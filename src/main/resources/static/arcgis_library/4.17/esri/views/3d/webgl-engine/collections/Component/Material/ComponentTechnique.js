// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.17/esri/copyright.txt for details.
//>>built
define("require exports tslib ../../../../../../core/maybe ../../../../../../core/libs/gl-matrix-2/mat3f64 ../../../../../../core/libs/gl-matrix-2/vec4f64 ./shader/ComponentShader.glsl ../../../core/shaderLibrary/Slice.glsl ../../../core/shaderLibrary/attributes/VertexPosition.glsl ../../../core/shaderLibrary/output/OutputHighlight.glsl ../../../core/shaderLibrary/shading/PhysicallyBasedRenderingParameters.glsl ../../../core/shaderLibrary/shading/ScreenSpaceReflections.glsl ../../../core/shaderLibrary/util/DoublePrecision.glsl ../../../core/shaderTechnique/ReloadableShaderModule ../../../core/shaderTechnique/ShaderTechnique ../../../core/shaderTechnique/ShaderTechniqueConfiguration ../../../lib/StencilUtils ../../../../../webgl/Program ../../../../../webgl/renderState ../../../../../webgl/renderState @dojo/framework/shim/Promise".split(" "),
function(q,e,g,h,r,t,u,v,m,w,x,y,z,A,n,f,p,B,l,k){Object.defineProperty(e,"__esModule",{value:!0});e.ComponentTechniqueConfiguration=e.ComponentDrawParameters=e.ComponentTechnique=e.TextureUnits=void 0;e.TextureUnits={DIFFUSE:0,COMPONENT_COLOR:1,NORMAL:2,EMISSION:3,OCCLUSION:4,METALLIC_ROUGHNESS:5,OVERLAY0_COLOR:2,OVERLAY1_COLOR:3,OVERLAY0_NORMAL:4,OVERLAY1_NORMAL:5,SSAO:6,SHADOW_MAP:7,PREPASS_LINEAR_DEPTH:8,LAST_FRAME_COLOR:9};n=function(f){function c(){return null!==f&&f.apply(this,arguments)||
this}g.__extends(c,f);c.prototype.bindPass=function(a,b){var d=this.program;m.VertexPosition.bindViewProjTransform(d,b.viewTransform);v.Slice.bindUniforms(this.program,this.configuration,b.slicePlane);0===b.identifier&&void 0!==b.ssrParams&&(b.ssrParams.lastFrameColorTextureID=e.TextureUnits.LAST_FRAME_COLOR,b.ssrParams.linearDepthTextureID=e.TextureUnits.PREPASS_LINEAR_DEPTH,y.ScreenSpaceReflections.bindUniforms(this.program,a,b.ssrParams));0===b.identifier&&(d.setUniformMatrix3fv("uTransformNormal_ViewFromGlobal",
b.transformNormal_ViewFromGlobal),1===b.subPass&&d.setUniform2fv("uCameraNearFar",b.cameraNearFar),0===b.subPass&&(b.ambientOcclusionEnabled&&b.ambientOcclusion.bind(d,e.TextureUnits.SSAO),b.shadowsEnabled&&b.shadowMap.bind(d,e.TextureUnits.SHADOW_MAP),b.lighting.setUniforms(this.program,b.integratedMesh)));1===b.identifier&&this.program.setUniform2fv("uCameraNearFar",b.cameraNearFar);2===b.identifier&&w.OutputHighlight.bindOutputHighlight(a,this.program,b)};c.prototype.bindDraw=function(a,b){m.VertexPosition.bindModelTransform(this.program,
a);this.program.setUniformMatrix3fv("uTransformNormal_GlobalFromModel",a.transformNormal_GlobalFromModel);if(b.isIntegratedMesh){var d=b.overlayTexScale;b=b.overlayTexOffset;this.program.setUniform4fv("overlayTexOffset",[a.toMapSpace[0]*d[0]+b[0],a.toMapSpace[1]*d[1]+b[1],a.toMapSpace[0]*d[2]+b[2],a.toMapSpace[1]*d[3]+b[3]]);this.program.setUniform4fv("overlayTexScale",[a.toMapSpace[2]*d[0],a.toMapSpace[3]*d[1],a.toMapSpace[2]*d[2],a.toMapSpace[3]*d[3]])}};c.prototype.bindMaterial=function(a,b,d){var c=
this.program;c.setUniform4fv("uBaseColor",b.baseColor);c.setUniform1f("uObjectOpacity",b.objectOpacity);c.setUniform1f("textureAlphaCutoff",b.alphaCutoff);1===b.componentParameters.type?b.componentParameters.texture.bind(c,{texName:"uComponentColorTex",invDimName:"uComponentColorTexInvDim",unit:e.TextureUnits.COMPONENT_COLOR}):(c.setUniform4fv("uExternalColor",b.componentParameters.externalColor),c.setUniform1i("uExternalColorMixMode",b.componentParameters.externalColorMixMode));h.isSome(b.baseColorTexture)&&
b.baseColorTexture.bind(a,c,"uBaseColorTexture",e.TextureUnits.DIFFUSE,"uBaseColorTextureSize");0===this.configuration.output&&(x.PhysicallyBasedRenderingParameters.bindUniforms(this.program,b),h.isSome(b.metallicRoughnessTexture)&&b.metallicRoughnessTexture.bind(a,c,"texMetallicRoughness",e.TextureUnits.METALLIC_ROUGHNESS,"texMetallicRoughnessSize"),h.isSome(b.emissionTexture)&&b.emissionTexture.bind(a,c,"texEmission",e.TextureUnits.EMISSION,"texEmissionSize"),h.isSome(b.occlusionTexture)&&b.occlusionTexture.bind(a,
c,"texOcclusion",e.TextureUnits.OCCLUSION,"texOcclusionSize"),h.isSome(b.normalTexture)&&b.normalTexture.bind(a,c,"normalTexture",e.TextureUnits.NORMAL,"normalTextureSize"));b.isIntegratedMesh&&(0===d.identifier&&0===d.subPass?(a.bindTexture(h.unwrap(b.overlayColorInner),e.TextureUnits.OVERLAY0_COLOR),a.bindTexture(h.unwrap(b.overlayColorOuter),e.TextureUnits.OVERLAY1_COLOR),a.bindTexture(h.unwrap(b.overlayNormalInner),e.TextureUnits.OVERLAY0_NORMAL),a.bindTexture(h.unwrap(b.overlayNormalOuter),e.TextureUnits.OVERLAY1_NORMAL),
c.setUniform1i("ovInnerNormalTex",e.TextureUnits.OVERLAY0_NORMAL),c.setUniform1i("ovOuterNormalTex",e.TextureUnits.OVERLAY1_NORMAL)):2===d.identifier&&(a.bindTexture(h.unwrap(b.overlayHighlightInner),e.TextureUnits.OVERLAY0_COLOR),a.bindTexture(h.unwrap(b.overlayHighlightOuter),e.TextureUnits.OVERLAY1_COLOR)),c.setUniform1i("ovInnerColorTex",e.TextureUnits.OVERLAY0_COLOR),c.setUniform1i("ovOuterColorTex",e.TextureUnits.OVERLAY1_COLOR),c.setUniform1f("overlayOpacity",1))};c.prototype.initializeProgram=
function(a){var b=c.shader.get(),d=this.configuration,d=b.build({OITEnabled:0===this.configuration.transparencyPassType||1===this.configuration.transparencyPassType,alphaPass:1===d.transparencyPassType,output:d.output,normalType:0===d.integratedMeshMode?d.hasNormals?1:3:2,attributeColor:d.hasVertexColors,attributeTextureCoordinates:d.vertexTextureCoordinates,componentData:d.componentData,alphaDiscardMode:d.alphaDiscardMode,baseColorTexture:d.baseColorTexture,doubleSidedMode:d.doubleSidedMode,receiveAmbientOcclusion:d.receiveAmbientOcclusion,
receiveShadows:d.receiveShadows,slicePlaneEnabled:d.slicePlaneEnabled,sliceHighlightDisabled:!1,sliceEnabledForVertexPrograms:!1,viewingMode:a.viewingMode,vertexDiscardMode:d.vertexDiscardMode,pbrMode:3===d.integratedMeshMode?4:d.usePBR?1:0,hasMetalnessAndRoughnessTexture:d.hasMetalnessAndRoughnessTexture,hasEmissionTexture:d.hasEmissionTexture,hasOcclusionTexture:d.hasOcclusionTexture,hasNormalTexture:d.hasNormalTexture,vertexTangets:!1,useOldSceneLightInterface:!1,supportsTextureAtlas:!0,doublePrecisionRequiresObfuscation:z.doublePrecisionRequiresObfuscation(a.rctx),
overlayEnabled:2===d.integratedMeshMode||3===d.integratedMeshMode,ssrEnabled:d.ssrEnabled,highStepCount:!1});return new B(a.rctx,d.generateSource("vertex"),d.generateSource("fragment"),b.attributeLocations)};Object.defineProperty(c.prototype,"pipeline",{get:function(){switch(this.configuration.transparencyPassType){case 0:return this.colorPipelineState;case 1:return this.alphaPipelineState;case 2:return this.frontFacePipelineState;default:return this.defaultPipelineState}},enumerable:!1,configurable:!0});
c.prototype.pipelineState=function(a){var b=this.configuration,c=0!==b.integratedMeshMode,e,f,g;3===a?(g=C,e=513,f=k.defaultDepthWriteParams,a=b.polygonOffsetEnabled?{factor:2,units:2}:null):(g=2!==a?1===a?D:E:null,e=2===a?513:515,f=2===a?k.defaultDepthWriteParams:null,a=2!==a?{factor:-1,units:-2}:null);return k.makePipelineState({blending:0===b.output&&b.blendingEnabled?g:null,culling:F[b.cullFace],depthTest:{func:e},depthWrite:f,colorWrite:k.defaultColorWriteParams,stencilWrite:c||b.sceneHasOcludees?
p.stencilWriteMaskOn:null,stencilTest:c?p.replaceBitWhenDepthTestPasses(1):b.sceneHasOcludees?p.stencilBaseAllZerosParams:null,polygonOffset:a})};c.prototype.initializePipeline=function(){this._colorPipelineState=this.pipelineState(0);this._alphaPipelineState=this.pipelineState(1);this._frontFacePipelineState=this.pipelineState(2);return this._defaultPipelineState=this.pipelineState(3)};Object.defineProperty(c.prototype,"defaultPipelineState",{get:function(){return this._defaultPipelineState},enumerable:!1,
configurable:!0});Object.defineProperty(c.prototype,"colorPipelineState",{get:function(){return this._colorPipelineState},enumerable:!1,configurable:!0});Object.defineProperty(c.prototype,"alphaPipelineState",{get:function(){return this._alphaPipelineState},enumerable:!1,configurable:!0});Object.defineProperty(c.prototype,"frontFacePipelineState",{get:function(){return this._frontFacePipelineState},enumerable:!1,configurable:!0});c.shader=new A.ReloadableShaderModule(u,function(){return new Promise(function(a,
b){q(["./shader/ComponentShader.glsl"],a,b)})});return c}(n.ShaderTechnique);e.ComponentTechnique=n;var C=l.separateBlendingParams(770,1,771,771),E=k.simpleBlendingParams(1,1),D=k.simpleBlendingParams(0,771),F=[null,{face:1028,mode:2305},{face:1029,mode:2305}];l=function(e){function c(){var a=null!==e&&e.apply(this,arguments)||this;a.transformNormal_GlobalFromModel=r.mat3f64.create();a.toMapSpace=t.vec4f64.create();return a}g.__extends(c,e);return c}(m.VertexPosition.ModelTransform);e.ComponentDrawParameters=
l;l=function(e){function c(){var a=null!==e&&e.apply(this,arguments)||this;a.output=0;a.hasVertexColors=!1;a.hasNormals=!1;a.vertexTextureCoordinates=0;a.componentData=0;a.slicePlaneEnabled=!1;a.cullFace=2;a.baseColorTexture=!1;a.receiveAmbientOcclusion=!0;a.receiveShadows=!0;a.vertexDiscardMode=0;a.doubleSidedMode=2;a.blendingEnabled=!0;a.alphaDiscardMode=1;a.integratedMeshMode=0;a.ssrEnabled=!1;a.polygonOffsetEnabled=!1;a.usePBR=!1;a.hasMetalnessAndRoughnessTexture=!1;a.hasEmissionTexture=!1;a.hasOcclusionTexture=
!1;a.hasNormalTexture=!1;a.sceneHasOcludees=!1;a.transparencyPassType=3;return a}g.__extends(c,e);g.__decorate([f.parameter({count:7})],c.prototype,"output",void 0);g.__decorate([f.parameter()],c.prototype,"hasVertexColors",void 0);g.__decorate([f.parameter()],c.prototype,"hasNormals",void 0);g.__decorate([f.parameter({count:3})],c.prototype,"vertexTextureCoordinates",void 0);g.__decorate([f.parameter({count:2})],c.prototype,"componentData",void 0);g.__decorate([f.parameter()],c.prototype,"slicePlaneEnabled",
void 0);g.__decorate([f.parameter({count:3})],c.prototype,"cullFace",void 0);g.__decorate([f.parameter()],c.prototype,"baseColorTexture",void 0);g.__decorate([f.parameter()],c.prototype,"receiveAmbientOcclusion",void 0);g.__decorate([f.parameter()],c.prototype,"receiveShadows",void 0);g.__decorate([f.parameter({count:3})],c.prototype,"vertexDiscardMode",void 0);g.__decorate([f.parameter({count:3})],c.prototype,"doubleSidedMode",void 0);g.__decorate([f.parameter()],c.prototype,"blendingEnabled",void 0);
g.__decorate([f.parameter({count:4})],c.prototype,"alphaDiscardMode",void 0);g.__decorate([f.parameter({count:4})],c.prototype,"integratedMeshMode",void 0);g.__decorate([f.parameter()],c.prototype,"ssrEnabled",void 0);g.__decorate([f.parameter()],c.prototype,"polygonOffsetEnabled",void 0);g.__decorate([f.parameter()],c.prototype,"usePBR",void 0);g.__decorate([f.parameter()],c.prototype,"hasMetalnessAndRoughnessTexture",void 0);g.__decorate([f.parameter()],c.prototype,"hasEmissionTexture",void 0);
g.__decorate([f.parameter()],c.prototype,"hasOcclusionTexture",void 0);g.__decorate([f.parameter()],c.prototype,"hasNormalTexture",void 0);g.__decorate([f.parameter()],c.prototype,"sceneHasOcludees",void 0);g.__decorate([f.parameter({count:4})],c.prototype,"transparencyPassType",void 0);return c}(f.ShaderTechniqueConfiguration);e.ComponentTechniqueConfiguration=l});