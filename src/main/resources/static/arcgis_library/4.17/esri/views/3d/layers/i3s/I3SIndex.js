// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.17/esri/copyright.txt for details.
//>>built
define("require exports ../../../../core/maybe ../../../../core/PooledArray ../../../../core/promiseUtils ../../../../core/libs/gl-matrix-2/vec3 ../../../../core/libs/gl-matrix-2/vec4f64 ./I3SNode ./I3SUtil ../../support/orientedBoundingBox".split(" "),function(z,v,e,r,A,H,B,w,n,C){function D(c){e.isSome(c.node)&&(c.node.renderMbs[3]=-1,e.isSome(c.node.serviceObbInRenderSR)&&(c.node.serviceObbInRenderSR.halfSize[0]=-1));e.isSome(c.ref)&&(c.ref.renderMbs[3]=-1,e.isSome(c.ref.serviceObbInRenderSR)&&
(c.ref.serviceObbInRenderSR.halfSize[0]=-1))}function E(c,a){return 0===a?0:c/a|0}function x(c,a){return 0===a?c:c%a}function F(c){if(c)for(var a=0;a<c.length;a++)for(var b=0,f=I;b<f.length;b++){var d=f[b];if(d[0]===c[a].metricType)return{lodMetric:d[1],maxError:c[a].maxError}}return{lodMetric:0,maxError:0}}function J(c){return Math.sqrt(4/Math.PI*c)}Object.defineProperty(v,"__esModule",{value:!0});v.selectErrorMetric=v.I3SIndex=void 0;var G=function(){return function(c,a,b,f,d){this.childOffset=
c;this.childCount=a;this.visibilityCache=b;this.ref=f;this.node=d;this.useAsHole=0}}();z=function(){function c(a,b,f,d,c,g,e,q,K,m,l,L){this.streamDataController=b;this.viewportQueries=f;this.logger=d;this.holeFilling=c;this._isLoaded=g;this._isReloading=e;this._isSelected=q;this._enable=K;this._needsUpdate=m;this._canRequest=l;this._computeVisibilityObb=L;this._dirty=!0;this._nodePages=[];this.lodMetric=this.rootIndex=this.nodesPerPage=this.nodeCount=0;this.lodConversion=function(a){return a};this._loading=
new Set;this._failedNodes=new Set;this._failedPages=new Set;this._indexMissing=1;this._maxUnloadedPrio=Number.NEGATIVE_INFINITY;this._maxProcessingPrio=Number.POSITIVE_INFINITY;this._nodeTraversalState={};this._version=n.addWraparound(0,2);this._visibilityCacheVersion=n.addWraparound(0,2);this._maxLevel=1;this._featureEstimate={estimate:0,leafsReached:!1};this._unloadedMemoryEstimate=0;this._missing=new r({deallocator:null});this._prefetch=new r({deallocator:null});this._updates=new M;this._imModificationUncategorized=
new r({deallocator:null});this.ignoreServiceObb=!1;this.progressiveLoadPenalty=0;this.layerHasModifications=!1;this.layerUrl=a.parsedUrl.path;this.rootId=a.rootNode&&a.rootNode.split("/").pop();a.serviceUpdateTimeStamp&&a.serviceUpdateTimeStamp.lastUpdate&&(this.lastUpdate=""+a.serviceUpdateTimeStamp.lastUpdate);this._maxLodLevel=this.viewportQueries?this.viewportQueries.maxLodLevel:1;(a=a.nodePages)?this.initNodePages(a):this.initNodeDocuments(this.rootId)}c.prototype.initNodePages=function(a){this.nodesPerPage=
a.nodesPerPage;this.rootIndex=a.rootIndex;switch(a.lodSelectionMetricType){case "maxScreenThreshold":this.lodMetric=1;break;case "maxScreenThresholdSQ":this.lodMetric=1,this.lodConversion=J}};c.prototype.initNodeDocuments=function(a){this.rootIndex=this.nodesPerPage=0;this._nodePages.push({nodes:[],children:[],parents:[]});this.makeRefNode(new w.NodeBase(a,null),-1)};c.prototype.loadPage=function(a){var b=this;this._loading.add(a);this.streamDataController.request(this.layerUrl+"/nodepages/"+a,"json").then(function(f){b._loading.delete(a);
b.addPage(a,f)}).catch(function(f){b._loading.delete(a);if(!A.isAbortError(f)){if(0===b._nodePages.length)return b.initNodeDocuments(b.rootId);b._failedPages.add(a);b.logger.error("Error when loading page "+a,f)}})};c.prototype.addPage=function(a,b){for(var f=this,d=this._nodePages.length;d<a;d++)this._nodePages[d]=null;var c=[],g=[];b=b.nodes.map(function(b,d){var e=c.length,h=b.children?b.children.length:0;g.push(-1);for(var l=0;l<h;l++)c.push(b.children[l]);var t=""+b.index,l=C.clone(b.obb),q=
B.vec4f64.fromArray([l.center[0],l.center[1],l.center[2],H.vec3.length(l.halfSize)]),k=b.mesh&&b.mesh.attribute,p=b.mesh&&b.mesh.geometry,u=b.mesh&&b.mesh.material;b=new w.Node(t,a*f.nodesPerPage+d,q,h,0,{hasSharedResource:!1,hasFeatureData:!!p,attributes:k&&null!=k.resource?""+k.resource:null,geometry:p&&null!=p.resource?""+p.resource:null,texture:u&&null!=u.resource?""+u.resource:null,geometryDefinition:p?p.definition:-1,materialDefinition:u?u.definition:-1},f.lastUpdate,f.lodMetric,f.lodConversion(b.lodThreshold),
p?p.featureCount:null);b.serviceObb=l;b.visibilityObb=f._computeVisibilityObb(b);b.vertexCount=p?p.vertexCount:0;return new G(e,h,n.addWraparound(f._visibilityCacheVersion,-2),null,b)});this._nodePages[a]={nodes:b,children:c,parents:g};this.nodeCount+=b.length;this.updateParentsAndLevel()};c.prototype.updateParentsAndLevel=function(){var a=this,b=[],f=function(f,d,c){var g=a.getPage(f);if(e.isSome(g)){var h=x(f,a.nodesPerPage);g.parents[h]=d;d=g.nodes[h].node;e.isSome(d)&&(d.level=c,b.push(f))}};
for(f(this.rootIndex,-1,0);b.length;){var d=b.pop(),c=this.getNode(d);if(e.isSome(c))for(var g=0;g<c.childCount;g++){var t=this.getChildIndex(c,g);f(t,d,c.level+1)}}};c.prototype.getPage=function(a){return this._nodePages[E(a,this.nodesPerPage)]};c.prototype.getNodeInternal=function(a){var b=this.getPage(a);return e.isNone(b)?null:b.nodes[x(a,this.nodesPerPage)]};c.prototype.addNode=function(a,b){null!=a.children&&this.populateChildren(b,a.children);var f=this.getParent(b),f=e.isSome(f)?f.level+1:
1;this._maxLevel=Math.max(this._maxLevel,f);var d=F(a.lodSelection),c=d.lodMetric,d=d.maxError,g=e.unwrap(this.getNodeInternal(b));g.node=new w.Node(a.id,b,B.vec4f64.fromArray(a.mbs),g.childCount,f,a.resources,a.version,c,d,a.numFeatures);a.obb&&(g.node.serviceObb=C.clone(a.obb));g.node.visibilityObb=this._computeVisibilityObb(g.node);e.isSome(g.ref)&&(null==g.ref.mbs&&(g.ref.mbs=a.mbs),g.node.renderMbs=g.ref.renderMbs,g.node.serviceObbInRenderSR=g.ref.serviceObbInRenderSR,g.ref.visibilityObb=g.node.visibilityObb);
return g.node};c.prototype.makeRefNode=function(a,b){var f=this._nodePages[0],d=f.nodes.length;f.nodes.push(new G(0,0,n.addWraparound(this._visibilityCacheVersion,-2),a,null));this.nodeCount++;f.parents.push(b);a.renderMbs[3]=-1;e.isSome(a.serviceObbInRenderSR)&&(a.serviceObbInRenderSR.halfSize[0]=-1);return d};c.prototype.populateChildren=function(a,b){var f=e.unwrap(this.getNodeInternal(a)),d=e.unwrap(this.getPage(a));f.childOffset=d.children.length;f.childCount=b.length;for(f=0;f<b.length;f++){var c=
this.makeRefNode(b[f],a);d.children.push(c)}};c.prototype.getNode=function(a){a=this.getNodeInternal(a);return e.isSome(a)?a.node:null};c.prototype.getIndexById=function(a){var b;this.forAllNodes(function(f,d){e.isSome(f.node)&&f.node.id===a?b=d:e.isSome(f.ref)&&f.ref.id===a&&(b=d)});return b};c.prototype.getNodeById=function(a){a=this.getIndexById(a);return 0<=a?this.getNode(a):null};c.prototype.getChildIndex=function(a,b){var f=this.getPage(a.index);if(e.isNone(f))return-1;a=f.nodes[x(a.index,this.nodesPerPage)];
return f.children[a.childOffset+b]};c.prototype.getParentIndex=function(a){var b=this.getPage(a);return e.isSome(b)?b.parents[x(a,this.nodesPerPage)]:-1};c.prototype.getParent=function(a){a=this.getParentIndex(a);return 0<=a?this.getNode(a):null};c.prototype.isLeaf=function(a){a=this.getNodeInternal(a);return e.isSome(a)&&0===a.childCount};Object.defineProperty(c.prototype,"rootNode",{get:function(){return this.getNode(this.rootIndex)},enumerable:!1,configurable:!0});Object.defineProperty(c.prototype,
"size",{get:function(){return this.nodeCount},enumerable:!1,configurable:!0});c.prototype.invalidateVisibilityCache=function(){this._visibilityCacheVersion=n.addWraparound(this._visibilityCacheVersion,2)};c.prototype.invalidateNodeVisibilityCache=function(a){a=this.getNodeInternal(a);e.isSome(a)&&this.invalidateNodeVisibilityCacheInternal(a)};c.prototype.invalidateNodeVisibilityCacheInternal=function(a){a.visibilityCache=n.addWraparound(this._visibilityCacheVersion,-2)};c.prototype.invalidateBoundingVolumeCache=
function(a){a=this.getNodeInternal(a);e.isSome(a)&&(D(a),this.invalidateNodeVisibilityCacheInternal(a))};c.prototype.invalidateGeometryVisibility=function(a){a=this.getNodeInternal(a);e.isSome(a)&&e.isSome(a.node)&&(a.node.geometryObb=null,a.node.renderMbs[3]=-1,e.isSome(a.node.serviceObbInRenderSR)&&(a.node.serviceObbInRenderSR.halfSize[0]=-1))};c.prototype.invalidateVisibilityObbs=function(){var a=this;e.isNone(this.rootNode)||this.traverse(this.rootNode,function(b){b.visibilityObb=a._computeVisibilityObb(b);
b.geometryObb=null;return!0})};c.prototype.isNodeVisible=function(a){a=this.getNodeInternal(a);if(e.isNone(a)||e.isSome(a.ref)&&!a.ref.mbs)return!0;if((a.visibilityCache&-2)!==this._visibilityCacheVersion){var b=a.node,f=e.isSome(b)&&(e.isNone(a.ref)||e.isSome(b.visibilityObb))?b:e.isSome(a.ref)?a.ref:null,b=!(e.isSome(b)&&2===b.imModificationImpact)&&(!f||this.viewportQueries.isNodeVisible(f));a.visibilityCache=this._visibilityCacheVersion+(b?1:0);return b}return 1===(a.visibilityCache&1)};c.prototype.isGeometryVisible=
function(a){if(!this.isNodeVisible(a))return!1;a=this.getNodeInternal(a);return e.isSome(a)&&e.isSome(a.node)&&e.isSome(a.node.geometryObb)&&(!this.layerHasModifications||4!==a.node.imModificationImpact)?this.viewportQueries.isGeometryVisible(a.node):!0};c.prototype._traverseCoverage=function(a,b,f,d,c){var g=this.getPage(a);if(!e.isNone(g)&&0!==b.childCount){var h=b.childOffset+b.childCount;a=[];for(var q=b.childOffset;q<h;++q){b=g.children[q];var k=this.getNodeInternal(b);e.isSome(k)&&e.isSome(k.node)&&
this.isGeometryVisible(b)&&a.push(k)}d/=a.length;for(g=0;g<a.length;g++)k=a[g],b=e.unwrap(k.node).index,this._isLoaded(b)||this._isReloading(b)?(c.delta=Math.max(c.delta,f),c.coverage+=d):this._traverseCoverage(b,k,f+1,d,c)}};c.prototype.useNodeAsHole=function(a){if("off"===this.holeFilling)return!1;var b=this.getNodeInternal(a);if(e.isNone(b))return!1;if("always"===this.holeFilling)return!0;if((b.useAsHole&-2)===this._version)return 1===(b.useAsHole&1);var f={delta:0,coverage:0};this._traverseCoverage(a,
b,0,1,f);a=.5>=f.delta*f.coverage;b.useAsHole=this._version+(a?1:0);return a};Object.defineProperty(c.prototype,"maxLevel",{get:function(){return this._maxLevel},enumerable:!1,configurable:!0});Object.defineProperty(c.prototype,"dirty",{get:function(){return this._dirty},enumerable:!1,configurable:!0});c.prototype.destroy=function(){this._updates.add.prune();this._updates.update.prune()};c.prototype.requestUpdate=function(){this._dirty=!0;this._indexMissing=1;this._version=n.addWraparound(this._version,
2)};c.prototype.imModificationsChanged=function(a){var b=this;this.layerHasModifications=a;this.forAllNodes(function(a){a=a.node;e.isSome(a)&&(a.imModificationImpact=4,a.visibilityObb=b._computeVisibilityObb(a),a.hasModifications&&b.invalidateGeometryVisibility(a.index))});this.invalidateVisibilityCache()};c.prototype.update=function(a,b,c){var d=this;if(this._dirty){this._maxProcessingPrio=this._maxUnloadedPrio=Number.NEGATIVE_INFINITY;this._missing.clear();this._prefetch.clear();this._updates.reset(a,
this._missing);k.clear();var f=!0,g=new y,t=new y,q=this._imModificationUncategorized;q.clear();this.traverseVisible(function(m,l){if(l){var h=l.node;d._updateNodeFeatureEstimate(h,t);if(e.isNone(h))l=d.entryPriority(m),d._loading.has(m)||d._failedNodes.has(m)||(d._missing.push(m),k.set(m,l)),d._maxProcessingPrio=Math.max(d._maxProcessingPrio,l);else{var n=e.unwrap(d.getPage(m));if(0===d._missing.length&&0===d.nodesPerPage)for(var r=0;r<l.childCount;r++){var p=n.children[l.childOffset+r],u=d.getNodeInternal(p);
!e.isSome(u)||u.node||d._loading.has(p)||d._failedNodes.has(p)||(k.set(p,d.entryPriority(p)),d._prefetch.push(p))}!h.failed&&h.resources.hasFeatureData&&(d._isLoaded(m)?(g.known+=h.memory,++g.knownNodes,d._isSelected(h)?0<l.childCount&&(f=!1):(g.unremoved+=h.memory,f=!1),d._needsUpdate(h)&&(l=d.entryPriority(m),k.set(m,l),d._maxProcessingPrio=Math.max(d._maxProcessingPrio,l),d._updates.update.push(m))):(h.memory&&(g.known+=h.memory,++g.knownNodes),d._isSelected(h)?(0<l.childCount&&(f=!1),h.memory?
(g.missing+=h.memory,g.known+=h.memory,++g.knownNodes):++g.missingNodes,0<=a.indexOf(h.index)?(d._maxProcessingPrio=Math.max(d._maxProcessingPrio,d.entryPriority(m)),d._updates.cancel=d._updates.cancel.filter(function(a){return a!==h.index})):!b.done&&d._enable(h)?b.madeProgress():(n=d.entryPriority(m),k.set(m,n),d._maxProcessingPrio=Math.max(d._maxProcessingPrio,n),d._updates.add.push(m),d.layerHasModifications&&c&&e.isSome(l)&&e.isSome(l.node)&&4===l.node.imModificationImpact&&q.push(m))):d._isReloading(m)&&
d._updates.remove.push(m)))}}else l=d.entryPriority(m),m=E(m,d.nodesPerPage),k.set(m,Math.max(l,k.get(m)||0)),d._loading.has(m)||d._failedPages.has(m)||d._missing.push(m),d._maxProcessingPrio=Math.max(d._maxProcessingPrio,l)});var n=this._updates.add;0<n.length&&this.layerHasModifications&&(0<q.length&&c(q),n.filterInPlace(function(a){var b=d.getNodeInternal(a);(b=e.isNone(b)||e.isNone(b.node)||2!==b.node.imModificationImpact)||d.invalidateNodeVisibilityCache(a);return b}));this._unloadedMemoryEstimate=
g.missing-g.unremoved;3<g.knownNodes&&0<g.missingNodes&&(this._unloadedMemoryEstimate+=g.known/g.knownNodes*g.missingNodes);this._unloadedMemoryEstimate=.8*Math.max(0,this._unloadedMemoryEstimate);this._featureEstimate.estimate=this._computeFeatureEstimate(t);this._featureEstimate.leafsReached=f;this._missing.sort(function(a,b){return a-b});this._missing.filterInPlace(function(a,b){return 1>b||d._missing.data[b-1]!==a});this._missing.sort(function(a,b){return k.get(a)-k.get(b)});0<this._missing.length?
(this._maxUnloadedPrio=k.get(this._missing.back()),this._prefetch.clear()):this._prefetch.sort(function(a,b){return k.get(a)-k.get(b)});this._updates.add.filterInPlace(function(a){return k.get(a)>=d._maxUnloadedPrio}).sort(function(a,b){return k.get(a)-k.get(b)});this._updates.update.sort(function(a,b){return k.get(a)-k.get(b)});this._indexMissing=this._loading.size+this._missing.length;this._dirty=0<this._indexMissing;k.clear()}};c.prototype.checkFeatureTarget=function(a,b){for(var c=this.viewportQueries.updateScreenSpaceErrorBias(b),
d=b,e=b,g=c,t=10;t--;){var k=new y;this._updateFeatureEstimate(d,k);if(this._computeFeatureEstimate(k)<=a){if(d>=b||0<k.missingNodes||0===t)break;g=d;d=.5*(d+e)}else e=d,d=.5*(d+g)}this._version=n.addWraparound(this._version,2);this.viewportQueries.updateScreenSpaceErrorBias(c);return Math.min(b,d)};c.prototype._updateFeatureEstimate=function(a,b){var c=this;this._version=n.addWraparound(this._version,2);this.viewportQueries.updateScreenSpaceErrorBias(a);this.traverseVisible(function(a,f){return c._updateNodeFeatureEstimate(f&&
f.node,b)})};c.prototype._updateNodeFeatureEstimate=function(a,b){e.isNone(a)||a.failed||e.isNone(a.numFeatures)||(this._isLoaded(a.index)?(b.known+=a.numFeatures,++b.knownNodes,this._isSelected(a)||(b.unremoved+=a.numFeatures)):this._isSelected(a)&&(e.isSome(a.numFeatures)?(b.missing+=a.numFeatures,b.known+=a.numFeatures,++b.knownNodes):++b.missingNodes))};c.prototype._computeFeatureEstimate=function(a){var b=a.known-a.unremoved;3<a.knownNodes&&0<a.missingNodes&&(b+=a.known/a.knownNodes*a.missingNodes);
return Math.max(0,b)};c.prototype.load=function(){return this._load(this._missing)};c.prototype.prefetch=function(){return this._load(this._prefetch)};c.prototype._load=function(a){if(0===a.length||!this._canRequest())return!1;for(;0<a.length&&this._canRequest();)0===this.nodesPerPage?this._loadNode(a.pop()):this.loadPage(a.pop());return!0};c.prototype.isLoading=function(){return 0<this._indexMissing};c.prototype.getIndexLoading=function(){return this._loading.size};c.prototype.getIndexMissing=function(){return this._indexMissing};
c.prototype.getUnloadedMemoryEstimate=function(){return this._unloadedMemoryEstimate};Object.defineProperty(c.prototype,"updates",{get:function(){return this._updates},enumerable:!1,configurable:!0});c.prototype.getFeatureEstimate=function(){return this._featureEstimate};c.prototype.nodeTraversalState=function(a){if(e.isNone(a))return null;var b=this._nodeTraversalState[a.index];if(b&&(b.version&-2)===this._version)return b;var c=this.viewportQueries.getLodLevel(a),d=this.viewportQueries.hasLOD(a),
h=!0;d?(h=this.getParentIndex(a.index),h=0<=h?(h=this._nodeTraversalState[h])&&c>h.lodLevel:0<c):h=0===a.childCount;if(b)return b.lodLevel=c,b.isChosen=h,b.version=this._version+1,b;this._nodeTraversalState[a.index]={nodeHasLOD:d,lodLevel:c,isChosen:h,version:this._version+1};return this._nodeTraversalState[a.index]};c.prototype._loadNode=function(a){var b=this;this._loading.add(a);var c=e.unwrap(this.getNodeInternal(a)).ref;if(e.isNone(c))this._failedNodes.add(a);else{var d=c.id,h=this.layerUrl+
"/nodes/"+d,g=function(){b._loading.delete(a);0===b._missing.length&&0===b._loading.size&&b.requestUpdate()};this.streamDataController.request(h,"json").then(function(c){c=b._validateNode(d,c);null!=c&&(c.obb&&b.invalidateNodeVisibilityCache(a),c=b.addNode(c,a),b.nodeTraversalState(c));g()},function(c){A.isAbortError(c)||(b.logger.error("Error loading node: "+h),b._failedNodes.add(a));g()})}};c.prototype._validateNode=function(a,b){var c=this;if(null==b||"object"!==typeof b||b.id!==a)return this.logger.error('Invalid node. Wrong type or wrong id "'+
a+'"'),null;b.sharedResource&&"./shared"!==b.sharedResource.href&&"./shared/"!==b.sharedResource.href&&this.logger.warn('Invalid shared resource href on node "'+a+'"');null==b.geometryData||Array.isArray(b.geometryData)&&1===b.geometryData.length&&"./geometries/0"===b.geometryData[0].href||this.logger.warn('Invalid geometry data on node "'+a+'"');null==b.attributeData||Array.isArray(b.attributeData)&&!b.attributeData.some(function(a,b){return a.href!=="./attributes/f_"+b+"/0"})||this.logger.warn('Invalid attribute data on node "'+
a+'"');b.featureData&&1<b.featureData.length&&this.logger.warn("Node "+a+" has "+b.featureData.length+" bundles. Only the first bundle will be loaded.");var d=b.hasOwnProperty("obb")&&!this.ignoreServiceObb?b.obb:null,e=b.featureData&&1===b.featureData.length&&b.featureData[0].featureRange?b.featureData[0].featureRange[1]-b.featureData[0].featureRange[0]+1:null,g=function(b){if(null==b)return null;var d=function(b){return c.logger.error("Invalid node reference on node "+a+": "+b)};if("number"===typeof b.id)d("id "+
b.id+" is a number instead of a string.");else if("string"!==typeof b.id||!Array.isArray(b.mbs))return d("Missing or invalid id."),null;if(!Array.isArray(b.mbs))return d("Invalid bounding volume on reference "+b.id+"."),null;b.href&&b.href!=="../"+b.id&&c.logger.error('Invalid node href on node "'+a+'"');d=b.hasOwnProperty("obb")&&!c.ignoreServiceObb?b.obb:null;b=new w.NodeBase(""+b.id,b.mbs);b.serviceObb=d;b.visibilityObb=c._computeVisibilityObb(b);return b},g=Array.isArray(b.children)?b.children.map(g).filter(function(a){return null!=
a}):null;return{id:a,mbs:b.mbs,obb:d,children:g,resources:{hasFeatureData:b.featureData&&0<b.featureData.length,hasSharedResource:null!=b.sharedResource,attributes:b.attributeData?a:null,texture:b.textureData&&0<b.textureData.length?a:null,geometry:null!=b.geometryData?a:null},version:"string"===typeof b.version?b.version:null,lodSelection:Array.isArray(b.lodSelection)?b.lodSelection:null,numFeatures:e}};c.prototype.resetFailedNodes=function(){this._failedNodes.clear();this._failedPages.clear();this.forAllNodes(function(a){e.isSome(a.node)&&
(a.node.failed=!1)})};c.prototype.entryPriority=function(a){var b=this.getNodeInternal(a),c=this.getParentIndex(a);if(e.isNone(b)||0>c&&null==b.node)return 0>c?Infinity:this.entryPriority(c);var d=0;b.node&&0<=c&&(c=this._nodeTraversalState[c],null!=c&&(d=c.lodLevel));for(c=this.progressiveLoadPenalty;0<=a;a=this.getParentIndex(a))if(this._isLoaded(a)){c=0;break}b=e.isSome(b.ref)?this.viewportQueries.distToPOI(b.ref):e.isSome(b.node)?this.viewportQueries.distToPOI(b.node):0;return-b-d*(b+this.progressiveLoadPenalty)+
c};c.prototype.traverseVisible=function(a){var b=this.getNodeInternal(this.rootIndex);e.isNone(b)?a(this.rootIndex,null):this._traverseVisible(this.rootIndex,b,a)};c.prototype._traverseVisible=function(a,b,c){if(b.node&&0===b.childCount)this.isGeometryVisible(a)&&c(a,b);else if(this.isNodeVisible(a)&&(c(a,b),null!=b.node)){var d=this.nodeTraversalState(b.node);if(!d.nodeHasLOD||d.lodLevel!==this._maxLodLevel)for(a=e.unwrap(this.getPage(a)),d=0;d<b.childCount;d++){var f=a.children[b.childOffset+d],
g=this.getNodeInternal(f);e.isSome(g)?this._traverseVisible(f,g,c):c(f,null)}}};c.prototype.traverse=function(a,b){b(a)&&this.traverseChildren(a,b)};c.prototype.traverseChildren=function(a,b){a=a.index;var c=this.getNodeInternal(a);e.isSome(c)&&this._traverseChildren(a,c,b)};c.prototype._traverseChildren=function(a,b,c){a=this.getPage(a);if(!e.isNone(a)){var d=b.childOffset+b.childCount;for(b=b.childOffset;b<d;++b){var f=a.children[b],g=this.getNodeInternal(f);e.isSome(g)&&e.isSome(g.node)&&c(g.node)&&
this._traverseChildren(f,g,c)}}};c.prototype.updateStats=function(a){0<this._updates.add.length&&(a.nodes+=" + "+this._updates.add.length);if(this._indexMissing||0<this._prefetch.length)a.index+=" + "+this._indexMissing||this._prefetch.length;a.prio=this._maxProcessingPrio;if(this._featureEstimate.estimate){var b=this._featureEstimate.estimate-a.features;0<b?a.features+=" + "+b:0>b&&(a.features+=" - "+-b)}};c.prototype.getPriority=function(){return Math.max(this._maxProcessingPrio,this._maxUnloadedPrio)};
c.prototype.updateElevationInfo=function(a){this.forAllNodes(D);this.viewportQueries.updateElevationInfo(a)};c.prototype.forAllNodes=function(a){for(var b=0;b<this._nodePages.length;b++){var c=this._nodePages[b];if(c)for(var d=b*this.nodesPerPage,e=0;e<c.nodes.length;e++)a(c.nodes[e],d+e)}};Object.defineProperty(c.prototype,"test",{get:function(){var a=this;return{addNode:function(b,c){return a.addNode(b,c)}}},enumerable:!1,configurable:!0});return c}();v.I3SIndex=z;var k=new Map,M=function(){function c(){this.update=
new r({deallocator:null});this.add=new r({deallocator:null});this.remove=new r({deallocator:null});this.cancel=[]}c.prototype.reset=function(a,b){this.add.clear();this.update.clear();this.cancel=a;this.missing=b};return c}(),I=[["maxScreenThreshold",1],["screenSpaceRelative",2],["removedFeatureDiameter",3],["distanceRangeFromDefaultCamera",4]];v.selectErrorMetric=F;var y=function(){return function(){this.unremoved=this.missingNodes=this.missing=this.knownNodes=this.known=0}}()});