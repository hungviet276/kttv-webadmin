// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.17/esri/copyright.txt for details.
//>>built
define("require exports tslib ../../../../core/promiseUtils ../../../../core/watchUtils ../../../../core/accessorSupport/decorators ../../../../core/libs/gl-matrix-2/vec3 ../../../../core/libs/gl-matrix-2/vec3f64 ../../../../geometry/Point ../PropertiesPool ./PointOfInterest".split(" "),function(g,d,c,k,p,e,h,l,m,q,r){Object.defineProperty(d,"__esModule",{value:!0});d.CameraOnSurface=void 0;var t=Array;g=function(d){function a(b){b=d.call(this,b)||this;b._dirty=!1;b._propertiesPool=new q.default({location:m,
renderLocation:t},b);b._estimatedSurfaceAltitude=0;b._pendingElevationQueryController=null;b.renderLocation=l.vec3f64.create();return b}c.__extends(a,d);a.prototype.initialize=function(){var b=this;this.handles.add(this.scheduler.registerTask(this.task,function(){return b._measureSurfaceAltitude()},function(){return b._needsUpdate()}));this._measureSurfaceAltitude();if(this.map){var a=function(){return b._setDirty()};this.handles.add([p.on(this.map,"ground.layers","change",a,a,a)])}};a.prototype.destroy=
function(){this._cancelPendingRequest();this._propertiesPool.destroy();this._propertiesPool=null};Object.defineProperty(a.prototype,"location",{get:function(){var b=this._propertiesPool.get("location");this.renderCoordsHelper.fromRenderCoords(this.renderLocation,b,this.state.spatialReference);return b},enumerable:!1,configurable:!0});Object.defineProperty(a.prototype,"updating",{get:function(){return this._dirty||null!=this._pendingElevationQueryController},enumerable:!1,configurable:!0});a.prototype.updateRenderLocation=
function(){this._setDirty();this._updateRenderLocation()};a.prototype.update=function(){this._measureSurfaceAltitude();this._updateRenderLocation()};a.prototype._setDirty=function(){this._dirty||(this._dirty=!0,this.notifyChange("updating"))};a.prototype._needsUpdate=function(){return!this._pendingElevationQueryController&&this._dirty};a.prototype._cancelPendingRequest=function(){var b=this._pendingElevationQueryController;b&&(this._pendingElevationQueryController=null,b.abort(),this.notifyChange("updating"))};
a.prototype._measureSurfaceAltitude=function(){var b=this;this._cancelPendingRequest();this._dirty=!1;this.notifyChange("updating");if(this.map&&this.map.ground){this.renderCoordsHelper.fromRenderCoords(this.state.camera.eye,n,this.state.spatialReference);var a=k.createAbortController();this.map.ground.queryElevation(n,{signal:a.signal}).then(function(a){return b._updateSurfaceAltitude(a.geometry.z)}).catch(function(a){k.isAbortError(a)||b._updateSurfaceAltitude(0)}).catch(function(){}).then(function(){b._pendingElevationQueryController===
a&&(b._pendingElevationQueryController=null,b.notifyChange("updating"));a=null});this._pendingElevationQueryController=a}else this._updateSurfaceAltitude(0)};a.prototype._updateSurfaceAltitude=function(a){this._estimatedSurfaceAltitude!==a&&(this._estimatedSurfaceAltitude=a,this._updateRenderLocation())};a.prototype._updateRenderLocation=function(){h.vec3.copy(f,this.state.camera.eye);this.renderCoordsHelper.setAltitude(this._estimatedSurfaceAltitude,f);h.vec3.exactEquals(this._get("renderLocation"),
f)||this._set("renderLocation",h.vec3.copy(this._propertiesPool.get("renderLocation"),f))};c.__decorate([e.property({constructOnly:!0})],a.prototype,"scheduler",void 0);c.__decorate([e.property({constructOnly:!0})],a.prototype,"task",void 0);c.__decorate([e.property({readOnly:!0,dependsOn:["renderLocation"]})],a.prototype,"location",null);c.__decorate([e.property({constructOnly:!0})],a.prototype,"map",void 0);c.__decorate([e.property({readOnly:!0})],a.prototype,"renderLocation",void 0);c.__decorate([e.property({readOnly:!0})],
a.prototype,"updating",null);return a=c.__decorate([e.subclass("esri.views.3d.support.CameraOnSurface")],a)}(r.PointOfInterest);d.CameraOnSurface=g;var f=l.vec3f64.create(),n=new m;d.default=g});