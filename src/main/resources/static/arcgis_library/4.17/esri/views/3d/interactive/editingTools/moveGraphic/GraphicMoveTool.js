// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.17/esri/copyright.txt for details.
//>>built
define("require exports tslib ../../../../../core/Collection ../../../../../core/Evented ../../../../../core/Handles ../../../../../core/handleUtils ../../../../../core/maybe ../../../../../core/accessorSupport/decorators ../../../../../layers/graphics/dehydratedFeatures ../../../../../support/elevationInfoUtils ../../manipulatorUtils ../manipulatorUtils ../visualElementUtils ../manipulations/config ../manipulations/MoveManipulation ../manipulations/moveUtils ../manipulations/MoveXYGraphicManipulation ./isSupportedGraphic ../../visualElements/OutlineVisualElement ../../../layers/graphics/GraphicState ../../../../interactive/dragEventPipeline ../../../../interactive/InteractiveToolBase".split(" "),
function(q,k,h,z,A,r,B,t,l,C,D,E,F,G,H,u,I,J,K,v,L,w,M){Object.defineProperty(k,"__esModule",{value:!0});k.GraphicMoveTool=k.GraphicMoveStopEvent=k.GraphicMoveEvent=k.GraphicMoveStartEvent=void 0;var x=function(){return function(f){this.allGraphics=f;this.type="graphic-move-start"}}();k.GraphicMoveStartEvent=x;var y=function(){return function(f,c,a){this.dx=f;this.dy=c;this.allGraphics=a;this.type="graphic-move"}}();k.GraphicMoveEvent=y;var p=function(){return function(f){this.allGraphics=f;this.type=
"graphic-move-stop"}}();k.GraphicMoveStopEvent=p;q=function(f){function c(a){a=f.call(this,a)||this;a.graphics=new z;a.enableZ=!0;a.type="move-3d";a._toolHandles=new r;a._handles=new r;return a}h.__extends(c,f);c.prototype.initialize=function(){var a=this;this._toolHandles.add([this.graphics.on("change",function(){return a._refreshManipulators()})]);this._refreshManipulators()};c.prototype.destroy=function(){this._handles.destroy();this._handles=null;this._toolHandles.destroy();this._toolHandles=
null;this.graphics.removeAll();this._set("view",null)};c.prototype.reset=function(){};c.prototype._refreshManipulators=function(){var a=this;this._handles.removeAll();this._moveManipulation&&this._moveManipulation.destroy();this.manipulators.removeAll();var d=this.graphics.toArray().filter(function(a){return 0===K.isSupportedGraphic(a)}).map(function(a){return new N(a)});d.length&&(this.createManipulators(d),this.createVisualElements(d),this._handles.add(d.map(function(d){return a.view.trackGraphicState(d.state)})),
this.updateMoveManipulation(d))};c.prototype.createManipulators=function(a){for(var d=this,c=function(b){var e=b.state;b.manipulationXY=new J.MoveXYGraphicManipulation({tool:g,view:g.view,graphicState:e});b.manipulationXY.forEachManipulator(function(a){return d._handles.add(a.events.on("immediate-click",function(a){d.emit("immediate-click",h.__assign(h.__assign({},a),{graphic:e.graphic}));a.stopPropagation()}))});g._handles.add(b.manipulationXY.createDragPipeline(function(b,e,c){return d.buildDragEventPipeline(b,
e,c,a)}))},g=this,b=0;b<a.length;b++)c(a[b]);this.createMoveManipulation(a)};c.prototype.createMoveManipulation=function(a){var d=this,c=new u.MoveManipulation({tool:this,view:this.view,snapToScene:!1,xyAvailable:!0,xyAxisAvailable:!0,zAvailable:!0,radius:1===a.length?u.MoveManipulation.radiusForSymbol(a[0].graphic.symbol):H.DISC_RADIUS});this._moveManipulation=c;c.elevationInfo={mode:"absolute-height",offset:0};c.forEachManipulator(function(a){d._handles.add(a.events.on("immediate-click",function(b){c.zManipulation.hasManipulator(a)||
1!==d.graphics.length||d.emit("immediate-click",h.__assign(h.__assign({},b),{graphic:d.graphics.getItemAt(0)}));b.stopPropagation()}))});for(var g=function(){return d.updateMoveManipulation(a)},b=0;b<a.length;b++){var m=a[b];this._handles.add([m.state.on("changed",g),m.state.watch("displaying",g)])}var e=a[a.length-1];this._handles.add(e.state.on("changed",function(){return d.updateMoveManipulationAngle(e)}));this._handles.add(c.createDragPipeline(function(b,e,c){d.buildDragEventPipeline(b,e,c,a)},
D.getGraphicEffectiveElevationInfo(e.graphic),t.unwrap(e.graphic.geometry).spatialReference));this.updateMoveManipulationAngle(e)};c.prototype.createVisualElements=function(a){for(var d=this,c=function(b){var e=G.createVisualElements({view:g.view,graphic:b.graphic,forEachManipulator:function(a){b.manipulationXY.forEachManipulator(a);d._moveManipulation.forEachManipulator(a)},onManipulatorsChanged:function(){return B.makeHandle()}});b.geometryRepresentation=e.visualElement;b.geometryRepresentation instanceof
v.OutlineVisualElement&&g._handles.add([b.geometryRepresentation.events.on("attachment-origin-changed",function(){b.state.isDraped||d.updateMoveManipulation(a)}),b.state.watch("isDraped",function(){return d.updateMoveManipulation(a)})]);g._handles.add(e)},g=this,b=0;b<a.length;b++)c(a[b])};c.prototype.updateMoveManipulationAngle=function(a){this._moveManipulation.angleDeferred=function(){return I.primaryShapeOrientation(a.graphic.geometry)}};c.prototype.updateMoveManipulation=function(a){for(var d=
C.makeDehydratedPoint(0,0,0,this.view.spatialReference),c=0,g=!1,b=this._moveManipulation,m=0;m<a.length;m++){var e=a[m];if(e.state.displaying){var f=e.state.graphic;this.enableZ&&F.canMoveZ(f)&&(g=!0);e=e.geometryRepresentation instanceof v.OutlineVisualElement&&!e.state.isDraped?e.geometryRepresentation.attachmentOrigin:E.getGraphicAttachmentOrigin(this.view,f);t.isSome(e)&&(d.x+=e.x,d.y+=e.y,d.z+=e.z,c++)}}0<c?(d.x/=c,d.y/=c,d.z/=c,b.location=d,b.xyManipulation.available=!0,b.xyAxisManipulation.available=
!0,b.zManipulation.available=g):b.available=!1};c.prototype.buildDragEventPipeline=function(a,c,f,g){var b=this,d=[],e=[],h=null,k=null,l=function(){for(var a=0;a<d.length;a++)d[a].dragging=!1;d.length=0;e.length=0;k=h=null;b._moveManipulation.interactive=!0};c.next(function(c){if("start"===c.action){d.length=0;for(var f=e.length=0;f<g.length;f++){var n=g[f];n.dragging||!n.manipulationXY.hasManipulator(a)&&n.manipulationXY.grabbing||(d.push(n),e.push(n.graphic),n.dragging=!0)}if(0!==e.length&&(b._moveManipulation.interactive=
!1,h=w.dragGraphicMany(e),k=w.resetGraphicMany(e),b.emit("graphic-move-start",new x(e)),b.destroyed))return null}return 0!==e.length?c:null}).next(function(a){return h(a)}).next(function(a){switch(a.action){case "start":case "update":if(a.translationX||a.translationY||a.translationZ){var c=b.view.toScreen(a.mapStart);a=b.view.toScreen(a.mapEnd);b.emit("graphic-move",new y(a.x-c.x,a.y-c.y,e));if(b.destroyed)return null}break;case "end":b.emit("graphic-move-stop",new p(e));if(b.destroyed)return null;
l()}});f.next(function(a){return k(a)}).next(function(){b.emit("graphic-move-stop",new p(e));if(b.destroyed)return null;l()})};h.__decorate([l.property({constructOnly:!0,nonNullable:!0})],c.prototype,"view",void 0);h.__decorate([l.property({readOnly:!0})],c.prototype,"graphics",void 0);h.__decorate([l.property({constructOnly:!0,nonNullable:!0})],c.prototype,"enableZ",void 0);h.__decorate([l.property({readOnly:!0})],c.prototype,"type",void 0);return c=h.__decorate([l.subclass("esri.views.3d.interactive.editingTools.graphicMove3D.GraphicMoveTool")],
c)}(A.EventedMixin(M.InteractiveToolBase));k.GraphicMoveTool=q;var N=function(){function f(c){this.manipulationXY=this.geometryRepresentation=this.state=null;this.dragging=!1;this.state=new L.GraphicState({graphic:c})}Object.defineProperty(f.prototype,"graphic",{get:function(){return this.state.graphic},enumerable:!1,configurable:!0});return f}()});