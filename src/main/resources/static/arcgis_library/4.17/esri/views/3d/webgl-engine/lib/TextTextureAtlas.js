// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.17/esri/copyright.txt for details.
//>>built
define("require exports tslib ../../../../core/Accessor ../../../../core/Evented ../../../../core/MapUtils ../../../../core/mathUtils ../../../../core/maybe ../../../../core/accessorSupport/decorators ./Texture ../../../support/Scheduler ../../../webgl/Texture".split(" "),function(f,g,k,v,w,q,x,m,n,y,r,z){Object.defineProperty(g,"__esModule",{value:!0});g.TextTextureAtlas=void 0;f=function(g){function b(a){a=g.call(this,a)||this;a.events=new w;a.glTexture=null;a.dirty=!1;a.needsClear=!1;a.elementsToAddOrUpdate=
new Map;a.elementsToRemove=new Map;a.elementsToRender=new Map;a.elements=new Map;a.stageObjects=new Map;return a}k.__extends(b,g);f=b;b.prototype.initialize=function(){this.id=y.idGen.gen(this.idHint);this.stage=this.view._stage;this.canvas=this.create2DCanvas();this.ctx=this.canvas.getContext("2d");this.stage.add(4,this);var a=this.computeAtlasResolution(this.view.width,this.view.height);this.createAtlasRegion(a);this.update2DCanvasSize();this.resetAtlasCursor()};b.prototype.unload=function(){m.isSome(this.glTexture)&&
(this.glTexture.dispose(),this.glTexture=null);this.events.emit("unloaded")};Object.defineProperty(b.prototype,"width",{get:function(){return this.atlas.size.width},enumerable:!1,configurable:!0});Object.defineProperty(b.prototype,"height",{get:function(){return this.atlas.size.height},enumerable:!1,configurable:!0});Object.defineProperty(b.prototype,"requiresFrameUpdates",{get:function(){return!1},enumerable:!1,configurable:!0});b.prototype.createDescriptor=function(a){return{target:3553,pixelFormat:6408,
dataType:5121,wrapMode:33071,flipped:!0,samplingMode:9987,hasMipmap:!0,preMultiplyAlpha:!0,maxAnisotropy:a.parameters.maxMaxAnisotropy}};b.prototype.load=function(a){var d=this;if(m.isSome(this.glTexture))return this.glTexture;this.glTexture=new z(a,this.createDescriptor(a),this.canvas);this.frameWorker=this.view.resourceController.scheduler.registerTask(r.Task.TEXT_TEXTURE_ATLAS,function(a){return d.run(a,!0)},function(){return d.dirty});this.setDirty();return this.glTexture};b.prototype.dispose=
function(){this.elementsToRender=this.elementsToRemove=this.elementsToAddOrUpdate=this.elements=null;this.frameWorker&&(this.frameWorker.remove(),this.frameWorker=null);this.glTexture&&(this.stage.remove(4,this.id),this.glTexture=null);this.canvas.width=0;this.canvas.height=0;this.ctx=this.canvas=null};b.prototype.create2DCanvas=function(){var a=document.createElement("canvas");a.setAttribute("id","canvas2d");a.setAttribute("style","display:none");a.setAttribute("width",(512).toString());a.setAttribute("height",
(512).toString());return a};b.prototype.update2DCanvasSize=function(){this.canvas.setAttribute("width",this.atlas.size.width.toString());this.canvas.setAttribute("height",this.atlas.size.height.toString())};b.prototype.createAtlasRegion=function(a){void 0===a&&(a=512);this.atlas={size:{width:a,height:a},cursor:{x:0,y:0},lineHeight:0}};b.prototype.computeAtlasResolution=function(a,d){a=Math.max(a,d);a=x.nextHighestPowerOfTwo(a+256);return a=Math.min(a,4096)};b.prototype.resizeAtlas=function(a,d){d=
d||a;var c=this.atlas;c.size.width=a;c.size.height=d;m.isSome(this.glTexture)&&this.glTexture.resize(a,d);this.update2DCanvasSize()};b.prototype.resetAtlasCursor=function(){var a=this.atlas;a.cursor.x=l;a.cursor.y=l+t;a.lineHeight=0;this.needsClear=!0};b.prototype.getAtlasUsage=function(){var a=this.atlas;return(a.cursor.x+a.cursor.y*a.size.width)/(a.size.width*a.size.height)};b.prototype.getExpectedAtlasUsage=function(){var a=this.elementsToRemove.size,d=this.elementsToAddOrUpdate.size,c=this.elements.size;
return this.getAtlasUsage()/c*(c+d-a)};b.prototype.addAtlasElement=function(a,d,c,b){var e=this.atlas,h=a.textRenderer,u=h.renderedWidth,f=h.renderedHeight,g=h.displayWidth,h=h.displayHeight;a.placement.offset.x=e.cursor.x;a.placement.offset.y=e.cursor.y;a.placement.size.width=u;a.placement.size.height=f;a.placement.size.displayWidth=g;a.placement.size.displayHeight=h;a.placement.uvMinMax=[a.placement.offset.x/e.size.width,1-(a.placement.offset.y+f)/e.size.height,(a.placement.offset.x+u)/e.size.width,
1-a.placement.offset.y/e.size.height];e.cursor.x+=c;e.lineHeight=Math.max(e.lineHeight,b);this.elements.set(d,a)};b.prototype.removeAtlasElement=function(a){if(a&&this.elements.has(a.textId)){var d=a.placement.offset,c=a.placement.size;this.ctx.clearRect(d.x,d.y,c.width,c.height);this.elements.delete(a.textId)}};b.prototype.ensureStageObjects=function(a){var d=this.stageObjects.get(a);if(d)return d;d=new Set;this.stageObjects.set(a,d);return d};b.prototype.addStageObject=function(a,d){this.ensureStageObjects(a).add(d)};
b.prototype.removeStageObject=function(a,d){(a=this.stageObjects.get(a))&&a.delete(d)&&(d.geometries[0].data.vertexAttributes.size.data=new Float32Array([0,0]),d.geometryVertexAttrsUpdated(0))};b.prototype._processAddition=function(a,d){var c=this.atlas,b=a.textId,e=a.textRenderer.renderedWidth+l,p=a.textRenderer.renderedHeight+l+t;if(c.cursor.x+e<c.size.width&&c.cursor.y+p<c.size.height)this.addAtlasElement(a,b,e,p),this.elementsToRender.set(b,a),this.elementsToAddOrUpdate.delete(b);else if(c.cursor.y+
p+c.lineHeight<c.size.height)c.cursor.x=l,c.cursor.y+=c.lineHeight,c.lineHeight=0,this.addAtlasElement(a,b,e,p),this.elementsToRender.set(b,a),this.elementsToAddOrUpdate.delete(b);else{a=this.getExpectedAtlasUsage();(b=.85<a&&4096>c.size.width)&&this.resizeAtlas(2*c.size.width,2*c.size.height);if(!d||!b&&.95<a&&4096===c.size.width)return this.processRemovals(),0;this.repack();return 1}return 0};b.prototype.processRemovals=function(){var a=this;this.elementsToRemove.forEach(function(d,c){var b=a.stageObjects.get(c);
b&&0!==b.size||a.removeAtlasElement(d);b&&0===b.size&&a.stageObjects.delete(c)});this.elementsToRemove.clear()};b.prototype.repack=function(){var a=this;this.processRemovals();this.elements.forEach(function(b,c){b.rendered=!1;a.elementsToAddOrUpdate.set(c,b)});this.elements.clear();this.resetAtlasCursor();this.elementsToRender.clear()};b.prototype.processRenderingRequest=function(a){this.ctx.clearRect(a.placement.offset.x,a.placement.offset.y,a.placement.size.width,a.placement.size.height);a.textRenderer.render(this.ctx,
a.placement.offset.x,a.placement.offset.y);var b=this.stageObjects.get(a.textId);b&&b.forEach(function(b){b.geometries[0].data.vertexAttributes.uv0.data=new Float32Array(a.placement.uvMinMax);b.geometries[0].data.vertexAttributes.size.data=new Float32Array([a.placement.size.displayWidth,a.placement.size.displayHeight]);b.geometryVertexAttrsUpdated(0)});a.rendered=!0};b.prototype.run=function(a,b){var c=this;if(this.glTexture){var d=!1;q.someMap(this.elementsToAddOrUpdate,function(a,e){return(a=c.elements.get(e))&&
a.rendered?((a=c.stageObjects.get(e))&&a.forEach(function(a){var b=a.geometries[0].data.vertexAttributes,d=c.elements.get(e);b.uv0.data=new Float32Array(d.placement.uvMinMax);b.size.data=new Float32Array([d.placement.size.displayWidth,d.placement.size.displayHeight]);a.geometryVertexAttrsUpdated(0)}),c.elementsToAddOrUpdate.delete(e),!1):1===c._processAddition(c.elementsToAddOrUpdate.get(e),b)?d=!0:!1});if(d)this.run(r.noBudget,!1);else{var e=!1;0<this.elementsToRender.size&&this.needsClear&&(this.ctx.clearRect(0,
0,this.canvas.width,this.canvas.height),this.needsClear=!1);q.someMap(this.elementsToRender,function(b,d){c.processRenderingRequest(b);c.elementsToRender.delete(d);e=!0;a.madeProgress();return a.done});e&&m.isSome(this.glTexture)&&this.glTexture.setData(this.canvas);this.dirty=0<this.elementsToRender.size;this.dirty||(f.test.orderedRepackingEnabled&&this.repackOrdered(),this.notifyChange("updating"))}}};b.prototype.addTextTexture=function(a,b){var c=a.key;this.elementsToAddOrUpdate.has(c)||this.elementsToAddOrUpdate.set(c,
{textId:c,placement:{offset:{x:0,y:0},size:{width:0,height:0,displayWidth:0,displayHeight:0},uvMinMax:[]},textRenderer:a,rendered:!1});this.addStageObject(c,b);this.elementsToRemove.delete(c);this.setDirty()};b.prototype.removeTextTexture=function(a,b){a=a.key;this.elementsToRemove.set(a,this.elements.get(a));this.removeStageObject(a,b)};Object.defineProperty(b.prototype,"textureId",{get:function(){return this.id},enumerable:!1,configurable:!0});Object.defineProperty(b.prototype,"isDirty",{get:function(){return this.dirty},
enumerable:!1,configurable:!0});Object.defineProperty(b.prototype,"updating",{get:function(){return this.dirty&&!!this.frameWorker},enumerable:!1,configurable:!0});b.prototype.setDirty=function(){this.dirty||(this.dirty=!0,this.notifyChange("updating"))};b.prototype.repackOrdered=function(){if(0!==this.elements.size){var a=[];this.elements.forEach(function(b,c){return a.push({element:b,key:c})});for(var b=!0,c=0;c<a.length-1;c++)if(0<a[c].key.localeCompare(a[c+1].key)){b=!1;break}if(!b||this.elementsToRemove.size){a.sort(function(a,
b){return a.key.localeCompare(b.key)});this.elements.clear();for(b=0;b<a.length;b++)c=a[b],this.elements.set(c.key,c.element);this.repack();this.setDirty()}}};Object.defineProperty(b.prototype,"test",{get:function(){var a=this;return{elements:this.elements,stageObjects:this.stageObjects,elementsToRemove:this.elementsToRemove,atlas:this.atlas,resizeAtlas:function(b,c){return a.resizeAtlas(b,c)},run:function(b,c){return a.run(b,c)}}},enumerable:!1,configurable:!0});var f;b.test={orderedRepackingEnabled:!1};
k.__decorate([n.property({constructOnly:!0})],b.prototype,"idHint",void 0);k.__decorate([n.property({constructOnly:!0})],b.prototype,"view",void 0);k.__decorate([n.property({type:Boolean,readOnly:!0})],b.prototype,"updating",null);return b=f=k.__decorate([n.subclass("esri.views.3d.webgl-engine.lib.TextTextureAtlas")],b)}(v);g.TextTextureAtlas=f;var l=2,t=2;g.default=f});