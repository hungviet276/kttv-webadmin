// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.17/esri/copyright.txt for details.
//>>built
define("require exports tslib ../../core/Accessor ../../core/Logger ../../core/Queue ../../core/accessorSupport/decorators ./keys ./handlers/LatestPointerType".split(" "),function(t,f,l,v,w,x,m,u,y){Object.defineProperty(f,"__esModule",{value:!0});f.ViewEventPriorities=f.InputManager=void 0;var q=w.getLogger("esri.views.input.InputManager");t=function(n){function c(a){a=n.call(this,a)||this;a._pointerCaptures=new Map;a._nameToGroup={};a._handlers=[];a._currentPropagation=null;a._sourceEvents=new Set;
a._keyModifiers=new Set;a._activeKeyModifiers=new Set;a._stoppedPropagationEventIds=new Set;a.primaryKey=u.primaryKey;a.latestPointerType="mouse";a.test={timestamp:void 0};return a}l.__extends(c,n);c.prototype.initialize=function(){this.eventSource.onEventReceived=this._onEventReceived.bind(this);this._installRecognizers()};c.prototype.destroy=function(){for(var a=0,b=Object.keys(this._nameToGroup);a<b.length;a++)this.uninstallHandlers(b[a]);this.eventSource=null};Object.defineProperty(c.prototype,
"hasPendingInputs",{get:function(){return this._handlers.some(function(a){return a.handler.hasPendingInputs})},enumerable:!1,configurable:!0});c.prototype.installHandlers=function(a,b,d){var e=this;void 0===d&&(d=f.ViewEventPriorities.INTERNAL);if(this._nameToGroup[a])q.error("There is already an InputHandler group registered under the name `"+a+"`");else if(0===b.length)q.error("Can't register a group of zero handlers");else{var c={name:a,handlers:b.map(function(a){return{handler:a,active:!0,removed:!1,
priorityIndex:0,groupPriority:d,eventCallback:null,uninstallCallback:null}})};this._nameToGroup[a]=c;a=function(a){var b=c.handlers[a];g._handlers.push(b);b.handler.onInstall({updateDependencies:function(){e.updateDependencies()},emit:function(a,d,c,k,g){e._emitInputEvent(b.priorityIndex+1,a,d,c,g,k)},setPointerCapture:function(a,d){e._setPointerCapture(c,b,a,d)},setEventCallback:function(a){b.eventCallback=a},setUninstallCallback:function(a){b.uninstallCallback=a},refreshHasPendingInputs:function(){e.notifyChange("hasPendingInputs")}})};
var g=this;for(b=c.handlers.length-1;0<=b;b--)a(b);this.updateDependencies()}};c.prototype.uninstallHandlers=function(a){var b=this._nameToGroup[a];b?(b.handlers.forEach(function(a){a.removed=!0;a.uninstallCallback()}),delete this._nameToGroup[a],this._currentPropagation?this._currentPropagation.needsHandlerGarbageCollect=!0:this._garbageCollectRemovedHandlers()):q.error("There is no InputHandler group registered under the name `"+a+"`")};c.prototype.hasHandlers=function(a){return void 0!==this._nameToGroup[a]};
c.prototype.updateDependencies=function(){var a=new Set,b=new Set;this._handlersPriority=[];for(var d=this._handlers.length-1;0<=d;d--){var e=this._handlers[d];e.priorityIndex=d;this._handlersPriority.push(e)}this._handlersPriority=this._sortHandlersPriority(this._handlersPriority);for(d=this._handlersPriority.length-1;0<=d;d--){e=this._handlersPriority[d];e.priorityIndex=d;var c=e.handler.hasSideEffects;if(!c)for(var g=0,h=e.handler.outgoingEventTypes;g<h.length;g++)if(a.has(h[g])){c=!0;break}if(c)for(g=
0,h=e.handler.incomingEventMatches;g<h.length;g++){var p=h[g];a.add(p.eventType);for(var r=0,p=p.keyModifiers;r<p.length;r++){var f=p[r];u.isSystemModifier(f)||b.add(f)}}e.active=c}this._sourceEvents=a;this._keyModifiers=b;0<this._pointerCaptures.size&&this._sourceEvents.add("pointer-capture-lost");0<this._keyModifiers.size&&(this._sourceEvents.add("key-down"),this._sourceEvents.add("key-up"));this.eventSource&&(this.eventSource.activeEvents=this._sourceEvents)};c.prototype._setLatestPointerType=
function(a){this._set("latestPointerType",a)};c.prototype._onEventReceived=function(a,b){"pointer-capture-lost"===a&&this._pointerCaptures.delete(b.native.pointerId);this._updateKeyModifiers(a,b);this._emitInputEventFromSource(a,b,null!=this.test.timestamp?this.test.timestamp:b.native?b.native.timestamp:void 0,b.native?b.native.cancelable:void 0)};c.prototype._updateKeyModifiers=function(a,b){var d=this;if(b){var e=!1,c=function(){if(!e){var a=new Set;d._activeKeyModifiers.forEach(function(b){a.add(b)});
d._activeKeyModifiers=a;e=!0}},g=function(a,b){b&&!d._activeKeyModifiers.has(a)?(c(),d._activeKeyModifiers.add(a)):!b&&d._activeKeyModifiers.has(a)&&(c(),d._activeKeyModifiers.delete(a))};if("key-down"===a||"key-up"===a){var h=b.key;this._keyModifiers.has(h)&&g(h,"key-down"===a)}a=b.native;g("Alt",!(!a||!a.altKey));g("Ctrl",!(!a||!a.ctrlKey));g("Shift",!(!a||!a.shiftKey));g("Meta",!(!a||!a.metaKey));g("Primary",this._activeKeyModifiers.has(this.primaryKey))}};c.prototype._installRecognizers=function(){var a=
this;this._latestPointerTypeHandler=new y.LatestPointerType(function(b){return a._setLatestPointerType(b)});0<this.recognizers.length&&this.installHandlers("default",this.recognizers,f.ViewEventPriorities.INTERNAL);this.installHandlers("input-manager-logic",[this._latestPointerTypeHandler],f.ViewEventPriorities.INTERNAL)};c.prototype._setPointerCapture=function(a,b,d,c){a=a.name+"-"+b.priorityIndex;b=this._pointerCaptures.get(d.pointerId)||new Set;this._pointerCaptures.set(d.pointerId,b);c?(b.add(a),
1===b.size&&this.eventSource&&this.eventSource.setPointerCapture(d,!0)):b.has(a)&&(b.delete(a),0===b.size&&(this._pointerCaptures.delete(d.pointerId),this.eventSource&&this.eventSource.setPointerCapture(d,!1)))};c.prototype._garbageCollectRemovedHandlers=function(){this._handlers=this._handlers.filter(function(a){return!a.removed});this.updateDependencies()};c.prototype._emitInputEventFromSource=function(a,b,d,c){this._emitInputEvent(0,a,b,d,c)};c.prototype._emitInputEvent=function(a,b,d,c,k,g){c=
void 0!==c?c:this._currentPropagation?this._currentPropagation.timestamp:performance.now();a={event:new z(b,d,c,g||this._activeKeyModifiers,void 0!==k?k:!1),priorityIndex:a};this._currentPropagation?this._currentPropagation.events.push(a):this._doNewPropagation(a)};c.prototype._doNewPropagation=function(a){this._currentPropagation={events:new x.default,currentHandler:null,needsHandlerGarbageCollect:!1,timestamp:a.event.timestamp};this._currentPropagation.events.push(a);for(a=this._currentPropagation;0<
this._currentPropagation.events.length;){var b=this._currentPropagation.events.pop(),d=b.event,b=b.priorityIndex,c=d.data&&d.data.eventId;if(null==c||!this._stoppedPropagationEventIds.has(c))for(a.currentHandler=this._handlersPriority[b];a.currentHandler;){if(a.currentHandler.removed)a.needsHandlerGarbageCollect=!0;else if(a.currentHandler.active&&a.currentHandler.eventCallback(d),d.shouldStopPropagation()){null!=c&&this._stoppedPropagationEventIds.add(c);break}a.currentHandler=this._handlersPriority[a.currentHandler.priorityIndex+
1]}}a.needsHandlerGarbageCollect&&this._garbageCollectRemovedHandlers();this.hasPendingInputs||this._stoppedPropagationEventIds.clear();this._currentPropagation=null};c.prototype._compareHandlerPriority=function(a,b){if(a.handler.hasSideEffects!==b.handler.hasSideEffects)return a.handler.hasSideEffects?1:-1;if(a.groupPriority!==b.groupPriority)return a.groupPriority>b.groupPriority?-1:1;for(var c=0,e=a.handler.incomingEventMatches;c<e.length;c++)for(var k=e[c],g=function(a){if(k.eventType!==a.eventType)return"continue";
var b=k.keyModifiers.filter(function(b){return-1!==a.keyModifiers.indexOf(b)});if(b.length===k.keyModifiers.length!==(b.length===a.keyModifiers.length))return{value:k.keyModifiers.length>a.keyModifiers.length?-1:1}},h=0,f=b.handler.incomingEventMatches;h<f.length;h++){var n=g(f[h]);if("object"===typeof n)return n.value}return a.priorityIndex>b.priorityIndex?-1:1};c.prototype._sortHandlersPriority=function(a){for(var b=[],c=0;c<a.length;c++){for(var e=a[c],f=0;f<b.length&&0<=this._compareHandlerPriority(e,
b[f]);)f++;b.splice(f,0,e)}return b};Object.defineProperty(c.prototype,"debug",{get:function(){var a=this,b=function(b){var c=a._setPointerCapture;a._setPointerCapture=function(){};b();a._setPointerCapture=c};return{injectEvent:function(c,e){b(function(){a._onEventReceived(c,e)})},disablePointerCapture:b}},enumerable:!1,configurable:!0});l.__decorate([m.property({readOnly:!0})],c.prototype,"hasPendingInputs",null);l.__decorate([m.property()],c.prototype,"eventSource",void 0);l.__decorate([m.property()],
c.prototype,"recognizers",void 0);l.__decorate([m.property({readOnly:!0})],c.prototype,"latestPointerType",void 0);return c=l.__decorate([m.subclass("esri.views.input.InputManager")],c)}(v);f.InputManager=t;(function(){return function(){}})();var z=function(){function f(c,a,b,d,e){this.type=c;this.data=a;this.timestamp=b;this.modifiers=d;this.cancelable=e;this._stopPropagation=!1}f.prototype.stopPropagation=function(){this._stopPropagation=!0};f.prototype.shouldStopPropagation=function(){return this._stopPropagation};
f.prototype.preventDefault=function(){this.data.native.preventDefault()};return f}();f.ViewEventPriorities={DEFAULT:0,TOOL:-1,WIDGET:-2,INTERNAL:-3}});