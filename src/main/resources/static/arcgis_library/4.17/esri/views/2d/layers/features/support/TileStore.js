// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.17/esri/copyright.txt for details.
//>>built
define("require exports tslib ../../../../../core/Evented ../../../../../core/has ../../../../../core/libs/rbush/rbush ./Tile ../../../tiling/TileCoverage ../../../tiling/TileKey".split(" "),function(l,m,r,t,u,v,q,w,x){Object.defineProperty(m,"__esModule",{value:!0});var k={added:[],removed:[]},p=new Set,y=new x(0,0,0,0);l=function(l){function d(a){var c=l.call(this)||this;c._tiles=new Map;c._index=v(9,u("csp-restrictions")?function(a){return{minX:a.bounds[0],minY:a.bounds[1],maxX:a.bounds[2],maxY:a.bounds[3]}}:
[".bounds[0]",".bounds[1]",".bounds[2]",".bounds[3]"]);c.tiles=[];c.tileScheme=a;return c}r.__extends(d,l);d.prototype.destroy=function(){this.clear()};d.prototype.clear=function(){this.tiles.length=0;this._tiles.clear();this._index.clear()};d.prototype.has=function(a){return this._tiles.has(a)};d.prototype.get=function(a){return this._tiles.get(a)};d.prototype.findByKey=function(a){return this._tiles.get(a.id)};d.prototype.intersections=function(a,c){var e="string"===typeof a?this.get(a):a;if(!e)return[];
var g=c*e.resolution;c=e.bounds[0]-g;a=e.bounds[1]-g;for(var d=e.bounds[2]+g,e=e.bounds[3]+g,g=[],b=0,h=this._index.search({minX:c,minY:a,maxX:d,maxY:e});b<h.length;b++){var k=h[b],f=k.bounds.slice();f[0]=Math.max(f[0],c);f[1]=Math.max(f[1],a);f[2]=Math.min(f[2],d);f[3]=Math.min(f[3],e);0<f[2]-f[0]&&0<f[3]-f[1]&&g.push({bounds:f,tile:k})}return g};d.prototype.boundsIntersections=function(a){return this._index.search({minX:a[0],minY:a[1],maxX:a[2],maxY:a[3]})};d.prototype.updateTiles=function(a){for(var c=
this,e={added:[],removed:[]},g=0,d=a.added;g<d.length;g++){var b=d[g];if(!this.has(b)){var h=new q.default(this.tileScheme,b);this._tiles.set(b,h);this._index.insert(h);e.added.push(h)}}g=0;for(a=a.removed;g<a.length;g++)b=a[g],this.has(b)&&(h=this.get(b),this._tiles.delete(b),this._index.remove(h),e.removed.push(h));this.tiles.length=0;this._tiles.forEach(function(a){return c.tiles.push(a)});(e.added.length||e.removed.length)&&this.emit("update",e)};d.prototype.setViewState=function(a){if(a=this.tileScheme.getTileCoverage(a,
0)){var c=a.spans,e=a.lodInfo,d=e.level;if(0<c.length)for(var l=0;l<c.length;l++)for(var b=c[l],h=b.row,m=b.colTo,f=b.colFrom;f<=m;f++){var n=y.set(d,h,e.normalizeCol(f),e.getWorldForColumn(f)).id;p.add(n);this.has(n)||(b=new q.default(this.tileScheme,n),this._tiles.set(n,b),this._index.insert(b),this.tiles.push(b),k.added.push(b))}for(c=this.tiles.length-1;0<=c;c--)b=this.tiles[c],p.has(b.id)||(this._tiles.delete(b.id),this.tiles.splice(c,1),this._index.remove(b),k.removed.push(b));(k.added.length||
k.removed.length)&&this.emit("update",k);w.pool.release(a);p.clear();k.added.length=0;k.removed.length=0}};return d}(t);m.default=l});