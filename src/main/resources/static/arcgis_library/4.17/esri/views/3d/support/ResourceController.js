// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.17/esri/copyright.txt for details.
//>>built
define("require exports tslib ../../../core/Accessor ../../../core/Handles ../../../core/scheduling ../../../core/accessorSupport/decorators ./index ./MemoryController ./StreamDataLoader ../../support/Scheduler".split(" "),function(u,e,d,m,n,p,f,k,q,r,t){Object.defineProperty(e,"__esModule",{value:!0});e.newResourceController=e.ResourceControllerMain=void 0;var l=function(g){function b(){var b=null!==g&&g.apply(this,arguments)||this;b.updating=!1;return b}d.__extends(b,g);d.__decorate([f.property({readOnly:!0})],
b.prototype,"updating",void 0);return b=d.__decorate([f.subclass("esri.views.3d.support.ResourceController")],b)}(m);e.ResourceControllerMain=l;e.newResourceController=function(d,b){void 0===b&&(b=function(){return performance.now()});return new h.ResourceController({view:d,now:b})};var h;(function(e){var b=function(b){function a(){var c=null!==b&&b.apply(this,arguments)||this;c._scheduler=null;c._memoryController=null;c._streamDataLoader=null;c._cameraChangeTime=0;c._handles=new n;c._frameTask=null;
return c}d.__extends(a,b);a.prototype.initialize=function(){var c=this;this._cameraChangeTime=this.now();this._scheduler=t.newScheduler(this.now);this._memoryController=q.newMemoryController(this.view);this._streamDataLoader=new r.default;this._streamDataLoader.setup(k.maxDownloadSlots,k.downloadSlotsPerClient,this._scheduler);this._handles.add([this.view.watch("state.camera",function(a,b){return c._cameraChangedHandler(a,b)},!0),this.view.watch("stationary",function(){return c._stationaryChangedHandler()}),
this._memoryController.events.on("updating-changed",function(){return c.notifyChange("updating")})]);this._frameTask=p.addFrameTask({update:function(a){return c.frame(a)}})};a.prototype.destroy=function(){this._handles.destroy();this._handles=null;this._frameTask&&(this._frameTask.remove(),this._frameTask=null);this._streamDataLoader&&(this._streamDataLoader.destroy(),this._streamDataLoader=null);this._memoryController.destroy();this._memoryController=null;this._scheduler.destroy();this._scheduler=
null};Object.defineProperty(a.prototype,"updating",{get:function(){return!!(this._memoryController&&this._memoryController.updating||this._streamDataLoader&&this._streamDataLoader.updating)},enumerable:!1,configurable:!0});Object.defineProperty(a.prototype,"scheduler",{get:function(){return this._scheduler},enumerable:!1,configurable:!0});Object.defineProperty(a.prototype,"memoryController",{get:function(){return this._memoryController},enumerable:!1,configurable:!0});a.prototype.createStreamDataRequester=
function(c){var a=this._streamDataLoader;return{request:function(b,d,e){return a.request(b,d,c,e)},get busy(){return a.busy}}};a.prototype.frame=function(a){if(!this.view.suspended){if(this.view.stateManager&&(this.view.stateManager.step(a.deltaTime/1E3),!this._scheduler))return;this._scheduler.state=this.state;this._scheduler.updateBudget(a)?(this._memoryController.update(),this._scheduler.frame()):this._memoryController.updating&&this._memoryController.update()}};a.prototype._cameraChangedHandler=
function(a,b){a&&b&&a.almostEquals(b)||(this._cameraChangeTime=this._scheduler.now,this._scheduler.state=this.state)};a.prototype._stationaryChangedHandler=function(){this.memoryController.resetStableQuality()};Object.defineProperty(a.prototype,"state",{get:function(){var a=this.view;return a.animation?0:a.interacting||this._scheduler.now-this._cameraChangeTime<=g?1:2},enumerable:!1,configurable:!0});Object.defineProperty(a.prototype,"test",{get:function(){var a=this;return{getQueueStats:function(b){return a._streamDataLoader.test.loadQueue.getStatsForType(b)},
state:this.state}},enumerable:!1,configurable:!0});d.__decorate([f.property({constructOnly:!0})],a.prototype,"view",void 0);d.__decorate([f.property({constructOnly:!0})],a.prototype,"now",void 0);d.__decorate([f.property()],a.prototype,"_streamDataLoader",void 0);d.__decorate([f.property({readOnly:!0,dependsOn:["_streamDataLoader.updating"]})],a.prototype,"updating",null);return a=d.__decorate([f.subclass("esri.views.3d.support.ResourceController")],a)}(l);e.ResourceController=b;var g=300})(h||(h=
{}))});