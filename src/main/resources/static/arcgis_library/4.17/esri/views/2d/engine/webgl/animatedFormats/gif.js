// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.17/esri/copyright.txt for details.
//>>built
define(["require","exports","tslib","../../../../../core/Error","../../../../../core/promiseUtils"],function(u,h,r,v,t){function w(b){if(!b||0===b.byteLength)return!1;b=b.constructor===Uint8Array?b:new Uint8Array(b);return 71===b[0]&&73===b[1]&&70===b[2]&&56===b[3]}Object.defineProperty(h,"__esModule",{value:!0});h.isAnimatedGIF=h.getGIFSize=h.isGIF=void 0;h.isGIF=w;h.getGIFSize=function(b){var a=new Uint8ClampedArray(b),c=6;b=a[c++]+(a[c++]<<8);a=a[c++]+(a[c++]<<8);return[b,a]};h.isAnimatedGIF=function(b){if(!b||
0===b.byteLength)return!1;b=new Uint8Array(b);if(!w(b))return!1;for(var a=0,c=0,e=b.length-9;c<e&&(0!==b[c]||33!==b[c+1]||249!==b[c+2]||4!==b[c+3]||0!==b[c+8]||44!==b[c+9]&&33!==b[c+9]||(a++,!(1<a)));++c);return 1<a};u=function(){function b(){this.playing=this.paused=!1;this.waitTillDone=!0;this.firstFrameOnly=this.loading=!1;this.frames=[];this.comment="";this.frameCount=this.currentFrameNumber=this.length=0;this.playSpeed=1;this.lastFrame=null;this.playOnLoad=!0;this.complete=!1;this.interlaceOffsets=
[0,4,2,1];this.interlaceSteps=[8,8,4,2];this._lastUsedFrame=-1}b.create=function(a,c){return r.__awaiter(this,void 0,void 0,function(){var e,d;return r.__generator(this,function(f){switch(f.label){case 0:e=new b,f.label=1;case 1:return f.trys.push([1,3,,4]),[4,e._load(a,c)];case 2:return f.sent(),[3,4];case 3:return d=f.sent(),t.isAbortError(d)?[3,4]:[2,new v("invalid-resource","Could not load PNG: "+d.message)];case 4:return[2,e]}})})};b.prototype.play=function(){this.playing||(this.paused=!1,this.playing=
!0,this._play())};b.prototype.pause=function(){this.paused=!0;this.playing=!1;clearTimeout(this.timerID)};b.prototype.togglePlay=function(){this.paused||!this.playing?this.play():this.pause()};b.prototype.bindFrame=function(a,c,b){a.bindTexture(c,b);if(a=this.frameChanged())b=this.currentFrame,c.updateData(0,0,0,b.width,b.height,b.frameData),this.updateUsedFrame();return a};b.prototype.seekFrame=function(a){clearTimeout(this.timerID);this.currentFrameNumber=a%this.frames.length;this.playing?this._play():
this._setCurrentFrame(this.currentFrameNumber)};b.prototype.seek=function(a){clearTimeout(this.timerID);0>a&&(a=0);a=1E3*a%this.length;for(var c=0;a>this.frames[c].time+this.frames[c].delay&&c<this.frames.length;)c+=1;this.currentFrameNumber=c;this.playing?this._play():this._setCurrentFrame(this.currentFrameNumber)};b.prototype.frameChanged=function(){return this._lastUsedFrame!==this.currentFrameNumber};b.prototype.updateUsedFrame=function(){this._lastUsedFrame=this.currentFrameNumber};b.prototype._load=
function(a,c){return r.__awaiter(this,void 0,void 0,function(){var b;return r.__generator(this,function(d){switch(d.label){case 0:return d.trys.push([0,2,,3]),this.loading=!0,[4,this._parse(a,c)];case 1:return d.sent(),this.loading=!1,this.play(),[3,3];case 2:return b=d.sent(),t.isAbortError(b)?[3,3]:[2,new v("invalid-resource","Could not parse gif!")];case 3:return[2]}})})};b.prototype._parse=function(a,c){var b=this,d=new x(a);d.pos+=6;this.width=d.data[d.pos++]+(d.data[d.pos++]<<8);this.height=
d.data[d.pos++]+(d.data[d.pos++]<<8);a=d.data[d.pos++];this.globalColourCount=1<<(a&7)+1;d.pos++;d.pos++;a&128&&(this.globalColourTable=this._parseColourTable(this.globalColourCount,d));return t.create(function(a,e){setTimeout(function(){return b._parseBlock(d,a,e,c)},0)})};b.prototype._parseBlock=function(a,c,b,d){return r.__awaiter(this,void 0,void 0,function(){var e,g=this;return r.__generator(this,function(f){if(d&&d.signal&&t.isAborted(d.signal))return b(t.createAbortError()),[2];e=a.data[a.pos++];
if(44===e){if(this._parseImg(a),this.firstFrameOnly)return this._finishedLoading(),c(),[2]}else{if(59===e)return this._finishedLoading(),c(),[2];this._parseExt(a)}if("function"===typeof this.onprogress)this.onprogress({bytesRead:a.pos,totalBytes:a.data.length,frame:this.frames.length});setTimeout(function(){return g._parseBlock(a,c,b,d)},0);return[2]})})};b.prototype._parseColourTable=function(a,c){for(var b=[],d=0;d<a;d++)b.push([c.data[c.pos++],c.data[c.pos++],c.data[c.pos++]]);return b};b.prototype._parseImg=
function(a){var c={};this.frames.push(c);c.disposalMethod=this.disposalMethod;c.time=this.length;c.delay=10*this.delayTime;this.length+=c.delay;c.transparencyIndex=this.transparencyGiven?this.transparencyIndex:void 0;c.leftPos=a.data[a.pos++]+(a.data[a.pos++]<<8);c.topPos=a.data[a.pos++]+(a.data[a.pos++]<<8);c.width=a.data[a.pos++]+(a.data[a.pos++]<<8);c.height=a.data[a.pos++]+(a.data[a.pos++]<<8);var b=a.data[a.pos++];c.localColourTableFlag=b&128?!0:!1;c.localColourTableFlag&&(c.localColourTable=
this._parseColourTable(1<<(b&7)+1,a));this.pixelBufSize!==c.width*c.height&&(this.pixelBuf=new Uint8Array(c.width*c.height),this.pixelBufSize=c.width*c.height);this._lzwDecode(a.data[a.pos++],a.readSubBlocksB());if(b&64){c.interlaced=!0;a=c.width;b=this.pixelBufSize/a;this.interlacedBufSize!==this.pixelBufSize&&(this.deinterlaceBuf=new Uint8Array(this.pixelBufSize),this.interlacedBufSize=this.pixelBufSize);for(var d=0,f=0;4>f;f++)for(var g=this.interlaceOffsets[f];g<b;g+=this.interlaceSteps[f])this.deinterlaceBuf.set(this.pixelBuf.subarray(d,
d+a),g*a),d+=a}else c.interlaced=!1;this._processFrame(c)};b.prototype._lzwDecode=function(a,c){var b,d,f,g,h,n,k,m,p,q;f=d=0;var l=[];g=1<<a;h=g+1;n=a+1;for(q=!1;!q;){m=k;for(b=k=0;b<n;b++)c[f>>3]&1<<(f&7)&&(k|=1<<b),f++;if(k===g){l=[];n=a+1;for(b=0;b<g;b++)l[b]=[b];l[g]=[];l[h]=null}else{if(k===h){q=!0;break}k>=l.length?l.push(l[m].concat(l[m][0])):m!==g&&l.push(l[m].concat(l[k][0]));m=l[k];p=m.length;for(b=0;b<p;b++)this.pixelBuf[d++]=m[b];l.length===1<<n&&12>n&&n++}}};b.prototype._processFrame=
function(a){a.image=document.createElement("canvas");a.image.width=this.width;a.image.height=this.height;a.ctx=a.image.getContext("2d");var b=a.localColourTableFlag?a.localColourTable:this.globalColourTable;null===this.lastFrame&&(this.lastFrame=a);var e=2===this.lastFrame.disposalMethod||3===this.lastFrame.disposalMethod?!0:!1;e||a.ctx.drawImage(this.lastFrame.image,0,0,this.width,this.height);for(var d=a.ctx.getImageData(a.leftPos,a.topPos,a.width,a.height),f=a.transparencyIndex,g=d.data,h=a.interlaced?
this.deinterlaceBuf:this.pixelBuf,n=h.length,k=0,m,p,q=0;q<n;q++)m=h[q],p=b[m],f!==m?(g[k++]=p[0],g[k++]=p[1],g[k++]=p[2],g[k++]=255):(e&&(g[k+3]=0),k+=4);a.ctx.putImageData(d,a.leftPos,a.topPos);this.lastFrame=a};b.prototype._parseExt=function(a){var b=a.data[a.pos++];249===b?this._parseGCExt(a):254===b?this.comment+=a.readSubBlocks():255===b?this._parseAppExt(a):(1===b&&(a.pos+=13),a.readSubBlocks())};b.prototype._parseAppExt=function(a){a.pos+=1;"NETSCAPE"===a.getString(8)?a.pos+=8:(a.pos+=3,a.readSubBlocks())};
b.prototype._parseGCExt=function(a){var b;a.pos++;b=a.data[a.pos++];this.disposalMethod=(b&28)>>2;this.transparencyGiven=b&1?!0:!1;this.delayTime=a.data[a.pos++]+(a.data[a.pos++]<<8);this.transparencyIndex=a.data[a.pos++];a.pos++};b.prototype._finishedLoading=function(){this.loading=!1;this.frameCount=this.frames.length;this.lastFrame=null;this.complete=!0;this.deinterlaceBuf=this.pixelBufSize=this.deinterlaceBuf=this.pixelBuf=this.waitTillDone=this.transparencyIndex=this.delayTime=this.transparencyGiven=
this.disposalMethod=void 0;this.currentFrameNumber=0;0<this.frames.length&&this._setCurrentFrame(0);this.playOnLoad&&this.play()};b.prototype._play=function(){var a=this,b;0===this.playSpeed?this.pause():(0>this.playSpeed?(--this.currentFrameNumber,0>this.currentFrameNumber&&(this.currentFrameNumber=this.frames.length-1),b=this.currentFrameNumber,--b,0>b&&(b=this.frames.length-1),b=1*-this.frames[b].delay/this.playSpeed):(this.currentFrameNumber+=1,this.currentFrameNumber%=this.frames.length,b=1*
this.frames[this.currentFrameNumber].delay/this.playSpeed),this._setCurrentFrame(this.currentFrameNumber),this.timerID=window.setTimeout(function(){return a._play()},b))};b.prototype._setCurrentFrame=function(a){this.currentFrame={frameData:this.frames[a].image,top:0,left:0,width:this.width,height:this.height}};return b}();h.default=u;var x=function(){function b(a){this.pos=0;this.data=new Uint8ClampedArray(a);this.len=this.data.length}b.prototype.getString=function(a){for(var b="";a--;)b+=String.fromCharCode(this.data[this.pos++]);
return b};b.prototype.readSubBlocks=function(){var a,b,e="";do for(b=a=this.data[this.pos++];b--;)e+=String.fromCharCode(this.data[this.pos++]);while(0!==a&&this.pos<this.len);return e};b.prototype.readSubBlocksB=function(){var a,b,e=[];do for(b=a=this.data[this.pos++];b--;)e.push(this.data[this.pos++]);while(0!==a&&this.pos<this.len);return e};return b}()});