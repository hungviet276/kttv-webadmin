// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.17/esri/copyright.txt for details.
//>>built
define("require exports ../../../../core/has ../../../../core/maybe ../../../../core/screenUtils ../../../../core/libs/gl-matrix-2/mat2d ../../../../core/libs/gl-matrix-2/mat2df32 ../../../../core/libs/gl-matrix-2/vec2 ../../../../core/libs/gl-matrix-2/vec2f32 ../../../../geometry/SpatialReference ../../../../geometry/support/aaBoundingRect ../../../../geometry/support/boundsUtils ../../../../geometry/support/intersects ../../../../geometry/support/jsonUtils ../../../../geometry/support/normalizeUtils ../../../../geometry/support/spatialReferenceUtils ../../../../geometry/support/spatialReferenceUtils ../../../../symbols/cim/CIMSymbolHelper ../../engine/webgl/alignmentUtils ../../engine/webgl/mesh/templates/shapingUtils ../../engine/webgl/util/BidiText".split(" "),
function(ha,l,ia,V,q,p,W,e,u,y,X,H,I,r,J,Y,Z,K,L,aa,ba){function M(a,b,c,d,f,g){var m,h,k=q.pt2px(c.xoffset),ca=q.pt2px(c.yoffset),l=t*c.angle;g*=t;switch(c.type){case "esriSMS":m=h=q.pt2px(c.size);break;case "esriPMS":m=q.pt2px(c.width),h=q.pt2px(c.height)}.04>f&&(d=.04*d/f);c=p.mat2d.identity(C);p.mat2d.translate(c,c,e.vec2.set(n,a,b));p.mat2d.rotate(c,c,g-l);p.mat2d.scale(c,c,e.vec2.set(n,d,-d));p.mat2d.translate(c,c,e.vec2.set(n,k,-ca));a=[0,0];e.vec2.transformMat2d(a,e.vec2.set(n,-.5*m,-.5*h),
c);b=[0,0];e.vec2.transformMat2d(b,e.vec2.set(n,-.5*m,.5*h),c);d=[0,0];e.vec2.transformMat2d(d,e.vec2.set(n,.5*m,-.5*h),c);k=[0,0];e.vec2.transformMat2d(k,e.vec2.set(n,.5*m,.5*h),c);return{rings:[[a,d,k,b,a]]}}function N(a,b,c,d,f,g){var m=K.CIMSymbolHelper.getEnvelope(c.data);if(!m)return null;.04>f&&(d=.04*d/f);f=q.pt2px(m.width);var h=q.pt2px(m.height);c=q.pt2px(m.x);var m=q.pt2px(m.y),k=0*t,l=t*g;g=p.mat2d.identity(C);p.mat2d.translate(g,g,e.vec2.set(n,a,b));p.mat2d.rotate(g,g,l-k);p.mat2d.scale(g,
g,e.vec2.set(n,d,d));a=[0,0];e.vec2.transformMat2d(a,e.vec2.set(n,c,m+h),g);b=[0,0];e.vec2.transformMat2d(b,e.vec2.set(n,c,m),g);d=[0,0];e.vec2.transformMat2d(d,e.vec2.set(n,c+f,m+h),g);h=[0,0];e.vec2.transformMat2d(h,e.vec2.set(n,c+f,m),g);return{rings:[[a,d,h,b,a]]}}function O(a,b,c,d,f,g){var m=q.pt2px(c.xoffset),h=q.pt2px(c.yoffset);c=t*c.angle;var k=t*g;g=p.mat2d.identity(C);p.mat2d.translate(g,g,e.vec2.set(n,a,b));p.mat2d.rotate(g,g,k);p.mat2d.scale(g,g,e.vec2.set(n,f,-f));a=d[0]+d[2]/2;b=d[1]+
d[3]/2;p.mat2d.translate(g,g,e.vec2.set(n,m,-h));p.mat2d.translate(g,g,e.vec2.set(n,a,b));p.mat2d.rotate(g,g,c);p.mat2d.translate(g,g,e.vec2.set(n,-a,-b));m=[0,0];e.vec2.transformMat2d(m,e.vec2.set(n,d[0],d[1]),g);h=[0,0];e.vec2.transformMat2d(h,e.vec2.set(n,d[0],d[1]+d[3]),g);c=[0,0];e.vec2.transformMat2d(c,e.vec2.set(n,d[0]+d[2],d[1]),g);a=[0,0];e.vec2.transformMat2d(a,e.vec2.set(n,d[0]+d[2],d[1]+d[3]),g);return{rings:[[m,c,a,h,m]]}}function P(a){switch(a.symbol.type){case "esriSFS":case "esriPFS":return(a=
a.symbol.outline)?a.width:0;case "esriSLS":return a.symbol.width;case "esriSMS":return a.symbol.size;case "esriPMS":return Math.max(a.symbol.width,a.symbol.height);case "esriTS":var b=[0,0,0,0];D(b,a.symbol,a.mosaicItem);return Math.max(b[2],b[3])+Math.max(Math.abs(b[0]),Math.abs(b[1]));case "expanded-cim":return a=K.CIMSymbolHelper.getEnvelope(a.symbol.data),Math.sqrt(a.width*a.width+a.height*a.height);case "composite-symbol":return a.symbol.layers.length?P({symbol:a.symbol.layers[a.symbol.layers.length-
1],mosaicItem:null}):0;default:return 0}}function D(a,b,c){if(!c||0===c.glyphMosaicItems.length)return a;var d=ba.bidiText(b.text)[1];b=aa.shapeGlyphs(c.glyphMosaicItems,d,{scale:q.pt2px(b.font.size)/24,angle:b.angle,xOffset:b.xoffset,yOffset:b.yoffset,hAlign:L.getXAnchorDirection(b.horizontalAlignment||"center"),vAlign:L.getYAnchorDirection(b.verticalAlignment||"baseline"),maxLineWidth:Math.max(32,Math.min(b.lineWidth||512,512)),lineHeight:30*Math.max(.25,Math.min(b.lineHeight||1,4)),decoration:b.font.decoration||
"none",isCIM:!1}).bounds;a[0]=b.x-b.halfWidth;a[1]=b.y-b.halfHeight;a[2]=b.width;a[3]=b.height;return a}function v(a,b){return Math.ceil((a-b)/(2*b))}function da(a,b){var c;c=r.isPolygon(a)?a.rings:a.paths;for(var d=0;d<c.length;d++)for(var f=0,g=c[d];f<g.length;f++)g[f][0]+=b;return a}function ea(a,b){if(!b)return a;var c=fa(a,b).map(function(a){return a.extent});return 2>c.length?c[0]||a:2<c.length?(a.xmin=b.valid[0],a.xmax=b.valid[1],a):{rings:c.map(function(a){return[[a.xmin,a.ymin],[a.xmin,a.ymax],
[a.xmax,a.ymax],[a.xmax,a.ymin],[a.xmin,a.ymin]]})}}function fa(a,b){var c=[],d=a.ymin,f=a.ymax,g=a.xmax-a.xmin,m=a.xmin,h=a.xmax,k,e=b.valid,l=e[0],n=e[1];k=Q(a.xmin,b);var p=k.x,e=k.frameId;k=Q(a.xmax,b);b=k.x;a=k.frameId;k=p===b&&0<g;if(g>2*n){g={xmin:m<h?p:b,ymin:d,xmax:n,ymax:f};m={xmin:l,ymin:d,xmax:m<h?b:p,ymax:f};h={xmin:0,ymin:d,xmax:n,ymax:f};d={xmin:l,ymin:d,xmax:0,ymax:f};f=[];l=[];z(g,h)&&f.push(e);z(g,d)&&l.push(e);z(m,h)&&f.push(a);z(m,d)&&l.push(a);for(n=e+1;n<a;n++)f.push(n),l.push(n);
c.push({extent:g,frameIds:[e]},{extent:m,frameIds:[a]},{extent:h,frameIds:f},{extent:d,frameIds:l})}else p>b||k?c.push({extent:{xmin:p,ymin:d,xmax:n,ymax:f},frameIds:[e]},{extent:{xmin:l,ymin:d,xmax:b,ymax:f},frameIds:[a]}):c.push({extent:{xmin:p,ymin:d,xmax:b,ymax:f},frameIds:[e]});return c}function Q(a,b){var c=b.valid;b=c[0];var d=c[1],c=2*d,f=0;a>d?(b=Math.ceil(Math.abs(a-d)/c),a-=b*c,f=b):a<b&&(b=Math.ceil(Math.abs(a-b)/c),a+=b*c,f=-b);return{x:a,frameId:f}}function z(a,b){var c=b.xmin,d=b.ymin,
f=b.xmax;b=b.ymax;return A(a,c,d)&&A(a,c,b)&&A(a,f,b)&&A(a,f,d)}function A(a,b,c){return b>=a.xmin&&b<=a.xmax&&c>=a.ymin&&c<=a.ymax?!0:!1}function R(a,b,c){if(Array.isArray(a)){var d=a[0];if(d>b){var f=v(d,b);a[0]=d+-2*f*b}else d<c&&(f=v(d,c),a[0]=d+-2*f*c)}else d=a.x,d>b?(f=v(d,b),a.x+=-2*f*b):d<c&&(f=v(d,c),a.x+=-2*f*c);return a}Object.defineProperty(l,"__esModule",{value:!0});l.getTextSymbolSize=l.normalizeCentralMeridian=l.getTextSymbolBounds=l.getCIMMarkerBounds=l.getMarkerSymbolBounds=l.isPointOnPolyline=
l.graphicGeometryToNumber=l.isMarkerSymbol=l.getBounds=void 0;var t=Math.PI/180,C=W.mat2df32.create(),n=u.vec2f32.create(),w=X.create();l.getBounds=function(a,b,c,d,f,g,e){if(!d||!c.symbol)return a[0]=a[1]=a[2]=a[3]=0,b[0]=b[1]=b[2]=b[3]=0,a;if(r.isPoint(d)){var h=d.x;d=d.y;"esriTS"===c.symbol.type&&0===b[2]&&0===b[3]&&D(b,c.symbol,c.mosaicItem);c=c.symbol;var k;switch(c.type){case "esriSMS":case "esriPMS":k=M(h,d,c,f,g,0);break;case "esriTS":k=O(h,d,c,b,f,0);break;case "cim":case "CIMSymbolReference":case "expanded-cim":k=
N(h,d,c,f,g,0)}for(f=b=0;f<k.rings[0].length-1;f++)c=k.rings[0][f],c=(h-c[0])*(h-c[0])+(d-c[1])*(d-c[1]),b=Math.max(b,c);b=Math.sqrt(b);k=J.normalizeMapX(h-b,e);h=J.normalizeMapX(h+b,e);k>h&&(e=Z.getInfo(e))&&(h=e.valid,e=h[1],k=h[0],h=e);a[0]=k;a[1]=d-b;a[2]=h;a[3]=d+b}else H.getBoundsXY(a,d),d=b[0],0===d&&(d=P(c),b[0]=d),d=f*d/2,a[0]-=d,a[1]-=d,a[2]+=d,a[3]+=d;return a};l.isMarkerSymbol=function(a){return"simple-marker"===a||"picture-marker"===a||"text"===a};l.graphicGeometryToNumber=function(a){switch(V.unwrap(a.geometry).type){case "polyline":return 1;
case "polygon":case "extent":return 2}return 0};var E=u.vec2f32.create(),S=u.vec2f32.create(),T=u.vec2f32.create(),x=u.vec2f32.create(),F=u.vec2f32.create(),U=u.vec2f32.create(),G=u.vec2f32.create();l.isPointOnPolyline=function(a,b,c,d){e.vec2.set(T,b,c);a=a.paths;for(var f,g,m,h,k,l,n,p,q=Infinity,u=0;u<a.length;u++){var r=a[u];if(!(2>r.length))for(var t=1;t<r.length;t++)f=r[t-1][0],m=r[t-1][1],g=r[t][0],h=r[t][1],k=Math.min(f,g)-d,l=Math.min(m,h)-d,n=Math.max(f,g)+d,p=Math.max(m,h)+d,b<k||b>n||
c<l||c>p||(e.vec2.set(E,f,m),e.vec2.set(S,g,h),e.vec2.subtract(x,S,E),e.vec2.subtract(F,E,T),e.vec2.scale(U,x,e.vec2.dot(x,F)/e.vec2.dot(x,x)),e.vec2.subtract(G,F,U),f=e.vec2.dot(G,G),q>f&&(q=f))}return Math.sqrt(q)<=d};l.getMarkerSymbolBounds=M;l.getCIMMarkerBounds=N;l.getTextSymbolBounds=O;l.normalizeCentralMeridian=function(a){var b,c,d,f,g,e=null;if(!a)return null;if("mesh"===a.type)return a.toJSON();b=a.spatialReference;c=Y.getInfo(b);if(!c)return a.toJSON();g=b.isWebMercator?102100:4326;d=B[g].maxX;
f=B[g].minX;b=B[g].plus180Line;g=B[g].minus180Line;var h,k=a.toJSON();r.isPoint(k)?h=R(k,d,f):r.isMultipoint(k)?(k.points=k.points.map(function(a){return R(a,d,f)}),h=k):r.isExtent(k)?h=ea(k,c):r.isPolygon(k)||r.isPolyline(k)?(H.getBoundsXY(w,k),a={xmin:w[0],ymin:w[1],xmax:w[2],ymax:w[3]},c=2*v(a.xmin,f)*d,k=0===c?k:da(k,c),a.xmin+=c,a.xmax+=c,I.extentIntersectsPolyline(a,b)&&a.xmax!==d?e=k:I.extentIntersectsPolyline(a,g)&&a.xmin!==f?e=k:h=k):h=a.clone();return null!==e?(new ga).cut(e,d):h};l.getTextSymbolSize=
D;var B={102100:{maxX:2.0037508342788905E7,minX:-2.0037508342788905E7,plus180Line:{paths:[[[2.0037508342788905E7,-2.0037508342788905E7],[2.0037508342788905E7,2.0037508342788905E7]]],spatialReference:y.WebMercator},minus180Line:{paths:[[[-2.0037508342788905E7,-2.0037508342788905E7],[-2.0037508342788905E7,2.0037508342788905E7]]],spatialReference:y.WebMercator}},4326:{maxX:180,minX:-180,plus180Line:{paths:[[[180,-180],[180,180]]],spatialReference:y.WGS84},minus180Line:{paths:[[[-180,-180],[-180,180]]],
spatialReference:y.WGS84}}},ga=function(){function a(){}a.prototype.cut=function(a,c){var b;if(a.rings)this.closed=!0,b=a.rings,this.minPts=4;else if(a.paths)this.closed=!1,b=a.paths,this.minPts=2;else return null;var f=b.length;c*=-2;for(var g=0;g<f;g++){var e=b[g];if(e&&e.length>=this.minPts){for(var h=[],k=0;k<e.length;k++){var l=e[k];h.push([l[0]+c,l[1]])}b.push(h)}}this.closed?a.rings=b:a.paths=b;return a};return a}()});