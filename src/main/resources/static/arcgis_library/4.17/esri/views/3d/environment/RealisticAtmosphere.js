// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.17/esri/copyright.txt for details.
//>>built
define("require exports ../../../core/Handles ../../../core/promiseUtils ../../../core/watchUtils ../../../core/libs/gl-matrix-2/mat4 ../../../core/libs/gl-matrix-2/mat4f64 ../../../core/libs/gl-matrix-2/vec2 ../../../core/libs/gl-matrix-2/vec2f64 ../../../core/libs/gl-matrix-2/vec3 ../../../core/libs/gl-matrix-2/vec3f64 ../../../core/libs/gl-matrix-2/vec4 ../../../core/libs/gl-matrix-2/vec4f64 ../../../geometry/support/geodesicConstants ./atmosphereUtils ./RealisticAtmosphereTechnique ../support/buffer/glUtil ../support/buffer/InterleavedLayout ../webgl-engine/lib/DefaultVertexAttributeLocations ../../webgl/BufferObject ../../webgl/VertexArrayObject".split(" "),
function(d,g,E,F,u,v,w,x,r,k,h,y,m,n,z,t,G,H,I,J,K){Object.defineProperty(g,"__esModule",{value:!0});g.RealisticAtmosphere=void 0;d=function(){function b(a,c){this._view=a;this.canRender=!0;this._skyslot=14;this._hazeSlot=15;this._renderData={texDepth:r.vec2f64.create(),cameraPosition:h.vec3f64.create(),projectionInverse:w.mat4f64.create(),viewInverse:w.mat4f64.create(),heightParameters:m.vec4f64.create(),atmosphereParameters1:m.vec4f64.create(),atmosphereParameters2:m.vec4f64.create(),atmosphereParameters3:h.vec3f64.create(),
invWavelength:A,invWavelengthScaled:l,radii:r.vec2f64.create(),scale:0,scaleDepth:p,lowerAlphaBlendBound:0,scaleOverScaleDepth:0,oneOverScaleDepth:0,scaleDepthBlue:q,oneOverScaleDepthBlue:B,scaleOverScaleDepthBlue:0,g:e,g2:e*e,miePhaseCoefficients:C,nearFar:r.vec2f64.create(),cameraHeight:0,cameraHeightSq:0,C:0,CSur:0,innerFadeDistance:0,altitudeFade:0};this._lowerElevationBoundRadius=0;this._lowerBoundEarthRadius=n.earthRadius;this._updateRadius(n.earthRadius);this._techniqueRepository=c;this._atmosphereTechniqueConfig=
new t.RealisticAtmosphereTechniqueConfiguration}b.prototype.destroy=function(){this._handles&&(this._handles.destroy(),this._handles=null);this._vao&&(this._vao.dispose(),this._vao=null)};b.prototype.when=function(){return F.resolve()};b.prototype.initializeRenderContext=function(a){var c=this;a=a.rctx;this._handles=new E;this._updateElevation({spatialReference:this._view.basemapTerrain.spatialReference,tile:this._view.basemapTerrain.rootTiles[0],extent:this._view.basemapTerrain.rootTiles[0].extent,
context:"ground"});this._handles.add(u.on(this._view,"basemapTerrain","elevation-change",function(a){return c._updateElevation(a)},function(){return c._updateElevation()}));this._handles.add(u.on(this._view,"basemapTerrain","elevation-bounds-change",function(){return c._updateVisibleElevationBounds()},function(){return c._updateVisibleElevationBounds()}));this._atmosphereTechniqueConfig.haze=!1;this._atmosphereTechnique=this._techniqueRepository.acquireAndReleaseExisting(t.RealisticAtmosphereTechnique,
this._atmosphereTechniqueConfig,this._atmosphereTechnique);this._atmosphereTechniqueConfig.haze=!0;this._atmosphereHazeTechnique=this._techniqueRepository.acquireAndReleaseExisting(t.RealisticAtmosphereTechnique,this._atmosphereTechniqueConfig,this._atmosphereHazeTechnique);this._vao=this._createVertexArrayObject(a)};b.prototype.uninitializeRenderContext=function(){this.destroy()};b.prototype.render=function(a){if(a.slot!==this._hazeSlot&&a.slot!==this._skyslot||0!==a.pass)return!1;this._update(a.camera);
a.slot===this._skyslot&&this._renderSky(a);a.slot===this._hazeSlot&&this._renderHaze(a);return!0};b.prototype._renderSky=function(a){var c=a.rctx,b=this._atmosphereTechnique.program;c.bindProgram(b);this._atmosphereTechnique.bindPipelineState(c);b.setUniform3fv("atmosphereParameters3",this._renderData.atmosphereParameters3);this._renderCommon(b,a)};b.prototype._renderHaze=function(a){var c=this,b=a.rctx,e=a.offscreenRenderingHelper,d=this._atmosphereHazeTechnique.program;b.bindProgram(d);this._atmosphereHazeTechnique.bindPipelineState(b);
e.renderDepthDetached(function(){b.bindTexture(e.depthTexture,0);d.setUniform1i("depthTex",0);c._renderCommon(d,a)})};b.prototype._renderCommon=function(a,c){var b=c.rctx;a.setUniform3fv("invWavelength",this._renderData.invWavelength);a.setUniform3fv("invWavelengthScaled",this._renderData.invWavelengthScaled);c.scenelightingData.setLightDirectionUniform(a);a.setUniform4fv("heightParameters",this._renderData.heightParameters);a.setUniform3fv("cameraPosition",this._renderData.cameraPosition);a.setUniformMatrix4fv("projectionInverse",
this._renderData.projectionInverse);a.setUniformMatrix4fv("viewInverse",this._renderData.viewInverse);a.setUniform2fv("nearFar",this._renderData.nearFar);a.setUniform2fv("radii",this._renderData.radii);a.setUniform4fv("atmosphereParameters1",this._renderData.atmosphereParameters1);a.setUniform4fv("atmosphereParameters2",this._renderData.atmosphereParameters2);a.setUniform1f("innerFadeDistance",this._renderData.innerFadeDistance);a.setUniform1f("altitudeFade",this._renderData.altitudeFade);b.bindVAO(this._vao);
a.assertCompatibleVertexAttributeLocations(this._vao);b.drawArrays(5,0,4)};b.prototype._createVertexArrayObject=function(a){var c=D.createBuffer(4);c.position.setVec(0,[-1,-1]);c.position.setVec(1,[1,-1]);c.position.setVec(2,[-1,1]);c.position.setVec(3,[1,1]);c.uv0.setVec(0,[0,0]);c.uv0.setVec(1,[1,0]);c.uv0.setVec(2,[0,1]);c.uv0.setVec(3,[1,1]);return new K(a,I.Default3D,{geometry:G.glLayout(D)},{geometry:J.createVertex(a,35044,c.buffer)})};b.prototype._adjustRadiusForTesselation=function(a){return a*
Math.cos(Math.PI/Math.pow(2,4)/16)};b.prototype._updateElevation=function(a){a=a?a.tile:this._view.basemapTerrain.rootTiles[0];0===a.lij[0]&&(a=this._adjustRadiusForTesselation(n.earthRadius+a.elevationBounds[0]),a!==this._lowerElevationBoundRadius&&(this._lowerElevationBoundRadius=a,this._lowerBoundEarthRadius=-1,this._updateVisibleElevationBounds()))};b.prototype._updateVisibleElevationBounds=function(){var a=this._adjustRadiusForTesselation(n.earthRadius+this._view.basemapTerrain.elevationBounds.min);
(0>this._lowerBoundEarthRadius||a<this._lowerBoundEarthRadius)&&this._updateRadius(a)};b.prototype._updateRadius=function(a){this._lowerBoundEarthRadius=a;var c=a/10*10.25,b=1/(c-a),d=b/p,g=b/q,h=.3*(c-a)+a,f=this._renderData;y.vec4.set(f.atmosphereParameters1,b,p,d,L);y.vec4.set(f.atmosphereParameters2,e,q,g,B);k.vec3.set(f.atmosphereParameters3,e*e,C,h);x.vec2.set(f.radii,a,c);f.scale=b;f.lowerAlphaBlendBound=h;f.scaleOverScaleDepth=d;f.scaleOverScaleDepthBlue=g;c=z.INNER_ATMOSPHERE_DEPTH;f.innerFadeDistance=
2*Math.sqrt((2*a-c)*c)};b.prototype._update=function(a){a&&(this._renderData.cameraHeight=k.vec3.length(a.eye),this._renderData.cameraHeightSq=this._renderData.cameraHeight*this._renderData.cameraHeight,this._renderData.C=this._renderData.cameraHeightSq-this._renderData.radii[1]*this._renderData.radii[1],this._renderData.CSur=this._renderData.cameraHeightSq-this._renderData.radii[0]*this._renderData.radii[0],this._renderData.heightParameters=m.vec4f64.fromValues(this._renderData.cameraHeight,this._renderData.cameraHeightSq,
this._renderData.C,this._renderData.CSur),k.vec3.copy(this._renderData.cameraPosition,a.eye),v.mat4.invert(this._renderData.projectionInverse,a.projectionMatrix),v.mat4.invert(this._renderData.viewInverse,a.viewMatrix),x.vec2.set(this._renderData.nearFar,a.near,a.far),this._renderData.altitudeFade=z.computeInnerAltitudeFade(this._renderData.cameraHeight-this._lowerBoundEarthRadius))};b.isSupported=function(a){return a.rctx.capabilities.depthTexture};return b}();g.RealisticAtmosphere=d;g=.02*Math.PI;
d=.004*Math.PI;var A=h.vec3f64.fromValues(1/Math.pow(.65,4),1/Math.pow(.57,4),1/Math.pow(.475,4)),l=h.vec3f64.clone(A);k.vec3.scale(l,l,g);k.vec3.add(l,l,h.vec3f64.fromValues(d,d,d));var p=.25,q=.05,L=1/p,B=1/q,e=-.99999,C=(1-e*e)/(2+e*e)*1.5,D=H.newLayout().vec2f("position").vec2f("uv0")});