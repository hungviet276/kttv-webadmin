// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.17/esri/copyright.txt for details.
//>>built
define("require exports tslib ../../../../Color ../../../../symbols ../../../../core/asyncUtils ../../../../core/compilerUtils ../../../../core/Error ../../../../core/has ../../../../core/lang ../../../../core/maybe ../../../../core/promiseUtils ../../../../core/screenUtils ../../../../core/urlUtils ../../../../core/libs/gl-matrix-2/mat4f64 ../../../../core/libs/gl-matrix-2/vec2f64 ../../../../core/libs/gl-matrix-2/vec3f64 ../../../../core/libs/gl-matrix-2/vec4f64 ../../../../geometry/support/aaBoundingBox ../../../../support/arcadeOnDemand ../../../../symbols/support/IconSymbol3DLayerResource ../../../../symbols/support/utils ../../../2d/arcade/callExpressionWithFeature ./constants ./ElevationAligners ./elevationAlignmentUtils ./ElevationContext ./Graphics3DDrapedGraphicLayer ./Graphics3DObject3DGraphicLayer ./Graphics3DSymbolLayer ./graphicUtils ./pointUtils ./sdfPrimitives ../support/FastSymbolUpdates ../../support/pointUtils ../../terrain/OverlayRenderer ../../webgl-engine/lib/Geometry ../../webgl-engine/lib/GeometryUtil ../../webgl-engine/lib/RenderGeometry ../../webgl-engine/lib/Texture ../../webgl-engine/materials/HUDMaterial @dojo/framework/shim/Promise".split(" "),
function(K,r,q,L,M,N,O,A,P,Q,g,B,w,F,x,C,t,R,S,T,U,V,W,X,Y,u,Z,aa,ba,ca,y,D,v,z,da,ea,fa,G,ga,H,I){function E(q){return g.isSome(q)?"cross"===q||"x"===q:!1}Object.defineProperty(r,"__esModule",{value:!0});r.Graphics3DIconSymbolLayer=void 0;var ha=x.mat4f64.create(),J=t.vec3f64.fromValues(0,0,1),ia=[.25,.25,.75,.75],ja=[64,64];x=function(r){function d(a,b,c,e){a=r.call(this,a,b,c,e)||this;a._cimLayers=null;a._cimSymbolMaterials=new Map;a._cimSymbolTextures=new Map;a._cimMaterialParametersInfo=null;
a._cimRequiredFields=null;a._cimScaleFactorOrFunction=null;a._size=null;a._symbolTextureRatio=1;a._outlineSize=0;a._texture=null;a._releaseTexture=null;a._elevationOptions={supportsOffsetAdjustment:!0,supportsOnTheGround:!0};return a}q.__extends(d,r);d.prototype.getCachedSize=function(){return{size:this._getIconSize()}};d.prototype.doLoad=function(a){return q.__awaiter(this,void 0,void 0,function(){var b,c,e,d;return q.__generator(this,function(f){switch(f.label){case 0:this._validateOrThrow();b=
this._prepareMaterialParameters();c=this._getPrimitive();if(!g.isSome(c))return[3,1];this._prepareResourcesPrimitive(b,c);return[3,5];case 1:return e=V.getIconHref(this.symbol,this.symbolLayer),(d=F.dataComponents(e))&&"application/json"===d.mediaType?[4,this._prepareResourcesCIM(b,JSON.parse(d.data),a)]:[3,3];case 2:return f.sent(),[3,5];case 3:return[4,this._prepareResourcesHref(b,e,a)];case 4:f.sent(),f.label=5;case 5:return[2]}})})};d.prototype._validateOrThrow=function(){if(!this._drivenProperties.size){var a=
y.validateSymbolLayerSize(this._getIconSize());if(a)throw new A("graphics3diconsymbollayer:invalid-size",a);}};d.prototype._getIconSize=function(){var a=this.symbolLayer,a=Math.round(null!=a.size?w.pt2px(a.size):16);return this._drivenProperties.size?Math.max(a,64):a};d.prototype._generateTextureCIM=function(a){var b=this._getGraphicHash(a),c=""===b?null:this._cimSymbolTextures.get(b);c||(a=this._context.sharedResources.cimSymbolRasterizer.rasterizeCIMSymbol(this._cimLayers,a,"esriGeometryPoint",
{scaleFactor:this._cimScaleFactorOrFunction},null,null),this._cimMaterialParametersInfo.anchorPos=this._getAnchorPos("relative",a.anchorPosition),c=new H(a.imageData,"symbol",{width:a.imageData.width,height:a.imageData.height,powerOfTwoResizeMode:2}),this._cimSymbolTextures.set(b,c),this._context.stage.add(4,c));return c};d.prototype._computeSize=function(a,b){a=a.width/a.height;return 1<a?[b,Math.round(b/a)]:[Math.round(b*a),b]};d.prototype._prepareMaterialParameters=function(){var a={anchorPos:this._getAnchorPos(this.symbolLayer.anchor,
this.symbolLayer.anchorPosition)},b=this.symbol;if(b&&"point-3d"===b.type&&b.hasVisibleVerticalOffset()){var b=b.verticalOffset,c=b.minWorldLength,e=b.maxWorldLength;a.verticalOffset={screenLength:w.pt2px(b.screenLength),minWorldLength:c||0,maxWorldLength:null!=e?e:Infinity}}this._context.screenSizePerspectiveEnabled&&(a.screenSizePerspective=this._context.sharedResources.screenSizePerspectiveSettings);a.occlusionTest=!0;a.slicePlaneEnabled=this._context.slicePlaneEnabled;return a};d.prototype._prepareResourcesPrimitive=
function(a,b){var c=this,e=this._getOutlineSize();if(E(b)&&0===e)throw Error("Nothing to render");this._outlineSize=e;a.color=this._getFillColor();a.outlineColor=this._getOutlineColor();a.outlineSize=this._outlineSize;var d=this._context.sharedResources.textures.fromData(b,function(){var a;switch(b){case "circle":a=v.createCircle(128,64);break;case "square":a=v.createSquare(128,64);break;case "kite":a=v.createKite(128,64);break;case "cross":a=v.createCross(128,64);break;case "x":a=v.createX(128,64);
break;case "triangle":a=v.createTriangle(128,64);break;default:O.neverReached(b)}return new H(a,"sdf_"+b,{mipmap:!1,wrap:{s:33071,t:33071},width:128,height:128,components:4,noUnpackFlip:!0})});this._texture=d.texture;this._releaseTexture=function(){return c._context.sharedResources.textures.release(d.uid)};a.textureIsSignedDistanceField=!0;a.distanceFieldBoundingBox=ia;a.textureId=this._texture.id;e=this._getIconSize();this._size=[e,e];this._symbolTextureRatio=2;this._createMaterialAndAddToStage(a,
this._context.stage)};d.prototype._prepareResourcesHref=function(a,b,c){return q.__awaiter(this,void 0,void 0,function(){var e,d,f,l,k,m,n,p,g=this;return q.__generator(this,function(h){switch(h.label){case 0:if(!P("esri-canvas-svg-support")&&F.isSVG(b))throw e="IconSymbol3DLayer failed to load (SVG symbols are not supported in IE11)",new A("graphics3diconsymbollayer:unsupported-image-format",e);this._outlineSize=this._getOutlineSize();a.color=this._getFillColor();a.outlineColor=this._getOutlineColor();
a.outlineSize=this._outlineSize;a.textureIsSignedDistanceField=!1;d=this._getIconSize();f=d*this._context.layerView.view.pixelRatio;return[4,N.result(this._context.sharedResources.textures.fromUrl(b,f,{signal:c}))];case 1:l=h.sent();if(!1===l.ok)throw B.throwIfAbortError(l.error),e="Failed to load (Request for icon resource failed: "+b+")",new A("graphics3diconsymbollayer:request-failed",e);k=l.value;m=k.uid;n=k.texture;this._releaseTexture=function(){return g._context.sharedResources.textures.release(m)};
p=n.params;this._size=this._computeSize(p,d);a.textureId=n.id;this._createMaterialAndAddToStage(a,this._context.stage);return[2]}})})};d.prototype._prepareResourcesCIM=function(a,b,c){return q.__awaiter(this,void 0,void 0,function(){var e,d,f,l,k,m,n,p,g,r,t,u;return q.__generator(this,function(h){switch(h.label){case 0:return e=new M.CIMSymbol({data:b}),this._context.sharedResources.cimSymbolRasterizer?[3,2]:[4,new Promise(function(a,b){K(["../../../../symbols/cim/CIMSymbolRasterizer"],a,b)})];case 1:d=
h.sent().CIMSymbolRasterizer,B.throwIfAborted(c),this._context.sharedResources.cimSymbolRasterizer||(this._context.sharedResources.cimSymbolRasterizer=new d(this._context.renderCoordsHelper.spatialReference,!0)),h.label=2;case 2:return f=this._context.layer.fields?this._context.layer.fields.map(function(a){return a.toJSON()}):null,l=this,[4,this._context.sharedResources.cimSymbolRasterizer.analyzeCIMSymbol(e,f,this._context.renderer&&"dictionary"===this._context.renderer.type?this._context.renderer.fieldMap:
null,"esriGeometryPoint",{signal:c})];case 3:l._cimLayers=h.sent();if(!this._context.renderer||"dictionary"!==this._context.renderer.type||!this._context.renderer.scaleExpression)return[3,6];n=this._context.renderer;if(!isNaN(n.scaleExpression))return[3,5];p=n.scaleExpression;return[4,T.createRendererExpression(p,this._context.layer.spatialReference,f)];case 4:return g=h.sent(),m=function(a,b,c){a=W.default(g,a,{$view:c},"esriGeometryPoint",b);return null!==a?a:1},[3,6];case 5:k=Number(n.scaleExpression),
h.label=6;case 6:this._cimScaleFactorOrFunction=k||m||1;if(this._context.renderer)return[3,7];t=[];return[3,9];case 7:return[4,this._context.renderer.getRequiredFields(this._context.layer.fields)];case 8:t=h.sent(),h.label=9;case 9:return r=t,B.throwIfAborted(c),u=this._context.layer.fieldsIndex,this._cimRequiredFields=r.map(function(a){return u.get(a).name}),this._cimMaterialParametersInfo=a,this._cimMaterialParametersInfo.color=this._getFillColor(),this._cimMaterialParametersInfo.outlineColor=[0,
0,0,0],this._cimMaterialParametersInfo.outlineSize=0,this._cimMaterialParametersInfo.textureIsSignedDistanceField=!1,[2]}})})};d.prototype._getPrimitive=function(){return this.symbolLayer.resource&&this.symbolLayer.resource.href?null:this.symbolLayer.resource&&this.symbolLayer.resource.primitive||U.defaultPrimitive};d.prototype._getOutlineSize=function(){var a=0,a=this.symbolLayer;if(g.isSome(a.outline)&&null!=a.outline.size)return Math.max(w.pt2px(a.outline.size),0);a=this._getPrimitive();a=E(a)?
1.5:0;return Math.max(a,0)};d.prototype._getOutlineColor=function(){var a=this._getLayerOpacity(),b=g.get(this.symbolLayer,"outline","color");if(g.isSome(b)){var c=L.toUnitRGB(b);return[c[0],c[1],c[2],b.a*a]}return[0,0,0,0]};d.prototype._getFillColor=function(){if(E(this._getPrimitive()))return X.TRANSPARENT_UNIT;var a=g.isNone(this._getPrimitive()),b=g.get(this.symbolLayer,"material","color");return this._getCombinedOpacityAndColor(b,{hasIntrinsicColor:a})};d.prototype._getAnchorPos=function(a,b){return"relative"===
a?C.vec2f64.fromValues((b.x||0)+.5,-(b.y||0)+.5):a in y.namedAnchorToHUDMaterialAnchorPos?y.namedAnchorToHUDMaterialAnchorPos[a]:y.namedAnchorToHUDMaterialAnchorPos.center};d.prototype._createMaterialAndAddToStage=function(a,b){this._fastUpdates=this._cimLayers?{enabled:!1}:z.initFastSymbolUpdatesState(this._context.renderer,this._fastVisualVariableConvertOptions());this._fastUpdates.enabled&&Q.mixin(a,this._fastUpdates.materialParameters);if(this._cimLayers){var c=this._cimSymbolMaterials.get(a.textureId);
c||(c=new I.default(a,this._getIdHint("_icon")),this._cimSymbolMaterials.set(a.textureId,c),b.add(3,c));return c}this._material=new I.default(a,this._getIdHint("_icon"));b.add(3,this._material);return this._material};d.prototype._setDrapingDependentMaterialParameters=function(){this.draped&&(this._forEachMaterial(function(a){a.setParameterValues({verticalOffset:null,screenSizePerspective:null,occlusionTest:!1,slicePlaneEnabled:!1,shaderPolygonOffset:0})}),this.layerOpacityChanged())};d.prototype.destroy=
function(){var a=this;r.prototype.destroy.call(this);this._forEachMaterial(function(b){a._context.stage.remove(3,b.id)});g.isSome(this._material)&&(this._material=null);this._cimSymbolMaterials.clear();this._cimSymbolTextures.forEach(function(b){a._context.stage.remove(4,b.id)});this._cimSymbolTextures.clear();this._releaseTexture&&(this._releaseTexture(),this._releaseTexture=null)};d.prototype._getScaleFactor=function(a,b){if(this._drivenProperties.size&&a.size){for(var c=0;3>c;c++){var e=a.size[c];
e&&"symbol-value"!==e&&"proportional"!==e&&(a.size[c]=w.pt2px(e))}if("symbol-value"===a.size[0])return 1;if(isFinite(+a.size[0]))return+a.size[0]/b;if(isFinite(+a.size[2]))return+a.size[2]/b}return 1};d.prototype.createGraphics3DGraphic=function(a){var b=a.renderingInfo,c=a.graphic,e,d;if(this._cimLayers){if(!this._cimLayers.length)return null;var f=this._generateTextureCIM(c);d=q.__assign({textureId:f.id},this._cimMaterialParametersInfo);d=this._createMaterialAndAddToStage(d,this._context.stage);
e=[f.params.width,f.params.height]}else e=this._size,d=g.unwrap(this._material);if(!this._validateGeometry(c.geometry))return null;f=D.placePointOnGeometry(c.geometry);if(g.isNone(f))return this.logger.warn("unsupported geometry type for icon symbol: "+c.geometry.type),null;var l="graphic"+c.uid,k=this._getVertexOpacityAndColor(b),m=1;this._fastUpdates.enabled&&this._fastUpdates.visualVariables.size||(m=this._getScaleFactor(b,e[0]>e[1]?e[0]:e[1]));m*=this._symbolTextureRatio;b=[e[0]*m,e[1]*m];e=this.setGraphicElevationContext(c,
new Z.ElevationContext);this.ensureDrapedStatus("on-the-ground"===e.mode)&&this._setDrapingDependentMaterialParameters();return this.draped?this._createAsOverlay(c,f,d,k,b,a.layer.uid):this._createAs3DShape(c,f,d,k,b,e,l,c.uid)};d.prototype.layerOpacityChanged=function(){var a=this._getFillColor(),b=this._getOutlineColor();this._forEachMaterial(function(c){c.setParameterValues({color:a});c.setParameterValues({outlineColor:b})});return!0};d.prototype.layerElevationInfoChanged=function(a,b,c){var e=
this._elevationContext.mode;c=u.elevationModeChangeUpdateType(d.elevationModeChangeTypes,c,e);if(c!==u.SymbolUpdateType.UPDATE)return c;var h=u.needsElevationUpdates2D(e)||"absolute-height"===e;return this.updateGraphics3DGraphicElevationInfo(a,b,function(){return h})};d.prototype.slicePlaneEnabledChanged=function(){var a=this;this.draped||this._forEachMaterial(function(b){b.setParameterValues({slicePlaneEnabled:a._context.slicePlaneEnabled})});return!0};d.prototype.physicalBasedRenderingChanged=
function(){return!0};d.prototype.pixelRatioChanged=function(){return this._getPrimitive()?!0:!1};d.prototype.applyRendererDiff=function(a,b){for(var c in a.diff)switch(c){case "visualVariables":if(z.updateFastSymbolUpdatesState(this._fastUpdates,b,this._fastVisualVariableConvertOptions()))g.isSome(this._material)&&this._material.setParameterValues(this._fastUpdates.materialParameters);else return!1;break;default:return!1}return!0};d.prototype._defaultElevationInfoNoZ=function(){return ka};d.prototype._createAs3DShape=
function(a,b,c,e,d,f,l,k){var h=this,g=this.getFastUpdateAttrValues(a);a=g?function(a){return z.evaluateModelTransform(h._fastUpdates.materialParameters,g,a)}:null;e=G.createPointGeometry(J,null,e,d,la,null,g);e=[new fa(e,l)];l=D.createStageObjectForHUD(this._context,b,e,[c],null,null,f,l,this._context.layer.uid,k,a);if(null===l)return null;var p=new ba(this,l.object,e,null,null,Y.perObjectElevationAligner,f);p.alignedSampledElevation=l.sampledElevation;p.needsElevationUpdates=u.needsElevationUpdates2D(f.mode)||
"absolute-height"===f.mode;p.getScreenSize=this._createScreenSizeGetter(d,a);p.calculateRelativeScreenBounds=function(a){return c.calculateRelativeScreenBounds(p.getScreenSize(),1,a)};D.extendPointGraphicElevationContext(p,b,this._context.elevationProvider);return p};d.prototype._createAsOverlay=function(a,b,c,e,d,f){var h=this;c.renderPriority=this._renderPriority;var k=t.vec3f64.create();da.pointToVector(b,k,this._context.overlaySR);k[2]=ea.DRAPED_Z;b=this._context.clippingExtent;if(g.isSome(b)&&
!S.containsPoint(b,k))return null;var m=this.getFastUpdateAttrValues(a);b=m?function(a){return z.evaluateModelTransform(h._fastUpdates.materialParameters,m,a)}:null;e=G.createPointGeometry(J,k,e,d,null,null,m);e=new ga(e);e.material=c;e.center=k;e.bsRadius=0;e.data.layerUid=f;e.data.graphicUid=a.uid;e.calculateShaderTransformation=b;var n=new aa(this,[e],null);n.getScreenSize=this._createScreenSizeGetter(d,b);n.calculateRelativeScreenBounds=function(a){return c.calculateRelativeScreenBounds(n.getScreenSize(),
1,a)};return n};d.prototype._createScreenSizeGetter=function(a,b){var c=this._outlineSize+2;if(this._fastUpdates.enabled){var e=a[0]/this._symbolTextureRatio,d=a[1]/this._symbolTextureRatio;return function(a){void 0===a&&(a=C.vec2f64.create());var f=b(ha);a[0]=f[0]*e+c;a[1]=f[5]*d+c;return a}}var f=a[0]/this._symbolTextureRatio+c,g=a[1]/this._symbolTextureRatio+c;return function(a){void 0===a&&(a=C.vec2f64.create());a[0]=f;a[1]=g;return a}};d.prototype._fastVisualVariableConvertOptions=function(){var a=
this._size[0]>this._size[1]?this._size[0]:this._size[1],b=t.vec3f64.fromValues(a,a,a),c=w.px2pt(1),a=a*c,a=t.vec3f64.fromValues(a,a,a);return{modelSize:b,symbolSize:a,unitInMeters:c,transformation:{anchor:t.vec3f64.ZEROS,scale:t.vec3f64.ONES,rotation:t.vec3f64.ZEROS}}};d.prototype._getGraphicHash=function(a){for(var b="",c=0,d=this._cimRequiredFields;c<d.length;c++)var g=d[c],b=b+(g+a.attributes[g]);return b};d.prototype._forEachMaterial=function(a){g.isSome(this._material)&&a(this._material);this._cimSymbolMaterials.forEach(a)};
d.PRIMITIVE_SIZE=ja;d.elevationModeChangeTypes={definedChanged:u.SymbolUpdateType.UPDATE,staysOnTheGround:u.SymbolUpdateType.NONE,onTheGroundChanged:u.SymbolUpdateType.RECREATE};return d}(ca.default);r.Graphics3DIconSymbolLayer=x;var ka={mode:"relative-to-ground",offset:0},la=R.vec4f64.fromValues(0,0,0,1);r.default=x});