// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.17/esri/copyright.txt for details.
//>>built
define("require exports tslib ../../../../core/devEnvironmentUtils ../../../../core/maybe ../../../../core/libs/gl-matrix-2/mat3 ../../../../core/libs/gl-matrix-2/mat3f64 ../../../../core/libs/gl-matrix-2/mat4 ../../../../core/libs/gl-matrix-2/mat4f64 ../../../../core/libs/gl-matrix-2/vec3 ../../../../core/libs/gl-matrix-2/vec3f64 ../../../../geometry/support/aaBoundingBox ../../glTF/DefaultLoadingContext ../../glTF/loader ../../glTF/internal/indexUtils ./wosrLoader ../../support/buffer/BufferView ../../support/buffer/math ../../support/buffer/utils ../../webgl-engine/lib/Geometry ../../webgl-engine/lib/GeometryData ../../webgl-engine/lib/Texture ../../webgl-engine/materials/DefaultMaterial".split(" "),
function(ca,l,m,T,c,K,U,V,W,n,P,G,X,Y,F,Q,u,x,y,Z,aa,C,N){function R(c){var h=c.match(/(.*\.(gltf|glb))(\?lod=([0-9]+))?$/);return h?{fileType:"gltf",url:h[1],specifiedLodIndex:null!=h[4]?Number(h[4]):null}:c.match(/(.*\.(json|json\.gz))$/)?{fileType:"wosr",url:c,specifiedLodIndex:null}:{fileType:"unknown",url:c,specifiedLodIndex:null}}function H(n,h,z,l){var A=n.model,k=U.mat3f64.create(),I=[],E=new Map,g=new Map;A.lods.forEach(function(n,L){if(void 0===l||L===l){var H=0,r={name:n.name,stageResources:{textures:[],
materials:[],geometries:[]},lodThreshold:c.isSome(n.lodThreshold)?n.lodThreshold:null,pivotOffset:[0,0,0],numberOfVertices:0,boundingBox:G.empty()};I.push(r);n.parts.forEach(function(b){var p=b.material+(b.attributes.normal?"_normal":"")+(b.attributes.color?"_color":"")+(b.attributes.texCoord0?"_texCoord0":"")+(b.attributes.tangent?"_tangent":""),a=A.materials.get(b.material),v=c.isSome(b.attributes.texCoord0),q=c.isSome(b.attributes.normal);if(!E.has(p)){if(v){if(c.isSome(a.textureColor)&&!g.has(a.textureColor)){var d=
A.textures.get(a.textureColor),f=m.__assign(m.__assign({},d.parameters),{preMultiplyAlpha:!0});g.set(a.textureColor,new C(d.data,a.textureColor,f))}c.isSome(a.textureNormal)&&!g.has(a.textureNormal)&&(d=A.textures.get(a.textureNormal),f=m.__assign(m.__assign({},d.parameters),{preMultiplyAlpha:!0}),g.set(a.textureNormal,new C(d.data,a.textureNormal,f)));c.isSome(a.textureOcclusion)&&!g.has(a.textureOcclusion)&&(d=A.textures.get(a.textureOcclusion),f=m.__assign(m.__assign({},d.parameters),{preMultiplyAlpha:!0}),
g.set(a.textureOcclusion,new C(d.data,a.textureOcclusion,f)));c.isSome(a.textureEmissive)&&!g.has(a.textureEmissive)&&(d=A.textures.get(a.textureEmissive),f=m.__assign(m.__assign({},d.parameters),{preMultiplyAlpha:!0}),g.set(a.textureEmissive,new C(d.data,a.textureEmissive,f)));c.isSome(a.textureMetallicRoughness)&&!g.has(a.textureMetallicRoughness)&&(d=A.textures.get(a.textureMetallicRoughness),f=m.__assign(m.__assign({},d.parameters),{preMultiplyAlpha:!0}),g.set(a.textureMetallicRoughness,new C(d.data,
a.textureMetallicRoughness,f)))}var B=N.COLOR_GAMMA,d=Math.pow(a.color[0],1/B),f=Math.pow(a.color[1],1/B),w=Math.pow(a.color[2],1/B),e=Math.pow(a.emissiveFactor[0],1/B),l=Math.pow(a.emissiveFactor[1],1/B),B=Math.pow(a.emissiveFactor[2],1/B);E.set(p,new N(m.__assign(m.__assign(m.__assign({},h),{transparent:"BLEND"===a.alphaMode,textureAlphaMode:ba(a.alphaMode),textureAlphaCutoff:a.alphaCutoff,diffuse:[d,f,w],ambient:[d,f,w],opacity:a.opacity,doubleSided:a.doubleSided,doubleSidedType:"winding-order",
cullFace:a.doubleSided?0:2,vertexColors:!!b.attributes.color,vertexTangents:!!b.attributes.tangent,normals:q?"default":"screenDerivative",castShadows:!0,receiveSSAO:!0,textureId:c.isSome(a.textureColor)&&v?g.get(a.textureColor).id:void 0,colorMixMode:a.colorMixMode,normalTextureId:c.isSome(a.textureNormal)&&v?g.get(a.textureNormal).id:void 0,textureAlphaPremultiplied:!0,occlusionTextureId:c.isSome(a.textureOcclusion)&&v?g.get(a.textureOcclusion).id:void 0,emissiveTextureId:c.isSome(a.textureEmissive)&&
v?g.get(a.textureEmissive).id:void 0,metallicRoughnessTextureId:c.isSome(a.textureMetallicRoughness)&&v?g.get(a.textureMetallicRoughness).id:void 0,emissiveFactor:[e,l,B],mrrFactors:[a.metallicFactor,a.roughnessFactor,h.mrrFactors[2]],isSchematic:!1}),z),p))}a:{q=b.indices||b.attributes.position.count;switch(b.primitiveType){case 4:d=F.trianglesToTriangles(q);break a;case 5:d=F.triangleStripToTriangles(q);break a;case 6:d=F.triangleFanToTriangles(q);break a}d=void 0}f={};w={};q=b.attributes.position.count;
e=y.createBuffer(u.BufferViewVec3f,q);x.vec3.transformMat4(e,b.attributes.position,b.transform);w.position={data:e.typedBuffer,size:e.elementCount};f.position=d;c.isSome(b.attributes.normal)&&(e=y.createBuffer(u.BufferViewVec3f,q),K.mat3.normalFromMat4(k,b.transform),x.vec3.transformMat3(e,b.attributes.normal,k),w.normal={data:e.typedBuffer,size:e.elementCount},f.normal=d);c.isSome(b.attributes.tangent)&&(e=y.createBuffer(u.BufferViewVec4f,q),K.mat3.normalFromMat4(k,b.transform),x.vec4.transformMat3(e,
b.attributes.tangent,k),w.tangent={data:e.typedBuffer,size:e.elementCount},f.tangent=d);c.isSome(b.attributes.texCoord0)&&(e=y.createBuffer(u.BufferViewVec2f,q),y.vec2.normalizeIntegerBuffer(e,b.attributes.texCoord0),w.uv0={data:e.typedBuffer,size:e.elementCount},f.uv0=d);c.isSome(b.attributes.color)&&(e=y.createBuffer(u.BufferViewVec4u8,q),4===b.attributes.color.elementCount?b.attributes.color instanceof u.BufferViewVec4f?x.vec4.scale(e,b.attributes.color,255):b.attributes.color instanceof u.BufferViewVec4u8?
y.vec4.copy(e,b.attributes.color):b.attributes.color instanceof u.BufferViewVec4u16&&x.vec4.scale(e,b.attributes.color,1/256):(y.vec4.fill(e,255,255,255,255),l=new u.BufferViewVec3u8(e.buffer,0,4),b.attributes.color instanceof u.BufferViewVec3f?x.vec3.scale(l,b.attributes.color,255):b.attributes.color instanceof u.BufferViewVec3u8?y.vec3.copy(l,b.attributes.color):b.attributes.color instanceof u.BufferViewVec3u16&&x.vec3.scale(l,b.attributes.color,1/256)),w.color={data:e.typedBuffer,size:e.elementCount},
f.color=d);b=new Z(new aa.GeometryData(w,f),"gltf_"+n.name+"_"+H++);r.stageResources.geometries.push(b);r.stageResources.materials.push(E.get(p));v&&(c.isSome(a.textureColor)&&r.stageResources.textures.push(g.get(a.textureColor)),c.isSome(a.textureNormal)&&r.stageResources.textures.push(g.get(a.textureNormal)),c.isSome(a.textureOcclusion)&&r.stageResources.textures.push(g.get(a.textureOcclusion)),c.isSome(a.textureEmissive)&&r.stageResources.textures.push(g.get(a.textureEmissive)),c.isSome(a.textureMetallicRoughness)&&
r.stageResources.textures.push(g.get(a.textureMetallicRoughness)));r.numberOfVertices+=q;p=b.boundingInfo;G.expand(r.boundingBox,p.getBBMin());G.expand(r.boundingBox,p.getBBMax())})}});return I}function ba(c){switch(c){case "BLEND":return 0;case "MASK":return 2;case "OPAQUE":return 1;default:return 0}}Object.defineProperty(l,"__esModule",{value:!0});l.gltfToEngineResources=l.parseUrl=l.fetch=void 0;l.fetch=function(l,h){return m.__awaiter(this,void 0,void 0,function(){var z,x,A,k,I,E,g,C,L,G,r,b;
return m.__generator(this,function(p){switch(p.label){case 0:return z=R(T.adjustStaticAGOUrl(l)),"wosr"!==z.fileType?[3,2]:[4,h.cache?h.cache.loadWOSR(z.url,h):Q.load(z.url,h)];case 1:return x=p.sent(),A=Q.processLoadResult(x,h),[2,{lods:[A],referenceBoundingBox:A.boundingBox,isEsriSymbolResource:!1,isWosr:!0,remove:x.remove}];case 2:return[4,h.cache?h.cache.loadGLTF(z.url,h):Y.load(new X.DefaultLoadingContext(h.streamDataRequester),z.url,h)];case 3:k=p.sent();I=c.get(k.model.meta,"ESRI_proxyEllipsoid");
if(k.meta.isEsriSymbolResource&&c.isSome(I)&&-1!==k.meta.uri.indexOf("/RealisticTrees/"))a:{p=k;for(var a=I,v=0;v<p.model.lods.length;++v){var q=p.model.lods[v];p.customMeta.esriTreeRendering=!0;for(var d=0,q=q.parts;d<q.length;d++){var f=q[d],B=f.attributes.normal;if(c.isNone(B))break a;for(var w=f.attributes.position,e=w.count,F=P.vec3f64.create(),O=P.vec3f64.create(),t=P.vec3f64.create(),M=y.createBuffer(u.BufferViewVec4u8,e),K=y.createBuffer(u.BufferViewVec3f,e),N=V.mat4.invert(W.mat4f64.create(),
f.transform),D=0;D<e;D++){w.getVec(D,O);B.getVec(D,F);n.vec3.transformMat4(O,O,f.transform);n.vec3.subtract(t,O,a.center);n.vec3.divide(t,t,a.radius);var S=t[2],J=n.vec3.length(t),J=Math.min(.45+.55*J*J,1);n.vec3.divide(t,t,a.radius);n.vec3.transformMat4(t,t,N);n.vec3.normalize(t,t);v+1!==p.model.lods.length&&1<p.model.lods.length&&(-1<S?n.vec3.lerp(t,t,F,.2):n.vec3.lerp(t,t,F,Math.min(-4*S-3.8,1)));K.setVec(D,t);M.set(D,0,255*J);M.set(D,1,255*J);M.set(D,2,255*J);M.set(D,3,255)}f.attributes.normal=
K;f.attributes.color=M}}}E=k.meta.isEsriSymbolResource?{usePBR:h.usePBR,isSchematic:!1,treeRendering:k.customMeta.esriTreeRendering,mrrFactors:[0,1,.2]}:{usePBR:!0,isSchematic:!1,mrrFactors:[0,1,.5]};g=m.__assign(m.__assign({},h.materialParamsMixin),{treeRendering:k.customMeta.esriTreeRendering});if(null!=z.specifiedLodIndex)return C=H(k,E,g,z.specifiedLodIndex),L=C[0].boundingBox,0!==z.specifiedLodIndex&&(G=H(k,E,g,0),L=G[0].boundingBox),[2,{lods:C,referenceBoundingBox:L,isEsriSymbolResource:k.meta.isEsriSymbolResource,
isWosr:!1,remove:k.remove}];r=H(k,E,g);b=r[0].boundingBox;return[2,{lods:r,referenceBoundingBox:b,isEsriSymbolResource:k.meta.isEsriSymbolResource,isWosr:!1,remove:k.remove}]}})})};l.parseUrl=R;l.gltfToEngineResources=H});