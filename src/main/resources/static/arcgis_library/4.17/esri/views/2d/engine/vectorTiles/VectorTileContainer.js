// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.17/esri/copyright.txt for details.
//>>built
define("require exports tslib ../../../../core/maybe ../../../../core/promiseUtils ../../../../geometry/support/aaBoundingRect ./decluttering/debugging ./decluttering/SymbolFader ../webgl/enums ../webgl/TileContainer ../webgl/TiledDisplayObject ../../tiling/TileCoverage ../../tiling/TileKey".split(" "),function(x,u,p,r,D,B,y,E,v,F,G,H,I){function C(g,c){if(g){var a=g.getLayoutProperty("visibility");if(!a||"none"!==a.getValue()&&(void 0===g.minzoom||g.minzoom<c+1E-6)&&(void 0===g.maxzoom||g.maxzoom>=
c-1E-6))return!0}return!1}Object.defineProperty(u,"__esModule",{value:!0});u.VectorTileContainer=void 0;x=function(g){function c(a){a=g.call(this,a)||this;a._backgroundTiles=[];a._pointToCallbacks=new Map;a._fading=!1;return a}p.__extends(c,g);c.prototype.destroy=function(){this.removeAllChildren();this.children.forEach(function(a){return a.destroy()});this._spriteMosaic&&this._spriteMosaic.dispose();this._glyphMosaic&&this._glyphMosaic.dispose()};c.prototype.setStyleResources=function(a,e,f){var h=
this;this._spriteMosaic=a;this._glyphMosaic=e;this._styleRepository=f;r.isNone(this._symbolFader)&&(a=new E.SymbolFader(this._styleRepository.layers),a.on("fade-start",function(){h.emit("fade-start");h._fading=!0;h.requestRender()}),a.on("fade-complete",function(){h.emit("fade-complete");h._fading=!1;h.requestRender()}),this._symbolFader=a);r.unwrap(this._symbolFader).layers=f.layers};c.prototype.hitTest=function(a,e){return p.__awaiter(this,void 0,void 0,function(){var f,h;return p.__generator(this,
function(d){f=[a,e];h=D.createResolver();this._pointToCallbacks.set(f,h);this.requestRender();return[2,h.promise]})})};c.prototype.enterTileInvalidation=function(){for(var a=0,e=this.children;a<e.length;a++)e[a].invalidating=!0};c.prototype.createRenderParams=function(a){return p.__assign(p.__assign({},g.prototype.createRenderParams.call(this,a)),{renderPass:null,styleLayer:null,styleLayerId:-1,glyphMosaic:this._glyphMosaic,spriteMosaic:this._spriteMosaic,hasClipping:!!this._clippingInfos})};c.prototype.doRender=
function(a){!this.visible||a.drawPhase!==v.WGLDrawPhase.MAP&&a.drawPhase!==v.WGLDrawPhase.DEBUG||void 0===this._spriteMosaic||g.prototype.doRender.call(this,a)};c.prototype.addChild=function(a){g.prototype.addChild.call(this,a);r.isSome(this._symbolFader)?this._symbolFader.addTile(a):a.decluttered=!0;this.requestRender();return a};c.prototype.removeChild=function(a){r.isSome(this._symbolFader)&&this._symbolFader.removeTile(a);this.requestRender();return g.prototype.removeChild.call(this,a)};c.prototype.renderChildren=
function(a){if(a.drawPhase===v.WGLDrawPhase.DEBUG)g.prototype.renderChildren.call(this,a);else if(this._doRender(a),0<this._pointToCallbacks.size){var e=a.context,f=e.getBoundFramebufferObject();a.drawPhase=v.WGLDrawPhase.HITTEST;var h=a.painter.effects.hittest;h.bind(a);this._doRender(a);h.draw(a,this._pointToCallbacks,6);e.bindFramebuffer(f)}};c.prototype.removeAllChildren=function(){for(var a=0;a<this.children.length;a++){var e=this.children[a];r.isSome(this._symbolFader)&&this._symbolFader.removeTile(e);
e.dispose()}g.prototype.removeAllChildren.call(this)};c.prototype.getStencilTarget=function(){return this.children.filter(function(a){return a.neededForCoverage})};c.prototype.restartDeclutter=function(){r.isSome(this._symbolFader)&&this._symbolFader.restartDeclutter()};c.prototype._doRender=function(a){var e,f,h,d=a.context,b=this._styleRepository,c=b.layers,t=!0;a.drawPhase===v.WGLDrawPhase.HITTEST&&(t=!1);0<b.backgroundBucketIds.length&&(a.renderPass="background",this._renderBackgroundLayers(a,
b.backgroundBucketIds));g.prototype.renderChildren.call(this,a);var k=this.children.filter(function(a){return a.visible});if(k&&0!==k.length){for(var n=0;n<k.length;n++)b=k[n],b.triangleCount=0;d.setStencilWriteMask(0);d.setColorMask(!0,!0,!0,!0);d.setStencilOp(7680,7680,7681);d.setStencilTestEnabled(!0);d.setBlendingEnabled(!1);d.setDepthTestEnabled(!0);d.setDepthWriteEnabled(!0);d.setDepthFunction(515);d.setClearDepth(1);d.clear(d.gl.DEPTH_BUFFER_BIT);a.renderPass="opaque";for(b=c.length-1;0<=b;b--)this._renderStyleLayer(b,
a,k);d.setDepthWriteEnabled(!1);d.setBlendingEnabled(t);d.setBlendFunctionSeparate(1,771,1,771);a.renderPass="translucent";for(b=0;b<c.length;b++)this._renderStyleLayer(b,a,k);d.setDepthTestEnabled(!1);a.renderPass="symbol";for(b=0;b<c.length;b++)this._renderStyleLayer(b,a,k);d.bindVAO();d.setStencilTestEnabled(!0);d.setBlendingEnabled(!0);if(a.drawPhase===v.WGLDrawPhase.MAP){this._fade(a.displayLevel,a.state);var m=window.COLLISION_DEBUG_CTX;if(m&&r.isSome(this._symbolFader)&&(m.clearRect(0,0,m.canvas.width,
m.canvas.height),!this._fading||window.COLLISION_XRAY)){a=function(a){if(a.symbols){var b=[];a.symbols.forEach(function(a){b.push.apply(b,a)});window.COLLISION_SHOW_GRID&&(a=null===(h=null===(f=null===(e=p._symbolFader)||void 0===e?void 0:e._symbolDeclutterer)||void 0===f?void 0:f._collisionJob)||void 0===h?void 0:h._gridIndex)&&y.drawGridIndex(m,a);y.drawColliders(m,b)}};for(var p=this,d=0,c=this.children;d<c.length;d++)b=c[d],a(b)}}}};c.prototype._fade=function(a,e){r.isSome(this._symbolFader)&&
(this._symbolFader.update(a,e)||this.requestRender())};c.prototype._renderStyleLayer=function(a,e,c){var h=e.painter,d=e.renderPass,b=this._styleRepository.layers[a];if(void 0!==b){var f;switch(b.type){case 0:return;case 1:if("opaque"!==d&&"translucent"!==e.renderPass)return;f="vtlFill";break;case 2:if("translucent"!==d)return;f="vtlLine";break;case 4:if("symbol"!==d)return;f="vtlCircle";break;case 3:if("symbol"!==d)return;f="vtlSymbol"}c=3===b.type?c.filter(function(a){return a.decluttered}):c.filter(function(a){return a.neededForCoverage});
if("vtlSymbol"!==f&&(d=e.displayLevel,0===c.length||void 0!==b.minzoom&&b.minzoom>=d+1E-6||void 0!==b.maxzoom&&b.maxzoom<d-1E-6))return;e.styleLayerId=a;e.styleLayer=b;b=0;for(d=c;b<d.length;b++)if(d[b].layerData[a]){h.renderObjects(e,c,f);break}}};c.prototype._renderBackgroundLayers=function(a,c){for(var f=a.context,e=a.displayLevel,d=a.painter,b=a.state,g=this._styleRepository,t=!1,k=0;k<c.length;k++){var n=c[k];if(C(g.layers[n],e)){t=!0;break}}if(t){var t=this._tileInfoView.getTileCoverage(a.state,
0,"smallest"),n=t.spans,m=t.lodInfo,p=m.level,z=B.create(),k=[];if(this._renderPasses){var w=this._renderPasses[0];r.isSome(this._clippingInfos)&&(w.brushes[0].prepareState(a,this._clippingInfos[0]),w.brushes[0].drawMany(a,this._clippingInfos))}for(var w=this._backgroundTiles,u=0,l,A=0;A<n.length;A++)for(var q=n[A],x=q.row,y=q.colTo,q=q.colFrom;q<=y;q++)u<w.length?(l=w[u],l.key.set(p,x,m.normalizeCol(q),m.getWorldForColumn(q)),this._tileInfoView.getTileBounds(z,l.key,!1),l.bounds=z,l.coords[0]=z[0],
l.coords[1]=z[3]):(l=new I(p,x,m.normalizeCol(q),m.getWorldForColumn(q)),l=new G.TiledDisplayObject(l,this._tileInfoView.getTileBounds(B.create(),l),[512,512],[4096,4096]),w.push(l)),l.setTransform(b,this._tileInfoView.getTileResolution(l.key)),k.push(l),u++;f.setStencilWriteMask(0);f.setColorMask(!0,!0,!0,!0);f.setStencilOp(7680,7680,7681);f.setStencilFunction(514,0,255);b=!0;a.drawPhase===v.WGLDrawPhase.HITTEST&&(b=!1);f.setStencilTestEnabled(b);for(f=0;f<c.length;f++)n=c[f],b=g.layers[n],C(b,e)&&
(a.styleLayerId=n,a.styleLayer=b,d.renderObjects(a,k,"vtlBackground"));H.pool.release(t)}};return c}(F.default);u.VectorTileContainer=x});