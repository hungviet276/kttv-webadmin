// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.17/esri/copyright.txt for details.
//>>built
define("require exports tslib ../../../../../core/maybe ../../../../../core/libs/gl-matrix-2/vec2f32 ../../../../../core/libs/gl-matrix-2/vec4f32 ../../vectorTiles/decluttering/config ../definitions ../enums ../GeometryUtils ../number ./WGLBrush".split(" "),function(B,t,L,F,G,z,H,C,D,I,M,N){Object.defineProperty(t,"__esModule",{value:!0});t.WGLBrushVTLSymbol=void 0;var O=1/65536,J=[1,1,1,1];B=function(t){function f(){var a=null!==t&&t.apply(this,arguments)||this;a._iconProgramOptions={id:!1,dd:!1,
sdf:!1};a._sdfProgramOptions={id:!1,dd:!1};a._spritesTextureSize=G.vec2f32.create();a._haloColor=z.vec4f32.create();a._sdfColor=z.vec4f32.create();a._color=z.vec4f32.create();return a}L.__extends(f,t);f.prototype.dispose=function(){};f.prototype.drawMany=function(a,b){var q=a.styleLayerId,g=a.styleLayer,h;a.drawPhase===D.WGLDrawPhase.HITTEST&&(h=M.u32to4Xu8(q+1));this._drawIcons(a,g,b,h);this._drawText(a,g,b,h)};f.prototype._drawIcons=function(a,b,q,g){for(var h=this,k=a.context,c=a.displayLevel,
A=a.drawPhase,n=a.painter,d=a.state,f=a.styleLayerId,p,x=!1,r=0;r<q.length;r++){var u=q[r];if(u.layerData[f]&&(p=u.layerData[f],0<p.iconPerPageElementsMap.size)){x=!0;break}}if(x){var u=b.hasDataDrivenIconSize?1:b.getLayoutValue("icon-size",c),l=b.hasDataDrivenIconColor?J:b.getPaintValue("icon-color",c),v=b.hasDataDrivenIconOpacity?1:b.getPaintValue("icon-opacity",c),x=b.getPaintValue("icon-translate",c),r=b.getPaintValue("icon-translate-anchor",c),y=n.getVectorTileProgramCach(),n=l[3]*v;this._color[0]=
n*l[0];this._color[1]=n*l[1];this._color[2]=n*l[2];this._color[3]=n;n=b.getLayoutValue("icon-rotation-alignment",c);2===n&&(n=1===b.getLayoutValue("symbol-placement",c)?0:1);var l=p.isIconSDF,v=b.hasDataDrivenIcon,A=A===D.WGLDrawPhase.HITTEST,w=this._iconProgramOptions;w.id=A;w.dd=v;w.sdf=l;var e=y.getProgram(4,(A?1:0)<<2|(v?1:0)<<1|(l?1:0),w);k.bindProgram(e);l&&(l=b.getPaintValue("icon-halo-color",c),v=b.getPaintValue("icon-halo-width",c),e.setUniform4f("u_outlineColor",l[0],l[1],l[2],l[3]),e.setUniform1f("u_outlineSize",
v));e.setUniformMatrix3fv("u_displayViewMat3",0===n?d.displayViewMat3:d.displayMat3);e.setUniformMatrix3fv("u_displayMat3",1===r?d.displayMat3:d.displayViewMat3);e.setUniform2fv("u_iconTranslation",x);e.setUniform1f("u_depth",b.z);e.setUniform1f("u_mapRotation",I.degToByte(d.rotation));e.setUniform1f("u_keepUpright",0);e.setUniform1f("u_level",10*c);e.setUniform1i("u_texture",C.VTL_TEXTURE_BINDING_UNIT_SPRITES);e.setUniform1f("u_size",u);e.setUniform4fv("u_color",this._color);e.setUniform1f("u_opacity",
1);e.setUniform1f("u_fadeDuration",H.FADE_DURATION/1E3);A&&e.setUniform4fv("u_id",g);b=function(b){if(!b.layerData[f])return"continue";p=b.layerData[f];if(0===p.iconPerPageElementsMap.size)return"continue";p.prepareForRendering(k,y);p.updateOpacityInfo();var c=p.iconVertexArrayObject;if(F.isNone(c))return"continue";k.bindVAO(c);e.setUniformMatrix3fv("u_dvsMat3",b.transforms.dvs);e.setUniform1f("u_time",(performance.now()-p.lastOpacityUpdate)/1E3);p.iconPerPageElementsMap.forEach(function(c,d){h._renderIconRange(a,
e,c,d,b)})};for(g=0;g<q.length;g++)u=q[g],b(u)}};f.prototype._renderIconRange=function(a,b,q,g,h){var k=a.context;a=a.spriteMosaic;this._spritesTextureSize[0]=a.getWidth(g)/4;this._spritesTextureSize[1]=a.getHeight(g)/4;b.setUniform2fv("u_mosaicSize",this._spritesTextureSize);a.bind(k,9729,g,C.VTL_TEXTURE_BINDING_UNIT_SPRITES);k.setStencilTestEnabled(!0);k.setStencilFunction(516,255,255);k.setStencilWriteMask(0);k.drawElements(4,q[1],5125,Uint32Array.BYTES_PER_ELEMENT*q[0]);h.triangleCount+=q[1]/
3};f.prototype._drawText=function(a,b,q,g){for(var h=this,k=a.context,c=a.displayLevel,f=a.drawPhase,n=a.glyphMosaic,d=a.painter,t=a.pixelRatio,p=a.state,x=a.styleLayerId,r,u=!1,l=0;l<q.length;l++)if(a=q[l],a.layerData[x]&&(r=a.layerData[x],0<r.glyphPerPageElementsMap.size)){u=!0;break}if(u){a=b.getLayoutValue("text-rotation-alignment",c);2===a&&(a=1===b.getLayoutValue("symbol-placement",c)?0:1);var u=0===a,u=b.getLayoutValue("text-keep-upright",c)&&u,f=f===D.WGLDrawPhase.HITTEST,t=.8*3/t,l=b.hasDataDrivenTextSize?
1:b.getLayoutValue("text-size",c),v=b.hasDataDrivenTextColor?J:b.getPaintValue("text-color",c),y=b.hasDataDrivenTextOpacity?1:b.getPaintValue("text-opacity",c),w=b.getPaintValue("text-halo-color",c),e=b.getPaintValue("text-halo-width",c),z=3*b.getPaintValue("text-halo-blur",c),B=3*e,K=d.getVectorTileProgramCach(),d=v[3]*y;this._sdfColor[0]=d*v[0];this._sdfColor[1]=d*v[1];this._sdfColor[2]=d*v[2];this._sdfColor[3]=d;d=w[3]*y;this._haloColor[0]=d*w[0];this._haloColor[1]=d*w[1];this._haloColor[2]=d*
w[2];this._haloColor[3]=d;this._glyphTextureSize||(this._glyphTextureSize=G.vec2f32.fromValues(n.width/4,n.height/4));var d=b.getPaintValue("text-translate",c),v=b.getPaintValue("text-translate-anchor",c),y=b.hasDataDrivenText,E=this._sdfProgramOptions;E.id=f;E.dd=y;var m=K.getProgram(6,(f?1:0)<<1|(y?1:0),E);k.bindProgram(m);m.setUniformMatrix3fv("u_displayViewMat3",0===a?p.displayViewMat3:p.displayMat3);m.setUniformMatrix3fv("u_displayMat3",1===v?p.displayMat3:p.displayViewMat3);m.setUniform2fv("u_textTranslation",
d);m.setUniform1f("u_depth",b.z+O);m.setUniform2fv("u_mosaicSize",this._glyphTextureSize);m.setUniform1f("u_mapRotation",I.degToByte(p.rotation));m.setUniform1f("u_keepUpright",u?1:0);m.setUniform1f("u_level",10*c);m.setUniform1i("u_texture",C.VTL_TEXTURE_BINDING_UNIT_GLYPHS);m.setUniform1f("u_size",l);m.setUniform1f("u_antialiasingWidth",t);m.setUniform1f("u_opacity",1);m.setUniform1f("u_fadeDuration",H.FADE_DURATION/1E3);f&&m.setUniform4fv("u_id",g);b=function(b){if(!b.layerData[x])return"continue";
r=b.layerData[x];if(0===r.glyphPerPageElementsMap.size)return"continue";r.prepareForRendering(k,K);r.updateOpacityInfo();var a=r.textVertexArrayObject;if(F.isNone(a))return"continue";k.bindVAO(a);m.setUniformMatrix3fv("u_dvsMat3",b.transforms.dvs);k.setStencilTestEnabled(!0);k.setStencilFunction(516,255,255);k.setStencilWriteMask(0);a=(performance.now()-r.lastOpacityUpdate)/1E3;m.setUniform1f("u_time",a);r.glyphPerPageElementsMap.forEach(function(a,c){h._renderGlyphRange(k,a,c,n,m,w[3],e,z,B,b)})};
for(g=0;g<q.length;g++)a=q[g],b(a)}};f.prototype._renderGlyphRange=function(a,b,f,g,h,k,c,t,n,d){g.bind(a,9729,f,C.VTL_TEXTURE_BINDING_UNIT_GLYPHS);0<k&&0<c&&(h.setUniform4fv("u_color",this._haloColor),h.setUniform1f("u_halo",1),h.setUniform1f("u_edgeDistance",n),h.setUniform1f("u_edgeBlur",t),a.drawElements(4,b[1],5125,Uint32Array.BYTES_PER_ELEMENT*b[0]),d.triangleCount+=b[1]/3);0<this._sdfColor[3]&&(h.setUniform4fv("u_color",this._sdfColor),h.setUniform1f("u_halo",0),h.setUniform1f("u_edgeDistance",
0),h.setUniform1f("u_edgeBlur",0),a.drawElements(4,b[1],5125,Uint32Array.BYTES_PER_ELEMENT*b[0]),d.triangleCount+=b[1]/3)};return f}(N.default);t.WGLBrushVTLSymbol=B});