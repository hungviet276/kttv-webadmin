// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.17/esri/copyright.txt for details.
//>>built
define("require exports tslib ../../../../core/Accessor ../../../../core/promiseUtils ../../../../core/accessorSupport/decorators ../../../../geometry/Extent ../../../../geometry/support/aaBoundingRect ../../../../geometry/support/spatialReferenceUtils ../../../../layers/support/TileInfo ../../viewStateUtils ../../engine/Bitmap ../../tiling/TileInfoView ../../tiling/TileKey".split(" "),function(E,F,d,x,r,c,t,y,z,A,u,B,C,D){var g=y.create(),h=[0,0],v=new D(0,0,0,0);return function(w){function a(a){var b=
w.call(this,a)||this;b._imagePromise=null;b.hidpi=!1;b.imageMaxWidth=2048;b.imageMaxHeight=2048;b.imageRotationSupported=!1;b.imageNormalizationSupported=!1;b.update=r.debounce(function(a,e){return d.__awaiter(b,void 0,void 0,function(){var b,c,f,n,g,l,q,p,m,k=this;return d.__generator(this,function(d){b=a.state;c=z.getInfo(b.spatialReference);f=this.hidpi?a.pixelRatio:1;if(!a.stationary||this.destroyed)return[2];this.imageRotationSupported?(h[0]=b.size[0],h[1]=b.size[1]):u.getOuterSize(h,b);n=Math.floor(h[0]*
f)>this.imageMaxWidth||Math.floor(h[1]*f)>this.imageMaxHeight;g=c&&(b.extent.xmin<c.valid[0]||b.extent.xmax>c.valid[1]);l=!this.imageNormalizationSupported&&g;q=!n&&!l;p=this.imageRotationSupported?b.rotation:0;q?this._imagePromise=this._singleExport(b,h,p,f,e):(m=Math.min(this.imageMaxWidth,this.imageMaxHeight),l&&(m=Math.min(b.worldScreenWidth,m)),this._imagePromise=this._tiledExport(b,m,p,f,e));return[2,this._imagePromise.then(function(b){k._imagePromise=null;var a=k.container.children.slice();
k.container.removeAllChildren();b.forEach(k.container.addChild,k.container);k.disposeSource&&a.forEach(function(b){k.disposeSource(b.source)},k)}).catch(function(b){k._imagePromise=null;throw b;})]})})},5E3);return b}d.__extends(a,w);a.prototype.destroy=function(){};Object.defineProperty(a.prototype,"updating",{get:function(){return null!==this._imagePromise},enumerable:!1,configurable:!0});a.prototype.updateExports=function(a){for(var b=0,e=this.container.children;b<e.length;b++){var f=e[b];if(!f.visible||
!f.stage)break;a(f)?console.error("ExportStrategy.updateExports doesn't support promise yet"):(f.invalidateTexture(),f.requestRender())}};a.prototype._export=function(a,b,c,f,d,g){var e=this;return r.resolve().then(function(){return e.fetchSource(a,Math.floor(b*d),Math.floor(c*d),{rotation:f,pixelRatio:d,signal:g})}).then(function(c){c=new B.Bitmap(c);c.x=a.xmin;c.y=a.ymax;c.resolution=a.width/b;c.rotation=f;c.pixelRatio=d;return c})};a.prototype._singleExport=function(a,b,c,d,h){u.getBBox(g,a.center,
a.resolution,b);a=new t(g[0],g[1],g[2],g[3],a.spatialReference);return this._export(a,b[0],b[1],c,d,h).then(function(b){return[b]})};a.prototype._tiledExport=function(a,b,c,d,h){var f=this,e=A.create({size:b,spatialReference:a.spatialReference,scales:[a.scale]}),n=new C(e),e=n.getTileCoverage(a);if(!e)return null;var l=[];e.forEach(function(e,q,p,m){v.set(e,q,p,m);n.getTileBounds(g,v);e=new t(g[0],g[1],g[2],g[3],a.spatialReference);l.push(f._export(e,b,b,c,d,h))});return r.all(l)};d.__decorate([c.property()],
a.prototype,"_imagePromise",void 0);d.__decorate([c.property()],a.prototype,"container",void 0);d.__decorate([c.property()],a.prototype,"disposeSource",void 0);d.__decorate([c.property()],a.prototype,"fetchSource",void 0);d.__decorate([c.property()],a.prototype,"hidpi",void 0);d.__decorate([c.property()],a.prototype,"imageMaxWidth",void 0);d.__decorate([c.property()],a.prototype,"imageMaxHeight",void 0);d.__decorate([c.property()],a.prototype,"imageRotationSupported",void 0);d.__decorate([c.property()],
a.prototype,"imageNormalizationSupported",void 0);d.__decorate([c.property()],a.prototype,"requestUpdate",void 0);d.__decorate([c.property({dependsOn:["_imagePromise"]})],a.prototype,"updating",null);return a=d.__decorate([c.subclass("esri.views.2d.layers.support.ExportStrategy")],a)}(x)});