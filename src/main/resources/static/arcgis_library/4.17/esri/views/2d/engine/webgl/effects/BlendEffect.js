// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.17/esri/copyright.txt for details.
//>>built
define("require exports ../../../../../core/Error ../../../../../core/Logger ../../../../../core/maybe ../../../../webgl ../enums ../VertexStream ../shaders/BlendPrograms".split(" "),function(h,g,n,t,u,p,v,w,q){Object.defineProperty(g,"__esModule",{value:!0});g.BlendEffect=void 0;var r=t.getLogger("esri.views.2d.engine.webgl.effects.blendEffects.BlendEffect");h=function(){function b(){this._size=[0,0]}b.prototype.dispose=function(a){this._backBufferTexture&&(this._backBufferTexture.dispose(),this._backBufferTexture=
null);this._programCache&&(this._programCache.dispose(),this._programCache=null);this._quad&&(this._quad.dispose(),this._quad=null)};b.prototype.draw=function(a,c,k,b,l){var d=a.context,e=a.drawPhase;this._setupShader(d);b&&"normal"!==b&&e!==v.WGLDrawPhase.LABEL?this._drawBlended(a,c,k,b,l):(a=this._programCache.getProgram(q.blend,"normal"))?(d.bindProgram(a),c.setSamplingMode(k),d.bindTexture(c,0),a.setUniform1i("u_layerTexture",0),a.setUniform1f("u_opacity",l),d.setBlendingEnabled(!0),d.setBlendFunction(1,
771),c=this._quad,c.draw(),c.unbind()):r.error(new n("mapview-BlendEffect",'Error creating shader program for blend mode "normal"'))};b.prototype._drawBlended=function(a,c,b,g,l){var d=a.context,e=a.pixelRatio,k=a.inFadeTransition,h=a.state.size,f=d.getBoundFramebufferObject(),m;u.isSome(f)?(e=f.descriptor,m=e.width,e=e.height):(m=Math.round(e*h[0]),e=Math.round(e*h[1]));this._createOrResizeTexture(a,m,e);a=this._backBufferTexture;f.copyToTexture(0,0,m,e,0,0,a);d.setStencilTestEnabled(!1);d.setStencilWriteMask(0);
d.setBlendingEnabled(!0);d.setDepthTestEnabled(!1);d.setDepthWriteEnabled(!1);(f=this._programCache.getProgram(q.blend,g))?(d.bindProgram(f),a.setSamplingMode(b),d.bindTexture(a,0),f.setUniform1i("u_backbufferTexture",0),c.setSamplingMode(b),d.bindTexture(c,1),f.setUniform1i("u_layerTexture",1),f.setUniform1f("u_opacity",l),f.setUniform1f("u_inFadeOpacity",k?1:0),d.setBlendFunction(1,0),c=this._quad,c.draw(),c.unbind(),d.setBlendFunction(1,771)):r.error(new n("mapview-BlendEffect","Error creating shader program for blend mode "+
g))};b.prototype._setupShader=function(a){this._programCache||(this._programCache=new p.ProgramCache(a),this._quad||(this._quad=new w(a,[-1,-1,1,-1,-1,1,1,1])))};b.prototype._createOrResizeTexture=function(a,c,b){a=a.context;if(null===this._backBufferTexture||c!==this._size[0]||b!==this._size[1])this._backBufferTexture?this._backBufferTexture.resize(c,b):this._backBufferTexture=new p.Texture(a,{target:3553,pixelFormat:6408,internalFormat:6408,dataType:5121,wrapMode:33071,samplingMode:9729,flipped:!1,
width:c,height:b}),this._size[0]=c,this._size[1]=b};return b}();g.BlendEffect=h});