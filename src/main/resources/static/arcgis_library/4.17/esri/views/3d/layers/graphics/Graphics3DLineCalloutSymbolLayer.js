// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.17/esri/copyright.txt for details.
//>>built
define("require exports tslib ../../../../Color ../../../../core/maybe ../../../../core/screenUtils ./ElevationAligners ./elevationAlignmentUtils ./ElevationContext ./Graphics3DObject3DGraphicLayer ./Graphics3DSymbolLayer ./graphicUtils ./pointUtils ./symbolComplexity ../../webgl-engine/lib/Geometry ../../webgl-engine/lib/GeometryData ../../webgl-engine/lib/Util ../../webgl-engine/materials/LineCalloutMaterial".split(" "),function(r,m,t,u,k,v,x,h,y,z,A,B,w,C,D,E,F,n){var d,l;Object.defineProperty(m,
"__esModule",{value:!0});m.Graphics3DLineCalloutSymbolLayer=void 0;var f=F.VertexAttrConstants;r=function(d){function b(a,c){a=d.call(this,a,null,c,G)||this;a._elevationOptions={supportsOffsetAdjustment:!0,supportsOnTheGround:!1};a.ensureDrapedStatus(!1);return a}t.__extends(b,d);b.prototype.doLoad=function(){return t.__awaiter(this,void 0,void 0,function(){return t.__generator(this,function(a){this._material=new n(this.materialParameters,this._getIdHint("_lineCallout_common"));this._context.stage.add(3,
this._material);return[2]})})};b.prototype.destroy=function(){d.prototype.destroy.call(this);this._material&&(this._context.stage.remove(3,this._material.id),this._material=null)};b.prototype.perInstanceMaterialParameters=function(a){var c=this.materialParameters;c.screenOffset=a.screenOffset||[0,0];c.centerOffsetUnits=a.centerOffsetUnits||"world";return c};Object.defineProperty(b.prototype,"materialParameters",{get:function(){var a=this.symbol,c=a.callout,g=k.isSome(c.color)?u.toUnitRGBA(c.color):
[0,0,0,0];g[3]*=this._getLayerOpacity();var b=v.pt2px(c.size||0),e=null;if(a.verticalOffset)var e=a.verticalOffset,p=e.minWorldLength,d=e.maxWorldLength,e={screenLength:v.pt2px(e.screenLength),minWorldLength:p||0,maxWorldLength:null!=d?d:Infinity};c=k.isSome(c.border)&&k.isSome(c.border.color)?u.toUnitRGBA(c.border.color):null;p="object"===a.symbolLayers.getItemAt(0).type;return{color:g,size:b,verticalOffset:e,screenSizePerspective:this._context.screenSizePerspectiveEnabled?this._context.sharedResources.screenSizePerspectiveSettings:
null,screenOffset:[0,0],centerOffsetUnits:"world",borderColor:c,occlusionTest:!p,shaderPolygonOffset:p?0:void 0,depthHUDAlignStart:"label-3d"===a.type,slicePlaneEnabled:this._context.slicePlaneEnabled}},enumerable:!1,configurable:!0});b.prototype._defaultElevationInfoNoZ=function(){return H};b.prototype.createGraphics3DGraphic=function(a){var c=a.renderingInfo;a=a.graphic;var g=this.setGraphicElevationContext(a,new y.ElevationContext,c.elevationOffset||0),b=c.symbol,e="on-the-ground"===this._elevationContext.mode&&
("cim"===b.type||!b.symbolLayers.some(function(a){return"object"===a.type||"text"===a.type}));if("label-3d"!==b.type&&e)return null;b=B.computeCentroid(a.geometry);return k.isNone(b)?null:this._createAs3DShape(b,g,c,"graphic"+a.uid,a.uid)};b.prototype.layerOpacityChanged=function(){this._material.setParameterValues(this.materialParameters);return!0};b.prototype.layerElevationInfoChanged=function(a,c,g){var d=this;g=h.elevationModeChangeUpdateType(b.elevationModeChangeTypes,g,this._elevationContext.mode);
if(g!==h.SymbolUpdateType.UPDATE)return g;a.forEach(function(a){var b=c(a);k.isSome(b)&&d.updateGraphicElevationContext(a.graphic,b)});return g};b.prototype.slicePlaneEnabledChanged=function(){this._material.setParameterValues({slicePlaneEnabled:this._context.slicePlaneEnabled});return!0};b.prototype.physicalBasedRenderingChanged=function(){return!0};b.prototype.pixelRatioChanged=function(){return!0};b.prototype.setGraphicElevationContext=function(a,c,b){void 0===b&&(b=0);a=d.prototype.setGraphicElevationContext.call(this,
a,c);a.addOffsetRenderUnits(b);return a};b.prototype.updateGraphicElevationContext=function(a,c){this.setGraphicElevationContext(a,c.elevationContext,c.metadata.elevationOffset);c.needsElevationUpdates=h.needsElevationUpdates2D(c.elevationContext.mode)};b.prototype.updateGeometry=function(a,c){return!1};b.prototype.computeComplexity=function(){return{primitivesPerFeature:2,primitivesPerCoordinate:0,estimated:!1,memory:C.emptySymbolComplexity.memory}};b.prototype.createVertexData=function(a){var c,
b=a.translation;a=a.centerOffset;if(!b&&!a)return q;b=b?{size:3,data:[b[0],b[1],b[2]]}:q[f.POSITION];a=a?{size:4,data:[a[0],a[1],a[2],a[3]]}:q[f.AUXPOS1];return c={},c[f.POSITION]=b,c[f.NORMAL]=q[f.NORMAL],c[f.AUXPOS1]=a,c};b.prototype.getOrCreateMaterial=function(a,b){var c=this.perInstanceMaterialParameters(a),d=n.uniqueMaterialIdentifier(c);if(d===this._material.uniqueMaterialIdentifier)return{material:this._material,isUnique:!1};if(a.materialCollection){var e=a.materialCollection.getMaterial(d);
e||(e=new n(c,b+"_lineCallout_shared"),a.materialCollection.addMaterial(d,e));return{material:e,isUnique:!1}}e=new n(c,b+"_lineCallout_unique");return{material:e,isUnique:!0}};b.prototype._createAs3DShape=function(a,b,d,f,e){var c=new E.GeometryData(this.createVertexData(d),I,"point"),c=[new D(c,f)],g=this.getOrCreateMaterial(d,f);f=w.createStageObjectForHUD(this._context,a,c,[g.material],null,null,b,f,this._context.layer.uid,e);if(null===f)return null;e=new z(this,f.object,c,g.isUnique?[g.material]:
null,null,x.perObjectElevationAligner,b);e.metadata={elevationOffset:d.elevationOffset||0};e.alignedSampledElevation=f.sampledElevation;e.needsElevationUpdates=h.needsElevationUpdates2D(b.mode);w.extendPointGraphicElevationContext(e,a,this._context.elevationProvider);return e};b.elevationModeChangeTypes={definedChanged:h.SymbolUpdateType.UPDATE,staysOnTheGround:h.SymbolUpdateType.UPDATE,onTheGroundChanged:h.SymbolUpdateType.RECREATE};return b}(A.Graphics3DSymbolLayer);m.Graphics3DLineCalloutSymbolLayer=
r;var q=(d={},d[f.POSITION]={size:3,data:[0,0,0]},d[f.NORMAL]={size:3,data:[0,0,1]},d[f.AUXPOS1]={size:4,data:[0,0,0,1]},d);d=new Uint32Array([0]);var I=(l={},l[f.POSITION]=d,l[f.NORMAL]=d,l[f.AUXPOS1]=d,l),H={mode:"relative-to-ground",offset:0},G={ignoreDrivers:!0,renderPriority:0,renderPriorityStep:1};m.default=r});