// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.17/esri/copyright.txt for details.
//>>built
define("require exports tslib ../../../../request ../../../../core/has ../../../../core/ItemCache ../../../../core/maybe ../../../../core/MemCache ../../../../core/promiseUtils ../../../../core/workers ../../../../geometry/support/aaBoundingRect ../vectorTiles/VectorTile ./GlyphMosaic ./GlyphSource ./SpriteMosaic ./TileIndex ./decluttering/debugging ../../tiling/TileKey".split(" "),function(q,n,g,r,v,w,k,x,h,y,z,A,B,C,D,t,E,p){Object.defineProperty(n,"__esModule",{value:!0});n.TileHandler=void 0;
var u=new w(10),m=new Map;q=function(){function b(a,c,e){this._vectorTileLayer=a;this.devicePixelRatio=c;this._memCache=e;this._connection=this._glyphMosaic=this._spriteMosaic=null;this._ongoingTileRequests=new Map;this._ongoingRequestToController=new Map}b.prototype.destroy=function(){this._ongoingTileRequests&&this.abortAll();this._connection&&(this._connection.close(),this._connection=null);this._vectorTileLayer=null;this._spriteMosaic&&(this._spriteMosaic.dispose(),this._spriteMosaic=null);this._glyphMosaic&&
(this._glyphMosaic.dispose(),this._glyphMosaic=null)};Object.defineProperty(b.prototype,"spriteMosaic",{get:function(){var a=this;return this._spriteSourcePromise.then(function(){return a._spriteMosaic})},enumerable:!1,configurable:!0});Object.defineProperty(b.prototype,"glyphMosaic",{get:function(){return this._glyphMosaic},enumerable:!1,configurable:!0});b.prototype.start=function(a){return g.__awaiter(this,void 0,void 0,function(){var c,e,f,d,b,l=this;return g.__generator(this,function(G){c=this._vectorTileLayer.sourceNameToSource;
e=[];for(f in c)e.push(this._fetchTileMap(c[f],a));this._spriteSourcePromise=this._vectorTileLayer.loadSpriteSource(this.devicePixelRatio,a);this._spriteSourcePromise.then(function(a){l._spriteMosaic=new D(1024,1024,250);l._spriteMosaic.setSpriteSource(a)});d=this._vectorTileLayer.styleRepository;b=new C(d.glyphs);this._glyphMosaic=new B(1024,1024,b);this._broadcastPromise=y.open("WorkerTileHandler",{client:this,scheduler:a.scheduler,signal:a.signal}).then(function(c){l._connection=c;return h.all(l._connection.broadcast("setLayers",
{style:d.styleJSON},a))});return[2,h.all(e)]})})};b.prototype.updateStyle=function(){return g.__awaiter(this,void 0,void 0,function(){var a,c=this;return g.__generator(this,function(e){switch(e.label){case 0:return[4,this._broadcastPromise];case 1:return e.sent(),a=this._vectorTileLayer.styleRepository,this._broadcastPromise=h.create(function(e,d){h.all(c._connection.broadcast("updateStyle",a.styleJSON)).then(e,d)}),[2,this._broadcastPromise]}})})};b.prototype.getVectorTile=function(a,c,e,f){var d=
this,b=new p(a,c,e,0);return k.isSome(this._memCache)&&(a=this._memCache.get(b.id),k.isSome(a))?(a.reference(),h.resolve(a)):this._getVectorTileData(b).then(function(a){h.throwIfAborted(f);if(k.isSome(d._memCache)){var c=d._memCache.get(b.id);if(k.isSome(c))return c.reference(),c}if(!d._vectorTileLayer)return null;c=d._vectorTileLayer.tileInfo.getTileBounds(z.create(),b);c=new A.VectorTile(b,d._vectorTileLayer.styleRepository,c,[512,512]);a&&a.tileData?(c.setData(a.tileData),k.isSome(d._memCache)&&
(c.reference(),a=c.getMemoryUsage(),0<a&&d._memCache.put(c.key.id,c,a*c.referenced,x.MIN_PRIORITY))):c.setData(null);return c})};b.prototype.releaseVectorTile=function(a){k.isNone(this._memCache)||a.release()||this._memCache.updateSize(a.key.id,a,a.getMemoryUsage()*a.referenced)};b.prototype.fetchTileData=function(a,c){var e=this;return this._getRefKeys(a,c).then(function(a){var d=e._vectorTileLayer.sourceNameToSource,b=[],f;for(f in d)b.push(f);return e._getSourcesData(b,a,c)})};b.prototype.parseTileData=
function(a,c){var e=this,b=a&&a.data;if(!b)return h.resolve(null);var d=b.sourceName2DataAndRefKey,F=b.transferList;return 0===Object.keys(d).length?h.resolve(null):this._broadcastPromise.then(function(){return e._connection.getAvailableClient().then(function(b){return b.invoke("createTileAndParse",{key:a.key.id,sourceName2DataAndRefKey:d},g.__assign(g.__assign({},c),{transferList:F})).then(function(a){if(v("esri-vector-tiles-debug")){var c={},b;for(b in d)c[b]=d[b].refKey;return{tileData:a,refKeys:c}}return{tileData:a}})})})};
Object.defineProperty(b.prototype,"updating",{get:function(){return 0<this._ongoingTileRequests.size},enumerable:!1,configurable:!0});b.prototype.abortAll=function(){this._ongoingRequestToController.forEach(function(a){return a.abort()});this._ongoingRequestToController.clear();this._ongoingTileRequests.clear()};b.prototype.getSprites=function(a){return g.__awaiter(this,void 0,void 0,function(){return g.__generator(this,function(c){switch(c.label){case 0:return[4,this._spriteSourcePromise];case 1:return c.sent(),
[2,this._spriteMosaic.getSpriteItems(a)]}})})};b.prototype.getGlyphs=function(a){return this._glyphMosaic.getGlyphItems(a.font,a.codePoints)};b.prototype.perfReport=function(a){E.perfAdd(a.key,a.milliseconds,"ms")};b.prototype.getStyleRepository=function(){return this._vectorTileLayer.styleRepository};b.prototype._getTilePayload=function(a,c,b){return g.__awaiter(this,void 0,void 0,function(){var e,d,h,l,k;return g.__generator(this,function(f){switch(f.label){case 0:return e=p.pool.acquire(a.id),
d=this._vectorTileLayer.sourceNameToSource,h=d[c],l=h.getSourceTileUrl(e.level,e.row,e.col),p.pool.release(e),[4,r(l,g.__assign({responseType:"array-buffer"},b))];case 1:return k=f.sent(),[2,{protobuff:k.data,sourceName:c}]}})})};b.prototype._fetchTileMap=function(a,c){if(a.capabilities.operations.supportsTileMap&&a.tileIndex||!a.tileMapURL)return h.resolve();var b=u.get(a.tileMapURL);if(b)return a.tileIndex=b,h.resolve();if(m.has(a.tileMapURL))return m.get(a.tileMapURL).then(function(c){a.tileIndex=
new t(c.data)});c=r(a.tileMapURL,c);c.then(function(c){a.tileIndex=new t(c.data);m["delete"](a.tileMapURL);u.put(a.tileMapURL,a.tileIndex)});m.set(a.tileMapURL,c);return c};b.prototype._getRefKeys=function(a,c){var b=this._vectorTileLayer.sourceNameToSource,f=[],d;for(d in b){var g=b[d].getRefKey(a,c);f.push(g)}return h.eachAlways(f)};b.prototype._getSourcesData=function(a,c,b){for(var e=[],d=0;d<c.length;d++)if(null==c[d].value||null==a[d])e.push(null);else{var g=this._getTilePayload(c[d].value,
a[d],b);e.push(g)}return h.eachAlways(e).then(function(a){for(var b={},e=[],d=0;d<a.length;d++)a[d].value&&a[d].value&&a[d].value.protobuff&&0<a[d].value.protobuff.byteLength&&(b[a[d].value.sourceName]={refKey:c[d].value.id,protobuff:a[d].value.protobuff},e.push(a[d].value.protobuff));return{sourceName2DataAndRefKey:b,transferList:e}})};b.prototype._getVectorTileData=function(a){var c=this,b=a.id;if(this._ongoingTileRequests.has(b))return this._ongoingTileRequests.get(b);var f=new AbortController;
a=this._getParsedVectorTileData(a,{signal:f.signal}).then(function(a){c._ongoingTileRequests.delete(b);c._ongoingRequestToController.delete(b);return a}).catch(function(){c._ongoingTileRequests.delete(b);c._ongoingRequestToController.delete(b);return null});this._ongoingTileRequests.set(b,a);this._ongoingRequestToController.set(b,f);return a};b.prototype._getParsedVectorTileData=function(a,b){var c=this;return this.fetchTileData(a,b).then(function(e){return c.parseTileData({key:a,data:e},b)})};return b}();
n.TileHandler=q});