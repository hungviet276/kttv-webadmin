// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.17/esri/copyright.txt for details.
//>>built
define("require exports ../../../../core/Evented ../../../../core/maybe ../../../../core/screenUtils ../../../../core/libs/gl-matrix-2/mat4 ../../../../core/libs/gl-matrix-2/mat4f64 ../../../../core/libs/gl-matrix-2/vec3 ../../../../core/libs/gl-matrix-2/vec3f64 ../../../../core/libs/gl-matrix-2/vec4 ../../../../core/libs/gl-matrix-2/vec4f64 ../../../../geometry/support/aaBoundingBox ../editingTools/settings ./VisualElementResources ../../layers/graphics/ElevationContext ../../layers/graphics/pointUtils ../../support/projectionUtils ../../webgl-engine/lib/Camera ../../webgl-engine/lib/Geometry ../../webgl-engine/lib/GeometryUtil ../../webgl-engine/materials/ColorMaterial ../../webgl-engine/materials/ShadedColorMaterial".split(" "),
function(l,k,v,m,n,w,x,y,z,q,r,A,h,B,C,D,E,F,t,u,G,H){Object.defineProperty(k,"__esModule",{value:!0});k.VerticesVisualElement=void 0;l=function(){function b(a){var c=this;this.view=null;this.camera=new F.default;this.events=new v;this._spatialReference=this._vertices=null;this._color=h.settings.colorToVec4(h.settings.reshapeManipulators.vertex.color);this._elevationInfo=null;this._occludedMode=8;this.resources=new B.VisualElementResources({view:a.view,createResources:function(a){return c.createResources(a)},
recreateGeometry:function(a,e){a.geometries.length=0;c.recreateGeometry(e,a.vertexMaterial,a.vertexOutlineMaterial,a.geometries);return a.geometries},cameraChanged:function(a){return c.resources.recreateGeometry()}});var e=!0,d;for(d in a)d in this?"attached"===d?e=a[d]:this[d]=a[d]:console.error("Cannot set unknown property",d);this.attached=e}b.prototype.destroy=function(){this.resources.destroy()};Object.defineProperty(b.prototype,"hidden",{get:function(){return this.resources.hidden},set:function(a){this.resources.hidden=
a},enumerable:!1,configurable:!0});Object.defineProperty(b.prototype,"attached",{get:function(){return this.resources.attached},set:function(a){this.updateAttached(a)},enumerable:!1,configurable:!0});b.prototype.updateAttached=function(a){this.resources.attached=a};Object.defineProperty(b.prototype,"vertices",{get:function(){return this._vertices},set:function(a){this._vertices=a;this.resources.recreateGeometry()},enumerable:!1,configurable:!0});Object.defineProperty(b.prototype,"spatialReference",
{get:function(){return this._spatialReference},set:function(a){this._spatialReference=a;this.resources.recreateGeometry()},enumerable:!1,configurable:!0});Object.defineProperty(b.prototype,"color",{get:function(){return this._color},set:function(a){q.vec4.exactEquals(a,this._color)||(q.vec4.copy(this._color,a),this.updateMaterial())},enumerable:!1,configurable:!0});Object.defineProperty(b.prototype,"elevationInfo",{get:function(){return this._elevationInfo},set:function(a){this._elevationInfo=a;this.resources.recreateGeometry()},
enumerable:!1,configurable:!0});Object.defineProperty(b.prototype,"occludedMode",{get:function(){return this._occludedMode},set:function(a){a!==this._occludedMode&&(this._occludedMode=a,m.isSome(this.resources.resources)&&(this.resources.resources.vertexMaterial.renderOccluded=a,this.resources.resources.vertexOutlineMaterial.renderOccluded=a))},enumerable:!1,configurable:!0});Object.defineProperty(b.prototype,"vertexMaterialParameters",{get:function(){return{color:this._color,transparent:1>this._color[3]}},
enumerable:!1,configurable:!0});b.prototype.updateMaterial=function(){m.isSome(this.resources.resources)&&this.resources.resources.vertexMaterial.setParameterValues(this.vertexMaterialParameters)};b.prototype.recreateGeometry=function(a,c,e,d){for(var b=0,f=this.createRenderGeometries();b<f.length;b++){var g=f[b];a.addGeometry(g.vertexGeometry,c,g.xform);d.push(g.vertexGeometry);a.addGeometry(g.vertexOutlineGeometry,e,g.xform);d.push(g.vertexOutlineGeometry)}};b.prototype.createResources=function(a){var c=
this.color,e=r.vec4f64.fromValues(c[0],c[1],c[2],3<c.length?c[3]:1),d=new H.ShadedColorMaterial({color:e,transparent:1>c[3],writeDepth:!0,cullFace:2},"manipulator");d.renderOccluded=h.settings.reshapeManipulators.vertex.renderOccludedFlag;var c=h.settings.colorToVec4(h.settings.reshapeManipulators.vertex.outlineColor),c=r.vec4f64.fromValues(c[0],c[1],c[2],4===c.length?c[3]:1),b=new G({color:c,transparent:!0,writeDepth:!0,cullFace:1},"manipulator-outline");b.renderOccluded=h.settings.reshapeManipulators.vertex.renderOccludedFlag;
var f=[];this.recreateGeometry(a,d,b,f);return{vertexMaterial:d,vertexOutlineMaterial:b,geometries:f,forEach:function(a){a(d);a(b);f.forEach(a)}}};b.prototype.calculateMapBounds=function(a){if(m.isNone(this.resources.resources))return!1;for(var c=this.view.renderCoordsHelper,e=0,b=this.resources.resources.geometries;e<b.length;e++){var h=b[e].data.getAttribute("position"),f=h.data,g=new Float64Array(f.length);E.bufferToBuffer(h.data,c.spatialReference,0,g,this.view.spatialReference,0,f.length/3);
A.expandWithBuffer(a,g)}return!0};b.prototype.computeScreenLocation=function(a,c){c.pixelSize=this.camera.computeScreenPixelSizeAt(a);this.camera.projectPoint(a,c.renderScreenPointArray);this.camera.renderToScreen(c.renderScreenPointArray,c.screenPointArray);return c};b.prototype.computeTransform=function(a,c){var b=x.mat4f64.create(),d=this.computeScreenLocation(a,I);c*=d.pixelSize;w.mat4.set(b,c,0,0,0,0,c,0,0,0,0,c,0,0,0,0,1);b[12]+=a[0];b[13]+=a[1];b[14]+=a[2];b[15]=1;return b};b.prototype.createRenderGeometries=
function(){var a=this.vertices;if(!m.isNone(a)&&0!==a.length&&this.view.state&&this.view.state.camera)this.camera.copyFrom(this.view.state.camera);else return[];for(var b=h.settings.reshapeManipulators.vertex,e=b.size/2,d=e+b.collisionPadding,k=e/d,b=(e+b.outlineSize)/d,f=D.geometryToRenderInfo(a,this.spatialReference,this.view.elevationProvider,this.view.renderCoordsHelper,C.ElevationContext.fromElevationInfo(this.elevationInfo)),a=[],e=f.numVertices,f=f.position,g=0;g<e;++g){var l=new t(u.createSphereGeometry(k,
16,16),"VerticesVisualElement-vertex"),n=new t(u.createSphereGeometry(b,16,16),"VerticesVisualElement-vertexOutline"),p=y.vec3.set(J,f[3*g+0],f[3*g+1],f[3*g+2]),p=this.computeTransform(p,d);a.push({vertexGeometry:l,vertexOutlineGeometry:n,xform:p})}return a};return b}();k.VerticesVisualElement=l;var I={screenPointArray:n.createScreenPointArray(),renderScreenPointArray:n.createRenderScreenPointArray3(),pixelSize:0},J=z.vec3f64.create()});