// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.17/esri/copyright.txt for details.
//>>built
define(["require","exports","../../../../core/LRUCache","../../tiling/TileCoverage","../../tiling/TileKey"],function(k,g,l,t,m){Object.defineProperty(g,"__esModule",{value:!0});g.TileManager=void 0;var u=function(c,a){return c+1/(1<<2*a)};k=function(){function c(a,b){this._tiles=new Map;this._tileCache=new l(40,function(a){return a.dispose()});this._viewSize=[0,0];this.acquireTile=a.acquireTile;this.releaseTile=a.releaseTile;this.tileInfoView=a.tileInfoView;this._container=b}c.prototype.destroy=function(){this._tiles.clear();
this._tiles=null;this._tileCache.clear();this._tileCache=null};c.prototype.update=function(a){var b=this;this._updateCacheSize(a);a=this.tileInfoView.getTileCoverage(a.state,0,"smallest");for(var d=a.spans,e=a.lodInfo,c=e.level,f=new Set,g=new Set,n=0;n<d.length;n++)for(var h=d[n],k=h.row,l=h.colTo,h=h.colFrom;h<=l;h++){var p=m.getId(c,k,e.normalizeCol(h),e.getWorldForColumn(h)),q=this._getOrAcquireTile(p);f.add(p);q.hasData()?this._container.addChild(q):g.add(new m(p))}this._tiles.forEach(function(a,
b){a.isCoverage=f.has(b)});g.forEach(function(a){return b._findPlaceholdersForMissingTiles(a,f)});var r=!1;this._tiles.forEach(function(a,b){a.neededForCoverage=f.has(b);a.isHoldingForFade&&f.add(b);a.isFading&&(r=!0)});this._tiles.forEach(function(a,d){f.has(d)||b._releaseTile(d)});t.pool.release(a);return!r};c.prototype.clearCache=function(){this._tileCache.clear()};c.prototype._findPlaceholdersForMissingTiles=function(a,b){var d=this,c=[];this._tiles.forEach(function(e){d._addPlaceholderChild(c,
e,a,b)});var v=c.reduce(u,0);1E-6>Math.abs(1-v)||this._addPlaceholderParent(a.id,b)};c.prototype._addPlaceholderChild=function(a,b,d,c){if(!(b.key.level<=d.level)&&b.hasData()){var e=b.key,f=e.level-d.level;d.row===e.row>>f&&d.col===e.col>>f&&d.world===e.world&&(this._container.addChild(b),c.add(b.id),a.push(b.key.level-d.level))}};c.prototype._addPlaceholderParent=function(a,b){for(;;){var d=a.split("/");a=d[1];var c=d[2],g=d[3],d=parseInt(d[0],10);a=0===d?null:d-1+"/"+(parseInt(a,10)>>1)+"/"+(parseInt(c,
10)>>1)+"/"+parseInt(g,10);if(!a||b.has(a))break;if((c=this._getTile(a))&&c.hasData()){this._container.addChild(c);b.add(c.id);break}}};c.prototype._getOrAcquireTile=function(a){var b=this._tiles.get(a);if(b)return b;(b=this._tileCache.pop(a))||(b=this.acquireTile(new m(a)));this._tiles.set(a,b);return b};c.prototype._getTile=function(a){var b=this._tiles.get(a);if(b)return b;(b=this._tileCache.pop(a))&&this._tiles.set(a,b);return b};c.prototype._releaseTile=function(a){var b=this._tiles.get(a);this.releaseTile(b);
this._container.removeChild(b);this._tiles.delete(a);b.hasData()?this._tileCache.put(a,b,1):b.dispose()};c.prototype._updateCacheSize=function(a){a=a.state.size;if(a[0]!==this._viewSize[0]||a[1]!==this._viewSize[1]){var b=Math.ceil(a[0]/512)+1,c=Math.ceil(a[1]/512)+1;this._viewSize[0]=a[0];this._viewSize[1]=a[1];this._tileCache.maxSize=5*b*c}};return c}();g.TileManager=k});