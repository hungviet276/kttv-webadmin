// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.17/esri/copyright.txt for details.
//>>built
define("require exports tslib ../core/Accessor ../core/Collection ../core/Handles ../core/Logger ../core/maybe ../core/promiseUtils ../core/watchUtils ../core/accessorSupport/decorators ./input/InputManager ./input/ViewEvents ./interactive/interactiveToolUtils ./interactive/ToolViewManagerManipulatorState".split(" "),function(z,A,f,n,t,u,v,g,l,q,h,w,x,k,y){var m=v.getLogger("esri.views.ToolViewManager");return function(r){function d(b){var a=r.call(this,b)||this;a._handles=new u;a._creatingTool=null;
a._manipulatorState=new y.default;a.tools=k.newToolCollection();a.cursor=null;a._forEachTool=function(b){if(!g.isSome(a._creatingTool)||!b(a._creatingTool))for(var c=0,e=a.tools.items;c<e.length&&!b(e[c]);c++);};return a}f.__extends(d,r);d.prototype.initialize=function(){var b=this;this._handles.add([this.view.on(x.eventTypes,function(a){b._handleInputEvent(a)},w.ViewEventPriorities.TOOL),this.tools.on("before-add",function(a){var c=a.item;null==c||b.tools.includes(c)?a.preventDefault():null==c.created||
c.created||(m.error("tools","Tool can not be added to view before it has been created"),a.preventDefault())}),this.tools.on("before-remove",function(a){b._manipulatorState.clearPointers(a.item,b._forEachTool)}),this.tools.on("change",function(){b._refreshToolWatchers()})])};d.prototype.destroy=function(){this._forEachTool(function(b){return b.destroy()});this._handles.destroy();this._handles=null};Object.defineProperty(d.prototype,"activeTool",{set:function(b){var a=this;g.isSome(b)&&!this.view.ready?
m.error("#activeTool\x3d","cannot set active tool while view is not ready"):(k.swap(this,b,function(c){a._set("activeTool",c);a._removeIncompleteTools(b);a._forEachTool(function(b){var c=g.isNone(a.activeTool)||b===a.activeTool;b.setEditableFlag&&b.setEditableFlag(1,c);c=k.areToolManipulatorsEditable(b);!g.isNone(a.activeTool)&&c||a._manipulatorState.clearPointers(b,a._forEachTool,!c)});a._updateCursor()}),this._creatingTool!==b&&this._rejectCreatingTool())},enumerable:!1,configurable:!0});d.prototype.createTool=
function(b,a,c){return f.__awaiter(this,void 0,void 0,function(){var d,e,h,m=this;return f.__generator(this,function(p){switch(p.label){case 0:return[4,this.view.whenReady()];case 1:p.sent();if(l.isAborted(c))throw l.createAbortError("Tool creation was interrupted by another tool being created");d=k.evaluateToolConstructorArguments(a);e=new b(f.__assign(f.__assign({},d),{view:this.view}));h=l.onAbort(c,function(){return m.activeTool=null});this._rejectCreatingTool("Tool creation was interrupted by another tool being created");
this._creatingTool=e;e.attach();this._refreshToolWatchers();k.setActive(e,!0);return[4,e.when()];case 2:return p.sent(),g.isSome(h)&&h.remove(),this._creatingTool=null,this.tools.add(e),e instanceof n&&null!=e.completed&&q.whenOnce(e,"completed").then(function(){k.setActive(e,!1)}),[2,e]}})})};d.prototype.attach=function(){var b=this;this._forEachTool(function(a){return a.attach()});"3d"===this.view.type?this._handles.add([this.view.state.watch("camera",function(){b.forEachManipulator(function(a){if(null!=
a.onViewChange)a.onViewChange()})}),this.view.elevationProvider.on("elevation-change",function(a){b.forEachManipulator(function(b){if(null!=b.onElevationChange)b.onElevationChange(a)})})],"manipulators"):this._handles.add(this.view.watch("extent",function(){b.forEachManipulator(function(a){if(null!=a.onViewChange)a.onViewChange()})}))};d.prototype.detach=function(){this.activeTool=null;this._forEachTool(function(b){b.detach();b.destroy()});this.tools.removeAll();this._handles.remove("manipulators")};
d.prototype.forEachManipulator=function(b){this._forEachTool(function(a){a.manipulators&&a.manipulators.forEach(function(c){return b(c.manipulator,a)})})};d.prototype._handleInputEvent=function(b){var a=this,c=!1,d=f.__assign(f.__assign({},b),{stopPropagation:function(){c=!0;b.stopPropagation()}});g.isSome(this.activeTool)?this.activeTool.handleInputEvent&&this.activeTool.handleInputEvent(d):this._forEachTool(function(a){!c&&!1!==a.visible&&a.handleInputEvent&&a.handleInputEvent(d)});!c&&"key-down"===
b.type&&"Escape"===b.key&&this.activeTool&&(b.stopPropagation(),this.activeTool=null);this._manipulatorState.handleInputEvent(d,{forEachTool:this._forEachTool,activeTool:this.activeTool,setActiveTool:function(b){a.activeTool=b},creatingTool:this._creatingTool,view:this.view});!c&&g.isSome(this.activeTool)&&this.activeTool.handleInputEventAfter&&this.activeTool.handleInputEventAfter(d);this._manipulatorState.handleHoverEvent(d,this._forEachTool);this._updateCursor()};d.prototype._refreshToolWatchers=
function(){var b=this;this._handles.remove("tools");this._forEachTool(function(a){if(a instanceof n){var c=q.watch(a,["cursor","visible","editable"],function(){k.areToolManipulatorsEditable(a)||b._manipulatorState.clearPointers(a,b._forEachTool);b._updateCursor()});b._handles.add(c,"tools")}a.manipulators&&b._handles.add(a.manipulators.on("change",function(c){c.removed.forEach(function(c){b._manipulatorState.clearPointers(a,b._forEachTool,!0,c.id)});b._manipulatorState.updateHoveredStateFromKnownPointers(b._forEachTool);
b._updateCursor()}),"tools")});this._manipulatorState.updateHoveredStateFromKnownPointers(this._forEachTool);this._updateCursor()};d.prototype._updateCursor=function(){var b=null;this._forEachTool(function(a){return null!=a.cursor&&!1!==a.visible?(b=a.cursor,!0):!1});b||(b=this._manipulatorState.cursor);this._get("cursor")!==b&&this._set("cursor",b)};d.prototype._rejectCreatingTool=function(b){var a=this._creatingTool;g.isNone(a)||(this._manipulatorState.clearPointers(a,this._forEachTool),a.rejectCreation&&
a.rejectCreation(l.createAbortError(b)),a.destroy(),this._creatingTool=null,this._refreshToolWatchers())};d.prototype._removeIncompleteTools=function(b){var a=this;this.tools.filter(function(a){return(g.isNone(b)||a!==b)&&null!=a.completed&&!a.completed}).forEach(function(b){a.tools.remove(b)})};f.__decorate([h.property({constructOnly:!0,nonNullable:!0})],d.prototype,"view",void 0);f.__decorate([h.property({value:null})],d.prototype,"activeTool",null);f.__decorate([h.property({readOnly:!0,type:t})],
d.prototype,"tools",void 0);f.__decorate([h.property({readOnly:!0})],d.prototype,"cursor",void 0);return d=f.__decorate([h.subclass("esri.views.ToolViewManager")],d)}(n)});