// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.17/esri/copyright.txt for details.
//>>built
define("require exports tslib ../../../core/asyncUtils ../../../core/Logger ../../../core/promiseUtils ../../../core/promiseUtils ../../../core/watchUtils ../../../core/accessorSupport/decorators ../../../geometry/Extent ../../../geometry/support/aaBoundingRect ./LayerView3D ./support/overlayImageUtils ./support/projectExtentUtils ../support/debugFlags ../webgl-engine/lib/RenderGeometry ../webgl-engine/lib/Texture ../webgl-engine/materials/ImageMaterial ../../layers/LayerView ../../layers/RefreshableLayerView".split(" "),
function(v,K,e,y,z,q,w,A,h,x,k,B,r,C,D,E,F,G,H,I){var u=z.getLogger("esri.views.3d.layers.DynamicLayerView3D");v=function(m){function b(){var a=null!==m&&m.apply(this,arguments)||this;a.drapeSourceType=0;a.hasDraped=!0;a.fullExtentInLocalViewSpatialReference=null;a.maximumDataResolution=null;a._images=[];a._extents=[];a._overlayExtents=[];a.updateWhenStationary=!0;return a}e.__extends(b,m);b.prototype.initialize=function(){var a=this;this.addResolvingPromise(C.toViewIfLocal(this).then(function(d){return a._set("fullExtentInLocalViewSpatialReference",
d)}));this.updatingHandles.add(this,"suspended",function(){return a._suspendedChangeHandler()});this.handles.add(this.view.resourceController.scheduler.registerIdleStateCallbacks(function(){a._isScaleRangeActive()&&a.notifyChange("suspended")},function(){}));this._isScaleRangeLayer()&&this.updatingHandles.add(this.layer,"scaleRangeId",function(){return a.notifyChange("suspended")});"local"===this.view.viewingMode&&this.updatingHandles.add(this.view.basemapTerrain,"extent",function(){return a._overlayExtents.forEach(function(d,
f){return a._updateImageExtent(f)})})};b.prototype.destroy=function(){this.clear()};b.prototype.setDrapingExtent=function(a,d,f,c,b,e){this._overlayExtents[a]={extent:k.create(d),spatialReference:f,resolution:c,renderLocalOrigin:b,pixelRatio:e};this._updateImageExtent(a)};b.prototype._updateImageExtent=function(a){var d=this._overlayExtents[a],f=this._clippedExtent(d.extent,J),c=r.computeImageExportSize(d.extent,f,d.resolution),b=d.pixelRatio*this.view.pixelRatio;if("imageMaxWidth"in this.layer||
"imageMaxHeight"in this.layer){var e=this.layer.imageMaxWidth,g=this.layer.imageMaxHeight;if(c.width>e){var l=e/c.width;c.height=Math.floor(c.height*l);c.width=e;b*=l}c.height>g&&(l=g/c.height,c.width=Math.floor(c.width*l),c.height=g,b*=l)}e=this._extents[a];e&&k.equals(e.extent,f)&&!this._imageSizeDiffers(f,e.imageSize,c)||(this._extents[a]={extent:k.create(f),spatialReference:d.spatialReference,imageSize:c,pixelRatio:b},this.suspended||this._fetch(a).catch(function(a){q.isAbortError(a)||u.error(a)}))};
b.prototype.clear=function(){for(var a=0;a<this._images.length;a++)this._clearImage(a)};b.prototype.doRefresh=function(a){return e.__awaiter(this,void 0,void 0,function(){var d,f;return e.__generator(this,function(c){switch(c.label){case 0:if(this.suspended)return[2];d=[];for(f=0;f<this._extents.length;f++)this._extents[f]&&d.push(this._fetch(f,a));return[4,q.eachAlways(d)];case 1:return c.sent(),[2]}})})};b.prototype.canResume=function(){if(!m.prototype.canResume.call(this))return!1;if(this._isScaleRangeLayer()){var a=
this.layer,d=a.minScale,a=a.maxScale;if(0<d||0<a){var f=this.view.scale;if(f<a||0<d&&f>d)return!1}}return!0};b.prototype.isUpdating=function(){return this._images.some(function(a){return!!a.loadingPromise})};b.prototype.processResult=function(a,d,f){return e.__awaiter(this,void 0,void 0,function(){return e.__generator(this,function(c){if(d instanceof HTMLImageElement||d instanceof HTMLCanvasElement)a.image=d;return[2]})})};b.prototype.findExtentInfoAt=function(a){for(var d=0,f=this._extents;d<f.length;d++){var c=
f[d],b=c.extent;if((new x(b[0],b[1],b[2],b[3],c.spatialReference)).contains(a))return c}return null};b.prototype.getFetchOptions=function(){};b.prototype.redraw=function(a,d){return e.__awaiter(this,void 0,void 0,function(){var b=this;return e.__generator(this,function(c){switch(c.label){case 0:return[4,y.forEach(this._images,function(c,f){return e.__awaiter(b,void 0,void 0,function(){return e.__generator(this,function(b){switch(b.label){case 0:return c?[4,a(c,d)]:[2];case 1:return b.sent(),this._createStageObjects(f,
c.image),this.emit("draped-data-change"),[2]}})})})];case 1:return c.sent(),[2]}})})};b.prototype._imageSizeDiffers=function(a,d,b){if(!this.maximumDataResolution||D.TESTS_DISABLE_UPDATE_THRESHOLDS)return!0;var c=k.width(a)/this.maximumDataResolution.x;a=k.height(a)/this.maximumDataResolution.y;a=Math.abs(a/d.height-a/b.height);return 1.5<Math.abs(c/d.width-c/b.width)||1.5<a?!0:!1};b.prototype._fetch=function(a,d){return e.__awaiter(this,void 0,void 0,function(){var b,c,n,h,g,l,m,t,r,p=this;return e.__generator(this,
function(f){switch(f.label){case 0:if(this.suspended)return[2];b=this._overlayExtents[a];c=this._extents[a];n=c.extent;h=new x(n[0],n[1],n[2],n[3],c.spatialReference);this._images[a]||(this._images[a]={texture:null,material:null,rendergeometry:null,loadingPromise:null,loadingAbortController:null,image:null,pixelData:null,renderExtent:k.create(n)});g=this._images[a];g.loadingAbortController&&(g.loadingAbortController.abort(),g.loadingAbortController=null);if(0===h.width||0===h.height)return this._clearImage(a),
[2];l=q.createAbortController();g.loadingAbortController=l;q.onAbort(d,function(){return l.abort()});m=l.signal;t=this._waitFetchReady(m).then(function(){var a=e.__assign(e.__assign({requestAsImageElement:!0,pixelRatio:b.pixelRatio},p.getFetchOptions()),{signal:m}),d=c.imageSize;return p.layer.fetchImage(h,d.width,d.height,a)}).then(function(a){if(w.isAborted(m))throw u.warnOnce("A call to fetchImage resolved even though the request was aborted. fetchImage should not resolve if options.signal.aborted is true."),
w.createAbortError();return p.processResult(g,a)});g.loadingPromise=t;q.always(t,function(){t===g.loadingPromise&&(g.loadingPromise=null,g.loadingAbortController=null)});r=t.then(function(){k.set(g.renderExtent,n);p._createStageObjects(a,g.image);p.notifyChange("updating");p.emit("draped-data-change")}).catch(function(a){a&&!q.isAbortError(a)&&u.error(a);p.notifyChange("updating");throw a;});this.notifyChange("updating");return[4,r];case 1:return f.sent(),[2]}})})};b.prototype.notifyGraphicUpdate=
function(){};b.prototype._clearImage=function(a){a=this._images[a];var d=this.view._stage;a&&(a.rendergeometry&&(this.view.basemapTerrain.overlayManager.renderer.removeGeometries([a.rendergeometry],this,2),a.rendergeometry=null),a.texture&&(d.remove(4,a.texture.id),a.texture=null),a.material&&(d.remove(3,a.material.id),a.material=null),a.loadingAbortController&&(a.loadingAbortController.abort(),a.loadingAbortController=null),a.loadingPromise=null,a.image=null,a.pixelData=null)};b.prototype._createStageObjects=
function(a,d){var b=this.view._stage,c=this._images[a];c.texture&&(b.remove(4,c.texture.id),c.texture=null);d?(c.texture=new F(d,"dynamicLayer",{width:d.width,height:d.height,preMultiplyAlpha:!0,wrap:{s:33071,t:33071}}),b.add(4,c.texture)):c.material&&(b.remove(3,c.material.id),c.material=null);!c.material&&c.texture?(c.material=new G({transparent:!0,textureId:c.texture.id},"dynamicLayer"),b.add(3,c.material)):c.material&&d&&c.material.setParameterValues({textureId:c.texture.id});d=this.view.basemapTerrain.overlayManager.renderer;
if(c.material){var e=void 0,b=this._overlayExtents[a].renderLocalOrigin;if(0===a)e=r.createGeometryForExtent(c.renderExtent,-1);else if(1===a){a=this._images[0].renderExtent;if(!a)return;e=r.createOuterImageGeometry(a,c.renderExtent,-1)}else{console.error("DynamicLayerView3D._createStageObjects: Invalid extent idx");return}a=new E(e);a.material=c.material;a.origin=b;d.addGeometries([a],this,2);c.rendergeometry&&d.removeGeometries([c.rendergeometry],this,2);c.rendergeometry=a}else c.rendergeometry&&
(d.removeGeometries([c.rendergeometry],this,2),c.rendergeometry=null)};b.prototype._isScaleRangeLayer=function(){return"minScale"in this.layer&&"maxScale"in this.layer};b.prototype._isScaleRangeActive=function(){return this._isScaleRangeLayer()?0<this.layer.minScale||0<this.layer.maxScale:!1};b.prototype._clippedExtent=function(a,b){if("local"!==this.view.viewingMode)return k.set(b,a);var d=this.view.basemapTerrain,c=d.extent;return d.ready&&c?k.intersection(a,c,b):k.set(b,a)};b.prototype._suspendedChangeHandler=
function(){this.suspended?(this.clear(),this.emit("draped-data-change")):this.refresh()};b.prototype._waitFetchReady=function(a){return e.__awaiter(this,void 0,void 0,function(){return e.__generator(this,function(b){switch(b.label){case 0:return this.updateWhenStationary?[4,A.whenOnce(this.view,"stationary",a)]:[3,2];case 1:b.sent(),b.label=2;case 2:return[2]}})})};e.__decorate([h.property()],b.prototype,"layer",void 0);e.__decorate([h.property({dependsOn:["view.scale","layer.minScale","layer.maxScale"]})],
b.prototype,"suspended",void 0);e.__decorate([h.property({type:Boolean})],b.prototype,"hasDraped",void 0);e.__decorate([h.property({readOnly:!0})],b.prototype,"fullExtentInLocalViewSpatialReference",void 0);e.__decorate([h.property()],b.prototype,"updating",void 0);return b=e.__decorate([h.subclass("esri.views.3d.layers.DynamicLayerView3D")],b)}(I.RefreshableLayerView(B.LayerView3D(H)));var J=k.create();return v});