// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.17/esri/copyright.txt for details.
//>>built
define("require exports tslib ../../../../core/maybe ../../../../core/promiseUtils ../../../../core/libs/gl-matrix-2/vec4f64 ../lib/AutoDisposable ../../../support/screenshotUtils ../../../webgl/FramebufferObject".split(" "),function(p,l,m,q,r,t,u,n,v){Object.defineProperty(l,"__esModule",{value:!0});l.ScreenshotManager=void 0;p=function(l){function f(a,c,b,d,e,k){void 0===d&&(d=null);void 0===k&&(k=!0);var g=l.call(this)||this;g._rctx=a;g._renderScene=c;g._requestRenderScene=b;g._renderOverlay=d;
g.forceCameraHook=e;g.supersample=k;g._screenshotQueue=[];return g}m.__extends(f,l);f.prototype.dispose=function(){this._rctx=null};f.prototype.takeScreenshot=function(a){this._requestRenderScene();var c=r.createResolver();this._screenshotQueue.push({settings:a,resolver:c});return c.promise};f.prototype.update=function(a){if(0!==this._screenshotQueue.length){for(var c=0,b=this._screenshotQueue;c<b.length;c++){var d=b[c];if(this.isDisposed)d.resolver.reject();else{var e=m.__assign(m.__assign({},d.settings),
{pixelRatio:d.settings.pixelRatio*a.viewCamera.pixelRatio}),k=this._ensureScreenshotEncodeCanvas(),g=this._renderScreenshot(a,e),e=n.encodeResult(g,e,k,{flipY:!0,premultipliedAlpha:!0});d.resolver(e)}}this._screenshotQueue=[]}};f.prototype._renderScreenshotOverlay=function(a,c,b){if(!q.isNone(this._renderOverlay)){a.width=c.width;a.height=c.height;var d=a.getContext("2d"),e=b.pixelRatio;d.save();d.translate(0,c.height);d.scale(1,-1);b.region&&d.translate(-b.region.x,-b.region.y);d.scale(e,e);this._renderOverlay(a,
c);d.restore()}};f.prototype._readbackScreenshot=function(a){return a.resample?this._readbackScreenshotResampled(a):this._readbackScreenshotImmediate(a)};f.prototype._readbackScreenshotResampled=function(a){var c=a.framebufferWidth,b=a.framebufferHeight,d=a.region,e=a.resample,k=this._ensureScreenshotEncodeCanvas(),g=n.createEmptyImageData(c,b,k);this._rctx.gl.readPixels(0,0,c,b,6408,5121,new Uint8Array(g.data.buffer));this._renderScreenshotOverlay(k,g,m.__assign(m.__assign({},a),{region:null}));
a=n.createEmptyImageData(d.width,d.height,k);return n.resampleHermite(g,a,!0,e.region.x,b-(e.region.y+e.region.height),e.region.width,e.region.height)};f.prototype._readbackScreenshotImmediate=function(a){var c=a.framebufferHeight,b=a.region,d=this._ensureScreenshotEncodeCanvas(),e=n.createEmptyImageData(b.width,b.height,d);this._rctx.gl.readPixels(b.x,c-(b.y+b.height),b.width,b.height,6408,5121,new Uint8Array(e.data.buffer));this._renderScreenshotOverlay(d,e,a);return e};f.prototype._renderScreenshot=
function(a,c){var b=null,d=a.viewCamera,e=c.framebufferWidth,k=c.framebufferHeight,g=!1;a=a.frameHasSlicePlane&&c.disableSlice;var h=c.ignorePadding&&d.pixelRatio!==c.pixelRatio;if(a=e!==d.fullWidth||k!==d.fullHeight||a||h){h=d.clone();if(c.ignorePadding){for(var b=t.vec4f64.clone(h.padding),f=0;4>f;f++)b[f]=Math.round(b[f]/h.pixelRatio*c.pixelRatio);h.padding=b}h.fullWidth=e;h.fullHeight=k;h.pixelRatio=c.pixelRatio;b=d.fovX-h.fovX;e=d.fovY-h.fovY;0>b&&b<e?h.fovX=d.fovX:0>e&&e<b&&(h.fovY=d.fovY);
this.forceCameraHook(h);g=!0;b=new v(this._rctx,{width:h.fullWidth,height:h.fullHeight,colorTarget:0,depthStencilTarget:3});this._renderScene(b,h,c.disableSlice)}c=this._readbackScreenshot(c);if(a&&!this._rctx.contextAttributes.alpha)for(f=3;f<c.data.length;f+=4)c.data[f]=255;b&&b.dispose();this._rctx.bindFramebuffer(null);g&&this.forceCameraHook(d);return c};f.prototype._ensureScreenshotEncodeCanvas=function(){this._screenshotEncodeCanvas||(this._screenshotEncodeCanvas=document.createElement("canvas"));
return this._screenshotEncodeCanvas};return f}(u.AutoDisposable);l.ScreenshotManager=p});