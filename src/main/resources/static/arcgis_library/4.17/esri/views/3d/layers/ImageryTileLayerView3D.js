// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.17/esri/copyright.txt for details.
//>>built
define("require exports tslib ../../../core/maybe ../../../core/watchUtils ../../../core/accessorSupport/decorators ./LayerView3D ./TiledLayerView3D ../terrain/RasterTile ../../layers/ImageryTileLayerView ../../layers/LayerView ../../layers/RefreshableLayerView ../../support/drapedUtils".split(" "),function(y,z,c,n,p,d,q,r,t,u,v,w,x){return function(h){function b(){var a=null!==h&&h.apply(this,arguments)||this;a.isAlignedMapTile=!0;return a}c.__extends(b,h);b.prototype.initialize=function(){var a=
this;this.layer.increaseRasterJobHandlerUsage();var b=this.updateFullExtent();this.addResolvingPromise(b);b=p.whenTrueOnce(this.view,"basemapTerrain.tilingSchemeLocked").then(function(){var b=a.view.basemapTerrain.tilingScheme,c=a.layer.tileInfo,f=-1<["png","png24","png32","jpg","mixed"].indexOf(c.format)&&b.compatibleWith(c),b=(a.isAlignedMapTile=f)?c:b.toTileInfo();a._set("tileInfo",b);a.updatingHandles.add(a,"layer.renderer",function(){return a.refresh()});a.updatingHandles.add(a,"layer.interpolation",
function(){return a.refresh()});a.updatingHandles.add(a,"layer.bandIds",function(){return a.refresh()});a.updatingHandles.add(a,"layer.multidimensionalDefinition",function(){return a.refresh()})});this.addResolvingPromise(b)};b.prototype.destroy=function(){this.layer.decreaseRasterJobHandlerUsage();this.view=null};Object.defineProperty(b.prototype,"_blankTile",{get:function(){var a=document.createElement("canvas"),b=a.getContext("2d"),c=this.tileInfo.size,d=c[0],c=c[1];a.width=d;a.height=c;b.clearRect(0,
0,d,c);return b.getImageData(0,0,d,c)},enumerable:!1,configurable:!0});Object.defineProperty(b.prototype,"imageFormatIsOpaque",{get:function(){return"jpg"===this.layer.tileInfo.format},enumerable:!1,configurable:!0});Object.defineProperty(b.prototype,"hasMixedImageFormats",{get:function(){return"mixed"===this.layer.tileInfo.format},enumerable:!1,configurable:!0});Object.defineProperty(b.prototype,"dataLevelRange",{get:function(){var a=this.layer.tileInfo.lods;return this.levelRangeFromScaleRange(this.tileInfo.lods[0].scale,
a[a.length-1].scale)},enumerable:!1,configurable:!0});b.prototype.fetchTile=function(a,b,d,h){return c.__awaiter(this,void 0,void 0,function(){var f,k,m,e,l,g;return c.__generator(this,function(c){switch(c.label){case 0:return f=this.tileInfo,k=this.layer.symbolizer.canRenderInWebGL,m={tileInfo:f,requestRawData:k,signal:n.unwrap(h.signal),requestAsImageElement:this.isAlignedMapTile},[4,this.layer.fetchTile(a,b,d,m)];case 1:return e=c.sent(),e instanceof HTMLImageElement?[2,e]:(l=e&&e.pixelBlock)?
k?[3,3]:[4,this.layer.applyRenderer(e)]:[2,this._blankTile];case 2:l=c.sent();if(null==l)return[2,this._blankTile];c.label=3;case 3:return g=new t.default([a,b,d],l,f.size[0],f.size[1]),k&&(g.symbolizerRenderer=this.layer.symbolizer.renderer,g.symbolizerParameters=this.layer.symbolizer.generateWebGLParameters(this._getSymbolizerOptions(a)),g.transformGrid=e.transformGrid),g.bandIds=this.layer.bandIds,[2,g]}})})};b.prototype._getSymbolizerOptions=function(a){a=this.tileInfo.lodAt(a).resolution;return{pixelBlock:null,
isGCS:this.view.spatialReference.isGeographic,resolution:{x:a,y:a},bandIds:this.layer.bandIds}};b.prototype.ensureSymbolizerParameters=function(a){a.symbolizerRenderer!==this.layer.symbolizer.renderer&&(a.symbolizerParameters=this.layer.symbolizer.generateWebGLParameters(this._getSymbolizerOptions(a.lij[0])))};b.prototype.createFetchPopupFeaturesQueryGeometry=function(a,b){return x.createQueryGeometry(a,b,this.view)};b.prototype.refresh=function(){this.emit("data-changed")};b.prototype.doRefresh=
function(a){return c.__awaiter(this,void 0,void 0,function(){return c.__generator(this,function(a){if(this.suspended)return[2];this.emit("data-changed");return[2]})})};c.__decorate([d.property({readOnly:!0,dependsOn:["tileInfo"]})],b.prototype,"_blankTile",null);c.__decorate([d.property({readOnly:!0,dependsOn:["layer.tileInfo.format"]})],b.prototype,"imageFormatIsOpaque",null);c.__decorate([d.property({readOnly:!0,dependsOn:["layer.tileInfo.format"]})],b.prototype,"hasMixedImageFormats",null);c.__decorate([d.property({readOnly:!0,
dependsOn:["tileInfo","view.basemapTerrain.tilingScheme","layer.url"]})],b.prototype,"dataLevelRange",null);return b=c.__decorate([d.subclass("esri.views.3d.layers.ImageryTileLayerView3D")],b)}(u.ImageryTileLayerView(w.RefreshableLayerView(r.TiledLayerView3D(q.LayerView3D(v)))))});