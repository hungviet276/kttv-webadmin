// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.17/esri/copyright.txt for details.
//>>built
define("require exports tslib ../../../../core/Logger ../../../../core/mathUtils ../../../../core/maybe ../../../../core/screenUtils ../../../../core/libs/gl-matrix-2/vec2 ../../../../core/libs/gl-matrix-2/vec3 ../../../../core/libs/gl-matrix-2/vec3f64 ../../support/geometryUtils ../../support/buffer/InterleavedLayout ../lib/geometryDataUtils ../lib/GLMaterial ../lib/Material ../lib/Util ./VisualVariableMaterialParameters ./internal/MaterialUtil ./renderers/utils ../shaders/RibbonLineTechnique ../shaders/RibbonLineTechnique".split(" "),
function(S,ra,I,W,J,K,D,X,e,l,d,Y,Z,aa,ba,ca,da,ea,fa,ga,h){function L(h,b,a,c,m){for(var e=0;e<m;e++)a[c++]=h[b++];return c}function N(e,b,a){a=a?a[h.RibbonVertexAttributeConstants.POSITION]:null;return e.isClosed?a?2<a.length:6<b[h.RibbonVertexAttributeConstants.POSITION].data.length:!1}var H=W.getLogger("esri.views.3d.webgl-engine.materials.RibbonLineMaterial");S=function(l){function b(a,c){c=l.call(this,c)||this;c._vertexAttributeLocations=h.ribbonVertexAttributeLocations;c.techniqueConfig=new h.RibbonLineTechniqueConfiguration;
c.params=ea.copyParameters(a,ha);c.validateParams();c.params.transparent=1>c.params.color[3]||c.params.transparent;c.layout=c.createLayout();return c}I.__extends(b,l);b.prototype.isClosed=function(a,c){return this.params.isClosed?c?2<c.length:6<a.length:!1};b.prototype.dispose=function(){};b.prototype.setParameterValues=function(a){for(var c in a)"cap"===c?H.error("cap cannot be changed after creation"):"join"===c&&"round"===this.params[c]!==("round"===a[c])?H.error("join cannot be changed after creation"):
"stipplePattern"===c&&!!this.params[c]!==!!a[c]?H.error("stippledness cannot be changed after creation"):this.params[c]=a[c];this.validateParams();this.parametersChanged()};b.prototype.getParameters=function(){return this.params};b.prototype.getPassParameters=function(){return this.params};b.prototype.getTechniqueConfig=function(a){this.techniqueConfig.output=a;a=K.isSome(this.params.stipplePattern);this.techniqueConfig.stippleEnabled=a;this.techniqueConfig.stippleIntegerRepeatsEnabled=a&&this.params.stippleIntegerRepeats;
this.techniqueConfig.stippleOffColorEnabled=a&&K.isSome(this.params.stippleOffColor);this.techniqueConfig.slicePlaneEnabled=this.params.slicePlaneEnabled;this.techniqueConfig.sceneHasOcludees=this.params.sceneHasOcludees;this.techniqueConfig.roundJoins="round"===this.params.join;this.techniqueConfig.roundCaps="round"===this.params.cap;this.techniqueConfig.transparent=this.params.transparent;this.techniqueConfig.polygonOffset=this.params.polygonOffset;this.techniqueConfig.writeDepth=this.params.writeDepth;
this.techniqueConfig.vvColor=this.params.vvColorEnabled;this.techniqueConfig.vvOpacity=this.params.vvOpacityEnabled;this.techniqueConfig.vvSize=this.params.vvSizeEnabled;this.techniqueConfig.innerColorEnabled=0<this.params.innerWidth&&K.isSome(this.params.innerColor);this.techniqueConfig.falloffEnabled=0<this.params.falloff;this.techniqueConfig.occluder=8===this.renderOccluded;return this.techniqueConfig};b.prototype.intersect=function(a,c,b,h,g,e,k,f,E){E?this.intersectDrapedLineGeometry(a,h,e,k):
this.intersectLineGeometry(a,c,b,h,this.params.width,k)};b.prototype.intersectDrapedLineGeometry=function(a,c,b,e){if(c.options.selectionMode){c=a.getAttribute(h.RibbonVertexAttributeConstants.POSITION).data;var g=a.getAttribute(h.RibbonVertexAttributeConstants.SIZE),m=this.params.width;this.params.vvSizeEnabled?(g=a.getAttribute(h.RibbonVertexAttributeConstants.SIZEFEATUREATTRIBUTE).data[0],m*=J.clamp(this.params.vvSizeOffset[0]+g*this.params.vvSizeFactor[0],this.params.vvSizeMinSize[0],this.params.vvSizeMaxSize[0])):
g&&(m*=g.data[0]);g=b[0];b=b[1];a=(m/2+4)*a.screenToWorldRatio;for(var m=Number.MAX_VALUE,k=0;k<c.length-5;k+=3){var f=c[k],E=c[k+1],d=g-f,r=b-E,f=c[k+3]-f,E=c[k+4]-E,A=J.clamp((f*d+E*r)/(f*f+E*E),0,1),d=f*A-d,r=E*A-r,r=d*d+r*r;r<m&&(m=r)}m<a*a&&e()}};b.prototype.intersectLineGeometry=function(a,c,b,A,g,q){if(A.options.selectionMode&&!fa.isInstanceHidden(c))if(ca.isTranslationMatrix(b)){var k=a.data,f=k.getVertexAttr();a=f[h.RibbonVertexAttributeConstants.POSITION].data;this.params.vvSizeEnabled?
g*=J.clamp(this.params.vvSizeOffset[0]+f[h.RibbonVertexAttributeConstants.SIZEFEATUREATTRIBUTE].data[0]*this.params.vvSizeFactor[0],this.params.vvSizeMinSize[0],this.params.vvSizeMaxSize[0]):f[h.RibbonVertexAttributeConstants.SIZE]&&(g*=f[h.RibbonVertexAttributeConstants.SIZE].data[0]);var m=A.camera,l=ia;X.vec2.copy(l,A.point);g=g*m.pixelRatio/2+4*m.pixelRatio;e.vec3.set(F[0],l[0]-g,l[1]+g,0);e.vec3.set(F[1],l[0]+g,l[1]+g,0);e.vec3.set(F[2],l[0]+g,l[1]-g,0);e.vec3.set(F[3],l[0]-g,l[1]-g,0);for(var r=
0;4>r;r++)m.unprojectPoint(F[r],y[r]);d.plane.fromPoints(m.eye,y[0],y[1],O);d.plane.fromPoints(m.eye,y[1],y[2],P);d.plane.fromPoints(m.eye,y[2],y[3],Q);d.plane.fromPoints(m.eye,y[3],y[0],R);c=Number.MAX_VALUE;k=N(this.params,f,k.indices)?a.length-2:a.length-5;for(r=0;r<k;r+=3)if(t[0]=a[r]+b[12],t[1]=a[r+1]+b[13],t[2]=a[r+2]+b[14],f=(r+3)%a.length,u[0]=a[f]+b[12],u[1]=a[f+1]+b[13],u[2]=a[f+2]+b[14],!(0>d.plane.signedDistance(O,t)&&0>d.plane.signedDistance(O,u)||0>d.plane.signedDistance(P,t)&&0>d.plane.signedDistance(P,
u)||0>d.plane.signedDistance(Q,t)&&0>d.plane.signedDistance(Q,u)||0>d.plane.signedDistance(R,t)&&0>d.plane.signedDistance(R,u))){m.projectPoint(t,C);m.projectPoint(u,B);if(0>C[2]&&0<B[2]){e.vec3.subtract(v,t,u);var f=m.frustum,M=-d.plane.signedDistance(f.planes[4],t),f=M/e.vec3.dot(v,d.plane.normal(f.planes[4]));e.vec3.scale(v,v,f);e.vec3.add(t,t,v);m.projectPoint(t,C)}else if(0<C[2]&&0>B[2])e.vec3.subtract(v,u,t),f=m.frustum,M=-d.plane.signedDistance(f.planes[4],u),f=M/e.vec3.dot(v,d.plane.normal(f.planes[4])),
e.vec3.scale(v,v,f),e.vec3.add(u,u,v),m.projectPoint(u,B);else if(0>C[2]&&0>B[2])continue;C[2]=0;B[2]=0;f=d.lineSegment.distance2(d.lineSegment.fromPoints(C,B,T),l);f<c&&(c=f,e.vec3.copy(U,t),e.vec3.copy(V,u))}b=A.rayBeginPoint;A=A.rayEndPoint;c<g*g&&(a=Number.MAX_VALUE,d.lineSegment.closestLineSegmentPoint(d.lineSegment.fromPoints(U,V,T),d.lineSegment.fromPoints(b,A,ja),G)&&(e.vec3.subtract(G,G,b),a=e.vec3.length(G),e.vec3.scale(G,G,1/a),a/=e.vec3.distance(b,A)),q(a,G))}else H.error("intersection assumes a translation-only matrix")};
b.prototype.computeAttachmentOrigin=function(a,b){var c=a.data;a="getVertexAttr"in c?c.getVertexAttr():"vertexAttr"in c?c.vertexAttr:null;if(!a)return null;var e=h.RibbonVertexAttributeConstants.POSITION,c="getVertexAttr"in c?c.indices:null;return Z.computeAttachmentOriginLines(a[e],c?c[e]:null,c&&N(this.params,a,c),b)};b.prototype.createLayout=function(){var a=Y.newLayout().vec3f(h.RibbonVertexAttributeConstants.POSITION).f32(h.RibbonVertexAttributeConstants.SUBDIVISIONFACTOR).vec2f(h.RibbonVertexAttributeConstants.UV0).vec3f(h.RibbonVertexAttributeConstants.AUXPOS1).vec3f(h.RibbonVertexAttributeConstants.AUXPOS2);
this.params.vvSizeEnabled?a.f32(h.RibbonVertexAttributeConstants.SIZEFEATUREATTRIBUTE):a.f32(h.RibbonVertexAttributeConstants.SIZE);this.params.vvColorEnabled?a.f32(h.RibbonVertexAttributeConstants.COLORFEATUREATTRIBUTE):a.vec4f(h.RibbonVertexAttributeConstants.COLOR);this.params.vvOpacityEnabled&&a.f32(h.RibbonVertexAttributeConstants.OPACITYFEATUREATTRIBUTE);return a};b.prototype.createBufferWriter=function(){return new ka(this.layout,this.params)};b.prototype.getGLMaterial=function(a){return 0===
a.output||4===a.output?new la(a):void 0};b.prototype.validateParams=function(){"miter"!==this.params.join&&(this.params.miterLimit=0)};return b}(ba.Material);var la=function(e){function b(a){a=e.call(this,a)||this;a.updateParameters();return a}I.__extends(b,e);b.prototype.updateParameters=function(){this.technique=this.techniqueRep.acquireAndReleaseExisting(ga.RibbonLineTechnique,this.material.getTechniqueConfig(this.output),this.technique)};b.prototype.beginSlot=function(a){return this.technique.configuration.occluder?
3===a||10===a||11===a:0===this.output?(this.targetSlot=this.technique.configuration.writeDepth?5:8,a===this.targetSlot):3===a};b.prototype._updateOccludeeState=function(a){a.hasOccludees!==this.material.getParameters().sceneHasOcludees&&(this.material.setParameterValues({sceneHasOcludees:a.hasOccludees}),this.updateParameters())};b.prototype.ensureParameters=function(a){0===this.output&&this._updateOccludeeState(a)};b.prototype.bind=function(a,b){a.bindProgram(this.technique.program);this.technique.bindPass(a,
this.material.getPassParameters(),b)};b.prototype.getPipelineState=function(a,b){return b?this.technique.occludeePipeline:this.technique.configuration.occluder?11===a?this.technique.occluderPipelineTransparent:10===a?this.technique.occluderPipelineOpaque:this.technique.occluderPipelineMaskWrite:this.technique.pipeline};return b}(aa.GLMaterial),ha=I.__assign({width:0,color:[1,1,1,1],join:"miter",cap:"butt",miterLimit:5,writeDepth:!0,polygonOffset:!1,stipplePattern:null,stippleIntegerRepeats:!1,stippleOffColor:null,
slicePlaneEnabled:!1,vvFastUpdate:!1,transparent:!1,isClosed:!1,falloff:0,innerWidth:0,innerColor:null,sceneHasOcludees:!1},da.Default),ka=function(){function d(b,a){this.params=a;this.numJoinSubdivisions=0;this.vertexBufferLayout=b;switch(this.params.join){case "miter":case "bevel":this.numJoinSubdivisions=a.stipplePattern?1:0;break;case "round":this.numJoinSubdivisions=ma}}d.prototype.isClosed=function(b){return N(this.params,b.vertexAttr,b.indices)};d.prototype.numCapSubdivisions=function(b){if(this.isClosed(b))return 0;
switch(this.params.cap){case "butt":return 0;case "square":return 1;case "round":return na}};d.prototype.allocate=function(b){return this.vertexBufferLayout.createBuffer(b)};d.prototype.elementCount=function(b){var a=2*this.numCapSubdivisions(b)+2,c=b.indices[h.RibbonVertexAttributeConstants.POSITION].length/2+1,e=this.isClosed(b),a=e?2:2*a,d=e?0:1,c=e?c:c-1;if(b.vertexAttr[h.RibbonVertexAttributeConstants.SUBDIVISIONS])for(b=b.vertexAttr[h.RibbonVertexAttributeConstants.SUBDIVISIONS].data;d<c;++d)a+=
4+2*b[d];else a+=(c-d)*(2*this.numJoinSubdivisions+4);return a+2};d.prototype.write=function(b,a,c,d){var l=this,g=oa,q=pa,k=qa,f=a.vertexAttr[h.RibbonVertexAttributeConstants.POSITION].data,m=a.indices&&a.indices[h.RibbonVertexAttributeConstants.POSITION],t=this.numCapSubdivisions(a);m&&m.length!==2*(f.length/3-1)&&console.warn("RibbonLineMaterial does not support indices");m=null;a.vertexAttr[h.RibbonVertexAttributeConstants.SUBDIVISIONS]&&(m=a.vertexAttr[h.RibbonVertexAttributeConstants.SUBDIVISIONS].data);
var r=1,u=0;this.params.vvSizeEnabled?u=a.vertexAttr[h.RibbonVertexAttributeConstants.SIZEFEATUREATTRIBUTE].data[0]:a.vertexAttr[h.RibbonVertexAttributeConstants.SIZE]&&(r=a.vertexAttr[h.RibbonVertexAttributeConstants.SIZE].data[0]);var v=[1,1,1,1],y=0;this.params.vvColorEnabled?y=a.vertexAttr[h.RibbonVertexAttributeConstants.COLORFEATUREATTRIBUTE].data[0]:a.vertexAttr[h.RibbonVertexAttributeConstants.COLOR]&&(v=a.vertexAttr[h.RibbonVertexAttributeConstants.COLOR].data);var C=0;this.params.vvOpacityEnabled&&
(C=a.vertexAttr[h.RibbonVertexAttributeConstants.OPACITYFEATUREATTRIBUTE].data[0]);var B=f.length/3;b=b.transformation;var p=new Float32Array(c.buffer);c=this.vertexBufferLayout.stride/4;var n=d*c;d=n;var x=function(a,b,c,d,e,f){p[n++]=b[0];p[n++]=b[1];p[n++]=b[2];p[n++]=d;p[n++]=e;p[n++]=f;p[n++]=a[0];p[n++]=a[1];p[n++]=a[2];p[n++]=c[0];p[n++]=c[1];p[n++]=c[2];l.params.vvSizeEnabled?p[n++]=u:p[n++]=r;l.params.vvColorEnabled?p[n++]=y:(p[n++]=v[0],p[n++]=v[1],p[n++]=v[2],p[n++]=v[3]);l.params.vvOpacityEnabled&&
(p[n++]=C)},n=n+c;e.vec3.set(q,f[0],f[1],f[2]);b&&e.vec3.transformMat4(q,q,b);if(a=this.isClosed(a)){var w=f.length-3;e.vec3.set(g,f[w],f[w+1],f[w+2]);b&&e.vec3.transformMat4(g,g,b)}else{e.vec3.copy(g,q);e.vec3.set(k,f[3],f[4],f[5]);b&&e.vec3.transformMat4(k,k,b);for(w=0;w<t;++w){var z=1-w/t;x(g,q,k,z,1,-4);x(g,q,k,z,1,4)}x(g,q,k,0,0,-4);x(g,q,k,0,0,4);e.vec3.copy(g,q);e.vec3.copy(q,k)}for(var G=a?B:B-1,w=a?0:1;w<G;w++){z=(w+1)%B*3;e.vec3.set(k,f[z+0],f[z+1],f[z+2]);b&&e.vec3.transformMat4(k,k,b);
x(g,q,k,0,1,-1);x(g,q,k,0,1,1);for(var D=m?m[w]:this.numJoinSubdivisions,F=0;F<D;++F)z=(F+1)/(D+1),x(g,q,k,z,1,-2),x(g,q,k,z,1,2);x(g,q,k,1,0,-2);x(g,q,k,1,0,2);e.vec3.copy(g,q);e.vec3.copy(q,k)}if(a)n=L(p,d+c,p,n,2*c);else for(x(g,q,k,0,1,-5),x(g,q,k,0,1,5),w=0;w<t;++w)z=(w+1)/t,x(g,q,k,z,1,-5),x(g,q,k,z,1,5);L(p,d+c,p,d,c);n=L(p,n-c,p,n,c)};return d}(),na=3,ma=1,t=l.vec3f64.create(),u=l.vec3f64.create(),v=l.vec3f64.create(),G=l.vec3f64.create(),ia=l.vec3f64.create(),C=D.createRenderScreenPointArray3(),
B=D.createRenderScreenPointArray3(),U=l.vec3f64.create(),V=l.vec3f64.create(),T=d.lineSegment.create(),ja=d.lineSegment.create(),oa=l.vec3f64.create(),pa=l.vec3f64.create(),qa=l.vec3f64.create(),F=[D.createRenderScreenPointArray3(),D.createRenderScreenPointArray3(),D.createRenderScreenPointArray3(),D.createRenderScreenPointArray3()],y=[l.vec3f64.create(),l.vec3f64.create(),l.vec3f64.create(),l.vec3f64.create()],O=d.plane.create(),P=d.plane.create(),Q=d.plane.create(),R=d.plane.create();return S});