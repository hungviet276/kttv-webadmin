// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.17/esri/copyright.txt for details.
//>>built
define("require exports ../../../core/mathUtils ../../../core/maybe ../../../core/libs/gl-matrix-2/vec3 ../../../core/libs/gl-matrix-2/vec3f64 ../../../core/libs/gl-matrix-2/vec4 ../../../core/libs/gl-matrix-2/vec4f64 ../../../geometry/support/aaBoundingBox ../../../geometry/support/geodesicConstants ../support/buffer/BufferPool ../support/buffer/InterleavedLayout ./ElevationData ./TerrainConst ../webgl-engine/lib/Util ../webgl-engine/materials/internal/MaterialUtil".split(" "),function(U,y,ha,ia,
P,V,W,ja,Q,N,ka,la,X,M,Y,ma){function Z(b,c,k,e){var aa=0<(k&2),G=c+(e?1024:0)+(aa?2048:0),n=R.get(G);if(!n){var n=c-1,z=c-1,w=c*c,a=2*n+2*z,r=n*z*6,t=6*a,A=6*(2*n+z-1);e&&(r*=2,t*=2,A*=2);for(var a=65536<w+a?new Uint32Array(r+t):new Uint16Array(r+t),q=0,u=0,g=r,v,l,f,p,m=0,h=0;h<=z;h++){aa&&(m=0===h?A:h===z?-A:0);for(var g=g+m,d=0;d<=n;d++)f=S(d,h,n,z),-1<f&&(p=0===h&&d!==n?1:d===n&&h!==z?n+1:h===z&&0!==d?-1:0===d&&0!==h?-(n+1):0,0!==p&&(v=q,l=w+f,f=w+(0===d&&1===h?0:f+1),p=q+p,e?(a[g+0]=v,a[g+1]=
l,a[g+2]=l,a[g+3]=f,a[g+4]=f,a[g+5]=v,a[g+6]=f,a[g+7]=p,a[g+8]=p,a[g+9]=v,a[g+10]=v,a[g+11]=f,g+=12):(a[g+0]=v,a[g+1]=l,a[g+2]=f,a[g+3]=f,a[g+4]=p,a[g+5]=v,g+=6))),++q,d<n&&h<z&&(v=h*(n+1)+d,l=v+1,f=l+(n+1),p=f-1,e?(a[u+0]=v,a[u+1]=l,a[u+2]=l,a[u+3]=f,a[u+4]=f,a[u+5]=v,a[u+6]=f,a[u+7]=p,a[u+8]=p,a[u+9]=v,a[u+10]=v,a[u+11]=f,u+=12):(a[u+0]=v,a[u+1]=l,a[u+2]=f,a[u+3]=f,a[u+4]=p,a[u+5]=v,u+=6));g-=m}n=new na(a,r,t);R.set(G,n)}b.indices=n.values;b.numSurfaceIndices=n.numSurfaceIndices;b.numSkirtIndices=
n.numSkirtIndices;b.numWithoutSkirtIndices=b.numSurfaceIndices+(k?6*(c-1)*(e?2:1):0)}function T(b,c,k,e){b<e[0]&&(e[0]=b);b>e[3]&&(e[3]=b);c<e[1]&&(e[1]=c);c>e[4]&&(e[4]=c);k<e[2]&&(e[2]=k);k>e[5]&&(e[5]=k)}function ba(b,c){var k=c>b?1:0;return 2+4*k+(1-2*k)*(b+c)}function S(b,c,k,e){return 0===c?b:b===k?k+c:c===e?k+e+(k-b):0===b&&0<c?2*k+e+(e-c):-1}Object.defineProperty(y,"__esModule",{value:!0});y.intersectSkirts=y.createPlanarGlobePatch=y.createSphericalGlobePatch=y.releaseGeometry=y.clearCaches=
y.PatchGeometry=void 0;var oa=la.newLayout().vec3f(Y.VertexAttrConstants.POSITION).vec2f(Y.VertexAttrConstants.UV0),O=new ka.BufferPool(function(b){return oa.createBuffer(b)},function(b){return b.count});U=function(){return function(){this.vertexAttributes=this.indices=null;this.boundingBox=Q.empty();this.skirtLength=this.numVertsPerRow=this.numWithoutSkirtIndices=this.numSkirtIndices=this.numSurfaceIndices=0;this.uvOffsetAndScale=ja.vec4f64.create()}}();y.PatchGeometry=U;var na=function(){return function(b,
c,k){this.values=b;this.numSurfaceIndices=c;this.numSkirtIndices=k}}();y.clearCaches=function(){O.clear();R.clear()};y.releaseGeometry=function(b){O.release(b.vertexAttributes);b.vertexAttributes=null;b.indices=null};y.createSphericalGlobePatch=function(b,c,k,e,q,G,n){var z=q[0],w=q[1],a=q[2];q=q[3];var r=.1*N.earthRadius*(q-w),t=b.numVertsPerRow-1,A=b.numVertsPerRow-1,y=b.numVertsPerRow*b.numVertsPerRow,u=O.acquire(y+(2*t+2*A)),g=u.position.typedBuffer,v=u.uv0.typedBuffer,l=e.geometryInfo.boundingBox;
Q.empty(l);var f=c[2]-c[0],p=c[3]-c[1],m=a-z,a=k[0],h=k[1];k=k[2];for(var d=0;d<=t;d++){var D=d/t,B=z+D*m;ca[d]=Math.sin(B);da[d]=Math.cos(B);ea[d]=D;fa[d]=c[0]+D*f}z=G&&!!(n&1);f=G&&!!(n&2);for(B=m=0;B<=A;B++){var E=B/A,d=ha.lerp(w,q,E),I=Math.cos(d),K=Math.sin(d),J=void 0;G?(J=N.halfEarthRadius*Math.log((1+K)/(1-K)),E=(J-c[1])/p):J=180*d/Math.PI;for(d=0;d<=t;d++){var D=ea[d],x=ca[d],L=da[d],H=N.earthRadius;b.samplerData&&(H+=X.ElevationData.sample(fa[d],J,b.samplerData)||0);L=L*I*H-a;x=x*I*H-h;
H=K*H-k;T(L,x,H,l);var F=M.GEOMETRY_VERTEX_STRIDE*m;g[F+0]=L;g[F+1]=x;g[F+2]=H;v[F+0]=D;v[F+1]=E;F=S(d,B,t,A);if(-1<F){var F=M.GEOMETRY_VERTEX_STRIDE*(y+F),C=z&&0===B?-1:f&&B===A?1:0,L=0===C?L:-a,x=0===C?x:-h,H=0===C?H:N.earthRadius*C-k;g[F+0]=L;g[F+1]=x;g[F+2]=H;v[F+0]=0===C?ba(D,E):D;v[F+1]=0===C?r:E;0!==C&&T(L,x,H,l)}++m}}e.geometryInfo.numVertsPerRow=b.numVertsPerRow;e.geometryInfo.vertexAttributes=u;e.geometryInfo.skirtLength=r;W.vec4.set(e.geometryInfo.uvOffsetAndScale,0,0,1,1);Z(e.geometryInfo,
b.numVertsPerRow,G?n:0,b.wireframe)};y.createPlanarGlobePatch=function(b,c,k,e){var q=c[0],G=c[1],n=c[2]-q,z=c[3]-G,w=b.clippingArea,a=w?Math.max(0,(w[0]-c[0])/n):0,r=w?Math.max(0,(w[1]-c[1])/z):0,t=w?Math.min(1,(w[2]-c[0])/n):1;c=w?Math.min(1,(w[3]-c[1])/z):1;var A=t>a?1/(t-a):1,y=c>r?1/(c-r):1,u=-a*A,g=-r*y,v=.1*n,l=b.numVertsPerRow-1,f=b.numVertsPerRow-1,p=b.numVertsPerRow*b.numVertsPerRow,m=O.acquire(p+(2*l+2*f)),h=m.position.typedBuffer,d=m.uv0.typedBuffer,D=e.geometryInfo.boundingBox;Q.empty(D);
for(var B=0,E=0;E<=f;E++){var I=E/f,K=g+I*y,I=G+I*z;w&&(I<w[1]?(I=w[1],K=0):I>w[3]&&(I=w[3],K=1));for(var J=0;J<=l;J++){var x=J/l,L=u+x*A,x=q+x*n;w&&(x<w[0]?(x=w[0],L=0):x>w[2]&&(x=w[2],L=1));var H=b.samplerData?X.ElevationData.sample(x,I,b.samplerData)||0:0,x=x-k[0],F=I-k[1],H=H-k[2];T(x,F,H,D);var C=M.GEOMETRY_VERTEX_STRIDE*B;h[C+0]=x;h[C+1]=F;h[C+2]=H;d[C+0]=L;d[C+1]=K;C=S(J,E,l,l);-1<C&&(C=M.GEOMETRY_VERTEX_STRIDE*(p+C),h[C+0]=x,h[C+1]=F,h[C+2]=H,d[C+0]=ba(L,K),d[C+1]=v);++B}}e.geometryInfo.numVertsPerRow=
b.numVertsPerRow;e.geometryInfo.vertexAttributes=m;e.geometryInfo.skirtLength=v;W.vec4.set(e.geometryInfo.uvOffsetAndScale,a,r,t-a,c-r);Z(e.geometryInfo,b.numVertsPerRow,0,b.wireframe)};var R=new Map,ga=Math.pow(2,-52);y.intersectSkirts=function(b,c,k,e,y,G,n,z,w){var a,r,t,A=G.position;G=G.uv0;var M=b[0],u=b[1];b=b[2];var g=c[0]-M,v=c[1]-u;c=c[2]-b;e*=3;for(k*=3;k<e;k+=3){var l=y[k],f=y[k+1],p=y[k+2],m=A.get(l,0),h=A.get(l,1);a=A.get(l,2);var d=A.get(f,0),D=A.get(f,1);r=A.get(f,2);var B=A.get(p,
0),E=A.get(p,1);t=A.get(p,2);l=G.get(l,0);f=G.get(f,0);p=G.get(p,0);2<=l&&(P.vec3.set(q,m,h,a),n(q),m+=q[0],h+=q[1],a+=q[2]);2<=f&&(P.vec3.set(q,d,D,r),n(q),d+=q[0],D+=q[1],r+=q[2]);2<=p&&(P.vec3.set(q,B,E,t),n(q),B+=q[0],E+=q[1],t+=q[2]);ia.isSome(z)&&(a=z.applyToVertex(m,h,a),m=a[0],h=a[1],a=a[2],r=z.applyToVertex(d,D,r),d=r[0],D=r[1],r=r[2],t=z.applyToVertex(B,E,t),B=t[0],E=t[1],t=t[2]);d-=m;D-=h;r-=a;B-=m;E-=h;t-=a;var l=v*t-E*c,f=c*B-t*g,I=g*E-B*v,p=d*l+D*f+r*I,m=M-m,K=u-h,J=b-a,h=K*r-D*J;a=
J*d-r*m;var x=m*D-d*K;if(p>ga){m=m*l+K*f+J*I;if(0>m||m>p)continue;l=g*h+v*a+c*x;if(0>l||m+l>p)continue}else if(p<-ga){m=m*l+K*f+J*I;if(0<m||m<p)continue;l=g*h+v*a+c*x;if(0<l||m+l<p)continue}else continue;h=(B*h+E*a+t*x)/p;0<=h&&(a=ma.computeNormal(d,D,r,B,E,t,pa),w(h,a))}};var ca=Array(M.MAX_PATCH_TESSELATION+1),da=Array(M.MAX_PATCH_TESSELATION+1),ea=Array(M.MAX_PATCH_TESSELATION+1),fa=Array(M.MAX_PATCH_TESSELATION+1),q=V.vec3f64.create(),pa=V.vec3f64.create()});