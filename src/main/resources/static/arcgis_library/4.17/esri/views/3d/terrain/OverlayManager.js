// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.17/esri/copyright.txt for details.
//>>built
define("require exports tslib ../../../core/Accessor ../../../core/Handles ../../../core/has ../../../core/mathUtils ../../../core/mathUtils ../../../core/maybe ../../../core/scheduling ../../../core/unitUtils ../../../core/accessorSupport/decorators ../../../core/libs/gl-matrix-2/vec2 ../../../core/libs/gl-matrix-2/vec3 ../../../core/libs/gl-matrix-2/vec3f64 ../../../core/libs/gl-matrix-2/vec4 ../../../core/libs/gl-matrix-2/vec4f64 ../../../geometry/support/aaBoundingRect ../../../geometry/support/geodesicConstants ../../../layers/support/timeUtils ../state/utils/viewUtils ../support/animationUtils ../support/debugFlags ../support/debugUtils ../support/geometryUtils ../support/mathUtils ../support/projectionUtils ./Overlay ./OverlayRenderer ../webgl-engine/lib/Intersector ../webgl-engine/lib/localOrigin ../webgl-engine/parts/requireUtils ../../support/Scheduler".split(" "),
function(E,p,k,K,L,M,u,N,y,O,F,m,P,r,z,w,G,f,A,Q,R,S,B,T,U,H,C,I,V,W,X,Y,Z){function aa(f,c){for(var a=B.TESTS_DISABLE_UPDATE_THRESHOLDS?0:1E-5*Math.max(f[2]-f[0],f[3]-f[1],c[2]-c[0],c[3]-c[1]),b=0;4>b;b++)if(Math.abs(c[b]-f[b])>a)return!0;return!1}Object.defineProperty(p,"__esModule",{value:!0});p.OverlayManager=void 0;var ba=[[-.1,-2,3.9,2],[-.1,-3.9,3.9,.1],[-2,-3.9,2,.1],[-3.9,-3.9,.1,.1],[-3.9,-2,.1,2],[-3.9,-.1,.1,3.9],[-2,-.1,2,3.9],[-.1,-.1,3.9,3.9]],t;E=function(p){function c(){var a=null!==
p&&p.apply(this,arguments)||this;a._handles=new L;a._overlaySR=null;a._renderSR=null;a._overlaySREqualsRenderSR=!0;a._drapeSources=new Map;a._drapeTargets=new Set;a._overlays=null;a._drapeSourceTypes=[0,0];a._drapeTargetTypes=[0,0];a._renderedAltitude=0;a._placementDirty=!1;a._drawTexturesDirty=!1;a._drawTexturesAnimateDirty=!1;a._layerViewsDirty=!0;a._hasUnusedRenderTargets=!1;a._isSpherical=!1;a._longitudeCyclical=null;a._latestOriginId=0;a._maxResolution=M("esri-mobile")?2048:4096;a._animationTimeLast=
0;a._forceAnimation=!1;return a}k.__extends(c,p);Object.defineProperty(c.prototype,"updating",{get:function(){return this.needsUpdate()||this.renderer.updating},enumerable:!1,configurable:!0});Object.defineProperty(c.prototype,"hasHighlights",{get:function(){return this.renderer.hasHighlights},enumerable:!1,configurable:!0});Object.defineProperty(c.prototype,"rendersOccluded",{get:function(){return this.renderer.rendersOccluded},enumerable:!1,configurable:!0});c.prototype.initialize=function(){var a=
this;this._stage=this.view._stage;this.renderer=new V.OverlayRenderer({renderView:this._stage.renderView,globalUnitScale:this.view.state.isGlobal?F.getMetersPerUnitForSR(this._overlaySR):1});this._drapeTargetTypes[0]++;this.renderer.onHasHighlightsChanged=function(){a.setDrawTexturesDirty();a.notifyChange("hasHighlights")};this.renderer.onRendersOccludedChanged=function(){a.setDrawTexturesDirty();a.notifyChange("rendersOccluded")};this.renderer.onContentChanged=function(){a.setDrawTexturesDirty()};
this.groundIntersector=new W.Intersector(this.view.state.mode);this.groundIntersector.options.backfacesTerrain=!0;this.groundIntersector.options.invisibleTerrain=!0;this.groundIntersector.options.hud=!1;this._handles.add([this.view.watch(["pointsOfInterest.renderPointOfView","pointsOfInterest.centerOnSurfaceFrequent.location","pixelRatio"],function(){return a.setOverlayPlacementDirty()}),this.terrainSurface.on("elevation-change",function(){return a.setOverlayPlacementDirty()}),this.view.allLayerViews.on("after-changes",
function(){return a._layerViewsDirty=!0}),this.view.on("resize",function(){return a.setOverlayPlacementDirty()}),O.addFrameTask({preRender:function(b){a.renderer.commitChanges();a._updateLayerViews();a.hasOverlays()&&(a._dispatchRendererUpdate(b),a._drawOverlayTextures());a._hasUnusedRenderTargets&&a._collectUnusedRenderTargetMemory()}}),this.view.resourceController.scheduler.registerTask(Z.Task.OVERLAY_MANAGER,function(){return a.updateOverlays()},function(){return a.needsUpdate()}),this.view._stage.renderView.events.on("force-camera-for-screenshot",
function(b){a.updateOverlays(b);a._drawOverlayTextures()})]);this._updateLayerViews()};c.prototype.destroy=function(){var a=this;this._drapeSources.forEach(function(b,d){return a._unregisterDrapeSource(d)});this._drapeTargets.forEach(function(b,d){return a._unregisterDrapeTarget(d)});this._drapeTargetTypes[0]--;this._disposeOverlays();this.renderer.dispose();this._handles&&(this._handles.destroy(),this._handles=null);y.isSome(t)&&(t.remove(),t=null)};c.prototype.hasOverlays=function(){return!!this._overlays};
c.prototype.setSpatialReference=function(a,b){this._overlaySR=a;this._longitudeCyclical=null;if(a){this._renderSR=this.view.renderSpatialReference;this._overlaySREqualsRenderSR=this._overlaySR.equals(this._renderSR);if(this._isSpherical=b)this._longitudeCyclical=a.isWebMercator?new H.Cyclical(-2.0037508342787E7,2.0037508342787E7):new H.Cyclical(-180,180),this.renderer.longitudeCyclical=this._longitudeCyclical;this.renderer&&(this.renderer.globalUnitScale=b?F.getMetersPerUnitForSR(this._overlaySR):
1)}else this._disposeOverlays();this.notifyChange("updating")};c.prototype.getGpuMemoryUsage=function(){return this._overlays[0].getGpuMemoryUsage()+this._overlays[1].getGpuMemoryUsage()};c.prototype._updateLayerViews=function(){var a=this;if(this._layerViewsDirty){for(var b=new Set,d=0,h=this.view.allLayerViews.items;d<h.length;d++){var e=h[d];b.add(e.uid);"drapeSourceType"in e&&!this._drapeSources.has(e)&&this._registerDrapeSource(e);"drapeTargetType"in e&&!this._drapeTargets.has(e)&&this._registerDrapeTarget(e)}this._drapeSources.forEach(function(d,
h){b.has(h.uid)||a._unregisterDrapeSource(h)});this._drapeTargets.forEach(function(d){b.has(d.uid)||a._unregisterDrapeTarget(d)});this.renderer.updateLayerOrder();this.setDrawTexturesDirty();this._layerViewsDirty=!1}};c.prototype._registerDrapeSource=function(a){var b=this,d=a.on("draped-data-change",function(){return b.setOverlayContentDirty()});this._drapeSourceTypes[a.drapeSourceType]++;this._drapeSources.set(a,[d]);this._overlays&&a.setDrapingExtent&&this._overlays.forEach(function(d,e){return b._updateDrapeSource(a,
e,d)});this.setOverlayContentDirty()};c.prototype._updateDrapeSource=function(a,b,d){a.setDrapingExtent&&a.setDrapingExtent(b,d.extent,this._overlaySR,d.resolution,d.renderLocalOrigin,d.pixelRatio)};c.prototype._unregisterDrapeSource=function(a){if(this._drapeSources.has(a)){var b=this._drapeSources.get(a);b&&b.forEach(function(a){return a.remove()});this._drapeSourceTypes[a.drapeSourceType]--;this._drapeSources.delete(a);this.setOverlayContentDirty()}};c.prototype._registerDrapeTarget=function(a){this._drapeTargets.add(a);
this._updateDrapeTarget(a);this._drapeTargetTypes[a.drapeTargetType]++};c.prototype._updateDrapeTarget=function(a){var b=this;this._overlays&&this._overlays.forEach(function(d,h){var e=d.renderTargets,c=b.needsColorWithoutRasterImage()?e.colorWithoutRasterImage:b.hasDrapedFeatures()?e.color:null,f=e.highlight,e=e.water;a.setDrapingTextures(h,d.extent,c&&c.valid?c.fbo.getTexture():null,f.valid?f.fbo.getTexture():null,e.valid?e.fbo.getTexture():null)})};c.prototype._unregisterDrapeTarget=function(a){this._drapeTargets.delete(a);
this._drapeTargetTypes[a.drapeTargetType]--};c.prototype.setOverlayContentDirty=function(){this.setOverlayPlacementDirty();this.setDrawTexturesDirty()};c.prototype.setOverlayPlacementDirty=function(){this._placementDirty=!0;this.notifyChange("updating")};c.prototype.updateOverlays=function(a){void 0===a&&(a=this.view.state.camera);if(this._overlaySR){this._updateLayerViews();var b;b=u.nextHighestPowerOfTwo(Math.max(a.fullWidth,a.fullHeight)+256);var d=Math.min(b,this._maxResolution);this._computeOverlayExtents(a,
b,x);b=f.width(x.inner)/f.width(x.outer);this._overlays||(this._overlays=[new I.Overlay(this._stage.renderView.renderingContext,0),new I.Overlay(this._stage.renderView.renderingContext,1)]);a=this._updateOverlay(0,x.inner,d,1);d=this._updateOverlay(1,x.outer,d,b);if(a||d)this.terrainSurface.updateTileOverlayParams(),this.setDrawTexturesDirty();this._placementDirty=!1;this.terrainSurface.updateOverlayOpacity();this.notifyChange("updating")}};c.prototype._updateOverlay=function(a,b,d,h){var c=this,
g=this._overlays[a];if(!aa(b,g.extent)&&d===g.resolution&&g.pixelRatio===h)return!1;f.set(g.extent,b);g.resolution=d;g.pixelRatio=h;b=f.center(g.extent);g.renderLocalOrigin=X.fromValues(b[0],b[1],0,"OV_"+this._latestOriginId++);this._drapeSources.forEach(function(b,d){return c._updateDrapeSource(d,a,g)});return!0};c.prototype.needsUpdate=function(){return(this._placementDirty||this._layerViewsDirty)&&(0<this._drapeSources.size||0<this.view.graphics.length||B.OVERLAY_DRAW_DEBUG_TEXTURE)&&!!this._overlaySR&&
!this._get("suspended")&&this.terrainSurface.ready};c.prototype.updateOpacity=function(a){return this._overlays?this._getAltitudeBasedOpacity(a,this._renderedAltitude):1};c.prototype._getAltitudeBasedOpacity=function(a,b){return 3.5*a<b?Math.sqrt(u.clamp((a-b/10)/(b/3.5-b/10),0,1)):1};c.prototype.setTileParameters=function(a,b,d){if(this._overlays){var h=this._overlays[0],c=this._overlays[1];a=f.intersection(a.extent,a.surface.extent,J);this._rectInsideRect(a,h.extent)?(this._setTileOverlayData(a,
h,b.overlays[0]),b.overlays[1].overlay=null):this._rectanglesOverlap(a,h.extent)?(this._setTileOverlayData(a,h,b.overlays[0]),this._setTileOverlayData(a,c,b.overlays[1])):(this._rectanglesOverlap(a,c.extent)?this._setTileOverlayData(a,c,b.overlays[0]):b.overlays[0].overlay=null,b.overlays[1].overlay=null)}else b.overlays[0].overlay=null,b.overlays[1].overlay=null;b.overlayOpacity=void 0!==d?d:1};c.prototype.overlayPixelSizeInMapUnits=function(a){if(!this._overlays)return 0;var b=this._overlays[0],
d=this._overlays[1];a=this._pointIsInExtent(a,b.extent)?b:d;return(a.extent[2]-a.extent[0])/a.resolution};c.prototype._setTileOverlayData=function(a,b,d){var h=b.extent;d.texScale[0]=(a[2]-a[0])/(h[2]-h[0]);d.texScale[1]=(a[3]-a[1])/(h[3]-h[1]);var c=a[0];if(this._longitudeCyclical){var c=this._longitudeCyclical.minimalMonotonic(h[0],c),g=this._longitudeCyclical.minimalMonotonic(h[0],a[2]);c>g&&(c=g-(a[2]-a[0]))}d.texOffset[0]=(c-h[0])/(h[2]-h[0]);d.texOffset[1]=(a[1]-h[1])/(h[3]-h[1]);d.overlay=
b};c.prototype._disposeOverlays=function(){this._overlays&&(this._overlays.forEach(function(a){return a.dispose()}),this._overlays=null)};c.prototype.hotReloadShaders=function(){return k.__awaiter(this,void 0,void 0,function(){return k.__generator(this,function(a){switch(a.label){case 0:return Y.removeLoadedShaderModules(),[4,this.renderer.hotReloadShaders()];case 1:return a.sent(),this.updateOverlays(),this.needsUpdate(),[2]}})})};c.prototype.stopAnimationsAtTime=function(a){this.renderer.stopAnimationsAtTime(a);
this._forceAnimation=!0};c.prototype._dispatchRendererUpdate=function(a){var b=Q.Milliseconds(a.time-this._animationTimeLast);b<S.DESIRED_DRAPED_ANIMATION_MS&&!this._forceAnimation||(this._animationTimeLast=a.time,this.renderer.updateLogic({dt:b,camera:this._stage.getCamera()})&&(this._drawTexturesAnimateDirty=!0))};c.prototype.setDrawTexturesDirty=function(){this._overlays?this._drawTexturesDirty=!0:this.setOverlayPlacementDirty()};c.prototype._intersectGroundFromView=function(a,b,d,c){d=this.view.sceneIntersectionHelper.getCenterRayWithSubpixelOffset(a,
ca,b,d);b=d.origin;d=r.vec3.add(D,d.origin,d.direction);this.groundIntersector.reset(b,d);this.groundIntersector.intersect([],null,a);this.view.basemapTerrain.intersect(this.groundIntersector,null,b,d);return this.groundIntersector.results.min.getIntersectionPoint(c)};c.prototype._findHorizonBasedPointOfInterest=function(a,b,d){var c=.5,e=this.view.renderCoordsHelper.getAltitude(b),g=this.view.renderCoordsHelper.getAltitude(a.eye),f=g>e;"global"===this.view.viewingMode?(c=z.vec3f64.clone(a.eye),r.vec3.normalize(c,
c),r.vec3.negate(c,c),e=u.asinClamped((A.earthRadius+e)/(A.earthRadius+e+Math.abs(g-e))),g=u.acosClamped(Math.abs(r.vec3.dot(a.viewForward,c))),c=u.clamp((e-(g-.5*a.fovY))/a.fovY,0,1),e=u.clamp((-e-(g-.5*a.fovY))/a.fovY,0,1),c=1===c&&0===e?.5:e+.55*(c-e),f||(c=1-c)):(c=G.vec4f64.fromValues(0,Math.tan(.5*Math.PI-Math.acos(-a.viewForward[2])),1,0),c=w.vec4.transformMat4(c,c,a.projectionMatrix)[1],c=u.clamp(.5+.5*c,0,1),c=1===c||0===c?.5:f?.55*c:1-.55*(1-c));return this._intersectGroundFromView(a,.5,
c,d)?r.vec3.sqrDist(d,a.eye)<r.vec3.sqrDist(b,a.eye):!1};c.prototype._computeOverlayExtents=function(a,b,d){var c=this.terrainSurface.extent,e=this.view.pointsOfInterest.centerOnSurfaceFrequent.renderLocation,g=z.vec3f64.create();this._findHorizonBasedPointOfInterest(a,e,g)||r.vec3.copy(g,e);this._renderedAltitude=this.view.renderCoordsHelper.getAltitude(a.eye);var l=r.vec3.distance(a.eye,g),e=R.viewAngle(this.view.renderCoordsHelper,e,a.eye),e=Math.PI/2-Math.abs(e-Math.PI/2);B.OVERLAY_SHOW_CENTER?
(y.isNone(t)&&(t=new T.GraphicsHandle(this.view.graphics,"red")),t.showPoint(g,this._renderSR)):y.isSome(t)&&t.remove();this._overlaySREqualsRenderSR||C.vectorToVector(g,this._renderSR,g,this._overlaySR);var l=b*a.perRenderPixelRatio*l/2,n=!1,k=Infinity;this._isSpherical&&(this._overlaySR.isWebMercator?(l/=Math.cos(C.webMercator.y2lat(g[1])),k=this.terrainSurface.extent[3]):(n=!0,l/=A.metersPerDegree,k=90),l>=k&&(l=k,g[1]=0,this._overlaySR.isWebMercator&&(g[0]=0)));var m=1;n&&(m=1/Math.max(.2,Math.cos(Math.abs(N.deg2rad(g[1])))),
180<l*m&&(m=180/l));var n=Math.log(2)/12,l=Math.exp(Math.round(Math.log(l)/n)*n),n=l*m,p=.5*b/(32*n);b=.5*b/(32*l);g[0]=Math.round(g[0]*p)/p;g[1]=Math.round(g[1]*b)/b;b=d.inner;b[0]=g[0]-n;b[1]=g[1]-l;b[2]=g[0]+n;b[3]=g[1]+l;this._isSpherical&&this._shiftExtentToFitBounds(b,Infinity,k);d=d.outer;f.set(d,b);6*n>c[2]-c[0]?f.set(d,c):e<=.25*Math.PI?(d[0]-=n,d[1]-=l,d[2]+=n,d[3]+=l):(C.vectorToVector(a.eye,this._renderSR,D,this._overlaySR),P.vec2.subtract(q,g,D),a=-Math.atan2(q[1],q[0])+.125*Math.PI,
0>a&&(a+=2*Math.PI),w.vec4.scale(q,ba[Math.floor(a/(.25*Math.PI))],2*l),q[0]*=m,q[2]*=m,w.vec4.add(d,d,q));this._isSpherical&&(d[0]=this._longitudeCyclical.clamp(d[0]),d[2]=this._longitudeCyclical.clamp(d[2]),d[1]=Math.max(d[1],-k),d[3]=Math.min(d[3],k));!this._isSpherical&&c&&(a=f.intersection(b,c,J),c=f.intersection(d,c,da),f.contains(a,c)&&(d[2]=d[0],d[3]=d[1]))};c.prototype._drawOverlayTextures=function(){var a=this;if(this._drawTexturesDirty||this._drawTexturesAnimateDirty){var b=this._drawOverlay(0),
c=this._drawOverlay(1);0!==b&&0!==c||this.terrainSurface.updateTileOverlayParams();this._collectUnusedRenderTargetMemory();this._drapeTargets.forEach(function(b){return a._updateDrapeTarget(b)});this._drawTexturesDirty?(this._drawTexturesAnimateDirty=this._drawTexturesDirty=!1,this.terrainSurface.requestRender(),this.terrainSurface.pendingUpdates=!0):(this._drawTexturesAnimateDirty=!1,this.terrainSurface.requestRender(0))}};c.prototype._setupGeometryViewsCyclical=function(a,b,c){this._setupGeometryViewsDirect(a,
b,c);var d=.001*this._longitudeCyclical.range;if(b[0]-d<=this._longitudeCyclical.min){var e=a.views[a.numViews++];w.vec4.set(e.viewport,0,0,c,c);f.offset(b,this._longitudeCyclical.range,0,e.extent)}b[2]+d>=this._longitudeCyclical.max&&(e=a.views[a.numViews++],w.vec4.set(e.viewport,0,0,c,c),f.offset(b,-this._longitudeCyclical.range,0,e.extent))};c.prototype._setupGeometryViewsDirect=function(a,b,c){a.numViews=1;a=a.views[0];f.set(a.extent,b);w.vec4.set(a.viewport,0,0,c,c)};c.prototype._drawOverlay=
function(a){var b=this._overlays[a],c=b.computeRenderTargetValidityBitfield(),f=b.extent,e=b.resolution,g=b.pixelRatio;this._longitudeCyclical?this._setupGeometryViewsCyclical(v,f,e):this._setupGeometryViewsDirect(v,f,e);v.width=e;v.height=e;v.pixelRatio=g*this.view.state.camera.pixelRatio;v.index=a;b.drawRenderTargets(this.renderer,v,this.needsColorWithoutRasterImage());a=b.computeRenderTargetValidityBitfield();return c^a?0:1};c.prototype.needsColorWithoutRasterImage=function(){return 0<this._drapeSourceTypes[0]&&
0<this._drapeSourceTypes[1]&&0<this._drapeTargetTypes[1]};c.prototype.hasDrapedFeatures=function(){return 0<this._drapeSourceTypes[1]};c.prototype._collectUnusedRenderTargetMemory=function(){var a=performance.now();this._hasUnusedRenderTargets=!1;for(var b=0,c=this._overlays;b<c.length;b++)this._hasUnusedRenderTargets=c[b].collectUnusedMemory(a)||this._hasUnusedRenderTargets};c.prototype._rectanglesOverlap=function(a,b){return this._longitudeCyclical?(this._longitudeCyclical.contains(b[0],b[2],a[0])||
this._longitudeCyclical.contains(b[0],b[2],a[2])||this._longitudeCyclical.contains(a[0],a[2],b[0]))&&!(a[1]>b[3]||a[3]<b[1]):f.intersects(a,b)};c.prototype._rectInsideRect=function(a,b){return this._longitudeCyclical?this._longitudeCyclical.contains(b[0],b[2],a[0])&&this._longitudeCyclical.contains(b[0],b[2],a[2])&&a[1]>b[1]&&a[3]<b[3]:f.contains(b,a)};c.prototype._pointIsInExtent=function(a,b){if(this._longitudeCyclical)return this._longitudeCyclical.contains(b[0],b[2],a.x)&&a.y>=b[1]&&a.y<=b[3];
var c=a.x;a=a.y;return c>b[0]&&c<b[2]&&a>b[1]&&a<b[3]};c.prototype._shiftExtentToFitBounds=function(a,b,c){var d=0,e=0;a[0]<-b?d=a[0]+b:a[2]>b&&(d=b-a[2]);a[1]<-c?e=a[1]+c:a[3]>c&&(e=c-a[3]);f.offset(a,d,e)};Object.defineProperty(c.prototype,"test",{get:function(){return{overlays:this._overlays,renderer:this.renderer}},enumerable:!1,configurable:!0});k.__decorate([m.property()],c.prototype,"renderer",void 0);k.__decorate([m.property()],c.prototype,"view",void 0);k.__decorate([m.property()],c.prototype,
"terrainSurface",void 0);k.__decorate([m.property({readOnly:!0,aliasOf:"terrainSurface.suspended"})],c.prototype,"suspended",void 0);k.__decorate([m.property({readOnly:!0,dependsOn:["terrainSurface.ready","suspended","renderer.updating"]})],c.prototype,"updating",null);k.__decorate([m.property({type:Boolean})],c.prototype,"hasHighlights",null);k.__decorate([m.property({type:Boolean})],c.prototype,"rendersOccluded",null);return c=k.__decorate([m.subclass("esri.views.3d.terrain.OverlayManager")],c)}(K);
p.OverlayManager=E;var v={width:0,height:0,pixelRatio:0,views:[{viewport:f.create(),extent:f.create()},{viewport:f.create(),extent:f.create()},{viewport:f.create(),extent:f.create()}],numViews:0,index:0},q=G.vec4f64.create(),D=z.vec3f64.create(),x={inner:f.create(),outer:f.create()},J=f.create(),da=f.create(),ca=U.ray.create()});