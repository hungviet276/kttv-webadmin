// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.17/esri/copyright.txt for details.
//>>built
define(["require","exports","../../../../../../core/screenUtils","../../../../../webgl","../../VertexStream"],function(n,m,t,h,v){Object.defineProperty(m,"__esModule",{value:!0});m.DropShadow=void 0;var w=[1,0],x=[0,1];n=function(){function f(){this._verticalBlurFBO=this._horizontalBlurFBO=null;this._size=[0,0];this._programDesc={blur:{vsPath:"post-processing/drop-shadow",fsPath:"post-processing/blur/gaussianBlur",attributes:{a_position:0}},composite:{vsPath:"post-processing/pp",fsPath:"post-processing/drop-shadow/composite",
attributes:{a_position:0}},blit:{vsPath:"post-processing/pp",fsPath:"post-processing/blit",attributes:{a_position:0}}}}f.prototype.dispose=function(){this._layerFBOTexture&&(this._layerFBOTexture.dispose(),this._layerFBOTexture=null);this._horizontalBlurFBO&&(this._horizontalBlurFBO.dispose(),this._horizontalBlurFBO=null);this._verticalBlurFBO&&(this._verticalBlurFBO.dispose(),this._verticalBlurFBO=null)};f.prototype.draw=function(b,c,d){var a=b.context,q=b.state,k=b.pixelRatio,g=q.size,f=b.painter.materialManager,
m=this._programDesc,h=Math.round(k*g[0]),r=Math.round(k*g[1]),p=[Math.round(h/2),Math.round(r/2)],n=d.blurRadius,l=d.offsetY,g=d.color,y=[k*t.pt2px(d.offsetX/2),k*t.pt2px(l/2)];this._createOrResizeResources(b,p);var u=this._horizontalBlurFBO;d=this._verticalBlurFBO;a.setStencilWriteMask(0);a.setStencilTestEnabled(!1);a.setDepthWriteEnabled(!1);a.setDepthTestEnabled(!1);k=this._layerFBOTexture;c.copyToTexture(0,0,h,r,0,0,k);this._quad||(this._quad=new v(a,[-1,-1,1,-1,-1,1,1,1]));a.setViewport(0,0,
p[0],p[1]);l=this._quad;l.bind();a.setBlendingEnabled(!1);var e=f.getProgram(b,m.blur,[{name:"radius",value:Math.ceil(n)}]);a.bindProgram(e);a.bindFramebuffer(u);a.bindTexture(c.colorTexture,4);e.setUniformMatrix3fv("u_displayViewMat3",q.displayMat3);e.setUniform2fv("u_offset",y);e.setUniform1i("u_colorTexture",4);e.setUniform2fv("u_texSize",p);e.setUniform2fv("u_direction",w);e.setUniform1f("u_sigma",n);l.draw();a.bindFramebuffer(d);a.bindTexture(u.colorTexture,5);e.setUniformMatrix3fv("u_displayViewMat3",
q.displayMat3);e.setUniform2fv("u_offset",[0,0]);e.setUniform1i("u_colorTexture",5);e.setUniform2fv("u_direction",x);l.draw();a.bindFramebuffer(c);a.setViewport(0,0,h,r);b=f.getProgram(b,m.composite);a.bindProgram(b);a.bindTexture(d.colorTexture,2);b.setUniform1i("u_blurTexture",2);a.bindTexture(k,3);b.setUniform1i("u_layerFBOTexture",3);b.setUniform4fv("u_shadowColor",[g[0]/255*g[3],g[1]/255*g[3],g[2]/255*g[3],g[3]]);l.draw();a.setBlendingEnabled(!0);a.setStencilTestEnabled(!0);a.setBlendFunction(1,
771);l.unbind()};f.prototype._createOrResizeResources=function(b,c){var d=b.context,a=b.pixelRatio,f=b.state.size;b=Math.round(a*f[0]);a=Math.round(a*f[1]);this._horizontalBlurFBO&&this._size[0]===b&&this._size[1]===a||(this._size[0]=b,this._size[1]=a,this._horizontalBlurFBO?this._horizontalBlurFBO.resize(c[0],c[1]):this._horizontalBlurFBO=new h.FramebufferObject(d,{colorTarget:0,depthStencilTarget:0,width:c[0],height:c[1]},{target:3553,pixelFormat:6408,internalFormat:6408,dataType:5121,wrapMode:33071,
samplingMode:9729,flipped:!1,width:c[0],height:c[1]}),this._verticalBlurFBO?this._verticalBlurFBO.resize(c[0],c[1]):this._verticalBlurFBO=new h.FramebufferObject(d,{colorTarget:0,depthStencilTarget:0,width:c[0],height:c[1]},{target:3553,pixelFormat:6408,internalFormat:6408,dataType:5121,wrapMode:33071,samplingMode:9729,flipped:!1,width:c[0],height:c[1]}),this._layerFBOTexture?this._layerFBOTexture.resize(b,a):this._layerFBOTexture=new h.Texture(d,{target:3553,pixelFormat:6408,internalFormat:6408,
dataType:5121,wrapMode:33071,samplingMode:9729,flipped:!1,width:b,height:a}))};return f}();m.DropShadow=n});