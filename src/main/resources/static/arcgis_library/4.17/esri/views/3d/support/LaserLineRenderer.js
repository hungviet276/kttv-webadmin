// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.17/esri/copyright.txt for details.
//>>built
define("require exports ../../../core/mathUtils ../../../core/maybe ../../../core/libs/gl-matrix-2/vec2f64 ../../../core/libs/gl-matrix-2/vec3 ../../../core/libs/gl-matrix-2/vec3f64 ../../../core/libs/gl-matrix-2/vec4 ../../../core/libs/gl-matrix-2/vec4f64 ./geometryUtils ./LaserlinePathData ../webgl-engine/lib/glUtil3D ../webgl-engine/lib/Util ../webgl-engine/materials/internal/MaterialUtil ../webgl-engine/shaders/LaserlinePathTechnique ../webgl-engine/shaders/LaserlineTechnique".split(" "),function(q,
n,y,k,z,f,g,r,p,h,t,A,B,u,v,w){function x(c,a,e,b){var d=C,m=D;f.vec3.transformMat4(d,a,b);f.vec3.copy(m,e);m[3]=0;r.vec4.transformMat4(m,m,b);h.plane.fromPositionAndNormal(d,m,c)}Object.defineProperty(n,"__esModule",{value:!0});n.LaserLineRenderer=void 0;var C=g.vec3f64.create(),D=p.vec4f64.create(),E={glowColor:[1,.5,0],glowWidth:8,glowFalloff:8,innerColor:[1,1,1],innerWidth:1,globalAlpha:.75,angleCutoff:y.deg2rad(6),globalAlphaContrastBoost:2};q=function(){function c(a,e,b){void 0===e&&(e={});
void 0===b&&(b={contrastControlEnabled:!1});this._technique=null;this._projInfo=p.vec4f64.create();this._zScale=z.vec2f64.create();this._heightManifoldEnabled=!1;this._heightManifoldTarget=g.vec3f64.create();this._pointDistanceEnabled=!1;this._pointDistanceOrigin=g.vec3f64.create();this._pointDistanceTarget=g.vec3f64.create();this._lineVerticalPlaneEnabled=!1;this._lineVerticalPlaneSegment=h.lineSegment.create();this._intersectsLineEnabled=!1;this._intersectsLineSegment=h.lineSegment.create();this._intersectsLineRadius=
3;this._pathVerticalPlaneEnabled=this._intersectsLineInfinite=!1;this._pathTechnique=this._pathVerticalPlaneData=null;this.canRender=!0;this._tempNormal=g.vec3f64.create();this._tempDir=g.vec3f64.create();this._tempUp=g.vec3f64.create();this._tempVec3A=g.vec3f64.create();this._tempVec3B=g.vec3f64.create();this._tempVec4=p.vec4f64.create();this._tempPlane=h.plane.create();this._tempSphere=h.sphere.create();this._renderCoordsHelper=a;this._params=u.copyParameters(e,E);this._config=b}Object.defineProperty(c.prototype,
"renderSlots",{get:function(){return[this._config.contrastControlEnabled?17:16]},enumerable:!1,configurable:!0});Object.defineProperty(c.prototype,"needsLinearDepth",{get:function(){return!0},enumerable:!1,configurable:!0});Object.defineProperty(c.prototype,"heightManifoldEnabled",{get:function(){return this._heightManifoldEnabled},set:function(a){this._heightManifoldEnabled!==a&&(this._heightManifoldEnabled=a,this._requestRender())},enumerable:!1,configurable:!0});Object.defineProperty(c.prototype,
"heightManifoldTarget",{get:function(){return this._heightManifoldTarget},set:function(a){f.vec3.copy(this._heightManifoldTarget,a);this._requestRender()},enumerable:!1,configurable:!0});Object.defineProperty(c.prototype,"pointDistanceEnabled",{get:function(){return this._pointDistanceEnabled},set:function(a){a!==this._pointDistanceEnabled&&(this._pointDistanceEnabled=a,this._requestRender())},enumerable:!1,configurable:!0});Object.defineProperty(c.prototype,"pointDistanceTarget",{get:function(){return this._pointDistanceTarget},
set:function(a){f.vec3.copy(this._pointDistanceTarget,a);this._requestRender()},enumerable:!1,configurable:!0});Object.defineProperty(c.prototype,"pointDistanceOrigin",{get:function(){return this._pointDistanceOrigin},set:function(a){f.vec3.copy(this._pointDistanceOrigin,a);this._requestRender()},enumerable:!1,configurable:!0});Object.defineProperty(c.prototype,"lineVerticalPlaneEnabled",{get:function(){return this._lineVerticalPlaneEnabled},set:function(a){a!==this._lineVerticalPlaneEnabled&&(this._lineVerticalPlaneEnabled=
a,this._requestRender())},enumerable:!1,configurable:!0});Object.defineProperty(c.prototype,"lineVerticalPlaneSegment",{get:function(){return this._lineVerticalPlaneSegment},set:function(a){h.lineSegment.copy(a,this._lineVerticalPlaneSegment);this._requestRender()},enumerable:!1,configurable:!0});Object.defineProperty(c.prototype,"intersectsLineEnabled",{get:function(){return this._intersectsLineEnabled},set:function(a){a!==this._intersectsLineEnabled&&(this._intersectsLineEnabled=a,this._requestRender())},
enumerable:!1,configurable:!0});Object.defineProperty(c.prototype,"intersectsLineSegment",{get:function(){return this._intersectsLineSegment},set:function(a){h.lineSegment.copy(a,this._intersectsLineSegment);this._requestRender()},enumerable:!1,configurable:!0});Object.defineProperty(c.prototype,"intersectsLineRadius",{get:function(){return this._intersectsLineRadius},set:function(a){a!==this._intersectsLineRadius&&(this._intersectsLineRadius=a,this._requestRender())},enumerable:!1,configurable:!0});
Object.defineProperty(c.prototype,"intersectsLineInfinite",{get:function(){return this._intersectsLineInfinite},set:function(a){a!==this._intersectsLineInfinite&&(this._intersectsLineInfinite=a,this._requestRender())},enumerable:!1,configurable:!0});Object.defineProperty(c.prototype,"pathVerticalPlaneEnabled",{get:function(){return this._pathVerticalPlaneEnabled},set:function(a){a!==this._pathVerticalPlaneEnabled&&(this._pathVerticalPlaneEnabled=a,k.isSome(this._pathVerticalPlaneData)&&this._requestRender())},
enumerable:!1,configurable:!0});Object.defineProperty(c.prototype,"pathVerticalPlaneVertices",{set:function(a){k.isNone(this._pathVerticalPlaneData)&&(this._pathVerticalPlaneData=new t.LaserlinePathData(this._renderCoordsHelper));this._pathVerticalPlaneData.vertices=a;this.pathVerticalPlaneEnabled&&this._requestRender()},enumerable:!1,configurable:!0});Object.defineProperty(c.prototype,"pathVerticalPlaneBuffers",{set:function(a){k.isNone(this._pathVerticalPlaneData)&&(this._pathVerticalPlaneData=
new t.LaserlinePathData(this._renderCoordsHelper));this._pathVerticalPlaneData.buffers=a;this.pathVerticalPlaneEnabled&&this._requestRender()},enumerable:!1,configurable:!0});c.prototype.setParameterValues=function(a){u.updateParameters(this._params,a)&&this._requestRender()};c.prototype.initializeRenderContext=function(a){this._initContext=a;this._quadVAO=A.createQuadVAO(a.rctx);this._techniqueRepository=a.shaderTechniqueRep;this._techniqueConfig=new w.LaserlineTechniqueConfiguration;this._pathTechniqueConfig=
new v.LaserlinePathTechniqueConfiguration};c.prototype.uninitializeRenderContext=function(){this._quadVAO.dispose();this._quadVAO=null;k.isSome(this._technique)&&this._techniqueRepository.release(this._technique);k.isSome(this._pathVerticalPlaneData)&&this._pathVerticalPlaneData.dispose();k.isSome(this._pathTechnique)&&this._techniqueRepository.release(this._pathTechnique)};c.prototype.render=function(a){var e=this.heightManifoldEnabled||this.pointDistanceEnabled||this.lineVerticalPlaneSegment||this.intersectsLineEnabled,
b=this.pathVerticalPlaneEnabled;if(!e&&!b)return!0;var d=a.camera;B.inverseProjectionInfo(d.projectionMatrix,d.fullWidth,d.fullHeight,this._projInfo,this._zScale);e&&this.renderUnified(a);b&&this.renderPath(a);return!0};c.prototype.renderUnified=function(a){var e=a.rctx,b=this._selectTechnique(),d=b.program;e.bindProgram(d);b.bindPipelineState(e);this.bindGlobalUniforms(a,d);this.bindHeightManifoldUniforms(a,d);this.bindPointDistanceUniforms(a,d);this.bindLineVerticalPlaneUniforms(a,d);this.bindIntersectsLineUniforms(a,
d);b.bind(this._params,a.camera);e.bindVAO(this._quadVAO);e.drawArrays(5,0,4)};c.prototype.renderPath=function(a){if(!k.isNone(this._pathVerticalPlaneData)){this._pathTechniqueConfig.contrastControlEnabled=this._config.contrastControlEnabled;this._pathTechnique=this._techniqueRepository.acquireAndReleaseExisting(v.LaserlinePathTechnique,this._pathTechniqueConfig,this._pathTechnique);var e=a.rctx,b=this._pathTechnique,d=b.program;e.bindProgram(d);b.bindPipelineState(e);this.bindGlobalUniforms(a,d);
b.bind(this._params,this._pathVerticalPlaneData.origin,a.camera);this._pathVerticalPlaneData.draw(a.rctx)}};c.prototype.bindHeightManifoldUniforms=function(a,e){if(this.heightManifoldEnabled){var b=this._tempVec3A,d=this._tempPlane;this._renderCoordsHelper.worldUpAtPosition(this._heightManifoldTarget,b);x(d,this._heightManifoldTarget,b,a.camera.viewMatrix);e.setUniform4fv("heightPlane",d)}};c.prototype.bindPointDistanceUniforms=function(a,e){if(this._pointDistanceEnabled){a=a.camera;var b=this._tempSphere;
f.vec3.copy(b.center,this._pointDistanceOrigin);f.vec3.transformMat4(b.center,b.center,a.viewMatrix);b.radius=f.vec3.distance(this._pointDistanceOrigin,this._pointDistanceTarget);e.setUniform4f("pointDistanceSphere",b.center[0],b.center[1],b.center[2],b.radius)}};c.prototype.bindLineVerticalPlaneUniforms=function(a,e){if(this._lineVerticalPlaneEnabled){var b=this._renderCoordsHelper;a=a.camera;var d=this._tempPlane,c=this._tempVec3A,g=this._tempUp,k=this._tempDir,l=this._tempNormal;h.lineSegment.pointAt(this._lineVerticalPlaneSegment,
.5,c);b.worldUpAtPosition(c,g);f.vec3.normalize(k,this._lineVerticalPlaneSegment.vector);f.vec3.cross(l,g,k);f.vec3.normalize(l,l);x(d,this._lineVerticalPlaneSegment.origin,l,a.viewMatrix);e.setUniform4fv("lineVerticalPlane",d);d=this._tempVec3A;f.vec3.copy(d,this._lineVerticalPlaneSegment.origin);b.setAltitude(0,d);f.vec3.transformMat4(d,d,a.viewMatrix);e.setUniform3fv("lineVerticalStart",d);d=this._tempVec3B;f.vec3.add(d,this._lineVerticalPlaneSegment.origin,this._lineVerticalPlaneSegment.vector);
b.setAltitude(0,d);f.vec3.transformMat4(d,d,a.viewMatrix);e.setUniform3fv("lineVerticalEnd",d)}};c.prototype.bindIntersectsLineUniforms=function(a,e){if(this._intersectsLineEnabled){var b=F,d=G;if(this._intersectsLineInfinite){var c=a.camera;h.clipRay.fromRay(h.ray.wrap(this._intersectsLineSegment.origin,this._intersectsLineSegment.vector),l);l.c0=-Number.MAX_VALUE;if(!h.frustum.intersectClipRay(c.frustum.planes,l))return;h.clipRay.getStart(l,b);h.clipRay.getEnd(l,d)}else f.vec3.copy(b,this._intersectsLineSegment.origin),
f.vec3.add(d,this._intersectsLineSegment.origin,this._intersectsLineSegment.vector);c=this._tempVec3A;f.vec3.transformMat4(c,b,a.camera.viewMatrix);e.setUniform3fv("intersectsLineStart",c);b=this._tempVec4;f.vec3.copy(b,this._intersectsLineSegment.vector);this._tempVec4[3]=0;r.vec4.transformMat4(this._tempVec4,this._tempVec4,a.camera.viewMatrix);f.vec3.transformMat4(d,d,a.camera.viewMatrix);e.setUniform3fv("intersectsLineEnd",d);f.vec3.normalize(b,b);e.setUniform3f("intersectsLineDirection",b[0],
b[1],b[2]);e.setUniform1f("intersectsLineRadius",this._intersectsLineRadius)}};c.prototype.bindGlobalUniforms=function(a,c){var b=a.camera;c.setUniform4fv("projInfo",this._projInfo);c.setUniform2fv("zScale",this._zScale);c.setUniform2f("nearFar",b.near,b.far);this._heightManifoldEnabled?c.setUniform1f("maxPixelDistance",2*b.computeScreenPixelSizeAt(this._heightManifoldTarget)):this._pointDistanceEnabled?c.setUniform1f("maxPixelDistance",2*b.computeScreenPixelSizeAt(this._pointDistanceTarget)):this._lineVerticalPlaneEnabled&&
c.setUniform1f("maxPixelDistance",2*b.computeScreenPixelSizeAt(this._lineVerticalPlaneSegment.origin));c.setUniform1i("depthMap",0);a.rctx.bindTexture(a.offscreenRenderingHelper.linearDepthTexture,0);c.setUniform1i("frameColor",1);a.rctx.bindTexture(a.offscreenRenderingHelper.mainColorTexture,1)};c.prototype._requestRender=function(){this._initContext&&this._initContext.requestRender()};c.prototype._selectTechnique=function(){this._techniqueConfig.heightManifoldEnabled=this.heightManifoldEnabled;
this._techniqueConfig.lineVerticalPlaneEnabled=this.lineVerticalPlaneEnabled;this._techniqueConfig.pointDistanceEnabled=this.pointDistanceEnabled;this._techniqueConfig.intersectsLineEnabled=this.intersectsLineEnabled;this._techniqueConfig.contrastControlEnabled=this._config.contrastControlEnabled;return this._technique=this._techniqueRepository.acquireAndReleaseExisting(w.LaserlineTechnique,this._techniqueConfig,this._technique)};return c}();n.LaserLineRenderer=q;var l=h.clipRay.create(),F=g.vec3f64.create(),
G=g.vec3f64.create()});