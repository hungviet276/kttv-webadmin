// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.17/esri/copyright.txt for details.
//>>built
define(["require","exports","../../../../../core/maybe","./util"],function(q,n,r,v){Object.defineProperty(n,"__esModule",{value:!0});n.SymbolRepository=void 0;q=function(){function h(a,b,e){this.tileCoordRange=a;this._tileForest=b;this._createUnique=e;this._tiles=new Map;this._uniqueSymbolsReferences=new Map}Object.defineProperty(h.prototype,"uniqueSymbols",{get:function(){r.isNone(this._uniqueSymbolLayerArray)&&(this._uniqueSymbolLayerArray=this._createUniqueSymbolLayerArray());return this._uniqueSymbolLayerArray},
enumerable:!1,configurable:!0});h.prototype.addTile=function(a,b){var e=this;void 0===b&&(b=!0);this._uniqueSymbolLayerArray=null;b?(b={flatLatestSymbols:null,indexedLatestSymbols:null},this._tiles.set(a,b)):(b=this._tiles.get(a),this._removeSymbols(b.flatLatestSymbols));var f=a.symbols;f.forEach(function(b){for(var c=0;c<b.length;c++)b[c].tile=a});var d=new Map;f.forEach(function(b,a){var c=b.length;if(32<=c){var g=e.tileCoordRange;do g/=2,c/=4;while(8<c&&64<g);c=new v.GridIndex(e.tileCoordRange,
e.tileCoordRange,g);d.set(a,c);for(a=0;a<b.length;a++)g=b[a],c.getCell(g.xTile,g.yTile).push(g)}});b.flatLatestSymbols=f;b.indexedLatestSymbols=d;this._addSymbols(a.key,f)};h.prototype.removeTile=function(a){this._uniqueSymbolLayerArray=null;this._removeSymbols(a.symbols);this._tiles.delete(a)};h.prototype._removeSymbols=function(a){var b=this;a.forEach(function(a,f){for(var d=0;d<a.length;d++){for(var c=a[d],e=c.unique,l=e.tileSymbols,g=l.length-1,m=0;m<g;m++)if(l[m]===c){l[m]=l[g];break}l.length=
g;0===g&&(l=b._uniqueSymbolsReferences.get(f),l.delete(e),0===l.size&&b._uniqueSymbolsReferences.delete(f));c.unique=null;c.tile=null}})};h.prototype._addSymbols=function(a,b){var e=this;if(0!==b.size){for(var f=0,d=this._tileForest.getRoots();f<d.length;f++){var c=d[f];c.key.world===a.world&&(c.key.level!==a.level||c.key.equals(a))&&this._matchSymbols(c,a,b)}b.forEach(function(a,b){for(var c=0;c<a.length;c++){var d=a[c];if(r.isNone(d.unique)){var f=e._createUnique();d.unique=f;f.tileSymbols.push(d);
d=e._uniqueSymbolsReferences.get(b);d||(d=new Set,e._uniqueSymbolsReferences.set(b,d));d.add(f)}}})}};h.prototype._matchSymbols=function(a,b,e){var f=this;if(a.key.level>b.level){var d=a.key.level-b.level;if(a.key.row>>d!==b.row||a.key.col>>d!==b.col)return}if(b.level>a.key.level&&(d=b.level-a.key.level,b.row>>d!==a.key.row||b.col>>d!==a.key.col))return;if(b.equals(a.key))for(var c=0,h=this._tileForest.getChildren(a);c<h.length;c++)d=h[c],this._matchSymbols(d,b,e);else{var l=new Map;e.forEach(function(c,
d){for(var e=[],g=0;g<c.length;g++){var k=c[g],h=v.tileCoordChange(f.tileCoordRange,k.xTile,b.level,b.col,a.key.level,a.key.col),p=v.tileCoordChange(f.tileCoordRange,k.yTile,b.level,b.row,a.key.level,a.key.row);0<=h&&h<f.tileCoordRange&&0<=p&&p<f.tileCoordRange&&e.push({symbol:k,xTransformed:h,yTransformed:p})}c=[];g=a.key.level<b.level?1:1<<a.key.level-b.level;k=f._tiles.get(a);if(h=k.flatLatestSymbols.get(d))for(var p=k.indexedLatestSymbols.get(d),m=0;m<e.length;m++){for(var k=e[m],t=!1,n=void 0,
q=k.xTransformed,r=k.yTransformed,n=p?p.getCell(q,r):h,k=k.symbol,x=k.hash,w=0;w<n.length;w++){var u=n[w];if(x===u.hash&&Math.abs(q-u.xTile)<=g&&Math.abs(r-u.yTile)<=g){t=u.unique;k.unique=t;t.tileSymbols.push(k);t=!0;break}}t||c.push(k)}0<c.length&&l.set(d,c)});e=0;for(c=this._tileForest.getChildren(a);e<c.length;e++)d=c[e],this._matchSymbols(d,b,l)}};h.prototype._createUniqueSymbolLayerArray=function(){var a=Array(this._uniqueSymbolsReferences.size),b=0;this._uniqueSymbolsReferences.forEach(function(e,
f){var d=[];e.forEach(function(a){d.push(a)});a[b]={layerIndex:f,uniqueSymbols:d};b++});return a};return h}();n.SymbolRepository=q});