// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.17/esri/copyright.txt for details.
//>>built
define("require exports ../../../../../core/Handles ../../../../../core/maybe ../../../../../core/screenUtils ../../../../../layers/graphics/hydratedFeatures ../../editingTools/dragEventPipeline3D ./AreaMeasurement3DView ../../../../interactive/dragEventPipeline".split(" "),function(u,v,p,h,e,l,q,r,t){return function(){function b(a,d,b){this._manipulators=b;this._handles=new p;this._tempPickRequest=new r.PickRequest;this.model=a;this.view=d;this.model.reset();this._setupManipulators()}b.prototype.destroy=
function(){this._handles.destroy();this._handles=null};b.prototype.handleInputEvent=function(a){switch(a.type){case "immediate-click":this._handleImmediateClick(a);break;case "pointer-move":this._handlePointerMove(a);break;case "drag":this._handleDrag(a);break;case "key-down":this._handleKeyDown(a)}};b.prototype._setupManipulators=function(){var a=this,b=0,f=function(c){return function(d){"start"===d.action&&(b++,a.model.lastDraggedVertex=h.unwrap(a.view.manipulatorIdToVertexId(c)),"measured"===a.model.state&&
(a.model.state="editing"));return d}},e=function(){return function(c){return"end"===c.action?(b--,0===b&&"editing"===a.model.state&&(a.model.state="measured"),null):c}},g=function(c,b){a._handles.add([t.createManipulatorDragEventPipeline(b,function(b,d,g){var m=q.hideManipulatorWhileDragging(b),k=h.unwrap(a.view.manipulatorIdToVertexId(c));d.next(f(c)).next(m).next(e()).next(a.view.screenToMap3D()).next(function(c){b.location=c.mapEnd;a.model.path.update(k,l.clonePoint(c.mapEnd))});var n=l.clonePoint(a.model.path.vertex(k));
g.next(m).next(function(){a.model.path.update(k,n);b.location=n})}),b.events.on("double-click",function(b){if("mouse"!==b.pointerType||0===b.button)"drawing"===a.model.state&&a.model.finishMeasurement(),b.stopPropagation()})],"manipulator-"+c)};this._manipulators.forEach(function(a){g(a.id,a.manipulator)});this._handles.add([this._manipulators.on("after-add",function(a){a=a.item;g(a.id,a.manipulator)}),this._manipulators.on("after-remove",function(b){a._handles.remove("manipulator-"+b.item.id)})])};
b.prototype._handleDrag=function(a){"editing"===this.model.state&&a.stopPropagation()};b.prototype._handleImmediateClick=function(a){if("mouse"!==a.pointerType||0===a.button){var b=e.createScreenPointFromEvent(a);if(this.model.active)switch(this.model.state){case "initial":this._addVertexAt(b)&&(this.model.state="drawing",a.stopPropagation());break;case "drawing":var f=this.view.vertexHandleAt(b,a.pointerType);if(h.isNone(f)){if(this._addVertexAt(b))return}else 0===f&&(this.model.finishMeasurement(),
a.stopPropagation())}"mouse"===a.pointerType&&this._hoverAt(b)}};b.prototype._handlePointerMove=function(a){"mouse"===a.pointerType&&(a=e.createScreenPointFromEvent(a),this._hoverAt(a))};b.prototype._handleKeyDown=function(a){"Enter"===a.key&&"drawing"===this.model.state&&(this.model.finishMeasurement(),a.stopPropagation())};b.prototype._hoverAt=function(a){this.view.requiresCursorPoint?(a=this._pick(a),a.mapPoint&&(this.model.cursorPoint=a.mapPoint)):this.model.cursorPoint=null};b.prototype._addVertexAt=
function(a){a=this._pick(a);return a.mapPoint?(this.model.path.add(a.mapPoint),!0):!1};b.prototype._pick=function(a){var b=this._tempPickRequest;b.screenPoint=a;return this.view.pick(b)};return b}()});