// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.17/esri/copyright.txt for details.
//>>built
define("require exports tslib ../../../../../request ../../../../../core/Error ../../../../../core/has ../../../../../core/Logger ../../../../../core/maybe ../../../../../core/promiseUtils ../../../../../tasks/support/Query ../controllers/support/sources ./DataTileSource ../../../../support/QueueProcessor".split(" "),function(p,n,c,u,v,q,w,x,l,y,z,A,r){Object.defineProperty(n,"__esModule",{value:!0});n.BaseFeatureSource=void 0;var B=w.getLogger("esri.views.2d.layers.features.sources.BaseFeatureSource");
p=function(m){function b(e){var d=m.call(this,e)||this;d.type="feature";d._adapter=z.createSourceAdapter(e.serviceInfo);d._queue=new r.QueueProcessor({concurrency:8,process:function(a){return c.__awaiter(d,void 0,void 0,function(){var d,e,b,g,k;return c.__generator(this,function(c){l.throwIfAborted(a);d=a.tile.key.id;e=a.tile;b=a.signal;g=q("esri-tiles-debug")?{tile:d.replace(/\//g,"."),depth:a.depth}:void 0;k={query:g,signal:b,transform:e.transform};return[2,this._adapter.executeQuery(a.query,k)]})})}});
d._patchQueue=new r.QueueProcessor({concurrency:8,process:function(a){return c.__awaiter(d,void 0,void 0,function(){var d,e,b,g,k;return c.__generator(this,function(c){l.throwIfAborted(a);d=a.tile.key.id;e=a.tile;b=a.signal;g=q("esri-tiles-debug")?{tile:d.replace(/\//g,"."),depth:a.depth}:void 0;k={query:g,signal:b,transform:e.transform};return[2,this._adapter.executeQuery(a.query,k)]})})}});return d}c.__extends(b,m);b.prototype.destroy=function(){this._adapter.destroy();this._queue.destroy();this._patchQueue.destroy()};
b.prototype.setViewState=function(e){};Object.defineProperty(b.prototype,"updating",{get:function(){return!!this._queue.length},enumerable:!1,configurable:!0});b.prototype.subscribe=function(e){m.prototype.subscribe.call(this,e);this._fetchDataTile(e).catch(function(d){l.isAbortError(d)||B.error(new v("mapview-query-error","Encountered error when fetching tile",{tile:e,error:d}))})};b.prototype.unsubscribe=function(e){m.prototype.unsubscribe.call(this,e)};b.prototype.pause=function(){this._queue.pause()};
b.prototype.resume=function(){this._queue.resume()};b.prototype.query=function(e,d){return c.__awaiter(this,void 0,void 0,function(){return c.__generator(this,function(a){return[2,this._adapter.executeQuery(e,d)]})})};b.prototype.queryLastEditDate=function(){return c.__awaiter(this,void 0,void 0,function(){var e,d,a,b;return c.__generator(this,function(f){switch(f.label){case 0:return e=this._serviceInfo.source,d=c.__assign(c.__assign({},e.query),{f:"json"}),[4,u(e.path,{query:d,responseType:"json"})];
case 1:return a=f.sent(),b=a.data,[2,b.editingInfo.lastEditDate]}})})};b.prototype.forEachRequest=function(e,d){var a=this._subscriptions.get(e);e=a.signal;for(var c=0,a=a.requests.done;c<a.length;c++)d(a[c].request,{signal:e})};b.prototype._executePatchQuery=function(e,d,a,b){return c.__awaiter(this,void 0,void 0,function(){var f,h,g;return c.__generator(this,function(k){f=d.clone();f.outFields=c.__spreadArrays([this._serviceInfo.objectIdField],a);f.returnCentroid=!1;f.returnGeometry=!1;h=f.start/
8E3;g=b.signal;return[2,this._patchQueue.push({tile:e,query:f,signal:g,depth:h})]})})};b.prototype._resendRequest=function(e,d){return c.__awaiter(this,void 0,void 0,function(){var a,b,t,h,g,k;return c.__generator(this,function(f){switch(f.label){case 0:a=e.query;b=e.request;t=a.outFields;h=this._sourceQueryInfo.outFields;g=h.filter(function(a){return-1===t.indexOf(a)});if(x.isNone(b.features))return[2];if(!g.length)return this._onRequest(c.__assign(c.__assign({},b),{end:b.end||d.end}),"new",d),[2];
f.label=1;case 1:return f.trys.push([1,3,,4]),[4,this._executePatchQuery(b.tile,a,g,d)];case 2:return k=f.sent(),l.throwIfAborted(d),a.outFields=h,b.features.joinAttributes(k),this._onRequest(c.__assign(c.__assign({},b),{end:b.end||d.end}),"new",d),[3,4];case 3:return f.sent(),[3,4];case 4:return[2]}})})};b.prototype.resend=function(b){var d=b.dataTileOnly;return c.__awaiter(this,void 0,void 0,function(){var a,b,e,h=this;return c.__generator(this,function(c){switch(c.label){case 0:a=0;b=!1;e=[];for(this._subscriptions.forEach(function(a){a.requests.done.length||
(a=a.tile,h._onRequest({tile:a,id:a.id,features:null,noData:!0,end:!1},"new",{dataTileOnly:!0}))});!b;)b=!0,this._subscriptions.forEach(function(c){var f=c.requests;c=c.signal;f.done.length>a&&(b=!1,e.push(h._resendRequest(f.done[a],{signal:c,dataTileOnly:d,end:f.done.length===a+1})))}),a++;return[4,l.all(e)];case 1:return c.sent(),[2]}})})};b.prototype._createQuery=function(b,d){var a=new y(c.__assign(c.__assign(c.__assign({},this._serviceQueryInfo),this._sourceQueryInfo),d));this._serviceInfo.capabilities.query.supportsQuantization||
(d.quantizationParameters=null,a.maxAllowableOffset=b.resolution);d.quantizationParameters&&"esriGeometryPolyline"===this.geometryType&&(a.maxAllowableOffset=b.resolution);a.resultType="tile";a.geometry=b.extent;return a};return b}(A.DataTileSource);n.BaseFeatureSource=p});