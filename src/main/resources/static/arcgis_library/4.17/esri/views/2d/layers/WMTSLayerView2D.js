// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.17/esri/copyright.txt for details.
//>>built
define("require exports tslib ../../../core/Handles ../../../core/accessorSupport/decorators ../../../geometry/support/webMercatorUtils ./BitmapTileLayerView2D ./LayerView2D ../tiling/TileInfoView ../tiling/TileQueue ../tiling/TileStrategy ../../layers/LayerView ../../layers/RefreshableLayerView".split(" "),function(v,w,d,h,g,k,l,m,n,p,q,r,t){var u=[102113,102100,3857,3785,900913];return function(f){function b(){var a=null!==f&&f.apply(this,arguments)||this;a._handles=new h;a._tileStrategy=null;a._fetchQueue=
null;a._tileRequests=new Map;a.layer=null;return a}d.__extends(b,f);Object.defineProperty(b.prototype,"tileMatrixSet",{get:function(){if(this.layer.activeLayer.tileMatrixSetId)return this.layer.activeLayer.tileMatrixSet;var a=this._getTileMatrixSetBySpatialReference(this.layer.activeLayer);if(!a)return null;this.layer.activeLayer.tileMatrixSetId=a.id;return a},enumerable:!1,configurable:!0});b.prototype.hitTest=function(){return null};b.prototype.update=function(a){this._fetchQueue.pause();this._fetchQueue.state=
a.state;this._tileStrategy.update(a);this._fetchQueue.resume();this.notifyChange("updating")};b.prototype.attach=function(){var a=this,c=this.layer.activeLayer,b=this.tileMatrixSet;if(b){var e=b.tileInfo.spatialReference,c=c.fullExtent&&c.fullExtent.clone();e.isWebMercator?c=k.geographicToWebMercator(c):e.isWGS84||(c=b.fullExtent);this._tileInfoView=new n(b.tileInfo,c);this._fetchQueue=new p({tileInfoView:this._tileInfoView,process:function(c){return a.fetchTile(c)}});this._tileStrategy=new q({cachePolicy:"keep",
acquireTile:function(c){return a.acquireTile(c)},releaseTile:function(c){return a.releaseTile(c)},tileInfoView:this._tileInfoView});this._handles.add(this.watch("layer.activeLayer.styleId, tileMatrixSet",function(){return a._refresh()}));f.prototype.attach.call(this)}};b.prototype.detach=function(){f.prototype.detach.call(this);this._handles.removeAll();this._tileStrategy.destroy();this._fetchQueue.clear();this._fetchQueue=this._tileStrategy=this._tileInfoView=null};b.prototype.moveStart=function(){this.requestUpdate()};
b.prototype.viewChange=function(){this.requestUpdate()};b.prototype.moveEnd=function(){this.requestUpdate()};b.prototype.doRefresh=function(){return d.__awaiter(this,void 0,void 0,function(){return d.__generator(this,function(a){if(this.updateRequested||this.suspended)return[2];this._refresh();return[2]})})};b.prototype.isUpdating=function(){return 0<this._fetchQueue.length};b.prototype.acquireTile=function(a){var c,b=this,e=this._bitmapView.createTile(a),d=e.bitmap;c=this._tileInfoView.getTileCoords([0,
0],e.key);d.x=c[0];d.y=c[1];d.resolution=this._tileInfoView.getTileResolution(e.key);c=this._tileInfoView.tileInfo.size;d.width=c[0];d.height=c[1];this._tileInfoView.getTileCoords(d,e.key);var f={id:a.id,fulfilled:!1,promise:this._fetchQueue.push(e.key).then(function(a){e.bitmap.source=a;e.once("attach",function(){return b.requestUpdate()});b._bitmapView.addChild(e)}).catch(function(){e.bitmap.source=null;e.once("attach",function(){return b.requestUpdate()});b._bitmapView.addChild(e)})};f.promise.then(function(){return f.fulfilled=
!0},function(){return f.fulfilled=!0});this._tileRequests.set(e,f);this.requestUpdate();return e};b.prototype.releaseTile=function(a){var c=this._tileRequests.get(a);c.fulfilled||this._fetchQueue.abort(c.id);this._tileRequests.delete(a);this._bitmapView.removeChild(a);this.requestUpdate()};b.prototype.fetchTile=function(a){return d.__awaiter(this,void 0,void 0,function(){return d.__generator(this,function(c){return[2,this.layer.fetchTile(a.level,a.row,a.col)]})})};b.prototype.canResume=function(){var a=
f.prototype.canResume.call(this);return a?null!==this.tileMatrixSet:a};b.prototype._refresh=function(){var a=this;this._fetchQueue.reset();this._tileStrategy.tiles.forEach(function(c){if(c.bitmap.source){c.bitmap.source=null;var b={id:c.key.id,fulfilled:!1,promise:a._fetchQueue.push(c.key).then(function(b){c.bitmap.source=b;c.requestRender();a.notifyChange("updating")})};b.promise.then(function(){return b.fulfilled=!0},function(){return b.fulfilled=!0});a._tileRequests.set(c,b)}});this.notifyChange("updating")};
b.prototype._getTileMatrixSetBySpatialReference=function(a){var b=this.view.spatialReference;if(!a.tileMatrixSets)return null;var d=a.tileMatrixSets.find(function(a){return a.tileInfo.spatialReference.wkid===b.wkid});!d&&b.isWebMercator&&(d=a.tileMatrixSets.find(function(a){return-1<u.indexOf(a.tileInfo.spatialReference.wkid)}));return d};d.__decorate([g.property({dependsOn:["tileMatrixSet"]})],b.prototype,"suspended",void 0);d.__decorate([g.property({readOnly:!0,dependsOn:["view.spatialReference",
"layer.activeLayer"]})],b.prototype,"tileMatrixSet",null);return b=d.__decorate([g.subclass("esri.views.2d.layers.WMTSLayerView2D")],b)}(t.RefreshableLayerView(l.BitmapTileLayerView2D(m.LayerView2DMixin(r))))});