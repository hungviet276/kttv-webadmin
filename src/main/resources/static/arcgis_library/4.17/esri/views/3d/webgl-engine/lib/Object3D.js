// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.17/esri/copyright.txt for details.
//>>built
define("require exports tslib ../../../../core/maybe ../../../../core/libs/gl-matrix-2/mat4 ../../../../core/libs/gl-matrix-2/mat4f64 ../../../../core/libs/gl-matrix-2/vec3 ../../../../core/libs/gl-matrix-2/vec3f64 ../../support/mathUtils ./GeometryRecord ./IdGen ./Object3DStateSet ./Util ../materials/renderers/utils".split(" "),function(u,C,z,A,t,n,f,l,v,p,B,w,q,r){u=function(){function b(a){void 0===a&&(a={});this._objectTransformation=n.mat4f64.create();this._bvObjectSpace=new x;this._bvWorldSpace=
new x;this._bvDirty=!0;this._hasVolatileTransformation=!1;this._visible=!0;this.id=b._idGen.gen(a.idHint);this.castShadow=null!=a.castShadow?a.castShadow:!0;(this.metadata=a.metadata)&&this.metadata.isElevationSource&&(this.metadata.lastValidElevationBB=new y);this.objectTransformation=n.mat4f64.create();this._initializeGeometryRecords(a.geometries,a.materials,a.transformations,a.origins)}Object.defineProperty(b.prototype,"geometryRecords",{get:function(){return this._geometryRecords},enumerable:!1,
configurable:!0});Object.defineProperty(b.prototype,"geometries",{get:function(){return this._geometries},enumerable:!1,configurable:!0});Object.defineProperty(b.prototype,"objectTransformation",{get:function(){return this._objectTransformation},set:function(a){t.mat4.copy(this._objectTransformation,a);this._invalidateBoundingVolume();this._notifyDirty("objTransformation")},enumerable:!1,configurable:!0});b.prototype.dispose=function(){for(var a=0,c=this._geometryRecords;a<c.length;a++)p.pool.release(c[a]);
this._geometries=this._geometryRecords=null};b.prototype._initializeGeometryRecords=function(a,c,b,d){if(Array.isArray(a)){q.assert(c.length===a.length,"Object3D: materials don't match geometries");q.assert(b.length===a.length,"Object3D: transformations don't match geometries");this._geometryRecords=Array(a.length);this._geometries=a.slice();for(var m=0;m<a.length;m++)this._geometryRecords[m]=p.pool.acquire(a[m],c[m],n.mat4f64.clone(b[m]),{highlights:null,occludees:null,visible:!0},d&&d[m]);this._hasVolatileTransformation=
!1}else this._geometryRecords=[],this._geometries=[]};Object.defineProperty(b.prototype,"parentLayer",{get:function(){return this._parentLayer},set:function(a){q.assert(null==this._parentLayer||null==a,"Object3D can only be added to a single Layer");this._parentLayer=a},enumerable:!1,configurable:!0});b.prototype.getNumGeometryRecords=function(){return this._geometryRecords.length};b.prototype.getGeometryRecord=function(a){q.assert(0<=a&&a<this._geometryRecords.length,"Object3d.getGeometryDataByIndex: index out of range");
return this._geometryRecords[a]};b.prototype.addGeometry=function(a,c,b,d,f,g){b=b?b:n.mat4f64.IDENTITY;this._geometries.push(a);a=p.pool.acquire(a,c,b,d||{highlights:null,occludees:null,visible:!0},f,g);this._geometryRecords.push(a);this._hasVolatileTransformation=this._geometryRecords.some(function(a){return!!a.shaderTransformation});this._notifyDirty("objGeometryAdded",a);this._invalidateBoundingVolume();return a};b.prototype.removeGeometry=function(a){var c=this._geometryRecords.splice(a,1)[0];
p.pool.release(c);this._hasVolatileTransformation=this._geometryRecords.some(function(a){return!!a.shaderTransformation});this._geometries.splice(a,1);this._notifyDirty("objGeometryRemoved",c);this._invalidateBoundingVolume();return c};b.prototype.removeAllGeometries=function(){for(;0<this.getNumGeometryRecords();)this.removeGeometry(0)};b.prototype.geometryVertexAttrsUpdated=function(a){this._notifyDirty("vertexAttrsUpdated",this._geometryRecords[a]);this._invalidateBoundingVolume()};Object.defineProperty(b.prototype,
"isVisible",{get:function(){return this._visible},enumerable:!1,configurable:!0});b.prototype.setVisible=function(a){this._visible=a;a=0;for(var c=this._geometryRecords;a<c.length;a++)c[a].instanceParameters.visible=this._visible;this._notifyDirty("visibilityChanged")};b.prototype.occlude=function(){for(var a=w.generateObject3DStateId(1),c=0,b=this._geometryRecords;c<b.length;c++){var d=b[c];d.instanceParameters.occludees=r.addObject3DStateID(d.instanceParameters.occludees,a)}this._notifyDirty("occlusionChanged");
return a};b.prototype.removeOcclude=function(a){for(var c=0,b=this._geometryRecords;c<b.length;c++){var d=b[c];d.instanceParameters.occludees=r.removeObject3DStateID(d.instanceParameters.occludees,a)}this._notifyDirty("occlusionChanged")};b.prototype.highlight=function(){for(var a=w.generateObject3DStateId(0),c=0,b=this._geometryRecords;c<b.length;c++){var d=b[c];d.instanceParameters.highlights=r.addObject3DStateID(d.instanceParameters.highlights,a)}this._notifyDirty("highlightChanged");return a};
b.prototype.removeHighlight=function(a){for(var c=0,b=this._geometryRecords;c<b.length;c++){var d=b[c];d.instanceParameters.highlights=r.removeObject3DStateID(d.instanceParameters.highlights,a)}this._notifyDirty("highlightChanged")};b.prototype.getCombinedStaticTransformation=function(a,c){return t.mat4.multiply(A.unwrapOr(c,n.mat4f64.create()),this.objectTransformation,a.getStaticTransformation())};b.prototype.getCombinedShaderTransformation=function(a,c){c=c||n.mat4f64.create();t.mat4.multiply(c,
this.objectTransformation,a.getShaderTransformation());return c};b.prototype.hasVolativeTransformation=function(){return this._hasVolatileTransformation};b.prototype.getBBMin=function(a){this._validateBoundingVolume();return a?this._bvObjectSpace.bbMin:this._bvWorldSpace.bbMin};b.prototype.getBBMax=function(a){this._validateBoundingVolume();return a?this._bvObjectSpace.bbMax:this._bvWorldSpace.bbMax};b.prototype.getCenter=function(a){this._validateBoundingVolume();return a?this._bvObjectSpace.center:
this._bvWorldSpace.center};b.prototype.getBSRadius=function(a){this._validateBoundingVolume();return a?this._bvObjectSpace.bsRadius:this._bvWorldSpace.bsRadius};b.prototype._validateBoundingVolume=function(){if(this._bvDirty||this._hasVolatileTransformation){this._bvObjectSpace.init();this._bvWorldSpace.init();for(var a=0;a<this._geometryRecords.length;++a){var c=this._geometries[a],b=this._geometryRecords[a],c=c.boundingInfo;this._calculateTransformedBoundingVolume(c,this._bvObjectSpace,b.getShaderTransformation());
this._calculateTransformedBoundingVolume(c,this._bvWorldSpace,this.getCombinedShaderTransformation(b))}f.vec3.lerp(this._bvObjectSpace.center,this._bvObjectSpace.bbMin,this._bvObjectSpace.bbMax,.5);f.vec3.lerp(this._bvWorldSpace.center,this._bvWorldSpace.bbMin,this._bvWorldSpace.bbMax,.5);for(var b=l.vec3f64.create(),d=l.vec3f64.create(),h=v.maxScale(this.objectTransformation),a=0;a<this._geometryRecords.length;++a){var c=this._geometries[a],g=this._geometryRecords[a].getShaderTransformation(),e=
v.maxScale(g),c=c.boundingInfo;f.vec3.transformMat4(b,c.getCenter(),g);g=f.vec3.distance(b,this._bvObjectSpace.center);c=c.getBSRadius()*e;this._bvObjectSpace.bsRadius=Math.max(this._bvObjectSpace.bsRadius,g+c);f.vec3.transformMat4(d,b,this.objectTransformation);e=f.vec3.distance(d,this._bvWorldSpace.center);this._bvWorldSpace.bsRadius=Math.max(this._bvWorldSpace.bsRadius,e+c*h)}this._bvDirty=!1}};b.prototype._calculateTransformedBoundingVolume=function(a,c,b){var d=a.getBBMin();a=a.getBBMax();var h=
l.vec3f64.clone(d),g=l.vec3f64.clone(a);f.vec3.transformMat4(h,h,b);f.vec3.transformMat4(g,g,b);for(var e=0;3>e;++e)c.bbMin[e]=Math.min(c.bbMin[e],h[e],g[e]),c.bbMax[e]=Math.max(c.bbMax[e],h[e],g[e]);for(e=0;3>e;++e){f.vec3.copy(h,d);f.vec3.copy(g,a);h[e]=a[e];g[e]=d[e];f.vec3.transformMat4(h,h,b);f.vec3.transformMat4(g,g,b);for(var k=0;3>k;++k)c.bbMin[k]=Math.min(c.bbMin[k],h[k],g[k]),c.bbMax[k]=Math.max(c.bbMax[k],h[k],g[k])}};b.prototype._invalidateBoundingVolume=function(){this._bvDirty=!0;this._parentLayer&&
this._parentLayer.notifyObjectBBChanged(this,{center:this._bvWorldSpace.center,radius:this._bvWorldSpace.bsRadius})};b.prototype._notifyDirty=function(a,b,f,d){this._parentLayer&&this._parentLayer.notifyDirty(a,b,f||1,d||this)};Object.defineProperty(b.prototype,"test",{get:function(){var a=this;return{hasGeometry:function(b){return-1<a._geometries.indexOf(b)},getGeometryIndex:function(b){return a._geometries.indexOf(b)}}},enumerable:!1,configurable:!0});b._idGen=new B.IdGen;return b}();var y=function(){function b(){this.bbMin=
l.vec3f64.fromValues(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE);this.bbMax=l.vec3f64.fromValues(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE)}b.prototype.isEmpty=function(){return this.bbMax[0]<this.bbMin[0]&&this.bbMax[1]<this.bbMin[1]&&this.bbMax[2]<this.bbMin[2]};return b}(),x=function(b){function a(){var a=b.call(this)||this;a.center=l.vec3f64.create();a.bsRadius=0;return a}z.__extends(a,b);a.prototype.init=function(){f.vec3.set(this.bbMin,Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE);
f.vec3.set(this.bbMax,-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE);f.vec3.set(this.center,0,0,0);this.bsRadius=0};a.prototype.getCenter=function(){return this.center};a.prototype.getBSRadius=function(){return this.bsRadius};return a}(y);return u});