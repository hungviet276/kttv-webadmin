// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.17/esri/copyright.txt for details.
//>>built
define("require exports tslib ../../../../../../core/has ../../../../../../core/maybe ../../../../../../core/promiseUtils ../../definitions ../../enums ../MeshData ../VertexVector ../templates/WGLLabelTemplate ../templates/WGLMarkerTemplate ../templates/WGLTemplateStore".split(" "),function(v,t,q,B,u,w,x,g,y,m,z,A,r){Object.defineProperty(t,"__esModule",{value:!0});t.WGLMeshFactory=void 0;v=function(){function d(a,b,e){this._isDD=!1;this._geometryType=a;this._idField=b;this._templateStore=e}d.prototype.update=
function(a,b){this._isDD="simple"===a.mesh.matcher.type&&a.mesh.matcher.isDotDensity;u.isSome(a.mesh.labels)&&this._setLabelTemplates(a.mesh.labels,b)};d.prototype._setLabelTemplates=function(a,b){this._labelTemplates=a.map(function(a){return z.default.fromLabelClass(a,b)})};Object.defineProperty(d.prototype,"templates",{get:function(){return this._templateStore},enumerable:!1,configurable:!0});d.prototype.createMeshData=function(a){var b=Array(5),e=this._labelTemplates&&0<this._labelTemplates.length,
k="esriGeometryPolyline"===this._geometryType?x.HEURISTIC_GLYPHS_PER_LINE:x.HEURISTIC_GLYPHS_PER_FEATURE;b[g.WGLGeometryType.MARKER]=new m.VertexVectors(g.WGLGeometryType.MARKER,4*a);b[g.WGLGeometryType.FILL]=new m.VertexVectors(g.WGLGeometryType.FILL,a,this._isDD);b[g.WGLGeometryType.LINE]=new m.VertexVectors(g.WGLGeometryType.LINE,a);b[g.WGLGeometryType.TEXT]=new m.VertexVectors(g.WGLGeometryType.TEXT,4*a);b[g.WGLGeometryType.LABEL]=new m.VertexVectors(g.WGLGeometryType.LABEL,e?4*k:0);return new y.MeshData(b,
{features:a,records:a,metrics:0})};d.prototype.analyze=function(a,b,e,k,p){return q.__awaiter(this,void 0,void 0,function(){var h,c,f,l,n,d,g;return q.__generator(this,function(m){switch(m.label){case 0:return w.isAborted(p)?[2]:"dictionary"!==b.type?[3,2]:[4,b.analyze(this._idField,a.copy(),e,k,p)];case 1:h=m.sent(),m.label=2;case 2:for(c=0;a.next();)if(f=void 0,f=h?h[c++]:b.match(this._idField,a,this._geometryType,e,k),a.setGroupId(f),r.isDynamicId(f))for(l=this._templateStore.getDynamicTemplateGroup(f),
n=0,d=l;n<d.length;n++)(g=d[n])&&g.analyze&&g.analyze(this._templateStore,a,e,k);return[2,this._templateStore.finalize(p)]}})})};d.prototype.analyzeGraphics=function(a,b,e,k,p){return q.__awaiter(this,void 0,void 0,function(){var h,c,f,l,d,g;return q.__generator(this,function(n){switch(n.label){case 0:if(w.isAborted(p))return[2];h=a.getCursor();return b?[4,b.analyze(this._idField,h.copy(),e,k,p)]:[3,2];case 1:n.sent(),n.label=2;case 2:for(;h.next();){c=h.getGroupId();if(null==c||-1===c)c=b.match(this._idField,
h,h.geometryType,e,k),h.setGroupId(c);if(r.isDynamicId(c))for(f=this._templateStore.getDynamicTemplateGroup(c),l=0,d=f;l<d.length;l++)(g=d[l])&&g.analyze&&g.analyze(this._templateStore,h,e,k);h.setGroupId(c)}return[2,this._templateStore.finalize(p)]}})})};d.prototype.writeGraphic=function(a,b){var e=b.getGroupId(),k=b.getDisplayId(),d=this._templateStore.getTemplateGroup(e),h=b.geometryType;if(null!=k){if(r.isDynamicId(e))for(var c=0;c<d.length;c++)e=d[c],e.bindFeature(b,null,null);if(d)for(a.writeDisplayObject(k,
b.readGraphic().insertAfter),c=0;c<d.length;c++)if(e=d[c]){var f=a.get(e.geometryType);e.writeMesh(a,f,b,h,k)}}};d.prototype.writeCursor=function(a,b,e,d,g,h){var c=b.getGroupId(),f=b.getDisplayId(),l=this._templateStore.getTemplateGroup(c);if(null!=f&&l){a.writeDisplayObject(f,0);if(r.isDynamicId(c))for(var k=0;k<l.length;k++)c=l[k],c.bindFeature(b,e,d);for(e=0;e<l.length;e++)c=l[e],d=a.get(c.geometryType),!c.needsPixelBuffer&&b.hasFilter()||c.writeMesh(a,d,b,this._geometryType,f);c=a.hasDisplayRecords();
u.isSome(h)&&c&&(l=h&&this._findLabelRef(l),this._writeLabels(a,b,f,h,l,g));a.endDisplayObject()}};d.prototype._findLabelRef=function(a){for(var b=0;b<a.length;b++){var e=a[b];if(e instanceof A.default)return e}return null};d.prototype._writeLabels=function(a,b,e,d,g,h){for(var c=0;c<d.length;c++){var f=d[c];if(u.isSome(f)&&f){var l=f.glyphs,k=f.rtl,f=this._labelTemplates[f.index],m=a.get(f.geometryType);f.bindReferenceTemplate(g);f.bindTextInfo(l,k);f.writeMesh(a,m,b,this._geometryType,e,h)}}};return d}();
t.WGLMeshFactory=v});