// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.17/esri/copyright.txt for details.
//>>built
define("require exports tslib ../../../core/promiseUtils ../../../core/watchUtils ../../../core/accessorSupport/decorators ../../2d/engine/vectorTiles/SchemaHelper ../../2d/engine/vectorTiles/TileHandler ../../2d/engine/vectorTiles/VTLPainter3D ./LayerView3D ./TiledLayerView3D ../terrain/terrainUtils ../../layers/LayerView".split(" "),function(u,v,c,f,m,d,n,h,k,p,q,r,t){return function(e){function a(b){return e.call(this,b)||this}c.__extends(a,e);a.prototype.initialize=function(){var b=this,a=this._getTileInfoSupportError(r.test.force512VTL?
this.layer.tileInfo:this.layer.compatibleTileInfo256,this.layer.fullExtent);if(a)this.addResolvingPromise(f.reject(a));else{var a=m.whenTrueOnce(this.view,"basemapTerrain.tilingSchemeLocked").then(function(){var a=b.view.basemapTerrain.tilingScheme,c=a.pixelSize;b.schemaHelper=new n(c,b.view.spatialReference.isGeographic);c=256===c?b.layer.compatibleTileInfo256:b.view.spatialReference.isGeographic?b.layer.compatibleTileInfo512:b.layer.tileInfo;if(a=b._getTileInfoCompatibilityError(c,a))throw a;b._set("tileInfo",
c)}),c=f.createAbortController();this._memCache=this.view.resourceController.memoryController.getMemCache(this.layer.uid,function(a){return b.tileHandler.releaseVectorTile(a)});var d=this.view.resourceController.scheduler;this.tileHandler=new h.TileHandler(this.layer,this.view.pixelRatio,this._memCache);var e=this.tileHandler.start({signal:c.signal,scheduler:d}),g=this.tileHandler.spriteMosaic;g.then(function(a){return b.painter=new k.default(a,b.tileHandler.glyphMosaic)});e.then(function(){return c=
null});var l=function(){c&&c.abort();c=f.createAbortController();b._memCache.clear();var a=new h.TileHandler(b.layer,b.view.pixelRatio,b._memCache),e=a.start({signal:c.signal,scheduler:d}),g=a.spriteMosaic;e.then(function(){return c=null});b.updatingHandles.addPromise(f.all([e,g]).then(function(c){var d=b.tileHandler,e=b.painter;b.painter=new k.default(c[1],a.glyphMosaic);b.tileHandler=a;b.emit("data-changed");d.destroy();e&&e.dispose()}))};this.updatingHandles.add(this,"layer.currentStyleInfo",l);
this.updatingHandles.add(this,"view.pixelRatio",l);a=f.all([a,e,g]);this.addResolvingPromise(a)}};a.prototype.destroy=function(){this._memCache&&(this._memCache.destroy(),this._memCache=null);this.painter&&(this.painter.dispose(),this.painter=null);this.tileHandler&&(this.tileHandler.destroy(),this.tileHandler=null)};Object.defineProperty(a.prototype,"dataLevelRange",{get:function(){var a=this.tileInfo.lods,a=this.levelRangeFromScaleRange(a[0].scale,a[a.length-1].scale);1===a.minLevel&&256===this.tileInfo.size[0]&&
(a.minLevel=0);return a},enumerable:!1,configurable:!0});c.__decorate([d.property({aliasOf:"layer.fullExtent"})],a.prototype,"fullExtent",void 0);c.__decorate([d.property()],a.prototype,"layer",void 0);c.__decorate([d.property()],a.prototype,"tileInfo",void 0);c.__decorate([d.property()],a.prototype,"dataLevelRange",null);c.__decorate([d.property()],a.prototype,"updatingProgressValue",void 0);return a=c.__decorate([d.subclass("esri.views.3d.layers.VectorTileLayerView3D")],a)}(q.TiledLayerView3D(p.LayerView3D(t)))});