// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.17/esri/copyright.txt for details.
//>>built
define("require exports ../../../../request ../../../../core/arrayUtils ../../../../core/Error ../../../../core/maybe ../../../../core/promiseUtils ../../../../core/typedArrayUtil ../../../../core/libs/gl-matrix-2/mat4 ../../../../core/libs/gl-matrix-2/mat4f64 ../../../../core/libs/gl-matrix-2/quat ../../../../core/libs/gl-matrix-2/quatf32 ../../../../core/libs/gl-matrix-2/vec3 ../../../../core/libs/gl-matrix-2/vec4f64 ../../../../geometry/SpatialReference ../../../../geometry/support/aaBoundingBox ../../../../geometry/support/aaBoundingRect ../../../../geometry/support/geodesicConstants ../../../../geometry/support/webMercatorUtils ../../../../tasks/support/Query ./I3SBinaryReader ./I3SProjectionUtil ../support/edgeUtils ../support/symbolColorUtils ../../support/orientedBoundingBox ../../support/projectionUtils".split(" "),
function(qa,c,aa,E,p,x,q,J,ba,K,y,ca,h,da,L,ea,w,M,fa,ga,ha,ia,N,ja,z,t){function F(a){return a&&parseInt(a.substring(a.lastIndexOf("/")+1,a.length),10)}function O(a,b){var d=b[0],f=b[1];b=b[3];var c=a[0]-d,d=d-a[2],g=a[1]-f;a=f-a[3];var f=Math.max(c,d,0),e=Math.max(g,a,0),f=f*f+e*e;return f>b*b?0:0<f?1:-Math.max(c,d,g,a)>b?3:2}function P(a,b,d){var f=[],c=d&&d.missingFields;d=d&&d.originalFields;for(var g=0;g<a.length;g++){for(var e=a[g],l=e.toLowerCase(),r=!1,G=0,h=b;G<h.length;G++){var Q=h[G];
if(l===Q.name.toLowerCase()){f.push(Q.name);r=!0;d&&d.push(e);break}}!r&&c&&c.push(e)}return f}function ka(a,b){return a.filter(function(a){return a!==b}).concat([b])}function la(a,b,d,f){b.sort(function(a,b){return a.attributes[d]-b.attributes[d]});var c=b.map(function(a){return a.attributes[d]}),g=[],e=P(f,a.fields,{originalFields:g});return R(a,c,e).then(function(a){for(var d=0;d<b.length;d++){var f=b[d],c=a[d],m={};if(f.attributes)for(var l in f.attributes)m[l]=f.attributes[l];for(var u=0;u<g.length;u++)m[g[u]]=
c[e[u]];f.attributes=m}return b})}function R(a,b,d){var f=a.capabilities.query.maxRecordCount;if(null!=f&&b.length>f)return f=E.splitIntoChunks(b,f),q.all(f.map(function(b){return R(a,b,d)})).then(E.flatten);f=new ga({objectIds:b,outFields:d,orderByFields:[a.objectIdField]});return a.queryFeatures(f).then(function(a){if(a&&a.features&&a.features.length===b.length)return a.features.map(function(a){return a.attributes});throw new p("scenelayer:feature-not-in-associated-layer","Feature not found in associated feature layer");
})}function ma(a,b,d,f,c){for(var e=[],m=0;m<b.length;m++){var l=b[m];l&&-1!==c.indexOf(l.name)&&e.push({url:a+"/nodes/"+d.resources.attributes+"/attributes/"+l.key+"/0",storageInfo:l})}return q.eachAlways(e.map(function(a){return aa(a.url,{responseType:"array-buffer"}).then(function(b){return ha.readBinaryAttribute(a.storageInfo,b.data)})})).then(function(a){for(var b=[],d=0;d<f.length;d++){for(var c=f[d],m={},u=0;u<a.length;u++)null!=a[u].value&&(m[e[u].storageInfo.name]=S(a[u].value,c));b.push(m)}return b})}
function S(a,b){if(!a)return null;b=a[b];return J.isInt16Array(a)?b===na?null:b:J.isInt32Array(a)?b===oa?null:b:b!==b?null:b}function T(a){var b=new L(F(a.store.indexCRS||a.store.geographicCRS));return b.equals(a.spatialReference)?a.spatialReference:b}function U(a){var b=new L(F(a.store.vertexCRS||a.store.projectedCRS));return b.equals(a.spatialReference)?a.spatialReference:b}function A(a,b,d){if(!fa.canProject(a,b))throw new p("layerview:spatial-reference-incompatible","The spatial reference of this scene layer is incompatible with the spatial reference of the view",
{});if("local"===d&&a.isGeographic)throw new p("layerview:local-gcs-not-supported","Geographic coordinate systems are not supported in local scenes",{});}function V(a,b,d){var f=T(a);a=U(a);A(f,b,d);A(a,b,d)}function W(a,b,d,f,c){void 0===c&&(c=0);if(f===B)if(b.isGeographic)f=1+Math.max(0,c)/(M.earthRadius+a.center[2]),h.vec3.set(d.center,a.center[0],a.center[1],a.center[2]+c),t.bufferToBuffer(d.center,b,0,d.center,B,0,1),y.quat.copy(d.quaternion,a.quaternion),y.quat.conjugate(n,a.quaternion),h.vec3.set(e,
0,0,1),h.vec3.transformQuat(e,e,n),h.vec3.set(e,a.halfSize[0]*Math.abs(e[0]),a.halfSize[1]*Math.abs(e[1]),a.halfSize[2]*Math.abs(e[2])),h.vec3.scale(e,e,M.earthInverseFlattening),h.vec3.add(d.halfSize,a.halfSize,e),h.vec3.scale(d.halfSize,d.halfSize,f);else{z.corners(a,H);h.vec3.set(d.center,a.center[0],a.center[1],a.center[2]+c);t.computeLinearTransformation(b,d.center,k,B);h.vec3.set(d.center,k[12],k[13],k[14]);f=2*Math.sqrt(1+k[0]+k[5]+k[10]);n[0]=(k[6]-k[9])/f;n[1]=(k[8]-k[2])/f;n[2]=(k[1]-k[4])/
f;n[3]=.25*f;y.quat.multiply(d.quaternion,n,a.quaternion);y.quat.conjugate(n,d.quaternion);for(var g=f=a=0,m=0,l=H;m<l.length;m++){var r=l[m];r[2]+=c;t.bufferToBuffer(r,b,0,r,B,0,1);h.vec3.sub(e,r,d.center);h.vec3.transformQuat(e,e,n);a=Math.max(a,Math.abs(e[0]));f=Math.max(f,Math.abs(e[1]));g=Math.max(g,Math.abs(e[2]))}h.vec3.set(d.halfSize,a,f,g)}else a===d?(d.center[2]+=c,t.bufferToBuffer(d.center,b,0,d.center,f,0,1)):(h.vec3.set(d.center,a.center[0],a.center[1],a.center[2]+c),t.bufferToBuffer(d.center,
b,0,d.center,f,0,1),y.quat.copy(d.quaternion,a.quaternion),h.vec3.copy(d.halfSize,a.halfSize))}Object.defineProperty(c,"__esModule",{value:!0});c.computeVisibilityObb=c.transformObb=c.addWraparound=c.getSymbolInfo=c.SymbolInfo=c.transparentEdgeMaterial=c.rendererNeedsTextures=c.checkPointCloudLayerCompatibleWithView=c.checkPointCloudLayerValid=c.checkSceneLayerCompatibleWithView=c.checkSceneLayerValid=c.checkSpatialReferences=c.checkSpatialReference=c.getCacheKeySuffix=c.getVertexCrs=c.getIndexCrs=
c.getCachedAttributeValue=c.whenGraphicAttributes=c.findFieldsCaseInsensitive=c.intersectBoundingBoxWithMbs=c.intersectBoundingRectWithMbs=c.getClipAABB=c.filterInPlace=c.findIntersectingNodes=c.selectEncoding=c.extractWkid=c.BROWSER_SUPPORTED_IMAGE_ENCODING_STRINGS=c.DDS_ENCODING_STRING=void 0;c.DDS_ENCODING_STRING="image/vnd-ms.dds";c.BROWSER_SUPPORTED_IMAGE_ENCODING_STRINGS=["image/jpeg","image/png"];c.extractWkid=F;c.selectEncoding=function(a,b){if(b)for(b=0;b<a.length;b++)if(a[b].encoding===
c.DDS_ENCODING_STRING)return a[b];for(b=0;b<a.length;b++)if(-1<c.BROWSER_SUPPORTED_IMAGE_ENCODING_STRINGS.indexOf(a[b].encoding))return a[b];return null};c.findIntersectingNodes=function(a,b,d,c,e,g){e.traverse(d,function(d){var f=d.mbs;b!==c&&(f=pa,t.mbsToMbs(d.mbs,c,f,b));f=O(a,f);if(0===f)return!1;g(d,f);return!0})};c.filterInPlace=function(a,b,d){for(var c=0,e=0,g=0;g<b.length&&c<a.length;g++)a[c]===b[g]&&(d(g)&&(a[e]=a[c],e++),c++);a.length=e};var v=ea.create();c.getClipAABB=function(a,b){if(0===
b.rotationScale[1]&&0===b.rotationScale[2]&&0===b.rotationScale[3]&&0===b.rotationScale[5]&&0===b.rotationScale[6]&&0===b.rotationScale[7])return v[0]=(a[0]-b.position[0])/b.rotationScale[0],v[1]=(a[1]-b.position[1])/b.rotationScale[4],v[2]=(a[2]-b.position[2])/b.rotationScale[8],v[3]=(a[3]-b.position[0])/b.rotationScale[0],v[4]=(a[4]-b.position[1])/b.rotationScale[4],v[5]=(a[5]-b.position[2])/b.rotationScale[8],v};var pa=da.vec4f64.create();c.intersectBoundingRectWithMbs=O;c.intersectBoundingBoxWithMbs=
function(a,b){var d=b[0],c=b[1],e=b[2];b=b[3];var g=a[0]-d,d=d-a[3],h=a[1]-c,c=c-a[4],l=a[2]-e;a=e-a[5];var e=Math.max(g,d,0),r=Math.max(h,c,0),k=Math.max(l,a,0),e=e*e+r*r+k*k;return e>b*b?0:0<e?1:-Math.max(g,d,h,c,l,a)>b?3:2};c.findFieldsCaseInsensitive=P;c.whenGraphicAttributes=function(a,b,d,c,e,g){!0===(g&&g.populateObjectId)&&(c=ka(c,d));if(0===b.length)return q.resolve(b);g=a.associatedLayer;var f=a.attributeStorageInfo;if(x.isSome(g)&&g.loaded)return la(g,b,d,c);if(f){b=e(b);if(!b)return q.reject(new p("scenelayer:features-not-loaded",
"Tried to query attributes for unloaded features"));var h=a.parsedUrl.path;return q.all(b.map(function(a){return ma(h,f,a.node,a.indices,c).then(function(b){for(var c=0;c<a.graphics.length;c++){var d=a.graphics[c],e=b[c];if(d.attributes)for(var f in d.attributes)f in e||(e[f]=d.attributes[f]);d.attributes=e}return a.graphics})})).then(E.flatten)}return q.reject(new p("scenelayer:no-attribute-source","This scene layer does not have a source for attributes available"))};var na=-Math.pow(2,15),oa=-Math.pow(2,
31);c.getCachedAttributeValue=S;c.getIndexCrs=T;c.getVertexCrs=U;c.getCacheKeySuffix=function(a,b){return b===t.SphericalECEFSpatialReference?"@ECEF":a.equals(b)?"":null!=b.wkid?"@"+b.wkid:null};c.checkSpatialReference=A;c.checkSpatialReferences=V;c.checkSceneLayerValid=function(a){var b;(b=null==a.store||null==a.store.defaultGeometrySchema)||(b=a.store.defaultGeometrySchema,b=!!(null!=b.geometryType&&"triangles"!==b.geometryType||null!=b.topology&&"PerAttributeArray"!==b.topology||null==b.vertexAttributes||
null==b.vertexAttributes.position));if(b)throw new p("scenelayer:unsupported-geometry-schema","The geometry schema of this scene layer is not supported.",{url:a.parsedUrl.path});};c.checkSceneLayerCompatibleWithView=function(a,b){V(a,b.spatialReference,b.viewingMode)};c.checkPointCloudLayerValid=function(a){var b;(b=null==a.store||null==a.store.defaultGeometrySchema)||(a=a.store.defaultGeometrySchema,b=!!(null==a.geometryType||"points"!==a.geometryType||null!=a.topology&&"PerAttributeArray"!==a.topology||
null!=a.encoding&&""!==a.encoding&&"lepcc-xyz"!==a.encoding||null==a.vertexAttributes||null==a.vertexAttributes.position));if(b)throw new p("pointcloud:unsupported-geometry-schema","The geometry schema of this point cloud scene layer is not supported.",{});};c.checkPointCloudLayerCompatibleWithView=function(a,b){A(a.spatialReference,b.spatialReference,b.viewingMode)};c.rendererNeedsTextures=function(a){if(null==a||"simple"!==a.type&&"class-breaks"!==a.type&&"unique-value"!==a.type||("unique-value"===
a.type||"class-breaks"===a.type)&&null==a.defaultSymbol)return!0;a=a.getSymbols();if(0===a.length)return!0;for(var b=0;b<a.length;b++){var c=a[b];if("mesh-3d"!==c.type||0===c.symbolLayers.length)return!0;for(var e=0,c=c.symbolLayers.items;e<c.length;e++){var h=c[e];if("fill"!==h.type||x.isNone(h.material)||x.isNone(h.material.color)||"replace"!==h.material.colorMixMode)return!0}}return!1};c.transparentEdgeMaterial=N.createSolidEdgeMaterial({color:[0,0,0,0],opacity:0});var X=function(){return function(){this.material=
this.edgeMaterial=null;this.castShadows=!0}}();c.SymbolInfo=X;c.getSymbolInfo=function(a){var b=new X,c=!1,e=!1,h=0;for(a=a.symbolLayers.items;h<a.length;h++){var g=a[h];if("fill"===g.type&&g.enabled){var k=g.material,l=g.edges;x.isSome(k)&&!c&&(c=k.color,k=ja.parseColorMixMode(k.colorMixMode),x.isSome(c)?b.material={color:[c.r/255,c.g/255,c.b/255],alpha:c.a,colorMixMode:k}:b.material={color:[1,1,1],alpha:1,colorMixMode:1},b.castShadows=g.castShadows,c=!0);x.isSome(l)&&!e&&(b.edgeMaterial=N.createMaterialFromEdges(l,
{}),e=!0)}}b.material||(b.material={color:[1,1,1],alpha:1,colorMixMode:1});return b};c.addWraparound=function(a,b){return(a|0)+(b|0)|0};c.transformObb=W;c.computeVisibilityObb=function(a,b,c,f,k,g){if(!g||0===g.length)return null;var d=ia.computeGlobalTransformation(a.mbs,k,c,b);ba.mat4.invert(C,d);var l,m=function(){if(!l)if(l=H,w.empty(D),x.isSome(a.serviceObb)){W(a.serviceObb,c,Y,b,k);z.corners(Y,l);for(var d=0,f=l;d<f.length;d++){var g=f[d];h.vec3.transformMat4(g,g,C);w.expandPointInPlace(D,g)}}else for(g=
a.mbs,d=g[3],t.vectorToVector(g,c,e,b),h.vec3.transformMat4(e,e,C),e[2]+=k,f=0;8>f;++f){var m=f&1?d:-d,n=f&2?d:-d,p=f&4?d:-d,g=l[f];h.vec3.copy(g,[e[0]+m,e[1]+n,e[2]+p]);w.expandPointInPlace(D,g)}},n=Infinity,p=-Infinity,v=function(a){if("replace"===a.type&&(a=a.geometry,a.hasZ)){w.empty(I);var c=a.spatialReference||f;a=a.rings.reduce(function(a,d){return d.reduce(function(a,d){t.vectorToVector(d,c,e,b);h.vec3.transformMat4(e,e,C);w.expandPointInPlace(I,e);return Math.min(e[2],a)},a)},Infinity);m();
w.intersects(D,I)&&(n=Math.min(n,a),p=Math.max(p,a))}};g.forEach(function(a){return v(a)});if(Infinity===n)return null;g=function(a,b,c){h.vec3.transformMat4(e,c,d);a[b+0]=e[0];a[b+1]=e[1];a[b+2]=e[2];b+=24;c[2]=n;h.vec3.transformMat4(e,c,d);a[b+0]=e[0];a[b+1]=e[1];a[b+2]=e[2];b+=24;c[2]=p;h.vec3.transformMat4(e,c,d);a[b+0]=e[0];a[b+1]=e[1];a[b+2]=e[2]};for(var q=0;8>q;++q)g(Z.data,3*q,l[q]);return z.compute(Z)};var B=t.SphericalECEFSpatialReference,k=K.mat4f64.create(),n=ca.quatf32.create(),H=[[0,
0,0],[0,0,0],[0,0,0],[0,0,0],[0,0,0],[0,0,0],[0,0,0],[0,0,0]],I=w.create(),D=w.create(),Y=z.create(),e=[0,0,0],Z={data:Array(72),size:3,offsetIdx:0,strideIdx:3},C=K.mat4f64.create()});