// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.17/esri/copyright.txt for details.
//>>built
define("require exports ../../../Camera ../../../Viewpoint ../../../core/Error ../../../core/maybe ../../../core/promiseUtils ../../../core/watchUtils ../camera/constraintUtils ./controllers/PointToPointAnimationController ./controllers/SurfaceCollisionCorrectionController ../support/cameraUtils ../support/viewpointUtils ../../animation/easing".split(" "),function(h,e,p,q,f,d,g,r,n,m,t,u,v,w){Object.defineProperty(e,"__esModule",{value:!0});e.GoToOperation=void 0;h=function(){function c(a,b,x){var c=
this;this.target=a;this.options=b;this.view=x;this.state="pending";this.animationController=this.abortController=null;this.promise=g.create(function(a,b){c.resolveCallback=a;c.rejectCallback=b;a=g.createAbortController();if(d.isSome(c.options.signal))g.onAbort(c.options.signal,function(){c.abort()});c.abortController=a;c.waitForReady()})}c.prototype.then=function(a,b){return this.promise.then(a,b)};c.prototype.catch=function(a){return this.promise.catch(a)};c.prototype.resolve=function(a){this.state=
"finished";return this.resolveCallback(a)};c.prototype.reject=function(a){this.state="finished";return this.rejectCallback(a)};c.prototype.goTo=function(a,b){switch(this.state){case "pending":case "wait-for-ready":case "wait-for-viewpoint":case "wait-for-animation-finish":b.animate&&this.options.animate?this.reject(new f("AbortError")):this.abort()}return new c(a,b,this.view)};c.prototype.waitForReady=function(){var a=this;this.state="wait-for-ready";this.view.stateManager.view.ready?this.createViewPoint():
r.whenOnce(this.view.stateManager.view,"ready",this.abortController.signal).then(function(){a.createViewPoint()},function(b){a.reject(b)})};c.prototype.createViewPoint=function(){var a=this;"finished"!==this.state&&(this.state="wait-for-viewpoint",this.animationController=this.options.animate?this.getAnimationController():null,v.create(this.view.stateManager.view,this.target,this.abortController.signal).then(function(b){"finished"!==a.state&&(b=a.getCameraFromViewpoint(b),d.isNone(b)||(a.options.animate?
d.isNone(a.animationController)||a.startAnimation(b,a.animationController):(a.view.stateManager.setStateCamera(b.camera,{applyConstraints:!b.isFullySpecified,positionAndOrientationOnly:!0,doNotCancelGoToOperation:!0}),a.resolve())))},function(b){a.reject(b)}))};c.prototype.internalAnimateOptions=function(a){var b={};a&&(null!=a.speedFactor&&(b.speedFactor=a.speedFactor),null!=a.duration&&(b.duration=a.duration/1E3),null!=a.maxDuration&&(b.maxDuration=a.maxDuration/1E3),null!=a.easing&&(b.easing="string"===
typeof a.easing?w.named[a.easing]:a.easing));return b};c.prototype.getCameraFromViewpoint=function(a){var b=!!(this.target instanceof q&&this.target.camera||this.target instanceof p),c=a.camera;if(!this.view.stateManager.isCompatible(c))return a=(a=c.position)&&a.spatialReference,this.reject(new f("GotoAnimation:incompatible-spatialreference","Resulting camera has an incompatible spatial reference (camera: "+(a?a.wkid:"none")+", view: "+this.view.stateManager.view.spatialReference.wkid+")",{camera:c})),
null;c=u.externalToInternal(this.view.stateManager.view,c);return c?{viewpoint:a,camera:c,isFullySpecified:b}:(this.reject(new f("GotoAnimation:invalid-camera","Resulting camera is invalid")),null)};c.prototype.startAnimation=function(a,b){var c=this;this.state="wait-for-animation-finish";var e=b.viewAnimation;if(d.isNone(e))this.reject(new f("GotoAnimation:missing-animation","Unreachable code in view.stateManager"));else{e.update(a.viewpoint,"running");var g=function(){return c.view.stateManager.view.state.cameraController===
b&&d.isSome(b.viewAnimation)&&b.viewAnimation.target===a.viewpoint&&b.active};if(g()){var l;a.isFullySpecified?(l=new t.SurfaceCollisionCorrectionController({view:this.view.stateManager.view,desiredCamera:a.camera}),n.applySurfaceCollisionConstraint(this.view.stateManager.view,a.camera,1)):n.applyAll(this.view.stateManager.view,a.camera);b.begin(a.camera,this.internalAnimateOptions(this.options));var h=function(){var k=c.view.stateManager.view.state.cameraController;l&&(k&&k.active?k instanceof m.PointToPointAnimationController&&
d.isSome(k.viewAnimation)&&k.viewAnimation.target===a.viewpoint&&(c.view.stateManager.view.state.cameraController=l):d.isSome(b.viewAnimation)&&b.viewAnimation.target===a.viewpoint&&"finished"===b.state&&(c.view.stateManager.view.state.cameraController=l))};e.when(h,function(a){d.isNone(c.view.stateManager.view.state)||(h(),g()&&c.reject(a))});b.asyncResult={resolve:function(){c.resolve()},reject:function(a){d.isNone(c.view.stateManager.view.state)||g()&&c.reject(a)}}}}};c.prototype.getAnimationController=
function(){var a,b=null,b=this.view.stateManager.view.state.cameraController;b instanceof m.PointToPointAnimationController&&(b.updateStateFromViewAnimation(),b.active&&(a=b,b=a.viewAnimation));return null!=a||(a=new m.PointToPointAnimationController({view:this.view.stateManager.view,mode:"animation"}),b=a.viewAnimation,this.view.stateManager.view.state.switchCameraController(a))?a:(d.isSome(b)&&b.stop(),this.reject(new f("GotoAnimation:goto-cannot-interrupt","Cannot start an animation while interacting")),
null)};c.prototype.abort=function(){switch(this.state){case "pending":case "wait-for-ready":case "wait-for-viewpoint":this.reject(new f("AbortError"));break;case "wait-for-animation-finish":d.isSome(this.animationController)&&this.view.stateManager.view.state.cameraController===this.animationController&&this.animationController.active&&this.animationController.stopController(),this.reject(new f("AbortError"))}};return c}();e.GoToOperation=h});