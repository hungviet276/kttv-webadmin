// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.17/esri/copyright.txt for details.
//>>built
define("require exports tslib ../../../../core/CircularArray ../../../../core/has ../../../../core/maybe ../../../../core/libs/gl-matrix-2/mat2d ../../../../core/libs/gl-matrix-2/mat2df32 ../../../../core/libs/gl-matrix-2/vec2 ../../../../core/libs/gl-matrix-2/vec2f32 ./definitions ./DirtyMap ./DisplayRecordStore ./enums ./Fader ./TiledDisplayObject ./WGLBuffers".split(" "),function(z,v,C,D,L,A,w,E,F,G,n,B,x,H,I,J,K){Object.defineProperty(v,"__esModule",{value:!0});v.WGLTile=void 0;var y=new Set;
z=function(u){function d(a,b,h){void 0===h&&(h=!1);a=u.call(this,a,b,[n.TILE_SIZE,n.TILE_SIZE])||this;a._data=null;a._displayList=null;a._wglBuffers=null;a._deferPatches=!1;a._dirtyMap=new B.default;a._labelIndex=null;a._lastCommitTime=0;a._patchQueue=new D.default(100);a.fader=new I.default;a._dirty=!0;a._replaceBuffers=!1;a._uploadsLocked=!1;a._hasData=!1;a._invalidated=!1;a.transforms.labelMat2d=E.mat2df32.create();a._ensureCorrectZOrder=h;a._deferPatches=!h;return a}C.__extends(d,u);d.prototype.destroy=
function(){u.prototype.destroy.call(this);this.clear()};Object.defineProperty(d.prototype,"displayObjects",{get:function(){var a;return null!==(a=this._displayObjects)&&void 0!==a?a:[]},enumerable:!1,configurable:!0});Object.defineProperty(d.prototype,"isDirty",{get:function(){return this._dirty},set:function(a){this._dirty=a;this.requestRender()},enumerable:!1,configurable:!0});Object.defineProperty(d.prototype,"hasData",{get:function(){return!!this._hasData},enumerable:!1,configurable:!0});Object.defineProperty(d.prototype,
"labelIndex",{get:function(){return this._labelIndex},enumerable:!1,configurable:!0});d.prototype.getGeometry=function(a){return this._wglBuffers&&this._wglBuffers.has(a)?this._wglBuffers.get(a):null};d.prototype.getDisplayList=function(){return this._displayList};d.prototype.setTransform=function(a,b){u.prototype.setTransform.call(this,a,b);var h=this.transforms.labelMat2d;b=a.getScreenTransform(h,b);var d=G.vec2f32.create();F.vec2.transformMat2d(d,this.coords,b);w.mat2d.identity(h);w.mat2d.translate(h,
h,d);w.mat2d.multiply(h,a.viewMat2d,h)};d.prototype.setData=function(a){var b=a.addOrUpdate,h=a.remove;a.clear&&(this.clear(),this._patchQueue.clear(),this._hasData=!1);"replace"===a.type&&(this._replaceBuffers=!0,this._patchQueue.clear(),this._data=null);!this._data&&b&&b.tileDisplayData.displayObjects.length?(b.tileDisplayData.computeDisplayList(this._ensureCorrectZOrder),this._dirtyMap=new B.default,this._dispRecStore=x.default.fromTileData(b,this._dirtyMap),this._data=b,this._dirtyMap.markAllDirty(),
this._hasData=!0,a.end&&this.ready()):this._data?b&&b.tileDisplayData.displayObjects.length||h.length?this._deferPatches?this._patchQueue.enqueue(a):this._doPatchData(a):a.end&&this.ready():a.end&&this.ready();a.end&&!this._data&&this.clear();this.requestRender();this.emit("change")};d.prototype.lockUploads=function(){this._uploadsLocked=!0};d.prototype.unlockUploads=function(){this._uploadsLocked=!1;this.requestRender()};d.prototype.commitChanges=function(a){if(!a.time||a.time!==this._lastCommitTime){this._lastCommitTime=
a.time;this.fader.step()||this.requestRender();if(this._patchQueue.size){var b=this._patchQueue.dequeue();A.isSome(b)&&(b.end&&this.ready(),this._doPatchData(b),this.requestRender(),this._hasData=!0)}if(this._uploadsLocked)this.requestRender();else if(this.visible&&this._data){if(this._replaceBuffers)for(this._wglBuffers&&this._wglBuffers.dispose(),this._wglBuffers=null,this._replaceBuffers=!1;this._patchQueue.size;)b=this._patchQueue.dequeue(),A.isSome(b)&&(b.end&&this.ready(),this._doPatchData(b),
this._hasData=!0);this._wglBuffers||(this._wglBuffers=new K.default(a.context));if(this._dirtyMap.hasDirty()||this._invalidated)this._invalidated=!1,this._wglBuffers.upload(this._data.tileBufferData,this._dirtyMap),this._displayList=this._data.tileDisplayData.displayList.clone(),this._displayObjects=this._data.tileDisplayData.displayObjects.slice(),this._rebuildLabelIndex(),this._dirtyMap.markAllClean()}}};d.prototype.clear=function(){this._dispRecStore=this._displayList=this._data=null;this._wglBuffers&&
(this._wglBuffers.dispose(),this._wglBuffers=null)};d.prototype._doPatchData=function(a){try{if("new"===a.type){if(!a.addOrUpdate)return;this._invalidated=!0;var b=this._bulkAddFeatures(a);b&&(this._dirtyMap.markAllDirty(),this._data.reshuffleV2(a,b.objectIndex,b.recordIndex),this._dispRecStore=x.default.fromTileData(this._data,this._dirtyMap))}else this._invalidated=!0,this._patchData(a)||(this._dirtyMap.markAllDirty(),this._data.reshuffle(),this._dispRecStore=x.default.fromTileData(this._data,this._dirtyMap))}catch(h){}this.requestRender()};
d.prototype._rebuildLabelIndex=function(){var a,b;if(null!==(b=null===(a=this._data)||void 0===a?void 0:a.tileBufferData.geometries[H.WGLGeometryType.LABEL])&&void 0!==b&&b.indexBuffer.length)for(this.isDirty=!0,this._labelIndex=this._initLabelIndex(),a=0,b=this.displayObjects;a<b.length;a++)for(var h=0,d=b[a].metrics;h<d.length;h++)this._insertIntoLabelIndex(d[h])};d.prototype._insertIntoLabelIndex=function(a){0>a.xBucket||0>a.yBucket||3<a.yBucket||3<a.xBucket||this.labelIndex[a.yBucket][a.xBucket].push(a)};
d.prototype._initLabelIndex=function(){for(var a=[],b=0;b<n.TILE_SIZE/n.COLLISION_BUCKET_SIZE;b++){a.push([]);for(var h=0;h<n.TILE_SIZE/n.COLLISION_BUCKET_SIZE;h++)a[b].push([])}return a};d.prototype._bulkAddFeatures=function(a){for(var b=a.addOrUpdate.tileDisplayData.displayObjects,h=this._data.tileDisplayData.displayObjects,d=0;d<b.length;d++){for(var c=b[d],g=0;g<c.displayRecords.length;++g){var m=c.displayRecords[g];if(!this._dispRecStore.tryAddMeshData(m,a.addOrUpdate.tileBufferData.geometries[m.geometryType]))return{objectIndex:d,
recordIndex:g}}this._data.tileDisplayData.hasRegistry&&this._data.tileDisplayData.displayObjectRegistry.set(c.id,c);h.push(c)}return null};d.prototype._patchData=function(a){for(var b=!0,d=a.addOrUpdate&&a.addOrUpdate.tileDisplayData&&a.addOrUpdate.tileDisplayData.displayObjects||[],r=(a.remove||[]).slice(),c=0;c<d.length;c++){var g=d[c];null!=g.insertAfter&&r.push(g.id)}for(g=0;g<r.length;g++){var m=r[g];if(c=this._data.tileDisplayData.displayObjectRegistry.get(m)){this._data.tileDisplayData.displayList.removeFromList(c.displayRecords);
for(var l=0,e=c.displayRecords;l<e.length;l++)this._dispRecStore.delete(e[l]);this._data.tileDisplayData.displayObjectRegistry.delete(m);c=this._data.tileDisplayData.displayObjects.indexOf(c);this._data.tileDisplayData.displayObjects.splice(c,1)}}for(r=0;r<d.length;r++){g=d[r];c=this._data.tileDisplayData.displayObjectRegistry.get(g.id);m=void 0;if(c){l=c.displayRecords;c.set(g);c.displayRecords=l;l=c.displayRecords.length;for(e=0;e<l;++e){var f=c.displayRecords[e],k=g.displayRecords[e];if(e>=g.displayRecords.length||
f.geometryType!==k.geometryType||f.symbolLevel!==k.symbolLevel||f.zOrder!==k.zOrder||f.materialKey!==k.materialKey)this._dispRecStore.delete(c.displayRecords[e]),e<g.displayRecords.length&&(c.displayRecords[e]=void 0)}c.displayRecords.length=g.displayRecords.length;c.metrics=g.metrics}else if(c=g.copy(),c.displayRecords=[],this._data.tileDisplayData.displayObjectRegistry.set(g.id,c),e=void 0,f=this._data.tileDisplayData.displayObjects,null!=c.insertAfter?(m={},0<=c.insertAfter?(l=this._data.tileDisplayData.displayObjectRegistry.get(c.insertAfter))?
(e=f.indexOf(l)+1,e<f.length?f.splice(e,0,c):(f.push(c),e=f.length)):(f.push(c),e=f.length):(f.unshift(c),e=0)):(f.push(c),e=f.length),m){k=void 0;if(this._data.tileDisplayData.displayList.unified)k=0<g.displayRecords.length?1:0;else{y.clear();for(var k=0,p=g.displayRecords;k<p.length;k++)l=this._data.tileDisplayData.displayList.getDPInfoType(p[k].geometryType),y.add(l);k=y.size}p=0;for(--e;0<=e&&p<k;--e)for(var q=f[e].displayRecords.length-1;0<=q&&p<k;--q){var t=f[e].displayRecords[q],l=this._data.tileDisplayData.displayList.getDPInfoType(t.geometryType);
m[l]||(m[l]=t,++p)}}p=g.displayRecords.length;for(e=0;e<p;++e){k=g.displayRecords[e];(f=c.displayRecords[e])?(f.meshData=k.meshData,f.materialKey=k.materialKey):(f=k.copy(),f.vertexFrom=void 0,f.indexFrom=void 0,c.displayRecords[e]=f);var q=k.geometryType,l=this._data.tileDisplayData.displayList.getDPInfoType(q),t=a.addOrUpdate.tileBufferData.geometries[q],q=t.vertexBuffer,t=t.indexBuffer,n=void 0;m&&(n=m[l]?this._data.tileDisplayData.displayList.splitAfter(m[l]):-1);b=this._dispRecStore.setMeshData(f,
k,q,t,n)&&b;m&&null!=f.indexFrom&&null!=f.indexFrom&&(m[l]=f)}}return b};return d}(J.TiledDisplayObject);v.WGLTile=z});