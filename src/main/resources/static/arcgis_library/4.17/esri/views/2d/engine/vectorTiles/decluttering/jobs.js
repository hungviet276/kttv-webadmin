// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.17/esri/copyright.txt for details.
//>>built
define(["require","exports","../../../../../core/libs/gl-matrix-2/mat3f32","./config","./util"],function(z,e,F,I,J){Object.defineProperty(e,"__esModule",{value:!0});e.CollisionJob=void 0;z=function(){function e(A,c,f,k,d,g){this._symbols=A;this._layers=k;this._zoom=d;this._currentSymbolCursor=this._currentLayerCursor=0;this._styleProps=new Map;this._allNeededMatrices=new Map;this._gridIndex=new J.GridIndex(c,f,I.COLLISION_GRID_CELL_SIZE);this._si=Math.sin(Math.PI*g/180);this._co=Math.cos(Math.PI*
g/180);for(c=0;c<A.length;c++)for(f=0,k=A[c].symbols;f<k.length;f++)d=k[f],this._allNeededMatrices.has(d.tile)||this._allNeededMatrices.set(d.tile,F.mat3f32.clone(d.tile.transforms.tileUnitsToPixels))}e.prototype.work=function(A){for(var c=this._gridIndex,f=performance.now();this._currentLayerCursor<this._symbols.length;this._currentLayerCursor++,this._currentSymbolCursor=0)for(var k=this._symbols[this._currentLayerCursor],d=this._getProperties(k.layerIndex);this._currentSymbolCursor<k.symbols.length;this._currentSymbolCursor++){if(99===
this._currentSymbolCursor%100&&performance.now()-f>A)return!1;var g=k.symbols[this._currentSymbolCursor];if(g.unique.show){for(var n=g,q=this._si,r=this._co,b=this._allNeededMatrices.get(g.tile),p=this._zoom,e=d.iconRotationAlignment,t=d.textRotationAlignment,v=d.iconTranslate,l=d.iconTranslateAnchor,m=d.textTranslate,B=d.textTranslateAnchor,w=0,x=0,E=n.colliders;x<E.length;x++){var a=E[x],h=0===a.partIndex?v:m,C=h[0],h=h[1],D=0===a.partIndex?l:B,y=a.minLod<=p&&p<=a.maxLod,w=w+(y?0:1);a.enabled=y;
a.xScreen=a.xTile*b[0]+a.yTile*b[3]+b[6];a.yScreen=a.xTile*b[1]+a.yTile*b[4]+b[7];0===D?(a.xScreen+=r*C-q*h,a.yScreen+=q*C+r*h):(a.xScreen+=C,a.yScreen+=h);1===(0===a.partIndex?e:t)?(a.dxScreen=a.dxPixels,a.dyScreen=a.dyPixels):(a.dxScreen=r*(a.dxPixels+a.width/2)-q*(a.dyPixels+a.height/2)-a.width/2,a.dyScreen=q*(a.dxPixels+a.width/2)+r*(a.dyPixels+a.height/2)-a.height/2)}0<n.colliders.length&&w===n.colliders.length&&(n.unique.show=!1);n=g.unique;if(n.show){e=d.iconAllowOverlap;q=d.iconIgnorePlacement;
t=d.textAllowOverlap;r=d.textIgnorePlacement;v=0;for(l=g.colliders;v<l.length;v++)if(b=l[v],b.enabled&&(p=n.parts[b.partIndex],p.show)){if(m=!(b.partIndex?t:e))a:{m=b.xScreen+b.dxScreen;B=b.yScreen+b.dyScreen;w=m+b.width;x=B+b.height;h=c.getCellSpan(m,B,w,x);E=h[0];a=h[2];C=h[3];for(h=h[1];h<=C;h++)for(D=E;D<=a;D++)for(var y=0,z=c.cells[h][D];y<z.length;y++){var u=z[y],G=u.xScreen+u.dxScreen,H=u.yScreen+u.dyScreen,F=G+u.width,u=H+u.height;if(!(w<G||m>F||x<H||B>u)){m=!0;break a}}m=!1}m&&(b.hard?n.show=
!1:p.show=!1)}if(n.show)for(e=0,g=g.colliders;e<g.length;e++)if(b=g[e],b.enabled&&(b.partIndex?!r:!q)&&(p=n.parts[b.partIndex],p.show))for(p=b.xScreen+b.dxScreen,t=b.yScreen+b.dyScreen,l=this._gridIndex.getCellSpan(p,t,p+b.width,t+b.height),p=l[0],t=l[2],v=l[3],l=l[1];l<=v;l++)for(m=p;m<=t;m++)this._gridIndex.cells[l][m].push(b)}}}return!0};e.prototype._getProperties=function(e){var c=this._styleProps.get(e);if(c)return c;var c=this._zoom,f=this._layers[e],k=1===f.getLayoutValue("symbol-placement",
c),d=f.getLayoutValue("icon-rotation-alignment",c);2===d&&(d=k?0:1);var g=f.getLayoutValue("text-rotation-alignment",c);2===g&&(g=k?0:1);var k=f.getPaintValue("icon-translate",c),n=f.getPaintValue("icon-translate-anchor",c),q=f.getPaintValue("text-translate",c),r=f.getPaintValue("text-translate-anchor",c),c={iconAllowOverlap:f.getLayoutValue("icon-allow-overlap",c),iconIgnorePlacement:f.getLayoutValue("icon-ignore-placement",c),textAllowOverlap:f.getLayoutValue("text-allow-overlap",c),textIgnorePlacement:f.getLayoutValue("text-ignore-placement",
c),iconRotationAlignment:d,textRotationAlignment:g,iconTranslateAnchor:n,iconTranslate:k,textTranslateAnchor:r,textTranslate:q};this._styleProps.set(e,c);return c};return e}();e.CollisionJob=z});