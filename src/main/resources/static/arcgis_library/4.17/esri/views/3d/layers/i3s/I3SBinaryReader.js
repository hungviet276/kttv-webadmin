// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.17/esri/copyright.txt for details.
//>>built
define("require exports tslib ../../../../core/Error ../../../../core/lang ../../../../core/Logger ./LEPCC".split(" "),function(H,c,n,h,E,F,v){function G(a,b,d){for(var l="",e=0;e<d;){var f=a[b+e];if(128>f)l+=String.fromCharCode(f),e++;else if(192<=f&&224>f){if(e+1>=d)throw new h("utf8-decode-error","UTF-8 Decode failed. Two byte character was truncated.");var g=a[b+e+1],f=(f&31)<<6|g&63,l=l+String.fromCharCode(f),e=e+2}else if(224<=f&&240>f){if(e+2>=d)throw new h("utf8-decode-error","UTF-8 Decode failed. Multi byte character was truncated.");
var g=a[b+e+1],c=a[b+e+2],f=(f&15)<<12|(g&63)<<6|c&63,l=l+String.fromCharCode(f),e=e+3}else if(240<=f&&248>f){if(e+3>=d)throw new h("utf8-decode-error","UTF-8 Decode failed. Multi byte character was truncated.");g=a[b+e+1];c=a[b+e+2];f=(f&7)<<18|(g&63)<<12|(c&63)<<6|a[b+e+3]&63;l=65536<=f?l+String.fromCharCode((f-65536>>10)+55296,(f&1023)+56320):l+String.fromCharCode(f);e+=4}else throw new h("utf8-decode-error","UTF-8 Decode failed. Invalid multi byte sequence.");}return l}function q(a,b){for(var d=
{byteOffset:0,byteCount:0,fields:Object.create(null)},l=0,e=0;e<b.length;e++){var f=b[e],g=f.valueType||f.type;d.fields[f.property]=(0,c.valueType2ArrayBufferReader[g])(a,l);l+=c.valueType2TypedArrayClassMap[g].BYTES_PER_ELEMENT}d.byteCount=l;return d}function w(a,b,d){var c=[],e,f=0,g;for(g=0;g<a;g+=1){e=b[g];if(0<e){if(c.push(G(d,f,e-1)),0!==d[f+e-1])throw new h("string-array-error","Invalid string array: missing null termination.");}else c.push(null);f+=e}return c}function r(a,b){return new c.valueType2TypedArrayClassMap[b.valueType](a,
b.byteOffset,b.count*b.valuesPerElement)}function x(a,b){return new Uint8Array(a,b.byteOffset,b.byteCount)}function y(a,b,d){a=null!=b.header?q(a,b.header):{byteOffset:0,byteCount:0,fields:{count:d}};d={header:a,byteOffset:a.byteCount,byteCount:0,entries:Object.create(null)};for(var c=a.byteCount,e=0;e<b.ordering.length;e++){var f=b.ordering[e],g=E.clone(b[f]);g.count=a.fields.count;if("String"===g.valueType){if(g.byteOffset=c,g.byteCount=a.fields[f+"ByteCount"],"UTF-8"!==g.encoding)throw new h("unsupported-encoding",
"Unsupported String encoding.",{encoding:g.encoding});}else if(t(g.valueType)){var k=p(g.valueType),c=c+(0!==c%k?k-c%k:0);g.byteOffset=c;g.byteCount=k*g.valuesPerElement*g.count}else throw new h("unsupported-value-type","Unsupported binary valueType",{valueType:g.valueType});c+=g.byteCount;d.entries[f]=g}d.byteCount=c-d.byteOffset;return d}function z(a,b,d){b!==a&&u.error("Invalid "+d+" buffer size\n expected: "+a+", actual: "+b+")");if(b<a)throw new h("buffer-too-small","Binary buffer is too small",
{expectedSize:a,actualSize:b});}function A(a){return{isDraco:!1,isLegacy:!1,color:null!=a.color,normal:null!=a.normal,uv0:null!=a.uv0,uvRegion:null!=a.uvRegion,featureIndex:null!=a.faceRange&&null!=a.featureId}}function B(a){for(var b={isDraco:!1,isLegacy:!0,color:!1,normal:!1,uv0:!1,uvRegion:!1,featureIndex:!1},d=0,c=a.ordering;d<c.length;d++){var e=c[d];if(a.vertexAttributes[e])switch(e){case "normal":b.normal=!0;break;case "color":b.color=!0;break;case "uv0":b.uv0=!0;break;case "region":b.uvRegion=
!0}}a.featureAttributes&&a.featureAttributeOrder&&(b.featureIndex=!0);return b}function C(a){for(var b={isDraco:!0,isLegacy:!1,color:!1,normal:!1,uv0:!1,uvRegion:!1,featureIndex:!1},d=0;d<a.length;d++)switch(a[d]){case "normal":b.normal=!0;break;case "uv0":b.uv0=!0;break;case "color":b.color=!0;break;case "uv-region":b.uvRegion=!0;break;case "feature-index":b.featureIndex=!0}return b}function t(a){return c.valueType2TypedArrayClassMap.hasOwnProperty(a)}function p(a){return t(a)?c.valueType2TypedArrayClassMap[a].BYTES_PER_ELEMENT:
0}Object.defineProperty(c,"__esModule",{value:!0});c.getBytesPerValue=c.isValueType=c.valueType2ArrayBufferReader=c.valueType2TypedArrayClassMap=c.readBinaryAttribute=c.createGeometryDescriptorForDraco=c.createGeometryDescriptorFromSchema=c.createGeometryDescriptor=c.createGeometryIndexFromSchema=c.createGeometryDescriptorFromDefinition=c.createAttributeDataIndex=c.createRawView=c.createTypedView=c.readStringArray=c.readHeader=void 0;var u=F.getLogger("esri.views.3d.layers.i3s.I3SBinaryReader");c.readHeader=
q;c.readStringArray=w;c.createTypedView=r;c.createRawView=x;c.createAttributeDataIndex=y;c.createGeometryDescriptorFromDefinition=A;c.createGeometryIndexFromSchema=function(a,b){for(var d=q(a,b&&b.header),c=d.byteCount,e={isDraco:!1,header:d,byteOffset:d.byteCount,byteCount:0,vertexAttributes:{}},f=d.fields,g=null!=f.vertexCount?f.vertexCount:f.count,k=0,m=b.ordering;k<m.length;k++){var h=m[k];b.vertexAttributes[h]&&(d=n.__assign(n.__assign({},b.vertexAttributes[h]),{byteOffset:c,count:g}),e.vertexAttributes[D[h]?
D[h]:"_"+h]=d,c+=p(d.valueType)*d.valuesPerElement*g)}g=f.faceCount;if(b.faces&&g)for(e.faces={},k=0,m=b.ordering;k<m.length;k++)h=m[k],b.faces[h]&&(d=n.__assign(n.__assign({},b.faces[h]),{byteOffset:c,count:g}),e.faces[h]=d,c+=p(d.valueType)*d.valuesPerElement*g);f=f.featureCount;if(b.featureAttributes&&b.featureAttributeOrder&&f)for(e.featureAttributes={},g=0,k=b.featureAttributeOrder;g<k.length;g++)m=k[g],b.featureAttributes[m]&&(d=n.__assign(n.__assign({},b.featureAttributes[m]),{byteOffset:c,
count:f}),e.featureAttributes[m]=d,m="UInt64"===d.valueType?8:p(d.valueType),c+=m*d.valuesPerElement*f);z(c,a.byteLength,"geometry");e.byteCount=c-e.byteOffset;return e};c.createGeometryDescriptor=function(a,b){return a&&a.compressedAttributes&&"draco"===a.compressedAttributes.encoding?C(a.compressedAttributes.attributes):a?A(a):B(b)};c.createGeometryDescriptorFromSchema=B;c.createGeometryDescriptorForDraco=C;var D={position:"position",normal:"normal",color:"color",uv0:"uv0",region:"uvRegion"};c.readBinaryAttribute=
function(a,b,c){if("lepcc-rgb"===a.encoding)return v.decodeRGB(b);if("lepcc-intensity"===a.encoding)return v.decodeIntensity(b);if(null!=a.encoding&&""!==a.encoding)throw new h("unknown-attribute-storage-info-encoding","Unknown Attribute Storage Info Encoding");a["attributeByteCounts "]&&!a.attributeByteCounts&&(u.warn("Warning: Trailing space in 'attributeByteCounts '."),a.attributeByteCounts=a["attributeByteCounts "]);"ObjectIds"===a.ordering[0]&&a.hasOwnProperty("objectIds")&&(u.warn("Warning: Case error in objectIds"),
a.ordering[0]="objectIds");c=y(b,a,c);z(c.byteOffset+c.byteCount,b.byteLength,"attribute");if(a=c.entries.attributeValues||c.entries.objectIds){if("String"===a.valueType){c=c.entries.attributeByteCounts;var d=r(b,c);b=x(b,a);return w(c.count,d,b)}return r(b,a)}throw new h("bad-attribute-storage-info","Bad attributeStorageInfo specification.");};c.valueType2TypedArrayClassMap={Float32:Float32Array,Float64:Float64Array,UInt8:Uint8Array,Int8:Int8Array,UInt16:Uint16Array,Int16:Int16Array,UInt32:Uint32Array,
Int32:Int32Array};c.valueType2ArrayBufferReader={Float32:function(a,b){return(new DataView(a,0)).getFloat32(b,!0)},Float64:function(a,b){return(new DataView(a,0)).getFloat64(b,!0)},UInt8:function(a,b){return(new DataView(a,0)).getUint8(b)},Int8:function(a,b){return(new DataView(a,0)).getInt8(b)},UInt16:function(a,b){return(new DataView(a,0)).getUint16(b,!0)},Int16:function(a,b){return(new DataView(a,0)).getInt16(b,!0)},UInt32:function(a,b){return(new DataView(a,0)).getUint32(b,!0)},Int32:function(a,
b){return(new DataView(a,0)).getInt32(b,!0)}};c.isValueType=t;c.getBytesPerValue=p});