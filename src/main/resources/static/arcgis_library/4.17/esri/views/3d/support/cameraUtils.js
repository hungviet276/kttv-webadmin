// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.17/esri/copyright.txt for details.
//>>built
define("require exports tslib ../../../Camera ../../../core/Logger ../../../core/mathUtils ../../../core/promiseUtils ../../../core/libs/gl-matrix-2/vec3 ../../../core/libs/gl-matrix-2/vec3f64 ../../../geometry/Point ../../../geometry/SpatialReference ../../../geometry/support/geodesicConstants ../../../geometry/support/scaleUtils ../camera/intersectionUtils ./cameraUtilsPlanar ./cameraUtilsSpherical ./earthUtils ./ElevationProvider ./mathUtils ./pointUtils ./projectionUtils ../../support/spatialReferenceSupport".split(" "),
function(ia,c,B,E,S,y,T,k,n,q,u,F,U,V,J,K,W,L,M,p,G,X){function r(a){return"global"===a.viewingMode?K:J}function N(a,b,d){var e=a.state.camera,g=e.fovX,e=e.width/2/e.pixelRatio;"global"===a.viewingMode&&null!=d&&(b*=Math.cos(y.deg2rad(d)));b/=a.renderCoordsHelper.unitInMeters;return e/(96*39.37/b)/Math.tan(g/2)}function O(a,b,d){var e=a.state.camera;b=96*39.37/(e.width/2/e.pixelRatio/(b*Math.tan(e.fovX/2)));"global"===a.viewingMode&&(b/=Math.cos(y.deg2rad(d)));return b*=a.renderCoordsHelper.unitInMeters}
function P(a,b,d,e,g,f){if(v(f)){var c=H(f.signal);z(a,e.heading,e.tilt,b,d,g,c);c.resolver.promise.then(function(b){return f.resolver.resolve(A(a,b,e.fov))},function(a){return f.resolver.reject(a)})}else return b=z(a,e.heading,e.tilt,b,d,g),A(a,b,e.fov,f)}function Q(a,b,d,e,g){return r(a).directionToHeadingTilt(b,d,e,g)}function Y(a,b){return!!(a.basemapTerrain&&a.renderCoordsHelper.fromRenderCoords(b,t,a.spatialReference)&&L.getElevationAtPoint(a.elevationProvider,t)>t.z-1)}function Z(a,b,d){return B.__awaiter(this,
void 0,void 0,function(){var e;return B.__generator(this,function(g){switch(g.label){case 0:return a.renderCoordsHelper.fromRenderCoords(b,t,a.spatialReference)?[4,a.elevationProvider.queryElevation(t.x,t.y,t.z,t.spatialReference,"ground",d)]:[2,!1];case 1:return e=g.sent(),[2,e>t.z-1]}})})}function aa(a,b,d){return B.__awaiter(this,void 0,void 0,function(){var e,g;return B.__generator(this,function(f){switch(f.label){case 0:e=n.vec3f64.create();if(b)return[3,1];k.vec3.copy(e,a.state.camera.center);
return[3,5];case 1:if(!(b instanceof q))return[3,4];p.pointToVector(b,e,a.renderSpatialReference);return null!=b.z||null==a.basemapTerrain?[3,3]:[4,a.elevationProvider.queryElevation(b.x,b.y,b.z,b.spatialReference,"ground",d)];case 2:return g=f.sent(),null!=g&&a.renderCoordsHelper.setAltitude(g,e),[2,e];case 3:return[3,5];case 4:k.vec3.copy(e,b),f.label=5;case 5:return[2,e]}})})}function ba(a,b){var d=n.vec3f64.create();b&&b instanceof q?(p.pointToVector(b,d,a.renderSpatialReference),null==b.z&&null!=
a.basemapTerrain&&(b=L.getElevationAtPoint(a.elevationProvider,b),null!=b&&a.renderCoordsHelper.setAltitude(b,d))):b?k.vec3.copy(d,b):k.vec3.copy(d,a.state.camera.center);return d}function z(a,b,d,e,g,f,c){var x=e&&e instanceof q?e:null;if(v(c))aa(a,e,c.signal).then(function(e){I(a,b,d,x,e,g,f,c)},function(a){return c.resolver.reject(a)});else return e=ba(a,e),I(a,b,d,x,e,g,f,c)}function I(a,b,d,e,g,c,x,l){e||(e=p.vectorToPoint(g,a.renderSpatialReference,a.spatialReference||u.WGS84));c=Math.max(c,
a.state.constraints.minimumPoiDistance);var f=ca(a,b,d,g,c,x),da=r(a).eyeForCenterWithHeadingTilt,h=da(g,c,f.heading,f.tilt);if(1===x&&"global"===a.viewingMode&&0<d){var k=function(){var f=c,h=c,m=a.state.constraints.tilt(h),h=r(a).eyeTiltToLookAtTilt(d,g,h),h=Math.min(h,.5*Math.PI),m=m.min*(1-C)+h*C,f=r(a).lookAtTiltToEyeTilt(m,g,f);x=1>d-f?0:1;return I(a,b,f,e,g,c,x,l)},f=a.map.ground.navigationConstraint;if(!f||"stay-above"===f.type){if(Y(a,h.eye))return k();if(v(l)){Z(a,h.eye,l.signal).then(function(a){if(a)return k();
l.resolver.resolve({eye:h.eye,up:h.up,center:n.vec3f64.clone(g),heading:h.heading,tilt:h.tilt})});return}}}f=!l||v(l)?{center:n.vec3f64.create(),eye:n.vec3f64.create(),up:n.vec3f64.create(),tilt:0,heading:0}:l;f.eye=h.eye;f.up=h.up;f.center=n.vec3f64.clone(g);f.heading=h.heading;f.tilt=h.tilt;v(l)&&l.resolver.resolve(f);return f}function ca(a,b,d,e,g,f){var c=0;if(f=1===f)if(c=a.pointsOfInterest.centerOnSurfaceFrequent.distance,8<Math.log(g/c)/Math.LN2)f=!0;else{var l=a.renderSpatialReference,m=a.spatialReference||
u.WGS84;f=p.vectorToPoint(e,l,m);l=p.vectorToPoint(a.pointsOfInterest.centerOnSurfaceFrequent.renderLocation,l,m);c*=Math.tan(.5*a.state.camera.fov);f=5<l.distance(f)/c}f?(b=0,f=a.state.constraints.tilt(g),f.max=Math.min(f.max,.5*Math.PI),f=f.min*(1-C)+f.max*C,d=r(a).eyeTiltToLookAtTilt(d,e,g),c=Math.min(d,f)):c=r(a).eyeTiltToLookAtTilt(d,e,g);d=c=a.state.constraints.clampTilt(g,c);d=r(a).lookAtTiltToEyeTilt(d,e,g);return{heading:b,tilt:d}}function A(a,b,d,e){a=p.vectorToPoint(b.eye,a.renderSpatialReference,
a.spatialReference||u.WGS84);return a?e?(e.position=a,e.heading=b.heading,e.tilt=b.tilt,e.fov=d,e):new E(a,b.heading,b.tilt,d):null}function H(a){return{resolver:T.createResolver(),signal:a}}function v(a){return a&&"resolver"in a}Object.defineProperty(c,"__esModule",{value:!0});c.isAsyncContext=c.createAsyncContext=c.computeScale=c.scaleToResolution=c.zoomToScale=c.scaleToZoom=c.observerToCamera=c.toExtent=c.fromExtent=c.getObserverForPointAtDistance=c.directionToHeadingTilt=c.fromCenterDistance=
c.fromCenterScale=c.distanceToScale=c.scaleToDistance=c.internalToExternal=c.externalToInternal=c.headingTiltToDirectionUp=void 0;var R=S.getLogger("esri.views.3d.support.cameraUtils"),w=n.vec3f64.create(),D=n.vec3f64.create(),ea=n.vec3f64.create(),fa={heading:0,tilt:0},t=new q,ga=new M.Cyclical(-2.0037508342788905E7,2.0037508342788905E7),ha=new M.Cyclical(-180,180);c.headingTiltToDirectionUp=function(a,b,d,e,c){return r(a).headingTiltToDirectionUp(b,d,e,c)};c.externalToInternal=function(a,b){var d=
a.renderSpatialReference,e=r(a).headingTiltToDirectionUp,c=n.vec3f64.create();if(!p.pointToVector(b.position,c,d))return null;d=e(c,b.heading,b.tilt);k.vec3.scale(d.direction,d.direction,a.state.camera.distance);k.vec3.add(d.direction,d.direction,c);a=V.cameraOnContentAlongViewDirection(a,c,d.direction,d.up);a.fov=y.deg2rad(b.fov);return a};c.internalToExternal=function(a,b,d){var e=a.renderSpatialReference,c=k.vec3.copy(ea,b.viewForward),c=Q(a,b.eye,c,b.up,fa);a=a.spatialReference||u.WGS84;G.vectorToVector(b.eye,
e,w,a)||(a=u.WGS84,G.vectorToVector(b.eye,e,w,a));if(!d)return new E(new q(w,a),c.heading,c.tilt,y.rad2deg(b.fov));d.position.x=w[0];d.position.y=w[1];d.position.z=w[2];d.position.spatialReference=a;d.heading=c.heading;d.tilt=c.tilt;d.fov=y.rad2deg(b.fov);return d};c.scaleToDistance=N;c.distanceToScale=O;c.fromCenterScale=function(a,b,c,e,g,f){c=N(a,c,b.latitude);return P(a,b,c,e,g,f)};c.fromCenterDistance=P;c.directionToHeadingTilt=Q;c.getObserverForPointAtDistance=z;c.fromExtent=function(a,b,c,
e,g,f){var d,l=0;null!=b.zmax&&null!=b.zmin&&(d=(b.zmax+b.zmin)/2,l=b.zmax-b.zmin);var m,k;if("global"===a.viewingMode){if(!X.isSpatialReferenceSupported(b.spatialReference,"global"))return v(f)&&f.resolver.reject(),null;var h=new q(b.xmin,b.ymin,b.spatialReference),n=new q(b.xmax,b.ymax,b.spatialReference),p=b.spatialReference.isGeographic?ha:ga;b=new q(p.center(h.x,n.x),(n.y+h.y)/2,b.spatialReference);null!=d&&(b.z=d);k=W.getGreatCircleSpanAt(b,h,n);m=k.lon;k=k.lat;p.diff(h.x,n.x)>p.range/2&&(m+=
F.halfEarthCircumference);m=Math.min(m,F.halfEarthCircumference);k=Math.min(k,F.halfEarthCircumference)}else h=a.spatialReference||u.WGS84,m=b.xmax-b.xmin,k=b.ymax-b.ymin,b=new q({x:b.xmin+.5*m,y:b.ymin+.5*k,z:d,spatialReference:h});d=a.state.camera;l=Math.max(1/Math.tan(d.fovX/2)*m*.5,1/Math.tan(d.fovY/2)*k*.5,1/Math.tan(d.fov/2)*l*.5)/1;if(v(f))m=H(f.signal),z(a,c,e,b,l,g,m),m.resolver.promise.then(function(b){return f.resolver.resolve(A(a,b,a.camera.fov))},function(a){return f.resolver.reject(a)});
else return c=z(a,c,e,b,l,g),A(a,c,a.camera.fov,f)};c.toExtent=function(a,b,c){var e=a.renderSpatialReference,d=k.vec3.dist(b.eye,c);c=p.vectorToPoint(c,e,a.spatialReference||u.WGS84);e=2*d*Math.tan(b.fovX/2)*1;b=2*d*Math.tan(b.fovY/2)*1;return"global"===a.viewingMode?K.toExtent(a,c,e,b):J.toExtent(a,c,e,b)};var C=.7;c.observerToCamera=A;c.scaleToZoom=function(a,b){if(a=a.basemapTerrain&&a.basemapTerrain.tilingScheme)return a.levelAtScale(b);R.error("#scaleToZoom()","Cannot compute zoom from scale without a tiling scheme")};
c.zoomToScale=function(a,b){if(a=a.basemapTerrain&&a.basemapTerrain.tilingScheme)return a.scaleAtLevel(b);R.error("#zoomToScale()","Cannot compute scale from zoom without a tiling scheme")};c.scaleToResolution=function(a,b){return a.spatialReference?U.getResolutionForScale(b,a.spatialReference):void 0};c.computeScale=function(a,b,c){var e=a.renderSpatialReference;b||(b=a.state.camera);var d;d=u.WGS84;b instanceof E?(d=b.position.latitude,p.pointToVector(b.position,w,e),p.pointToVector(c,D,e),b=k.vec3.distance(w,
D)):(G.vectorToVector(b.center,e,D,d),d=D[1],b=b.distance);return O(a,b,d)};c.createAsyncContext=H;c.isAsyncContext=v});