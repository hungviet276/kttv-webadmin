// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.17/esri/copyright.txt for details.
//>>built
define("require exports tslib ../../../../core/libs/gl-matrix-2/mat3 ../../../../core/libs/gl-matrix-2/mat3f32 ./RenderBucket ./decluttering/config ../webgl/TiledDisplayObject".split(" "),function(l,f,n,h,p,k,m,q){Object.defineProperty(f,"__esModule",{value:!0});f.VectorTile=void 0;l=function(f){function c(b,e,a,d){a=f.call(this,b,a,d,[4096,4096])||this;a._referenced=0;a._hasSymbolBuckets=!1;a._memoryUsedByLayerData=0;a.layerData={};a.layerCount=0;a.status="loading";a.allSymbolsFadingOut=!1;a.lastOpacityUpdate=
0;a.symbols=new Map;a.isCoverage=!1;a.neededForCoverage=!1;a.decluttered=!1;a.invalidating=!1;a._referenced=1;a.styleLayers=e;a.id=b.id;a.transforms.tileUnitsToPixels=p.mat3f32.create();return a}n.__extends(c,f);Object.defineProperty(c.prototype,"hasSymbolBuckets",{get:function(){return this._hasSymbolBuckets},enumerable:!1,configurable:!0});Object.defineProperty(c.prototype,"isFading",{get:function(){return this._hasSymbolBuckets&&performance.now()-this.lastOpacityUpdate<m.FADE_DURATION},enumerable:!1,
configurable:!0});Object.defineProperty(c.prototype,"isHoldingForFade",{get:function(){return this._hasSymbolBuckets&&(!this.allSymbolsFadingOut||performance.now()-this.lastOpacityUpdate<m.FADE_DURATION)},enumerable:!1,configurable:!0});Object.defineProperty(c.prototype,"wasRequested",{get:function(){return"errored"===this.status||"loaded"===this.status||"reloading"===this.status},enumerable:!1,configurable:!0});c.prototype.setData=function(b){this.changeDataImpl(b);this.requestRender();this.ready();
this.invalidating=!1};c.prototype.hasData=function(){return 0<this.layerCount};c.prototype.dispose=function(){c._destroyRenderBuckets(this.layerData);this.layerData={};this._memoryUsedByLayerData=this.layerCount=0;this.destroy()};c.prototype.release=function(){return 0===--this._referenced?(this.dispose(),this.stage=null,!0):!1};c.prototype.reference=function(){++this._referenced};Object.defineProperty(c.prototype,"referenced",{get:function(){return this._referenced},enumerable:!1,configurable:!0});
c.prototype.getMemoryUsage=function(){return this._memoryUsedByLayerData/(this._referenced||1)};c.prototype.changeDataImpl=function(b){c._destroyRenderBuckets(this.layerData);this.layerData={};this._memoryUsedByLayerData=this.layerCount=0;if(b){b=c._createRenderBuckets(b);for(var e in b)this.layerData[e]&&(this._memoryUsedByLayerData-=this.layerData[e].memoryUsed,this.layerData[e].destroy(),this.layerData[e]=null,this.layerCount--),this._memoryUsedByLayerData+=b[e].memoryUsed,this.layerData[e]=b[e],
this.layerCount++}b=new Map;this._hasSymbolBuckets=!1;for(var a in this.layerData){e=parseInt(a,10);var d=this.layerData[e];3===d.type&&(b.set(e,d.symbols),this._hasSymbolBuckets=!0)}this.symbols=b;this.emit("symbols-changed")};c.prototype.attachWithContext=function(b){this.stage={context:b,trashDisplayObject:function(b){b.processDetach()},untrashDisplayObject:function(){return!1}}};c.prototype.setTransform=function(b,e){f.prototype.setTransform.call(this,b,e);var a=e/(b.resolution*b.pixelRatio);
e=this.size[0]/this.coordRange[0]*a;var a=this.size[1]/this.coordRange[1]*a,d=b.toScreen([0,0],this.coords),c=d[0],d=d[1],g=this.transforms.tileUnitsToPixels;h.mat3.identity(g);h.mat3.translate(g,g,[c,d]);h.mat3.rotate(g,g,Math.PI*b.rotation/180);h.mat3.scale(g,g,[e,a,1])};c._destroyRenderBuckets=function(b){var c=new Set,a;for(a in b){var d=b[a];c.has(d)||(d.destroy(),c.add(d))}};c._createRenderBuckets=function(b){var c={},a=0;for(b=b.buckets;a<b.length;a++){var d=b[a],f=void 0;switch((new Uint32Array(d))[0]){case 1:f=
new k.FillRenderBucket(d);break;case 2:f=new k.LineRenderBucket(d);break;case 3:f=new k.SymbolRenderBucket(d);break;case 4:f=new k.CircleRenderBucket(d)}for(var d=0,g=f.layerIndices;d<g.length;d++)c[g[d]]=f}return c};return c}(q.TiledDisplayObject);f.VectorTile=l});