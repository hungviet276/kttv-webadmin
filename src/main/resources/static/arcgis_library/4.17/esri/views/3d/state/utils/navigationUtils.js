// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.17/esri/copyright.txt for details.
//>>built
define("require exports ../../../../core/mathUtils ../../../../core/screenUtils ../../../../core/libs/gl-matrix-2/mat4 ../../../../core/libs/gl-matrix-2/mat4f64 ../../../../core/libs/gl-matrix-2/vec2 ../../../../core/libs/gl-matrix-2/vec2f64 ../../../../core/libs/gl-matrix-2/vec3 ../../../../core/libs/gl-matrix-2/vec3f64 ../../../../geometry/support/geodesicConstants ../../support/geometryUtils ../../support/mathUtils ../../support/stack ../../support/geometryUtils/coordinateSystem ../../webgl-engine/lib/Camera".split(" "),
function(qa,d,p,ma,k,M,na,oa,e,h,R,m,y,w,B,pa){function N(a,c,b){var d=w.sm4d.get();k.mat4.identity(d);k.mat4.rotate(d,d,b[3],m.axisAngle.axis(b));e.vec3.subtract(a.eye,a.eye,c);e.vec3.transformMat4(a.eye,a.eye,d);e.vec3.add(a.eye,a.eye,c);e.vec3.subtract(a.center,a.center,c);e.vec3.transformMat4(a.center,a.center,d);e.vec3.add(a.center,a.center,c);e.vec3.transformMat4(a.up,a.up,d);a.markViewDirty()}function S(a,c){e.vec3.set(c,0,0,0);for(var b=0;b<a.length;b++)e.vec3.add(c,c,a[b]);e.vec3.scale(c,
c,1/a.length)}function T(a,c,b){return Math.sin(a/e.vec3.length(c))*(b+R.earthRadius)}function U(a,c,b,d){b=m.ray.fromScreenAtEye(c,b,V);m.sphere.closestPointOnSilhouette(a,b,E);return m.sphere.intersectRay(a,b,d)?e.vec3.squaredDistance(E,b.origin)<e.vec3.squaredDistance(d,b.origin)?(e.vec3.copy(d,E),!1):!0:(e.vec3.subtract(A,c.eye,c.center),e.vec3.normalize(A,A),m.plane.fromNormalAndOffset(A,-e.vec3.dot(e.vec3.normalize(A,A),E),W),m.plane.intersectRay(W,b,d),!1)}function X(a,c,b,z,f,g){e.vec3.cross(F,
a,c);e.vec3.subtract(G,a,c);e.vec3.length(a)<=f||!z.aboveGround?(e.vec3.cross(b,G,z.eye),a=e.vec3.dot(a,c)/(e.vec3.length(a)*e.vec3.length(c)),g=Math.cos(p.clamp(y.cyclicalPI.normalize(p.deg2rad(g)),0,d.TiltThresholdPanningSpeed)),c=-p.acosClamped(a)-Math.max(0,e.vec3.length(c)-f)/(g*f)):(e.vec3.subtract(Y,z.eye,z.center),e.vec3.cross(b,G,Y),c=-e.vec3.length(G)/f);e.vec3.normalize(b,b);e.vec3.scale(b,b,e.vec3.length(F));return c}function O(a,c,b,e){e=Math.cos(p.clamp(y.cyclicalPI.normalize(p.deg2rad(e)),
0,d.TiltThresholdPanningSpeed));c=c>b?-(c-b)/(e*b):c<-b?Math.PI-(c+b)/(e*b):p.acosClamped(c/b);return((a>b?-(a-b)/(e*b):a<-b?Math.PI-(a+b)/(e*b):p.acosClamped(a/b))-c)*b}function Z(a,c,b,d,f,g,n,l,h,k){h=O(a[2],c[2],n.radius,h);c=k?O(a[0],c[0],n.radius,180):c[0]-a[0];a=Math.sin(l)*c-Math.cos(l)*h;l=Math.cos(l)*c+Math.sin(l)*h;e.vec3.normalize(aa,f);f=k?a/Math.sqrt(Math.abs(Math.pow(n.radius,2)-Math.pow(e.vec3.dot(b,aa),2))):a/n.radius;b=l/Math.sqrt(Math.abs(Math.pow(n.radius,2)-Math.pow(e.vec3.dot(b,
d),2)));na.vec2.set(g,f,b)}function ba(a,c,b,d,f,g,n,l,h,k){e.vec3.cross(F,a,c);B.coordinateSystemFromOneAxisAndNormalVector(g.up,g.eye,H,I,J);B.coordinateSystemFromOneAxisAndNormalVector([0,0,1],g.eye,q,r,ca);e.vec3.copy(b,r);e.vec3.copy(d,q);e.vec3.normalize(b,b);e.vec3.scale(b,b,e.vec3.length(F));B.vectorCoordinates(a,e.vec3.normalize(I,I),e.vec3.normalize(J,J),e.vec3.normalize(H,H),da);B.vectorCoordinates(c,I,J,H,ea);Z(da,ea,a,q,r,f,n,l,h,k)}function fa(a,c,b,d,f,g,n){k.mat4.identity(t);k.mat4.identity(u);
k.mat4.identity(v);k.mat4.rotate(t,t,f,d);k.mat4.rotate(u,u,n,g);k.mat4.multiply(v,t,u);e.vec3.subtract(c,a,b);e.vec3.transformMat4(c,c,v);e.vec3.add(c,c,b)}function ga(a,c,b,d,f,g){k.mat4.identity(t);k.mat4.identity(u);k.mat4.identity(v);k.mat4.rotate(t,t,d,b);k.mat4.rotate(u,u,g,f);k.mat4.multiply(v,t,u);e.vec3.subtract(a.eye,a.eye,c);e.vec3.transformMat4(a.eye,a.eye,v);e.vec3.add(a.eye,a.eye,c);e.vec3.subtract(a.center,a.center,c);e.vec3.transformMat4(a.center,a.center,v);e.vec3.add(a.center,a.center,
c);e.vec3.subtract(a.up,a.up,c);e.vec3.transformMat4(a.up,a.up,v);e.vec3.add(a.up,a.up,c);a.markViewDirty()}function P(a,c,b,e,f,g,n,l){void 0===n&&(n=d.PreservingHeadingThreshold.Pole);void 0===l&&(l=d.PreservingHeadingThreshold.Angle);a=Math.abs(a[2])<b*n||Math.abs(c)>b;return(Math.abs(e)>Math.PI-l||Math.abs(e)<l)&&a&&g.aboveGround&&f<d.PreservingHeadingThreshold.Tilt?!0:!1}function ha(a,c,b,e,d,g){g?(m.axisAngle.fromPoints(b,e,ia),N(c,a.center,ia)):(b=X(b,e,ja,c,a.radius,d),N(c,a.center,m.axisAngle.wrapAxisAngle(ja,
b)))}function ka(a,c,b,d,f,g,n){var z=n?20:1;e.vec3.copy(x,d);K.copyFrom(c);for(var h,k=0;k<z&&1E-12<e.vec3.squaredDistance(b,x);k++)if(d=e.vec3.squaredDistance(b,x),ba(b,x,r,q,C,K,a,f,g,n),ga(K,a.center,q,C[1],r,C[0]),fa(x,x,a.center,q,C[1],r,C[0]),h=e.vec3.squaredDistance(b,x),h<d||0===k)c.copyFrom(K);else break}Object.defineProperty(d,"__esModule",{value:!0});d.panMotionToRotationMatrix=d.panToPosition=d.applyPanSphericalPreserveHeading=d.applyPanSphericalDirectRotation=d.preserveHeadingThreshold=
d.applyRotationWithTwoAxes=d.rotatePointAroundTwoAxes=d.rotationAnglesAndAxesHeadingPreserving=d.rotationAnglesHeadingPreserving=d.lengthFromPoints=d.rotationAngleAndAxisDirectRotation=d.sphereOrPlanePointFromScreenPoint=d.applyPanPlanar=d.decidePanMode=d.pickPointAndInitSphere=d.TiltThresholdPanningSpeed=d.PreservingHeadingThreshold=d.VerticalPanTresholds=d.PanMode=d.offSurfaceTiltToEyeTiltGlobal=d.onSurfaceTiltToEyeTiltGlobal=d.centroid=d.centroidOnSphere=d.applyZoomOnSphere=d.applyZoomToPoint=
d.intersectPlaneFromScreenPoint=d.applyRotation=d.normalizeRotationDelta=d.rotationFromPointsAroundAxis=d.normalizeCoordinate=d.Earth=void 0;d.Earth=m.sphere.fromValues(R.earthRadius,h.vec3f64.create());d.normalizeCoordinate=function(a,c,b){b[0]=c[0]/(a.fullWidth/a.pixelRatio);b[1]=c[1]/(a.fullHeight/a.pixelRatio);return b};d.rotationFromPointsAroundAxis=function(a,c,b){var d=w.sv3d.get(),f=w.sv3d.get(),g=w.sv3d.get();e.vec3.copy(f,a);e.vec3.copy(g,c);a=e.vec3.dot(f,b);c=e.vec3.dot(g,b);e.vec3.scale(d,
b,a);e.vec3.subtract(f,f,d);e.vec3.normalize(f,f);e.vec3.scale(d,b,c);e.vec3.subtract(g,g,d);e.vec3.normalize(g,g);a=e.vec3.dot(f,g);e.vec3.cross(d,b,f);b=e.vec3.dot(g,d);return Math.atan2(b,a)};d.normalizeRotationDelta=function(a){for(;a>Math.PI;)a-=2*Math.PI;for(;a<-Math.PI;)a+=2*Math.PI;return a};d.applyRotation=N;d.intersectPlaneFromScreenPoint=function(a,c,b,e){return m.plane.intersectRay(a,m.ray.fromScreen(c,b,V),e)};d.applyZoomToPoint=function(a,c,b,d){var f=w.sv3d.get();b=1-b;e.vec3.subtract(f,
c,a.eye);var g=e.vec3.length(f),h=g*(1-b);0<=b&&h<d&&(h=d,b=-(h-g)/g);1E-6>Math.abs(g-h)||(e.vec3.scale(f,f,b),e.vec3.add(a.eye,a.eye,f),e.vec3.lerp(a.center,a.center,c,b))};d.applyZoomOnSphere=function(a,c,b){c.getScreenCenter(la);m.sphere.intersectScreen(a,c,la,c.center);c.markViewDirty();a=c.distance;b*=a;1E-6>Math.abs(a-b)||(b=e.vec3.scale(w.sv3d.get(),c.viewForward,b),e.vec3.subtract(c.eye,c.center,b),c.markViewDirty())};var la=ma.createScreenPointArray();d.centroidOnSphere=function(a,c,b){S(c,
b);e.vec3.normalize(b,b);e.vec3.scale(b,b,a)};d.centroid=S;d.onSurfaceTiltToEyeTiltGlobal=T;d.offSurfaceTiltToEyeTiltGlobal=function(a,c,b){return T(Math.PI/2,c,b)+(a-Math.PI/2)};var D;(function(a){a[a.Vertical=0]="Vertical";a[a.Horizontal=1]="Horizontal"})(D=d.PanMode||(d.PanMode={}));d.VerticalPanTresholds={Elevation:3E4,Angle:p.deg2rad(8)};d.PreservingHeadingThreshold={Pole:.95,Angle:p.deg2rad(18),Tilt:45};d.TiltThresholdPanningSpeed=p.deg2rad(80);d.pickPointAndInitSphere=function(a,c,b,k){var f=
h.vec3f64.create(),g=m.sphere.create(),n=!0;a.intersectScreen(b,f)?g.radius=e.vec3.length(f):(g.radius=c.aboveGround?Math.max(e.vec3.length(c.center),.9*d.Earth.radius):e.vec3.length(c.eye)-c.relativeElevation,k?U(g,c,b,f):n=m.sphere.intersectScreen(g,c,b,f));return{sphere:g,scenePickPoint:n?f:null}};d.decidePanMode=function(a,c,b){var h=e.vec3.length(a.eye);if(Math.abs(h-d.Earth.radius)>d.VerticalPanTresholds.Elevation)return D.Horizontal;if(a.aboveGround===c.radius>h)return D.Vertical;e.vec3.subtract(L,
a.eye,b);e.vec3.normalize(L,L);return Math.abs(.5*Math.PI-p.acosClamped(e.vec3.dot(b,L)/e.vec3.length(b)))<d.VerticalPanTresholds.Angle?D.Vertical:D.Horizontal};var L=h.vec3f64.create();d.applyPanPlanar=function(a,c,b){e.vec3.subtract(Q,b,c);e.vec3.subtract(a.eye,a.eye,Q);e.vec3.subtract(a.center,a.center,Q);a.markViewDirty()};var Q=h.vec3f64.create();d.sphereOrPlanePointFromScreenPoint=U;var E=h.vec3f64.create(),A=h.vec3f64.create(),W=m.plane.create();d.rotationAngleAndAxisDirectRotation=X;var Y=
h.vec3f64.create();d.lengthFromPoints=O;d.rotationAnglesHeadingPreserving=Z;d.rotationAnglesAndAxesHeadingPreserving=ba;d.rotatePointAroundTwoAxes=fa;d.applyRotationWithTwoAxes=ga;d.preserveHeadingThreshold=P;d.applyPanSphericalDirectRotation=ha;d.applyPanSphericalPreserveHeading=ka;d.panToPosition=function(a,c,b,h,f,g,k){P(b,e.vec3.dot(c.up,b),a.radius,-y.cyclicalPI.normalize(p.deg2rad(f)),g,c,d.PreservingHeadingThreshold.Pole,d.PreservingHeadingThreshold.Angle)?ka(a,c,b,h,-y.cyclicalPI.normalize(p.deg2rad(f)),
g,k):ha(a,c,b,h,g,k)};d.panMotionToRotationMatrix=function(a,c,b,d,f,g,h,l,m){if(P(a.center,e.vec3.dot(a.up,a.center),e.vec3.length(a.center),-y.cyclicalPI.normalize(p.deg2rad(g)),h,c))switch(a=-y.cyclicalPI.normalize(p.deg2rad(f)),B.coordinateSystemFromOneAxisAndNormalVector([0,0,1],c.eye,q,r,ca),f=b.translation[0]*d.pan,g=b.translation[1]*d.pan,c=Math.max(Math.sqrt(Math.abs(1-Math.pow(e.vec3.dot(c.center,q),2)/Math.pow(e.vec3.length(c.center),2))),.5),h=-Math.cos(a)*g+Math.sin(a)*f,k.mat4.rotate(l.pan.matrix,
l.pan.matrix,(Math.sin(a)*g+Math.cos(a)*f)/c,q),l.pan.enabled=!0,m.mode){case "pan":k.mat4.rotate(l.pan.matrix,l.pan.matrix,h,r);l.pan.enabled=!0;break;case "zoom":l.zoom=-b.translation[1]*d.zoom}else switch(a=c.eye,c=c.viewRight,a=e.vec3.cross(w.sv3d.get(),c,a),f=b.translation[0]*d.pan,0!==f&&(k.mat4.rotate(l.pan.matrix,l.pan.matrix,-f,a),l.pan.enabled=!0),m.mode){case "pan":b=b.translation[1]*d.pan;0!==b&&(k.mat4.rotate(l.pan.matrix,l.pan.matrix,b,c),l.pan.enabled=!0);break;case "zoom":l.zoom=-b.translation[1]*
d.zoom}};var q=h.vec3f64.create(),r=h.vec3f64.create(),ca=h.vec3f64.create(),H=h.vec3f64.create(),I=h.vec3f64.create(),J=h.vec3f64.create(),da=h.vec3f64.create(),ea=h.vec3f64.create(),C=oa.vec2f64.create(),ia=m.axisAngle.create(),t=M.mat4f64.create(),u=M.mat4f64.create(),v=M.mat4f64.create(),x=h.vec3f64.create(),aa=h.vec3f64.create(),G=h.vec3f64.create(),K=new pa.default,F=h.vec3f64.create(),ja=h.vec3f64.create(),V={origin:h.vec3f64.create(),direction:h.vec3f64.create()}});