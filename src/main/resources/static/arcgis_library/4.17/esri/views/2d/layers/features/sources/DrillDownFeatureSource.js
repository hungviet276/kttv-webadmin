// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.17/esri/copyright.txt for details.
//>>built
define("require exports tslib ../../../../../core/has ../../../../../core/promiseUtils ./BaseFeatureSource".split(" "),function(a,d,c,b,t,e){Object.defineProperty(d,"__esModule",{value:!0});d.DrillDownFeatureSource=void 0;a=b("esri-featurelayer-webgl");b=b("esri-mobile");var x=a&&"object"===typeof a&&null!=a.maxDrillLevel?a.maxDrillLevel:b?1:4,y=a&&"object"===typeof a&&null!=a.maxRecordCountFactor?a.maxRecordCountFactor:b?1:3;e=function(a){function b(f){return a.call(this,f)||this}c.__extends(b,a);
b.prototype._fetchDataTile=function(a){return c.__awaiter(this,void 0,void 0,function(){var b,d,e,u,g,h,f=this;return c.__generator(this,function(z){b=this._serviceInfo.capabilities.query.supportsMaxRecordCountFactor;d=this._subscriptions.get(a.key.id);e=d.signal;u=a.getQuantizationParameters();g=0;h=function(n,k){return c.__awaiter(f,void 0,void 0,function(){var f,p,l,m,q,v,r,w;return c.__generator(this,function(c){switch(c.label){case 0:f=this._sourceQueryInfo,p=this._createQuery(n,{maxRecordCountFactor:b?
y:void 0,returnExceededLimitFeatures:!1,quantizationParameters:u}),g++,c.label=1;case 1:return c.trys.push([1,3,,4]),[4,this._queue.push({tile:a,query:p,signal:e,depth:k})];case 2:l=c.sent();g--;t.throwIfAborted(e);if(!l)return[2];if(f!==this._sourceQueryInfo)return h(n,k),[2];if(l.exceededTransferLimit&&k<x){m=0;for(q=n.createChildTiles();m<q.length;m++)v=q[m],h(v,k+1);return[2]}r={tile:a,id:a.id,features:l,end:0===g};d.requests.done.push({query:p,request:r});this._onRequest(r,"new");return[3,4];
case 3:return w=c.sent(),t.isAbortError(w)||this._onRequest({tile:a,id:a.id,features:null,end:!0},"new"),[3,4];case 4:return[2]}})})};h(a,0);return[2]})})};return b}(e.BaseFeatureSource);d.DrillDownFeatureSource=e});