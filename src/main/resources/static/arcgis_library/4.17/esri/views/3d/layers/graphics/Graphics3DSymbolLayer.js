// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.17/esri/copyright.txt for details.
//>>built
define("require exports tslib ../../../../Color ../../../../core/arrayUtils ../../../../core/compilerUtils ../../../../core/Logger ../../../../core/mathUtils ../../../../core/maybe ../../../../core/libs/gl-matrix-2/vec3f64 ../../../../core/libs/gl-matrix-2/vec4f64 ./elevationAlignmentUtils ./ElevationContext ./featureExpressionInfoUtils ./graphicUtils ./Loadable ./symbolComplexity".split(" "),function(n,k,u,v,w,x,y,r,h,z,A,p,B,C,q,D,E){function l(d,a){d=null!=d?a.attributes[d]:0;return null!=d&&isFinite(d)?
d:0}Object.defineProperty(k,"__esModule",{value:!0});k.getAttributeValue=k.Graphics3DSymbolLayer=void 0;var m=y.getLogger("esri.views.3d.layers.graphics.Graphics3DSymbolLayer");n=function(d){function a(b,c,e,a){var f=d.call(this)||this;f._elevationInfoOverride=null;f.complexity=null;f.logger=m;f._elevationOptions={supportsOffsetAdjustment:!1,supportsOnTheGround:!0};f.symbol=b;f.symbolLayer=c;f._context=e;f._renderPriority=a.renderPriority;f._renderPriorityStep=a.renderPriorityStep;f._elevationContext=
new B.ElevationContext;f.complexity=f.computeComplexity();f._updateDrivenProperties(a.ignoreDrivers);f._updateElevationContext();return f}u.__extends(a,d);a.prototype.getCachedSize=function(){return null};Object.defineProperty(a.prototype,"extentPadding",{get:function(){return 0},enumerable:!1,configurable:!0});Object.defineProperty(a.prototype,"needsDrivenTransparentPass",{get:function(){return this._drivenProperties.opacity&&!this._drivenProperties.opacityAlwaysOpaque},enumerable:!1,configurable:!0});
a.prototype._logGeometryCreationWarnings=function(b,c,a,g){var e="polygons"in b?b.polygons:null;g+=" geometry failed to be created";var d=null;b.projectionSuccess?!c.length||1===c.length&&!c[0].length?d=g+" (no "+a+" were defined)":Array.isArray(c)&&Array.isArray(c[0])?e&&0===e.length&&"rings"===a&&0<c.length&&2<c[0].length&&(d=g+" (filled "+a+" should use clockwise winding - try reversing the order of vertices)"):d=g+" ("+a+" should be defined as a 2D array)":d=g+" (failed to project geometry to view spatial reference)";
d&&m.warnOncePerTick(d)};a.prototype._validateGeometryType=function(b,c,a){if(w.includes(c,b.type))return!0;this.logger.warn("unsupported geometry type for "+a+(" symbol: "+b.type));return!1};a.prototype._validateGeometry=function(b){return"point"!==b.type||r.isFinite(b.x)&&r.isFinite(b.y)?!0:(m.warn("point coordinate is not a valid number, graphic skipped"),!1)};a.prototype._defaultElevationInfoNoZ=function(){return F};a.prototype._defaultElevationInfoZ=function(){return G};a.prototype._updateElevationContext=
function(){h.isSome(this._elevationInfoOverride)?(this._elevationContext.setFromElevationInfo(this._elevationInfoOverride),this._elevationContext.updateFeatureExpressionInfoContext(null)):this._context.layer.elevationInfo?(this._elevationContext.setFromElevationInfo(this._context.layer.elevationInfo),this._elevationContext.updateFeatureExpressionInfoContext(this._context.featureExpressionInfoContext)):this._elevationContext.reset()};a.prototype.getDefaultElevationInfo=function(b){return b.hasZ?this._defaultElevationInfoZ():
this._defaultElevationInfoNoZ()};a.prototype.getGeometryElevationMode=function(b,c){void 0===c&&(c=this.getDefaultElevationInfo(b));return this._elevationContext.mode||c.mode};a.prototype.setElevationInfoOverride=function(b){this._elevationInfoOverride=b;this._updateElevationContext()};a.prototype.setGraphicElevationContext=function(b,c){var a=h.unwrap(b.geometry),g=this.getDefaultElevationInfo(a);c.unit=null!=this._elevationContext.unit?this._elevationContext.unit:g.unit;c.mode=this.getGeometryElevationMode(a,
g);c.offsetMeters=h.unwrapOr(this._elevationContext.meterUnitOffset,h.unwrapOr(g.offset,0));if(a=!this._elevationOptions.supportsOnTheGround&&"on-the-ground"===c.mode)c.mode="relative-to-ground",c.offsetMeters=0;c.updateFeatureExpressionInfoContext(a?C.zeroContext:this._elevationContext.featureExpressionInfoContext,b,this._context.layer);return c};a.prototype.prepareSymbolLayerPatch=function(b){};a.prototype.updateGeometry=function(b,c){return!1};a.prototype.onRemoveGraphic=function(b){};a.prototype._updateDrivenProperties=
function(b){var c={color:!1,opacity:!1,opacityAlwaysOpaque:!0,size:!1};b||(b=this._context.renderer)&&"visualVariables"in b&&b.visualVariables&&b.visualVariables.forEach(function(b){switch(b.type){case "color":c.color=!0;if(b.stops)for(var a=0;a<b.stops.length;a++){var e=b.stops[a].color;e&&(c.opacity=!0,1>e.a&&(c.opacityAlwaysOpaque=!1))}break;case "opacity":c.opacity=!0;c.opacityAlwaysOpaque=!1;break;case "size":c.size=!0}});this._drivenProperties=c};a.prototype._getLayerOpacity=function(){if(this._context.layerView&&
"fullOpacity"in this._context.layerView)return this._context.layerView.fullOpacity;var b=this._context.layer.opacity;return null==b?1:b};a.prototype._getCombinedOpacity=function(b,c){void 0===c&&(c=t);var a=1;this.draped||(a*=this._getLayerOpacity());if(this._drivenProperties.opacity)return a;h.isSome(b)?a*=b.a:c.hasIntrinsicColor||(a=0);return a};a.prototype._getCombinedOpacityAndColor=function(b,a){void 0===a&&(a=t);a=this._getCombinedOpacity(b,a);if(this._drivenProperties.color)return q.mixinColorAndOpacity(null,
a);b=h.isSome(b)?v.toUnitRGB(b):z.vec3f64.ONES;return q.mixinColorAndOpacity(b,a)};a.prototype._getVertexOpacityAndColor=function(b,a,e){b=q.mixinColorAndOpacity(this._drivenProperties.color?b.color:null,this._drivenProperties.opacity?b.opacity:null);e&&(b[0]*=e,b[1]*=e,b[2]*=e,b[3]*=e);return a?new a(b):b};a.prototype._getIdHint=function(b){void 0===b&&(b="");return this._context.layer.id+"_symbol"+b};a.prototype.isFastUpdatesEnabled=function(){return this._fastUpdates&&this._fastUpdates.enabled};
a.prototype.computeComplexity=function(){return E.defaultSymbolLayerComplexity(this.symbol,this.symbolLayer)};a.prototype.destroy=function(){this.abortLoad()};a.prototype.globalPropertyChanged=function(b,a,e){switch(b){case "opacity":return this.layerOpacityChanged(a,e);case "elevationInfo":return b=this._elevationContext.mode,this._updateElevationContext(),this.layerElevationInfoChanged(a,e,b)===p.SymbolUpdateType.RECREATE?!1:!0;case "slicePlaneEnabled":return this.slicePlaneEnabledChanged(a,e);
case "physicalBasedRenderingEnabled":return this.physicalBasedRenderingChanged();case "pixelRatio":return this.pixelRatioChanged();default:return x.neverReachedSilent(b),!1}};a.prototype.updateGraphics3DGraphicElevationInfo=function(b,a,e){var c=this,f=p.SymbolUpdateType.UPDATE;b.forEach(function(b){var d=a(b);h.isSome(d)?(c.setGraphicElevationContext(b.graphic,d.elevationContext),d.needsElevationUpdates=e(d.elevationContext.mode)):f=p.SymbolUpdateType.RECREATE});return f};a.prototype.applyRendererDiff=
function(b,a){return!1};a.prototype.getFastUpdateAttrValues=function(b){if(!this._fastUpdates.enabled)return null;var a=this._fastUpdates.visualVariables,d=a.size?l(a.size.field,b):0,g=a.color?l(a.color.field,b):0;b=a.opacity?l(a.opacity.field,b):0;return A.vec4f64.fromValues(d,g,b,0)};Object.defineProperty(a.prototype,"draped",{get:function(){return this._draped},enumerable:!1,configurable:!0});a.prototype.ensureDrapedStatus=function(a){if(null==this._draped)return this._draped=a,!0;a!==this.draped&&
m.warnOnce("A symbol can only produce either draped or non-draped visualizations. Use two separate symbol instances for draped and non-draped graphics if necessary.");return!1};return a}(D.Loadable);k.Graphics3DSymbolLayer=n;k.getAttributeValue=l;var F={mode:"on-the-ground",offset:0,unit:"meters"},G={mode:"absolute-height",offset:0,unit:"meters"},t={hasIntrinsicColor:!1};k.default=n});