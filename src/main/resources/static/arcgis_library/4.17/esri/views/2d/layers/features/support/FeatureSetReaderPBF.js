// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.17/esri/copyright.txt for details.
//>>built
define("require exports tslib ../../../../../core/Error ../../../../../core/Logger ../../../../../core/pbf ../../../../../layers/graphics/featureConversionUtils ../../../../../layers/graphics/OptimizedFeature ../../../../../layers/graphics/OptimizedGeometry ./FeatureSetReader ./FeatureSetReaderPBFHeader".split(" "),function(p,n,v,B,C,D,q,E,t,r,F){function G(c){for(var b=c.getLength(),b=c.pos()+b;c.pos()<b&&c.next();)switch(c.tag()){case 1:return c=c.getString(),""===c?null:c;case 2:return c.getFloat();
case 3:return c.getDouble();case 4:return c.getSInt32();case 5:return c.getUInt32();case 6:return c.getInt64();case 7:return c.getUInt64();case 8:return c.getSInt64();case 9:return c.getBool();default:return c.skip(),null}return null}Object.defineProperty(n,"__esModule",{value:!0});n.FeatureSetReaderPBF=void 0;var H=C.getLogger("esri.view.2d.layers.features.support.FeatureSetReaderPBF");p=function(c){function b(a,g,b,e){a=c.call(this,a)||this;a._hasNext=!1;a._isPoints=!1;a._isPolygons=!1;a._featureIndex=
-1;a._featureOffset=0;a._cache={area:0,unquantGeometry:void 0,geometry:void 0,centroid:void 0,legacyFeature:void 0,optFeature:void 0};a._geometryType=e;a._reader=g;a._header=b;a._hasNext=b.hasFeatures;a._isPoints="esriGeometryPoint"===e;a._isPolygons="esriGeometryPolygon"===e;return a}v.__extends(b,c);b.fromBuffer=function(a,g){var d;a:{try{for(var e=new D(new Uint8Array(a),new DataView(a));e.next();)switch(e.tag()){case 2:b:{for(var f=e.getMessage();f.next();)switch(f.tag()){case 1:d=f.getMessage();
break b;default:f.skip()}d=null}break a;default:e.skip()}}catch(I){d=new B("query:parsing-pbf","Error while parsing FeatureSet PBF payload",{error:I}),H.error(d)}d=null}a=F.parseHeader(d,"esriGeometryPoint"===g);e=r.FeatureSetReader.createInstance();return new b(e,d,a,g)};Object.defineProperty(b.prototype,"geometryType",{get:function(){return this._geometryType},enumerable:!1,configurable:!0});Object.defineProperty(b.prototype,"size",{get:function(){return this._header.featureCount},enumerable:!1,
configurable:!0});Object.defineProperty(b.prototype,"hasZ",{get:function(){return!1},enumerable:!1,configurable:!0});Object.defineProperty(b.prototype,"hasM",{get:function(){return!1},enumerable:!1,configurable:!0});Object.defineProperty(b.prototype,"stride",{get:function(){return 2+(this.hasZ?1:0)+(this.hasM?1:0)},enumerable:!1,configurable:!0});Object.defineProperty(b.prototype,"hasFeatures",{get:function(){return this._header.hasFeatures},enumerable:!1,configurable:!0});Object.defineProperty(b.prototype,
"hasNext",{get:function(){return this._hasNext},enumerable:!1,configurable:!0});Object.defineProperty(b.prototype,"exceededTransferLimit",{get:function(){return this._header.exceededTransferLimit},enumerable:!1,configurable:!0});b.prototype.getApproximateSize=function(){return this._hasFilter?Math.max(Math.round(this.size*Math.abs(this._xmax-this._xmin)*Math.abs(this._ymax-this._ymin)/262144),0):this.size};b.prototype.getQuantizationTransform=function(){return this._header.transform};b.prototype.getCursor=
function(){return this.copy()};b.prototype.getIndex=function(){return this._featureIndex};b.prototype.setIndex=function(a){this._cache.area=0;this._cache.unquantGeometry=void 0;this._cache.geometry=void 0;this._cache.centroid=void 0;this._cache.legacyFeature=void 0;this._cache.optFeature=void 0;this._featureIndex=a};b.prototype.getAttributeHash=function(){var a=this,g="";this._header.fieldIndexMap.forEach(function(b){g+=a._readAttributeAtIndex(b)+"."});return g};b.prototype.getObjectId=function(){return this._readAttributeAtIndex(this._header.objectIdFieldIndex)};
b.prototype.getDisplayId=function(){return this._header.displayIds[this._featureIndex]};b.prototype.setDisplayId=function(a){this._header.displayIds[this._featureIndex]=a};b.prototype.getGroupId=function(){return this._header.groupIds[this._featureIndex]};b.prototype.setGroupId=function(a){this._header.groupIds[this._featureIndex]=a};b.prototype.readLegacyFeature=function(){var a;if(void 0===this._cache.legacyFeature){var b=this.readCentroid(),b={attributes:this.readAttributes(),geometry:this._isPoints?
this.readLegacyPointGeometry():this.readLegacyGeometry(),centroid:null!==(a=b&&{x:b.coords[0],y:b.coords[1]})&&void 0!==a?a:null};return this._cache.legacyFeature=b}return this._cache.legacyFeature};b.prototype.readOptimizedFeature=function(){if(void 0===this._cache.optFeature){var a=new E.default(this.readGeometry(),this.readAttributes(),this.readCentroid());return this._cache.optFeature=a}return this._cache.optFeature};b.prototype.getXHydrate=function(){var a=this._header.centroid[2*this._featureIndex],
b=this.getQuantizationTransform();return a*b.scale[0]+b.translate[0]};b.prototype.getYHydrate=function(){var a=this._header.centroid[2*this._featureIndex+1],b=this.getQuantizationTransform();return b.translate[1]-a*b.scale[1]};b.prototype.readLegacyPointGeometry=function(){return{x:this._header.centroid[2*this._featureIndex]+this._tx,y:this._header.centroid[2*this._featureIndex+1]+this._ty}};b.prototype.readLegacyGeometry=function(){var a=this.readGeometry();return q.convertToGeometry(a,this.geometryType,
!1,!1)};b.prototype.readLegacyCentroid=function(){var a=this.readCentroid();if(!a)return null;a=a.coords;return{x:a[0],y:a[1]}};b.prototype.readGeometryArea=function(){this._cache.area||this.readGeometry();return this._cache.area};b.prototype.readUnquantizedGeometry=function(){if(void 0===this._cache.unquantGeometry){var a=this.readGeometry();if(!a)return this._cache.unquantGeometry=null;for(var a=a.clone(),b=a.lengths,d=a.coords,e=0,f=2;e<b.length;e++,f+=2)for(var c=b[e],y=1;y<c;y+=1,f+=2)d[f]+=
d[f-2],d[f+1]+=d[f-1];return this._cache.unquantGeometry=a}return this._cache.unquantGeometry};b.prototype.readHydratedGeometry=function(){var a=this.readGeometry();if(!a)return null;a=a.clone();this._isPoints&&(a.coords[0]-=this._tx,a.coords[1]-=this._ty);q.unquantizeOptimizedGeometry(a,a,this.hasZ,this.hasM,this.getQuantizationTransform());return a};b.prototype.readGeometry=function(){if(void 0===this._cache.geometry){var a=null;if(this._isPoints)a=new t.default([],[this._header.centroid[2*this._featureIndex]+
this._tx,this._header.centroid[2*this._featureIndex+1]+this._ty]);else{var b=this._header.offsets.geometry[this._featureIndex],d=this._reader;if(0===b)return null;d.move(b);try{a=this._parseGeometry(d)}catch(e){return console.error("Failed to parse geometry!",e),null}}return this._cache.geometry=a}return this._cache.geometry};b.prototype.readCentroid=function(){if(void 0===this._cache.centroid){var a=null,a=this._header.centroid[2*this._featureIndex]+this._tx,b=this._header.centroid[2*this._featureIndex+
1]+this._ty;if(268435455===a){if(a=this._computeCentroid())this._header.centroid[2*this._featureIndex]=a.coords[0]-this._tx,this._header.centroid[2*this._featureIndex+1]=a.coords[1]-this._ty}else a=new t.default([],[a,b]);return this._cache.centroid=a}return this._cache.centroid};b.prototype.copy=function(){var a=this._reader.clone(),a=new b(this.instance,a,this._header,this.geometryType);this.copyInto(a);return a};b.prototype.next=function(){this._cache.area=0;this._cache.unquantGeometry=void 0;
this._cache.geometry=void 0;this._cache.centroid=void 0;this._cache.legacyFeature=void 0;this._cache.optFeature=void 0;if(!this._hasFilter)return++this._featureIndex<this.size;for(;++this._featureIndex<this.size&&!this._passesFilter(););return this._featureIndex<this.size};b.prototype._readAttribute=function(a,b){a=this._header.hasFieldIndex(a)?a:a.toLowerCase().trim();var d=this._header.getFieldIndex(a);if(null!=d)return d=this._readAttributeAtIndex(d),b?this._header.isDateField(a)?new Date(d):d:
d};b.prototype._readAttributes=function(){var a=this,b={};this._header.fieldIndexMap.forEach(function(d,e){b[e]=a._readAttributeAtIndex(d)});return b};b.prototype.copyInto=function(a){c.prototype.copyInto.call(this,a);a._featureIndex=this._featureIndex;a._featureOffset=this._featureOffset;a._hasNext=this._hasNext};b.prototype._passesFilter=function(){if(!this._hasFilter)return!0;var a=this._header.centroid[2*this._featureIndex],b=this._header.centroid[2*this._featureIndex+1];if(268435455===a){if(this._isPolygons&&
!this.readCentroid())return!1;a=this._header.centroid[2*this._featureIndex];b=this._header.centroid[2*this._featureIndex+1]}return a>=this._xmin&&a<=this._xmax&&b>=this._ymin&&b<=this._ymax?!0:!1};b.prototype._readAttributeAtIndex=function(a){var b=this._reader;b.move(this._header.offsets.attributes[this._featureIndex*this._header.fieldCount+a]);return G(b)};b.prototype._preprocessPolygon=function(a,b){for(var d=0,e=0,f=0,c=!1,g=!1,n=!1,p=-1,w=[],q=0,r=!1,x=0;x<b.length;x++){for(var u=b[x],l=a[2*
d],m=a[2*d+1],h=0,k=1;k<u;k++)var z=l+a[2*(d+k)],A=m+a[2*(d+k)+1],v=(z-l)*(A+m),l=z,m=A,h=h+.5*v;(k=0<h)&&r&&(e+=u);k||(p++,r=!1);if(1E6<=p)break;q+=h;c&&k&&g&&(n=!0);a[2*f]=a[2*e];a[2*f++ +1]=a[2*e++ +1];c=1;g=a[2*e];h=a[2*e++ +1];for(k=2;k<u;k++)l=a[2*e],m=a[2*e++ +1],0===g*m-l*h?(g+=l,h+=m):(a[2*f]=g,a[2*f++ +1]=h,c++,g=l,h=m);a[2*f]=g;a[2*f++ +1]=h;c++;w.push(c);c=!1;g=!0;d+=u}return w.length?(this._cache.area=Math.abs(q),new t.default(w,a,n)):null};b.prototype._parseGeometry=function(a){for(var b=
a.getLength(),d=a.pos()+b,b=[],e=[];a.pos()<d&&a.next();)switch(a.tag()){case 2:for(var c=a.getUInt32(),c=a.pos()+c;a.pos()<c;)e.push(a.getUInt32());break;case 3:c=a.getUInt32();for(c=a.pos()+c;a.pos()<c;)b.push(a.getSInt32()),b.push(a.getSInt32()),this.hasZ&&a.getSInt32(),this.hasM&&a.getSInt32();break;default:a.skip()}for(d=a=0;d<e.length;d++)c=e[d],b[2*a]+=this._tx,b[2*a+1]+=this._ty,a+=c;return this._isPolygons?this._preprocessPolygon(b,e):new t.default(e,b)};return b}(r.FeatureSetReader);n.FeatureSetReaderPBF=
p});