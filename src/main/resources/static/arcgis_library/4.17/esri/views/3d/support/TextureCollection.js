// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.17/esri/copyright.txt for details.
//>>built
define("require exports tslib ../../../core/maybe ../../../core/promiseUtils ../../../core/urlUtils ../webgl-engine/lib/Texture ../../support/Scheduler".split(" "),function(g,f,k,n,l,q,r,p){Object.defineProperty(f,"__esModule",{value:!0});f.TextureCollection=void 0;g=function(){function d(a,c,b,d){this._streamDataRequester=a;this._stage=c;this._textureOptions=b;this._textureRequests=new Map;this._frameTask=n.isSome(d)?d.registerTask(p.Task.TEXTURE_UNLOAD,function(){},function(){return!1}):new p.TestTaskHandle}
d.prototype.destroy=function(){var a=this;this._frameTask.remove();this._textureRequests.forEach(function(c){return a.releaseTextureRequest(c)});this._textureRequests.clear()};d.prototype.fromUrl=function(a,c,b){return k.__awaiter(this,void 0,void 0,function(){var d,h,e,f,g,m=this;return k.__generator(this,function(k){l.throwIfAborted(b);d=n.isSome(b)&&b.signal;h=this.makeUid(a,c);e=this._textureRequests.get(h);e||(f=l.createAbortController(),g=this._streamDataRequester.request(a,"image",{uid:h,signal:f.signal}),
e={referenceCount:0,texture:null,textureAsync:null,abortController:f},this._textureRequests.set(h,e),e.textureAsync=g.then(function(b){b=m.createTexture(a,b,c);e.texture=b;e.abortController=null;m.addToStage(b);return{uid:h,texture:b}},function(a){e.abortController=null;throw a;}));e.referenceCount++;return[2,l.create(function(a,b){l.onAbort(d,function(){b(l.createAbortError())});e.textureAsync.then(a,b)}).catch(function(a){m.release(h);throw a;})]})})};d.prototype.fromData=function(a,c){a=this.makeUid(a);
var b=this._textureRequests.get(a);b||(b={referenceCount:0,texture:c(),textureAsync:null,abortController:null},this.addToStage(b.texture),this._textureRequests.set(a,b));b.referenceCount++;return{uid:a,texture:b.texture}};d.prototype.release=function(a){var c=this;if(this._textureRequests){var b=this._textureRequests.get(a);b?(1>b.referenceCount&&console.warn("TextureCollection: reference count is \x3c 1 for "+a),b.referenceCount--,1>b.referenceCount&&this._frameTask.schedule(function(){return c.releaseNow(a)})):
console.warn("TextureCollection: texture doesn't exist: '"+a+"'")}};Object.defineProperty(d.prototype,"test",{get:function(){return{textureRequests:this._textureRequests}},enumerable:!1,configurable:!0});d.prototype.releaseNow=function(a){if(this._textureRequests){var c=this._textureRequests.get(a);!c||0<c.referenceCount||(this.releaseTextureRequest(c),this._textureRequests.delete(a))}};d.prototype.releaseTextureRequest=function(a){a.texture?this.removeFromStage(a.texture):a.abortController&&(a.abortController.abort(),
a.abortController=null)};d.prototype.createTexture=function(a,c,b){q.isSVG(a)&&(b||0===c.width&&0===c.height)&&(a=c.width?c.height/c.width:1,b=b||64,1<a?(c.width=Math.round(b/a),c.height=b):(c.width=b,c.height=Math.round(b*a)));b=k.__assign(k.__assign({},this._textureOptions),{width:c.width,height:c.height,powerOfTwoResizeMode:2});return new r(c,"symbol",b)};d.prototype.addToStage=function(a){this._stage.add(4,a)};d.prototype.removeFromStage=function(a){this._stage.remove(4,a.id)};d.prototype.makeUid=
function(a,c){return null!=c?a+"."+c+"px":a};return d}();f.TextureCollection=g;f.default=g});