// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.17/esri/copyright.txt for details.
//>>built
define("require exports tslib ../../../../core/Accessor ../../../../core/HandleOwner ../../../../core/has ../../../../core/Identifiable ../../../../core/MapPool ../../../../core/MapUtils ../../../../core/maybe ../../../../core/promiseUtils ../../../../core/promiseUtils ../../../../core/screenUtils ../../../../core/accessorSupport/decorators ../../../../geometry/Polygon ../../../../geometry/SpatialReference ../../../../geometry/support/aaBoundingRect ../../../../geometry/support/coordsUtils ../../../../geometry/support/jsonUtils ../../../../geometry/support/spatialReferenceUtils ../../../../layers/graphics/data/projectionSupport ../../../../symbols/cim/cimSymbolUtils ../../../../symbols/support/defaults ../../engine/webgl/definitions ../../engine/webgl/TileData ../../engine/webgl/WGLTile ../../engine/webgl/mesh/factories/matcherUtils ../../engine/webgl/mesh/factories/WGLMeshFactory ../../engine/webgl/mesh/templates/WGLTemplateStore ../../engine/webgl/util/BidiText ../features/schemaUtils ../features/support/AttributeStore ../features/support/ComputedAttributeStorage ../features/support/GraphicsReader ../features/support/TileStore ./GraphicContainer ./GraphicProcessingQueue ./GraphicStore ./graphicsUtils ../../../layers/GraphicsView".split(" "),
function(q,y,e,I,J,ia,K,E,L,r,m,M,N,p,O,P,k,Q,h,v,F,R,w,S,T,U,V,W,X,Y,G,Z,aa,ba,ca,da,ea,fa,ga,ha){function H(e,d,a){if(a.has(e))return a.get(e);d={tile:d,addedOrModified:[],removed:[]};a.set(e,d);return d}Object.defineProperty(y,"__esModule",{value:!0});q=function(q){function d(a){a=q.call(this,a)||this;a._storage=new aa.ComputedAttributeStorage;a._displayIds=new Map;a._tiles=new Map;a._graphicStoreUpdate=!1;a._graphicsSet=new Set;a._matcher=m.resolve(null);a._tileUpdateSet=new Set;a._tilesToUpdate=
new Map;a._graphicIdToAbortController=new Map;a._attached=!1;a._highlightIds=new Map;a._updatingGraphicsTimer=null;a._processing=!1;a._needsProcessing=!1;a._pendingUpdate={addOrModified:new Set,removed:new Set};a.lastUpdateId=-1;a.updateRequested=!1;a.graphicUpdateHandler=a.graphicUpdateHandler.bind(a);a.addOrUpdateGraphic=a.addOrUpdateGraphic.bind(a);a._processAnalyzedGraphics=a._processAnalyzedGraphics.bind(a);a._graphicsChangeHandler=a._graphicsChangeHandler.bind(a);return a}e.__extends(d,q);d.prototype._createMatcher=
function(a,b){a&&(a=G.createMatcherSchema({indexCount:0,fields:{}},"feature",a),this._matcher=V.createMatcher(a,b,null))};d.prototype._createDisplayId=function(a){this._displayIds.has(a)||this._displayIds.set(a,this._storage.createDisplayId());return this._displayIds.get(a)};d.prototype.initialize=function(){var a=this;this._tileStore=new ca.default(this.view.featuresTilingScheme);this.container=new da.default(this.view.featuresTilingScheme);this._attributeStore=new Z.default({type:"local",initialize:function(b){return m.resolve(a.container.attributeView.initialize(b))},
update:function(b){return a.container.attributeView.requestUpdate(b)},render:function(){return a.container.requestRender()}});this._graphicStore=new fa.default(this.view.featuresTilingScheme,this.view.state.scale,this.uid,this.graphics,function(b){a._createDisplayId(b.uid);a._setFilterState(b.uid,b.visible)},function(b){var c=a._displayIds.get(b.uid);a._displayIds.delete(b.uid);a._storage.releaseDisplayId(c)});this._graphicProcessingQueue=new ea.default({process:this.addOrUpdateGraphic});var b=new X.WGLTemplateStore(this.container.getMaterialItems.bind(this.container),
!0);this._createMatcher(this.renderer,b);this._meshFactory=new W.WGLMeshFactory(null,this.uid,b);this._templateStore=b;this.watch("renderer",function(c){return a._createMatcher(c,b)});this._tileStore.on("update",this._onTileUpdate.bind(this));this.container.on("attach",function(){0<a.graphics.items.length&&a._graphicsChangeHandler({target:a.graphics,added:a.graphics.items,removed:[],moved:[]});a.handles.add(a.graphics.on("change",a._graphicsChangeHandler),"graphics");a._attached=!0;a.notifyChange("updating")});
this.container.on("detach",function(){a._graphicProcessingQueue&&a._graphicProcessingQueue.clear()})};d.prototype.destroy=function(){this._updatingGraphicsTimer&&(clearTimeout(this._updatingGraphicsTimer),this._updatingGraphicsTimer=null,this.notifyChange("updating"));this.container.destroy();this._set("graphics",null);this._graphicProcessingQueue&&(this._graphicProcessingQueue.destroy(),this._graphicProcessingQueue=null);this._graphicStore.clear();this._tileStore.destroy();this._attributeStore=null};
Object.defineProperty(d.prototype,"updating",{get:function(){return!this._attached||null!==this._updatingGraphicsTimer||this._graphicProcessingQueue.updating||0<this._tileUpdateSet.size||0<this._tilesToUpdate.size},enumerable:!1,configurable:!0});d.prototype.hitTest=function(a,b){if(!this.view||!this.view.position)return m.resolve();a=this.view.toMap(N.createScreenPoint(a,b));return this.searchFeatures(a).then(function(a){return a&&a.length?a[0]:null})};d.prototype.searchFeatures=function(a,b){var c=
this;void 0===b&&(b=2);return m.create(function(f){f(c._graphicStore.hitTest(a.x,a.y,b,c.view.state.resolution,c.view.state.rotation))})};d.prototype.update=function(a){a=a.state;var b=this.view.featuresTilingScheme.getClosestInfoForScale(a.scale).level;this._graphicStore.updateLevel(b);this._tileStore.setViewState(a);this._graphicStoreUpdate=!0;this.updateRequested=!1};d.prototype.viewChange=function(){this.requestUpdate()};d.prototype.requestUpdate=function(){this.updateRequested||(this.updateRequested=
!0,this.requestUpdateCallback())};d.prototype.processUpdate=function(a){this.updateRequested&&(this.updateRequested=!1,this.update(a))};d.prototype.graphicUpdateHandler=function(a){var b=a.newValue,c=a.graphic;switch(a.property){case "geometry":case "symbol":this._graphicProcessingQueue.push(c,"update");break;case "visible":this._setFilterState(c.uid,b),this._attributeStore.sendUpdates()}};d.prototype.addHighlight=function(a){for(var b=0;b<a.length;b++){var c=a[b];if(this._highlightIds.has(c)){var f=
this._highlightIds.get(c);this._highlightIds.set(c,f+1)}else this._highlightIds.set(c,1)}this._updateHighlight()};d.prototype.removeHighlight=function(a){for(var b=0;b<a.length;b++){var c=a[b];if(this._highlightIds.has(c)){var f=this._highlightIds.get(c)-1;0===f?this._highlightIds.delete(c):this._highlightIds.set(c,f)}}this._updateHighlight()};d.prototype._updateHighlight=function(){var a=this,b=L.keysOfMap(this._highlightIds),c=b.map(function(b){return a._displayIds.get(b)});this._attributeStore.setHighlight(b,
c)};d.prototype._getIntersectingTiles=function(a){return(a=this._graphicStore.getBounds(a))&&0!==k.width(a)&&0!==k.height(a)?this._tileStore.boundsIntersections(a):[]};d.prototype._updateTile=function(a){var b=this,c=a.tile,f=this._getGraphicsData(this._templateStore,c,a.addedOrModified);return this._processGraphics(f).then(function(f){b._patchTile(c.key,{type:"update",addOrUpdate:f,remove:a.removed,end:!0});return f})};d.prototype._patchTile=function(a,b){this._tiles.has(a)&&(a=this._tiles.get(a),
this.container.onTileData(a,b),this.container.requestRender())};d.prototype._graphicsChangeHandler=function(a){for(var b=0,c=a.added;b<c.length;b++){var f=c[b];this._pendingUpdate.addOrModified.add(f)}b=0;for(c=a.moved;b<c.length;b++)f=c[b],this._pendingUpdate.addOrModified.add(f);b=0;for(a=a.removed;b<a.length;b++)f=a[b],this._pendingUpdate.addOrModified.has(f)?this._pendingUpdate.addOrModified.delete(f):this._pendingUpdate.removed.add(f);this._processing?this._needsProcessing=!0:this._updateGraphics()};
d.prototype._getFeaturesToUpdate=function(){for(var a=this,b={addOrModified:[],removed:[]},c=0,f=this.graphics.items;c<f.length;c++){var d=f[c];this._pendingUpdate.addOrModified.has(d)&&b.addOrModified.push(d)}this._pendingUpdate.removed.forEach(function(c){a._graphicStore.has(c)&&b.removed.push(c)});this._pendingUpdate.addOrModified.clear();this._pendingUpdate.removed.clear();return b};d.prototype._updateGraphics=function(){return e.__awaiter(this,void 0,void 0,function(){var a,b,c,f,d,l,g,n,t,u,
h,z,p,k,q,r,v,x,A,B,C,w,D,y=this;return e.__generator(this,function(e){switch(e.label){case 0:this._processing=!0,a=this._getFeaturesToUpdate(),b=a.addOrModified,c=a.removed,f=this._tilesToUpdate,e.label=1;case 1:e.trys.push([1,4,,5]);this._graphicStoreUpdate||(l=this.view.state,g=this.view.featuresTilingScheme.getClosestInfoForScale(l.scale).level,this._graphicStore.updateLevel(g),this._tileStore.setViewState(l));n=[];t=Array(b.length);for(u=0;u<b.length;u++)h=b[u],t[u]=h,this._graphicsSet.add(h),
n.push(this.addGraphic(h));z=0;for(p=c;z<p.length;z++){k=p[z];this._abortProcessingGraphic(k.uid);q=this._getIntersectingTiles(k);r=0;for(v=q;r<v.length;r++)x=v[r],d=x.key.id,A=H(d,x,f),A.removed.push(this._displayIds.get(k.uid));this._graphicsSet.delete(k);this._graphicStore.remove(k)}this._flipUpdatingGraphics();return[4,m.all(n)];case 2:e.sent();B=void 0;for(u=0;u<t.length;u++)for(B=t[u],q=this._getIntersectingTiles(B),C=0,w=q;C<w.length;C++)x=w[C],d=x.key.id,A=H(d,x,f),A.addedOrModified.push(B);
this._graphicStore.updateZ();D=[];f.forEach(function(a){return D.push(y._updateTile(a))});return[4,m.all(D)];case 3:return e.sent(),[3,5];case 4:return e.sent(),[3,5];case 5:return f.clear(),this.notifyChange("updating"),this._processing=!1,this._needsProcessing&&(this._needsProcessing=!1,this._updateGraphics()),[2]}})})};d.prototype._getArcadeInfo=function(a){var b=(a.attributes?Object.keys(a.attributes):[]).map(function(b){return{name:b,alias:b,type:"string"===typeof a.attributes[b]?"esriFieldTypeString":
"esriFieldTypeDouble"}});return r.isNone(a.geometry)?null:{geometryType:h.getJsonType(a.geometry),spatialReference:P.fromJSON(a.geometry.spatialReference),fields:b}};d.prototype._getSymbolForGraphic=function(a,b){return e.__awaiter(this,void 0,void 0,function(){return e.__generator(this,function(c){return r.isSome(a.symbol)?[2,a.symbol]:r.isSome(this.renderer)?[2,this.renderer.getSymbolAsync(a,{scale:this.view.scale,abortOptions:b})]:[2,this._getNullSymbol(a)]})})};d.prototype._getSymbolResources=
function(a,b){return e.__awaiter(this,void 0,void 0,function(){var c,f,d,l,g,n,t,h,k;return e.__generator(this,function(e){switch(e.label){case 0:if(!this.container.stage)return[2,m.resolve(null)];c=this._getArcadeInfo(a);return[4,this._getSymbolForGraphic(a,b)];case 1:return f=e.sent(),d=G.createSymbolSchema(f),[4,R.expandSymbol(d,c,b)];case 2:l=e.sent();if("esriTS"!==l.type)return[3,4];g=[];n=Y.bidiText(l.text)[0];for(t=0;t<n.length;t++)g.push(n.charCodeAt(t));h={symbol:l,id:0,glyphIds:g};return[4,
this.container.getMaterialItems([h])];case 3:return k=e.sent()[0].mosaicItem,[2,{symbol:l,mosaicItem:k}];case 4:return[2,{symbol:l,mosaicItem:null}]}})})};d.prototype._projectAndNormalizeGeometry=function(a){return e.__awaiter(this,void 0,void 0,function(){var b,c,f,d=this;return e.__generator(this,function(e){if(r.isNone(a.geometry))return[2,m.resolve(null)];b=a.geometry;h.isPolygon(b)?(c=b.rings,b.rings=c):h.isPolyline(b)?(f=b.paths,b.paths=f):h.isExtent(b)&&(b=O.fromExtent(b));return[2,F.checkProjectionSupport(b.spatialReference,
this.view.spatialReference).then(function(){var a=ga.normalizeCentralMeridian(b),a=F.project(a,b.spatialReference,d.view.spatialReference);Q.closeRingsAndFixWinding(a);return a})]})})};d.prototype._onTileUpdate=function(a){var b=v.getInfo(this.view.spatialReference);if(a.added&&0<a.added.length)for(var c=0,f=a.added;c<f.length;c++)this._addNewTile(f[c],b);if(a.removed&&0<a.removed.length)for(b=0,a=a.removed;b<a.length;b++)this._removeTile(a[b].key)};d.prototype.addOrUpdateGraphic=function(a,b,c){return this._addOrUpdateGraphic(a,
b,c)};d.prototype.addGraphic=function(a){var b=this;this._abortProcessingGraphic(a.uid);var c=M.createAbortController();this._graphicIdToAbortController.set(a.uid,c);return this._addOrUpdateGraphic(a,"add",{signal:c.signal}).then(function(){b._graphicIdToAbortController.delete(a.uid)}).catch(function(c){b._graphicIdToAbortController.delete(a.uid);if(!m.isAbortError(c))throw c;})};d.prototype._addOrUpdateGraphic=function(a,b,c){var d=this,e=this._projectAndNormalizeGeometry(a),l=this._getSymbolResources(a,
c);return m.all([e,l]).then(function(f){var e=f[0];f=f[1];return"add"===b?d._addProjectedGraphic(a,f,e):d._updateGraphic(a,f,e,c)})};d.prototype._addProjectedGraphic=function(a,b,c){this._graphicsSet.has(a)&&this._graphicStore.addOrModify(a,b,c)};d.prototype._updateGraphic=function(a,b,c,d){var f=this;if(!this._graphicStore.has(a)||m.isAborted(d))return m.resolve();c=this._graphicStore.update(a,b,c);b=c.oldBounds;c=c.newBounds;var e=0===k.width(b)&&0===k.height(b),g=0===k.width(c)&&0===k.height(c),
e=e?[]:this._tileStore.boundsIntersections(b);b=g?[]:this._tileStore.boundsIntersections(c);c=E.acquire();for(var n=0;n<e.length;n++)g=e[n],c.set(g.key,{addOrUpdate:null,remove:[this._displayIds.get(a.uid)]});for(e=0;e<b.length;e++)g=b[e],n=this._getGraphicData(this._templateStore,g,a),c.has(g.key)?(g=c.get(g.key),g.remove.length=0,g.addOrUpdate=n):c.set(g.key,{addOrUpdate:n,remove:null});var h=[];c.forEach(function(a,b){var c=f._processGraphics(a.addOrUpdate,d).then(function(c){f._patchTile(b,{type:"update",
addOrUpdate:c,remove:a.remove,end:!0})});h.push(c)});E.release(c);return m.all(h).then(function(){})};d.prototype._addTile=function(a,b){var c=k.create();this.view.featuresTilingScheme.getTileBounds(c,a);c=new U.WGLTile(a,c,!0);b={type:"update",clear:!0,addOrUpdate:b,remove:[],end:!0};this._tiles.set(a,c);this.container.addChild(c);c.setData(b)};d.prototype._addNewTile=function(a,b){var c=this,d=this._graphicStore.queryTileData(this._templateStore,a);if(b){b=Math.round((b.valid[1]-b.valid[0])/a.resolution);
for(var e=0;e<d.length;e++){var l=d[e];l.geometry&&h.isPoint(l.geometry)&&this._wrapPoints(l,b)}}var g=a.key;this._tileUpdateSet.add(a.key);this.notifyChange("updating");this._processGraphics(d).then(function(a){c._addTile(g,a);c._tileUpdateSet.delete(g);c.notifyChange("updating")}).catch(function(a){c._tileUpdateSet.delete(g);c.notifyChange("updating");if(!m.isAbortError(a))throw a;})};d.prototype._removeTile=function(a){if(this._tiles.has(a)){var b=this._tiles.get(a);this.container.removeChild(b);
b.destroy();this._tiles.delete(a)}};d.prototype._setFilterState=function(a,b){var c=this._displayIds.get(a);a=this._attributeStore.getHighlightFlag(a);this._attributeStore.setData(c,0,0,a|(b?S.FILTER_FLAG_0:0))};d.prototype._getGraphicsData=function(a,b,c){var d=v.getInfo(this.view.spatialReference);a=this._graphicStore.getGraphicsData(a,b,c);if(d)for(b=Math.round((d.valid[1]-d.valid[0])/b.resolution),d=0;d<a.length;d++)c=a[d],c.geometry&&h.isPoint(c.geometry)&&this._wrapPoints(c,b);a.sort(function(a,
b){return a.insertAfter-b.insertAfter});return a};d.prototype._getGraphicData=function(a,b,c){a=this._graphicStore.getGraphicData(a,b,c);c=[a];var d=v.getInfo(this.view.spatialReference);d&&(b=Math.round((d.valid[1]-d.valid[0])/b.resolution),a.geometry&&h.isPoint(a.geometry)&&this._wrapPoints(a,b));return c};d.prototype._wrapPoints=function(a,b){var c=a.geometry;512===b?20>c.x?a.geometry={points:[[c.x,c.y],[b,0]]}:492<c.x&&(a.geometry={points:[[c.x,c.y],[-b,0]]}):-20>c.x?a.geometry={points:[[c.x,
c.y],[b,0]]}:532<c.x&&(a.geometry={points:[[c.x,c.y],[-b,0]]})};d.prototype._processGraphics=function(a,b){return e.__awaiter(this,void 0,void 0,function(){var c,d,h,l,g,k;return e.__generator(this,function(e){switch(e.label){case 0:c=a&&a.length;if(!c||!this._meshFactory)return[2,null];d=ba.GraphicsReader.from(a);h=this._meshFactory;g=(l=h).analyzeGraphics;k=[d];return[4,this._matcher];case 1:return[4,g.apply(l,k.concat([e.sent(),null,null,b]))];case 2:return e.sent(),this._attributeStore.sendUpdates(),
[2,this._processAnalyzedGraphics(d)]}})})};d.prototype._processAnalyzedGraphics=function(a){var b=this._meshFactory,c=b.createMeshData(a.getApproximateSize());for(a=a.getCursor();a.next();){var d=a.readGraphic();d.insertAfter=-1===d.insertAfter?-1:this._displayIds.get(d.insertAfter);d.displayId=this._displayIds.get(d.attributes[this.uid]);b.writeGraphic(c,a)}b={};c.encode(b,[]);return T.TileData.decode(b)};d.prototype._abortProcessingGraphic=function(a){this._graphicIdToAbortController.has(a)&&this._graphicIdToAbortController.get(a).abort()};
d.prototype._getNullSymbol=function(a){a=a.geometry;return h.isPolyline(a)?w.errorPolylineSymbol2D:h.isPolygon(a)||h.isExtent(a)?w.errorPolygonSymbol2D:w.errorPointSymbol2D};d.prototype._flipUpdatingGraphics=function(){var a=this;this._updatingGraphicsTimer&&clearTimeout(this._updatingGraphicsTimer);this._updatingGraphicsTimer=setTimeout(function(){a._updatingGraphicsTimer=null;a.notifyChange("updating")},160);this.notifyChange("updating")};e.__decorate([p.property()],d.prototype,"_graphicProcessingQueue",
void 0);e.__decorate([p.property({constructOnly:!0})],d.prototype,"requestUpdateCallback",void 0);e.__decorate([p.property({constructOnly:!0})],d.prototype,"graphics",void 0);e.__decorate([p.property({dependsOn:["_graphicProcessingQueue.updating"]})],d.prototype,"updating",null);e.__decorate([p.property()],d.prototype,"view",void 0);e.__decorate([p.property()],d.prototype,"updateRequested",void 0);return d=e.__decorate([p.subclass("esri.views.2d.layers.support.GraphicsView2D")],d)}(ha.GraphicsView(J.HandleOwnerMixin(K.IdentifiableMixin(I))));
y.default=q});