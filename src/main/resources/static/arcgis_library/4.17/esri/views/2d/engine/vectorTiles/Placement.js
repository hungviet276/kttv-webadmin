// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.17/esri/copyright.txt for details.
//>>built
define("require exports ./GeometryUtils ./TextShaping ./decluttering/config ../webgl/Geometry".split(" "),function(Q,e,q,T,ma,c){Object.defineProperty(e,"__esModule",{value:!0});e.PlacementEngine=e.Placement=e.PlacedSymbol=e.Anchor=e.TILE_PIXEL_RATIO=e.TILE_PIXEL_SIZE=e.TILE_COORD_SIZE=void 0;e.TILE_COORD_SIZE=4096;e.TILE_PIXEL_SIZE=512;e.TILE_PIXEL_RATIO=8;Q=function(){return function(c,a,b,l,d){void 0===b&&(b=0);void 0===l&&(l=-1);void 0===d&&(d=.5);this.x=c;this.y=a;this.angle=b;this.segment=l;
this.minzoom=d}}();e.Anchor=Q;var aa=function(){return function(c,a,b,l,d,u,E){void 0===u&&(u=.5);void 0===E&&(E=q.C_INFINITY);this.anchor=c;this.labelAngle=a;this.glyphAngle=b;this.page=l;this.alternateVerticalGlyph=d;this.minzoom=u;this.maxzoom=E}}(),fa=function(){return function(c,a,b,l,d,u,q,e,v,f,n,x){this.tl=c;this.tr=a;this.bl=b;this.br=l;this.mosaicRect=d;this.labelAngle=u;this.minAngle=q;this.maxAngle=e;this.anchor=v;this.minzoom=f;this.maxzoom=n;this.page=x}}();e.PlacedSymbol=fa;var ga=
function(){return function(c){this.shapes=c}}();e.Placement=ga;Q=function(){function S(){}S.prototype.getIconPlacement=function(a,b,l){var d=b.width/b.pixelRatio,u=b.height/b.pixelRatio,e=l.offset[0]-d/2,L=l.offset[1]-u/2,v=b.rect,f=2/b.pixelRatio,n=e-f,x=L-f,g=n+v.width/b.pixelRatio,h=x+v.height/b.pixelRatio;b=new c.Point(n,x);f=new c.Point(g,h);h=new c.Point(n,h);x=new c.Point(g,x);n=l.rotate*q.C_DEG_TO_RAD;g=1===l.rotationAlignment;0<=a.segment&&!g&&(n+=a.angle);if(0!==n){var g=Math.cos(n),r=Math.sin(n);
b.rotate(g,r);f.rotate(g,r);h.rotate(g,r);x.rotate(g,r)}g=new c.Point(a.x,a.y);v=new fa(b,x,h,f,v,0,0,256,g,.5,q.C_INFINITY,0);v=new ga([v]);l.allowOverlap&&l.ignorePlacement||!ma.DECLUTTER_TILES||(b=l.size,f=l.padding,v.iconColliders=[{xTile:a.x,yTile:a.y,dxPixels:e*b-f,dyPixels:L*b-f,hard:!l.optional,partIndex:0,width:d*b+2*f,height:u*b+2*f,angle:n,minLod:.5,maxLod:q.C_INFINITY}]);return v};S.prototype.getTextPlacement=function(a,b,l,d){for(var u=new c.Point(a.x,a.y),E=d.rotate*q.C_DEG_TO_RAD,L=
0===d.rotationAlignment,v=d.keepUpright,f=d.padding,n=.5,x=L?a.angle:0,g=0<=a.segment&&L,h=d.allowOverlap&&d.ignorePlacement?null:[],r=[],ha=!g,t=Number.POSITIVE_INFINITY,y=Number.NEGATIVE_INFINITY,M=t,N=y,S=g?v:L&&v,C=d.size/T.SDF_GLYPH_SIZE,U=!1,m=0;m<b.length;m++){var k=b[m];if(k.vertical){U=!0;break}}var z=m=0;if(!g&&U)switch(k=T.TextShaping.getTextBox(b,d.lineHeight*T.SDF_GLYPH_SIZE),d.anchor){case 1:m=k.height/2;z=-k.width/2;break;case 2:m=-k.height/2;z=k.width/2;break;case 3:m=k.height/2;z=
k.width/2;break;case 4:m=-k.height/2;z=-k.width/2;break;case 5:m=k.height;break;case 7:z=-k.width;break;case 6:z=k.width;break;case 8:m=-k.height}for(var m=m+d.offset[0]*T.SDF_GLYPH_SIZE,z=z+d.offset[1]*T.SDF_GLYPH_SIZE,F,Q=0;Q<b.length;Q++){var k=b[Q],A=k.glyphMosaicItem;if(A&&!A.rect.isEmpty){var O=A.rect,P=A.metrics,B=A.page;if(h&&ha){if(void 0!==F&&F!==k.y){var p=F=void 0,D=void 0,G=void 0;U?(F=-N+m,p=t+z,D=N-M,G=y-t):(F=t+m,p=M+z,D=y-t,G=N-M);var w={xTile:a.x,yTile:a.y,dxPixels:F*C-f,dyPixels:p*
C-f,hard:!d.optional,partIndex:1,width:D*C+2*f,height:G*C+2*f,angle:E,minLod:.5,maxLod:q.C_INFINITY};h.push(w);t=Number.POSITIVE_INFINITY;y=Number.NEGATIVE_INFINITY;M=t;N=y}F=k.y}var V=[];if(g){if(A=(k.x+P.left-4+.5*A.metrics.width)*C*e.TILE_PIXEL_RATIO,n=this._placeGlyph(a,n,A,l,a.segment,1,k.vertical,B,V),v&&(n=this._placeGlyph(a,n,A,l,a.segment,-1,k.vertical,B,V)),2<=n)break}else V.push(new aa(u,x,x,B,!1)),L&&v&&V.push(new aa(u,x+q.C_PI,x+q.C_PI,B,!1));var B=k.x+P.left,A=k.y-T.SDF_GLYPH_BASELINE-
P.top,D=B+P.width,G=A+P.height,I=p=void 0,ba=void 0,ca=void 0;if(!g&&U)if(k.vertical)var H=(B+D)/2-P.height/2,R=(A+G)/2+P.width/2,p=new c.Point(-R-4+m,H-4+z),I=new c.Point(p.x+O.width,p.y+O.height),ba=new c.Point(p.x,I.y),ca=new c.Point(I.x,p.y);else p=new c.Point(-A+4+m,B-4+z),I=new c.Point(p.x-O.height,p.y+O.width),ba=new c.Point(I.x,p.y),ca=new c.Point(p.x,I.y);else p=new c.Point(B-4+m,A-4+z),I=new c.Point(p.x+O.width,p.y+O.height),ba=new c.Point(p.x,I.y),ca=new c.Point(I.x,p.y);for(var ka=R=H=
void 0,la=void 0,ia=0;ia<V.length;ia++){var w=V[ia],W=void 0,X=void 0,Y=void 0,Z=void 0;w.alternateVerticalGlyph?(H||(H=(B+D)/2+m,R=(A+G)/2+z,H=new c.Point(H-P.height/2-4,R+P.width/2+4),R=new c.Point(H.x+O.height,H.y-O.width),ka=new c.Point(R.x,H.y),la=new c.Point(H.x,R.y)),W=H,X=ka,Y=la,Z=R):(W=p,X=ba,Y=ca,Z=I);var da=A,ja=G,ea=w.glyphAngle+E;if(0!==ea){var J=Math.cos(ea),K=Math.sin(ea),W=W.clone(),X=X.clone(),Y=Y.clone(),Z=Z.clone();W.rotate(J,K);Z.rotate(J,K);X.rotate(J,K);Y.rotate(J,K)}J=0;K=
256;g&&U?k.vertical?w.alternateVerticalGlyph?(J=32,K=96):(J=224,K=32):(J=224,K=96):(J=192,K=64);r.push(new fa(W,Y,X,Z,O,w.labelAngle,J,K,w.anchor,w.minzoom,w.maxzoom,w.page));!h||S&&!this._legible(w.labelAngle)||(ha?(B<t&&(t=B),da<M&&(M=da),D>y&&(y=D),ja>N&&(N=ja)):2>w.minzoom&&(w={xTile:a.x,yTile:a.y,dxPixels:(B+m)*C-f,dyPixels:(da+m)*C-f,hard:!d.optional,partIndex:1,width:(D-B)*C+2*f,height:(ja-da)*C+2*f,angle:ea,minLod:w.minzoom,maxLod:w.maxzoom},h.push(w)))}}}if(2<=n)return null;h&&ha&&(G=D=F=
void 0,U?(F=-N+m,b=t+z,D=N-M,G=y-t):(F=t+m,b=M+z,D=y-t,G=N-M),w={xTile:a.x,yTile:a.y,dxPixels:F*C-f,dyPixels:b*C-f,hard:!d.optional,partIndex:1,width:D*C+2*f,height:G*C+2*f,angle:E,minLod:.5,maxLod:q.C_INFINITY},h.push(w));a=new ga(r);h&&0<h.length&&(a.textColliders=h);return a};S.prototype._legible=function(a){a=q.radToByte(a);return 65>a||193<=a};S.prototype._placeGlyph=function(a,b,l,d,e,E,L,v,f){var n=0>E?q.positiveMod(a.angle+q.C_PI,q.C_2PI):a.angle,x=0;0>l&&(E*=-1,l*=-1,x=q.C_PI);0<E&&++e;a=
new c.Point(a.x,a.y);var g=d[e],h=q.C_INFINITY;if(d.length<=e)return h;for(;;){var r=g.x-a.x,u=g.y-a.y,t=Math.sqrt(r*r+u*u),y=Math.max(l/t,b),r=q.positiveMod(Math.atan2(u/t,r/t)+x,q.C_2PI);f.push(new aa(a,n,r,v,!1,y,h));L&&f.push(new aa(a,n,r,v,!0,y,h));if(y<=b)return y;a=g.clone();do{e+=E;if(d.length<=e||0>e)return y;g=d[e]}while(a.isEqual(g));h=g.x-a.x;r=g.y-a.y;u=Math.sqrt(h*h+r*r);h*=t/u;r*=t/u;a.x-=h;a.y-=r;h=y}};return S}();e.PlacementEngine=Q});