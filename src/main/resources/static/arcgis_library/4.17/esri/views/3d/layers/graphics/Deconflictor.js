// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.17/esri/copyright.txt for details.
//>>built
define("require exports tslib ../../../../core/Accessor ../../../../core/MapUtils ../../../../core/mathUtils ../../../../core/maybe ../../../../core/PooledArray ../../../../core/accessorSupport/decorators ../../../../core/libs/gl-matrix-2/mat4 ../../../../core/libs/gl-matrix-2/mat4f64 ../../../../core/libs/gl-matrix-2/vec2f64 ../../../../core/libs/gl-matrix-2/vec3 ../../../../core/libs/gl-matrix-2/vec3f64 ../../../../core/libs/gl-matrix-2/vec4 ../../../../core/libs/gl-matrix-2/vec4f64 ../../../../core/libs/gl-matrix-2/factories/vec3f64 ../../../../geometry/support/aaBoundingRect ../../../../geometry/support/geodesicConstants ./deconflictorDebug ../../support/debugFlags ../../support/geometryUtils ../../support/geometryUtils/sphere ../../webgl-engine/lib/Camera ../../webgl-engine/lib/screenSizePerspectiveUtils ../../webgl-engine/lib/Util ../../webgl-engine/materials/HUDMaterial".split(" "),
function(C,h,k,x,K,D,t,E,y,L,M,N,n,u,v,F,G,p,O,z,P,q,Q,R,S,H,T){function I(e){var b,a,g,c,f;return k.__generator(this,function(d){switch(d.label){case 0:if(!Map.prototype.entries)return[3,5];b=e.entries();a=b.next();d.label=1;case 1:return a.done?[3,4]:[4,a.value[1]];case 2:d.sent(),d.label=3;case 3:return a=b.next(),[3,1];case 4:return[3,9];case 5:g=K.valuesOfMap(e),c=0,f=g,d.label=6;case 6:if(!(c<f.length))return[3,9];a=f[c];return[4,a];case 7:d.sent(),d.label=8;case 8:return c++,[3,6];case 9:return[2]}})}
function U(e,b,a){var g,c;return k.__generator(this,function(f){switch(f.label){case 0:return b.clear(),e.forEach(function(c,g){var d=b.pushNew();d.id=g;d.prio=c.info?-c.info[a].distance:Number.MAX_VALUE}),[4];case 1:f.sent(),g=b.iterableSort(function(a,c){return c.prio-a.prio}),c=g.next(),f.label=2;case 2:return c.done?[3,5]:[4];case 3:f.sent(),f.label=4;case 4:return c=g.next(),[3,2];case 5:return b.forEachSimple(function(a){var c=e.get(a.id);c&&(e.delete(a.id),e.set(a.id,c))}),b.clear(),[2]}})}
Object.defineProperty(h,"__esModule",{value:!0});h.Deconflictor=h.DeconflictorViewState=h.DeconflictorGraphic=void 0;var m=u.vec3f64.create(),r=F.vec4f64.create(),w=F.vec4f64.create(),A=u.vec3f64.create(),V=M.mat4f64.create(),W=q.sphere.create(),B=q.ray.create(),X=u.vec3f64.create(),Y=p.create(),Z=function(){return function(){this.aabr=p.create();this.distance=0;this.visible=this.culled=!1}}();C=function(){return function(e,b,a){void 0===a&&(a={});this.graphics3DGraphic=e;this.slicePlaneEnabled=b;
this.info=a}}();h.DeconflictorGraphic=C;var aa=function(){function e(){this.active=new Map;this.visible=new Map}e.prototype.clear=function(){this.active.clear();this.visible.clear()};return e}(),ba=function(){return function(){}}(),ca=function(){return function(){this.sortArray=new E({allocator:function(e){return e||new ba}})}}(),J=function(){function e(){this.camera=new R.default;this.slicePlane=q.boundedPlane.create();this.slicePlaneEnabled=!1}e.prototype.copyFrom=function(b){this.camera.copyFrom(b.camera);
q.boundedPlane.copy(b.slicePlane,this.slicePlane);this.slicePlaneEnabled=b.slicePlaneEnabled};return e}();h.DeconflictorViewState=J;x=function(e){function b(){var a=null!==e&&e.apply(this,arguments)||this;a._dirty=!1;a._runningViewState=new J;a._state=0;a.graphics=new aa;a.iterators=new ca;a.accBinsNumX=15;a.accBinsNumY=20;a.accBinsSizeX=0;a.accBinsSizeY=0;a.accBins=null;a.accNumTests=0;return a}k.__extends(b,e);Object.defineProperty(b.prototype,"dirty",{get:function(){return this._dirty},enumerable:!1,
configurable:!0});Object.defineProperty(b.prototype,"state",{get:function(){return this._state},enumerable:!1,configurable:!0});b.prototype.destroy=function(){this.graphics.clear();this.iterators=null};b.prototype.setDirty=function(){!this._dirty&&0<this.graphics.active.size&&(this._dirty=!0,this.notifyChange("updating"))};Object.defineProperty(b.prototype,"updating",{get:function(){return 0!==this._state||this._dirty},enumerable:!1,configurable:!0});Object.defineProperty(b.prototype,"updatingProgress",
{get:function(){if(!this.updating)return 1;var a=this._state/4;return this._dirty?.5*a:a},enumerable:!1,configurable:!0});b.prototype.needsUpdate=function(){return this.view.ready&&null!=this.view.state&&this.updating};b.prototype.update=function(a){switch(this._state){case 0:this.startUpdate(),a.madeProgress();case 1:if(this._state=1,!this.processActiveGraphics(a))break;case 2:if(this._state=2,!this.sortVisibleGraphics(a))break;case 3:if(this._state=3,!this.deconflictVisibleGraphics(a))break;default:z.drawAccelerationStruct(this,
this.graphics.visible),this._state=0,this.notifyChange("updating")}};b.prototype.modifyGraphics=function(a,b){var c=this;b?a.forEach(function(a){return c.addToActiveGraphics(a)}):a.forEach(function(a){return c.removeFromActiveGraphics(a)});this.setDirty()};b.prototype.layerSupportsDeconfliction=function(a){if(t.isNone(a)||"object3d"!==a.type)return!1;a=a.stageObject;return 1===(a?a.getNumGeometryRecords():0)&&a.getGeometryRecord(0).material instanceof T.default?!0:!1};b.prototype.startUpdate=function(){z.prepare(this.view);
this._dirty=!1;this._runningViewState.copyFrom(this.viewState);var a=this._runningViewState.camera;this.initBins(a.fullWidth,a.fullHeight);this.resetIterators()};b.prototype.addToActiveGraphics=function(a){a.info[this.visibilityGroup]=new Z;this.graphics.active.set(a.graphics3DGraphic.graphic.uid,a);this.setDirty()};b.prototype.removeFromActiveGraphics=function(a){this.removeFromVisibleGraphics(a);var b=a.graphics3DGraphic;b.destroyed||b.clearVisibilityFlag(3,this.visibilityGroup);delete a.info[this.visibilityGroup];
this.graphics.active.delete(a.graphics3DGraphic.graphic.uid);this.setDirty()};b.prototype.addToVisibleGraphics=function(a){this.graphics.visible.set(a.graphics3DGraphic.graphic.uid,a)};b.prototype.removeFromVisibleGraphics=function(a){this.graphics.visible.delete(a.graphics3DGraphic.graphic.uid)};b.prototype.processActiveGraphics=function(a){var b=this.ensureActiveGraphicsIterator(),c=L.mat4.invert(V,this._runningViewState.camera.projectionMatrix),f="global"===this.view.viewingMode&&1===this.view.map.ground.opacity&&
0<this._runningViewState.camera.relativeElevation?W:null,d=0;t.isSome(f)&&(n.vec3.transformMat4(f.center,G.ZEROS,this._runningViewState.camera.viewMatrix),f.radius=O.earthRadius,d=q.sphere.distanceToSilhouette(f,G.ZEROS));for(;!a.done;){a.madeProgress();var l=b.next();if(l.done)return this.resetActiveGraphicsIterator(),!0;var e=(l=l.value)&&l.info[this.visibilityGroup];e&&(this.collectGraphics3DGraphics(l,c,f,d),e.culled?this.removeFromVisibleGraphics(l):this.addToVisibleGraphics(l))}return!1};b.prototype.sortVisibleGraphics=
function(a){for(var b=this.ensureSortGraphicsIterator();!a.done;){var c=b.next();a.madeProgress();if(c.done)return this.resetSortGraphicsIterator(),!0}return!1};b.prototype.deconflictVisibleGraphics=function(a){for(var b=this.ensureVisibleGraphicsIterator(),c=1===this.visibilityGroup;!a.done;){a.madeProgress();var f=b.next();if(f.done)return this.resetVisibleGraphicsIterator(),!0;var f=f.value,d=f.info[this.visibilityGroup];if(d&&!d.culled){var l=f.graphics3DGraphic;(l=(!c||l.isVisible())&&!this.isConflicted(f))&&
this.addToBins(f);d.visible=l;this.setGraphicVisibility(f,l);z.drawPoly(d,l)}}return!1};b.prototype.resetIterators=function(){this.iterators.active=null;this.iterators.visible=null;this.iterators.sort=null};b.prototype.ensureActiveGraphicsIterator=function(){this.iterators.active||(this.iterators.active=I(this.graphics.active));return this.iterators.active};b.prototype.resetActiveGraphicsIterator=function(){this.iterators.active=null};b.prototype.ensureVisibleGraphicsIterator=function(){this.iterators.visible||
(this.iterators.visible=I(this.graphics.visible));return this.iterators.visible};b.prototype.resetVisibleGraphicsIterator=function(){this.iterators.visible=null};b.prototype.ensureSortGraphicsIterator=function(){this.iterators.sort||(this.iterators.sort=U(this.graphics.visible,this.iterators.sortArray,this.visibilityGroup));return this.iterators.sort};b.prototype.resetSortGraphicsIterator=function(){this.iterators.sort=null};b.prototype.collectGraphics3DGraphics=function(a,b,c,f){var d=a.graphics3DGraphic;
if(!d.destroyed){var g=a.info[this.visibilityGroup];if(d.isVisible(0,3)){d=this.getGraphicsLayers(d);p.empty(g.aabr);for(var e=null,h=0;h<d.length;h++){var k=d[h];if(this.layerSupportsDeconfliction(k)){var n=k.stageObject.getGeometryRecord(0).material;if(t.isNone(e)){e=this.getProjectionInfo(k,b,da);if(e.isOutsideScreen||this.isCulledBySlice(a,m)||t.isSome(c)&&this.isCulledByHorizon(e,c,f)){g.culled=!0;return}!P.DISABLE_DECONFLICTOR_VISIBILITY_OFFSET&&g.visible&&(e.distance*=.7)}this.expandBoundingRect(g,
k,n,e)}}t.isNone(e)?g.culled=!0:(g.distance=e.distance,g.culled=!1)}else g.culled=!0}};b.prototype.getProjectionInfo=function(a,b,c){var g=this._runningViewState.camera;a=a.stageObject;var d=a.getGeometryRecord(0),e=d.material,h=a.getCenter();n.vec3.transformMat4(m,h,g.viewMatrix);d=d.geometry.data.getVertexAttr();h=d[H.VertexAttrConstants.AUXPOS1].data;e.applyShaderOffsetsView(m,d[H.VertexAttrConstants.NORMAL].data,a.objectTransformation,h,g,c.scaleInfo,m);v.vec4.set(r,m[0],m[1],m[2],1);v.vec4.transformMat4(w,
r,g.projectionMatrix);n.vec3.scale(c.positionNDC,w,1/w[3]);e.applyShaderOffsetsNDC(c.positionNDC,h,g,c.positionNDC,A);c.distanceWithoutPolygonOffset=g.depthNDCToWorld(A[2]);c.distance=A[2]===c.positionNDC[2]?c.distanceWithoutPolygonOffset:g.depthNDCToWorld(c.positionNDC[2]);v.vec4.set(w,c.positionNDC[0],c.positionNDC[1],c.positionNDC[2],1);v.vec4.transformMat4(r,w,b);v.vec4.scale(r,r,1/r[3]);n.vec3.set(c.positionView,m[0],m[1],m[2]);return c};b.prototype.isCulledByHorizon=function(a,b,c){n.vec3.copy(B.direction,
a.positionView);n.vec3.set(B.origin,0,0,0);return Q.intersectRay(b,B,X)?a.distanceWithoutPolygonOffset>c:!1};b.prototype.isCulledBySlice=function(a,b){return a.slicePlaneEnabled&&this._runningViewState.slicePlaneEnabled&&q.boundedPlane.extrusionContainsPoint(this._runningViewState.slicePlane,b)};b.prototype.expandBoundingRect=function(a,b,c,f){var d=f.positionNDC;f=f.scaleInfo;var g=this._runningViewState.camera;b=b.getScreenSize(ea);S.applyPrecomputedScaleFactor(b,f.factor,b);b[0]*=g.pixelRatio;
b[1]*=g.pixelRatio;c=p.offset(c.calculateRelativeScreenBounds(b,f.factorAlignment.scale,Y),D.lerp(0,g.fullWidth,.5+.5*d[0]),D.lerp(0,g.fullHeight,.5+.5*d[1]));d=this.iconMarginFactor;0!==d&&(d*=Math.min(p.width(c),p.height(c)),c[0]-=d,c[1]-=d,c[2]+=d,c[3]+=d);p.expand(a.aabr,c)};b.prototype.isConflicted=function(a){var b=a.graphics3DGraphic.graphic.uid;a=a.info[this.visibilityGroup];for(var c=Math.floor(a.aabr[0]/this.accBinsSizeX);c<=Math.floor(a.aabr[2]/this.accBinsSizeX);c++)if(!(0>c||c>=this.accBinsNumX))for(var f=
Math.floor(a.aabr[1]/this.accBinsSizeY);f<=Math.floor(a.aabr[3]/this.accBinsSizeY);f++)if(!(0>f||f>=this.accBinsNumY))for(var d=this.accBins[c][f],e=0;e<d.length;e++){var h=d.data[e],k=h.info[this.visibilityGroup];if(k&&k.visible&&h.graphics3DGraphic.graphic.uid!==b&&(this.accNumTests++,p.intersects(k.aabr,a.aabr)))return!0}return!1};b.prototype.initBins=function(a,b){if(null==this.accBins){this.accBins=[];for(var c=0;c<this.accBinsNumX;c++){this.accBins.push([]);for(var e=this.accBins[this.accBins.length-
1],d=0;d<this.accBinsNumY;d++)e.push(new E)}}else for(c=0;c<this.accBinsNumX;c++)for(d=0;d<this.accBinsNumY;d++)this.accBins[c][d].clear();this.accBinsSizeX=a/this.accBinsNumX;this.accBinsSizeY=b/this.accBinsNumY;this.accNumTests=0};b.prototype.addToBins=function(a){for(var b=a.info[this.visibilityGroup],c=Math.floor(b.aabr[2]/this.accBinsSizeX),e=Math.floor(b.aabr[1]/this.accBinsSizeY),d=Math.floor(b.aabr[3]/this.accBinsSizeY),b=Math.floor(b.aabr[0]/this.accBinsSizeX);b<=c;b++)if(!(0>b||b>=this.accBinsNumX))for(var h=
e;h<=d;h++)0>h||h>=this.accBinsNumY||this.accBins[b][h].push(a)};b.prototype.setGraphicVisibility=function(a,b){a=a.graphics3DGraphic;a.destroyed||(a.setVisibilityFlag(3,b,this.visibilityGroup),1===this.visibilityGroup&&this.view.labeler.setLabelGraphicVisibility(a,b))};k.__decorate([y.property({constructOnly:!0})],b.prototype,"view",void 0);k.__decorate([y.property({type:Boolean,readOnly:!0})],b.prototype,"updating",null);return b=k.__decorate([y.subclass("esri.views.3d.layers.graphics.Deconflictor")],
b)}(x);h.Deconflictor=x;var ea=N.vec2f64.create(),da=new (function(){function e(){this.positionView=u.vec3f64.create();this.positionNDC=u.vec3f64.create();this.distanceWithoutPolygonOffset=this.distance=0;this.scaleInfo={factor:{scale:0,factor:0,minPixelSize:0,paddingPixels:0},factorAlignment:{scale:0,factor:0,minPixelSize:0,paddingPixels:0}}}Object.defineProperty(e.prototype,"isOutsideScreen",{get:function(){var b=this.positionNDC;return-1>b[0]||-1>b[1]||-1>b[2]||1<=b[0]||1<=b[1]},enumerable:!1,
configurable:!0});return e}())});