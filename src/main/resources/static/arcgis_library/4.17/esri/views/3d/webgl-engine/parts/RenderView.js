// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.17/esri/copyright.txt for details.
//>>built
define("require exports tslib ../../../../core/Accessor ../../../../core/Evented ../../../../core/has ../../../../core/Logger ../../../../core/maybe ../../../../core/scheduling ../../../../core/watchUtils ../../../../core/accessorSupport/decorators ../../../../layers/support/timeUtils ../../support/animationUtils ../collections/Component/ComponentObjectCollection ../core/shaderTechnique/CommonUniformStore ../core/shaderTechnique/ShaderTechniqueRepository ../lib/AutoDisposable ../lib/CompositingHelper ../lib/GLMaterialRep ../lib/Renderer ../lib/TextureRepository ../lib/tracer ../lib/WebGLDriverTest ../materials/lineStippleUtils ../materials/internal/WaterTextureRepository ./requireUtils ./ScreenshotManager ../../../webgl/context-util ../../../webgl/RenderingContext".split(" "),
function(k,f,d,l,m,n,p,q,r,t,g,u,v,w,x,y,e,z,A,B,C,h,D,E,F,G,H,I,J){Object.defineProperty(f,"__esModule",{value:!0});f.RenderView=void 0;var K=p.getLogger("esri.views.3d.webgl-engine.parts.View");k=function(f){function c(a){var b=f.call(this,{})||this;b._stage=a;b.events=new m;b._stippleTextureRepository=new E.StippleTextureRepository;b.waterTextureRepository=new F.WaterTextureRepository;b._commonUniformStore=new x.CommonUniformStore;b._componentObjectCollection=null;b._needsUpdate=!0;b._needsRender=
!0;b._idleSuspend=!0;b._logicUpdateLast=0;b._stats={renderTimeTotal:0,renderTimeLast:0,frameCount:0};b._container=b._stage.container;b._initializeContext(b._stage.options);t.init(b.waterTextureRepository,"loadingState",function(){return b.setNeedsRender()});b._shaderTechniqueRepository=new y.ShaderTechniqueRepository({rctx:b._rctx,viewingMode:b._stage.options.viewingMode,commonUniformStore:b._commonUniformStore,stippleTextureRepository:b._stippleTextureRepository,waterTextureRepository:b.waterTextureRepository});
b._textureRepository=new C.TextureRepository(b._stage.scheduler,b._stage.getAll(4),b._shaderTechniqueRepository,b._rctx);b._textureRepository.events.on("changed",function(a){return b.setNeedsRender(a)});b._materialRepository=new A(b._textureRepository,b._shaderTechniqueRepository,function(){return b.setNeedsRender()});b._compositingHelper=new z.default(b._rctx,b._shaderTechniqueRepository);a=b._container.getBoundingClientRect();b._renderer=new B.default(b._materialRepository,b._textureRepository,
b._shaderTechniqueRepository,b._rctx,b._compositingHelper,function(a){void 0===a&&(a=1);return b.setNeedsRender(a)},[a.width,a.height],b._stage);b._screenshotManager=new H.ScreenshotManager(b._rctx,function(a,c,d){return b._render(a,c,d)},function(){return b.setNeedsRender()},b._stage.options.screenshot.renderOverlay,function(a){return b.events.emit("force-camera-for-screenshot",a)});b._registerFrameTask();return b}d.__extends(c,f);c.prototype.normalizeCtorArgs=function(){return{}};c.prototype.dispose=
function(){this._container.contains(this._canvas)&&this._container.removeChild(this._canvas);this._frameTask&&(this._frameTask.remove(),this._frameTask=null);this._shaderTechniqueRepository.dispose();this._shaderTechniqueRepository=null;D.clearTestWebGLDriver(this._rctx);f.prototype.dispose.call(this);this._rctx=null};c.prototype.getCombinedStats=function(){var a=this._rctx.gl;return d.__assign(d.__assign({},this._stats),{scene:this._renderer.getStats(),textureMemory:void 0!==a.getUsedTextureMemory?
a.getUsedTextureMemory():void 0,renderbufferMemory:void 0!==a.getUsedRenderbufferMemory?a.getUsedRenderbufferMemory():void 0,VBOMemory:void 0!==a.getUsedVBOMemory?a.getUsedVBOMemory():void 0})};c.prototype.setNeedsRender=function(a){void 0===a&&(a=1);1===a?this._needsUpdate||(this._needsUpdate=!0,this.notifyChange("updating")):this._needsRender=!0};Object.defineProperty(c.prototype,"canRender",{get:function(){return this._renderer.canRender},enumerable:!1,configurable:!0});Object.defineProperty(c.prototype,
"needsUpdate",{get:function(){return this._needsUpdate},enumerable:!1,configurable:!0});Object.defineProperty(c.prototype,"updating",{get:function(){return this.needsUpdate||this._renderer.updating||0<this._textureRepository.loadingCount||this.waterTextureRepository.updating||this._stage.dirty},enumerable:!1,configurable:!0});c.prototype.ensureEdgeView=function(){return this._renderer.ensureEdgeView()};Object.defineProperty(c.prototype,"edgeView",{get:function(){return this._renderer.edgeView},enumerable:!1,
configurable:!0});Object.defineProperty(c.prototype,"textureRepository",{get:function(){return this._textureRepository},enumerable:!1,configurable:!0});Object.defineProperty(c.prototype,"compositingHelper",{get:function(){return this._compositingHelper},enumerable:!1,configurable:!0});c.prototype.setRenderParameters=function(a){this.setNeedsRender();void 0!==a.idleSuspend&&(this._idleSuspend=!!a.idleSuspend);this._renderer.setRenderParams(a)};Object.defineProperty(c.prototype,"renderingContext",{get:function(){return this._rctx},
enumerable:!1,configurable:!0});c.prototype.has=function(a){return"s3tc"===a?!!this._rctx.capabilities.compressedTextureS3TC:"shaderTextureLOD"===a?!!this._rctx.capabilities.shaderTextureLOD:!1};c.prototype.modify=function(a,b,c){this._renderer.modify(a,a.length,b,b.length,c,c.length)};c.prototype.setCamera=function(a){this._renderer.camera=a};c.prototype.getCamera=function(){return this._renderer.camera};c.prototype.getCanvas=function(){return this._canvas};c.prototype.takeScreenshot=function(a){return this._screenshotManager.takeScreenshot(a)};
Object.defineProperty(c.prototype,"renderPlugins",{get:function(){return this._renderer.renderPlugins},enumerable:!1,configurable:!0});Object.defineProperty(c.prototype,"test",{get:function(){return{renderer:this._renderer}},enumerable:!1,configurable:!0});c.prototype.getGpuMemoryUsage=function(){return this._renderer.getGpuMemoryUsage()};c.prototype.hotReloadShaders=function(){return d.__awaiter(this,void 0,void 0,function(){return d.__generator(this,function(a){switch(a.label){case 0:return G.removeLoadedShaderModules(),
[4,this._shaderTechniqueRepository.hotReload()];case 1:return a.sent(),this.setNeedsRender(),[2]}})})};c.prototype._registerFrameTask=function(){var a=this,b={viewCamera:this._renderer.camera,frameHasSlicePlane:!1};this._frameTask=r.addFrameTask({preRender:function(b){h.begin();var c=!1;a._stage.processDirty();var d=u.Milliseconds(b.time-a._logicUpdateLast);d>v.DESIRED_ANIMATION_MS&&(c=a._renderer.updateLogic({camera:a._renderer.camera,dt:d}),a._logicUpdateLast=b.time);c&&a.setNeedsRender(0)},render:function(){(a.needsUpdate||
a._needsRender||!a._idleSuspend)&&a.canRender&&(a._needsRender=!1,a._needsUpdate=!1,a._render(null,a._renderer.camera,!1))},postRender:function(){a.notifyChange("updating");h.end()},update:function(){b.viewCamera=a._renderer.camera;b.frameHasSlicePlane=a._renderer.hasSlicePlane;a._textureRepository.update();a._screenshotManager.update(b)}})};c.prototype._initializeContext=function(a){this._canvas=a.canvas;this._canvas||(this._canvas=document.createElement("canvas"));this._canvas.setAttribute("style",
"width: 100%; height:100%; display:block;");var b=h.instrumentContext(I.createContextOrErrorHTML(this._canvas,{alpha:a.alpha||!1,premultipliedAlpha:!0,antialias:!1,depth:!0,stencil:null==a.stencil?!0:a.stencil,powerPreference:"high-performance"},a.renderContext));this._rctx=new J(b,{disabledExtensions:a.deactivatedWebGLExtensions||{},debugWebGLExtensions:a.debugWebGLExtensions||{}});null!=this._rctx.parameters.maxMaxAnisotropy&&(this._rctx.parameters.maxMaxAnisotropy=Math.min(this._rctx.parameters.maxMaxAnisotropy,
8));this._loadShaderOnlyExtensions(this._rctx);!a.alpha&&this._rctx.contextAttributes.alpha&&K.error("WebGL context has alpha channel even though no alpha channel was requested");!this._rctx.contextAttributes.alpha&&11<=n("safari")&&(this._container.style.backgroundColor="black");this._container.appendChild(this._canvas)};c.prototype._render=function(a,b,c){this._renderer.setLighting(this._stage.lighting);this._renderer.render(a,b,c,this._stage.mainLightDirection)};c.prototype._loadShaderOnlyExtensions=
function(a){a=a.capabilities;a.standardDerivatives;a.shaderTextureLOD;a.textureFloat};Object.defineProperty(c.prototype,"componentObjectCollection",{get:function(){q.isNone(this._componentObjectCollection)&&(this._componentObjectCollection=new w.ComponentObjectCollection(this._renderer.renderPassManager));return this._componentObjectCollection},set:function(a){this._componentObjectCollection=a},enumerable:!1,configurable:!0});d.__decorate([g.property({type:Boolean,readOnly:!0,dependsOn:["waterTextureRepository.updating"]})],
c.prototype,"updating",null);d.__decorate([e.autoDispose()],c.prototype,"_rctx",void 0);d.__decorate([e.autoDispose()],c.prototype,"_container",void 0);d.__decorate([e.autoDispose()],c.prototype,"_canvas",void 0);d.__decorate([e.autoDispose()],c.prototype,"_stippleTextureRepository",void 0);d.__decorate([e.autoDispose(),g.property()],c.prototype,"waterTextureRepository",void 0);d.__decorate([e.autoDispose()],c.prototype,"_textureRepository",void 0);d.__decorate([e.autoDispose()],c.prototype,"_commonUniformStore",
void 0);d.__decorate([e.autoDispose()],c.prototype,"_compositingHelper",void 0);d.__decorate([e.autoDispose()],c.prototype,"_renderer",void 0);d.__decorate([e.autoDispose()],c.prototype,"_screenshotManager",void 0);d.__decorate([e.autoDispose()],c.prototype,"componentObjectCollection",null);d.__decorate([e.autoDispose()],c.prototype,"_componentObjectCollection",void 0);return c=d.__decorate([g.subclass("esri.views.3d.webgl-engine.parts.RenderView")],c)}(e.AutoDisposableMixin(l));f.RenderView=k});