// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.17/esri/copyright.txt for details.
//>>built
define("require exports tslib ../../../core/Accessor ../../../core/SetUtils ../../../core/accessorSupport/decorators ../../../core/libs/gl-matrix-2/vec2 ../../support/QueueProcessor".split(" "),function(x,y,c,t,n,e,u,v){function w(c,b){c.length=0;b.forEach(function(a){return c.push(a)});return c}var p=new Set,k=[],h=new Map,r=[0,0];return function(q){function b(a){a=q.call(this,a)||this;a._keyToItem=new Map;a.concurrency=6;a.strategy="scale-first";a.tileInfoView=null;return a}c.__extends(b,q);b.prototype.initialize=
function(){var a=this,b=this.concurrency,c=this.process;this._peekByScaleFirst;this._peekByCenterFirst;this._queue=new v.QueueProcessor({concurrency:b,process:function(b,g){b=a._keyToItem.get(b);return c(b,{signal:g})},peeker:function(a){return n.firstOfSet(a)}})};b.prototype.destroy=function(){this.clear();this._queue.destroy();this._queue=null};Object.defineProperty(b.prototype,"length",{get:function(){return this._queue?this._queue.length:0},enumerable:!1,configurable:!0});Object.defineProperty(b.prototype,
"onGoingCount",{get:function(){return this._keyToItem.size},enumerable:!1,configurable:!0});Object.defineProperty(b.prototype,"updating",{get:function(){return 0<this.length||0<this.onGoingCount},enumerable:!1,configurable:!0});b.prototype.abort=function(a){this._queue.abort("string"===typeof a?a:a.id)};b.prototype.clear=function(){this._queue.clear();this._keyToItem.clear();this.notifyChange("updating")};b.prototype.has=function(a){return"string"===typeof a?this._keyToItem.has(a):this._keyToItem.has(a.id)};
b.prototype.isOngoing=function(a){a="string"===typeof a?a:a.id;return this.has(a)&&this._queue.isOngoing(a)};b.prototype.pause=function(){this._queue.pause()};b.prototype.push=function(a,b){var c=this,f=a.key.id+"-"+b;if(this.has(f))return this.get(f);b=this._queue.push(f);var g=function(){c._keyToItem.delete(f);c.notifyChange("updating")};this._keyToItem.set(f,a);b.then(g,g);this.notifyChange("updating");return b};b.prototype.reset=function(){this._queue.reset();this.notifyChange("updating")};b.prototype.resume=
function(){this._queue.resume()};b.prototype._peekByScaleFirst=function(a){var b=this;if(!this.state)return n.firstOfSet(a);var c=this.tileInfoView,f=Number.NEGATIVE_INFINITY,g=Number.POSITIVE_INFINITY;a.forEach(function(a){a=b._keyToItem.get(a);var c=b.tileInfoView.getTileScale(a.key);h.has(c)||(h.set(c,[]),f=Math.max(c,f),g=Math.min(c,g));h.get(c).push(a.key);p.add(c)});var d=this.state.scale;h.has(d)||(w(k,p),k.sort(),d=k.reduce(function(a,b){return Math.abs(b-d)<Math.abs(a-d)?b:a},k[0]));d=Math.min(d,
f);d=Math.max(d,g);a=h.get(d);var l=c.getClosestInfoForScale(d),e=l.getColumnForX(this.state.center[0]),m=l.getRowForY(this.state.center[1]);a.sort(function(a,b){var c=l.denormalizeCol(a.col,a.world),d=l.denormalizeCol(b.col,b.world);return Math.sqrt((e-c)*(e-c)+(m-a.row)*(m-a.row))-Math.sqrt((e-d)*(e-d)+(m-b.row)*(m-b.row))});p.clear();h.clear();return a[0].id};b.prototype._peekByCenterFirst=function(a){var b=this;if(!this.state)return n.firstOfSet(a);var c=this.tileInfoView,e=this.state.center,
g=Number.POSITIVE_INFINITY,d=null;a.forEach(function(a){a=b._keyToItem.get(a);c.getTileCoords(r,a.key);var f=u.vec2.distance(r,e);f<g&&(g=f,d=a.key)});return d.id};c.__decorate([e.property({constructOnly:!0})],b.prototype,"concurrency",void 0);c.__decorate([e.property({constructOnly:!0})],b.prototype,"process",void 0);c.__decorate([e.property()],b.prototype,"state",void 0);c.__decorate([e.property({constructOnly:!0})],b.prototype,"strategy",void 0);c.__decorate([e.property({constructOnly:!0})],b.prototype,
"tileInfoView",void 0);c.__decorate([e.property({readOnly:!0})],b.prototype,"updating",null);return b=c.__decorate([e.subclass("esri.views.2d.tiling.PagedTileQueue")],b)}(t)});