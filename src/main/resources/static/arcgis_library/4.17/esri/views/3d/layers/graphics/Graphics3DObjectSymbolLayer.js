// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.17/esri/copyright.txt for details.
//>>built
define("require exports tslib ../../../../Color ../../../../core/lang ../../../../core/maybe ../../../../core/screenUtils ../../../../core/libs/gl-matrix-2/mat4 ../../../../core/libs/gl-matrix-2/mat4f64 ../../../../core/libs/gl-matrix-2/vec3 ../../../../core/libs/gl-matrix-2/vec3f64 ../../../../core/libs/gl-matrix-2/vec4f64 ../../../../geometry/support/aaBoundingBox ../../../../symbols/support/ObjectSymbol3DLayerResource ../../../../symbols/support/symbolLayerUtils3D ./ElevationAligners ./elevationAlignmentUtils ./ElevationContext ./Graphics3DLodInstanceGraphicLayer ./Graphics3DSymbolLayer ./graphicUtils ./lodResourceUtils ./objectResourceUtils ./pointUtils ./primitiveObjectSymbolUtils ./symbolComplexity ../support/FastSymbolUpdates ../../support/pointUtils ../../support/projectionUtils ../../webgl-engine/lib/Util ../../webgl-engine/lib/lodRendering/LodRenderer ../../webgl-engine/lib/lodRendering/LodResources ../../webgl-engine/materials/DefaultMaterial".split(" "),
function(E,n,I,z,P,f,Q,A,J,q,g,p,u,X,K,Y,F,Z,aa,ba,x,R,ca,B,L,da,G,ea,fa,ga,ha,C,ia){Object.defineProperty(n,"__esModule",{value:!0});n.Graphics3DObjectSymbolLayer=void 0;E=function(n){function e(b,a,c,d){b=n.call(this,b,a,c,d)||this;b._resources=null;b._optionalFields=[];b._instanceIndexToGraphicUid=new Map;b.ensureDrapedStatus(!1);return b}I.__extends(e,n);e.prototype.getCachedSize=function(){var b=f.isSome(this._resources)?this._resources.symbolSize:[1,1,1];return{width:b[0],depth:b[1],height:b[2]}};
e.prototype.doLoad=function(b){return I.__awaiter(this,void 0,void 0,function(){var a,c,d,k,f;return I.__generator(this,function(e){switch(e.label){case 0:a=this._getIdHint("_objectmat");if(!this._drivenProperties.size&&(c=x.validateSymbolLayerSize(this.symbolLayer)))throw Error();d=this.symbolLayer;if(!this.isPrimitive)return[3,1];k=d.resource?d.resource.primitive:X.defaultPrimitive;this._resources=this._createResourcesForPrimitive(k,a);return[3,3];case 1:return f=this,[4,this._createResourcesForUrl(d.resource.href,
b)];case 2:f._resources=e.sent(),e.label=3;case 3:return this.complexity=this.computeComplexity(),[2]}})})};Object.defineProperty(e.prototype,"extentPadding",{get:function(){return f.isSome(this._resources)?this._resources.extentPadding:0},enumerable:!1,configurable:!0});Object.defineProperty(e.prototype,"isPrimitive",{get:function(){return!(this.symbolLayer.resource&&this.symbolLayer.resource.href)},enumerable:!1,configurable:!0});Object.defineProperty(e.prototype,"lodRenderer",{get:function(){return f.get(this._resources,
"lodRenderer")},enumerable:!1,configurable:!0});e.prototype.setMaterialTransparencyParams=function(b,a){void 0===a&&(a=f.get(this.symbolLayer,"material","color"));a=this._getCombinedOpacity(a);b.transparent=1>a||this.needsDrivenTransparentPass;b.opacity=a;return b};e.prototype._createResourcesForPrimitive=function(b,a){if(!L.isValidPrimitive(b))throw Error("Unknown object symbol primitive: "+b);var c=this.symbolLayer,d=u.create(K.objectSymbolLayerPrimitiveBoundingBox(b)),k=g.vec3f64.fromArray(u.size(d)),
e=g.vec3f64.fromArray(K.objectSymbolLayerSizeWithResourceSize(k,c)),m=q.vec3.length(e),h={usePBR:this._context.physicalBasedRenderingEnabled,isSchematic:!0,instanced:["transformation"],ambient:g.vec3f64.ONES,diffuse:g.vec3f64.ONES,slicePlaneEnabled:this._context.slicePlaneEnabled,sliceHighlightDisabled:!0,castShadows:this.symbolLayer.castShadows,offsetTransparentBackfaces:!this.symbolLayer.isPrimitive},v=h.usePBR;this.setMaterialTransparencyParams(h);var l=this.symbol;if("point-3d"===l.type&&l.verticalOffset){var l=
l.verticalOffset,n=l.minWorldLength,r=l.maxWorldLength;h.verticalOffset={screenLength:Q.pt2px(l.screenLength),minWorldLength:n||0,maxWorldLength:null!=r?r:Infinity};h.castShadows=!1}this._context.screenSizePerspectiveEnabled&&(h.screenSizePerspective=this._context.sharedResources.screenSizePerspectiveSettings);this._drivenProperties.color?h.externalColor=p.vec4f64.ONES:(c=f.isSome(c.material)&&c.material.color,c=f.isSome(c)?z.toUnitRGBA(c):p.vec4f64.ONES,h.externalColor=c);this._fastUpdates=G.initFastSymbolUpdatesState(this._context.renderer,
this._fastVisualVariableConvertOptions(d,e,k,f.none));this._fastUpdates.enabled?(P.mixin(h,this._fastUpdates.materialParameters),h.instanced.push("featureAttribute"),this._optionalFields.push("featureAttribute")):this._hasPerInstanceColor()&&(h.instanced.push("color"),this._optionalFields.push("color"));h=new ia(h,a);a=L.primitiveLodResources(b,h,a);if(!a)throw Error("Unknown object symbol primitive: "+b);b=C.materialsFromLodResources(a).map(function(a){return{opacity:1,transparent:a.getParameters().transparent}});
h=this._createStageResources(a,v);c=this._createLodRenderer(a);return{lodResources:a,lodRenderer:c,stageResources:h,symbolSize:e,extentPadding:m,isEsriSymbolResource:!1,isWosr:!1,originalMaterialParameters:b,physicalBasedRenderingEnabled:v,resourceBoundingBox:d,resourceSize:k,dispose:f.none,pivotOffset:f.none}};e.prototype._createResourcesForUrl=function(b,a){return I.__awaiter(this,void 0,void 0,function(){var c,d,k,e,m,h,v,l,n,r,T,U,V,t,p,w,x,A,B,D,y,E,M,N,z,O,F,H,J,L=this;return I.__generator(this,
function(S){switch(S.label){case 0:return c=["transformation"],d={instanced:c,slicePlaneEnabled:this._context.slicePlaneEnabled,castShadows:this.symbolLayer.castShadows},k={materialParamsMixin:d,streamDataRequester:this._context.streamDataRequester,cache:this._context.sharedResources.objectResourceCache},this._fastUpdates=G.initFastSymbolUpdatesState(this._context.renderer,this._fastVisualVariableConvertOptions(f.none,f.none,f.none,f.none)),this._fastUpdates.enabled?(P.mixin(k.materialParamsMixin,
this._fastUpdates.materialParameters),c.push("featureAttribute"),this._optionalFields.push("featureAttribute")):this._hasPerInstanceColor()&&(c.push("color"),this._optionalFields.push("color")),e=this.symbol,"point-3d"===e.type&&e.verticalOffset&&(m=e.verticalOffset,h=m.screenLength,v=m.minWorldLength,l=m.maxWorldLength,k.materialParamsMixin.verticalOffset={screenLength:Q.pt2px(h),minWorldLength:v||0,maxWorldLength:null!=l?l:Infinity},k.materialParamsMixin.castShadows=!1),k.signal=a,k.usePBR=this._context.physicalBasedRenderingEnabled,
n=k.usePBR,[4,ca.fetch(b,k)];case 1:return r=S.sent(),T=r.isEsriSymbolResource,U=r.isWosr,V=r.remove,t=R.makeLodResources(r.lods),R.fillEstimatedMinScreenSpaceRadius(t),t.levels.sort(function(a,b){return a.minScreenSpaceRadius-b.minScreenSpaceRadius}),t.levels[0].minScreenSpaceRadius=Math.min(2,t.levels[0].minScreenSpaceRadius),p=this._context,w=this.symbolLayer.material,x=this._getExternalColorParameters(w),A=f.get(this.symbolLayer,"material","color"),B=this._getCombinedOpacity(A,{hasIntrinsicColor:!0}),
D=this.needsDrivenTransparentPass,y=C.materialsFromLodResources(t),E=C.materialsFromLodResources(t).map(function(a){a=a.getParameters();return{opacity:a.opacity||1,transparent:a.transparent}}),y.forEach(function(a){var b=a.getParameters();a.setParameterValues(x);var c=b.opacity*B;a.setParameterValues({opacity:c,transparent:1>c||D||b.transparent});p.screenSizePerspectiveEnabled&&a.setParameterValues({screenSizePerspective:p.sharedResources.screenSizePerspectiveSettings})}),M=r.referenceBoundingBox,
N=g.vec3f64.fromArray(u.size(M)),z=g.vec3f64.fromArray(t.levels[0].pivotOffset),O=g.vec3f64.fromArray(K.objectSymbolLayerSizeWithResourceSize(N,this.symbolLayer)),F=q.vec3.length(O),G.updateFastSymbolUpdatesState(this._fastUpdates,this._context.renderer,this._fastVisualVariableConvertOptions(M,O,N,z))&&y.forEach(function(a){return a.setParameterValues(L._fastUpdates.materialParameters)}),H=this._createStageResources(t,n),J=this._createLodRenderer(t),[2,{lodResources:t,lodRenderer:J,stageResources:H,
symbolSize:O,extentPadding:F,isEsriSymbolResource:T,isWosr:U,originalMaterialParameters:E,physicalBasedRenderingEnabled:n,resourceBoundingBox:M,resourceSize:N,dispose:V,pivotOffset:z}]}})})};e.prototype._createStageResources=function(b,a){var c=this._context.stage,d=C.materialsFromLodResources(b);a!==this._context.physicalBasedRenderingEnabled&&this.physicalBasedRenderingChanged();for(a=0;a<d.length;a++)c.add(3,d[a]);a=C.texturesFromLodResources(b);for(var k=0;k<a.length;k++)c.add(4,a[k]);b=C.geometriesFromLodResources(b);
for(k=0;k<b.length;k++)c.add(2,b[k]);return{materials:d,textures:a,geometries:b}};e.prototype._createLodRenderer=function(b){var a=this,c=this._context.stage;b=new ha.LodRenderer(b,this._optionalFields,{layerUid:this._context.layer.uid,graphicUid:function(b){return a._instanceIndexToGraphicUid.get(b)},notifyGraphicUpdate:function(b,c){return a._context.notifyGraphicUpdate(a._instanceIndexToGraphicUid.get(b),c)}},this._fastUpdates.enabled?{applyTransform:function(b,c,e){b.getFeatureAttribute(c,D);
A.mat4.copy(e,G.evaluateModelTransform(a._fastUpdates.materialParameters,D,e))},scaleFactor:function(b,c,e){c.getFeatureAttribute(e,D);return G.evaluateModelTransformScale(b,a._fastUpdates.materialParameters,D)}}:null);b.slicePlane=this._context.slicePlaneEnabled;c.addRenderPlugin(b.slots,b);return b};e.prototype._getExternalColorParameters=function(b){var a={};this._drivenProperties.color?a.externalColor=p.vec4f64.ONES:f.isSome(b)&&f.isSome(b.color)?a.externalColor=z.toUnitRGBA(b.color):(a.externalColor=
p.vec4f64.ONES,a.colorMixMode="ignore");return a};e.prototype.destroy=function(){n.prototype.destroy.call(this);var b=this._context.stage;if(f.isSome(this._resources)){b.removeRenderPlugin(this._resources.lodRenderer);this._resources.lodRenderer.destroy();for(var a=this._resources.stageResources,c=0,d=a.materials;c<d.length;c++)b.remove(3,d[c].id);c=0;for(d=a.textures;c<d.length;c++)b.remove(4,d[c].id);c=0;for(a=a.geometries;c<a.length;c++)b.remove(2,a[c].id);f.isSome(this._resources.dispose)&&this._resources.dispose()}this._resources=
null};e.prototype.createGraphics3DGraphic=function(b){var a=b.graphic;if(!this._validateGeometry(a.geometry))return null;var c=B.placePointOnGeometry(a.geometry);if(f.isNone(c))return this.logger.warn("unsupported geometry type for icon symbol: "+a.geometry.type),null;var d=this.setGraphicElevationContext(a,new Z.ElevationContext);return this._createAs3DShape(a,c,b.renderingInfo,d,a.uid)};e.prototype.notifyDestroyGraphicLayer=function(b){this._instanceIndexToGraphicUid.delete(b.instanceIndex)};e.prototype.graphicLayerToGraphicId=
function(){return 0};e.prototype.layerOpacityChanged=function(){if(f.isNone(this._resources))return!0;for(var b=this._drivenProperties.opacity,a=!this.isPrimitive,c=this._resources.stageResources.materials,d=this._resources.originalMaterialParameters,e=0;e<c.length;e++){var g=c[e],m=f.get(this.symbolLayer,"material","color"),h=d[e],m=this._getCombinedOpacity(m,{hasIntrinsicColor:a})*h.opacity;g.setParameterValues({opacity:m,transparent:1>m||b||h.transparent})}return!0};e.prototype.layerElevationInfoChanged=
function(b,a){return this.updateGraphics3DGraphicElevationInfo(b,a,F.needsElevationUpdates3D)};e.prototype.slicePlaneEnabledChanged=function(){if(f.isNone(this._resources))return!0;this._resources.lodRenderer.slicePlane=this._context.slicePlaneEnabled;for(var b=0,a=this._resources.stageResources.materials;b<a.length;b++)a[b].setParameterValues({slicePlaneEnabled:this._context.slicePlaneEnabled});return!0};e.prototype.physicalBasedRenderingChanged=function(){if(f.isNone(this._resources))return!0;for(var b=
this._resources,a=b.isEsriSymbolResource,c=b.isWosr,d=0,b=b.stageResources.materials;d<b.length;d++){var e=b[d];this.isPrimitive?e.setParameterValues({usePBR:this._context.physicalBasedRenderingEnabled,isSchematic:!0}):a&&!c&&e.setParameterValues({usePBR:this._context.physicalBasedRenderingEnabled,isSchematic:!1})}return!0};e.prototype.pixelRatioChanged=function(){return!0};e.prototype.applyRendererDiff=function(b,a){if(f.isNone(this._resources))return!0;var c=this._resources,d=c.stageResources.materials,
e=c.lodRenderer,g=c.resourceBoundingBox,m=c.symbolSize,h=c.resourceSize,c=c.pivotOffset,v;for(v in b.diff)switch(v){case "visualVariables":if(G.updateFastSymbolUpdatesState(this._fastUpdates,a,this._fastVisualVariableConvertOptions(g,m,h,c))){b=0;for(var l=d;b<l.length;b++)l[b].setParameterValues(this._fastUpdates.materialParameters);e.notifyShaderTransformationChanged()}else return!1;break;default:return!1}return!0};e.prototype.computeComplexity=function(){if(f.isNone(this._resources))return n.prototype.computeComplexity.call(this);
var b=C.geometriesFromLodLevelResources(this._resources.lodResources.levels[0]).reduce(function(a,b){return a+b.data.getIndices(ga.VertexAttrConstants.POSITION).length},0)/3,a=da.defaultSymbolLayerMemoryComplexity(this.symbol,this.symbolLayer);return{primitivesPerFeature:b,primitivesPerCoordinate:0,estimated:!1,memory:a}};e.prototype.hasLodRenderer=function(){return f.isSome(this._resources)};e.prototype._createAs3DShape=function(b,a,c,d,e){if(!this.hasLodRenderer()||f.isNone(this._resources))return null;
b=this.getFastUpdateAttrValues(b);var k=!this._fastUpdates.enabled&&this._hasPerInstanceColor()?x.mixinColorAndOpacity(c.color,c.opacity):null,m=this._context.clippingExtent;ea.pointToVector(a,w,this._context.elevationProvider.spatialReference);if(f.isSome(m)&&!u.containsPoint(m,w))return null;var m=this._requiresTerrainElevation(d),h=this._computeGlobalTransform(a,d,H,m?y:null);c=this._computeLocalTransform(this._resources,this.symbolLayer,c,W);var g=this._resources.lodRenderer.instanceData,l=g.addInstance();
this._instanceIndexToGraphicUid.set(l,e);g.setLocalTransform(l,c,!1);g.setGlobalTransform(l,h);b&&g.setFeatureAttribute(l,b);k&&g.setColor(l,k);e=new aa(this,l,Y.perLodInstanceElevationAligner,d);m&&(e.alignedSampledElevation=y.sampledElevation);e.needsElevationUpdates=F.needsElevationUpdates3D(d.mode);B.extendPointGraphicElevationContext(e,a,this._context.elevationProvider);return e};e.prototype._computeGlobalTransform=function(b,a,c,d){a=F.evaluateElevationAlignmentAtPoint(b,this._context.elevationProvider,
a,this._context.renderCoordsHelper,d);w[0]=b.x;w[1]=b.y;w[2]=a;fa.computeLinearTransformation(b.spatialReference,w,c,this._context.renderCoordsHelper.spatialReference);return c};e.prototype._computeLocalTransform=function(b,a,c,d){A.mat4.identity(d);this._applyObjectRotation(c,!1,d);this._applyObjectRotation(a,!0,d);this._applyObjectScale(b,c,d);this._applyAnchor(b,a,d);return d};e.prototype._applyObjectScale=function(b,a,c){this._fastUpdates.enabled&&this._fastUpdates.requiresShaderTransformation||
(b=x.computeObjectScale(this._drivenProperties.size&&a.size?a.size:b.symbolSize,b.symbolSize,b.resourceSize,this._context.renderCoordsHelper.unitInMeters),1===b[0]&&1===b[1]&&1===b[2]||A.mat4.scale(c,c,b))};e.prototype.prepareSymbolLayerPatch=function(b){if("partial"===b.diff.type){var a=b.diff.diff;this._preparePatchTransform(b,a);this._preparePatchColor(b,a)}};e.prototype.updateGeometry=function(b,a){if(f.isNone(this._resources))return!0;var c=a&&B.placePointOnGeometry(a);if(f.isNone(c))return!1;
a=this.getGeometryElevationMode(a);if(b.elevationContext.mode!==a)return!1;a=this._requiresTerrainElevation(b.elevationContext);this._computeGlobalTransform(c,b.elevationContext,H,a?y:null);a&&(b.alignedSampledElevation=y.sampledElevation);this._resources.lodRenderer.instanceData.setGlobalTransform(b.instanceIndex,H,!0);B.extendPointGraphicElevationContext(b,c,this._context.elevationProvider);return!0};e.prototype._preparePatchTransform=function(b,a){var c=this;if((a.heading||a.tilt||a.roll||a.width||
a.height||a.depth||a.anchor||a.anchorPosition)&&!f.isNone(this._resources)){var d=function(a,b,c){return f.unwrapOr(null!=a&&"complete"===a.type?a.newValue:b,c)},e=d(a.heading,this.symbolLayer.heading,0),n=d(a.tilt,this.symbolLayer.tilt,0),m=d(a.roll,this.symbolLayer.roll,0),h=d(a.width,this.symbolLayer.width,void 0),v=d(a.height,this.symbolLayer.height,void 0),l=d(a.depth,this.symbolLayer.depth,void 0),q=d(a.anchor,this.symbolLayer.anchor,void 0),d=d(a.anchorPosition,this.symbolLayer.anchorPosition,
void 0);delete a.heading;delete a.tilt;delete a.roll;delete a.width;delete a.height;delete a.depth;delete a.anchor;delete a.anchorPosition;var r={heading:e,tilt:n,roll:m,anchor:q,anchorPosition:d},p=this._resources;1===this.loadStatus&&b.symbolLayerStatePatches.push(function(){p.symbolSize=g.vec3f64.fromArray(K.objectSymbolLayerSizeWithResourceSize(p.resourceSize,{width:h,height:v,depth:l,isPrimitive:c.symbolLayer.isPrimitive}))});b.graphics3DGraphicPatches.push(function(a,b){b=c._computeLocalTransform(p,
r,b,W);p.lodRenderer.instanceData.setLocalTransform(a.instanceIndex,b,!0)})}};e.prototype._preparePatchColor=function(b,a){var c=this;if(a.material&&"partial"===a.material.type&&(a=a.material.diff,a.color&&"complete"===a.color.type&&null!=a.color.newValue&&null!=a.color.oldValue)){var d=a.color.newValue,e=f.isSome(d)?z.toUnitRGBA(d):p.vec4f64.ONES;delete a.color;var g=this._resources;f.isNone(g)||b.graphics3DGraphicPatches.push(function(a){c._hasPerInstanceColor()?(g.lodRenderer.instanceData.setColor(a.instanceIndex,
e),a=c.setMaterialTransparencyParams({},d)):a=c.setMaterialTransparencyParams({externalColor:e},d);for(var b=0,f=g.stageResources.materials;b<f.length;b++)f[b].setParameterValues(a)})}};e.prototype._requiresTerrainElevation=function(b){return"absolute-height"!==b.mode};e.prototype._applyObjectRotation=function(b,a,c){if(!(this._fastUpdates.enabled&&this._fastUpdates.requiresShaderTransformation&&a))return x.computeObjectRotation(b.heading,b.tilt,b.roll,c)};e.prototype._computeAnchor=function(b,a,
c){var d=g.vec3f64.create();switch(c.anchor){case "center":q.vec3.copy(d,u.center(b));q.vec3.negate(d,d);break;case "top":a=u.center(b);q.vec3.set(d,-a[0],-a[1],-b[5]);break;case "bottom":a=u.center(b);q.vec3.set(d,-a[0],-a[1],-b[2]);break;case "relative":a=u.center(b);b=u.size(b);c=(c=c.anchorPosition)?g.vec3f64.fromValues(c.x,c.y,c.z):g.vec3f64.ZEROS;q.vec3.multiply(d,b,c);q.vec3.add(d,d,a);q.vec3.negate(d,d);break;default:f.isSome(a)?q.vec3.negate(d,a):q.vec3.copy(d,g.vec3f64.ZEROS)}return d};
e.prototype._applyAnchor=function(b,a,c){this._fastUpdates.enabled&&this._fastUpdates.requiresShaderTransformation||(b=this._computeAnchor(b.resourceBoundingBox,b.pivotOffset,a))&&A.mat4.translate(c,c,b)};e.prototype._hasPerInstanceColor=function(){return this._drivenProperties.color||this._drivenProperties.opacity};e.prototype._fastVisualVariableConvertOptions=function(b,a,c,d){var e=f.isSome(b)?g.vec3f64.fromArray(u.size(b)):g.vec3f64.ONES;b=f.isSome(b)?this._computeAnchor(b,d,this.symbolLayer):
g.vec3f64.ZEROS;d=this._context.renderCoordsHelper.unitInMeters;c=x.computeObjectScale(f.isSome(a)?a:void 0,a,c,d);var n=g.vec3f64.fromValues(this.symbolLayer.tilt||0,this.symbolLayer.roll||0,this.symbolLayer.heading||0);return{modelSize:e,symbolSize:f.isSome(a)?a:g.vec3f64.ONES,unitInMeters:d,transformation:{anchor:b,scale:c,rotation:n}}};return e}(ba.default);n.Graphics3DObjectSymbolLayer=E;var w=g.vec3f64.create(),W=J.mat4f64.create(),H=J.mat4f64.create(),D=p.vec4f64.create(),y={verticalDistanceToGround:0,
sampledElevation:0};n.default=E});