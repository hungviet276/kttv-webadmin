// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.17/esri/copyright.txt for details.
//>>built
define("require exports ../../../../core/maybe ../../../webgl ../brushes ../vectorTiles/shaders/ProgramCache ./BitBlitRenderer ./enums ./MaterialManager ./TextureManager ./effects/AnimationEffect ./effects/BlendEffect ./effects/HighlightEffect ./effects/HittestEffect ./effects/post-processing/EffectManager ./painter/RenderPass".split(" "),function(h,k,g,l,f,p,q,m,r,t,u,v,w,x,y,z){function n(c,a,b){return 1!==b||g.isSome(c)&&"normal"!==c||g.isSome(a)&&0<a.length}Object.defineProperty(k,"__esModule",
{value:!0});k.PainterOptions=void 0;h=function(){return function(){}}();k.PainterOptions=h;h=function(){function c(a,b){this.context=a;this._blitRenderer=new q.BitBlitRenderer;this._brushCache=new Map;this._vtlProgramCache=null;this._blendEffect=new v.BlendEffect;this.effects={highlight:new w.default,hittest:new x.HittestEffect,integrate:new u.AnimationEffect};this.materialManager=new r(a);this._vtlProgramCache=new p.default(a);this.textureManager=new t(b);this._effectsManager=new y.EffectManager(b)}
c.prototype.getRenderTarget=function(){return this._renderTarget};c.prototype.setRenderTarget=function(a){this._renderTarget=a};c.prototype.getFbos=function(a,b){if(a!==this._lastWidth||b!==this._lastHeight){this._lastWidth=a;this._lastHeight=b;if(this._fbos){for(var e in this._fbos)this._fbos[e].resize(a,b);return this._fbos}e={target:3553,pixelFormat:6408,dataType:5121,samplingMode:9728,wrapMode:33071,width:a,height:b};var d={colorTarget:0,depthStencilTarget:3};this._stencilBuf=a=new l.Renderbuffer(this.context,
{width:a,height:b,internalFormat:34041});this._fbos={output:new l.FramebufferObject(this.context,d,e,a),blend:new l.FramebufferObject(this.context,d,e,a),effect0:new l.FramebufferObject(this.context,d,e,a)}}return this._fbos};c.prototype.getSharedStencilBuffer=function(){return this._stencilBuf};c.prototype.beforeRenderLayers=function(a,b){void 0===b&&(b=null);var e=a.getViewport(),d=e.width,e=e.height;this._prevFBO=a.getBoundFramebufferObject();d=this.getFbos(d,e);a.bindFramebuffer(d.output);a.setDepthWriteEnabled(!0);
g.isSome(b)?(b=b.color,d=b.a,a.setClearColor(d*b.r/255,d*b.g/255,d*b.b/255,d)):a.setClearColor(0,0,0,0);a.setClearDepth(1);a.clear(a.gl.COLOR_BUFFER_BIT|a.gl.DEPTH_BUFFER_BIT);a.setDepthWriteEnabled(!1)};c.prototype.beforeRenderLayer=function(a,b,e){var d=a.context;n(a.blendMode,a.effects,e)?(d.bindFramebuffer(this._fbos.blend),d.setColorMask(!0,!0,!0,!0),d.setClearColor(0,0,0,0),d.clear(d.gl.COLOR_BUFFER_BIT)):(a=this._getOutputFBO(),d.bindFramebuffer(a));d.setDepthWriteEnabled(!1);d.setDepthTestEnabled(!1);
d.setStencilTestEnabled(!0);d.setClearStencil(b);d.setStencilWriteMask(255);d.clear(d.gl.STENCIL_BUFFER_BIT)};c.prototype.compositeLayer=function(a,b){var e=a.context,d=a.blendMode,c=a.effects;n(d,c,b)&&(g.isSome(c)&&0<c.length&&this._applyEffects(a,c),c=this._getOutputFBO(),e.bindFramebuffer(c),e.setStencilTestEnabled(!1),e.setStencilWriteMask(0),e.setBlendingEnabled(!0),e.setBlendFunctionSeparate(1,771,1,771),e.setColorMask(!0,!0,!0,!0),e=g.isSome(d)?d:"normal",this._blendEffect.draw(a,this._fbos.blend.colorTexture,
9728,e,b))};c.prototype.renderLayers=function(a){a.bindFramebuffer(this._prevFBO);if(this._fbos){var b=this._getOutputFBO();a.setStencilTestEnabled(!1);a.setStencilWriteMask(0);this.blitTexture(a,b.colorTexture,9728)}};c.prototype.dispose=function(){this.materialManager.dispose();this.textureManager.dispose();this._blitRenderer&&(this._blitRenderer.dispose(),this._blitRenderer=null);this._vtlProgramCache&&(this._vtlProgramCache.dispose(),this._vtlProgramCache=null);this._brushCache&&(this._brushCache.forEach(function(a){return a.dispose()}),
this._brushCache.clear(),this._brushCache=null);if(this._fbos)for(var a in this._fbos)this._fbos[a]&&this._fbos[a].dispose();if(this.effects)for(var b in this.effects)this.effects[b]&&this.effects[b].dispose();this._prevFBO=null};c.prototype.getGeometryBrush=function(a){var b;a=(b={},b[m.WGLGeometryType.FILL]=f.brushes.fill,b[m.WGLGeometryType.LINE]=f.brushes.line,b[m.WGLGeometryType.MARKER]=f.brushes.marker,b[m.WGLGeometryType.TEXT]=f.brushes.text,b)[a];b=this._brushCache.get(a);void 0===b&&(b=new a,
this._brushCache.set(a,b));return this._brushCache.get(a)};c.prototype.renderObject=function(a,b,e,d){e=f.brushes[e];if(!e)return null;var c=this._brushCache.get(e);void 0===c&&(c=new e,this._brushCache.set(e,c));c.prepareState(a,b,d);c.draw(a,b,d)};c.prototype.renderObjects=function(a,b,e,d){e=f.brushes[e];if(!e)return null;var c=this._brushCache.get(e);void 0===c&&(c=new e,this._brushCache.set(e,c));c.drawMany(a,b,d)};c.prototype.getVectorTileProgramCach=function(){return this._vtlProgramCache};
c.prototype.registerRenderPass=function(a){var b=this,e=a.brushes.map(function(a){b._brushCache.has(a)||b._brushCache.set(a,new a);return b._brushCache.get(a)});return new z.default(e,a)};c.prototype.setHighlightOptions=function(a){this.effects.highlight.setHighlightOptions(a)};c.prototype.blitTexture=function(a,b,e,d){void 0===d&&(d=1);a.setBlendingEnabled(!0);a.setBlendFunctionSeparate(1,771,1,771);a.setColorMask(!0,!0,!0,!0);this._blitRenderer.render(a,b,e,d)};c.prototype._getOutputFBO=function(){return null!=
this._renderTarget?this._renderTarget:this._fbos.output};c.prototype._applyEffects=function(a,b){var e=a.context,d=0;for(b=this._effectsManager.getPostProcessingEffects(b);d<b.length;d++){var c=b[d],f=c.postProcessingEffect,c=c.effect;e.bindFramebuffer(this._fbos.blend);f.draw(a,this._fbos.blend,c)}};return c}();k.default=h});