// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.17/esri/copyright.txt for details.
//>>built
define("require exports tslib ../../../../geometry ../../../../renderers ../../../../symbols ../../../../core/Accessor ../../../../core/arrayUtils ../../../../core/compilerUtils ../../../../core/Error ../../../../core/Handles ../../../../core/Logger ../../../../core/MapUtils ../../../../core/mathUtils ../../../../core/maybe ../../../../core/ObjectPool ../../../../core/PooledArray ../../../../core/promiseUtils ../../../../core/scheduling ../../../../core/watchUtils ../../../../core/accessorSupport/decorators ../../../../core/accessorSupport/diffUtils ../../../../core/libs/gl-matrix-2/vec3 ../../../../core/libs/gl-matrix-2/vec3f64 ../../../../geometry/support/aaBoundingBox ../../../../geometry/support/aaBoundingRect ../../../../layers/Layer ../../../../layers/graphics/dehydratedFeatures ../../../../layers/graphics/hydratedFeatures ../../../../renderers/support/rendererConversion ../../../../support/arcadeOnDemand ../../../../symbols/support/defaults3D ../../../../symbols/support/symbolConversion ./ElevationQuery ./featureExpressionInfoUtils ./Graphics3DFeatureStore ./Graphics3DGraphic ./Graphics3DSymbolCreationContext ./Graphics3DSymbolFactory ./Graphics3DWebStyleSymbol ./GraphicStateTracking ./graphicUtils ./SpatialIndex2D ./symbolComplexity ../support/StageLayerElevationProvider ../../support/extentUtils ../../support/projectionUtils ../../support/PropertiesPool ../../webgl-engine/lib/GridLocalOriginFactory ../../webgl-engine/lib/Layer ../../../support/Scheduler".split(" "),
function(R,x,g,S,G,H,W,u,X,B,Y,Z,C,y,f,aa,I,n,ba,D,l,L,E,J,F,ca,da,M,N,T,ea,fa,U,ga,K,ha,ia,ja,ka,la,ma,na,oa,pa,qa,ra,v,sa,ta,ua,V){Object.defineProperty(x,"__esModule",{value:!0});x.Graphics3DCore=void 0;var O=J.vec3f64.create(),h=F.create(),p=Z.getLogger("esri.views.3d.layers.graphics.Graphics3DCore");R=function(x){function c(a){a=x.call(this,a)||this;a.propertiesPool=new sa.PropertiesPool({computedExtent:S.Extent},a);a.computedExtent=null;a.currentRenderer=null;a.rendererHasGeometryOperations=
!1;a.graphicStateTracking=null;a.symbolCreationContext=new ja.Graphics3DSymbolCreationContext;a.graphics3DGraphics=new Map;a.stageLayer=null;a.stage=null;a.graphicsDrapedUids=new Set;a.graphicsBySymbol=new Map;a.symbolConversionCache=new Map;a.symbols=new Map;a.graphicsWithoutSymbol=new Map;a.graphicsWaitingForSymbol=new Set;a.handles=new Y;a.suspendSymbolCleanup=!1;a._spatialReference=null;a.arcadeOnDemand=null;a.rendererChangeAbortController=null;a.elevationInfoChangeAbortController=null;a.setupAbortController=
null;a.elevationAlignment=null;a.scaleVisibility=null;a.filterVisibility=null;a._spatialIndex=null;a.extentPadding=0;a._updatingPendingLoadedGraphicsChange=null;a.featureStore=null;a.deconflictor=null;a.labeler=null;a.objectStates=null;a.viewElevationProvider=null;a.stageLayerElevationProvider=null;a.sharedSymbolResourcesOwnerHandle=null;a.whenGraphics3DGraphicRequests={};a.pendingUpdates=new Map;a.numberOfGraphics=0;a.numberOfGraphicsProvidingElevation=0;a.pendingAdds=0;a.pendingRemoves=0;a.pendingUpdatesPool=
new I({allocator:function(a){return a||{add:null,renderingInfo:null,abortController:null,state:0,remove:null}},deallocator:function(a){a.add=null;a.renderingInfo=null;a.remove=null;a.state=0;a.abortController=null;return a}});a.symbolWarningLogged=!1;a.geometryWarningLogged=!1;a.objectIdInvisibleSet=new Set;a._whenSymbolRemoved=new I;a.preferredUpdatePolicy=0;a.forcedUpdatePolicy=null;a._asyncUpdates=!1;a.elevationFeatureExpressionEnabled=!0;a.owner=null;a.layer=null;a.hasDraped=!1;a.graphicSymbolSupported=
!0;a.getRenderingInfoWithoutRenderer=!1;a.hasZ=null;a.hasM=null;a._usedMemory=0;a._visible=void 0;a._startCreateGraphics=!1;a.maxPendingUpdates=0;return a}g.__extends(c,x);P=c;Object.defineProperty(c.prototype,"spatialIndex",{get:function(){if(!this._spatialIndex){this._spatialIndex=new oa.default({objectIdField:this.owner.layer&&this.owner.layer.objectIdField,spatialReference:this._spatialReference,hasZ:this.hasZ,hasM:this.hasM});var a=0,b=Array(this.graphics3DGraphics.size);this.graphics3DGraphics.forEach(function(d){return b[a++]=
d});this._spatialIndex.addMany(b)}return this._spatialIndex},enumerable:!1,configurable:!0});Object.defineProperty(c.prototype,"asyncUpdates",{get:function(){return this._asyncUpdates},enumerable:!1,configurable:!0});Object.defineProperty(c.prototype,"updating",{get:function(){return!!(0<this.graphicsWaitingForSymbol.size||this.needsUpdate()||this.elevationAlignment&&this.elevationAlignment.updating||this.scaleVisibility&&this.scaleVisibility.updating||this.filterVisibility&&this.filterVisibility.updating||
this.rendererChangeAbortController||this.elevationInfoChangeAbortController||this._updatingPendingLoadedGraphicsChange)},enumerable:!1,configurable:!0});Object.defineProperty(c.prototype,"updatingRemaining",{get:function(){return this.updating?this.pendingUpdates.size:0},enumerable:!1,configurable:!0});Object.defineProperty(c.prototype,"updatingTotal",{get:function(){return this.updating?this.maxPendingUpdates:0},enumerable:!1,configurable:!0});Object.defineProperty(c.prototype,"displayFeatureLimit",
{get:function(){var a=this.owner&&this.owner.view&&this.owner.view.qualitySettings,b=a?a.graphics3D.minTotalNumberOfFeatures:0,d=a?a.graphics3D.maxTotalNumberOfFeatures:0,a=a?a.graphics3D.maxTotalNumberOfPrimitives:0,m=this.maxSymbolComplexity,c=Math.max(b,Math.min(d,Math.ceil(a/Math.max(1,m?m.primitivesPerFeature:1)))),f=this._get("displayFeatureLimit");return f&&f.minimumTotalNumberOfFeatures===b&&f.maximumTotalNumberOfFeatures===d&&f.maximumTotalNumberOfPrimitives===a&&f.maximumSymbolComplexity===
m&&f.maximumNumberOfFeatures===c?f:{minimumTotalNumberOfFeatures:b,maximumTotalNumberOfFeatures:d,maximumTotalNumberOfPrimitives:a,maximumSymbolComplexity:m,maximumNumberOfFeatures:c}},enumerable:!1,configurable:!0});Object.defineProperty(c.prototype,"maxSymbolComplexity",{get:function(){for(var a=null,b=this.symbolComplexities,d=this._get("maxSymbolComplexity"),m=!1,c=0;c<b.length;c++){var f=b[c];if(!a||0===a.primitivesPerCoordinate&&f.primitivesPerFeature>a.primitivesPerFeature||0!==a.primitivesPerCoordinate&&
f.primitivesPerCoordinate>a.primitivesPerCoordinate)a=f;m=m||f.estimated}return!a||m&&d&&(d.primitivesPerFeature>=a.primitivesPerFeature||d.primitivesPerCoordinate>=a.primitivesPerCoordinate)||d&&d.primitivesPerFeature===a.primitivesPerFeature&&d.primitivesPerCoordinate===a.primitivesPerCoordinate?d:a},enumerable:!1,configurable:!0});Object.defineProperty(c.prototype,"spatialReference",{get:function(){return this._spatialReference},enumerable:!1,configurable:!0});Object.defineProperty(c.prototype,
"usedMemory",{get:function(){return this._usedMemory+(this.maxSymbolComplexity&&this.labelsEnabled?this.maxSymbolComplexity.memory.bytesPerFeatureLabel*this.numberOfGraphics:0)},enumerable:!1,configurable:!0});Object.defineProperty(c.prototype,"usedMemoryPerGraphic",{get:function(){return this._usedMemory&&this.numberOfGraphics?this._usedMemory/this.numberOfGraphics:this.maxSymbolComplexity?this.maxSymbolComplexity.memory.bytesPerFeature+(this.labelsEnabled?this.maxSymbolComplexity.memory.bytesPerFeatureLabel:
0):0},enumerable:!1,configurable:!0});Object.defineProperty(c.prototype,"unprocessedMemoryEstimate",{get:function(){return Math.max(0,(this.pendingAdds-this.pendingRemoves)*this.usedMemoryPerGraphic)},enumerable:!1,configurable:!0});Object.defineProperty(c.prototype,"symbolComplexities",{get:function(){return this.currentRenderer?this.getSymbolComplexitiesUsedOrRenderer(this.currentRenderer):this.getSymbolComplexitiesUsed()},enumerable:!1,configurable:!0});c.prototype.getConvertedSymbol=function(a){if("web-style"===
a.type)return a.clone();var b=this.symbolConversionCache.get(a.id);if(void 0!==b)return b;var b=U.to3D(a,!0,!1,this.hasLabelingContext(a)),d=b.symbol||null;d||b.error&&p.error(b.error.message);this.symbolConversionCache.set(a.id,d);return d};c.prototype.getSymbolComplexitiesUsedOrRenderer=function(a){if(f.isNone(a))return[];var b=a.getSymbols(),d="backgroundFillSymbol"in a&&a.backgroundFillSymbol;if(!(d||b&&b.length))return[];a=[];d=this.getSymbolComplexityUsedOrRenderer(d);f.isSome(d)&&a.push(d);
for(d=0;d<b.length;d++){var m=this.getSymbolComplexityUsedOrRenderer(b[d]);f.isSome(m)&&a.push(m)}return a};c.prototype.getSymbolComplexityUsedOrRenderer=function(a){if(f.isNone(a))return null;var b=this.symbols.get(a.id);return f.isSome(b)?b.complexity:(a=this.getConvertedSymbol(a))?pa.defaultSymbolComplexity(a):null};c.prototype.getSymbolComplexitiesUsed=function(){var a=[];this.symbols.forEach(function(b){f.isSome(b)&&a.push(b.complexity)});return a};c.prototype.initialize=function(){var a=this;
this._spatialReference=this.owner.view.spatialReference;this._set("featureStore",new ha.default({objectIdField:this.owner.layer&&this.owner.layer.objectIdField,hasZ:this.hasZ,hasM:this.hasM,spatialReference:this._spatialReference,getSpatialIndex:function(){return a.spatialIndex},forAllGraphics:function(b){return a.graphics3DGraphics.forEach(b)}}))};c.prototype.setup=function(a){return g.__awaiter(this,void 0,void 0,function(){var b,d,m,c,q,k=this;return g.__generator(this,function(e){switch(e.label){case 0:return this.setupAbortController=
n.createAbortController(),b=this.setupAbortController.signal,this._set("elevationAlignment",a.elevationAlignment),this._set("scaleVisibility",a.scaleVisibility),this._set("filterVisibility",a.filterVisibility),this._set("deconflictor",a.deconflictor),this._set("labeler",a.labeler),this._set("objectStates",a.objectStates),d=this.owner.view,this.viewElevationProvider=new ga.ViewElevationProvider(this._spatialReference,d),this.initializeStage(d,this.layer.uid),this.symbolCreationContext.sharedResources=
d.sharedSymbolResources,this.sharedSymbolResourcesOwnerHandle=d.sharedSymbolResources.addGraphicsOwner(this.owner),f.isSome(this.currentRenderer)&&(this.symbolCreationContext.renderer=this.currentRenderer),this.symbolCreationContext.stage=this.stage,this.symbolCreationContext.streamDataRequester=d.sharedSymbolResources.streamDataRequester,this.symbolCreationContext.renderCoordsHelper=d.renderCoordsHelper,this.symbolCreationContext.layer=this.layer,this.symbolCreationContext.layerView=this.owner,this.symbolCreationContext.localOriginFactory=
new ta,this.symbolCreationContext.elevationProvider=d.elevationProvider,this.symbolCreationContext.notifyGraphicUpdate=function(a,b){return k.notifyGraphicUpdate(a,b)},m=K.extractExpressionInfo(this.layer.elevationInfo,this.elevationFeatureExpressionEnabled),c=this.symbolCreationContext,[4,K.createContext(m,this._spatialReference,p)];case 1:c.featureExpressionInfoContext=e.sent(),n.throwIfAborted(b),this.symbolCreationContext.screenSizePerspectiveEnabled=d.screenSizePerspectiveEnabled&&this.layer.screenSizePerspectiveEnabled,
this.symbolCreationContext.slicePlaneEnabled=!!this.owner.slicePlaneEnabled,this.symbolCreationContext.physicalBasedRenderingEnabled=!!this.owner.view.qualitySettings.physicallyBasedRenderingEnabled,this.handles.add(this.owner.watch("suspended",function(){return k.updateLayerVisibility()})),q="layer"in this.owner?["layer.screenSizePerspectiveEnabled,view.screenSizePerspectiveEnabled"]:"view.screenSizePerspectiveEnabled",this.handles.add([this.owner.watch(q,function(){var a=d.screenSizePerspectiveEnabled&&
k.layer.screenSizePerspectiveEnabled;a!==k.symbolCreationContext.screenSizePerspectiveEnabled&&(k.symbolCreationContext.screenSizePerspectiveEnabled=a,k.recreateAllGraphics())}),D.init(this,"preferredUpdatePolicy",function(){return k.updateUpdatePolicy()},!0),this.owner.watch("slicePlaneEnabled",function(a){return k.slicePlaneEnabledChange(!!a)}),this.owner.view.watch("pixelRatio",function(){return k.pixelRatioChange()}),this.owner.view.watch("qualitySettings.physicallyBasedRenderingEnabled",function(a){return k.physicalBasedRenderingChange(a)}),
D.when(d.basemapTerrain,"tilingScheme",function(a){a.spatialReference.equals(k.symbolCreationContext.overlaySR)||(k.symbolCreationContext.overlaySR=d.basemapTerrain.spatialReference);k.handles.has("loaded-graphics")?k.recreateAllGraphics():k.handles.add([D.on(k.owner,"loadedGraphics","change",function(a){return k.graphicsCollectionChanged(a)},function(){return k.recreateAllGraphics()}),D.on(k.owner,"loadedGraphics","after-changes",function(){return k._signalUpdatingDuringAsyncLoadedGraphicsChange()},
function(){return k._signalUpdatingDuringAsyncLoadedGraphicsChange()})],"loaded-graphics")}),d.resourceController.scheduler.registerTask(V.Task.GRAPHICS_CORE,function(a){return k.update(a)},function(){return k.needsUpdate()})]),this.owner.layer&&"featureReduction"in this.owner.layer&&this.handles.add(this.owner.watch("layer.featureReduction",function(){return k.deconflictor.featureReductionChange()})),this.notifyChange("maxSymbolComplexity"),e.label=2;case 2:return e.trys.push([2,4,,5]),[4,this.rendererChange(this.layer.renderer)];
case 3:return e.sent(),[3,5];case 4:return e.sent(),[3,5];case 5:return n.throwIfAborted(b),this.setupAbortController=null,[2]}})})};c.prototype.abortSetup=function(){this.setupAbortController&&(this.setupAbortController.abort(),this.setupAbortController=null)};c.prototype.destroy=function(){this.abortSetup();this.abortRendererChange();this.abortElevationInfoChange();this.owner.view.deconflictor.removeGraphicsOwner(this);this.owner.view.labeler.removeGraphicsOwner(this);this._updatingPendingLoadedGraphicsChange&&
(this._updatingPendingLoadedGraphicsChange.remove(),this._updatingPendingLoadedGraphicsChange=null);this.clear();f.isSome(this.graphicStateTracking)&&(this.graphicStateTracking.destroy(),this.graphicStateTracking=null);this.stage&&(this.stage.removeFromViewContent([this.stageLayer.id]),this.stage.remove(0,this.stageLayer.id),this.stage=this.stageLayer=null);this.handles.destroy();this._spatialReference=this.handles=null;this._set("owner",null);for(var a in this.whenGraphics3DGraphicRequests)this.whenGraphics3DGraphicRequests[a].reject(new B("graphic:layer-destroyed",
"Layer has been destroyed"));this.whenGraphics3DGraphicRequests=null;this.sharedSymbolResourcesOwnerHandle&&(this.sharedSymbolResourcesOwnerHandle.remove(),this.sharedSymbolResourcesOwnerHandle=null);this.propertiesPool&&(this.propertiesPool.destroy(),this.propertiesPool=null);this.pendingUpdatesPool=null;this.symbolConversionCache.clear();this.objectIdInvisibleSet.clear();this._spatialIndex&&(this._spatialIndex.destroy(),this._spatialIndex=null);this.featureStore&&(this.featureStore.destroy(),this._set("featureStore",
null))};c.prototype.clear=function(){this.objectStates&&this.objectStates.allGraphicsDeleted();f.isSome(this.graphicStateTracking)&&this.graphicStateTracking.allGraphicsDeleted();this.graphics3DGraphics.forEach(function(a){return a.destroy()});this._spatialIndex&&this._spatialIndex.clear();this.graphics3DGraphics.clear();this._usedMemory=this.numberOfGraphics=0;this.updateLayerVisibility();this.symbols.forEach(function(a){f.isSome(a)&&a.destroy()});this.symbols.clear();this.graphicsBySymbol.clear();
this.graphicsWithoutSymbol.clear();this.graphicsWaitingForSymbol.clear();this.pendingUpdates.clear();this.pendingUpdatesPool.clear();this.pendingRemoves=this.pendingAdds=this.maxPendingUpdates=0;this._set("hasDraped",!1);this.notifyChange("updating");this.notifyChange("updatingTotal");this.notifyChange("updatingRemaining");this.featureStore.events.emit("changed")};c.prototype.initializeStage=function(a,b){var d=this;this.stage=a._stage;this.stageLayer=new ua(b,{isPickable:!this.owner.suspended},b);
this.stage.add(0,this.stageLayer);this.stage.addToViewContent([this.stageLayer.id]);this.stageLayer.on("dirty",function(a){if(d.graphicStateTracking)switch(a.dirtyType){case "objTransformation":case "objGeometryAdded":case "objGeometryRemoved":case "shaderTransformationChanged":case "vertexAttrsUpdated":a=a.origin.metadata.graphicUid;d.notifyGraphicUpdate(a,2);break;case "visibilityChanged":a=a.origin.metadata.graphicUid,d.notifyGraphicUpdate(a,1)}})};c.prototype.notifyGraphicUpdate=function(a,b){switch(b){case 1:this.notifyGraphicVisibilityChanged(a);
break;case 2:this.notifyGraphicGeometryChanged(a)}};c.prototype.notifyGraphicGeometryChanged=function(a){f.isNone(this.graphicStateTracking)||(a=this.graphics3DGraphics.get(a))&&this.graphicStateTracking.updateGraphicGeometry(a)};c.prototype.notifyGraphicVisibilityChanged=function(a){f.isNone(this.graphicStateTracking)||(a=this.graphics3DGraphics.get(a))&&this.graphicStateTracking.updateGraphicVisibility(a)};c.prototype.updateLayerVisibility=function(){var a=this.numberOfGraphics>this.displayFeatureLimit.maximumNumberOfFeatures*
va,a=!this.owner.suspended&&!a;a!==this._visible&&((this._visible=a)?(this.stageLayer.isPickable=!0,this.updateAllGraphicsVisibility()):(this.stageLayer.isPickable=!1,this.hideAllGraphics()),this.updateStageLayerVisibility())};c.prototype.updateStageLayerVisibility=function(){this.stageLayer.isVisible=this._visible&&(null==this.layer.opacity||0<this.layer.opacity)};c.prototype.getGraphics3DGraphicById=function(a){return this.graphics3DGraphics.get(a)};c.prototype.getGraphics3DGraphicByObjectId=function(a){var b=
this;if(!this.owner.layer||!this.owner.layer.objectIdField)return null;var d=null;C.someMap(this.graphics3DGraphics,function(c){return b._getGraphicObjectID(c.graphic)===a?(d=c,!1):!0});return d};c.prototype._getGraphicObjectID=function(a,b){void 0===b&&(b=this.owner.layer&&this.owner.layer.objectIdField);return M.getObjectId(a,b)};Object.defineProperty(c.prototype,"graphics3DGraphicsByObjectID",{get:function(){var a=this,b=this.owner.layer&&this.owner.layer.objectIdField;if(!b)return null;var d=
new Map;this.graphics3DGraphics.forEach(function(c){if(c){var m=a._getGraphicObjectID(c.graphic,b);f.isSome(m)&&d.set(m,c)}});return d},enumerable:!1,configurable:!0});Object.defineProperty(c.prototype,"labelsEnabled",{get:function(){return!(!this.labeler||!this.labeler.layerLabelsEnabled())},enumerable:!1,configurable:!0});c.prototype.updateLabelingInfo=function(a){return g.__awaiter(this,void 0,void 0,function(){var b,d;return g.__generator(this,function(c){switch(c.label){case 0:return b=this.deconflictor&&
this.deconflictor.labelingInfoChange(a),d=this.labeler&&this.labeler.labelingInfoChange(a),[4,n.eachAlways([b,d])];case 1:return c.sent(),[2]}})})};c.prototype.updateVisibilityInfo=function(){this.deconflictor&&this.deconflictor.labelingInfoChange();this.labeler&&this.labeler.visibilityInfoChange()};Object.defineProperty(c.prototype,"symbolUpdateType",{get:function(){var a=this;if(0<this.pendingUpdates.size)return"unknown";var b=0,d=0;return C.someMap(this.symbols,function(c,e){if(f.isSome(c)){c=
c.getFastUpdateStatus();if(0<c.loading)return!0;a.graphicsBySymbol.has(e)&&(d+=c.fast,b+=c.slow)}return!1})?"unknown":0<=d&&0===b?"fast":0<=b&&0===d?"slow":"mixed"},enumerable:!1,configurable:!0});c.prototype.needsUpdate=function(){return 0<this.pendingUpdates.size};c.prototype.update=function(a){this._applyPendingUpdates(a);this.needsUpdate()||this.notifyChange("updating")};c.prototype.setObjectIdVisibility=function(a,b){b?this.objectIdInvisibleSet.delete(a):this.objectIdInvisibleSet.add(a);a=this._findGraphics3DGraphicByObjectId(a);
f.isSome(a)&&this._updateUserVisibility(a)};c.prototype._findGraphics3DGraphicByObjectId=function(a){var b=this,d;C.someMap(this.graphics3DGraphics,function(c){return b._getGraphicObjectID(c.graphic)===a?(d=c,!0):!1});return d};c.prototype._updateUserVisibility=function(a){if(f.isNone(a))return!1;var b=a.graphic,d=this._getGraphicObjectID(b),b=b.visible&&!this.owner.suspended&&(f.isNone(d)||!this.objectIdInvisibleSet.has(d));return a.setVisibilityFlag(0,b,0)};c.prototype.whenGraphics3DGraphic=function(a){var b=
this.graphics3DGraphics.get(a.uid);if(b)return n.resolve(b);if(b=this.whenGraphics3DGraphicRequests[a.uid])return b.promise;b=n.createDeferred();this.whenGraphics3DGraphicRequests[a.uid]=b;return b.promise};c.prototype.boundsForGraphics3DGraphic=function(a,b){return g.__awaiter(this,void 0,void 0,function(){var d,c,e,q,k,l,h,w,p,n;return g.__generator(this,function(m){switch(m.label){case 0:return d=this._spatialReference,c=this.owner.view.renderSpatialReference,e=this.owner.view.basemapTerrain.spatialReference,
q=function(a,b,m){return v.bufferToBuffer(a,c,b,a,d,b,m)},k=function(a,b,c){return v.bufferToBuffer(a,e,b,a,d,b,c)},l=this.viewElevationProvider?{service:this.viewElevationProvider,useViewElevation:f.isSome(b)&&b.useViewElevation,minDemResolution:f.isSome(b)&&b.minDemResolution,minDemResolutionForPoints:this.owner.view.resolution}:null,[4,a.getProjectedBoundingBox(q,k,l,f.get(b,"signal"))];case 1:h=m.sent();if(!h)return[2,null];w=h.boundingBox;h.requiresDrapedElevation&&(p=this.symbolCreationContext.elevationProvider)&&
(F.center(w,O),n=p.getElevation(O[0],O[1],0,d,"ground")||0,w[2]=Math.min(w[2],n),w[5]=Math.max(w[5],n));return[2,{boundingBox:w,screenSpaceObjects:h.screenSpaceObjects}]}})})};c.prototype.whenGraphicBounds=function(a,b){var d=this;return D.whenOnce(this.owner,"loadedGraphics").then(function(){var b=d.owner.layer&&d.owner.layer.objectIdField,c=d.owner.loadedGraphics.find(function(d){return d===a?!0:b&&d.attributes&&a.attributes&&d.attributes[b]===a.attributes[b]});if(c)return d.whenGraphics3DGraphic(c);
throw new B("internal:graphic-not-part-of-view","Graphic is not part of this view");}).then(function(a){return d.boundsForGraphics3DGraphic(a,b)})};c.prototype.computeAttachmentOrigin=function(a,b){a=this.graphics3DGraphics.get(a.uid);if(!a)return null;var d=a.computeAttachmentOrigin();if(0===d.render.num&&0===d.draped.num)return null;E.vec3.set(r,0,0,0);a=0;if(0<d.render.num){if(!v.vectorToVector(d.render.origin,this.symbolCreationContext.renderCoordsHelper.spatialReference,z,b))return null;E.vec3.add(r,
r,z);a++}if(0<d.draped.num){var c=d.draped.origin,d=c[0],c=c[1],e=this.viewElevationProvider.getElevation(d,c,"ground")||0;E.vec3.set(z,d,c,e);if(!v.vectorToVector(z,this.viewElevationProvider.spatialReference,z,b))return null;E.vec3.add(r,r,z);a++}1<a&&E.vec3.scale(r,r,1/a);return new S.Point({x:r[0],y:r[1],z:r[2],spatialReference:b})};c.prototype.getSymbolLayerSize=function(a,b){var d=this.symbols.get(a.id);if(f.isNone(d))throw new B("internal:symbol-not-part-of-view","Symbol is not part of this view");
a=a.symbolLayers.indexOf(b);if(-1===a)throw new B("internal:missing-symbol-layer","Symbol layer is not in symbol");d=d.getSymbolLayerSize(a);if(null==d)throw new B("internal:missing-size","Symbol layer has no valid size");return d};c.prototype.graphicsCollectionChanged=function(a){this._startCreateGraphics&&(this.add(a.added),this.remove(a.removed))};c.prototype.graphicUpdateHandler=function(a){var b=a.graphic.uid,d=this.graphics3DGraphics.get(b),b=this.graphicsWithoutSymbol.get(b);if(d||b)switch(a.property){case "visible":this.graphicUpdateVisibleHandler(d);
break;case "geometry":this.graphicUpdateGeometryHandler(d,a);break;case "symbol":this.graphicUpdateSymbolHandler(d,a);break;case "attributes":break;default:X.neverReached(a)}};c.prototype.graphicUpdateGeometryHandler=function(a,b){var d=b.graphic.geometry;if(f.isNone(d))this.recreateGraphic(b.graphic);else if(f.isNone(a)){if(a=b.graphic.symbol&&b.graphic.symbol.id)if(a=this.symbols.get(a),f.isSome(a)&&0===a.loadStatus)return;this.recreateGraphic(b.graphic)}else a.graphics3DSymbol.updateGeometry(a,
b.newValue)||this.recreateGraphic(a.graphic),this.expandComputedExtent(d)};c.prototype.graphicUpdateSymbolHandler=function(a,b){var d=b.graphic,c=f.isSome(a)?a.graphics3DSymbol:b.oldValue&&this.symbols.get(b.oldValue.id);if(f.isNone(c))this.recreateGraphic(d);else{var e=c.symbol;b=this.getConvertedSymbol(b.newValue);if(b.type!==e.type||"web-style"===b.type||"web-style"===e.type)this.recreateGraphic(d);else{var q=this.graphicsBySymbol.get(e.id);if(q&&1!==q.size)this.recreateGraphic(d);else if(q=L.diff(e,
b),f.isNone(q))this.updateSymbolMapping(e.id,b);else{var k={diff:q,graphics3DGraphicPatches:[],symbolStatePatches:[]};c.prepareSymbolPatch(k);if(L.isEmpty(k.diff)){for(var g=c.extentPadding,h=0,l=k.symbolStatePatches;h<l.length;h++)q=l[h],q();g!==c.extentPadding&&this.recomputeExtentPadding();d=this._getRenderingInfo(d);if(f.isSome(a))for(c=0,k=k.graphics3DGraphicPatches;c<k.length;c++)q=k[c],q(a,d);this.updateSymbolMapping(e.id,b)}else this.recreateGraphic(d)}}}};c.prototype.graphicUpdateVisibleHandler=
function(a){this._updateUserVisibility(a)&&(this.labeler&&this.owner.view.labeler.setDirty(),this.owner.view.deconflictor.setDirty())};c.prototype.recreateGraphic=function(a){a=[a];this.suspendSymbolCleanup=!0;this.remove(a);this.add(a);this.suspendSymbolCleanup=!1;this.asyncUpdates||this._cleanupSymbols()};c.prototype._beginGraphicUpdate=function(a){this.graphicsWaitingForSymbol.add(a.uid);1===this.graphicsWaitingForSymbol.size&&this.notifyChange("updating");this._get("symbolsUpdating")||this._set("symbolsUpdating",
!0)};c.prototype._endGraphicUpdate=function(a){a&&(this.graphicsWaitingForSymbol.delete(a.uid),0===this.graphicsWaitingForSymbol.size&&(this._cleanupSymbols(),this.notifyChange("updating"),this._get("symbolsUpdating")&&(this.owner.view.flushDisplayModifications(),this._set("symbolsUpdating",!1))))};c.prototype.recomputeExtentPadding=function(){var a=0;this.symbols.forEach(function(b){f.isSome(b)&&(a=Math.max(a,b.extentPadding))});this._set("extentPadding",a)};c.prototype.expandComputedExtent=function(a){var b=
a.spatialReference;M.computeAABB(a,h);a=this._spatialReference;var d=P.tmpVec;!b.equals(a)&&v.xyzToVector(h[0],h[1],0,b,d,a)&&(h[0]=d[0],h[1]=d[1],v.xyzToVector(h[3],h[4],0,b,d,a),h[3]=d[0],h[4]=d[1]);if(y.isFinite(h[0])&&y.isFinite(h[3])&&y.isFinite(h[1])&&y.isFinite(h[4])){var b=this.computedExtent,d=null,c=y.isFinite(h[2])&&y.isFinite(h[5]),e=c&&(!b||null==b.zmin||h[2]<b.zmin),c=c&&(!b||null==b.zmax||h[5]>b.zmax);if(b){if(h[0]<b.xmin||h[1]<b.ymin||h[3]>b.xmax||h[4]>b.ymax||e||c)d=this.propertiesPool.get("computedExtent"),
d.xmin=Math.min(h[0],b.xmin),d.ymin=Math.min(h[1],b.ymin),d.xmax=Math.max(h[3],b.xmax),d.ymax=Math.max(h[4],b.ymax),d.spatialReference=a}else d=this.propertiesPool.get("computedExtent"),d.xmin=h[0],d.ymin=h[1],d.xmax=h[3],d.ymax=h[4],d.spatialReference=a;d&&(e&&(d.zmin=h[2]),c&&(d.zmax=h[5]),this._set("computedExtent",d))}};c.prototype.updateHasDraped=function(){this._set("hasDraped",0<this.graphicsDrapedUids.size)};c.prototype.abortElevationInfoChange=function(){this.elevationInfoChangeAbortController&&
(this.elevationInfoChangeAbortController.abort(),this.elevationInfoChangeAbortController=null)};c.prototype.elevationInfoChange=function(){return g.__awaiter(this,void 0,void 0,function(){var a,b,d,c=this;return g.__generator(this,function(e){switch(e.label){case 0:return this.abortElevationInfoChange(),this.elevationInfoChangeAbortController=a=n.createAbortController(),b=K.extractExpressionInfo(this.layer.elevationInfo,this.elevationFeatureExpressionEnabled),d=this.symbolCreationContext,[4,K.createContext(b,
this._spatialReference,p)];case 1:return d.featureExpressionInfoContext=e.sent(),n.throwIfAborted(a),this.elevationInfoChangeAbortController=null,this.labeler&&this.labeler.elevationInfoChange(),this.forEachGraphics3DSymbol(function(a,b,d){a.globalPropertyChanged("elevationInfo",b)?b.forEach(function(a){var b=a.graphic,d=0;for(a=a.labelGraphics;d<a.length;d++){var c=a[d];c.graphics3DSymbolLayer.updateGraphicElevationContext(b,c)}}):c._recreateSymbol(d)}),this.updateStageLayerElevationProvider(),this.elevationAlignment&&
this.elevationAlignment.elevationInfoChange(),[2]}})})};c.prototype.updateStageLayerElevationProvider=function(){if(this.stageLayerElevationProvider){if(this.layer.elevationInfo&&"relative-to-scene"===this.layer.elevationInfo.mode||0===this.numberOfGraphicsProvidingElevation)this.owner.view.elevationProvider.unregister(this.stageLayerElevationProvider),this.stageLayerElevationProvider.dispose(),this.stageLayerElevationProvider=null}else(!this.layer.elevationInfo||this.layer.elevationInfo&&"relative-to-scene"!==
this.layer.elevationInfo.mode)&&0<this.numberOfGraphicsProvidingElevation&&(this.stageLayerElevationProvider=new qa.StageLayerElevationProvider({layer:this.layer,stageLayer:this.stageLayer,view:this.owner.view}),this.owner.view.elevationProvider.register("scene",this.stageLayerElevationProvider))};c.prototype.clearSymbolsAndGraphics=function(){this.clear();this.filterVisibility&&this.filterVisibility.clear();this.labeler&&this.labeler.reset();this.deconflictor&&this.deconflictor.clear();this.elevationAlignment&&
this.elevationAlignment.clear();this.stageLayer&&this.stageLayer.invalidateSpatialQueryAccelerator();this.stageLayerElevationProvider&&(this.owner.view.elevationProvider.unregister(this.stageLayerElevationProvider),this.stageLayerElevationProvider.dispose(),this.stageLayerElevationProvider=null)};c.prototype.startCreateGraphics=function(){this._startCreateGraphics=!0;this.recreateAllGraphics()};c.prototype.recreateAllGraphics=function(){this._startCreateGraphics&&(this.clearSymbolsAndGraphics(),this._set("computedExtent",
null),this.symbolCreationContext.screenSizePerspectiveEnabled=this.owner.view.screenSizePerspectiveEnabled&&this.layer.screenSizePerspectiveEnabled,this.symbolCreationContext.slicePlaneEnabled=!!this.owner.slicePlaneEnabled,this.owner.loadedGraphics&&this.owner.loadedGraphics.length&&this.owner.view.basemapTerrain.tilingScheme&&this.add(this.owner.loadedGraphics.toArray()))};c.prototype._recreateSymbol=function(a){var b=this,d=this.graphicsBySymbol.get(a),c=[];d&&(d.forEach(function(a,d){var e=a.usedMemory;
b._conditionalRemove(a,d);b._spatialIndex&&b._spatialIndex.remove(a);c.push(a.graphic);a.destroy();b.removeGraphics3DGraphic(d,e);b.updateLayerVisibility();b.featureStore.events.emit("changed")}),this.graphicsBySymbol.set(a,new Map));d=this.symbols.get(a);f.isSome(d)&&d.destroy();this.symbols.delete(a);this.updateHasDraped();this.add(c)};c.prototype._conditionalRemove=function(a,b){a.isDraped&&this.graphicsDrapedUids.delete(b);this.objectStates&&this.objectStates.removeGraphic(a);this.labeler&&this.labeler.removeGraphic(a);
this.deconflictor&&this.deconflictor.removeGraphic(a);f.isSome(this.graphicStateTracking)&&this.graphicStateTracking.removeGraphic(a)};c.prototype.add=function(a){a&&0!==a.length&&(this.owner.view.basemapTerrain&&this.owner.view.basemapTerrain.tilingScheme?(this.asyncUpdates?this._addDelayed(a):this._addImmediate(a),this.notifyChange("updating")):p.error("#add()","Cannot add graphics before terrain surface has been initialized"))};c.prototype._addImmediate=function(a){var b=this;this.symbolWarningLogged=
this.geometryWarningLogged=!1;t.clear();for(var d=0;d<a.length;d++){var c=a[d];this._startAddGraphic(c,this._getRenderingInfo(c,p),t)}t.forEach(function(a){return b._finishAddGraphics(a)});t.clear();this.updateHasDraped();this._cleanupSymbols();this.labeler&&(this.owner.view.labeler.setDirty(),this._cleanupSymbols());this.owner.view.deconflictor.setDirty()};c.prototype._addDelayed=function(a){for(var b=0;b<a.length;b++){var d=a[b],c=d.uid,e=this.pendingUpdates.get(c);e?e.add?0!==e.state&&e.abortController.abort():
this.pendingAdds++:(e=this.pendingUpdatesPool.pushNew(),this.pendingAdds++,this.pendingUpdates.set(c,e));e.add=d}this.maxPendingUpdates=Math.max(this.maxPendingUpdates,this.pendingUpdates.size);this.notifyChange("updatingTotal");this.notifyChange("updatingRemaining")};c.prototype.remove=function(a){this.asyncUpdates?this._removeDelayed(a):this._removeImmediate(a);this.notifyChange("updating")};c.prototype._removeImmediate=function(a){for(var b=0;b<a.length;b++)this._removeGraphic(a[b]);this.updateHasDraped();
this._cleanupSymbols();this.labeler&&this.owner.view.labeler.setDirty();this.owner.view.deconflictor.setDirty()};c.prototype._removeDelayed=function(a){for(var b=0;b<a.length;b++){var d=a[b],c=d.uid,e=this.pendingUpdates.get(c);e?e.add&&(e.remove?e.add=null:this.pendingUpdates.delete(c),1===e.state&&e.abortController.abort(),this.pendingAdds--):(e=this.pendingUpdatesPool.pushNew(),e.remove=d,this.pendingUpdates.set(c,e),this.pendingRemoves++)}0===this.pendingUpdates.size&&this._finishPendingUpdates();
this.maxPendingUpdates=Math.max(this.maxPendingUpdates,this.pendingUpdates.size);this.notifyChange("updatingTotal");this.notifyChange("updatingRemaining")};c.prototype._finishPendingUpdates=function(){this.pendingUpdatesPool.clear();this.maxPendingUpdates=0;this._cleanupSymbols();(this.pendingAdds||this.pendingRemoves)&&p.warn("pendingAdds/Removes in inconsistent state!");this.pendingRemoves=this.pendingAdds=0};c.prototype._applyPendingUpdates=function(a){var b=this;this.symbolWarningLogged=this.geometryWarningLogged=
!1;var d=2===a.state?1E3:100,c=0;t.clear();C.someMap(this.pendingUpdates,function(e,m){e.add&&0===e.state&&b._startAddRenderingInfo(e);!e.remove||e.add&&2!==e.state||(b.pendingRemoves--,b._removeGraphic(e.remove),e.remove=null);if(e.add)switch(e.state){case 2:b._startAddGraphic(e.add,e.renderingInfo,t)&&c++;e.add=null;b.pendingAdds--;break;case 3:e.add=null,b.pendingAdds--}c>d&&(t.forEach(function(a){return b._finishAddGraphics(a)}),t.clear(),c=0);null==e.remove&&null==e.add&&(b.pendingUpdates.delete(m),
a.madeProgress());return a.done});t.forEach(function(a){return b._finishAddGraphics(a)});t.clear();0===this.pendingUpdates.size&&this._finishPendingUpdates();this.notifyChange("updatingTotal");this.notifyChange("updatingRemaining");this.updateHasDraped()};c.prototype._startAddRenderingInfo=function(a){var b=this;f.isSome(this.layer.renderer)&&"dictionary"===this.layer.renderer.type?(a.state=1,a.abortController=n.createAbortController(),this._getRenderingInfoAsync(a.add,{signal:a.abortController.signal}).then(function(d){f.isNone(d)||
f.isNone(d.symbol)?(p&&!b.symbolWarningLogged&&(b.symbolWarningLogged=!0,p.warn("Graphic in layer "+b.layer.id+" has no symbol and will not render")),a.renderingInfo=null):a.renderingInfo=d;a.state=2},function(b){a.abortController=null;n.isAbortError(b)?a.state=0:a.state=3})):(a.renderingInfo=this._getRenderingInfo(a.add,p),a.state=2)};c.prototype._startAddGraphic=function(a,b,d){this.graphicsWithoutSymbol.set(a.uid,a);if(!b||f.isNone(b.symbol)||!M.hasGeometry(a))return!1;var c=this.getOrCreateGraphics3DSymbol(b.symbol,
b.renderer);if(f.isNone(c))return!1;this.expandComputedExtent(a.geometry);this._beginGraphicUpdate(a);a={graphic:a,renderingInfo:b,layer:this.layer};b=c.symbol.id;var e=d.get(b);e?e.graphics.push(a):(e=Q.acquire(),e.clear(),e.push(a),d.set(b,{asyncSymbol:c,graphics:e}));return!0};c.prototype._finishAddGraphics=function(a){var b=this,d=!1,c=function(b){b===a.asyncSymbol.symbol.id&&(d=!0)};this._whenSymbolRemoved.push(c);a.asyncSymbol.load(function(){if(!b.destroyed){b._whenSymbolRemoved.removeUnordered(c);
A.clear();for(var e=0;e<a.graphics.length;e++){var m=a.graphics.data[e],k=m.graphic;d||a.asyncSymbol.destroyed||b.graphicSymbolSupported&&k.symbol&&k.symbol.id!==a.asyncSymbol.symbol.id||(b.graphicsWaitingForSymbol.has(k.uid)&&(m=b.createGraphics3DGraphic(a.asyncSymbol,m),b._spatialIndex&&f.isSome(m)&&A.push(m)),b._endGraphicUpdate(k));--a.asyncSymbol.referenced}0<A.length&&(b._spatialIndex.addMany(A.data,A.length),A.clear());b.featureStore.events.emit("changed");a.graphics.clear();Q.release(a.graphics);
b.labeler&&b.owner.view.labeler.setDirty()}},function(e){if(!b.destroyed){b._whenSymbolRemoved.removeUnordered(c);if(!d)if(n.isAbortError(e))b.add(a.graphics.map(function(a){return a.graphic}));else if(!a.asyncSymbol.destroyed)for(e=0;e<a.graphics.length;e++)b._endGraphicUpdate(a.graphics.data[e].graphic);a.graphics.clear();Q.release(a.graphics)}})};c.prototype._removeGraphic=function(a){a=a.uid;var b=this.graphics3DGraphics.get(a);if(b){b.graphics3DSymbol.onRemoveGraphic(b);var d=b.usedMemory,c=
b.isElevationSource;this._conditionalRemove(b,a);this._spatialIndex&&this._spatialIndex.remove(b);this.graphicsBySymbol.get(b.graphics3DSymbol.symbol.id).delete(a);this.graphicsWithoutSymbol.delete(a);this.removeGraphics3DGraphic(a,d,c);b.destroy();this.featureStore.events.emit("changed")}else this.graphicsWithoutSymbol.delete(a),this.graphicsWaitingForSymbol.delete(a)};c.prototype.hasLabelingContext=function(a){if(a instanceof H.LabelSymbol3D||a instanceof H.TextSymbol){var b=this.symbolCreationContext.layer;
return b.labelingInfo?b.labelingInfo.some(function(b){return b.symbol===a}):!1}return!1};c.prototype.hasValidSymbolCreationContext=function(a){return a instanceof H.LabelSymbol3D&&!this.hasLabelingContext(a)?(p.error("LabelSymbol3D is only valid as part of a LabelClass. Using LabelSymbol3D as a renderer symbol is not supported."),!1):!0};c.prototype._getRenderingInfo=function(a,b){var d=a.geometry;if(f.isNone(d))return b&&!this.geometryWarningLogged&&(this.geometryWarningLogged=!0,b.warn("Graphic in layer "+
this.layer.id+" has no geometry and will not render")),null;if(!v.canProject(d.spatialReference,this._spatialReference))return b&&!this.geometryWarningLogged&&(this.geometryWarningLogged=!0,b.warn("Graphic in layer "+this.layer.id+" has incompatible spatial reference and will not render")),null;if(!this.graphicSymbolSupported&&f.isSome(a.symbol))return b&&!this.symbolWarningLogged&&(this.symbolWarningLogged=!0,b.warn("Graphic in layer "+this.layer.id+" is not allowed to have a symbol, use a renderer instead")),
null;a=this.rendererHasGeometryOperations?N.hydrateGraphic(a,this.layer):a;a=this.owner.getRenderingInfo&&(this.getRenderingInfoWithoutRenderer||f.isSome(this.currentRenderer))?this.owner.getRenderingInfo(a,this.currentRenderer,f.unwrap(this.arcadeOnDemand)):{symbol:a.symbol||fa.getDefaultSymbol3D(a.geometry)};return!a||f.isNone(a.symbol)?(b&&!this.symbolWarningLogged&&(this.symbolWarningLogged=!0,b.warn("Graphic in layer "+this.layer.id+" has no symbol and will not render")),null):a};c.prototype._getRenderingInfoAsync=
function(a,b){if(f.isNone(a.geometry))return p&&!this.geometryWarningLogged&&(this.geometryWarningLogged=!0,p.warn("Graphic in layer "+this.layer.id+" has no geometry and will not render")),null;if(!this.graphicSymbolSupported&&f.isSome(a.symbol))return p&&!this.symbolWarningLogged&&(this.symbolWarningLogged=!0,p.warn("Graphic in layer "+this.layer.id+" is not allowed to have a symbol, use a renderer instead")),null;a=this.rendererHasGeometryOperations?N.hydrateGraphic(a,this.layer):a;return this.owner.getRenderingInfoAsync(a,
f.unwrap(this.currentRenderer),f.unwrap(this.arcadeOnDemand),b)};c.prototype.createGraphics3DSymbol=function(a,b){var d=this;if(!this.hasValidSymbolCreationContext(a))return null;a=this.getConvertedSymbol(a);if(!a)return null;var c;f.isSome(b)&&"backgroundFillSymbol"in b&&b.backgroundFillSymbol&&(b=U.to3D(b.backgroundFillSymbol,!1,!0),b.symbol&&"web-style"!==b.symbol.type&&(c=b.symbol.symbolLayers));var e=ka.make(a,this.symbolCreationContext,c);e.load(function(){var a=e.extentPadding;a>d.extentPadding&&
d._set("extentPadding",a);d.notifyChange("maxSymbolComplexity")},function(){});return e};c.prototype.getOrCreateGraphics3DSymbol=function(a,b){var d=this,c=this.symbols.get(a.id);void 0===c&&(c=a instanceof H.WebStyleSymbol?new la(a,function(a){return d.createGraphics3DSymbol(a,b)}):this.createGraphics3DSymbol(a,b),this.symbols.set(a.id,c));f.isSome(c)&&++c.referenced;return c};c.prototype.trackGraphicState=function(a){f.isNone(this.graphicStateTracking)&&(this.graphicStateTracking=new ma.GraphicStateTracking(this));
return this.graphicStateTracking.add(a)};c.prototype.addGraphics3DGraphic=function(a){this._usedMemory+=a.usedMemory;this.graphics3DGraphics.set(a.graphic.uid,a);this.numberOfGraphics++;a.isElevationSource&&(this.numberOfGraphicsProvidingElevation++,this.updateStageLayerElevationProvider());this.updateLayerVisibility()};c.prototype.removeGraphics3DGraphic=function(a,b,d){void 0===d&&(d=!1);this._usedMemory-=b;this.graphics3DGraphics.delete(a);this.numberOfGraphics--;d&&(this.numberOfGraphicsProvidingElevation--,
this.updateStageLayerElevationProvider());this.updateLayerVisibility()};c.prototype.createGraphics3DGraphic=function(a,b){var d=b.graphic;this.graphicsWithoutSymbol.delete(d.uid);if(!this.symbols.has(a.symbol.id))return this.add([d]),null;if(this.graphics3DGraphics.has(d.uid))return null;b=a.createGraphics3DGraphic(b);if(f.isNone(b))return null;this.addGraphics3DGraphic(b);a=a.symbol.id;this.graphicsBySymbol.has(a)||this.graphicsBySymbol.set(a,new Map);this.graphicsBySymbol.get(a).set(d.uid,b);b.isDraped&&
(this.graphicsDrapedUids.add(d.uid),this._set("hasDraped",!0));b.centroid=null;f.isSome(d.geometry)&&"point"!==d.geometry.type&&b instanceof ia&&(b.centroid=na.computeCentroid(d.geometry,this._spatialReference));this._updateUserVisibility(b);this.scaleVisibility&&this.scaleVisibility.updateVisibility(b);this.filterVisibility&&this.filterVisibility.updateVisibility(b);this.deconflictor&&this.deconflictor.addGraphic(b);this.labeler&&this.labeler.addGraphic(b);this.objectStates&&this.objectStates.addGraphic(b);
this.deconflictor&&this.owner.view.deconflictor.setInitialIconVisibilityFlag(this,b);b.initialize(this.stage,this.stageLayer,this.owner);f.isSome(this.graphicStateTracking)&&this.graphicStateTracking.addGraphic(b);if(a=this.whenGraphics3DGraphicRequests[d.uid])delete this.whenGraphics3DGraphicRequests[d.uid],a.resolve(b);return b};c.prototype.abortRendererChange=function(){this.rendererChangeAbortController&&(this.rendererChangeAbortController.abort(),this.rendererChangeAbortController=null)};c.prototype.rendererChange=
function(a){return g.__awaiter(this,void 0,void 0,function(){var b,d;return g.__generator(this,function(c){switch(c.label){case 0:this.abortRendererChange();if(a===this.currentRenderer)return[2];this.validateRenderer(a);if(!T.isSupportedRenderer3D(a))return this.currentRendererChange(null,!1),[2];if(!f.isSome(a)||!a.arcadeRequired)return[3,4];this.rendererChangeAbortController=b=n.createAbortController();return[4,this.ensureArcade()];case 1:return d=c.sent().arcadeUtils,n.throwIfAborted(b),d.hasGeometryOperations(a)?
[4,d.enableGeometryOperations()]:[3,3];case 2:c.sent(),n.throwIfAborted(b),c.label=3;case 3:return this.rendererChangeAbortController=null,this.currentRendererChange(a,!0),[3,5];case 4:this.currentRendererChange(a,!1),c.label=5;case 5:return[2]}})})};c.prototype.ensureArcade=function(){return g.__awaiter(this,void 0,void 0,function(){var a;return g.__generator(this,function(b){switch(b.label){case 0:if(!f.isNone(this.arcadeOnDemand))return[3,2];a=this;return[4,ea.loadArcade()];case 1:return a.arcadeOnDemand=
b.sent(),[2,this.arcadeOnDemand];case 2:return[2,this.arcadeOnDemand]}})})};c.prototype.currentRendererChange=function(a,b){this.currentRenderer=a;this.rendererHasGeometryOperations=b;this.symbolCreationContext.arcade=f.unwrap(this.arcadeOnDemand);b=this.symbolCreationContext.renderer;if(a!==b)if(this.updateUpdatePolicy(),this.symbolConversionCache.clear(),f.isNone(a))this.symbolCreationContext.renderer=null,this.recreateAllGraphics();else{var c=L.diff(b,a);this.updateUnchangedSymbolMappings(c,a,
b);this.symbolCreationContext.renderer=a;f.isNone(c)||("complete"===c.type?this.recreateAllGraphics():"partial"===c.type&&(this.applyRendererDiff(c,a,b)?this.volatileGraphicsUpdated():this.recreateAllGraphics()),this.notifyChange("maxSymbolComplexity"))}};c.prototype.diffHasSymbolChange=function(a){for(var b in a.diff)switch(b){case "visualVariables":case "defaultSymbol":case "uniqueValueInfos":break;case "authoringInfo":case "fieldDelimiter":delete a.diff[b];break;default:return!0}return!1};c.prototype.applySymbolSetDiff=
function(a,b,c){var d=this;a=a||[];b=b||[];for(var e=[],g=function(b){var m=k.graphicsBySymbol.get(b.id);m&&m.forEach(function(k,g){var h=k.graphic,l=d.layer instanceof da?d.layer:null,q=f.unwrap(d.arcadeOnDemand);if(b!==c.defaultSymbol||c.getSymbol(N.hydrateGraphic(h,l),{arcade:q})!==c.defaultSymbol)l=k.usedMemory,a.length||c.defaultSymbol?e.push(h):d.graphicsWithoutSymbol.set(g,h),h=d.graphics3DGraphics.get(g),d._conditionalRemove(h,g),k.destroy(),m.delete(g),d.removeGraphics3DGraphic(g,l),d.updateLayerVisibility()});
k._whenSymbolRemoved.forEachSimple(function(a){return a(b.id)})},k=this,h=0;h<b.length;h++)g(b[h]);if(a.length||e.length)this.graphicsWithoutSymbol.forEach(function(a){return e.push(a)}),this.graphicsWithoutSymbol.clear(),this.add(e);this.updateHasDraped();this._cleanupSymbols();this.labeler&&this.owner.view.labeler.setDirty();this.owner.view.deconflictor.setDirty()};c.prototype.applyUniqueValueRendererDiff=function(a,b,c){var d=a.diff.defaultSymbol,e=a.diff.uniqueValueInfos;if(d||e){var f=e?e.added.map(function(a){return a.symbol}):
[],k=e?e.removed.map(function(a){return a.symbol}):[];if(e)for(var g=0;g<e.changed.length;g++)f.push(e.changed[g].newValue.symbol),k.push(e.changed[g].oldValue.symbol);d?(c.defaultSymbol&&k.push(c.defaultSymbol),b.defaultSymbol&&f.push(b.defaultSymbol)):c.defaultSymbol&&f.length&&k.push(b.defaultSymbol);this.applySymbolSetDiff(f,k,b);delete a.diff.defaultSymbol;delete a.diff.uniqueValueInfos;return!0}return!1};c.prototype.calculateUnchangedSymbolMapping=function(a,b,c){var d=function(a){return f.isSome(a)?
a.id:null};if(b instanceof G.UniqueValueRenderer&&c instanceof G.UniqueValueRenderer&&(f.isNone(a)||"partial"===a.type)){var e=a&&a.diff;a=e&&e.defaultSymbol;var e=e&&e.uniqueValueInfos,g=void 0,g=e?e.unchanged.map(function(a){return{oldId:d(a.oldValue.symbol),newId:d(a.newValue.symbol)}}):c.uniqueValueInfos.map(function(a,c){return{oldId:d(a.symbol),newId:d(b.uniqueValueInfos[c].symbol)}});!a&&c.defaultSymbol&&g.push({oldId:d(c.defaultSymbol),newId:d(b.defaultSymbol)});return g}return[]};c.prototype.updateSymbolMapping=
function(a,b){var c=b?"string"===typeof b?b:b.id:null;b="string"===typeof b?null:b;if(a&&a!==c){var g=this.graphicsBySymbol.get(a);this.graphicsBySymbol.delete(a);void 0!==g&&this.graphicsBySymbol.set(c,g);g=this.symbols.get(a);void 0!==g&&(this.symbols.delete(a),this.symbols.set(c,g),f.isSome(g)&&(f.isSome(b)?g.symbol=b:g.symbol.id=c))}};c.prototype.updateUnchangedSymbolMappings=function(a,b,c){var d=0;for(a=this.calculateUnchangedSymbolMapping(a,b,c);d<a.length;d++)b=a[d],this.updateSymbolMapping(b.oldId,
b.newId)};c.prototype.applyRendererDiff=function(a,b,c){var d=this;return this.diffHasSymbolChange(a)?!1:b instanceof G.UniqueValueRenderer&&c instanceof G.UniqueValueRenderer&&this.applyUniqueValueRendererDiff(a,b,c)&&0===Object.keys(a.diff).length?!0:!C.someMap(this.graphicsBySymbol,function(c,g){c=d.symbols.get(g);return f.isSome(c)&&!c.applyRendererDiff(a,b)})};c.prototype.opacityChange=function(){this.forEachGraphics3DSymbol(function(a,b){return a.globalPropertyChanged("opacity",b)});this.updateStageLayerVisibility()};
c.prototype.updateUpdatePolicy=function(){var a=f.isSome(this.currentRenderer)&&"dictionary"===this.currentRenderer.type;f.isSome(this.forcedUpdatePolicy)?this._asyncUpdates=1===this.forcedUpdatePolicy:this._asyncUpdates=1===this.preferredUpdatePolicy||a;(this.symbolCreationContext.isAsync=this._asyncUpdates)||this.update(V.noBudget)};c.prototype.slicePlaneEnabledChange=function(a){a!==this.symbolCreationContext.slicePlaneEnabled&&(this.symbolCreationContext.slicePlaneEnabled=a,this.stageLayer.isSliceable=
a,this.forEachGraphics3DSymbol(function(a,c){return a.globalPropertyChanged("slicePlaneEnabled",c)}),this.deconflictor&&this.deconflictor.slicePlaneEnabledChange(),this.labeler&&this.labeler.slicePlaneEnabledChange())};c.prototype.physicalBasedRenderingChange=function(a){a!==this.symbolCreationContext.physicalBasedRenderingEnabled&&(this.symbolCreationContext.physicalBasedRenderingEnabled=a,this.forEachGraphics3DSymbol(function(a,c){return a.globalPropertyChanged("physicalBasedRenderingEnabled",c)}))};
c.prototype.pixelRatioChange=function(){var a=this;this.forEachGraphics3DSymbol(function(b,c,f){b.globalPropertyChanged("pixelRatio",c)||a._recreateSymbol(f)})};c.prototype._signalUpdatingDuringAsyncLoadedGraphicsChange=function(){var a=this;this._updatingPendingLoadedGraphicsChange&&this._updatingPendingLoadedGraphicsChange.remove();this._updatingPendingLoadedGraphicsChange=ba.schedule(function(){a._updatingPendingLoadedGraphicsChange=null})};c.prototype.setClippingExtent=function(a,b){var c=this.symbolCreationContext.clippingExtent,
f=ca.create();ra.toBoundingRect(a,f,b)?this.symbolCreationContext.clippingExtent=F.fromRect(F.create(),f):this.symbolCreationContext.clippingExtent=null;return!F.equals(this.symbolCreationContext.clippingExtent,c)};c.prototype.modifyGraphics3DGraphicVisibilities=function(a){var b=!1;this.graphics3DGraphics.forEach(function(c){a(c)&&(b=!0)});b&&(this.labeler&&this.owner.view.labeler.setDirty(),this.owner.view.deconflictor.setDirty())};c.prototype.forEachGraphics3DSymbol=function(a){for(var b=0,c=u.keysOfMap(this.symbols);b<
c.length;b++){var g=c[b],e=this.symbols.get(g);if(f.isNone(e))break;var h=this.graphicsBySymbol.get(g);a(e,h||wa,g)}};c.prototype.updateAllGraphicsVisibility=function(){var a=this;this.filterVisibility&&(this.filterVisibility.dirty=!0);this.modifyGraphics3DGraphicVisibilities(function(b){var c=a._updateUserVisibility(b);b=a.scaleVisibility&&a.scaleVisibility.updateVisibility(b);return c||b})};c.prototype.hideAllGraphics=function(){this.modifyGraphics3DGraphicVisibilities(function(a){return a.setVisibilityFlag(0,
!1,0)})};c.prototype.validateRenderer=function(a){(a=T.validateTo3D(a))&&p.warn("Renderer for layer '"+(this.layer.title?this.layer.title+", ":"")+", id:"+this.layer.id+"' is not supported in a SceneView",a.message)};c.prototype.volatileGraphicsUpdated=function(){this.labeler&&this.labeler.reset();this.stageLayer.invalidateSpatialQueryAccelerator();this.stageLayer.shaderTransformationChanged();this.notifyChange("updating")};c.prototype._cleanupSymbols=function(){var a=this;if(!(0<this.graphicsWaitingForSymbol.size||
this.suspendSymbolCleanup)){var b=!1;this.symbols.forEach(function(c,g){if(!(f.isNone(c)||0<c.referenced)){var d=a.graphicsBySymbol.get(g);d&&0!==d.size||(a.graphicsBySymbol.delete(g),a.symbols.delete(g),c&&c.destroy(),b=!0)}});b&&(this.recomputeExtentPadding(),this.notifyChange("maxSymbolComplexity"))}};c.prototype.snapshotInternals=function(){var a=this;return{graphics:u.keysOfMap(this.graphics3DGraphics).sort(),symbols:u.keysOfMap(this.symbols).sort(),graphicsBySymbol:u.keysOfMap(this.graphicsBySymbol).sort().map(function(b){return{symbolId:b,
graphics:u.keysOfMap(a.graphicsBySymbol.get(b)).sort()}}),graphicsWithoutSymbol:u.keysOfMap(this.graphicsWithoutSymbol).sort(),graphicsDrapedUids:u.keysOfSet(this.graphicsDrapedUids).sort(),pendingUpdates:this.pendingUpdates}};Object.defineProperty(c.prototype,"test",{get:function(){var a=this;return{symbols:this.symbols,filterVisibility:this.filterVisibility,numPending:this.pendingUpdates.size,forceUpdatePolicy:function(b){a.forcedUpdatePolicy=b;a.updateUpdatePolicy()}}},enumerable:!1,configurable:!0});
Object.defineProperty(c.prototype,"performanceInfo",{get:function(){return{visible:this.graphics3DGraphics.size,missing:this.graphicsWithoutSymbol.size,pending:this.pendingUpdates.size}},enumerable:!1,configurable:!0});var P;c.tmpVec=J.vec3f64.create();g.__decorate([l.property({readOnly:!0})],c.prototype,"computedExtent",void 0);g.__decorate([l.property()],c.prototype,"currentRenderer",void 0);g.__decorate([l.property()],c.prototype,"rendererHasGeometryOperations",void 0);g.__decorate([l.property()],
c.prototype,"rendererChangeAbortController",void 0);g.__decorate([l.property()],c.prototype,"elevationInfoChangeAbortController",void 0);g.__decorate([l.property()],c.prototype,"setupAbortController",void 0);g.__decorate([l.property({readOnly:!0})],c.prototype,"elevationAlignment",void 0);g.__decorate([l.property({readOnly:!0})],c.prototype,"scaleVisibility",void 0);g.__decorate([l.property({readOnly:!0})],c.prototype,"filterVisibility",void 0);g.__decorate([l.property({readOnly:!0})],c.prototype,
"extentPadding",void 0);g.__decorate([l.property()],c.prototype,"_updatingPendingLoadedGraphicsChange",void 0);g.__decorate([l.property({readOnly:!0})],c.prototype,"featureStore",void 0);g.__decorate([l.property({readOnly:!0})],c.prototype,"deconflictor",void 0);g.__decorate([l.property({readOnly:!0})],c.prototype,"labeler",void 0);g.__decorate([l.property({readOnly:!0})],c.prototype,"objectStates",void 0);g.__decorate([l.property()],c.prototype,"preferredUpdatePolicy",void 0);g.__decorate([l.property({constructOnly:!0})],
c.prototype,"elevationFeatureExpressionEnabled",void 0);g.__decorate([l.property({constructOnly:!0})],c.prototype,"owner",void 0);g.__decorate([l.property({constructOnly:!0})],c.prototype,"layer",void 0);g.__decorate([l.property({readOnly:!0})],c.prototype,"hasDraped",void 0);g.__decorate([l.property({readOnly:!0})],c.prototype,"symbolsUpdating",void 0);g.__decorate([l.property({constructOnly:!0})],c.prototype,"graphicSymbolSupported",void 0);g.__decorate([l.property({constructOnly:!0})],c.prototype,
"getRenderingInfoWithoutRenderer",void 0);g.__decorate([l.property({readOnly:!0,dependsOn:"elevationAlignment.updating scaleVisibility.updating filterVisibility.updating rendererChangeAbortController elevationInfoChangeAbortController _updatingPendingLoadedGraphicsChange".split(" ")})],c.prototype,"updating",null);g.__decorate([l.property({readOnly:!0})],c.prototype,"updatingRemaining",null);g.__decorate([l.property({readOnly:!0})],c.prototype,"updatingTotal",null);g.__decorate([l.property({readOnly:!0,
dependsOn:["owner.view.qualitySettings.graphics3D.maxTotalNumberOfPrimitives","owner.view.qualitySettings.graphics3D.maxTotalNumberOfFeatures","maxSymbolComplexity"]})],c.prototype,"displayFeatureLimit",null);g.__decorate([l.property({readOnly:!0})],c.prototype,"maxSymbolComplexity",null);g.__decorate([l.property({constructOnly:!0})],c.prototype,"hasZ",void 0);g.__decorate([l.property({constructOnly:!0})],c.prototype,"hasM",void 0);return c=P=g.__decorate([l.subclass("esri.views.3d.layers.graphics.Graphics3DCore")],
c)}(W);x.Graphics3DCore=R;var t=new Map,A=new I,Q=new aa(I);(function(){return function(){this.renderingInfo=this.add=null;this.state=0;this.remove=null}})();var va=10,r=J.vec3f64.create(),z=J.vec3f64.create(),wa=new Map});