// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.17/esri/copyright.txt for details.
//>>built
define("require exports ../../../../core/compilerUtils ../../../../core/Handles ../../../../core/has ../../../../core/MapUtils ../../../../core/maybe ../../../../core/TimeProfiler ../../../../core/watchUtils ../../../../core/libs/gl-matrix-2/mat4 ../../../../core/libs/gl-matrix-2/mat4f64 ../../../../core/libs/gl-matrix-2/vec2f64 ../../../../core/libs/gl-matrix-2/vec3f64 ../../support/debugFlags ../core/renderPasses/RenderPassManager ../core/shaderLibrary/hud/HUD.glsl ./BoundingInfo ./Camera ./depthRange ./depthRangeUtils ./FxaaRenderPass ./glUtil3D ./HighlightHelper ./Material ./OffscreenRendering ./RenderContext ./rendererUtils ./RenderPluginManager ./renderStats ./ShadowMap ./SliceHelper ./SmaaRenderPass ./SSAOHelper ./edgeRendering/EdgeView ../lighting/SceneLighting ../materials/renderers/MergedRenderer ../../../webgl/Profiling".split(" "),
function(x,y,E,F,G,u,m,z,H,l,r,I,J,v,K,w,L,M,N,O,P,Q,R,A,S,T,U,V,W,X,Y,Z,aa,ba,ca,da,ea){Object.defineProperty(y,"__esModule",{value:!0});x=function(){function b(a,c,d,b,g,f,h,k){var e=this;this._materialRep=a;this._rctx=b;this._compositingHelper=g;this.requestRender=f;this._stage=k;this._materialRenderers=new Map;this._hasWater=this._hasOccludees=this._hasHighlights=!1;this._camera=new M.default(J.vec3f64.fromValues(0,100,-100));this._lighting=new ca.SceneLighting;this._content=new Map;this._isRendering=
!1;this._fallbackDepthStencilTexture=null;this._stats=new W.RenderStatsAggregator;this._antialiasing=1;this._edgeView=null;this._handles=new F;this._OITEnabled=!1;this.renderHiddenTransparentEdges=function(){};this._shaderTechniqueRepository=d;this._fxaaPass=new P(this._rctx);this._smaaPass=new Z(this._rctx);this.camera.viewport[2]=h[0];this.camera.viewport[3]=h[1];this.requestRender();this._bindParameters={slot:null,camera:null,inverseViewport:I.vec2f64.create(),shadowMappingEnabled:!1,ssaoEnabled:!1,
origin:null,screenToWorldRatio:null,screenToWorldRatioGlobalWM:null,slicePlane:null,highlightDepthTexture:null,hasOccludees:!1,linearDepthTexture:null,linearDepthTextureID:0,lastFrameColorTexture:null,lastFrameColorTextureID:0,reprojectionMat:null,ssrEnabled:!1,lighting:this._lighting};this._offscreenRendering=new S.OffscreenRendering(this._rctx,this._compositingHelper);this._sliceHelper=new Y;this._shadowMap=new X(this._rctx,d.viewingMode);this._ssaoHelper=new aa(d,this._rctx,function(){return e.requestRender()});
this._highlightHelper=new R(d,this._rctx);this._renderPlugins=new V.RenderPluginManager({rctx:this._rctx,shaderTechniqueRep:d,textureRep:c,materialRep:this._materialRep,requestRender:this.requestRender});this.renderPassManager=new K.RenderPassManager(this._rctx,this._shaderTechniqueRepository);this._renderPlugins.add(this.renderPassManager.slots(),this.renderPassManager);this._renderContext=new T(this._rctx,this._offscreenRendering,this._lighting,this._shadowMap,this._ssaoHelper,this._sliceHelper);
this._renderContext.ssrParams={camera:null,linearDepthTexture:null,linearDepthTextureID:0,lastFrameColorTexture:null,lastFrameColorTextureID:0,reprojectionMat:null,ssrEnabled:!1};G("enable-feature:alo10771/OIT")&&(this._OITEnabled=!0);this._handles.add(H.init(v,"EDGES_SHOW_HIDDEN_TRANSPARENT_EDGES",function(a){e.renderHiddenTransparentEdges=a?function(){return e.renderEdges(1)}:function(){};e.requestRender()}))}b.prototype.dispose=function(){this._handles.destroy();this._fxaaPass.disable();this._smaaPass.disable();
this._materialRenderers.forEach(function(a){return a.dispose()});this._materialRenderers=null;this._edgeView=m.destroyMaybe(this._edgeView);this._offscreenRendering=m.disposeMaybe(this._offscreenRendering);this._fallbackDepthStencilTexture=m.disposeMaybe(this._fallbackDepthStencilTexture);this._shadowMap&&(this._shadowMap.enabled=!1,this._shadowMap.dispose());this._ssaoHelper&&(this._ssaoHelper.enabled=!1,this._ssaoHelper.dispose());this._highlightHelper&&(this._highlightHelper.enabled=!1);L.tmpIndices.prune();
this._content.clear();this._content=null};Object.defineProperty(b.prototype,"updating",{get:function(){return 1===this._antialiasing&&this._smaaPass.isLoadingResources},enumerable:!1,configurable:!0});b.prototype.ensureEdgeView=function(){var a=this;null==this._edgeView&&(this._edgeView=new ba.EdgeView(this._rctx,this._shaderTechniqueRepository,{setNeedsRender:function(){return a.requestRender()}}));return this._edgeView};Object.defineProperty(b.prototype,"camera",{get:function(){return this._camera},
set:function(a){this._camera.copyFrom(a);this.requestRender()},enumerable:!1,configurable:!0});Object.defineProperty(b.prototype,"edgeView",{get:function(){return this._edgeView},enumerable:!1,configurable:!0});b.prototype.setLighting=function(a){this._lighting.set(a)};b.prototype.setRenderParams=function(a){void 0!==a.ssrEnable&&(this.renderPassManager.screenSpaceReflectionsEnabled=a.ssrEnable);void 0!==a.shadowMap&&(this._shadowMap.enabled=a.shadowMap,this.renderPassManager.shadowCastingEnabled=
a.shadowMap);void 0!==a.shadowMapMaxCascades&&(this._shadowMap.maxCascades=a.shadowMapMaxCascades);this._highlightHelper.enabled=!0;void 0!==a.ssao&&(this._ssaoHelper.enabled=a.ssao);void 0!==a.ssaoAttenuation&&(this._ssaoHelper.attenuation=a.ssaoAttenuation);void 0!==a.ssaoRadius&&(this._ssaoHelper.radius=a.ssaoRadius);void 0!==a.ssaoFilterRadius&&console.error("The property ssaoFilterRadius is no longer supported as a render parameter.");void 0!==a.ssaoSamples&&(this._ssaoHelper.samples=a.ssaoSamples);
a.background&&(this._offscreenRendering.background=a.background);void 0!==a.antialiasingEnabled&&(this._antialiasing=a.antialiasingEnabled?1:0);void 0!==a.defaultHighlightOptions&&this._highlightHelper.setDefaultOptions(a.defaultHighlightOptions);void 0!==a.slicePlane&&(this._sliceHelper.plane=m.unwrap(a.slicePlane));void 0!==a.waterReflectionEnabled&&(this._waterReflectionEnabled=10<=this._rctx.parameters.maxTextureImageUnits&&a.waterReflectionEnabled);this.requestRender()};Object.defineProperty(b.prototype,
"hasSlicePlane",{get:function(){return!!this._sliceHelper.plane},enumerable:!1,configurable:!0});Object.defineProperty(b.prototype,"renderPlugins",{get:function(){return this._renderPlugins},enumerable:!1,configurable:!0});Object.defineProperty(b.prototype,"canRender",{get:function(){return 0<this._camera.fullWidth&&0<this._camera.fullHeight},enumerable:!1,configurable:!0});b.prototype.getStats=function(){return this._stats.getAggregatedStats()};b.prototype.getFramebufferTexture=function(a){switch(a){case "color":return this._offscreenRendering.colorTexture;
case "hudVisibility":return this._offscreenRendering.hudVisibilityTexture;case "shadowMap":return this._shadowMap&&this._shadowMap.getDepthTexture();case "linearDepth":return this._offscreenRendering.linearDepthTexture;case "normals":return this._offscreenRendering.normalTexture;case "highlight":return this._offscreenRendering.highlightTexture;default:return E.neverReached(a),null}};b.prototype.modify=function(a,c,d,b,g,f){var e=this;void 0===c&&(c=a?a.length:0);void 0===b&&(b=d?d.length:0);void 0===
f&&(f=g?g.length:0);this._isRendering&&console.warn("Renderer.modify called while rendering");for(var k=0;k<b;++k)this._content.delete(d[k].uniqueName);for(k=0;k<c;++k)this._content.set(a[k].uniqueName,a[k]);if(c||b||f){var B=!1;U.splitRenderGeometryChangeSetByMaterial({toAdd:a,numToAdd:c,toRemove:d,numToRemove:b,toUpdate:g,numToUpdate:f}).forEach(function(a,c){var d=e._materialRenderers.get(c);!d&&0<a.toAdd.length&&(d=new da(e._rctx,e._materialRep,c),e._materialRenderers.set(c,d));d&&(d.modify(a),
d.isEmpty&&(B=!0))});B&&this._materialRenderers.forEach(function(a,c){a.isEmpty&&(e._materialRenderers.delete(c),a.dispose())});this._hasHighlights=u.someMap(this._materialRenderers,function(a){return a.hasHighlights});this._hasOccludees=u.someMap(this._materialRenderers,function(a){return a.hasOccludees});this._hasWater=u.someMap(this._materialRenderers,function(a){return a.hasWater});this.requestRender()}};b.prototype.updateLogic=function(a){var c=!1;this._materialRenderers.forEach(function(d){d.updateLogic&&
(c=d.updateLogic(a)||c)});return c};b.prototype.render=function(a,c,d,b){var e=this;this._isRendering=!0;var f=this._offscreenRendering;f.needLastFrameColorTexture=this._waterReflectionEnabled;f.advanceCurrentRenderTarget();var h=this._sliceHelper.plane;d&&(this._sliceHelper.plane=null);this._rctx.bindFramebuffer(a);c.setGLViewport(this._rctx);this._renderPlugins.prepareRender(c);this.renderShadowMap(a,c,b);this.ensureBindParameters(this._renderContext,c);this.ensureBindParametersSSR(this._renderContext);
f.initializeFrame(c);this.renderLinearDepth();this.renderNormal();this._ssaoHelper.enabled&&this._ssaoHelper.computeSSAO(c,f.linearDepthTexture,f.normalTexture);this._ssaoHelper.bindToAllPrograms(this._shaderTechniqueRepository);this._stats.reset();this._renderContext.pass=0;this._renderContext.hasOccludees=this._hasOccludees;f.bindFramebuffer();this._renderPlugins.render(0,this._renderContext);this.renderOpaqueGeometry(this._renderContext);this.renderEdges(2);this.renderHiddenTransparentEdges();
this.renderOrderIndependentTransparency();this.renderEdges(1);d=c=!1;c=this.renderHUDVisibility(this._renderContext);this.renderInternalSlot(20,this._renderContext);(d=this.renderTransparentTerrain(this._renderContext))&&c&&(f.compositeTransparentTerrainOntoHUDVisibility(),f.renderToTargets(function(){return e.renderHUD(w.HUD.TransparentRenderStyle.OCCLUDED)},f.currentColorTarget,f.tmpDepth,void 0,!0,!0));d&&f.compositeTransparentTerrainOntoMain();f.renderToTargets(function(){e.renderInternalSlot(8,
e._renderContext);e._renderPlugins.render(15,e._renderContext);e._renderPlugins.render(16,e._renderContext)},f.currentColorTarget,f.mainDepth);this._renderPlugins.needsLaserlineWithContrastControl&&f.renderAndComposite(function(){e._renderPlugins.render(17,e._renderContext)},2);this.renderOccluded();this.renderAntiAliasing(a,this._antialiasing);this._rctx.bindFramebuffer(a);this._rctx.clearSafe(256);this.renderHUD(w.HUD.TransparentRenderStyle.NOTOCCLUDED);this.renderHighlights(this._renderContext.camera,
a);this._renderContext.lastFrameCamera.copyFrom(this._renderContext.camera);this._sliceHelper.plane=h;this._isRendering=!1;if(this.onPostRender)this.onPostRender()};b.prototype.renderEdges=function(a){var c=this,d=this._edgeView;d&&d.shouldRender()&&this._offscreenRendering.renderAndComposite(function(){return d.render(c._bindParameters,a)},1)};b.prototype.renderShadowMap=function(a,c,d){var b=this._shadowMap;if(b.enabled){v.ENABLE_PROFILE_DEPTH_RANGE&&z.begin("depthRange");var g=this.computeDepthRange(c);
v.ENABLE_PROFILE_DEPTH_RANGE&&z.end("depthRange");b.prepare(c,d,g);d=b.getCascades();for(g=0;g<d.length;++g){var f=d[g];f.camera.setGLViewport(this._rctx);this.ensureCameraBindParameters(this._renderContext,f.camera);this.renderGeometryPass(3)}b.finish(a);c.setGLViewport(this._rctx)}b.bindToAllPrograms(this._shaderTechniqueRepository)};b.prototype.renderLinearDepth=function(){var a=this;this._ssaoHelper.enabled||this._renderPlugins.needsLinearDepth||this._hasWater&&this._waterReflectionEnabled?this._offscreenRendering.renderToTargets(function(){return a.renderGeometryPass(1)},
this._offscreenRendering.linearDepth,this._offscreenRendering.tmpDepth,[0,0,0,0],!0,!0):this._offscreenRendering.disposeTarget(this._offscreenRendering.linearDepth)};b.prototype.renderNormal=function(){var a=this;this._ssaoHelper.enabled?this._offscreenRendering.renderToTargets(function(){a.renderGeometryPass(2)},this._offscreenRendering.normal,this._offscreenRendering.tmpDepth,[0,0,0,0],!0,!0):this._offscreenRendering.disposeTarget(this._offscreenRendering.normal)};b.prototype.computeDepthRange=
function(a){var c=O.depthRangeFromScene(a,this._content,this._stage.getLayers());N.union(c,this.renderPlugins.queryDepthRange(a));c.near=Math.max(a.near,c.near);c.far=Math.min(a.far,c.far);return c};b.prototype.renderGeometryPass=function(a){this._renderContext.pass=a;this.renderOpaqueGeometry(this._renderContext);this.renderTransparentGeometry(this._renderContext);this.renderTransparentTerrain(this._renderContext)};b.prototype.renderOpaqueGeometry=function(a){this._renderPlugins.render(1,a);this._renderPlugins.render(2,
a);this.renderInternalSlot(3,a);this._renderPlugins.render(4,a);a.ssaoHelper&&a.ssaoHelper.bindToAllPrograms(this._shaderTechniqueRepository);this._renderPlugins.render(14,this._renderContext)};b.prototype.renderTransparentGeometry=function(a){this.renderInternalSlot(5,a);this._renderPlugins.render(6,a);a.ssaoHelper&&a.ssaoHelper.bindToAllPrograms(this._shaderTechniqueRepository)};b.prototype.renderTransparentTerrain=function(a){return this._renderPlugins.render(7,a)};b.prototype.renderHUDVisibility=
function(a){var c=this,b=!1;a.offscreenRenderingHelper&&a.offscreenRenderingHelper.renderHUDVisibility(function(){c._bindParameters.hudVisibilityTexture=c._renderContext.offscreenRenderingHelper?c._renderContext.offscreenRenderingHelper.hudVisibilityTexture:null;b=c.renderInternalSlot(12,a)});return b};b.prototype.renderHUD=function(a){this._bindParameters.renderTransparentlyOccludedHUD=a;this.renderInternalSlot(21,this._renderContext);this.renderInternalSlot(18,this._renderContext);this.renderInternalSlot(19,
this._renderContext)};b.prototype.renderHighlights=function(a,c){var b=this,e=this._highlightHelper;if(e&&e.enabled&&(this._hasHighlights||this._renderPlugins.needsHighlight)){var g=null;e.profilingCallback&&(g=ea.startMeasurement(this._renderContext.rctx));this._renderContext.highlightDepthTexture=this._bindParameters.highlightDepthTexture;var f=this._offscreenRendering.renderToTargets(function(){b.renderGeometryPass(4);b._rctx.clearSafe(256);b.renderHUD(w.HUD.TransparentRenderStyle.BOTH)},this._offscreenRendering.highlight,
this._offscreenRendering.tmpDepth,[0,0,0,0],!0,!0);e.render(a,f,c);null!==g&&e.profilingCallback&&g.stop(function(a){e.profilingCallback&&e.profilingCallback(a)})}else this._offscreenRendering.disposeTarget(this._offscreenRendering.highlight)};b.prototype.renderOrderIndependentTransparency=function(){var a=this;if(this._OITEnabled&&this._rctx.capabilities.textureFloat&&this._rctx.capabilities.textureFloat.textureFloat){var c=function(c){a._renderContext.transparencyPassType=c;a._offscreenRendering.renderOITPass(function(){return a.renderTransparentGeometry(a._renderContext)},
c)};c(0);c(1);c(2);this._offscreenRendering.compositeTransparentOntoOpaque();this._renderContext.transparencyPassType=3}else this.renderTransparentGeometry(this._renderContext)};b.prototype.renderOccluded=function(){var a=this,c=0;this._materialRenderers.forEach(function(a,b){b&&b.isVisible()&&8===b.renderOccluded&&(c|=b.renderOccluded,p.push(b))});var b=this._offscreenRendering,e=this._renderContext,g=function(a,e,d,f,g){void 0===d&&(d=function(){return h(e)});void 0===f&&(f=!0);void 0===g&&(g=!0);
0!==(c&e)&&(b.renderToTargets(d,b.tmpColor,b.mainDepth,[0,0,0,0],f,g),b.compositeOccludedOntoMain(a))};0!==p.length&&(this.renderInternalSlot(10,e,p),g(.2,8,function(){return a.renderInternalSlot(11,e,p)},!1,!1),p.length=0);this._materialRenderers.forEach(function(a,b){b&&b.isVisible()&&(4===b.renderOccluded||2===b.renderOccluded||32===b.renderOccluded||16===b.renderOccluded)&&(c|=b.renderOccluded,q.push(b))});var f=this._renderPlugins.renderOccludedFlags;if(c|=f){var h=function(b){e.renderOccludedMask=
b;1<f&&a._renderPlugins.render(9,e);a.renderInternalSlot(3,e,q);a.renderInternalSlot(5,e,q);a.renderInternalSlot(8,e,q);e.resetRenderOccludedMask()};e.pass=0;g(.5,4,function(){return h(4)},!0,2);g(.5,2,function(){return h(2)},!0,2);g(1,48,function(){h(16);h(32)},!0,2);q.length=0}};b.prototype.renderAntiAliasing=function(a,b){var c=this;switch(b){case 1:this._smaaPass.loadResources(function(){return c.requestRender()});this._smaaPass.enable()?(this._fxaaPass.disable(),this._smaaPass.render({colorTexture:this._offscreenRendering.colorTexture},
a)):(this._rctx.bindFramebuffer(a),this._offscreenRendering.composite());break;case 2:this._fxaaPass.enable()?(this._smaaPass.disable(),this._fxaaPass.render({colorTexture:this._offscreenRendering.colorTexture},a)):(this._rctx.bindFramebuffer(a),this._offscreenRendering.composite());break;default:this._rctx.bindFramebuffer(a),this._offscreenRendering.composite(),this._fxaaPass.disable(),this._smaaPass.disable()}};b.prototype.ensureCameraBindParameters=function(a,b){this._renderContext.camera=b;this._bindParameters.camera=
a.camera;this._bindParameters.inverseViewport[0]=1/a.camera.fullViewport[2];this._bindParameters.inverseViewport[1]=1/a.camera.fullViewport[3]};b.prototype.ensureBindParameters=function(a,b){this.ensureCameraBindParameters(a,b);b=this._renderContext.offscreenRenderingHelper;this._bindParameters.shadowMap=a.shadowMap;this._bindParameters.shadowMappingEnabled=!!a.shadowMap&&a.shadowMap.enabled;this._bindParameters.ssaoEnabled=!!a.ssaoHelper&&a.ssaoHelper.enabled;this._bindParameters.slicePlane=a.sliceHelper&&
a.sliceHelper.plane;this._bindParameters.hasOccludees=a.hasOccludees;this._bindParameters.linearDepthTextureID=3;this._bindParameters.lastFrameColorTextureID=4;this._bindParameters.hudVisibilityTexture=b?b.hudVisibilityTexture:null;this._bindParameters.highlightDepthTexture=b&&b.depthTexture||this.getFallbackDepthTexture()};b.prototype.ensureBindParametersSSR=function(a){this._waterReflectionEnabled?(l.mat4.translate(C,a.lastFrameCamera.viewMatrix,this._bindParameters.origin?this._bindParameters.origin:
[0,0,0]),l.mat4.translate(t,a.camera.viewMatrix,this._bindParameters.origin?this._bindParameters.origin:[0,0,0]),l.mat4.invert(t,t),l.mat4.invert(D,a.camera.projectionMatrix),l.mat4.multiply(n,t,D),l.mat4.multiply(n,C,n),l.mat4.multiply(n,a.lastFrameCamera.projectionMatrix,n),this._renderContext.ssrParams.camera=a.camera,this._renderContext.ssrParams.reprojectionMat=this._bindParameters.reprojectionMat=n,this._renderContext.ssrParams.linearDepthTexture=this._bindParameters.linearDepthTexture=this._offscreenRendering.linearDepthTexture,
this._renderContext.ssrParams.lastFrameColorTexture=this._bindParameters.lastFrameColorTexture=this._offscreenRendering.lastFrameColorTexture):this._renderContext.ssrParams.lastFrameColorTexture=this._bindParameters.lastFrameColorTexture=null;this._renderContext.ssrParams.ssrEnabled=this._bindParameters.ssrEnabled=this._waterReflectionEnabled};b.prototype.renderInternalSlot=function(a,b,d){var c=this,g=0===b.pass?this._stats:null,f=!1;this._bindParameters.slot=a;m.isSome(d)?d.forEach(function(d){A.materialPredicate(d,
b)&&(d=c._materialRenderers.get(d),m.isSome(d)&&(f=d.render(a,b,c._bindParameters)||f))}):this._materialRenderers.forEach(function(d,e){A.materialPredicate(e,b)&&(e=g?g.getMaterialRenderStatsObject(d.type):null,f=d.render(a,b,c._bindParameters,e)||f)});return f};b.prototype.getFallbackDepthTexture=function(){this._fallbackDepthStencilTexture||(this._fallbackDepthStencilTexture=Q.createEmptyDepthTexture(this._rctx));return this._fallbackDepthStencilTexture};b.prototype.getGpuMemoryUsage=function(){return{offscreen:this._offscreenRendering?
this._offscreenRendering.getGpuMemoryUsage():0,highlights:this._highlightHelper?this._highlightHelper.getGpuMemoryUsage():0,shadows:this._shadowMap?this._shadowMap.getGpuMemoryUsage():0,ssao:this._ssaoHelper?this._ssaoHelper.getGpuMemoryUsage():0}};Object.defineProperty(b.prototype,"test",{get:function(){var a=this;return{antialiasing:this._antialiasing,offscreen:this._offscreenRendering,shadowMap:this._shadowMap,ssao:this._ssaoHelper,highlight:this._highlightHelper,materialRenderers:this._materialRenderers,
OITEnabled:this._OITEnabled,setOITEnabled:function(b){return a._OITEnabled=b}}},enumerable:!1,configurable:!0});return b}();y.default=x;var q=[],p=[],C=r.mat4f64.create(),D=r.mat4f64.create(),t=r.mat4f64.create(),n=r.mat4f64.create()});