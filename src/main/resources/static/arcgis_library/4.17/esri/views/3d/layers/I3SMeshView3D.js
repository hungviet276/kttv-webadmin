// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.17/esri/copyright.txt for details.
//>>built
define("require exports tslib ../../../Color ../../../Graphic ../../../core/Collection ../../../core/has ../../../core/Logger ../../../core/MapUtils ../../../core/mathUtils ../../../core/maybe ../../../core/PooledArray ../../../core/promiseUtils ../../../core/scheduling ../../../core/typedArrayUtil ../../../core/unitUtils ../../../core/watchUtils ../../../core/accessorSupport/decorators ../../../core/libs/gl-matrix-2/mat3 ../../../core/libs/gl-matrix-2/mat3f32 ../../../core/libs/gl-matrix-2/mat4 ../../../core/libs/gl-matrix-2/mat4f64 ../../../core/libs/gl-matrix-2/vec3 ../../../core/libs/gl-matrix-2/vec3f64 ../../../core/libs/gl-matrix-2/vec4 ../../../geometry/support/aaBoundingBox ../../../layers/graphics/controllers/I3SOnDemandController ../../../layers/support/fieldUtils ../../../layers/support/layerUtils ../../../layers/support/SceneModification ../../../renderers/visualVariables/support/visualVariableUtils ../../../support/arcadeOnDemand ../../../symbols/Symbol3D ../../../symbols/support/unitConversionUtils ./I3SMeshViewLabeler ./I3SMeshWorkerHandle ./SceneLayerWorker ./graphics/graphicUtils ./i3s/Highlights ./i3s/I3SCrossfadeHelper ./i3s/I3SElevationProvider ./i3s/I3SGeometryUtil ./i3s/I3SIntersectionHandler ./i3s/I3SProjectionUtil ./i3s/I3SUtil ./i3s/IDBCache ./support/attributeUtils ./support/layerViewUpdatingProperties ../support/debugFlags ../support/extentUtils ../support/orientedBoundingBox ../support/projectionUtils ../support/buffer/glUtil ../webgl-engine/collections/Component/SourceGeometry ../webgl-engine/core/material/RenderTexture ../webgl-engine/core/shaderLibrary/util/AlphaDiscard.glsl ../webgl-engine/lib/Texture ../webgl-engine/lib/TextureBackedBuffer/BufferManager @dojo/framework/shim/Promise".split(" "),
function(P,G,g,ia,K,ja,ka,la,Q,L,f,ma,r,na,R,oa,S,l,pa,qa,T,U,V,W,ra,E,sa,X,ta,ua,Y,va,wa,xa,ya,Z,za,aa,Aa,Ba,Ca,Da,Ea,M,k,Fa,N,Ga,H,Ha,O,F,Ia,Ja,I,Ka,ba,La){function ca(f){var g=f.metallicRoughness;return g&&0<=g.baseColorTextureId||g&&0<=g.metallicRoughnessTextureId||0<=f.normalTextureId||0<=f.emissiveTextureId||0<=f.occlusionTextureId}function da(g){return f.isSome(g)&&R.isArrayBuffer(g.data)}function ea(g,v){g=1024+g.interleavedVertexData.byteLength+(g.indices?g.indices.byteLength:0)+g.positionData.data.byteLength+
g.positionData.indices.byteLength;if(f.isSome(v))for(var c=0;c<v.length;c++){var a=v[c];f.isSome(a)&&R.isArrayBuffer(a.data)&&(g+=a.data.byteLength)}return g}function fa(f,g){return 104857600<g.byteSize?(D.warn("Node is too big to store in IndexedDB cache: "+f.id+" ("+g.byteSize+" bytes)"),!1):0<g.byteSize}function Ma(g){if(0===g.length)return null;var k=new Float64Array(10*g.length);g.forEachSimple(function(c,a){var b=c.serviceObb;f.isNone(b)&&(b=Na,V.vec3.copy(b.center,c.mbs),b.halfSize[0]=b.halfSize[1]=
b.halfSize[2]=c.mbs[3]);c=10*a;k[c+0]=b.center[0];k[c+1]=b.center[1];k[c+2]=b.center[2];k[c+3]=b.halfSize[0];k[c+4]=b.halfSize[1];k[c+5]=b.halfSize[2];k[c+6]=b.quaternion[0];k[c+7]=b.quaternion[1];k[c+8]=b.quaternion[2];k[c+9]=b.quaternion[3]});return k}Object.defineProperty(G,"__esModule",{value:!0});G.I3SMeshView3D=void 0;var D=la.getLogger("esri.views.3d.layers.SceneLayerView3D"),ga=[1,1,1,1],Oa=function(){return function(f,g,c,a,b,d,e){this.node=f;this.featureIds=g;this.objectHandle=c;this.cachedRendererVersion=
a;this.attributeInfo=b;this.material=d;this.textures=e;this.lodCrossfadeTargetTime=null;this.lodCrossfadeDirection=0;this.cachedEdgeMaterials=[];this.cachedSymbology=null}}();G.I3SMeshView3D=function(G){return function(v){function c(){var a=null!==v&&v.apply(this,arguments)||this;a._elevationProvider=null;a._intersectionHandler=null;a._nodeId2Meta=new Map;a._nodeId2MetaReloading=new Map;a._asyncModuleLoading=0;a._addTasks=new Map;a._rendererVersion=0;a._colorVariable=null;a._opacityVariable=null;
a._rendererFields=null;a._symbologyFields=null;a._symbologyOverride=null;a._symbologyOverrideFields=null;a._symbolInfos=new Map;a._idbCache=new Fa.IDBCache("esri-scenelayer-cache","geometries");a._labeler=null;a.holeFilling="auto";a._hasColors=!1;a._hasTextures=!1;a._hasData=!1;a.slicePlaneEnabled=!1;a._modifications=[];a._layerUrl="";a._cacheKeySuffix=null;a._arcade=null;a._tmpAttributeOnlyGraphic=new K(null,null,{});a._crossfadeHelper=new Ba.I3SCrossfadeHelper(a);return a}g.__extends(c,v);Object.defineProperty(c.prototype,
"lodCrossfadeDuration",{get:function(){return 0},enumerable:!1,configurable:!0});Object.defineProperty(c.prototype,"layerUid",{get:function(){return this.i3slayer&&this.i3slayer.uid},enumerable:!1,configurable:!0});Object.defineProperty(c.prototype,"sublayerUid",{get:function(){return null},enumerable:!1,configurable:!0});Object.defineProperty(c.prototype,"hasTexturesOrVertexColors",{get:function(){return this._hasData?this._hasTextures||this._hasColors?"yes":"probably-not":"unknown"},enumerable:!1,
configurable:!0});Object.defineProperty(c.prototype,"rendererTextureUsage",{get:function(){return k.rendererNeedsTextures(this._currentRenderer)?63:44},enumerable:!1,configurable:!0});Object.defineProperty(c.prototype,"elevationOffset",{get:function(){var a=null!=this.i3slayer?this.i3slayer.elevationInfo:null;if(null!=a&&"absolute-height"===a.mode){var b=oa.getMetersPerVerticalUnitForSR(this.i3slayer.spatialReference),d=xa.getMetersPerUnit(a.unit);return f.unwrapOr(a.offset,0)*d/b}return 0},enumerable:!1,
configurable:!0});Object.defineProperty(c.prototype,"uncompressedTextureDownsamplingEnabled",{get:function(){return this.view&&this.view.qualitySettings.sceneService.uncompressedTextureDownsamplingEnabled&&!this.useCompressedTextures},enumerable:!1,configurable:!0});Object.defineProperty(c.prototype,"useCompressedTextures",{get:function(){var a=this.i3slayer.version,a=!ka("trident")||1<a.major||1===a.major&&3<a.minor;return this.view._stage.renderView.has("s3tc")&&a},enumerable:!1,configurable:!0});
Object.defineProperty(c.prototype,"_enableMipMaps",{get:function(){return!this.uncompressedTextureDownsamplingEnabled},enumerable:!1,configurable:!0});Object.defineProperty(c.prototype,"_enableAtlasMipMaps",{get:function(){return this._enableMipMaps},enumerable:!1,configurable:!0});Object.defineProperty(c.prototype,"_atlasBiasCompensationEnabled",{get:function(){return this.view&&this.view._stage&&!this.view._stage.renderView.has("shaderTextureLOD")&&this._enableAtlasMipMaps},enumerable:!1,configurable:!0});
Object.defineProperty(c.prototype,"_disableAtlasAnisotropy",{get:function(){return this._atlasBiasCompensationEnabled},enumerable:!1,configurable:!0});c.prototype.initialize=function(){var a=this;this._worker=new Z.I3SMeshWorkerHandle(this.view.resourceController.scheduler);this.addResolvingPromise(this._worker.promise);this._worker.setLegacySchema(this.layerUid,this.i3slayer.store.defaultGeometrySchema);k.checkSceneLayerValid(this.i3slayer);k.checkSceneLayerCompatibleWithView(this.i3slayer,this.view);
this._layerUrl=this.i3slayer.parsedUrl.path;this._controller=new sa({layerView:this});this.geoMemoryEstimate=this.texMemoryEstimate=this.gpuMemoryEstimate=0;this._stage=this.view._stage;this._collection=this._stage.renderView.componentObjectCollection;this._highlights=new Aa({collection:this._collection,forAllFeatures:function(b){return a._forAllFeatures(b,null,1)},forAllFeaturesOfNode:function(b,e){return a._forAllFeaturesOfNode(b,e)}});if(this._isIntegratedMesh||!this.i3slayer.store.defaultGeometrySchema)this._hasSymbolColors=
!1;else{var b=this.i3slayer.store.defaultGeometrySchema.featureAttributes;this._hasSymbolColors=!!(b&&b.faceRange&&b.id)}this._hasVertexColors=null!=this.i3slayer.store.defaultGeometrySchema.vertexAttributes.color&&(null==this.i3slayer.cachedDrawingInfo||!this.i3slayer.cachedDrawingInfo.color);this._isIntegratedMesh||(this._edgeView=this._stage.renderView.ensureEdgeView());this._memCache=this.view.resourceController.memoryController.getMemCache(this.i3slayer.uid,function(b){return a._deleteComponentObject(b)});
this._intersectionHandler=new Ea.I3SIntersectionHandler({layerUid:this.layerUid,sublayerUid:this.sublayerUid,collection:this._collection,slicePlaneEnabled:this.slicePlaneEnabled,isGround:this._isIntegratedMesh,forEach:function(b){a._nodeId2Meta.forEach(function(a){return f.isSome(a)&&b(a.node,a.objectHandle)});a._nodeId2MetaReloading.forEach(function(a){return f.isSome(a)&&b(a.node,a.objectHandle)})}});this._elevationProvider=new Ca({layerView:this,intersectionHandler:this._intersectionHandler});
this.updatingHandles.add(this,"view.clippingArea",function(){return a._clippingAreaChanged()},2);this.updatingHandles.add(this,"fullOpacity",function(b){return a._opacityChange(b)});this.updatingHandles.add(this,"slicePlaneEnabled",function(b){return a._slicePlaneEnabledChange(b)});this.updatingHandles.add(this,"elevationOffset",function(b,e){a._reloadAll(e);a._controller.invalidateVisibilityObbs()});this.updatingHandles.add(this,"filter",function(){return a._filterChange()},2);this.updatingHandles.add(this,
"view.qualitySettings.physicallyBasedRenderingEnabled",function(){return a._updatePBR()});b=function(){a._reloadAll();a._memCache.clear()};this.updatingHandles.add(this,"rendererTextureUsage",b);this.updatingHandles.add(this,"uncompressedTextureDownsamplingEnabled",b);this.updatingHandles.add(this,"suspended",function(b){return a._suspendedChange(b)},2);this.updatingHandles.add(this.i3slayer,"labelsVisible",function(){return a._labelingChanged()},2);this.updatingHandles.add(this.i3slayer,"labelingInfo",
function(){return a._labelingChanged()},2);this.updatingHandles.add(this,"_modifications",function(){return a._modificationsChanged()},2);this.handles.add([S.init(H,"I3S_TREE_SHOW_TILES",function(b){if(b&&!a._treeDebugger){var d=a._controller.crsIndex;(new Promise(function(a,b){P(["./support/I3STreeDebugger"],a,b)})).then(function(b){b=b.I3STreeDebugger;!a._treeDebugger&&H.I3S_TREE_SHOW_TILES&&(a._treeDebugger=new b({lv:a,view:a.view,nodeSR:d}))})}else b||!a._treeDebugger||H.I3S_TREE_SHOW_TILES||
(a._treeDebugger.destroy(),a._treeDebugger=null)}),S.init(H,"I3S_SHOW_MODIFICATIONS",function(){return a._showModifications()})]);this._cacheKeySuffix=k.getCacheKeySuffix(this.i3slayer.spatialReference,this.view.renderSpatialReference);this._idbCache.init().catch(function(a){return D.warn("Failed to initialize IndexedDB cache: "+a)});this._componentColorManager=this._hasSymbolColors?new La.BufferManager(this._stage.renderView.renderingContext):null};c.prototype.destroy=function(){this._clearAddTasks();
this._elevationProvider&&(this._elevationProvider.layerChanged(),this.view.elevationProvider.unregister(this._elevationProvider),this._elevationProvider=null);this._intersectionHandler&&(this._stage.sceneIntersectionHelper.removeIntersectionHandler(this._intersectionHandler),this._intersectionHandler=null);var a=this._worker;a&&(a.destroyContext(this.i3slayer.uid).then(function(){return a.destroy()}),this._worker=null);this._removeAllNodeDataFromStage();this._memCache.destroy();this._edgeView=this._stage=
this._collection=this._memCache=null;f.isSome(this._labeler)&&(this._labeler.destroy(),this._labeler=null);this._treeDebugger&&(this._treeDebugger.destroy(),this._treeDebugger=null);this._controller&&(this._controller.destroy(),this._controller=null);this._highlights.destroy();this._nodeId2MetaReloading=this._nodeId2Meta=null;this._componentColorManager&&(this._componentColorManager.destroy(),this._componentColorManager=null);this.emit("visible-geometry-changed");this._visibleGeometryChangedSchedulerHandle&&
(this._visibleGeometryChangedSchedulerHandle.remove(),this._visibleGeometryChangedSchedulerHandle=null)};c.prototype.memEstimateTextureAdded=function(a){a=a.estimatedTexMemRequired;this.gpuMemoryEstimate+=a;this.texMemoryEstimate+=a;return a};c.prototype.memEstimateTextureRemoved=function(a){a=a.estimatedTexMemRequired;this.gpuMemoryEstimate-=a;this.texMemoryEstimate-=a};c.prototype.memEstimateGeometryAdded=function(a){a=this._collection.getObjectGPUMemoryUsage(a);this.gpuMemoryEstimate+=a;this.geoMemoryEstimate+=
a;return a};c.prototype.memEstimateGeometryRemoved=function(a){a=this._collection.getObjectGPUMemoryUsage(a);this.gpuMemoryEstimate-=a;this.geoMemoryEstimate-=a};c.prototype.isNodeLoaded=function(a){return this._nodeId2Meta.has(a)};c.prototype.isNodeReloading=function(a){return this._nodeId2MetaReloading.has(a)};c.prototype.getUsedMemory=function(){var a=f.isSome(this._labeler)?this._labeler.usedMemory:0;this._nodeId2Meta.forEach(function(b){return a+=f.isSome(b)?b.node.memory:0});this._nodeId2MetaReloading.forEach(function(b){return a+=
f.isSome(b)?b.node.memory:0});return a};c.prototype.getUnloadedMemory=function(){return(this._controller?this._controller.unloadedMemoryEstimate:0)+(f.isSome(this._labeler)?this._labeler.unloadedMemoryEstimate:0)};c.prototype.ignoresMemoryFactor=function(){return!1};c.prototype._labelingChanged=function(){var a=this;if(!ta.areLabelsVisible(this.i3slayer)||!this._supportsLabeling)f.isSome(this._labeler)&&(this._labeler.destroy(),this._labeler=null);else if(!f.isSome(this._labeler)){var b=new ya.default({view:this.view,
layer:this.i3slayer,collection:this._collection});this._nodeId2Meta.forEach(function(d){return f.isSome(d)&&a._addMetaToLabeler(b,d)});this._labeler=b}};c.prototype._loadAsyncModule=function(a){var b=this;++this._asyncModuleLoading;return a.then(function(a){--b._asyncModuleLoading;return a},function(a){--b._asyncModuleLoading;throw a;})};c.prototype._modificationsChanged=function(){var a=this;if(f.isNone(this._i3sModule)&&this._hasModifications)this._i3sModule=this._loadAsyncModule((new Promise(function(a,
b){P(["./SceneLayerWorker"],a,b)})).then(function(b){return b.ensureWASM().then(function(){a._i3sModule=b;a._modificationsChanged()})}));else if(!(f.isNone(this._i3sModule)||this._i3sModule instanceof Promise)){var b=this.i3slayer.uid,d=this.i3slayer.spatialReference;this._worker.setModifications(b,this._modifications,d);var e=Z.toWasmModification(this._modifications,d);this._i3sModule.setModificationsSync({context:b,modifications:e,isGeodetic:d.isGeographic});this._controller.modificationsChanged();
var c=this._hasModifications?new ma:null;this._nodeId2Meta.forEach(function(b,d){f.isNone(b)?a._nodeId2Meta.delete(d):b.node.hasModifications?(a._nodeId2Meta.delete(d),a._nodeId2MetaReloading.set(d,b)):f.isSome(c)&&c.push(b.node)});f.isSome(c)&&this._nodeId2MetaReloading.forEach(function(a){return c.push(a.node)});f.isSome(c)&&0<c.length&&(this.updateNodeModificationStatus(c),c.forEachSimple(function(b){if(2!==b.imModificationImpact){var d=a._nodeId2Meta.get(b.index);a._controller.invalidateGeometryVisibility(b.index);
a._nodeId2Meta.delete(b.index);f.isSome(d)&&a._nodeId2MetaReloading.set(b.index,d)}}));this._memCache.clear();this._controller.restartNodeLoading();this._showModifications()}};c.prototype._showModifications=function(){f.isSome(this._modificationGraphics)&&(this.view.graphics.removeMany(this._modificationGraphics),this._modificationGraphics=null);if(H.I3S_SHOW_MODIFICATIONS&&0!==this._modifications.length){var a={clip:[227,227,79,.8],mask:[227,139,79,.8],replace:[139,227,79,.8]},b={type:"simple-fill",
outline:{color:[255,255,255],width:1}};this._modificationGraphics=[];for(var d=0,e=this._modifications;d<e.length;d++){var c=e[d];c.geometry.spatialReference=this.i3slayer.spatialReference;var n=g.__assign(g.__assign({},b),{color:a[c.type]});this._modificationGraphics.push(new K({geometry:c.geometry,symbol:n}))}this.view.graphics.addMany(this._modificationGraphics)}};c.prototype._addMetaToLabeler=function(a,b){var d=this;a.addNodeMeta(b,function(a,b){return d._createAttributes(a,b)})};c.prototype._suspendedChange=
function(a){a?(this._removeAllNodeDataFromStage(),this.view.elevationProvider&&this.view.elevationProvider.unregister(this._elevationProvider),this._stage.sceneIntersectionHelper.removeIntersectionHandler(this._intersectionHandler)):(this.view.elevationProvider.register(this._elevationContext,this._elevationProvider),this._stage.sceneIntersectionHelper.addIntersectionHandler(this._intersectionHandler))};c.prototype.getLoadedAttributes=function(a){a=this._nodeId2Meta.get(a);if(f.isSome(a)&&f.isSome(a.attributeInfo))return a.attributeInfo.loadedAttributes};
c.prototype.getAttributeData=function(a){a=this._nodeId2Meta.get(a);if(f.isSome(a)&&f.isSome(a.attributeInfo))return a.attributeInfo.attributeData};c.prototype.setAttributeData=function(a,b){var d=this;a=this._nodeId2Meta.get(a);f.isSome(a)&&(a.attributeInfo=b,a.cachedRendererVersion=this._getInvalidRendererVersion(),a.filteredIds=null,f.isSome(this._labeler)&&this._labeler.setNodeMetaAttributes(a,function(a,b){return d._createAttributes(a,b)}),this._updateEngineObject(a))};c.prototype.getVisibleNodes=
function(){var a=[];this._nodeId2Meta.forEach(function(b){return f.isSome(b)&&a.push(b.node)});return a};c.prototype.getLoadedNodeIndices=function(a){this._nodeId2Meta.forEach(function(b,d){return a.push(d)});this._nodeId2MetaReloading.forEach(function(b,d){return a.push(d)})};c.prototype._createTexture=function(a,b,d,e){if(f.isNone(d)||null==d.data)return null;var c=d.data,n=b.wrapTextures;b=d.usage&1?"opaque"===b.alphaMode?3:4:3;var C=!0,q;d.encoding===k.DDS_ENCODING_STRING?q=ba.DDS_ENCODING:C=
L.isPowerOfTwo(c.width)&&L.isPowerOfTwo(c.height);C=(e?this._enableAtlasMipMaps:this._enableMipMaps)&&C;d=new ba(c,a.id+"/"+d.id,{mipmap:C,wrap:e||!n?{s:33071,t:33071}:{s:10497,t:10497},disableAnisotropy:e&&C&&this._disableAtlasAnisotropy,encoding:q,noUnpackFlip:!0,components:b});this._stage.add(4,d);a.memory+=this.memEstimateTextureAdded(d);return d};c.prototype._getVertexBufferLayout=function(a,b){a={hasTexture:ca(a.params.material),hasNormals:b.normal,hasRegions:b.uvRegion};return Ia.glLayout(Ja.createVertexBufferLayout(this._getGeometryParameters(a)))};
c.prototype._getObjectIdField=function(){return this.i3slayer.objectIdField||"OBJECTID"};c.prototype._findGraphicNodeAndIndex=function(a){var b=N.attributeLookup(a.attributes,this._getObjectIdField()),d=null;Q.someMap(this._nodeId2Meta,function(a){if(f.isNone(a))return!1;var c=a.featureIds.indexOf(b);if(-1===c)return!1;d={node:a.node,index:c};return!0});return d};c.prototype._getGraphicIndices=function(a,b){a=this._nodeId2Meta.get(a.index);if(f.isNone(a))return[];for(var d=[],c=this._getObjectIdField(),
h=0;h<b.length;h++){var n=N.attributeLookup(b[h].attributes,c),n=a.featureIds.indexOf(n);-1!==n&&d.push(n)}return d};c.prototype.whenGraphicBounds=function(a){a=this._findGraphicNodeAndIndex(a);if(!a)return r.reject();var b=this._nodeId2Meta.get(a.node.index);if(f.isNone(b))return r.reject();a=Da.boundingBoxCornerPoints(a.index,this._collection,b.objectHandle,new Float64Array(24));if(F.bufferToBuffer(a,this.view.renderSpatialReference,0,a,this.view.spatialReference,0,8))return b=E.empty(),E.expandWithBuffer(b,
a,0,8),r.resolve({boundingBox:b,screenSpaceObjects:[]})};c.prototype.whenGraphicAttributes=function(a,b){var d=this;return k.whenGraphicAttributes(this.i3slayer,a,this._getObjectIdField(),b,function(a){for(var b=new Map,c=[],e=0;e<a.length;e++){var f=a[e],g=d._findGraphicNodeAndIndex(f),m=b.get(g.node);m||(m={node:g.node,indices:[],graphics:[]},c.push(m),b.set(g.node,m));m.indices.push(g.index);m.graphics.push(f)}return c},{populateObjectId:!0})};c.prototype.getGraphicFromIntersectorMetadata=function(a){if(null==
a.nodeIndex||null==a.componentIndex)return null;var b=this._nodeId2Meta.get(a.nodeIndex);return f.isNone(b)||null==b.featureIds||a.componentIndex>=b.featureIds.length?null:this._createGraphic(a.componentIndex,b)};c.prototype._getCacheKey=function(a){return this._layerUrl+"/v16/"+a.id+this._cacheKeySuffix};c.prototype._getMemCacheKey=function(a,b){void 0===b&&(b=this.elevationOffset);return a+"#"+b};Object.defineProperty(c.prototype,"_idbCacheEnabled",{get:function(){return!this._controller.disableIDBCache&&
0===this._modifications.length&&0===this.elevationOffset&&null!=this._cacheKeySuffix},enumerable:!1,configurable:!0});c.prototype.loadCachedGPUData=function(a){return this._memCache.pop(this._getMemCacheKey(a.index))};c.prototype._cacheGPUData=function(a,b){void 0===b&&(b=this.elevationOffset);var d=this._controller.indexDepth-a.node.level+1;this._memCache.put(this._getMemCacheKey(a.node.index,b),a,a.node.memory,d)};c.prototype.loadMissingTextures=function(a,b,d,c){var e=this,n=a.filter(function(a,
d){if(0===(a.usage&e.rendererTextureUsage))return!1;if(f.isNone(b))return!0;a=k.selectEncoding(a.encodings,e.useCompressedTextures);d=b[d];return f.isNone(d)||null==d.data||a&&d.encoding!==a.encoding?!0:!1});return 0===n.length?r.resolve(!1):d(n,c).then(function(d){for(var c=0,e=0;e<a.length;e++)c<d.length&&d[c].id===a[e].id&&(b[e]=d[c],c++);return!0})};c.prototype.loadCachedNodeData=function(a,b,d){var c=this;return this._idbCacheEnabled?this._idbCache.get(this._getCacheKey(a),b).then(function(e){if(null==
e)return null;if(e.nodeVersion!==a.version)return c._idbCache.remove(c._getCacheKey(a)),null;a.geometryObb=e.geometryObb;return c.loadMissingTextures(e.requiredTextures,e.textureData,d,b).then(function(d){d&&c._idbCache.initialized&&f.isSome(e.textureData)&&(e.byteSize=ea(e.transformedGeometry,e.textureData),e.textureData.every(da)&&fa(a,e)&&c._idbCache.put(c._getCacheKey(a),e).catch(function(b){return D.warn("Failed to update node with textures in IndexedDB cache: "+a.id+": "+b)}));r.throwIfAborted(b);
return e})}):r.resolve(null)};c.prototype.addNode=function(a,b,d){var c=this;return"geometryData"in b?this._addData(a,b.attributeDataInfo,function(){return c._transformNode(a,b,d).then(function(e){return c._safeReschedule(d,function(){if(f.isNone(e))return a.hasModifications=!1,c._addCachedNodeData(a,null,d);a.hasModifications=e.transformedGeometry.hasModifications;var h=e.obb,C=e.componentOffsets,q=e.featureIds,t=e.transformedGeometry,m=M.computeGlobalTransformation(a.mbs,c.elevationOffset,c._controller.crsIndex,
c.view.renderSpatialReference);a.geometryObb=O.create([h.center.x,h.center.y,h.center.z],[h.extents.x,h.extents.y,h.extents.z],[h.orientation.x,h.orientation.y,h.orientation.z,h.orientation.w]);V.vec3.transformMat4(a.geometryObb.center,a.geometryObb.center,m);b.geometryData.componentOffsets=C;q&&(b.geometryData.featureIds=Array.prototype.slice.call(q));h={nodeVersion:a.version,geometryData:b.geometryData,requiredTextures:b.requiredTextures,textureData:b.textureData,transformedGeometry:t,globalTrafo:m,
geometryObb:a.geometryObb,byteSize:ea(t,b.textureData)};c._idbCacheEnabled&&c._idbCache.initialized&&fa(a,h)&&(C=f.isSome(h.textureData)?h.textureData.map(function(a){return da(a)?a:null}):null,c._idbCache.put(c._getCacheKey(a),g.__assign(g.__assign({},h),{textureData:C})).catch(function(b){return D.warn("Failed to store node in IndexedDB cache: "+a.id+": "+b)}));return c._addCachedNodeData(a,h,d)})})}):r.reject()};c.prototype.computeVisibilityObb=function(a){return k.computeVisibilityObb(a,this.view.renderSpatialReference,
this._controller.crsIndex,this.i3slayer.spatialReference,this.elevationOffset,this._modifications)};c.prototype._transformNode=function(a,b,d){for(var c=b.geometryData.geometries,h=Array(c.length),n=0;n<c.length;++n)h[n]=this._getVertexBufferLayout(c[n],b.geometryDescriptor);var c=a.mbs,n=this.elevationOffset,g=this._controller.crsIndex,q=this._controller.crsVertex,t=this.view.renderSpatialReference,m=M.getLocalOrigin(c,n,g),k=M.computeGlobalTransformation(c,n,g,t),g=F.getProjectorName(g,q),q=F.getProjectorName(q,
t);return f.isNone(g)||f.isNone(q)?r.resolve(null):this._worker.invoke({context:this.i3slayer.uid,geometryBuffer:b.geometryBuffer,geometryData:b.geometryData,geometryDescriptor:b.geometryDescriptor,layouts:h,localOrigin:m,globalTrafo:k,mbs:c,obb:a.serviceObb,elevationOffset:n,needNormals:!this._isIntegratedMesh&&this._controller.isMeshPyramid,normalReferenceFrame:this.i3slayer.normalReferenceFrame||"none",indexToVertexProjector:g,vertexToRenderProjector:q},d)};c.prototype.isFadingEnabled=function(){return 0<
this.lodCrossfadeDuration};c.prototype._setNewNodeOpacity=function(a,b){var d=this.isFadingEnabled();this.setNodeOpacity(b,d?0:this.fullOpacity);d?this._crossfadeHelper.fadeNodeInternal(a,b,0):this._crossfadeHelper.stopNodeFadingInternal(b)};c.prototype.addCachedGPUData=function(a,b,d){a.geometryObb=O.clone(this._collection.getComponentObb(b.objectHandle));this._controller.isGeometryVisible(a)?(f.isSome(this._labeler)&&this._addMetaToLabeler(this._labeler,b),a=a.index,this._addNodeMeta(a,b),this.updateNodeState(a,
d),this._collection.setObjectVisibility(b.objectHandle,!0),this._updateMaterial(b),this._setNewNodeOpacity(a,b),this._updateEngineObject(b),this._highlights.objectCreated(b),this._treeDebugger&&this._treeDebugger.update()):this._cacheGPUData(b)};c.prototype.addCachedNodeData=function(a,b,d,c){var e=this;return this._addData(a,d,function(){return e._addCachedNodeData(a,b,c)})};c.prototype._addCachedNodeData=function(a,b,d){var c=this;if(this.suspended||!this._controller.isGeometryVisible(a))return this._removeNodeStageData(a.index,
this.elevationOffset,this._nodeId2MetaReloading),r.resolve();if(f.isNone(b))return this._addNodeMeta(a.index,null),r.resolve();var h=b.geometryData,n=b.transformedGeometry,g=b.globalTrafo,q=f.isSome(b.textureData)?b.textureData.filter(function(a){return f.isSome(a)&&0!==(a.usage&c.rendererTextureUsage)}):null;a.memory=0;var t=h.componentOffsets,m=h.geometries,h=h.featureIds,k=null,w=null;if(this._hasSymbolColors)for(var k=this._componentColorManager.getBuffer(h.length),w=new Uint16Array(h.length),
l=0;l<h.length;l++)w[l]=k.acquireIndex();var A=this._collection,m=m[0],k=n.layout,w=n.indices,l=n.interleavedVertexData,z=n.positionData,n=n.hasColors,p=this._materialParameters(m,k),t=t||new Uint32Array([0,w?w.length:l.byteLength/k[0].stride]),t={vertices:{data:l,count:l.byteLength/k[0].stride,layoutParameters:p.geometryParams},positionData:{positions:z.data,indices:z.indices},indices:w,primitiveType:4,componentOffsets:t},k=m.transformation?U.mat4f64.clone(m.transformation):U.mat4f64.create();T.mat4.multiply(k,
g,k);var g=T.mat4.getTranslation(W.vec3f64.create(),k),k=pa.mat3.fromMat4(qa.mat3f32.create(),k),w=this.view.renderSpatialReference,l=this.view.basemapTerrain.spatialReference,z=W.vec3f64.create(),u=[1,1,1];F.localLinearScaleFactors(g,w,u,l);F.vectorToVector(g,w,z,l);var B=A.createObject({toMapSpace:[z[0],z[1],u[0],u[1]],geometry:t,obb:f.unwrap(a.geometryObb),transform:{position:g,rotationScale:k},visible:!1}),g={isSchematic:m.params.material.isSchematic,isOpaque:"blend"!==m.params.material.alphaMode&&
1<=m.params.material.metallicRoughness.baseColorFactor[3]},t=f.isSome(q)?q.map(function(b){return c._createTexture(a,p.material,b,2===p.geometryParams.textureCoordinates)}):[];this._configureMaterial(B,m.params.material,t,q);a.memory+=this.memEstimateGeometryAdded(B);var x=this._addTasks.get(a.index),y=new Oa(a,h,B,this._getInvalidRendererVersion(),x.attributeInfo,g,t);x.meta=y;!this._hasTextures&&b.requiredTextures.some(function(a){return 0!==(a.usage&19)})&&(this._hasTextures=!0);this._hasData=
!0;this._hasColors=this._hasColors||n;this._hasTextures=this._hasTextures||!!a.resources.texture;this.notifyChange("hasTexturesOrVertexColors");var v=this.slicePlaneEnabled;return this._addOrUpdateEdgeRendering(y).then(function(b){b&&c._edgeView.updateObjectVisibility(y.objectHandle,!1);return c._safeReschedule(d,function(){var d=c._addTasks.get(a.index);if(d)if(f.isSome(c._labeler)&&c._addMetaToLabeler(c._labeler,y),c._addNodeMeta(a.index,y),d.meta=null,c.suspended)c._removeNodeStageData(a.index,
c.elevationOffset);else{A.setObjectVisibility(B,!0);b&&c._edgeView.updateObjectVisibility(y.objectHandle,!0);y.attributeInfo=d.attributeInfo;var d=y.cachedRendererVersion!==c._rendererVersion,e=v!==c.slicePlaneEnabled;c._setObjectSymbolColors(y);var h=c._applyFiltersToNode(y);(d||b&&(e||h))&&c._addOrUpdateEdgeRendering(y);c.visibleGeometryChanged(y);c._highlights.objectCreated(y);c._updateMaterial(y);c._setNewNodeOpacity(a.index,y);c._treeDebugger&&c._treeDebugger.update()}})}).catch(function(a){f.isSome(x.meta)&&
(c._deleteComponentObject(x.meta),x.meta=null);throw a;})};c.prototype._addNodeMeta=function(a,b){this._removeNodeStageData(a,this.elevationOffset,this._nodeId2MetaReloading);if(this._nodeId2Meta.has(a)){D.error("Removing duplicated node");var c=this._nodeId2Meta.get(a);f.isSome(c)&&this._deleteComponentObject(c)}this._nodeId2Meta.set(a,b)};c.prototype._safeReschedule=function(a,b){r.throwIfAborted(a);return this._controller.reschedule(a,b)};c.prototype._materialParameters=function(a,b){a=a.params.material;
var c=b.some(function(a){return"uvRegion"===a.name});b=b.some(function(a){return"normalCompressed"===a.name});var e=ca(a);return{geometryParams:this._getGeometryParameters({hasTexture:e,hasNormals:b,hasRegions:c}),material:a}};c.prototype._configureMaterial=function(a,b,c,e){var d=this,g=this.rendererTextureUsage,k=function(a){a:{a&=g;if(!f.isNone(e)&&0!==a)for(var b=0;b<e.length;b++){var d=e[b];if(f.isSome(d)&&0!==(d.usage&a)){a=c[b].id;break a}}a=null}return a};this._collection.updateMaterial(a,
function(a){var c=b.metallicRoughness.baseColorFactor,e=L.clamp(b.metallicRoughness.baseColorFactor[3],0,1);a.baseColor=[c[0],c[1],c[2],e];a.mrrFactors=[b.metallicRoughness.metallicFactor,b.metallicRoughness.roughnessFactor,b.isSchematic?.2:.5];a.emissiveFactor=b.emissiveFactor;a.usePBR=d._usePBR(b.isSchematic);a.isIntegratedMesh=d._isIntegratedMesh;a.alphaCutoff="mask"===b.alphaMode?b.alphaCutoff:Ka.defaultMaskAlphaCutoff;a.alphaDiscardMode="opaque"===b.alphaMode?1:"mask"===b.alphaMode?2:3;c=d._stage.renderView.textureRepository;
if(e=k(33))a.baseColorTexture=new I.RenderTexture(c,e);if(e=k(2))a.metallicRoughnessTexture=new I.RenderTexture(c,e);if(e=k(16))a.emissionTexture=new I.RenderTexture(c,e);if(e=k(8))a.occlusionTexture=new I.RenderTexture(c,e);if(e=k(4))a.normalTexture=new I.RenderTexture(c,e);a.commonMaterialParameters.slicePlaneEnabled=d.slicePlaneEnabled;a.commonMaterialParameters.doubleSided=b.doubleSided;a.commonMaterialParameters.cullFace=b.cullFace;d._updateMaterialOverlay(a)})};c.prototype._getGeometryParameters=
function(a){return{textureCoordinates:a.hasTexture?a.hasRegions?2:1:0,colors:this._hasVertexColors,normals:a.hasNormals&&!this._isIntegratedMesh}};c.prototype._addData=function(a,b,c){var d=this,h=this._addTasks.get(a.index);h?h.attributeInfo=b:(h=g.__assign(g.__assign({},r.createResolver()),{attributeInfo:b,meta:null}),this._addTasks.set(a.index,h),c().then(h.resolve,h.reject).then(function(){return d._addTasks.delete(a.index)}).catch(function(b){d._addTasks.delete(a.index);throw b;}));return h.promise};
c.prototype._clearAddTasks=function(){var a=this;this._addTasks.forEach(function(b){f.isSome(b.meta)&&(a._deleteComponentObject(b.meta),b.meta=null)});this._addTasks.clear()};c.prototype._clippingAreaChanged=function(){var a=E.create();Ha.projectToBoundingBox(this.view.clippingArea,a,this.view.renderSpatialReference)?this._clippingArea=a:this._clippingArea=null;this._filterChange();this._controller&&this._controller.updateClippingArea(this.view.clippingArea)};c.prototype._filterChange=function(){this._applyFilters(!1)};
c.prototype._applyFilters=function(a){var b=this;this._filters=this.getFilters();a?this._controller&&this._controller.requestUpdate():this._nodeId2Meta.forEach(function(a){f.isSome(a)&&b._applyFiltersToNode(a)&&(b._addOrUpdateEdgeRendering(a),b.visibleGeometryChanged(a))})};c.prototype.getFilters=function(){var a=this,b=[];this._clippingArea&&b.push(function(b,c){return a._boundingboxFilter(b,c,a._clippingArea)});return b};c.prototype.addSqlFilter=function(a,b,c,e){var d=this;b&&c&&a.push(function(a,
h){return d._sqlFilter(a,h,b,c,e)})};c.prototype._sqlFilter=function(a,b,c,e,h){var d={},g=this._createLayerGraphic(d),q=this.i3slayer.objectIdField,l=b.featureIds,m=f.isSome(b.attributeInfo)&&b.attributeInfo.attributeData;e.every(function(a){return null!=m[a]||a===q})&&k.filterInPlace(a,l,function(a){d[q]=l[a];for(var b=0;b<e.length;b++){var f=e[b];f!==q&&(d[f]=k.getCachedAttributeValue(m[f],a))}try{if(Array.isArray(c)){for(a=0;a<c.length;a++)if(c[a].testFeature(g))return!0;return!1}return c.testFeature(g)}catch(A){return h(A),
!1}})};c.prototype._boundingboxNodeTest=function(a,b){F.mbsToMbs(a.node.mbs,this._controller.crsIndex,ha,this.view.renderSpatialReference);return k.intersectBoundingBoxWithMbs(b,ha)};c.prototype._boundingboxFeatureTest=function(a,b,c){return E.intersects(c,this._collection.getComponentAabb(a.objectHandle,b,Pa))};c.prototype._boundingboxFilter=function(a,b,c){var d=this,h=this._collection,f=this._boundingboxNodeTest(b,c);if(3!==f)if(0===f)a.length=0;else if(h=h.getComponentCount(b.objectHandle),h.invisible+
h.visible===b.featureIds.length){var g=this._transformAABB(Qa,c,b.objectHandle);k.filterInPlace(a,b.featureIds,function(a){return d._boundingboxFeatureTest(b,a,g)})}};c.prototype._transformAABB=function(a,b,c){var d=this._collection.getObjectTransform(c);c=d.position;d=d.rotationScale;a[0]=(b[0]-c[0])/d[0];a[1]=(b[1]-c[1])/d[4];a[2]=(b[2]-c[2])/d[8];a[3]=(b[3]-c[0])/d[0];a[4]=(b[4]-c[1])/d[4];a[5]=(b[5]-c[2])/d[8];return a};c.prototype._addOrUpdateEdgeRendering=function(a,b){void 0===b&&(b=!0);if(!this._edgeView)return r.resolve(!1);
var c=a.objectHandle,e=this._edgeView.hasObject(c);a=this._getFilteredEdgeMaterials(a);var h=a.perFeatureEdgeMaterials,f={slicePlaneEnabled:this.slicePlaneEnabled};if(a.hasEdges)return e?(this._edgeView.updateAllComponentMaterials(c,h,f,b),this._edgeView.updateObjectVisibility(c,!0),r.resolve(!0)):this._collection.addEdges(c,this._edgeView,h,f).then(function(){return!0});e&&this._edgeView.removeObject(c);return r.resolve(!1)};c.prototype._removeEdgeRendering=function(a){this._edgeView&&this._edgeView.hasObject(a.objectHandle)&&
this._edgeView.removeObject(a.objectHandle)};c.prototype._applyFiltersToNode=function(a){return this._applyFiltersToNodeComponents(a)?(f.isSome(this._labeler)&&this._labeler.applyFilterChange(a),!0):!1};c.prototype._applyFiltersToNodeComponents=function(a){var b=this._collection,c=0===b.getComponentCount(a.objectHandle).invisible;b.setAllComponentVisibilities(a.objectHandle,"all");if(0===this._filters.length)return a.filteredIds=null,!c;this._updateCachedFilteredIds(a);if(a.filteredIds===a.featureIds)return!c;
c=this._computeFilteredComponentIndices(a);b.setAllComponentVisibilities(a.objectHandle,c);return!0};c.prototype._updateCachedFilteredIds=function(a){if(null==a.filteredIds||a.appliedFilters!==this._filters)a.filteredIds=this._computeFilteredIds(a),a.appliedFilters=this._filters};c.prototype._computeFilteredIds=function(a){for(var b=a.featureIds.slice(),c=0,e=this._filters;c<e.length&&((0,e[c])(b,a),0!==b.length);c++);return b.length===a.featureIds.length?a.featureIds:b};c.prototype._computeFilteredComponentIndices=
function(a){var b=[];a.featureIds.forEach(function(c,e){a.filteredIds[b.length]===c&&b.push(e)});return b};c.prototype._removeAllNodeDataFromStage=function(a){var b=this;void 0===a&&(a=this.elevationOffset);this._nodeId2Meta.forEach(function(c,e){return b._removeNodeStageData(e,a)});this._nodeId2MetaReloading.forEach(function(c,e){return b._removeNodeStageData(e,a,b._nodeId2MetaReloading)})};c.prototype.removeNode=function(a){var b=this.elevationOffset;this._removeNodeStageData(a,b);this._removeNodeStageData(a,
b,this._nodeId2MetaReloading)};c.prototype._removeNodeStageData=function(a,b,c){void 0===c&&(c=this._nodeId2Meta);var d=c.get(a);f.isNone(d)?c.delete(a):(this._collection.setObjectVisibility(d.objectHandle,!1),this.visibleGeometryChanged(d),this._removeEdgeRendering(d),f.isSome(this._labeler)&&this._labeler.removeNodeMeta(d),c.delete(a),this._highlights.objectDeleted(d),c===this._nodeId2Meta?this._cacheGPUData(d,b):this._deleteComponentObject(d),this._treeDebugger&&this._treeDebugger.update())};c.prototype._deleteComponentObject=
function(a){this._edgeView&&this._edgeView.removeObject(a.objectHandle);this.memEstimateGeometryRemoved(a.objectHandle);this._collection.destroyObject(a.objectHandle);if(a.textures){var b=0;for(a=a.textures;b<a.length;b++){var c=a[b];this.memEstimateTextureRemoved(c);this._stage.remove(4,c.id)}}};c.prototype.updateNodeState=function(a,b){a=this._nodeId2Meta.get(a);f.isSome(a)&&this._collection.updateMaterial(a.objectHandle,function(a){return a.polygonOffsetEnabled=0===b})};c.prototype._invalidateAllSymbols=
function(){this._rendererVersion=k.addWraparound(this._rendererVersion,1);this._controller&&this._controller.requestUpdate()};c.prototype._getInvalidRendererVersion=function(){return k.addWraparound(this._rendererVersion,-1)};c.prototype._rendererChange=function(a){return g.__awaiter(this,void 0,void 0,function(){var b,c,e,h,f,l,q,t,m,r;return g.__generator(this,function(d){switch(d.label){case 0:this._currentRenderer=a;this.notifyChange("rendererTextureUsage");this._rendererVersion=k.addWraparound(this._rendererVersion,
1);this._opacityVariable=this._colorVariable=this._rendererFields=null;this._invalidateAllSymbols();if(!a)return[3,2];b=this;c=X.fixFields;e=[this.i3slayer.fields];return[4,a.getRequiredFields(this.i3slayer.fields)];case 1:b._rendererFields=c.apply(void 0,e.concat([d.sent()])),d.label=2;case 2:this._updateSymbologyFields();if(!(!this._arcade&&a&&"arcadeRequired"in a&&a.arcadeRequired))return[3,4];h=this;return[4,va.loadArcade()];case 3:h._arcade=d.sent(),d.label=4;case 4:if(a&&"visualVariables"in
a&&a.visualVariables)for(f=0,l=a.visualVariables;f<l.length;f++)q=l[f],"color"===q.type?this._colorVariable=q:"opacity"===q.type?this._opacityVariable=q:D.warn("Unsupported visual variable type for 3D Object Scene Services: "+q.type);if(a)for(t=0,m=a.getSymbols();t<m.length;t++)r=m[t],"mesh-3d"!==r.type&&D.error("Symbols of type '"+r.type+"' are not supported for 3D Object Scene Services.");this._controller&&this._controller.requestUpdate();return[2]}})})};c.prototype._getCachedEdgeMaterials=function(a){this._hasSymbolColors&&
a.cachedRendererVersion!==this._rendererVersion&&this._updateCachedRendererData(a);return a.cachedEdgeMaterials};c.prototype._getSymbolColors=function(a){this._hasSymbolColors&&a.cachedRendererVersion!==this._rendererVersion&&this._updateCachedRendererData(a);var b=a.cachedSymbology;return function(a,c){a*=5;ra.vec4.set(c.externalColor,b[a+0]/255,b[a+1]/255,b[a+2]/255,b[a+3]/255);c.externalColorMixMode=b[a+4]&15;c.castShadows=0!==(b[a+4]&16);c.pickable=0!==(b[a+4]&32)}};c.prototype._getSymbolInfo=
function(a,b){b=a&&a.getSymbol(b,{arcade:this._arcade});if(!(b instanceof wa))return null;a=b.id;if(this._symbolInfos.has(a))return this._symbolInfos.get(a);b=k.getSymbolInfo(b);this._symbolInfos.set(a,b);return b};c.prototype._setSymbologyOverride=function(a,b){this._symbologyOverride!==a&&(this._symbologyOverride=a,this._symbologyOverrideFields=b,this._invalidateAllSymbols(),this._updateSymbologyFields())};c.prototype._updateSymbologyFields=function(){this._symbologyFields=f.isSome(this._symbologyOverrideFields)&&
0<this._symbologyOverrideFields.length?f.isSome(this._rendererFields)&&0<this._rendererFields.length?X.fixFields(this.i3slayer.fields,g.__spreadArrays(this._rendererFields,this._symbologyOverrideFields)):this._symbologyOverrideFields:this._rendererFields};c.prototype._updateCachedRendererData=function(a){a.cachedRendererVersion=this._rendererVersion;if(this._hasSymbolColors){var b=this._tmpAttributeOnlyGraphic,c={};b.attributes=c;var e=this._currentRenderer,h=f.isSome(a.attributeInfo)&&a.attributeInfo.attributeData,
n=null!=a.featureIds?this.i3slayer.objectIdField:null,l=null!=h&&f.isSome(this._symbologyFields)&&0<this._symbologyFields.length,q=l?[]:null,t=l?[]:null;if(l&&f.isSome(this._symbologyFields))for(var m=0,r=this._symbologyFields;m<r.length;m++){var w=r[m],v=h[w];v&&(q.push(w),t.push(v))}a.cachedSymbology||(a.cachedSymbology=new Uint8Array(5*a.featureIds.length));for(var h={color:J,castShadows:!0,pickable:!0,colorMixMode:1,edgeMaterial:null},m=this.fullOpacity,r=null,w=2,v=k.transparentEdgeMaterial,
A=0,z=0;z<a.featureIds.length;z++){null!=n&&(c[n]=a.featureIds[z]);if(l)for(var p=0;p<q.length;p++)c[q[p]]=k.getCachedAttributeValue(t[p],z);var u=this._getSymbolInfo(e,b),B=p=null;if(e&&"visualVariables"in e){if(this._colorVariable){var x=Y.getColor(this._colorVariable,b,{color:Ra,arcade:this._arcade});x&&(p=J,p[0]=x.r/255,p[1]=x.g/255,p[2]=x.b/255,this._opacityVariable||null===x.a||(B=x.a))}this._opacityVariable&&(B=Y.getOpacity(this._opacityVariable,b,{arcade:this._arcade}))}u&&u.material&&(x=
u.material,p=f.isNone(p)||f.isNone(B)?aa.overrideColor(p,B,x.color,x.alpha,ga,J):aa.overrideColor(p,B,null,null,ga,J));f.isNone(p)&&(p=J,p[0]=1,p[1]=1,p[2]=1,p[3]=1);h.pickable=!0;h.castShadows=u?u.castShadows:!0;h.colorMixMode=u&&u.material?u.material.colorMixMode:1;h.edgeMaterial=u?u.edgeMaterial:null;f.isSome(this._symbologyOverride)&&(h.color=p,this._symbologyOverride(b,h),p=h.color);if(f.isSome(h.edgeMaterial)){u=0>=p[3]?0:1<=p[3]&&(a.material.isOpaque||3===h.colorMixMode)?2:1;if(h.edgeMaterial!==
r||u!==w)v=g.__assign(g.__assign({},h.edgeMaterial),{opacity:m,objectTransparency:u}),r=h.edgeMaterial,w=u;a.cachedEdgeMaterials[z]=v}else a.cachedEdgeMaterials[z]=k.transparentEdgeMaterial;a.cachedSymbology[A+0]=Math.round(255*p[0]);a.cachedSymbology[A+1]=Math.round(255*p[1]);a.cachedSymbology[A+2]=Math.round(255*p[2]);a.cachedSymbology[A+3]=Math.round(255*p[3]);a.cachedSymbology[A+4]=h.colorMixMode|+h.castShadows<<4|+h.pickable<<5;A+=5}}};c.prototype._getFilteredEdgeMaterials=function(a){var b=
this,c=this._getCachedEdgeMaterials(a);c.forEach(function(a){return a.opacity=b.fullOpacity});if(f.isNone(a.filteredIds))return{hasEdges:c.some(function(a){return a!==k.transparentEdgeMaterial}),perFeatureEdgeMaterials:c};var e=0,h=!1,c=c.map(function(b,c){if(a.featureIds[c]!==a.filteredIds[e])return k.transparentEdgeMaterial;h=h||b!==k.transparentEdgeMaterial;e++;return b});return{hasEdges:h,perFeatureEdgeMaterials:c}};c.prototype._setObjectSymbolColors=function(a){if(this._hasSymbolColors){var b=
a.objectHandle;a=this._getSymbolColors(a);this._collection.setComponentData(b,a);this._stage.renderView.setNeedsRender()}};c.prototype._reloadAll=function(a){void 0===a&&(a=this.elevationOffset);this._removeAllNodeDataFromStage(a);null!=this._controller&&this._controller.restartNodeLoading()};c.prototype._opacityChange=function(a){var b=this;this._crossfadeHelper.stopAllNodeFading();this._nodeId2Meta.forEach(function(c){f.isNone(c)||(b._collection.updateMaterial(c.objectHandle,function(b){return b.objectOpacity=
a}),c.cachedEdgeMaterials.forEach(function(b){return b.opacity=a}),b._updateEdgeRendering(c))})};c.prototype._updateMaterial=function(a){var b=this;this._collection.updateMaterial(a.objectHandle,function(c){c.commonMaterialParameters.slicePlaneEnabled=b.slicePlaneEnabled;c.usePBR=b._usePBR(a.material.isSchematic);b._updateMaterialOverlay(c)})};c.prototype._updateMaterialOverlay=function(a){};c.prototype._updateEngineObject=function(a){this._setObjectSymbolColors(a);this._applyFiltersToNode(a);this._addOrUpdateEdgeRendering(a);
this.visibleGeometryChanged(a)};c.prototype._slicePlaneEnabledChange=function(a){var b=this;this._intersectionHandler&&(this._intersectionHandler.slicePlane=a);f.isSome(this._labeler)&&(this._labeler.slicePlaneEnabled=a);this._nodeId2Meta.forEach(function(c){f.isNone(c)||(b._collection.updateMaterial(c.objectHandle,function(b){b.commonMaterialParameters.slicePlaneEnabled=a}),b._updateEdgeRendering(c,!1))})};c.prototype._updatePBR=function(){var a=this;this._nodeId2Meta.forEach(function(b){f.isNone(b)||
a._collection.updateMaterial(b.objectHandle,function(c){c.usePBR=a._usePBR(b.material.isSchematic)})})};c.prototype._usePBR=function(a){return!this._isIntegratedMesh&&(a?this.view.qualitySettings.physicallyBasedRenderingEnabled:!0)};c.prototype._updateEdgeRendering=function(a,b){void 0===b&&(b=!0);this._edgeView&&this._edgeView.hasObject(a.objectHandle)&&this._addOrUpdateEdgeRendering(a,b)};c.prototype._forAllNodes=function(a){this._nodeId2Meta.forEach(a)};c.prototype._forAllFeatures=function(a,b,
c){var d=this;void 0===c&&(c=0);Q.someMap(this._nodeId2Meta,function(e){if(f.isNone(e))return!1;if(f.isSome(b))switch(b(e)){case 0:return!0;case 2:return!1}var h=1;switch(c){case 1:h=d._forAllFeaturesOfNode(e,a);break;case 0:h=d._forVisibleFeaturesOfNode(e,a);break;case 2:h=d._forAllFeaturesOfNodeInClippingArea(e,a)}return 0===h})};c.prototype._forAllFeaturesOfNode=function(a,b){for(var c=1,e=a.featureIds,f=0;f<e.length&&(c=b(e[f],f,a),0!==c);f++);return c};c.prototype._forVisibleFeaturesOfNode=function(a,
b){var c=1,e=a.featureIds;this._collection.forEachVisibleComponent(a.objectHandle,function(d){c=b(e[d],d,a);return 1===c});return c};c.prototype._forAllFeaturesOfNodeInClippingArea=function(a,b){if(null==this._clippingArea)return this._forAllFeaturesOfNode(a,b);var c=this._boundingboxNodeTest(a,this._clippingArea);if(0===c)return 1;if(3===c)return this._forAllFeaturesOfNode(a,b);for(var c=a.featureIds,e=k.getClipAABB(this._clippingArea,this._collection.getObjectTransform(a.objectHandle)),f=0;f<c.length;f++)if(this._boundingboxFeatureTest(a,
f,e)){var g=b(c[f],f,a);if(0===g)return g}return 1};c.prototype._createAttributes=function(a,b){var c={};null!=b.featureIds&&(c[this._getObjectIdField()]=b.featureIds[a]);b=f.isSome(b.attributeInfo)&&b.attributeInfo.attributeData;if(f.isSome(b))for(var e=0,h=Object.keys(b);e<h.length;e++){var g=h[e];c[g]=k.getCachedAttributeValue(b[g],a)}return c};c.prototype._createGraphic=function(a,b){return this._createLayerGraphic(this._createAttributes(a,b))};c.prototype.highlight=function(a){var b=this,c=this._highlights;
"number"===typeof a?a=[a]:a instanceof K?a=[a]:a instanceof ja&&(a=a.toArray());if(Array.isArray(a)&&0<a.length){if(a[0]instanceof K){a=a.map(function(a){return N.attributeLookup(a.attributes,b._getObjectIdField())});var e=c.acquireSet(),f=e.set,e=e.handle;c.setFeatureIds(f,a);return e}if("number"===typeof a[0])return e=c.acquireSet(),f=e.set,e=e.handle,c.setFeatureIds(f,a),e}return Sa};c.prototype.visibleGeometryChanged=function(a){var b=this;this._elevationProvider&&(this._elevationProvider.objectChanged(a.node),
null==this._visibleGeometryChangedSchedulerHandle&&(this._visibleGeometryChangedSchedulerHandle=na.schedule(function(){b.emit("visible-geometry-changed");b._visibleGeometryChangedSchedulerHandle=null})))};Object.defineProperty(c.prototype,"performanceInfo",{get:function(){var a={displayedNumberOfFeatures:0,maximumNumberOfFeatures:0,totalNumberOfFeatures:0,core:null,index:0,nodes:this._nodeId2Meta.size,"Total GPU Memory Estimate":(this.gpuMemoryEstimate/1048576).toFixed(1)+"MB","Geometry Memory Estimate":(this.geoMemoryEstimate/
1048576).toFixed(1)+"MB","Texture Memory Estimate":(this.texMemoryEstimate/1048576).toFixed(1)+"MB"};this._controller&&(this._idbCacheEnabled&&(a.IDBCache=Math.round(100*this._idbCache.getHitRate())+"% hit"),this._controller.updateStats(a));return a},enumerable:!1,configurable:!0});Object.defineProperty(c.prototype,"test",{get:function(){var a=this;return{controller:this._controller,labeler:this._labeler,get visibleObjectIds(){var b=[];a._forAllFeatures(function(a){b.push(a);return 1},null,0);b.sort(function(a,
b){return a-b});return b},get numNodes(){return a._nodeId2Meta.size}}},enumerable:!1,configurable:!0});c.prototype.getNodeOpacityByIndex=function(a){a=this._nodeId2Meta.get(a);return this.getNodeOpacity(a)};c.prototype.getNodeOpacity=function(a){var b=0;f.isSome(a)&&this._collection.updateMaterial(a.objectHandle,function(a){b=a.objectOpacity});return b};c.prototype.getNodeCrossfadeMetaData=function(a){var b;return null===(b=this._nodeId2Meta)||void 0===b?void 0:b.get(a)};c.prototype.markNodeToRemove=
function(a){var b=this._controller;b&&b.markNodeToRemove(a)};c.prototype.removeMarkedNodes=function(){var a=this._controller;a&&a.removeMarkedNodes()};c.prototype.foreachCrossfadeNode=function(a){var b=this._nodeId2Meta;b&&b.forEach(function(b,c){return a(c,b)})};c.prototype.setNodeOpacityByIndex=function(a,b){a=this._nodeId2Meta.get(a);f.isSome(a)&&this.setNodeOpacity(a,b)};c.prototype.setNodeOpacity=function(a,b){this._collection.updateMaterial(a.objectHandle,function(a){a.objectOpacity=b});this.setNodeEdgeOpacity(a,
b)};c.prototype.setNodeEdgeOpacity=function(a,b){var c=this._getFilteredEdgeMaterials(a);if(c.hasEdges){for(var e=0,c=c.perFeatureEdgeMaterials;e<c.length;e++)c[e].opacity=b;this._addOrUpdateEdgeRendering(a)}};Object.defineProperty(c.prototype,"_hasModifications",{get:function(){return this._modifications&&0<this._modifications.length},enumerable:!1,configurable:!0});c.prototype.updateNodeModificationStatus=function(a){var b=this,c=a.length;if(!(!this._hasModifications||0>=c||f.isNone(this._i3sModule)||
this._i3sModule instanceof Promise)){var c=this.i3slayer.uid,e=Ma(a);if(f.isSome(e)){this._i3sModule.filterObbsForModificationsSync({context:c,buffer:e.buffer});var g=new Float64Array(e.buffer);a.forEachSimple(function(a,c){c=za.interpretObbModificationResults(g[c]);a.imModificationImpact=c;0!==c&&b._controller.invalidateGeometryVisibility(a.index)})}}};c.prototype.notifyUpdate=function(){this.notifyChange("updating")};c.prototype.isUpdating=function(){return!(!this._controller||!this._controller.updating)||
!!this._visibleGeometryChangedSchedulerHandle||f.isSome(this._labeler)&&this._labeler.updating||0<this._crossfadeHelper.numFadingNodes||0<this._asyncModuleLoading};g.__decorate([l.property({readOnly:!0})],c.prototype,"lodCrossfadeDuration",null);g.__decorate([l.property({})],c.prototype,"_asyncModuleLoading",void 0);g.__decorate([l.property()],c.prototype,"_visibleGeometryChangedSchedulerHandle",void 0);g.__decorate([l.property()],c.prototype,"view",void 0);g.__decorate([l.property()],c.prototype,
"i3slayer",void 0);g.__decorate([l.property()],c.prototype,"_controller",void 0);g.__decorate([l.property()],c.prototype,"_labeler",void 0);g.__decorate([l.property({dependsOn:["_controller.updating","_visibleGeometryChangedSchedulerHandle","_labeler.updating","_asyncModuleLoading"]})],c.prototype,"updating",void 0);g.__decorate([l.property({dependsOn:["_controller.rootNodeVisible"]})],c.prototype,"suspended",void 0);g.__decorate([l.property()],c.prototype,"holeFilling",void 0);g.__decorate([l.property(Ga.updatingProgress)],
c.prototype,"updatingProgress",void 0);g.__decorate([l.property({readOnly:!0,aliasOf:"_controller.updatingProgress"})],c.prototype,"updatingProgressValue",void 0);g.__decorate([l.property({readOnly:!0})],c.prototype,"hasTexturesOrVertexColors",null);g.__decorate([l.property({readOnly:!0})],c.prototype,"rendererTextureUsage",null);g.__decorate([l.property({readOnly:!0,dependsOn:["i3slayer.elevationInfo"]})],c.prototype,"elevationOffset",null);g.__decorate([l.property({type:Boolean})],c.prototype,"slicePlaneEnabled",
void 0);g.__decorate([l.property({dependsOn:["view.qualitySettings.sceneService.uncompressedTextureDownsamplingEnabled","useCompressedTextures"]})],c.prototype,"uncompressedTextureDownsamplingEnabled",null);g.__decorate([l.property({dependsOn:["i3slayer.version"]})],c.prototype,"useCompressedTextures",null);g.__decorate([l.property({type:[ua]})],c.prototype,"_modifications",void 0);return c=g.__decorate([l.subclass("esri.views.3d.layers.I3SMeshView3D")],c)}(G)};var Pa=E.create(),Qa=E.create(),Na=
O.create(),J=[0,0,0,0],Ra=new ia([0,0,0,0]),ha=[0,0,0,0],Sa={remove:function(){},pause:function(){},resume:function(){}}});