// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.17/esri/copyright.txt for details.
//>>built
define("require exports ../../../../core/Logger ../../../../core/maybe ../../../../core/libs/gl-matrix-2/vec2f64 ../../../../core/libs/gl-matrix-2/vec3 ../../../../core/libs/gl-matrix-2/vec4 ../../../../core/libs/gl-matrix-2/vec4f64 ../../support/imageUtils ./DefaultTextureUnits ./glUtil3D ./SSAOTechnique ./Util ../../../webgl/FramebufferObject ../../../webgl/Texture ../../../webgl/Util @dojo/framework/shim/Promise".split(" "),function(x,t,y,p,z,A,B,u,C,D,v,q,w,r,E,m){var F=y.getLogger("esri.views.3d.webgl-engine.lib.SSAOHelper");
t=function(){function b(a,d,b){this._enabled=!1;this._BLUR_F=2;this._attenuation=.5;this._radius=3;this._samples=16;this._viewportToRestore=u.vec4f64.create();this.quadVAO=null;this._rctx=d;this._techniqueRep=a;this._requestRender=b;this._ssaoTechniqueConfig=new q.SSAOTechniqueConfiguration;this._emptyTexture=v.createColorTexture(d,[1,1,1,1])}b.prototype.dispose=function(){this._emptyTexture.dispose();this._emptyTexture=null;p.isSome(this.quadVAO)&&(this.quadVAO=p.disposeMaybe(this.quadVAO))};Object.defineProperty(b.prototype,
"isSupported",{get:function(){var a=this._rctx,d=-1!==a.parameters.versionString.indexOf("WebGL 0.93"),a=-1!==a.parameters.versionString.indexOf("WebGL 0.94");return!(d||a)},enumerable:!1,configurable:!0});Object.defineProperty(b.prototype,"enabled",{get:function(){return this._enabled},set:function(a){a?this.enable():this.disable()},enumerable:!1,configurable:!0});Object.defineProperty(b.prototype,"attenuation",{get:function(){return this._attenuation},set:function(a){this._attenuation=a},enumerable:!1,
configurable:!0});Object.defineProperty(b.prototype,"radius",{get:function(){return this._radius},set:function(a){this._radius=a},enumerable:!1,configurable:!0});Object.defineProperty(b.prototype,"filterRadius",{get:function(){return 4},enumerable:!1,configurable:!0});Object.defineProperty(b.prototype,"samples",{get:function(){return this._samples},set:function(a){this._samples=a;this._enabled&&this.selectPrograms()},enumerable:!1,configurable:!0});b.prototype.computeSSAO=function(a,d,b){if(this._noiseTexture){w.assert(this.enabled);
var c=this._rctx,f=a.fullViewport,e=f[2],h=f[3],f=e/this._BLUR_F,l=h/this._BLUR_F;this._ssaoFBO.resize(e,h);this._blur0FBO.resize(f,l);this._blur1FBO.resize(f,l);f=1*e;l=1*h;c.bindFramebuffer(this._ssaoFBO);B.vec4.copy(this._viewportToRestore,a.fullViewport);c.setViewport(0,0,e,h);var g=this._ssaoTechnique.program,k=this._blurTechnique.program;c.bindProgram(g);c.setPipelineState(this._ssaoTechnique.pipeline);g.setUniform2f("rnmScale",e/this._noiseTexture.descriptor.width,h/this._noiseTexture.descriptor.height);
g.setUniform3fv("pSphere",8>=this._samples?this._data.random8:16>=this._samples?this._data.random16:32>=this._samples?this._data.random32:this._data.random64);e=this._data.minDiscrepancy;g.setUniform1f("numSpiralTurns",this._samples<e.length?e[this._samples]:5779);e=G;h=H;w.inverseProjectionInfo(a.projectionMatrix,a.fullWidth,a.fullHeight,e,h);g.setUniform4fv("projInfo",e);g.setUniform2fv("zScale",h);g.setUniform2f("nearFar",a.near,a.far);e=1/a.computeRenderPixelSizeAtDist(1);g.setUniform1f("projScale",
1*e);g.setUniform2f("screenDimensions",f,l);var n=2*this._radius,h=A.vec3.distance(a.eye,a.center),n=20*a.computeRenderPixelSizeAtDist(h),n=Math.max(.1,n);g.setUniform1f("radius",n);g.setUniform1f("intensity",4*this._attenuation/Math.pow(n,6));g.setUniform1i("rnm",0);g.setUniform1i("normalMap",1);g.setUniform1i("depthMap",2);c.bindTexture(this._noiseTexture,0);c.bindTexture(b,1);c.bindTexture(d,2);p.isSome(this.quadVAO)||(this.quadVAO=v.createQuadVAO(this._rctx));d=this.quadVAO;c.bindVAO(d);c.drawArrays(5,
0,m.vertexCount(d,"geometry"));c.bindTexture(this._ssaoFBO.colorTexture,0);c.setViewport(0,0,f/this._BLUR_F,l/this._BLUR_F);c.bindFramebuffer(this._blur0FBO);c.bindProgram(k);k.setUniform2f("screenDimensions",f,l);k.setUniform1i("tex",0);k.setUniform1i("normalMap",1);k.setUniform1i("depthMap",2);k.setUniform2f("blurSize",0,1*this._BLUR_F/l);k.setUniform1i("radius",4);k.setUniform1f("g_BlurFalloff",.08);k.setUniform2f("nearFar",a.near,a.far);5E4<h&&(e=Math.max(0,e-(h-5E4)));k.setUniform1f("projScale",
e);k.setUniform2f("zScale",1,0);c.drawArrays(5,0,m.vertexCount(d,"geometry"));k.setUniform2f("blurSize",1*this._BLUR_F/f,0);c.bindFramebuffer(this._blur1FBO);c.bindTexture(this._blur0FBO.colorTexture,0);c.drawArrays(5,0,m.vertexCount(d,"geometry"));c.setViewport(this._viewportToRestore[0],this._viewportToRestore[1],this._viewportToRestore[2],this._viewportToRestore[3])}};b.prototype.setUniforms=function(a,d){var b=this.enabled&&this._noiseTexture,c=this._rctx;c.bindTexture(b?this._blur1FBO.colorTexture:
this._emptyTexture,d);c.setActiveTexture(0);a.setUniform1i("ssaoTex",d);b?a.setUniform4f("viewportPixelSz",this._viewportToRestore[0],this._viewportToRestore[1],1/this._ssaoFBO.width,1/this._ssaoFBO.height):a.setUniform4f("viewportPixelSz",-1,-1,-1,-1)};b.prototype.bindToAllPrograms=function(a){a=a.getProgramsUsingUniform("viewportPixelSz");for(var b=0;b<a.length;b++)this.setUniforms(a[b],D.DefaultTextureUnits.SSAO)};b.prototype.selectPrograms=function(){this._ssaoTechniqueConfig.samples=8>=this._samples?
8:16>=this._samples?16:32>=this._samples?32:64;this._ssaoTechniqueConfig.radius=4;this._ssaoTechniqueConfig.output=0;this._ssaoTechnique=this._techniqueRep.acquireAndReleaseExisting(q.SSAOTechnique,this._ssaoTechniqueConfig,this._ssaoTechnique);this._ssaoTechniqueConfig.output=1;this._blurTechnique=this._techniqueRep.acquireAndReleaseExisting(q.SSAOTechnique,this._ssaoTechniqueConfig,this._blurTechnique)};b.prototype.enable=function(){var a=this;this.enabled||(this.isSupported?(this._enabled=!0,this.loadResources(function(){a._enabled&&
a.initialize()})):F.warn("SSAO is not supported for this browser or hardware"))};b.prototype.loadResources=function(a){var b=this;this._data?a():(new Promise(function(a,b){x(["./SSAOHelperData"],a,b)})).then(function(d){b._data=d;a()})};b.prototype.initialize=function(){var a=this,b={target:3553,pixelFormat:6408,dataType:5121,samplingMode:9729,wrapMode:33071,width:0,height:0},f={colorTarget:0,depthStencilTarget:0};this._ssaoFBO=new r(this._rctx,f,b);this._blur0FBO=new r(this._rctx,f,b);this._blur1FBO=
new r(this._rctx,f,b);C.requestImage(this._data.noiseTexture).then(function(b){a._enabled&&(a._noiseTexture=new E(a._rctx,{target:3553,pixelFormat:6408,dataType:5121,hasMipmap:!0,width:b.width,height:b.height},b),a._requestRender())});this.selectPrograms()};b.prototype.disable=function(){this.enabled&&(this._enabled=!1,this._noiseTexture&&(this._noiseTexture.dispose(),this._noiseTexture=null),this._blur1FBO&&(this._blur1FBO.dispose(),this._blur1FBO=null),this._blur0FBO&&(this._blur0FBO.dispose(),
this._blur0FBO=null),this._ssaoFBO&&(this._ssaoFBO.dispose(),this._ssaoFBO=null))};b.prototype.getGpuMemoryUsage=function(){return m.getGpuMemoryUsage(this._blur0FBO)+m.getGpuMemoryUsage(this._blur1FBO)+m.getGpuMemoryUsage(this._ssaoFBO)};Object.defineProperty(b.prototype,"test",{get:function(){return{ssao:this._ssaoFBO,blur:this._blur1FBO}},enumerable:!1,configurable:!0});return b}();var H=z.vec2f64.create(),G=u.vec4f64.create();return t});