// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.17/esri/copyright.txt for details.
//>>built
define(["require","exports","tslib","../../../../../core/maybe","../../../../../core/promiseUtils"],function(h,g,f,k,l){Object.defineProperty(g,"__esModule",{value:!0});g.ShaderTechniqueRepository=void 0;var m=function(){return function(b){this.technique=b;this.refZeroFrame=this.refCount=0}}();h=function(){function b(a){this._context=a;this._perConstructorInstances=new Map;this._frameCounter=0;this._keepAliveFrameCount=1200}Object.defineProperty(b.prototype,"viewingMode",{get:function(){return this._context.viewingMode},
enumerable:!1,configurable:!0});Object.defineProperty(b.prototype,"constructionContext",{get:function(){return this._context},enumerable:!1,configurable:!0});b.prototype.dispose=function(){this._perConstructorInstances.forEach(function(a){return a.forEach(function(a){return a.technique.dispose()})});this._perConstructorInstances.clear()};b.prototype.acquire=function(a,b){var c=b.key,e=this._perConstructorInstances.get(a);e||(e=new Map,this._perConstructorInstances.set(a,e));var d=e.get(c);void 0===
d&&(d=new m(new a(this._context,b)),e.set(c,d));++d.refCount;return d.technique};b.prototype.acquireAndReleaseExisting=function(a,b,c){return k.isNone(c)?this.acquire(a,b):b.key===c.key&&c instanceof a?c:(this.release(c),this.acquire(a,b))};b.prototype.release=function(a){a=this._perConstructorInstances.get(a.constructor).get(a.key);--a.refCount;0===a.refCount&&(a.refZeroFrame=this._frameCounter)};b.prototype.frameUpdate=function(){var a=this;this._frameCounter++;this._perConstructorInstances.forEach(function(b,
c){b.forEach(function(c,d){0===c.refCount&&c.refZeroFrame+a._keepAliveFrameCount<a._frameCounter&&(c.technique.dispose(),b.delete(d))});0===b.size&&a._perConstructorInstances.delete(c)})};b.prototype.getProgramsUsingUniform=function(a){return this._context.commonUniformStore.getPrograms(a)};b.prototype.hotReload=function(){return f.__awaiter(this,void 0,void 0,function(){var a,b=this;return f.__generator(this,function(c){switch(c.label){case 0:return a=[],this._perConstructorInstances.forEach(function(c,
d){a.push(function(a,c){return f.__awaiter(b,void 0,void 0,function(){var b,d=this;return f.__generator(this,function(e){switch(e.label){case 0:return(b=c.shader)?[4,b.reload()]:[3,2];case 1:e.sent(),a.forEach(function(a){a.technique.reload(d._context)}),e.label=2;case 2:return[2]}})})}(c,d))}),[4,l.all(a)];case 1:return c.sent(),[2]}})})};return b}();g.ShaderTechniqueRepository=h});