// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.17/esri/copyright.txt for details.
//>>built
define("require exports tslib ../../../core/Accessor ../../../core/Handles ../../../core/Logger ../../../core/MapUtils ../../../core/maybe ../../../core/maybe ../../../core/PooledArray ../../../core/SetUtils ../../../core/watchUtils ../../../core/accessorSupport/decorators ../../../core/libs/gl-matrix-2/mat4 ../../../core/libs/gl-matrix-2/vec2f64 ../../../core/libs/gl-matrix-2/vec3f64 ../support/debugFlags ./OverlayRenderTarget ../webgl-engine/core/shaderTechnique/CommonUniformStore ../webgl-engine/core/shaderTechnique/ShaderTechniqueRepository ../webgl-engine/lib/AutoDisposable ../webgl-engine/lib/Camera ../webgl-engine/lib/GLMaterialRep ../webgl-engine/lib/glUtil3D ../webgl-engine/lib/GridLocalOriginFactory ../webgl-engine/lib/intersectorUtils ../webgl-engine/lib/RenderContext ../webgl-engine/lib/renderStats ../webgl-engine/lib/SortedRenderGeometryRenderer ../webgl-engine/lib/TextureTechnique ../webgl-engine/lighting/Lightsources ../webgl-engine/lighting/SceneLighting ../webgl-engine/materials/lineStippleUtils ../../webgl/Texture ../../webgl/Util".split(" "),
function(z,h,e,H,I,J,l,K,n,L,M,A,q,v,N,w,B,O,P,Q,r,R,S,C,T,U,V,W,X,D,Y,Z,aa,ba,ca){Object.defineProperty(h,"__esModule",{value:!0});h.overlayRenderOccludedFlag=h.DRAPED_Z=h.OverlayRenderer=void 0;var E=J.getLogger("esri.views.3d.webgl-engine.lib.OverlayRenderer");z=function(x){function a(){var b=null!==x&&x.apply(this,arguments)||this;b._hasHighlights=!1;b._rendersOccluded=!1;b._hasWater=!1;b._lighting=new Z.SceneLighting;b._localOrigins=new T;b._handles=new I;b._layerRenderers=new Map;b._sortedLayerRenderersDirty=
!1;b._sortedLayerRenderers=new L;b._stats=new W.RenderStatsAggregator;b._geometries=new Map;b._uniqueIdx=0;b.globalUnitScale=1;b.longitudeCyclical=null;return b}e.__extends(a,x);a.prototype.initialize=function(){var b=this;this._rctx=this.renderView.renderingContext;this._renderContext=new V(this._rctx,null,null,null,null,null);this._stippleTextureRepository=new aa.StippleTextureRepository;this.waterTextureRepository=this.renderView.waterTextureRepository;this._shaderTechniqueRepository=new Q.ShaderTechniqueRepository({rctx:this._rctx,
viewingMode:2,commonUniformStore:new P.CommonUniformStore,stippleTextureRepository:this._stippleTextureRepository,waterTextureRepository:this.waterTextureRepository});A.init(this.waterTextureRepository,"loadingState",function(){return b.emitContentChanged()});this._materialRepository=new S(this.renderView.textureRepository,this._shaderTechniqueRepository);this._materialRepository.onMaterialChanged=function(d){0<(d.renderOccluded&h.overlayRenderOccludedFlag)!==b._rendersOccluded&&b.updateRendersOccluded();
b.emitContentChanged();b.notifyChange("updating")};this._compositingHelper=this.renderView.compositingHelper;this._lighting.set({lights:[new Y.AmbientLight(w.vec3f64.fromValues(1,1,1))],groundLightingFactor:1,globalFactor:0});this._bindParameters={slot:null,highlightDepthTexture:C.createEmptyDepthTexture(this._rctx),camera:p,inverseViewport:N.vec2f64.create(),origin:null,screenToWorldRatio:null,screenToWorldRatioGlobalWM:null,shadowMappingEnabled:!1,slicePlane:null,ssaoEnabled:!1,hasOccludees:!1,
linearDepthTexture:null,linearDepthTextureID:0,lastFrameColorTexture:null,lastFrameColorTextureID:0,reprojectionMat:null,ssrEnabled:!1,lighting:this._lighting}};a.prototype.dispose=function(){this._handles.destroy();this._layerRenderers.forEach(function(b){return b.dispose()});this._layerRenderers.clear();this._bindParameters.highlightDepthTexture.dispose();this._bindParameters.highlightDepthTexture=null;this._shaderTechniqueRepository.dispose();this._shaderTechniqueRepository=null};Object.defineProperty(a.prototype,
"updating",{get:function(){return this._sortedLayerRenderersDirty||l.someMap(this._layerRenderers,function(b){return b.updating})||this.waterTextureRepository.updating},enumerable:!1,configurable:!0});a.prototype.commitChanges=function(){var b=this,d=!1;this._layerRenderers.forEach(function(c,f){c.commitChanges()&&(d=!0);c.isEmpty&&(b._layerRenderers.delete(f),b._sortedLayerRenderersDirty=!0,b._handles.remove(f))});this._sortedLayerRenderersDirty&&(this.updateSortedLayerRenderers(),d=!0);d&&(this.notifyChange("updating"),
this.emitContentChanged(),this.updateHasHighlights(),this.updateRendersOccluded(),this.updateHasWater())};a.prototype.addGeometries=function(b,d,c){for(var f=0;f<b.length;f++){var a=b[f];null==a.origin&&(a.origin=this._localOrigins.getOrigin(a.center));a.uniqueName||(a.uniqueName="ov:"+this._uniqueIdx++);this._geometries.set(a.uniqueName,a)}this.ensureLayerRenderer(d).add(b);2===c&&this.notifyGraphicUpdate(b,d,2)};a.prototype.removeGeometries=function(b,d,c){for(var f=0;f<b.length;f++)this._geometries.delete(b[f].uniqueName);
if(f=this._layerRenderers.get(d))f.remove(b),2===c&&this.notifyGraphicUpdate(b,d,2)};a.prototype.updateGeometries=function(b,d,c){var f=this._layerRenderers.get(d);f?(f.modify(b,c),this.notifyUpdateGeometries(b,d,c)):E.warn("Attempted to update geometry for nonexistent layer")};a.prototype.notifyUpdateGeometries=function(b,d,c){this.notifyGraphicUpdate(b,d,4===c||2===c?2:1===c?1:0)};a.prototype.notifyGraphicUpdate=function(b,d,c){if(0!==c)for(var f=-1,a=0;a<b.length;a++){var g=b[a].data.graphicUid;
g!==f&&(d.notifyGraphicUpdate(g,c),f=g)}};a.prototype.updateHighlights=function(b,d){(d=this._layerRenderers.get(d))?d.modify(b,8):E.warn("Attempted to update highlights for nonexistent layer")};a.prototype.isEmpty=function(){return 0===this._geometries.size&&!B.OVERLAY_DRAW_DEBUG_TEXTURE};Object.defineProperty(a.prototype,"hasHighlights",{get:function(){return this._hasHighlights},enumerable:!1,configurable:!0});Object.defineProperty(a.prototype,"hasWater",{get:function(){return this._hasWater},
enumerable:!1,configurable:!0});Object.defineProperty(a.prototype,"rendersOccluded",{get:function(){return this._rendersOccluded},enumerable:!1,configurable:!0});a.prototype.updateLogic=function(b){var d=!1;this._layerRenderers.forEach(function(c){c.updateLogic(b)&&(d=!0)});return d};a.prototype.updateLayerOrder=function(){this._sortedLayerRenderersDirty=!0};a.prototype.drawPass=function(b,d,c,f){var a=this;void 0===f&&(f=0);if(0===c.numViews)return!1;this._screenToWorldRatio=c.pixelRatio*Math.abs(c.views[0].extent[2]-
c.views[0].extent[0])/Math.abs(c.views[0].viewport[2]-c.views[0].viewport[0]);if(this.isEmpty()||4===b&&!this.hasHighlights||2===b&&!this.hasWater||!this.hasNonZeroSizedView(c))return!1;var g=c.width,y=c.height;if(!d.isValid())return!1;d.resize(g,y);var k=this._rctx;p.pixelRatio=c.pixelRatio||1;this._renderContext.pass=b;this._bindParameters.screenToWorldRatio=this._screenToWorldRatio;this._bindParameters.screenToWorldRatioGlobalWM=this._screenToWorldRatio*this.globalUnitScale;d.bind(k);k.setClearColor(0,
0,0,0);k.clearSafe(16384);1===f&&(this._renderContext.renderOccludedMask=h.overlayRenderOccludedFlag);if(B.OVERLAY_DRAW_DEBUG_TEXTURE&&1!==f)for(var e=0;e<c.numViews;e++)this.setViewParameters(c.views[e],p),this.drawDebugTexture(g,y,F[c.index%F.length]);0<this._layerRenderers.size&&this._sortedLayerRenderers.forEachSimple(function(m){var e=m.layerView;m=m.renderer;if(2!==f||!n.isSome(e)||0!==e.drapeSourceType){var h=n.isSome(e)&&n.isSome(e.fullOpacity)&&1>e.fullOpacity&&0===b;h&&(a.bindTemporaryFramebuffer(a._rctx,
g,y),k.clearSafe(16384));for(var l=0;l<c.numViews;l++)a.setViewParameters(c.views[l],p),m.draw(a._renderContext,a._bindParameters,a._stats);h&&n.isSome(a._temporaryRenderTarget)&&(d.bind(k),a._compositingHelper.composite(a._temporaryRenderTarget.getTexture(),2,n.unwrap(n.unwrap(e).fullOpacity)))}});k.bindFramebuffer(null);d.generateMipMap();this._renderContext.resetRenderOccludedMask();return!0};a.prototype.bindTemporaryFramebuffer=function(b,d,c){K.isNone(this._temporaryRenderTarget)&&(this._temporaryRenderTarget=
new O.OverlayRenderTarget(b,"temp",0,!1));this._temporaryRenderTarget.resize(d,c);this._temporaryRenderTarget.bind(b)};a.prototype.getStats=function(){return this._stats.getAggregatedStats()};a.prototype.hotReloadShaders=function(){return e.__awaiter(this,void 0,void 0,function(){return e.__generator(this,function(b){switch(b.label){case 0:return[4,this._shaderTechniqueRepository.hotReload()];case 1:return b.sent(),[2]}})})};a.prototype.intersect=function(b,d,c){var f=this,a=0;this._geometries.forEach(function(g){if(!c||
c(g)){f.intersectRenderGeometry(g,d,0,b,a);var e=f.longitudeCyclical;e&&(g.center[0]-g.bsRadius<e.min&&f.intersectRenderGeometry(g,d,e.range,b,a),g.center[0]+g.bsRadius>e.max&&f.intersectRenderGeometry(g,d,-e.range,b,a));a++}})};a.prototype.intersectRenderGeometry=function(b,d,c,a,e){var f=this,m=0;n.isSome(b.transformation)&&(c+=b.transformation[12],m=b.transformation[13]);t[0]=d[0]-c;t[1]=d[1]-m;t[2]=1;u[0]=d[0]-c;u[1]=d[1]-m;u[2]=0;b.screenToWorldRatio=this._screenToWorldRatio;b.material.intersect(b,
null,b.getShaderTransformation(),a,t,u,function(d,c,g){f.addIntersectionResult(g,b.material.renderPriority,e,a,b.data.layerUid,b.data.graphicUid)},b.calculateShaderTransformation,!0)};a.prototype.addIntersectionResult=function(b,d,c,a,e,g){var f={type:"external",metadata:{layerUid:e,graphicUid:g}};e=function(e){e.set(f,null,a.results.ground.dist,a.results.ground.normal,a.results.ground.transformation,d,null,null,b,c);e.intersector="OverlayRenderer"};(null==a.results.min.drapedLayerOrder||d>=a.results.min.drapedLayerOrder)&&
(null==a.results.min.dist||a.results.ground.dist<=a.results.min.dist)&&e(a.results.min);0!==a.options.store&&(null==a.results.max.drapedLayerOrder||d<a.results.max.drapedLayerOrder)&&(null==a.results.max.dist||a.results.ground.dist>a.results.max.dist)&&e(a.results.max);2===a.options.store&&(g=new U.IntersectorResult(a.ray),e(g),a.results.all.push(g))};a.prototype.stopAnimationsAtTime=function(b){this._sortedLayerRenderers.forEachSimple(function(a){return a.renderer.stopAnimationsAtTime(b)})};a.prototype.ensureLayerRenderer=
function(b){var a=this,c=this._layerRenderers.get(b);c||(c=new X.SortedRenderGeometryRenderer({rctx:this._rctx,materialRepository:this._materialRepository}),this._layerRenderers.set(b,c),this._sortedLayerRenderersDirty=!0,this._handles.add([b.watch("fullOpacity",function(){return a.emitContentChanged()}),A.init(c,"updating",function(){return a.notifyChange("updating")})],b));return c};a.prototype.updateSortedLayerRenderers=function(){var b=this;if(this._sortedLayerRenderersDirty&&(this._sortedLayerRenderersDirty=
!1,this._sortedLayerRenderers.clear(),0!==this._layerRenderers.size)){var a=l.firstKeyOfMap(this._layerRenderers).view.allLayerViews,c=M.SetFromValues(l.valuesOfMap(this._layerRenderers));a.forEach(function(a){var d=b._layerRenderers.get(a);d&&(b._sortedLayerRenderers.push(new G(a,d)),c.delete(d))});c.forEach(function(a){b._sortedLayerRenderers.push(new G(null,a))})}};a.prototype.setViewParameters=function(b,a){a.viewport=b.viewport;var c=b.extent;v.mat4.ortho(a.projectionMatrix,0,c[2]-c[0],0,c[3]-
c[1],a.near,a.far);v.mat4.identity(a.viewMatrix);v.mat4.translate(a.viewMatrix,a.viewMatrix,[-b.extent[0],-b.extent[1],0]);a.setGLViewport(this._rctx);this._renderContext.camera=a;this._bindParameters.camera=a;this._bindParameters.inverseViewport[0]=1/a.fullViewport[2];this._bindParameters.inverseViewport[1]=1/a.fullViewport[3]};a.prototype.hasNonZeroSizedView=function(b){for(var a=0;a<b.numViews;a++){var c=b.views[a];if(c.extent[0]!==c.extent[2]&&c.extent[1]!==c.extent[3])return!0}return!1};a.prototype.emitContentChanged=
function(){if(this.onContentChanged)this.onContentChanged()};a.prototype.updateHasWater=function(){var a=l.someMap(this._layerRenderers,function(a){return a.hasWater});a!==this._hasWater&&(this._hasWater=a)};a.prototype.updateHasHighlights=function(){var a=l.someMap(this._layerRenderers,function(a){return a.hasHighlights});if(a!==this._hasHighlights&&(this._hasHighlights=a,this.onHasHighlightsChanged))this.onHasHighlightsChanged(this._hasHighlights)};a.prototype.updateRendersOccluded=function(){var a=
l.someMap(this._layerRenderers,function(a){return a.rendersOccluded});if(a!==this._rendersOccluded&&(this._rendersOccluded=a,this.onRendersOccludedChanged))this.onRendersOccludedChanged(this.rendersOccluded)};a.prototype.drawDebugTexture=function(a,d,c){var b=this._rctx;this.ensureDebugPatternResources(a,d);a=this._debugPatternProgram;b.bindProgram(a);b.setPipelineState(this._debugPatternPipelineState);a.setUniform4f("color",c[0],c[1],c[2],1);a.setUniform1i("tex",0);b.bindTexture(this._debugPatternTexture,
0);b.bindVAO(this._quadVAO);b.drawArrays(5,0,ca.vertexCount(this._quadVAO,"geometry"))};a.prototype.ensureDebugPatternResources=function(a,d){if(!this._debugPatternTexture){for(var b=new Uint8Array(a*d*4),f=0,e=0;e<d;e++)for(var g=0;g<a;g++){var h=Math.floor(g/10),k=Math.floor(e/10);2>h||2>k||10*h>a-20||10*k>d-20?(b[f++]=255,b[f++]=255,b[f++]=255,b[f++]=255):(b[f++]=255,b[f++]=255,b[f++]=255,h&1&&k&1?b[f++]=g&1^e&1?0:255:b[f++]=h&1^k&1?0:128)}this._debugPatternTexture=new ba(this._rctx,{target:3553,
pixelFormat:6408,dataType:5121,samplingMode:9728,width:a,height:d},b);a=new D.TextureTechniqueConfiguration;a.hasAlpha=!0;this._debugTextureTechnique=this._shaderTechniqueRepository.acquireAndReleaseExisting(D.TextureTechnique,a,this._debugTextureTechnique);this._debugPatternProgram=this._debugTextureTechnique.program;this._debugPatternPipelineState=this._debugTextureTechnique.pipeline;this._quadVAO=C.createQuadVAO(this._rctx)}};Object.defineProperty(a.prototype,"test",{get:function(){return{layerRenderers:this._layerRenderers}},
enumerable:!1,configurable:!0});e.__decorate([r.autoDispose()],a.prototype,"_shaderTechniqueRepository",void 0);e.__decorate([r.autoDispose()],a.prototype,"_stippleTextureRepository",void 0);e.__decorate([q.property(),r.autoDispose()],a.prototype,"waterTextureRepository",void 0);e.__decorate([q.property()],a.prototype,"renderView",void 0);e.__decorate([q.property()],a.prototype,"globalUnitScale",void 0);e.__decorate([q.property({type:Boolean,readOnly:!0,dependsOn:["waterTextureRepository.updating"]})],
a.prototype,"updating",null);return a=e.__decorate([q.subclass("esri.views.3d.terrain.OverlayRenderer")],a)}(r.AutoDisposableMixin(H));h.OverlayRenderer=z;var G=function(){return function(e,a){this.layerView=e;this.renderer=a}}(),F=[[1,.5,.5],[.5,.5,1],[.5,1,.5]],p=new R.default;p.near=1;p.far=1E4;p.relativeElevation=null;var t=w.vec3f64.create(),u=w.vec3f64.create();h.DRAPED_Z=-2;h.overlayRenderOccludedFlag=4});