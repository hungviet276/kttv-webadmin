// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.17/esri/copyright.txt for details.
//>>built
define("require exports tslib ../../../core/mathUtils ../../../core/libs/gl-matrix-2/vec3 ../../../core/libs/gl-matrix-2/vec3f64 ../../../geometry/support/geodesicConstants ../support/geometryUtils ../support/projectionUtils ../support/geometryUtils/plane ./PatchGeometryFactory ./Tile".split(" "),function(q,k,v,r,f,t,g,u,l,n,w,x){Object.defineProperty(k,"__esModule",{value:!0});k.SphericalPatch=void 0;q=function(m){function h(a,b,c){var d=m.call(this,y)||this;d.obb=Array(8);d.isWebMercator=!1;for(var e=
0;8>e;e++)d.obb[e]=t.vec3f64.create();void 0!==a&&d.init(a,b,c);return d}v.__extends(h,m);h.prototype.init=function(a,b,c){m.prototype.init.call(this,a,b,c);this.isWebMercator=c.tilingScheme.spatialReference.isWebMercator;b=this.extentInRadians[0];c=this.extentInRadians[1];var d=this.extentInRadians[2],e=this.extentInRadians[3];a=a[0];var h=r.lerp(c,e,.5),k=r.lerp(b,d,.5);this._edgeLen=(d-b)*Math.cos(0===a?0:Math.min(Math.abs(c),Math.abs(e)))*g.earthRadius;this._edgeLen2=this._edgeLen*this._edgeLen;
this._curvatureHeight=g.earthRadius-Math.sqrt(g.earthRadius*g.earthRadius-this._edgeLen2/4);l.wgs84ComparableLonLatToECEF(this.centerAtSeaLevel,k,h,0);b=t.vec3f64.fromArray(this.centerAtSeaLevel);f.vec3.normalize(b,b);this.up=b;this._updateOBB();this.updateRadiusAndCenter()};h.prototype.updateRadiusAndCenter=function(){if(0===this.lij[0])f.vec3.set(this._center[0],0,0,0),f.vec3.set(this._center[1],0,0,0),f.vec3.set(this._center[2],0,0,0),this._radius=g.earthRadius+this.elevationBounds[1];else{this._updateCenter();
var a=Math.max(f.vec3.squaredDistance(this._center[0],this.obb[0]),f.vec3.squaredDistance(this._center[0],this.obb[1]));this._radius=Math.sqrt(a)}};h.prototype._isVisible=function(){if(!this.intersectsClippingArea)return!1;var a=this.surface.frustum.planes;if(10>this.lij[0])return u.frustum.intersectsSphere(a,u.sphere.wrap(this._radius,this._center[0]));for(var b=this.obb,c=0;6>c;c++){var d=a[c];4===c&&(d=n.copy(d,p),p[3]-=this.surface.view.state.camera.near);for(var e=void 0,e=0;8>e&&!n.isPointOutside(d,
b[e]);e++);if(8===e)return!1}return!0};h.prototype.computeElevationBounds=function(){m.prototype.computeElevationBounds.call(this);this._updateOBB()};h.prototype.createGeometry=function(a,b){var c=this._isPole(this.lij[1],this.lij[0]);w.createSphericalGlobePatch(a,this.extent,b,this.renderData,this.extentInRadians,this.isWebMercator,c);this.setMemoryDirty()};h.prototype._updateOBB=function(){for(var a=this.extentInRadians,b=this.obb,c=0;2>c;c++){var d=this.elevationBounds[c],e=4*c;l.wgs84ComparableLonLatToECEF(b[e++],
a[0],a[1],d);l.wgs84ComparableLonLatToECEF(b[e++],a[0],a[3],d);l.wgs84ComparableLonLatToECEF(b[e++],a[2],a[3],d);l.wgs84ComparableLonLatToECEF(b[e++],a[2],a[1],d)}this.isWebMercator&&(a=this._isPole(this.lij[1],this.lij[0]),2===a?(f.vec3.set(b[1],0,0,g.earthRadius),f.vec3.set(b[2],0,0,g.earthRadius),f.vec3.set(b[5],0,0,g.earthRadius),f.vec3.set(b[6],0,0,g.earthRadius)):1===a&&(f.vec3.set(b[0],0,0,-g.earthRadius),f.vec3.set(b[3],0,0,-g.earthRadius),f.vec3.set(b[4],0,0,-g.earthRadius),f.vec3.set(b[7],
0,0,-g.earthRadius)))};h.prototype._isPole=function(a,b){var c=0;a===(1<<b)-1&&(c+=1);0===a&&(c+=2);return c};return h}(x.Tile);k.SphericalPatch=q;var y=[128,64,32,16,16,8,8,4],p=n.create()});