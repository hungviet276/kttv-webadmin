// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.17/esri/copyright.txt for details.
//>>built
define("require exports tslib ../../Viewpoint ../../core/Collection ../../core/maybe ../../core/promiseUtils ../../core/unitUtils ../../core/libs/gl-matrix-2/common ../../core/libs/gl-matrix-2/mat2d ../../core/libs/gl-matrix-2/mat2df64 ../../core/libs/gl-matrix-2/vec2 ../../core/libs/gl-matrix-2/vec2f64 ../../geometry/Extent ../../geometry/Geometry ../../geometry/Point ../../geometry/SpatialReference ../../geometry/support/geodesicConstants ../../geometry/support/spatialReferenceUtils ../../geometry/support/webMercatorUtils ../../geometry/support/webMercatorUtils".split(" "),
function(ga,b,J,H,Y,M,Z,Q,q,p,t,f,h,R,aa,N,ba,w,A,G,ca){function S(a,c,d,e){return e&&d&&!e.equals(d)&&G.canProject(e,d)&&e.isWebMercator?(e.isWebMercator?(d=c[1],89.99999<d?d=89.99999:-89.99999>d&&(d=-89.99999),d=Math.sin(q.common.toRadian(d)),a=f.vec2.set(a,q.common.toRadian(c[0])*w.earthRadius,.5*w.earthRadius*Math.log((1+d)/(1-d)))):(d=q.common.toDegree(c[0]/w.earthRadius),a=f.vec2.set(a,d-360*Math.floor((d+180)/360),q.common.toDegree(.5*Math.PI-2*Math.atan(Math.exp(-1*c[1]/w.earthRadius))))),
a):f.vec2.copy(a,c)}function C(a){return a.wkid?a:a.spatialReference||ba.WGS84}function D(a,c){return c.type?f.vec2.set(a,c.x,c.y):f.vec2.copy(a,c)}function B(a,c){return Math.max(a.width/c[0],a.height/c[1])*T(a.spatialReference)}function I(a,c,d,e){return J.__awaiter(this,void 0,void 0,function(){var b,k,f,h,K,p,r,l,n,m,O,E,D,B,u,x,y,z,P,q,t,w,C,v,L,H,F,A;return J.__generator(this,function(g){switch(g.label){case 0:if(!a||Array.isArray(a)&&!a.length)return[2,null];Y.isCollection(a)&&(a=a.toArray());
if(!Array.isArray(a)||!a.length||"object"!==typeof a[0])return[3,7];k=a.every(function(a){return"attributes"in a});f=a.some(function(a){return!a.geometry});h=a;if(!(k&&f&&c&&c.allLayerViews))return[3,2];K=new Map;p=0;for(r=a;p<r.length;p++)l=r[p],n=l.layer,m=K.get(n)||[],O=l.attributes[n.objectIdField],null!=O&&m.push(O),K.set(n,m);E=[];K.forEach(function(a,d){var e=c.allLayerViews.find(function(a){return a.layer.id===d.id});if("queryFeatures"in e){var b=d.createQuery();b.objectIds=a;b.returnGeometry=
!0;E.push(e.queryFeatures(b))}});return[4,Z.all(E)];case 1:D=g.sent();B=[];u=0;for(x=D;u<x.length;u++)if((y=x[u])&&y.features&&y.features.length)for(z=0,P=y.features;z<P.length;z++)l=P[z],M.isSome(l.geometry)&&B.push(l.geometry);h=B;g.label=2;case 2:q=0,t=h,g.label=3;case 3:if(!(q<t.length))return[3,6];w=t[q];return[4,I(w,c,d,e)];case 4:e=g.sent(),g.label=5;case 5:return q++,[3,3];case 6:return[2,e];case 7:if(!Array.isArray(a)||2!==a.length||"number"!==typeof a[0]||"number"!==typeof a[1])return[3,
8];b=new N(a);return[3,12];case 8:if(!(a instanceof aa))return[3,9];b=a;return[3,12];case 9:if(!("geometry"in a))return[3,12];if(!a.geometry)return[3,10];b=a.geometry;return[3,12];case 10:if(!a.layer)return[3,12];C=a.layer;v=c.allLayerViews.find(function(a){return a.layer.id===C.id});if(!("queryFeatures"in v))return[3,12];L=C.createQuery();L.objectIds=[a.attributes[C.objectIdField]];L.returnGeometry=!0;return[4,v.queryFeatures(L)];case 11:H=g.sent(),b=M.get(H,"features",0,"geometry"),g.label=12;case 12:if(M.isNone(b))return[2,
null];F="point"===b.type?new R({xmin:b.x,ymin:b.y,xmax:b.x,ymax:b.y,spatialReference:b.spatialReference}):b.extent;if(!F)return[2,null];A=G.canProject(F,d);if(!F.spatialReference.equals(d)&&A)F=G.project(F,d);else if(!A)return[2,null];e=e?e.union(F):F.clone();return[2,e]}})})}function da(a){if(a&&(!Array.isArray(a)||"number"!==typeof a[0])&&("object"===typeof a||Array.isArray(a)&&"object"===typeof a[0])){if("layer"in a&&a.layer&&a.layer.minScale&&a.layer.maxScale){var c=a.layer;return{min:c.minScale,
max:c.maxScale}}if(Array.isArray(a)&&a.length&&a.every(function(a){return"layer"in a})){for(var d=0,e=0,b=0;b<a.length;b++)(c=a[b].layer)&&c.minScale&&c.maxScale&&(d=c.minScale<d?c.minScale:d,e=c.maxScale>e?c.maxScale:e);return d&&e?{min:d,max:e}:null}}}function U(a,c){return J.__awaiter(this,void 0,void 0,function(){var d,e,b,k,f,p,n,m,r,l,q,t,v,E,w,A,u,x,y,z;return J.__generator(this,function(g){switch(g.label){case 0:if(!a||!c)return[2,new H({targetGeometry:new N,scale:0,rotation:0})];d=c.spatialReference;
e=c.constraints;b=c.padding;k=c.viewpoint;f=c.size;p=b?f[0]-b.left-b.right:f[0];n=b?f[1]-b.top-b.bottom:f[1];m=[p,n];r=null;a instanceof H?r=a:a.viewpoint?r=a.viewpoint:a.target&&"esri.Viewpoint"===a.target.declaredClass&&(r=a.target);l=null;if(!r||!r.targetGeometry)return[3,1];l=r.targetGeometry;return[3,10];case 1:if(!(a instanceof R))return[3,2];l=a;return[3,10];case 2:return a||a&&("center"in a||"extent"in a||"target"in a)?[4,I(a.center,c,d)]:[3,10];case 3:return(v=g.sent())?[3,5]:[4,I(a.extent,
c,d)];case 4:v=g.sent(),g.label=5;case 5:return(t=v)?[3,7]:[4,I(a.target,c,d)];case 6:t=g.sent(),g.label=7;case 7:return(q=t)?[3,9]:[4,I(a,c,d)];case 8:q=g.sent(),g.label=9;case 9:l=q,g.label=10;case 10:!l&&k&&k.targetGeometry?l=k.targetGeometry:!l&&c.extent&&(l=c.extent);E=C(l);d||(d=C(c.spatialReference||c.extent||l));if(!ca.canProject(l,d)&&E&&!E.equals(d))return[2,null];w=D(h.vec2f64.create(),l.center?l.center:l);A=new N(S(w,w,E,d),d);u=null;u=r&&r.targetGeometry&&"point"===r.targetGeometry.type?
r.scale:a.hasOwnProperty("scale")&&a.scale?a.scale:a.hasOwnProperty("zoom")&&-1!==a.zoom&&e&&e.effectiveLODs?e.zoomToScale(a.zoom):Array.isArray(l)||"point"===l.type||"extent"===l.type&&0===l.width&&0===l.height?c.extent&&G.canProject(c.extent,d)?B(G.project(c.extent,d),m):c.extent?B(c.extent,m):k.scale:G.canProject(l.extent,d)?B(G.project(l.extent,d),m):B(l.extent,m);if(x=da(a))x.min&&x.min>u?u=x.min:x.max&&x.max<u&&(u=x.max);y=0;r?y=r.rotation:a.hasOwnProperty("rotation")?y=a.rotation:k&&(y=k.rotation);
z=new H({targetGeometry:A,scale:u,rotation:y});e&&(z=e.fit(z),e.constrainByGeometry(z),e.rotationEnabled||(z.rotation=y));return[2,z]}})})}function n(a,c){var d=a.targetGeometry,e=c.targetGeometry;d.x=e.x;d.y=e.y;d.spatialReference=e.spatialReference;a.scale=c.scale;a.rotation=c.rotation;return a}function V(a,c,d){return d?f.vec2.set(a,.5*(c[0]-d.right+d.left),.5*(c[1]-d.bottom+d.top)):f.vec2.scale(a,c,.5)}function ea(a,c,d,e){b.getTransform(a,c,d,e);return p.mat2d.invert(a,a)}function W(a,c,d){var e=
v(c);c=Math.abs(Math.cos(e));e=Math.abs(Math.sin(e));return f.vec2.set(a,Math.round(d[1]*e+d[0]*c),Math.round(d[1]*c+d[0]*e))}function m(a){var c=a.scale;a=a.targetGeometry.spatialReference;a=A.isValid(a)?1/(39.37*Q.getMetersPerUnitForSR(a)*96):1;return c*a}function v(a){return q.common.toRadian(a.rotation)||0}function T(a){return A.isValid(a)?39.37*Q.getMetersPerUnitForSR(a)*96:1}function X(a){return a.isWrappable?(a=A.getInfo(a),a.valid[1]-a.valid[0]):0}Object.defineProperty(b,"__esModule",{value:!0});
b.translateBy=b.toScreen=b.toMap=b.padAndScaleAndRotateBy=b.scaleAndRotateBy=b.scaleTo=b.scaleBy=b.rotateTo=b.rotateBy=b.resize=b.pixelSize=b.centerAt=b.removePadding=b.addPadding=b.angleBetween=b.createAsync=b.getWorldScreenWidth=b.getWorldWidth=b.getTransformNoRotation=b.getTransform=b.getMatrix=b.getResolutionToScaleFactor=b.getResolution=b.getPaddingMapTranslation=b.getPaddingScreenTranslation=b.getOuterSize=b.getOuterExtent=b.setExtent=b.getExtent=b.getAnchor=b.copy=b.create=b.extentToScale=
void 0;var fa=180/Math.PI;b.extentToScale=B;b.create=U;b.copy=n;b.getAnchor=V;b.getExtent=function(){var a=h.vec2f64.create();return function(c,d,e){var b=d.targetGeometry;D(a,b);d=.5*m(d);c.xmin=a[0]-d*e[0];c.ymin=a[1]-d*e[1];c.xmax=a[0]+d*e[0];c.ymax=a[1]+d*e[1];c.spatialReference=b.spatialReference;return c}}();b.setExtent=function(a,c,d,e,g){b.centerAt(a,c,d.center);a.scale=B(d,e);g&&g.constraints&&g.constraints.constrain(a);return a};b.getOuterExtent=function(){var a=h.vec2f64.create(),c=h.vec2f64.create();
return function(d,e,b){D(a,e.targetGeometry);W(c,e,b);b=.5*m(e);d.set({xmin:a[0]-b*c[0],ymin:a[1]-b*c[1],xmax:a[0]+b*c[0],ymax:a[1]+b*c[1],spatialReference:e.targetGeometry.spatialReference});return d}}();b.getOuterSize=W;b.getPaddingScreenTranslation=function(){var a=h.vec2f64.create();return function(c,d,b){return f.vec2.sub(c,f.vec2.scale(c,d,.5),V(a,d,b))}}();b.getPaddingMapTranslation=function(){var a=t.mat2df64.create(),c=h.vec2f64.create();return function(d,e,g,k){var h=m(e);e=v(e);f.vec2.set(c,
h,h);p.mat2d.fromScaling(a,c);p.mat2d.rotate(a,a,e);p.mat2d.translate(a,a,b.getPaddingScreenTranslation(c,g,k));p.mat2d.translate(a,a,[0,k.top-k.bottom]);return f.vec2.set(d,a[4],a[5])}}();b.getResolution=m;b.getResolutionToScaleFactor=T;b.getMatrix=function(){var a=h.vec2f64.create(),c=h.vec2f64.create(),d=h.vec2f64.create();return function(b,g,k,h,n,m){f.vec2.negate(a,g);f.vec2.scale(c,k,.5*m);f.vec2.set(d,1/h*m,-1/h*m);p.mat2d.identity(b);p.mat2d.translate(b,b,c);n&&p.mat2d.rotate(b,b,n);p.mat2d.scale(b,
b,d);p.mat2d.translate(b,b,a);return b}}();b.getTransform=function(){var a=h.vec2f64.create();return function(c,d,e,g){var k=m(d),f=v(d);D(a,d.targetGeometry);return b.getMatrix(c,a,e,k,f,g)}}();b.getTransformNoRotation=function(){var a=h.vec2f64.create();return function(c,d,e,g){var f=m(d);D(a,d.targetGeometry);return b.getMatrix(c,a,e,f,0,g)}}();b.getWorldWidth=X;b.getWorldScreenWidth=function(a,c){return Math.round(X(a)/c)};b.createAsync=function(a,c){return U(a,c)};b.angleBetween=function(){var a=
h.vec2f64.create(),c=h.vec2f64.create(),b=[0,0,0];return function(d,g,k){f.vec2.subtract(a,d,g);f.vec2.normalize(a,a);f.vec2.subtract(c,d,k);f.vec2.normalize(c,c);f.vec2.cross(b,a,c);d=Math.acos(f.vec2.dot(a,c)/(f.vec2.length(a)*f.vec2.length(c)))*fa;0>b[2]&&(d=-d);isNaN(d)&&(d=0);return d}}();b.addPadding=function(){var a=h.vec2f64.create();return function(c,d,e,g){var f=c.targetGeometry;n(c,d);b.getPaddingMapTranslation(a,d,e,g);f.x+=a[0];f.y+=a[1];return c}}();b.removePadding=function(){var a=
h.vec2f64.create();return function(c,d,e,g){var f=c.targetGeometry;n(c,d);b.getPaddingMapTranslation(a,d,e,g);f.x-=a[0];f.y-=a[1];return c}}();b.centerAt=function(){var a=h.vec2f64.create();return function(c,b,e){n(c,b);b=c.targetGeometry;var d=C(e),f=C(b);D(a,e);S(a,a,d,f);b.x=a[0];b.y=a[1];return c}}();b.pixelSize=function(a){return m(a)};b.resize=function(){var a=h.vec2f64.create();return function(c,d,e,g,k){k||(k="center");f.vec2.sub(a,e,g);f.vec2.scale(a,a,.5);e=a[0];g=a[1];switch(k){case "center":f.vec2.set(a,
0,0);break;case "left":f.vec2.set(a,-e,0);break;case "top":f.vec2.set(a,0,g);break;case "right":f.vec2.set(a,e,0);break;case "bottom":f.vec2.set(a,0,-g);break;case "top-left":f.vec2.set(a,-e,g);break;case "bottom-left":f.vec2.set(a,-e,-g);break;case "top-right":f.vec2.set(a,e,g);break;case "bottom-right":f.vec2.set(a,e,-g)}b.translateBy(c,d,a);return c}}();b.rotateBy=function(a,c,b){n(a,c);a.rotation+=b;return a};b.rotateTo=function(a,c,b){n(a,c);a.rotation=b;return a};b.scaleBy=function(){var a=
h.vec2f64.create();return function(c,d,e,g,k){n(c,d);isNaN(e)||0===e||(b.toMap(a,g,d,k),c.scale=d.scale*e,b.toScreen(a,a,c,k),b.translateBy(c,c,f.vec2.set(a,a[0]-g[0],g[1]-a[1])));return c}}();b.scaleTo=function(a,c,b){n(a,c);a.scale=b;return a};b.scaleAndRotateBy=function(){var a=h.vec2f64.create();return function(c,d,e,g,k,h){n(c,d);isNaN(e)||0===e||(b.toMap(a,k,d,h),c.scale=d.scale*e,c.rotation+=g,b.toScreen(a,a,c,h),b.translateBy(c,c,f.vec2.set(a,a[0]-k[0],k[1]-a[1])));return c}}();b.padAndScaleAndRotateBy=
function(){var a=h.vec2f64.create(),c=h.vec2f64.create();return function(d,e,g,k,h,m,n){b.getPaddingScreenTranslation(c,m,n);f.vec2.add(a,h,c);return k?b.scaleAndRotateBy(d,e,g,k,a,m):b.scaleBy(d,e,g,a,m)}}();b.toMap=function(){var a=t.mat2df64.create();return function(c,b,e,g){return f.vec2.transformMat2d(c,b,ea(a,e,g,1))}}();b.toScreen=function(){var a=t.mat2df64.create();return function(c,d,e,g){return f.vec2.transformMat2d(c,d,b.getTransform(a,e,g,1))}}();b.translateBy=function(){var a=h.vec2f64.create(),
c=t.mat2df64.create();return function(b,e,g){n(b,e);var d=m(e),q=b.targetGeometry;p.mat2d.fromRotation(c,v(e));p.mat2d.scale(c,c,h.vec2f64.fromValues(d,d));f.vec2.transformMat2d(a,g,c);q.x+=a[0];q.y+=a[1];return b}}()});