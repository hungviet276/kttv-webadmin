// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.17/esri/copyright.txt for details.
//>>built
define("require exports tslib ../../../../core/Error ../../../../core/has ../../../../core/Logger ../../../../core/maybe ../../../../core/MD5 ../../../../renderers/visualVariables/SizeVariable ../../../../renderers/visualVariables/support/SizeStop ../../engine/LevelDependentSizeVariable".split(" "),function(A,f,l,p,q,u,r,n,v,k,w){function x(b,a,c){switch(b){case "avg":case "avg_angle":return"cluster_avg_"+a;case "mode":return"cluster_type_"+a;case "norm":return b=a.toLowerCase()+",norm:field,"+c.toLowerCase(),
"cluster_avg_"+n.createMD5Hash(b)}}function y(b,a){var c=a.name,e=a.outStatistic,d=e.onStatisticField,g=e.onStatisticValueExpression,e=e.statisticType;g?(a=n.createMD5Hash(g.toLowerCase()),b.push({name:c,outStatistic:{onStatisticField:a,onStatisticValueExpression:g,statisticType:e}})):d?b.push({name:c,outStatistic:{onStatisticField:d,statisticType:e}}):t.error(new p("mapview-unsupported-field","Unable to handle field",{field:a}))}function m(b,a,c){var e=n.createMD5Hash(a),d="mode"===c?"cluster_type_"+
e:"cluster_avg_"+e;b.some(function(a){return a.name===d})||b.push({name:d,outStatistic:{onStatisticField:e,onStatisticValueExpression:a,statisticType:c}});return d}function h(b,a,c,e){if("cluster_count"===a||b.some(function(b){return b.name===a}))return a;var d=x(c,a,e);b.some(function(a){return a.name===d})||("norm"===c?b.push({name:d,outStatistic:{onStatisticField:a,onStatisticNormalizationField:e,statisticType:c}}):b.push({name:d,outStatistic:{onStatisticField:a,statisticType:c}}));return d}Object.defineProperty(f,
"__esModule",{value:!0});f.isClusterCompatibleRenderer=f.createClusterCountSizeVariable=f.hasClusterCountVV=f.findSizeVV=f.createClusterRenderer=void 0;var t=u.getLogger("esri.views.2d.layers.support.clusterUtils");q.add("esri-cluster-arcade-enabled",1);var z=q("esri-cluster-arcade-enabled");f.createClusterRenderer=function(b,a,c,e){a=a.clone();if(!f.isClusterCompatibleRenderer(a))return a;if(c.fields)for(var d=0,g=c.fields;d<g.length;d++)y(b,g[d]);"visualVariables"in a&&(d=(a.visualVariables||[]).filter(function(a){return"$view.scale"!==
a.valueExpression}),g=f.findSizeVV(d),d.forEach(function(a){"rotation"===a.type?a.field?a.field=h(b,a.field,"avg_angle"):a.valueExpression&&(a.field=m(b,a.valueExpression,"avg_angle"),a.valueExpression=null):a.normalizationField?(a.field=h(b,a.field,"norm",a.normalizationField),a.normalizationField=null):a.field?a.field=h(b,a.field,"avg"):(a.field=m(b,a.valueExpression,"avg"),a.valueExpression=null)}),r.isNone(g)&&!f.hasClusterCountVV(d)&&(d.push(f.createClusterCountSizeVariable(c,e)),a.dynamicClusterSize=
!0),a.visualVariables=d);switch(a.type){case "unique-value":a.field?a.field=h(b,a.field,"mode"):a.valueExpression&&(a.field=m(b,a.valueExpression,"mode"),a.valueExpression=null);break;case "class-breaks":a.normalizationField?(a.field=h(b,a.field,"norm",a.normalizationField),a.normalizationField=null):a.field?a.field=h(b,a.field,"avg"):(a.field=m(b,a.valueExpression,"avg"),a.valueExpression=null)}return a};f.findSizeVV=function(b){for(var a=0;a<b.length;a++){var c=b[a];if("size"===c.type)return c}return null};
f.hasClusterCountVV=function(b){for(var a=0;a<b.length;a++)if("cluster_count"===b[a].field)return!0;return!1};f.createClusterCountSizeVariable=function(b,a){var c=[new k({value:0,size:0}),new k({value:1})];if(r.isNone(a))return new v({field:"cluster_count",stops:l.__spreadArrays(c,[new k({value:2,size:0})])});var e=Object.keys(a).reduce(function(d,e){var f;return l.__assign(l.__assign({},d),(f={},f[e]=l.__spreadArrays(c,[new k({value:Math.max(2,a[e].minValue),size:b.clusterMinSize}),new k({value:Math.max(3,
a[e].maxValue),size:b.clusterMaxSize})]),f))},{});return new w.LevelDependentSizeVariable({field:"cluster_count",levels:e})};f.isClusterCompatibleRenderer=function(b){var a=function(a){return t.error(new p("Unsupported-renderer",a,{renderer:b}))};if("unique-value"===b.type){if(b.field2||b.field3)return a("FeatureReductionCluster does not support multi-field UniqueValueRenderers"),!1}else if("class-breaks"===b.type){if(b.normalizationField){var c=b.normalizationType;if("field"!==c)return a("FeatureReductionCluster does not support a normalizationType of "+
c),!1}}else if("simple"!==b.type)return a("FeatureReductionCluster does not support renderers of type "+b.type),!1;if(!z){if("valueExpression"in b&&b.valueExpression)return a("FeatureReductionCluster does not currently support renderer.valueExpression. Support will be added in a future release"),!1;if(("visualVariables"in b&&b.visualVariables||[]).some(function(a){return!!("valueExpression"in a&&a.valueExpression)}))return a("FeatureReductionCluster does not currently support visualVariables with a valueExpression. Support will be added in a future release"),
!1}return!0}});