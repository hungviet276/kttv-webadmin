// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.17/esri/copyright.txt for details.
//>>built
define("require exports ../../../../../core/Error ../../../../../core/Logger ../../../../../core/MapUtils ../../../../../core/mathUtils ../definitions ./CollisionBucket ./LayerCollisionInfo".split(" "),function(x,v,z,A,y,w,q,B,n){Object.defineProperty(v,"__esModule",{value:!0});v.CollisionEngine=void 0;var t=q.TILE_SIZE/q.COLLISION_BUCKET_SIZE,C=A.getLogger("esri.views.2d.engine.webgl.collisions.CollisionEngine");x=function(){function d(a){this._layers=new Map;this._collisionBuckets=new Map;this._didError=
!1;this._tilingScheme=a}Object.defineProperty(d.prototype,"collisionInfos",{get:function(){return y.valuesOfMap(this._layers)},enumerable:!1,configurable:!0});d.prototype.registerLayerView=function(a,b){if(!this._layers.has(a)){var c=n.default.create(a,b,this.collisionInfos,this._tilingScheme);this._layers.set(a,c);this._collisionBuckets.forEach(function(a){return a.onRegisterLayer(c.index)})}};d.prototype.unregisterLayerView=function(a){var b=this;if(this._layers.has(a)){var c=this._layers.get(a);
n.default.delete(c.index,this.collisionInfos);this._layers.delete(a);this._collisionBuckets.forEach(function(a,l){var e=a.getTile(c.index);e&&(a.onUnregisterLayer(c.index),a.canDelete()&&b._collisionBuckets.delete(l),e.reference&&(e.reference.isDirty=!1))})}};d.prototype.addTile=function(a,b){var c=b.key.id;this._layers.has(a)&&(this._collisionBuckets.has(c)||this._collisionBuckets.set(c,new B.default(b.key,this._layers.size)),a=this._getIndex(a),this._collisionBuckets.get(c).getTile(a).reference=
b)};d.prototype.removeTile=function(a,b){this._layers.has(a)&&this._collisionBuckets.has(b)&&(a=this._getIndex(a),b=this._collisionBuckets.get(b).getTile(a),b.dirty=!1,b.reference=null)};d.prototype.run=function(a,b){var c=y.valuesOfMap(this._collisionBuckets).sort(function(a,b){return a.key.compareRowMajor(b.key)}),e=!0,l=a.renderingOptions.labelCollisionsEnabled&&!this._didError,d=this.collisionInfos;try{for(var m=0;m<c.length;m++){var f=c[m],e=e||f.isDirty;f.computeNeighbors(this._collisionBuckets);
for(var g=0;g<this._layers.size;g++){var h=n.default.find(g,d);f.reset(a,e,h)}}for(a=0;a<this._layers.size;a++)for(h=n.default.find(a,d),e=0,m=c;e<m.length;e++)f=m[e],this._run(l,f,h,b)}catch(k){C.error(z("mapview-labeling","Encountered an error during decluttering. Disabling collisions",k)),this._didError=!0}for(b=0;b<c.length;b++)f=c[b],f.ready()};d.prototype._run=function(a,b,c,e){var d=b.getReference(c.index);d&&d.hasData&&(d.key.level!==e?this._resetLabelsMinZoom(b,c):this._runVisibility(a,b,
d,c,e))};d.prototype._resetLabelsMinZoom=function(a,b){if(a&&"polyline"!==b.geometryType&&(a=a.getReference(b.index))&&a.hasData){b=b.layerView.tileRenderer.featuresView.attributeView;var c=0;for(a=a.displayObjects;c<a.length;c++)b.setLabelMinZoom(a[c].id,255)}};d.prototype._checkLabelsVisible=function(a,b){var c=!b.effect||b.effect.excludedLabelsVisible||!!(a&q.EFFECT_FLAG_0);return(!b.filter||!!(a&q.FILTER_FLAG_0))&&c};d.prototype._runVisibility=function(a,b,c,e,d){var l=e.layerView.tileRenderer.featuresView.attributeView;
c=c.displayObjects.sort(function(a,b){a=l.getLabelMinZoom(a.id);b=l.getLabelMinZoom(b.id);return a-b});for(var m=e.zoomRanges.some(function(a){return"none"===a.deconflictionStrategy}),f=0;f<c.length;f++){var g=c[f];if(g.metrics.length){var h="polyline"===e.geometryType?0:10*(d-1),k=l.getFilterFlags(g.id),r=this._checkLabelsVisible(k,e.layerView);if(a&&!m)for(var p=0;p<g.metrics.length;p++)k=g.metrics[p],k=r?-1!==k.minZoom?k.minZoom:this._computeLabelVisibility(g,k,e.index,b,k.baseZoom,d):255,h=Math.max(k,
h);h=Math.max(h,0);l.setLabelMinZoom(g.id,h);r=0;for(g=g.metrics;r<g.length;r++)k=g[r],k.minZoom=h}}};d.prototype._computeLabelVisibility=function(a,b,c,e,d,q){for(var m=b.xBucket,f=b.yBucket,g=b.xOverflow,h=b.yOverflow,k=m-g,m=m+g+1,g=f+h+1,f=f-h;f<g;f++)for(h=k;h<m;h++)if(!(h<-t||f<-t||h>t||f>t))for(var l=0;l<=c;l++){var p=this._getRelativeSubBucket(l,e,h,f);if(p)for(var n=0;n<p.length;n++){var u=p[n];if(l!==c||u.id!==a.id)u=this._compareLabels(b,u,d,q),d=Math.max(u,d)}}return d};d.prototype._compareLabels=
function(a,b,c,e){if(-1===b.minZoom||b.minZoom>10*(e+1))return c;a=a.findCollisionDelta(b);e=w.clamp(Math.ceil(10*(a+e)),0,255);return b.minZoom>=e?c:Math.max(c,e)};d.prototype._getNeighboringTile=function(a,b,c,e){return(b=b.neighbors[3*(1+e)+(1+c)])&&b.getTile(a)};d.prototype._getRelativeSubBucket=function(a,b,c,e){var d=w.sign(Math.floor(c/4)),n=w.sign(Math.floor(e/4));return(a=this._getNeighboringTile(a,b,d,n))&&a.reference&&a.index&&a.reference.hasData?a.index[e-4*n][c-4*d]:null};d.prototype._getIndex=
function(a){return this._layers.get(a).index};return d}();v.CollisionEngine=x});