// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.17/esri/copyright.txt for details.
//>>built
define("require exports ../../../../../core/libs/gl-matrix-2/mat4f64 ../../../../../core/libs/gl-matrix-2/vec2f64 ../../../../../core/libs/gl-matrix-2/vec3 ../../../../../core/libs/gl-matrix-2/vec3f64 ../../../../../core/libs/gl-matrix-2/vec4f64 ../../../../../geometry/support/aaBoundingBox ../../../support/debugFlags ../../../support/buffer/glUtil ../../core/shaderLibrary/output/OutputHighlight.glsl ../Camera ../DefaultVertexAttributeLocations ../intersectorUtils ../Util ./InstanceData ./InstanceOctree ./LevelSelector ./RenderInstanceData ../../materials/DefaultMaterial ../../materials/internal/MaterialUtil ../../materials/renderers/utils ../../../../webgl/BufferObject ../../../../webgl/Util ../../../../webgl/VertexArrayObject".split(" "),
function(z,l,N,O,t,u,P,v,A,B,Q,R,x,S,w,f,T,U,C,V,W,y,X,D,Y){function E(b,a,c,d){y.encodeDoubleVec3(b.modelOrigin,a,c.modelOriginHi,c.modelOriginLo,d);c.model.copyFrom(d,b.model,a);c.modelNormal.copyFrom(d,b.modelNormal,a);b.color&&c.color&&c.color.copyFrom(d,b.color,a);b.featureAttribute&&c.featureAttribute&&c.featureAttribute.copyFrom(d,b.featureAttribute,a)}Object.defineProperty(l,"__esModule",{value:!0});l.lodRenderers=l.LodRenderer=l.LodLevelData=l.LodComponentData=l.setLevelSelectorFactory=void 0;
var F=function(b){var a=b.baseBoundingSphere.radius;b=b.levels.map(function(a){return a.minScreenSpaceRadius});return new U.LevelSelector(a,b)};l.setLevelSelectorFactory=function(b){F=b};var G=function(){function b(a,c){var d=a.rctx,b=c.geometry;c=c.material;var g=b.data.toRenderData();this.materialRep=a.materialRep;c.setParameterValues({instancedDoublePrecision:!0});a=c.createBufferWriter();var h=a.vertexBufferLayout,e=a.elementCount(g),r=a.allocate(e);a.write({},g,r,0);this.geometry=b;this.material=
c;this.glMaterials=y.acquireMaterials(c,this.materialRep);this.vertexBufferLayout=h;this.vbo=X.createVertex(d,35044,r.buffer);this.vao=new Y(d,x.Default3D,{geometry:B.glLayout(h)},{geometry:this.vbo});this.vertexCount=e}b.prototype.destroy=function(){y.releaseMaterials(this.material,this.materialRep);this.vbo.dispose();this.vao.dispose()};Object.defineProperty(b.prototype,"boundingInfo",{get:function(){return this.geometry.boundingInfo},enumerable:!1,configurable:!0});Object.defineProperty(b.prototype,
"triangleCount",{get:function(){return this.vertexCount/3},enumerable:!1,configurable:!0});b.prototype.intersect=function(a,c,d,b,g,h){var e=this.geometry.id,k=g.toString();this.material.intersect(this.geometry,null,a.transform.transform,a,d,b,function(b,d,r,f){if(0<=b&&(null==c||c(a.rayBeginPoint,a.rayEndPoint,b))){var m={type:"external",metadata:{layerUid:h.layerUid,graphicUid:h.graphicUid(g)}};if(null==a.results.min.drapedLayerOrder||f>=a.results.min.drapedLayerOrder)if(null==a.results.min.dist||
b<a.results.min.dist)a.results.min.set(m,k,b,d,a.transform.transform,f,null,e,r),a.results.min.intersector="LodRenderer";0!==a.options.store&&(null==a.results.max.drapedLayerOrder||f>=a.results.max.drapedLayerOrder)&&(null==a.results.max.dist||b>a.results.max.dist)&&(a.results.max.set(m,k,b,d,a.transform.transform,f,null,e,r),a.results.min.intersector="LodRenderer");if(2===a.options.store){var p=new S.IntersectorResult(a.results.min.ray);p.set(m,k,b,d,a.transform.transform,f,null,e,r);p.intersector=
"LodRenderer";a.results.all.push(p)}}})};return b}();l.LodComponentData=G;var H=function(){function b(a,c){var b=this;this.components=[];this.minScreenSpaceRadius=c.minScreenSpaceRadius;c.components.forEach(function(c){b.components.push(new G(a,c))})}b.prototype.destroy=function(){this.components.forEach(function(a){a.destroy()})};b.prototype.intersect=function(a,c,b,k,g,h){this.components.forEach(function(d){d.intersect(a,c,b,k,g,h)})};Object.defineProperty(b.prototype,"boundingBox",{get:function(){if(!this._boundingBox){var a=
v.empty();this.components.forEach(function(c){v.expand(a,c.boundingInfo.bbMin);v.expand(a,c.boundingInfo.bbMax)});this._boundingBox=a}return this._boundingBox},enumerable:!1,configurable:!0});Object.defineProperty(b.prototype,"boundingSphere",{get:function(){if(!this._boundingSphere){var a=this.boundingBox,c=u.vec3f64.create();v.center(a,c);this._boundingSphere={center:c,radius:.5*v.diameter(a)}}return this._boundingSphere},enumerable:!1,configurable:!0});Object.defineProperty(b.prototype,"triangleCount",
{get:function(){return this.components.reduce(function(a,c){return a+c.triangleCount},0)},enumerable:!1,configurable:!0});return b}();l.LodLevelData=H;z=function(){function b(a,c,b,k){var d=this;this.type="Lod";this.isGround=!1;this._inverseViewport=O.vec2f64.create();this._levels=[];this._renderInstanceData=[];this._highlightRenderInstanceData=[];this._instanceIndex=0;this._slicePlane=!1;this._enableLevelSelection=!0;this._lastCamera=new R.default;this._updateCyclesWithStaticCamera=-1;this._needFullCycle=
!1;this.canRender=!0;this._symbol=a;this._optionalFields=c;this._metadata=b;this._instanceBufferLayout=V.getInstanceBufferLayout({instancedDoublePrecision:!0,instanced:c});this._glInstanceBufferLayout=B.glLayout(this._instanceBufferLayout,{divisor:1});this._instanceData=new f.InstanceData(this._optionalFields,k);this._instanceData.on("instance-added",function(){d.requestUpdateCycle()});this._instanceData.on("instance-removed",function(){d.requestUpdateCycle()});this._instanceData.on("instance-transform-changed",
function(a){d.requestUpdateCycle();d._metadata.notifyGraphicUpdate(a.index,2)});this._instanceData.on("instance-visibility-changed",function(a){d.requestUpdateCycle(!0);d._metadata.notifyGraphicUpdate(a.index,1)});this._instanceData.on("instance-highlight-changed",function(){d.requestUpdateCycle(!0)});this._enableLevelSelection=1<this._symbol.levels.length;l.lodRenderers.push(this)}b.prototype.destroy=function(){l.lodRenderers.splice(l.lodRenderers.indexOf(this),1)};Object.defineProperty(b.prototype,
"levels",{get:function(){return this._levels},enumerable:!1,configurable:!0});Object.defineProperty(b.prototype,"baseBoundingBox",{get:function(){return this._levels[this._levels.length-1].boundingBox},enumerable:!1,configurable:!0});Object.defineProperty(b.prototype,"baseBoundingSphere",{get:function(){return this._levels[this._levels.length-1].boundingSphere},enumerable:!1,configurable:!0});Object.defineProperty(b.prototype,"baseMaterial",{get:function(){return this._levels[this._levels.length-
1].components[0].material},enumerable:!1,configurable:!0});Object.defineProperty(b.prototype,"slicePlane",{get:function(){return this._slicePlane},set:function(a){this._slicePlane=a},enumerable:!1,configurable:!0});Object.defineProperty(b.prototype,"intersectionHandlerId",{get:function(){return this._metadata.layerUid},enumerable:!1,configurable:!0});Object.defineProperty(b.prototype,"instanceData",{get:function(){return this._instanceData},enumerable:!1,configurable:!0});Object.defineProperty(b.prototype,
"memoryUsage",{get:function(){var a={cpu:0,gpu:0};this._renderInstanceData.forEach(function(c){c=c.memoryUsage;a.cpu+=c.cpu;a.gpu+=c.gpu});this._highlightRenderInstanceData.forEach(function(c){c=c.memoryUsage;a.cpu+=c.cpu;a.gpu+=c.gpu});return a},enumerable:!1,configurable:!0});Object.defineProperty(b.prototype,"renderStats",{get:function(){var a=this,c=this._instanceData.size,b=[];this._levels.forEach(function(c,d){d=a._renderInstanceData[d].size+a._highlightRenderInstanceData[d].size;c=c.triangleCount;
b.push({renderedInstances:d,renderedTriangles:d*c,trianglesPerInstance:c})});return{totalInstances:c,renderedInstances:b.reduce(function(a,c){return a+c.renderedInstances},0),renderedTriangles:b.reduce(function(a,c){return a+c.renderedTriangles},0),levels:b}},enumerable:!1,configurable:!0});b.prototype.initializeRenderContext=function(a){var c=this;this._initContext=a;var b=a.rctx;this._symbol.levels.forEach(function(d){c._levels.push(new H(a,d));c._renderInstanceData.push(new C.RenderInstanceData(b,
c._instanceBufferLayout));c._highlightRenderInstanceData.push(new C.RenderInstanceData(b,c._instanceBufferLayout))});this._levelSelector=F(this)};b.prototype.uninitializeRenderContext=function(){this.invalidateOctree();this._levels.forEach(function(a){a.destroy()});this._renderInstanceData.forEach(function(a){a.destroy()});this._highlightRenderInstanceData.forEach(function(a){a.destroy()})};Object.defineProperty(b.prototype,"slots",{get:function(){return[4,6]},enumerable:!1,configurable:!0});Object.defineProperty(b.prototype,
"needsHighlight",{get:function(){return 0<this._highlightRenderInstanceData.reduce(function(a,c){return a+c.size},0)},enumerable:!1,configurable:!0});b.prototype.prepareRender=function(a){this.runUpdates(a)};b.prototype.render=function(a){var c=this,b=a.rctx,k=4===a.slot?3:6===a.slot?5:null;if(k){if(!this.baseMaterial.isVisible()||!this.baseMaterial.isVisibleInPass(a.pass))return!1;var g=a.camera;this._inverseViewport[0]=1/g.fullViewport[2];this._inverseViewport[1]=1/g.fullViewport[3];var h={slot:k,
origin:[0,0,0],camera:g,inverseViewport:this._inverseViewport,shadowMap:a.shadowMap,shadowMappingEnabled:!!a.shadowMap&&a.shadowMap.enabled,ssaoEnabled:!!a.ssaoHelper&&a.ssaoHelper.enabled,screenToWorldRatio:null,screenToWorldRatioGlobalWM:null,slicePlane:a.sliceHelper&&a.sliceHelper.plane,hudVisibilityTexture:a.offscreenRenderingHelper?a.offscreenRenderingHelper.hudVisibilityTexture:null,highlightDepthTexture:a.offscreenRenderingHelper?a.offscreenRenderingHelper.depthTexture:null,hasOccludees:!1,
linearDepthTexture:null,linearDepthTextureID:0,lastFrameColorTexture:null,lastFrameColorTextureID:0,reprojectionMat:null,ssrEnabled:!1,lighting:a.scenelightingData};b.bindVAO();for(var b=function(b){var d=a.isHighlightPass?e._highlightRenderInstanceData[b]:e._renderInstanceData[b];e._levels[b].components.forEach(function(e){c.renderComponent(a,k,h,d,e,b)})},e=this,g=0;g<this._levels.length;++g)b(g);return!0}};b.prototype.intersect=function(a,c,b,k){var d=this;if(this.baseMaterial.isVisible()){var h=
u.vec3f64.create();t.vec3.subtract(h,k,b);var e=function(e){d._instanceData.getCombinedModelTransform(e,I);a.transform.set(I);t.vec3.transformMat4(J,b,a.transform.inverse);t.vec3.transformMat4(K,k,a.transform.inverse);var g=d._instanceData.getState(e),h=d._instanceData.getLodLevel(e);w.assert(g&f.StateFlags.ACTIVE,"invalid instance state");w.assert(0<=h&&h<d._levels.length,"invaid lod level");d._levels[h].intersect(a,c,J,K,e,d._metadata)};this.baseMaterial.getParameters().verticalOffset?this.octree.forEach(e):
this.octree.forEachAlongRay(b,h,e)}};b.prototype.queryDepthRange=function(a){return this.queryDepthRangeOctree(a)};b.prototype.notifyShaderTransformationChanged=function(){this.invalidateOctree()};b.prototype.requestUpdateCycle=function(a){void 0===a&&(a=!1);this._updateCyclesWithStaticCamera=-1;a&&(this._needFullCycle=!0);this.needsUpdates&&this._initContext.requestRender()};Object.defineProperty(b.prototype,"needsUpdates",{get:function(){return 0<this._instanceData.size&&1>this._updateCyclesWithStaticCamera},
enumerable:!1,configurable:!0});b.prototype.runUpdates=function(a){if(!A.LOD_INSTANCE_RENDERER_DISABLE_UPDATES){if(this._enableLevelSelection){var c=a.equals(this._lastCamera);this._lastCamera.copyFrom(a);c||this.requestUpdateCycle()}c=this._needFullCycle?this._instanceData.size:2E3;this._needFullCycle=!1;this.updateInstances(a,c);this.needsUpdates&&this._initContext.requestRender()}};Object.defineProperty(b.prototype,"octree",{get:function(){this._octree||(this._octree=this.buildOctree());return this._octree},
enumerable:!1,configurable:!0});b.prototype.invalidateOctree=function(){this._octree&&(this._octree.destroy(),this._octree=null)};b.prototype.buildOctree=function(){for(var a=new T.InstanceOctree(this._instanceData,this.baseBoundingSphere),c=this._instanceData,c=c.view?c.view.state:null,b=0;b<this._instanceData.capacity;++b)c.get(b)&f.StateFlags.ACTIVE&&a.addInstance(b);return a};b.prototype.queryDepthRangeOctree=function(a){var c=a.eye,b=a.viewForward,k=this.octree.findClosest(b,"front-to-back",
a.frustum),g=this.octree.findClosest(b,"back-to-front",a.frustum);return null!=k&&null!=g?(this._instanceData.view.boundingSphere.getVec(k,q),t.vec3.subtract(q,q,c),k=t.vec3.dot(q,b)-q[3],this._instanceData.view.boundingSphere.getVec(g,q),t.vec3.subtract(q,q,c),c=t.vec3.dot(q,b)+q[3],{near:Math.max(a.near,k),far:Math.min(a.far,c)}):{near:Infinity,far:-Infinity}};b.prototype.startUpdateCycle=function(){this._updateCyclesWithStaticCamera++;this._renderInstanceData.forEach(function(a){a.startUpdateCylce()});
this._highlightRenderInstanceData.forEach(function(a){a.startUpdateCylce()});this.needsUpdates&&this._initContext.requestRender()};b.prototype.updateInstances=function(a,b){var c=this._enableLevelSelection,k=this._levelSelector;k.updateCamera(a);this._renderInstanceData.forEach(function(a){a.beginUpdate()});this._highlightRenderInstanceData.forEach(function(a){a.beginUpdate()});a=this._instanceData;var g=this._instanceData.view,h=a.capacity,e=this._instanceIndex;b=Math.min(a.size,b);for(var r=0;r<
b;++r){0===e&&this.startUpdateCycle();var p=g.state.get(e),m=0;if(p&f.StateFlags.ALLOCATED){var n=g.lodLevel.get(e);p&f.StateFlags.ACTIVE&&this._renderInstanceData[n].freeTail();p&f.StateFlags.HIGHLIGHT_ACTIVE&&this._highlightRenderInstanceData[n].freeTail();if(p&f.StateFlags.REMOVE)a.freeInstance(e);else if(p&f.StateFlags.VISIBLE){n=0;c&&(g.modelOrigin.getVec(e,L),n=k.selectLevel(L,a.getCombinedMedianScaleFactor(e)));m=p&~(f.StateFlags.ACTIVE|f.StateFlags.HIGHLIGHT_ACTIVE|f.StateFlags.TRANSFORM_CHANGED);
if(0<=n){var l=this._renderInstanceData[n],q=l.allocateHead();E(g,e,l.view,q);m|=f.StateFlags.ACTIVE;p&f.StateFlags.HIGHLIGHT&&(l=this._highlightRenderInstanceData[n],q=l.allocateHead(),E(g,e,l.view,q),m|=f.StateFlags.HIGHLIGHT_ACTIVE)}g.state.set(e,m);g.lodLevel.set(e,n)}else m=p&~(f.StateFlags.ACTIVE|f.StateFlags.HIGHLIGHT_ACTIVE|f.StateFlags.TRANSFORM_CHANGED),g.state.set(e,m);this._octree&&(n=!!(p&f.StateFlags.ACTIVE),m=!!(m&f.StateFlags.ACTIVE),!n&&m?this._octree.addInstance(e):n&&!m?this._octree.removeInstance(e):
n&&m&&p&f.StateFlags.TRANSFORM_CHANGED&&(this._octree.removeInstance(e),this._octree.addInstance(e)));e=(e+1)%h}else e=(e+1)%h,b++}this._instanceIndex=e;this._renderInstanceData.forEach(function(a){a.endUpdate()});this._highlightRenderInstanceData.forEach(function(a){a.endUpdate()})};b.prototype.renderComponent=function(a,b,d,k,g,h){var c=g.glMaterials.get(a.pass);if(c&&c.beginSlot(b)&&0!==k.size){var f=a.rctx,l=f.capabilities.instancing;c.ensureParameters(d);var m=c.getTechnique();b=c.getPipelineState(b);
f.setPipelineState(b);c.bind(f,d);f.bindVAO(g.vao);m.ensureAttributeLocations(g.vao);c=m.program;a.isHighlightPass&&Q.OutputHighlight.bindOutputHighlight(f,c,d);m.bindDraw(d);A.LOD_INSTANCE_RENDERER_COLORIZE_BY_LEVEL&&0===a.pass&&(c.setUniform4fv("externalColor",M[Math.min(h,M.length-1)]),c.setUniform1i("colorMixMode",W.colorMixModes.replace));a=k.capacity;d=k.headIndex;h=k.tailIndex;var c=k.firstIndex,n=this._glInstanceBufferLayout;b=function(a,b){D.bindVertexBufferLayout(f,x.Default3D,k.buffer,
n,a);l.drawArraysInstanced(m.primitiveType,0,g.vertexCount,b-a);D.unbindVertexBufferLayout(f,x.Default3D,k.buffer,n)};g.material.getParameters().transparent&&null!=c?d>h?(w.assert(c>=h&&c<=d,"invalid firstIndex"),b(c,d),b(h,c)):d<h&&(c<=d?(w.assert(0<=c&&c<=d,"invalid firstIndex"),b(c,d),b(h,a),b(0,c)):(w.assert(c>=h&&c<=a,"invalid firstIndex"),b(c,a),b(0,d),b(h,c))):d>h?b(h,d):d<h&&(b(0,d),b(h,a));f.bindVAO(null)}};return b}();l.LodRenderer=z;l.lodRenderers=[];var L=u.vec3f64.create(),q=P.vec4f64.create(),
I=N.mat4f64.create(),J=u.vec3f64.create(),K=u.vec3f64.create(),M=[[1,0,1,1],[0,0,1,1],[0,1,0,1],[1,1,0,1],[1,0,0,1]]});