// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.17/esri/copyright.txt for details.
//>>built
define("require exports ../../../core/mathUtils ../../../core/maybe ../../../core/libs/gl-matrix-2/vec2 ../../../core/libs/gl-matrix-2/vec2f64 ../../../layers/support/layerUtils ../../webgl ../../2d/engine/vectorTiles/tileRendererHelper3D ../support/StreamDataLoader ./BlendLayersTechnique ./RasterColorizerTechnique ./terrainUtils ./terrainUtils ./TileTexture ./support/FBOPool ../webgl-engine/lib/DefaultVertexBufferLayouts ../webgl-engine/lib/glUtil3D ../../webgl/rasterUtils ../../webgl/Util".split(" "),
function(O,P,F,p,B,C,G,x,H,I,y,D,u,J,t,K,L,v,M,N){function z(c,a,b){b.layerIndex=a;var d=c.layerInfo[1][a];return d.data?(B.vec2.set(b.offset,0,0),b.tile=c,b.scale=1,b.sourceLod=c.lij,b.sourceLayerInfo=d,b):(c=d.upsampleInfo)?(a=c.tile.layerInfo[1][a],b.tile=c.tile,B.vec2.copy(b.offset,c.offset),b.scale=c.scale,b.sourceLod=c.tile.lij,b.sourceLayerInfo=a,b):null}var E=[],A={tile:null,sourceLayerInfo:null,sourceLod:null,offset:[0,0],scale:1,layerIndex:0};return function(){function c(a,b,d){this._rctx=
a;this.tileSize=b;this._blackTex=this._backgroundTexture=null;this._vectorTileHelper=new H.VectorTileRendererHelper3D;this._rctx.capabilities.textureFilterAnisotropic&&(this._maxAnisotropy=this._rctx.parameters.maxMaxAnisotropy);this._vaoQuad=v.createQuadVAO(this._rctx,L.Pos2Tex);a=new y.BlendLayersTechniqueConfiguration;a.mode=2;this._blendLayersTechnique=d.acquireAndReleaseExisting(y.BlendLayersTechnique,a,this._blendLayersTechnique);a.mode=1;this._applyOpacityTechnique=d.acquireAndReleaseExisting(y.BlendLayersTechnique,
a,this._applyOpacityTechnique);this._techniqueRep=d;this._blackTex=new t.TileTexture(v.createColorTexture(this._rctx,[0,0,0,1]));this._fboPool=new K.FBOPool(this._rctx)}c.prototype.dispose=function(){this._fboPool&&(this._fboPool.clear(),this._fboPool=null);this._vaoQuad&&(this._vaoQuad.dispose(),this._vaoQuad=null);p.isSome(this._backgroundTexture)&&(this._backgroundTexture.release(),this._backgroundTexture=null);this._blackTex&&(this._blackTex.release(),this._blackTex=null);this._blendLayersTechnique&&
(this._blendLayersTechnique.dispose(),this._blendLayersTechnique=null);this._applyOpacityTechnique&&(this._applyOpacityTechnique.dispose(),this._applyOpacityTechnique=null);this._rasterColorizerTechnique&&(this._rasterColorizerTechnique.dispose(),this._rasterColorizerTechnique=null);this._vectorTileHelper&&(this._vectorTileHelper.dispose(),this._vectorTileHelper=null)};c.prototype.updateTileTexture=function(a){for(var b=a.layerInfo[1],d=0;d<b.length;d++)b[d].pendingUpdates&=-65;if(a.renderData){for(var g=
a.surface,e=g.baseOpacity,c=0,d=0,f=this.tileSize,w=!1,l=g.view.pixelRatio,k=b.length,h=0;h<b.length&&!w;h++){var q=g.layerViewByIndex(h,1),r=q.fullOpacity;E[h]=r;G.isBaseLayer(q.layer)&&k>=b.length&&(k=h);if(0!==r){++d;var m=z(a,h,A);m&&(u.isVectorTileLayerView(q)?f=Math.max(f,this.tileSize*l):1===e&&1===r&&(q.isOpaque||this._dataToTexture(m)&&p.isSome(m.sourceLayerInfo.data)&&m.sourceLayerInfo.data.descriptor.isOpaque)&&(w=!0),++c)}}this._cleanupFBOPool(l,b.length);e=f;f=F.nextHighestPowerOfTwo(e);
b=f*f;g=e*e;b===g?f=e:(e=f/2,f=b-g<g-e*e?f:e);b=f/this.tileSize;--h;if(0===c){c=0;if(a.surface.view.layerViewManager.updating||0<d)c=5E3;this._backgroundTexture&&p.isNone(a.renderData.textureReference)&&(c=0);this._useBackgroundTexture(a,c)}else 1===c&&w?this._useLayerTexture(a,h):this._composeMapLayers(a,h,k,w,E,f,b)}};c.prototype.setBackground=function(a){p.isSome(this._backgroundTexture)&&this._backgroundTexture.release();this._backgroundTexture=a instanceof HTMLImageElement?this._buildTexture(a):
new t.TileTexture(v.createColorTexture(this._rctx,a))};c.prototype._buildTexture=function(a){if(p.isNone(a))return null;var b={target:3553,pixelFormat:6408,dataType:5121,wrapMode:33071,samplingMode:9987,maxAnisotropy:this._maxAnisotropy,flipped:!0,hasMipmap:!0},d=this._rctx,c;if("number"===typeof a)b.width=b.height=a,c=new t.TileTexture(new x.Texture(d,b));else if(a instanceof I.ImageWithType)b.isOpaque=a.isOpaque,c=new t.TileTexture(new x.Texture(d,b,a.image)),a.release();else try{c=new t.TileTexture(new x.Texture(d,
b,a))}catch(e){c=new t.TileTexture(v.createEmptyTexture(d)),console.warn("TileRenderer: failed to execute 'texImage2D', cross-origin image may not be loaded.")}d.bindTexture(c.texture);c.generateMipmap();return c};c.prototype._drawQuad=function(a){this._rctx.bindVAO(this._vaoQuad);a.assertCompatibleVertexAttributeLocations(this._vaoQuad);this._rctx.drawArrays(5,0,N.vertexCount(this._vaoQuad,"geometry"))};c.prototype._drawRasterData=function(a,b,d,c,e){void 0===e&&(e=1);if(!p.isNone(b)){var g=this._rctx,
f=a.program;g.setPipelineState(a.pipeline);g.bindProgram(f);g.bindTexture(b,0);f.setUniform1i("tex",0);f.setUniform1f("scale",d);f.setUniform2f("offset",c[0],c[1]);f.setUniform1f("opacity",e);this._drawQuad(f)}};c.prototype._drawImageryTileData=function(a,b){void 0===b&&(b=1);var d=a.sourceLayerInfo.data;if(!p.isNone(d)&&d.source){a.tile.surface.layerViewByIndex(a.layerIndex,1).ensureSymbolizerParameters(d);var c=this._getRasterColorizerTechnique(d.symbolizerParameters.type,!!d.symbolizerParameters.colormap),
e=this._rctx,n=c.program;e.setPipelineState(c.pipeline);e.bindProgram(n);d.bind(e)&&(d.opacity=b,d.scale=a.scale,d.offset=a.offset,a=d.getTextures(),M.setTextures(e,n,a.names,a.textures),d=d.getUniforms(),c.bindPass(e,d),this._drawQuad(n),e.bindVAO())}};c.prototype._getRasterColorizerTechnique=function(a,b){a=["stretch","lut","hillshade"].indexOf(a);this._rasterColorizerConfig||(this._rasterColorizerConfig=new D.RasterColorizerTechniqueConfiguration,this._rctx.gl.getExtension("WEBGL_color_buffer_float"),
this._rctx.gl.getExtension("OES_texture_float"));this._rasterColorizerConfig.colorizerType=a;this._rasterColorizerConfig.applyColormap=b;return this._rasterColorizerTechnique=this._techniqueRep.acquireAndReleaseExisting(D.RasterColorizerTechnique,this._rasterColorizerConfig,this._rasterColorizerTechnique)};c.prototype._drawVectorData=function(a,b,c,g,e,n,f){var d=b.sourceLayerInfo.data;if(p.isNone(d))return f;var l=this._rctx,k=b.tile.surface.layerViewByIndex(b.layerIndex,1),h;l.setPipelineState(a.pipeline);
var q=1>g;q?(h=this._fboPool.acquire(e),l.bindFramebuffer(h),l.setClearColor(1,1,1,0),l.clearSafe(16640)):f&&l.clearSafe(256);this._vectorTileHelper.render(l,b.sourceLod,d,k.painter,k.layer.styleRepository,k.schemaHelper,Math.round(1/b.scale),b.offset,this.tileSize,c);return q?(l.bindFramebuffer(n),this._drawRasterData(a,h.colorTexture,1,[0,0],g),this._fboPool.release(h),f):!0};c.prototype._useBackgroundTexture=function(a,b){a.renderData.opacity=a.surface.baseOpacity;a.renderData.setTextureReference(this._backgroundTexture,
0,0,1,b)};c.prototype._useLayerTexture=function(a,b){a.renderData.opacity=a.surface.baseOpacity;b=z(a,b,A);if(this._dataToTexture(b)){var c=b.offset;a.renderData.setTextureReference(b.sourceLayerInfo.data,c[0],c[1],b.scale)}};c.prototype._composeMapLayers=function(a,b,c,g,e,n,f){var d=this,l=a.renderData.ensureTexture(n,function(){return d._buildTexture(n)});if(!p.isNone(l)){var k=this._rctx,h=this._fboPool.acquire(n);k.bindFramebuffer(h);k.setViewport(0,0,n,n);k.setClearColor(0,0,0,0);k.setClearDepth(1);
k.clearSafe(16640);var q=!1;!g&&p.isSome(this._backgroundTexture)&&this._drawRasterData(this._blendLayersTechnique,this._backgroundTexture.texture,1,C.vec2f64.ZEROS);g=a.surface.baseOpacity;for(var r=!1;0<=b;b--){var m=z(a,b,A);m&&(b<c&&1>g&&!r&&(this._drawRasterData(this._applyOpacityTechnique,this._blackTex.texture,1,C.vec2f64.ZEROS,g),r=!0),0!==e[b]&&(u.isVectorTileRenderInfo(m)?q=this._drawVectorData(this._blendLayersTechnique,m,f,e[b],n,h,q):u.isImageryTileRenderInfo(m)?this._drawImageryTileData(m,
e[b]):this._dataToTexture(m)&&p.isSome(m.sourceLayerInfo.data)&&this._drawRasterData(this._blendLayersTechnique,m.sourceLayerInfo.data.texture,m.scale,m.offset,e[b])))}k.bindTexture(l.texture);c=l.descriptor;k.gl.copyTexImage2D(k.gl.TEXTURE_2D,0,c.pixelFormat,0,0,c.width,c.height,0);l.generateMipmap();k.bindFramebuffer(null);this._fboPool.release(h);a.renderData.opacity=r?1:g;a.renderData.setTextureReference(l,0,0,1)}};c.prototype._dataToTexture=function(a){J.isRasterTileRenderInfo(a)&&this._rasterDataToTexture(a);
return u.isTextureTileRenderInfo(a)};c.prototype._rasterDataToTexture=function(a){var b=a.sourceLayerInfo;b.data=this._buildTexture(b.data);a.tile.setMemoryDirty()};c.prototype._cleanupFBOPool=function(a,b){if(a!==this._lastPixelRatio||b!==this._lastNumLayers)this._fboPool.clear(),this._lastPixelRatio=a,this._lastNumLayers=b};Object.defineProperty(c.prototype,"test",{get:function(){return{backgroundTexture:this._backgroundTexture}},enumerable:!1,configurable:!0});return c}()});