// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.17/esri/copyright.txt for details.
//>>built
define("require exports tslib ../../../core/Error ../../../core/Logger ../../../core/promiseUtils ../../../core/accessorSupport/decorators ../../../geometry/Extent ../../../layers/support/ExportWMSImageParameters ../engine/BitmapContainer ./LayerView2D ./support/ExportStrategy ../../layers/LayerView ../../layers/RefreshableLayerView ../../layers/WMSLayerView".split(" "),function(B,C,b,p,q,g,c,r,t,u,v,w,x,y,z){var A=q.getLogger("esri.views.2d.layers.WMSLayerView2D");return function(d){function a(){return null!==
d&&d.apply(this,arguments)||this}b.__extends(a,d);a.prototype.initialize=function(){var a=this.layer;a.supportsSpatialReference(this.view.spatialReference)||this.addResolvingPromise(g.reject(new p("layerview:spatial-reference-incompatible","The spatial references supported by this WMS layer are incompatible with the spatial reference of the view",{layer:a})))};a.prototype.hitTest=function(){return null};a.prototype.update=function(a){this.strategy.update(a).catch(function(a){g.isAbortError(a)||A.error(a)})};
a.prototype.attach=function(){var a=this,e=this.layer,b=this.view,l=e.imageMaxHeight,f=e.imageMaxWidth;this._bitmapContainer=new u.BitmapContainer;this.container.addChild(this._bitmapContainer);this.strategy=new w({container:this._bitmapContainer,fetchSource:this.fetchImage.bind(this),requestUpdate:this.requestUpdate.bind(this),imageMaxHeight:l,imageMaxWidth:f,imageRotationSupported:!1,imageNormalizationSupported:!1,hidpi:!1});this._exportWMSImageParameters=new t({layer:e,view:b});this.handles.add(this._exportWMSImageParameters.watch("version",
function(b){a._exportImageVersion!==b&&(a._exportImageVersion=b,a.requestUpdate())}),"wms")};a.prototype.detach=function(){this.handles.remove("wms");this.strategy.destroy();this._exportWMSImageParameters.layer=null;this._exportWMSImageParameters.destroy();this._exportWMSImageParameters=null;this.container.removeChild(this._bitmapContainer);this._bitmapContainer.removeAllChildren()};a.prototype.moveStart=function(){};a.prototype.viewChange=function(){};a.prototype.moveEnd=function(){this.requestUpdate()};
a.prototype.createFetchPopupFeaturesQuery=function(a){var b=a.x,k=a.y,l=this.view.spatialReference,f=null,c=0,d=0;this._bitmapContainer.children.some(function(a){var e=a.width,g=a.height,h=a.resolution,m=a.x;a=a.y;var n=m+h*e,h=a-h*g;return b>=m&&b<=n&&k<=a&&k>=h?(f=new r({xmin:m,ymin:h,xmax:n,ymax:a,spatialReference:l}),c=e,d=g,!0):!1});a=f.width/c;return{extent:f,width:c,height:d,x:Math.round((b-f.xmin)/a),y:Math.round((f.ymax-k)/a)}};a.prototype.doRefresh=function(){return b.__awaiter(this,void 0,
void 0,function(){return b.__generator(this,function(a){this.requestUpdate();return[2]})})};a.prototype.isUpdating=function(){return this.strategy.updating||this.updateRequested};a.prototype.fetchImage=function(a,e,c,d){return this.layer.fetchImage(a,e,c,b.__assign({timeExtent:this._exportWMSImageParameters.timeExtent,timestamp:this.refreshTimestamp},d))};b.__decorate([c.property()],a.prototype,"strategy",void 0);b.__decorate([c.property({dependsOn:["strategy.updating"]})],a.prototype,"updating",
void 0);return a=b.__decorate([c.subclass("esri.views.2d.layers.WMSLayerView2D")],a)}(z.WMSLayerView(y.RefreshableLayerView(v.LayerView2DMixin(x))))});