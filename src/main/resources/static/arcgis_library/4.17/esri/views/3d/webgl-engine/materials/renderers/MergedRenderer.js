// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.17/esri/copyright.txt for details.
//>>built
define("require exports ../../../../../core/MapUtils ../../../../../core/MapUtils ../../../../../core/maybe ../../../../../core/maybe ../../../../../core/libs/gl-matrix-2/mat4 ../../../../../core/libs/gl-matrix-2/mat4f64 ../../../support/buffer/glUtil ../../lib/renderStats ../../lib/ResizableFloat32Array ../../lib/Util ../WaterGLMaterial ./Instance ./utils ../../../../webgl/BufferObject ../../../../webgl/Util ../../../../webgl/VertexArrayObject".split(" "),function(C,P,E,r,w,x,y,z,F,D,G,v,H,u,A,I,
J,K){function L(f,b,a,g){for(var k=new Map,e=b.vertexBufferLayout.stride/4,l=function(a,g){var c=a.origin,d=f.get(c.id),h=k.get(c.id);null==h&&(h={optimalCount:null==d?0:d.optimalCount,sparseCount:null==d?0:d.buffer.size,toAdd:[],toRemove:[],origin:c.vec3},k.set(c.id,h));c=b.elementCount(a.data)*e;g?(h.optimalCount+=c,h.sparseCount+=c,h.toAdd.push(a)):(h.optimalCount-=c,h.toRemove.push(a))},m=0;m<a.length;m++){var d=a[m];l(d,!0)}for(a=0;a<g.length;a++)d=g[a],l(d,!1);return k}C=function(){function f(b,
a,g){this.type="MergedRenderer";this._dataByOrigin=new Map;this._hasOccludees=this._hasHighlights=!1;this._rctx=b;this._material=g;this._materialRep=a;this._glMaterials=A.acquireMaterials(this._material,this._materialRep);this._bufferWriter=g.createBufferWriter()}f.prototype.dispose=function(){A.releaseMaterials(this._material,this._materialRep);this._dataByOrigin&&(this._dataByOrigin.forEach(function(b){b.vao.dispose(!0);b.vao=null}),this._dataByOrigin.clear(),this._dataByOrigin=null);this._glMaterials&&
(this._glMaterials.forEach(function(b){b&&b.dispose()}),this._glMaterials.clear(),this._glMaterials=null)};Object.defineProperty(f.prototype,"isEmpty",{get:function(){return 0===this._dataByOrigin.size},enumerable:!1,configurable:!0});Object.defineProperty(f.prototype,"hasHighlights",{get:function(){return this._hasHighlights},enumerable:!1,configurable:!0});Object.defineProperty(f.prototype,"hasOccludees",{get:function(){return this._hasOccludees},enumerable:!1,configurable:!0});Object.defineProperty(f.prototype,
"hasWater",{get:function(){return!this.isEmpty&&r.someMap(this._glMaterials,function(b){return b instanceof H.WaterGLMaterial})},enumerable:!1,configurable:!0});Object.defineProperty(f.prototype,"rendersOccluded",{get:function(){return!this.isEmpty&&1!==this._material.renderOccluded},enumerable:!1,configurable:!0});f.prototype.modify=function(b){this.updateGeometries(b.toUpdate);this.addAndRemoveGeometries(b.toAdd,b.toRemove);this.updateRenderCommands()};f.prototype.addAndRemoveGeometries=function(b,
a){var g=this,k=this._bufferWriter,e=k.vertexBufferLayout,l=e.stride/4,m=this._dataByOrigin,d=L(m,k,b,a);d.forEach(function(a,b){d.delete(b);var c=a.optimalCount,k=a.sparseCount,h=m.get(b);null==h&&(v.assert(0<c),h=g.createData(e,c,a.origin),m.set(b,h));if(0===c)h.vao.dispose(!0),h.vao=null,m.delete(b);else{var f=c<a.sparseCount/2;b=M;var q=h.buffer.size,N=h.buffer.array,c=h.buffer.resize(f?c:k,!1);f||c?g.removeAndRebuild(h,a.toRemove,l,N,b):0<a.toRemove.length?(g.removeByErasing(h,a.toRemove,l,b),
0<a.toAdd.length&&(b.end=q)):(b.begin=q,b.end=q);c=O;v.setMatrixTranslation3(c,-a.origin[0],-a.origin[1],-a.origin[2]);g.append(h,a.toAdd,l,c,b);a=h.vao.vertexBuffers.geometry;a.byteSize!==h.buffer.array.buffer.byteLength?a.setData(h.buffer.array):(c=b.begin,b=b.end,c<b&&(c*=4,a.setSubData(h.buffer.array,c,c,4*b)));h.drawCommandsDirty=!0}})};f.prototype.updateGeometries=function(b){for(var a=this._bufferWriter,g=a.vertexBufferLayout.stride/4,k=0;k<b.length;k++){var e=b[k],l=e.updateType,e=e.renderGeometry,
m=this._dataByOrigin.get(e.origin.id),d=m&&m.instances.get(e.uniqueName);if(!d)break;l&1&&(d.isVisible=e.instanceParameters.visible);if(l&9){var c=e.instanceParameters.visible;d.hasHighlights=!!e.instanceParameters.highlights&&c}l&16&&(d.hasOccludees=!!e.instanceParameters.occludees);l&6&&(l=m.buffer.array,c=m.vao,A.calculateTransformRelToOrigin(e,B,t),a.write({transformation:B,invTranspTransformation:t},e.data,a.vertexBufferLayout.createView(l.buffer),d.from),v.assert(d.from+a.elementCount(e.data)===
d.to,"material VBO layout has changed"),c.vertexBuffers.geometry.setSubData(l,d.from*g*4,d.from*g*4,d.to*g*4));m.drawCommandsDirty=!0}};f.prototype.updateRenderCommands=function(){this._dataByOrigin.forEach(function(a){a.hasHiddenInstances=r.someMap(a.instances,function(a){return!a.isVisible});a.hasHighlights=r.someMap(a.instances,function(a){return a.isVisible&&a.hasHighlights});a.hasOccludees=r.someMap(a.instances,function(a){return a.isVisible&&a.hasOccludees})});this._hasHighlights=r.someMap(this._dataByOrigin,
function(a){return a.hasHighlights});this._hasOccludees=r.someMap(this._dataByOrigin,function(a){return a.hasOccludees});var b=function(a){a.drawCommandsDefault=null;a.drawCommandsHighlight=null;a.drawCommandsOccludees=null;a.stats={default:0,highlight:0,occludees:0};if(0!==a.instances.size)if(a.hasOccludees||a.hasHighlights||a.hasHiddenInstances){var b=u.sortInstancesAccordingToRange(E.valuesOfMap(a.instances));a.drawCommandsDefault=[];a.drawCommandsHighlight=[];a.drawCommandsOccludees=[];for(var k=
0;k<b.length;k++){var e=b[k];e.isVisible&&(e.hasOccludees?u.addOrMerge(a.drawCommandsOccludees,e):u.addOrMerge(a.drawCommandsDefault,e),e.hasHighlights&&u.addOrMerge(a.drawCommandsHighlight,e))}b=function(a){for(var b=0,d=0;d<a.length;d++)b+=a[d].count;return b/3};a.stats={default:b(a.drawCommandsDefault),highlight:b(a.drawCommandsHighlight),occludees:b(a.drawCommandsOccludees)}}else b=4*a.buffer.size/J.getStride(a.vao.layout.geometry),a.drawCommandsDefault=[{first:0,count:b}],a.stats={default:b,
highlight:0,occludees:0}};this._dataByOrigin.forEach(function(a){a.drawCommandsDirty&&(b(a),a.drawCommandsDirty=!1)})};f.prototype.updateLogic=function(b){return this._material.update(b)};f.prototype.render=function(b,a,g,k){var e=this,l=this._rctx,m=this._glMaterials.get(a.pass),d=4===a.pass,c=b;2===a.pass&&null===c&&(c=22);if(!m||2!==m.ensureResources(l)||null!=c&&!m.beginSlot(c)||d&&!this._hasHighlights)return!1;m.ensureParameters(g);var f=m.getTechnique(),p=m.getPipelineState(c,!1);l.setPipelineState(p);
m.bind(l,g);var n=!1;this._dataByOrigin.forEach(function(a){if(!(w.isNone(a.drawCommandsDefault)&&w.isNone(a.drawCommandsHighlight)&&w.isNone(a.drawCommandsOccludees)||d&&!a.hasHighlights)){g.origin=a.origin;f.bindDraw(g);f.ensureAttributeLocations(a.vao);l.bindVAO(a.vao);var b=f.primitiveType,h=d?a.drawCommandsHighlight:a.drawCommandsDefault,q=d?a.stats.highlight:a.stats.default;x.isSome(h)&&(e.renderCommands(l,b,h),D.addToRenderStats(h.length,q,k),n=!0);d||(h=a.drawCommandsOccludees,x.isSome(h)&&
(q=m.getPipelineState(c,!0),l.setPipelineState(q),e.renderCommands(l,b,h),l.setPipelineState(p),D.addToRenderStats(h.length,a.stats.occludees,k),n=!0))}});return n};f.prototype.renderCommands=function(b,a,g){for(var k=0;k<g.length;k++)b.drawArrays(a,g[k].first,g[k].count)};f.prototype.createData=function(b,a,g){return{instances:new Map,vao:new K(this._rctx,this._material.vertexAttributeLocations,{geometry:F.glLayout(b)},{geometry:I.createVertex(this._rctx,35044)}),buffer:new G.ResizableFloat32Array(a),
optimalCount:0,origin:g,hasHiddenInstances:!1,hasHighlights:!1,hasOccludees:!1,drawCommandsDirty:!1,drawCommandsDefault:null,drawCommandsOccludees:null,drawCommandsHighlight:null,stats:{default:0,highlight:0,occludees:0}}};f.prototype.removeAndRebuild=function(b,a,g,k,e){for(var l=0;l<a.length;l++){var m=a[l].uniqueName,d=b.instances.get(m);b.optimalCount-=(d.to-d.from)*g;b.instances.delete(m)}var c=0,f=b.buffer.array;e.begin=0;e.end=0;var p=-1,n=-1,h=0;b.instances.forEach(function(a){var b=a.from*
g,d=a.to*g,e=d-b;p!==n&&n!==b?(f.set(k.subarray(p,n),h),h+=n-p,p=b):-1===p&&(p=b);n=d;a.from=c/g;c+=e;a.to=c/g});p!==n&&f.set(k.subarray(p,n),h);e.end=c};f.prototype.removeByErasing=function(b,a,g,k){k.begin=Infinity;k.end=-Infinity;for(var e=-1,l=-1,m=0;m<a.length;m++){var d=a[m].uniqueName,c=b.instances.get(d),f=c.from*g,c=c.to*g;e!==l&&l!==f?(b.buffer.erase(e,l),e=f):-1===e&&(e=f);l=c;b.instances.delete(d);b.optimalCount-=c-f;f<k.begin&&(k.begin=f);c>k.end&&(k.end=c)}e!==l&&b.buffer.erase(e,l)};
f.prototype.append=function(b,a,g,f,e){for(var l=this._bufferWriter,k=0;k<a.length;k++){var d=a[k],c=x.isSome(d.transformation)?y.mat4.multiply(B,f,d.transformation):f;y.mat4.invert(t,c);y.mat4.transpose(t,t);var q=e.end;l.write({transformation:c,invTranspTransformation:t},d.data,l.vertexBufferLayout.createView(b.buffer.array.buffer),e.end/g);var c=l.elementCount(d.data)*g,p=q+c;v.assert(null==b.instances.get(d.uniqueName));var n=d.instanceParameters.visible,q=new u.Instance(q/g,p/g,n,!!d.instanceParameters.highlights&&
n,!!d.instanceParameters.occludees);b.instances.set(d.uniqueName,q);b.optimalCount+=c;e.end+=c}};Object.defineProperty(f.prototype,"test",{get:function(){return{material:this._material,glMaterials:this._glMaterials}},enumerable:!1,configurable:!0});return f}();var M={begin:0,end:0},O=z.mat4f64.create(),B=z.mat4f64.create(),t=z.mat4f64.create();return C});