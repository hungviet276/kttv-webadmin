// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.17/esri/copyright.txt for details.
//>>built
define("require exports tslib ../../../../TimeExtent ../../../../core/has ../../../../core/maybe ../../../../core/promiseUtils ../../../../core/accessorSupport/diffUtils ../../../../tasks/support/Query ../../engine/webgl/definitions ./sources/createSource ./support/UpdateToken".split(" "),function(r,p,g,z,A,q,B,n,C,t,D,u){function v(d,a){var b=[];b.push(new l([0,0],d,null));if(0===a)return b;a=Math.min(a,t.TILE_SIZE);var c=t.TILE_SIZE;b.push(new l([-c,-c],d.neighbor(-1,-1),[c-a,c-a,c,c]));b.push(new l([0,
-c],d.neighbor(0,-1),[0,c-a,c,c]));b.push(new l([c,-c],d.neighbor(1,-1),[0,c-a,a,c]));b.push(new l([-c,0],d.neighbor(-1,0),[c-a,0,c,c]));b.push(new l([c,0],d.neighbor(1,0),[0,0,a,c]));b.push(new l([-c,c],d.neighbor(-1,1),[c-a,0,c,a]));b.push(new l([0,c],d.neighbor(0,1),[0,0,c,a]));b.push(new l([c,c],d.neighbor(1,1),[0,0,a,a]));return b}Object.defineProperty(p,"__esModule",{value:!0});p.Source2D=void 0;var w=0,E=function(){function d(a,b){this.didSend=!1;this.dataTileCount=0;this.update=u.UpdateToken.all();
this._abortController=new AbortController;this.invalid=!1;this.displayTile=a;this._pixelBuffer=b;this.partitions=v(a,b)}d.prototype.setUpdate=function(a,b){this.update=a;this.dataTileCount=0;b!==this._pixelBuffer&&(this._pixelBuffer=b,this.partitions=v(this.displayTile,b));a.mesh&&(this.didSend=!1)};Object.defineProperty(d.prototype,"signal",{get:function(){return this._abortController.signal},enumerable:!1,configurable:!0});d.prototype.abort=function(){this._abortController.abort()};return d}(),
l=function(){function d(a,b,c){this.resolved=!1;this.tile=b;this.offset=a;this.extent=c}d.prototype.reset=function(){this.resolved=!1};return d}();r=function(){function d(a,b,c){var d=this;this.type="remote";this._pendingEdits=new Set;this._queryInfo=null;this._subscriptions={display:new Map};this._invalid={outFields:!1,queryFilterParameters:!1};var e=this._onDataTileRequest.bind(this);this._source=D.createSource(a,b,c,e,function(){return d.canAcceptPatch()});this._serviceInfo=a;this._geometryType=
a.geometryType;this._outSR=b}d.prototype.destroy=function(){var a=this;this._getSubscriptions().map(function(b){return a.unsubscribe(b.displayTile)});this._source.destroy()};Object.defineProperty(d.prototype,"updating",{get:function(){return this._source.updating||this._getSubscriptions().some(function(a){return!a.didSend})},enumerable:!1,configurable:!0});Object.defineProperty(d.prototype,"isStream",{get:function(){return"geoevent"===this._source.type},enumerable:!1,configurable:!0});Object.defineProperty(d.prototype,
"sourceEvents",{get:function(){return"geoevent"===this._source.type?{type:"geoevent",events:this._source.events}:{type:"feature",events:this._source.events}},enumerable:!1,configurable:!0});d.prototype.enableEvent=function(a,b){this._source.enableEvent(a,b)};d.prototype.setViewState=function(a){this._source.setViewState(a)};d.prototype.update=function(a,b){var c,d,e,f,h=this._serviceInfo.fields.length,m=null!==(d=null===(c=this._schema)||void 0===c?void 0:c.outFields)&&void 0!==d?d:[];c=null!==(f=
null===(e=this._schema)||void 0===e?void 0:e.pixelBuffer)&&void 0!==f?f:0;e=b.outFields.filter(function(a){return-1===m.indexOf(a)});e=g.__spreadArrays(m,e);b.pixelBuffer=0===b.pixelBuffer?0:Math.max(b.pixelBuffer,c);b.outFields=e.length>=.75*h?["*"]:e;b.outFields.sort();c=n.diff(this._schema,b);this._subscriptions.display.forEach(function(b){b.invalid&&(a.queryFilter=!0)});c&&(h=this._schema&&n.hasDiff(c,"outFields"),e=this._schema&&n.hasDiff(c,"pixelBuffer"),f=this._schema&&n.hasDiffAny(c,["definitionExpression",
"gdbVersion","historicMoment"]),A("esri-2d-update-debug")&&console.debug("Applying Update - Source:",c),c={returnCentroid:"esriGeometryPolygon"===this._geometryType,returnGeometry:!0,outFields:b.outFields,outSpatialReference:this._outSR,orderByFields:[this._serviceInfo.objectIdField+" ASC"],where:b.definitionExpression||"1\x3d1",gdbVersion:b.gdbVersion,historicMoment:b.historicMoment?new Date(b.historicMoment):null,timeExtent:z.fromJSON(b.timeExtent)},a.source=!0,e&&(a.why.mesh.push("Pixel buffer changed"),
a.mesh=!0),f&&(a.why.mesh.push("Layer filter changed"),a.why.source.push("Layer filter changed"),a.mesh=!0,a.queryFilter=!0,this._invalid.queryFilterParameters=!0),h&&(a.why.source.push("Layer required fields changed"),this._invalid.outFields=!0),this._schema=b,this._source.update(c),this._queryInfo=c)};d.prototype.subscribe=function(a){this._subscriptions.display.has(a.id)||this._subscribeDisplayTile(a)};d.prototype.unsubscribe=function(a){if(this._subscriptions.display.has(a.id)){var b=this._subscriptions.display.get(a.id);
this._subscriptions.display.delete(a.id);this._source.unsubscribe(a);b.abort()}};d.prototype.forEachRequest=function(a,b){this._source.forEachRequest(a,b)};d.prototype.query=function(a){return this._source.query(a)};d.prototype.createQuery=function(){return new C(g.__assign({},this._queryInfo))};d.prototype.createTileQuery=function(a){if("stream"===this._serviceInfo.type)throw Error("Service does not support tile  queries");var b=this.createQuery();b.quantizationParameters=a.getQuantizationParameters();
b.resultType="tile";b.geometry=a.extent;"esriGeometryPolyline"===this._serviceInfo.geometryType&&(b.maxAllowableOffset=a.resolution);this._serviceInfo.capabilities.query.supportsQuantization||(b.quantizationParameters=null,b.maxAllowableOffset=a.resolution);return b};d.prototype.invalidate=function(){this._subscriptions.display.forEach(function(a){return a.invalid=!0})};d.prototype.forEachPendingEdit=function(a){this._getSubscriptions().some(function(a){return a.invalid})?this._pendingEdits.forEach(a):
this._pendingEdits.clear()};d.prototype.onEdits=function(a){return g.__awaiter(this,void 0,void 0,function(){var b,c,d,e,f,h,m,y,k=this;return g.__generator(this,function(x){switch(x.label){case 0:return b=a.addedFeatures.filter(function(a){return!a.error}).map(function(a){return a.objectId}),c=a.updatedFeatures.filter(function(a){return!a.error}).map(function(a){return a.objectId}),d=a.deletedFeatures.filter(function(a){return!a.error}).map(function(a){return a.objectId}),e=g.__spreadArrays(b,c),
d.forEach(function(a){k._pendingEdits.has(a)&&k._pendingEdits.delete(a)}),e.forEach(function(a){return k._pendingEdits.add(a)}),f=this._getSubscriptions().map(function(a){return a.displayTile}),h=f.map(function(a){var b=k.createTileQuery(a);b.objectIds=e;return{tile:a,query:b}}),m=h.map(function(a){var b=a.tile,c=a.query;return g.__awaiter(k,void 0,void 0,function(){var a;return g.__generator(this,function(d){switch(d.label){case 0:return a={tile:b},[4,this._source.query(c)];case 1:return[2,(a.result=
d.sent(),a)]}})})}),[4,B.all(m)];case 1:return y=x.sent(),y.forEach(function(a){var b=a.tile;a=a.result;var e=k._subscriptions.display.get(b.key.id);if(e){var e=e.signal,f=u.UpdateToken.all();k.onDisplayTilePatch({type:"update",id:b.key.id,version:w++,update:f,addOrUpdate:a,remove:g.__spreadArrays(c,d),end:!0,noData:!1},{signal:e})}}),this.invalidate(),[2]}})})};d.prototype.resubscribe=function(a,b){void 0===b&&(b=!1);return g.__awaiter(this,void 0,void 0,function(){var c,d,e,f=this;return g.__generator(this,
function(h){switch(h.label){case 0:c=this._schema.pixelBuffer;this._subscriptions.display.forEach(function(b){return b.setUpdate(a,c)});d=!1;this._subscriptions.display.forEach(function(a){a.invalid&&(d=!0)});this._invalid.outFields&&(this._invalid.outFields=!1);if(!(b||this._invalid.queryFilterParameters||d))return[3,1];e=this._getSubscriptions().map(function(a){return a.displayTile});e.forEach(function(a){return f.unsubscribe(a)});e.forEach(function(a){return f.subscribe(a)});this._source.resume();
this._invalid.queryFilterParameters=!1;return[3,5];case 1:return a.mesh?[4,this._source.resend({dataTileOnly:!1})]:[3,3];case 2:return h.sent(),[3,5];case 3:return[4,this._source.resend({dataTileOnly:!0})];case 4:h.sent(),h.label=5;case 5:return[2]}})})};d.prototype.pause=function(){this._source.pause()};d.prototype.resume=function(){this._source.resume()};d.prototype._getSubscriptions=function(){var a=[];this._subscriptions.display.forEach(function(b){a.push(b)});return a};d.prototype._subscribeDisplayTile=
function(a){var b=new E(a,this._schema.pixelBuffer);this._subscriptions.display.set(a.id,b);this._source.subscribe(a);for(var c=0,b=b.partitions;c<b.length;c++){var d=b[c],e=this._source.get(d.tile.id);if(q.isSome(e))for(var f=0,e=e.requests.done;f<e.length;f++)this._onPartitionMessage(a.id,d,e[f].request,"new")}};d.prototype._onDataTileRequest=function(a,b,c){var d=this,e=this._subscriptions.display.get(a.id);if(c&&c.dataTileOnly){c=0;for(var f=e.partitions;c<f.length;c++)if(e=f[c],e.tile.id===a.id){this._onPartitionMessage(a.id,
e,a,b);break}}else{c=0;for(f=e.partitions;c<f.length;c++)if(e=f[c],e.tile.id===a.id){this._onPartitionMessage(a.id,e,a,b);break}this._subscriptions.display.forEach(function(c,e){if(e!==a.id){var f=0;for(c=c.partitions;f<c.length;f++){var k=c[f];if(k.tile.id===a.id){d._onPartitionMessage(e,k,a,b);break}}}})}};d.prototype._onPartitionMessage=function(a,b,c,d){var e=q.andThen(c.features,function(a){if(!q.isNone(b.extent)){var c=b.offset,d=b.extent,e=c[0],c=c[1];a=a.extent(d[0],d[1],d[2],d[3]).transform(e,
c)}return a}),f=this._subscriptions.display.get(a),h=f.signal;f.didSend||(d="replace");var g=!1;c.end&&(b.resolved=!0,g=a===b.tile.id);f.didSend=!0;this.onDisplayTilePatch({type:d,id:a,version:w++,update:f.update,addOrUpdate:e,remove:c.remove||[],noData:c.noData,end:g},{signal:h})};return d}();p.Source2D=r});