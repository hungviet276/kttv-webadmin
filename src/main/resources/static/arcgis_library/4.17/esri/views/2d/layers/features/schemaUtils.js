// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.17/esri/copyright.txt for details.
//>>built
define("require exports tslib ../../../../core/Error ../../../../core/has ../../../../core/lang ../../../../core/Logger ../../../../core/maybe ../../../../core/screenUtils ../../../../symbols/support/jsonUtils ../../engine/webgl/enums ../../engine/webgl/Utils ../../engine/webgl/materialKey/MaterialKey ../../engine/webgl/util/vvFlagUtils ./support/rendererUtils ../support/clusterUtils ../support/util".split(" "),function(ba,n,f,v,H,I,J,y,z,K,p,L,g,M,N,O,P){function r(a){var c;switch(a.type){case "line-marker":return{type:"line-marker",
color:null===(c=a.color)||void 0===c?void 0:c.toJSON(),placement:a.placement,style:a.style};default:return K.fromJSON(a.toJSON()).toJSON()}}function l(a,c,b){if(!a)return null;var d=0,e=!1;y.isSome(c)&&"visualVariables"in c&&(d=M.getVVFlags(c.visualVariables||[]),e="dot-density"===c.type);switch(a.type){case "simple-fill":case "picture-fill":return Q(a,d,e,b);case "simple-marker":case "picture-marker":return c=g.createMaterialKey(p.WGLGeometryType.MARKER,d,!1,!1),b=b?g.hydrateMaterialKey(c):c,c=r(a),
f.__assign(f.__assign({materialKey:b,hash:a.hash()},c),{angle:a.angle});case "simple-line":return R(a,d,b);case "text":return c=g.createMaterialKey(p.WGLGeometryType.TEXT,d,!1,!1),b=b?g.hydrateMaterialKey(c):c,c=r(a),f.__assign(f.__assign({materialKey:b,hash:a.hash()},c),{angle:a.angle});case "label":return c=g.createMaterialKey(p.WGLGeometryType.LABEL,d,!1,!1,a.labelPlacement),b=b?g.hydrateMaterialKey(c):c,f.__assign(f.__assign({materialKey:b,hash:a.hash()},a.toJSON()),{labelPlacement:a.labelPlacement});
case "cim":return{type:"cim",rendererKey:d,data:a.data};case "web-style":return f.__assign(f.__assign({},r(a)),{type:"web-style",hash:a.hash(),rendererKey:d});default:throw Error("symbol not supported "+a.type);}}function Q(a,c,b,d){b=g.createMaterialKey(p.WGLGeometryType.FILL,c,!1,b);var e=d?g.hydrateMaterialKey(b):b,h=a.clone();b=h.outline;h.outline=null;a=[];e=f.__assign({materialKey:e,hash:h.hash()},r(h));a.push(e);b&&(c=g.createMaterialKey(p.WGLGeometryType.LINE,c,!0,!1),d=d?g.hydrateMaterialKey(c):
c,d=f.__assign({materialKey:d,hash:b.hash()},r(b)),a.push(d));return{type:"composite-symbol",layers:a,hash:a.reduce(function(a,b){return b.hash+a},"")}}function R(a,c,b){var d,e=g.createMaterialKey(p.WGLGeometryType.LINE,c,!1,!1),h=b?g.hydrateMaterialKey(e):e;a=a.clone();e=a.marker;a.marker=null;var k=[];k.push(f.__assign({materialKey:h,hash:a.hash()},r(a)));e&&(c=g.createMaterialKey(p.WGLGeometryType.MARKER,c,!1,!1),b=b?g.hydrateMaterialKey(c):c,e.color=null!==(d=e.color)&&void 0!==d?d:a.color,k.push(f.__assign({materialKey:b,
hash:e.hash(),lineWidth:a.width},r(e))));return{type:"composite-symbol",layers:k,hash:k.reduce(function(a,b){return b.hash+a},"")}}function S(a,c){var b=a.labelPlacement,d=T[c];if(!a.symbol)return w.warn("No LabelClass symbol specified."),!0;if(!d)return w.error(new v("mapview-labeling:unsupported-geometry-type","Unable to create labels for Feature Layer, "+c+" is not supported")),!0;d.some(function(a){return a===b})||(d=d[0],b&&w.warn("Found invalid label placement type "+b+" for "+c+". Defaulting to "+
d),a.labelPlacement=d);return!1}function A(a,c){a=I.clone(a);return a.some(function(a){return S(a,c)})?[]:a}function B(a,c,b){var d,e;void 0===b&&(b=!1);try{var h=U(a.layer,b),k={};h.map(function(b){a:{switch(b.target){case "feature":C(k,D(a),b);b=void 0;break a;case "aggregate":var c=a.layer.featureReduction;if("selection"===c.type)throw new v("ValidationError","Mapview does not support `selection` reduction type",c);C(k,D(a),b);k.aggregate||(k.aggregate={name:"aggregate",input:"feature",filters:null,
attributes:{},params:{clusterRadius:z.pt2px(c.clusterRadius/2),clusterPixelBuffer:64*Math.ceil(z.pt2px(c.clusterMaxSize)/64),fields:b.aggregateFields}});E(k.aggregate,b.attributes.fields);b=void 0;break a}b=void 0}return b});return{source:{definitionExpression:a.layer.definitionExpression,fields:a.layer.fields.map(function(a){return a.toJSON()}),gdbVersion:"feature"===a.layer.type?a.layer.gdbVersion:void 0,historicMoment:"feature"===a.layer.type?null===(d=a.layer.historicMoment)||void 0===d?void 0:
d.getTime():void 0,outFields:a.availableFields,pixelBuffer:c,spatialReference:a.layer.spatialReference.toJSON(),timeExtent:null===(e=a.layer.timeExtent)||void 0===e?void 0:e.toJSON()},attributes:{fields:{},indexCount:0},processors:h,targets:k}}catch(u){if("ValidationError"===u.fieldName)return w.error(u),null;throw u;}}function E(a,c){for(var b in c){var d=c[b];if(d.target===a.name){var e=a.attributes[b];e?(e.context.mesh=e.context.mesh||d.context.mesh,e.context.storage=e.context.storage||d.context.storage):
a.attributes[b]=d}}return a}function D(a){var c,b,d,e,h;return[null!==(b=null===(c=a.filter)||void 0===c?void 0:c.toJSON())&&void 0!==b?b:null,null!==(h=null===(e=null===(d=a.effect)||void 0===d?void 0:d.filter)||void 0===e?void 0:e.toJSON())&&void 0!==h?h:null]}function C(a,c,b){a.feature||(a.feature={name:"feature",input:"source",filters:c,attributes:{}});E(a.feature,b.attributes.fields);return a}function q(a,c){return c.field?t(a,f.__assign(f.__assign({},c),{type:"field",field:c.field})):c.valueExpression?
t(a,f.__assign(f.__assign({},c),{type:"expression",valueExpression:c.valueExpression})):{field:null,fieldIndex:null}}function t(a,c){switch(c.type){case "expression":var b=c.valueExpression;if(!a.fields[b]){var d=a.indexCount++;a.fields[b]=f.__assign(f.__assign({},c),{name:b,fieldIndex:d})}a=a.fields[b];return{fieldIndex:a.fieldIndex};case "label-expression":return b=JSON.stringify(c.label),a.fields[b]||(d=a.indexCount++,a.fields[b]=f.__assign(f.__assign({},c),{name:b,fieldIndex:d})),a=a.fields[b],
{fieldIndex:a.fieldIndex};case "field":b=c.field;if("aggregate"===c.target&&a.fields[b])return{field:b};a.fields[b]=f.__assign(f.__assign({},c),{name:b});return{field:b};case "statistic":return a.fields[c.name]=f.__assign({},c),{field:c.name}}}function U(a,c){void 0===c&&(c=!1);var b=[],d=0;b.push(V(a,d++,c));return b}function F(a,c,b,d,e,h){void 0===h&&(h=!1);c=t(c,{type:"label-expression",target:d,context:{mesh:!0},resultType:"string",label:{labelExpression:b.labelExpression,labelExpressionInfo:b.labelExpressionInfo?
{expression:b.labelExpressionInfo.expression}:null,symbol:!!b.symbol,where:b.where}}).fieldIndex;return f.__assign(f.__assign({},l(b,a,h)),{fieldIndex:c,target:d,index:e})}function V(a,c,b){void 0===b&&(b=!1);var d={indexCount:0,fields:{}},e="featureReduction"in a&&a.featureReduction;c=e?"aggregate":"feature";switch(a.renderer.type){case "heatmap":var h=a.renderer;return{type:"heatmap",aggregateFields:[],attributes:d,target:c,storage:null,mesh:{blurRadius:h.blurRadius,fieldOffset:h.fieldOffset,field:q(d,
{target:c,field:h.field,resultType:"numeric"}).field}};default:var h=[],k="aggregate"===c?O.createClusterRenderer(h,a.renderer,e,null):a.renderer;W(d,h);var u=G(d,c,k,b),m=X(d,c,k),g=P.toJSONGeometryType(a.geometryType);a=a.labelsVisible&&a.labelingInfo||[];var x=[];if(e){if("selection"===e.type)throw new v("ValidationError","Mapview does not support `selection` reduction type",e);x=e&&e.labelsVisible&&e.labelingInfo||[]}a=A(a,g);var x=A(x,g),l=0,e=f.__spreadArrays(a.map(function(a){return F(k,d,
a,"feature",l++,b)}),x.map(function(a){return F(k,d,a,"aggregate",l++,b)}));return{type:"symbol",target:c,attributes:d,aggregateFields:h,storage:m,mesh:{matcher:u,labels:e}}}}function W(a,c){for(var b={mesh:!0,storage:!0},d=0;d<c.length;d++){var e=c[d],h=e.name,e=e.outStatistic,k=e.statisticType,f=e.onStatisticField,m=null,g=null,l=null;"onStatisticValueExpression"in e?g=t(a,{type:"expression",target:"feature",valueExpression:e.onStatisticValueExpression,resultType:"numeric"}).fieldIndex:"onStatisticNormalizationField"in
e?(m=t(a,{type:"field",target:"feature",field:f,resultType:"numeric"}).field,l=e.onStatisticNormalizationField):m=t(a,{type:"field",target:"feature",field:f,resultType:"numeric"}).field;t(a,{type:"statistic",target:"aggregate",name:h,context:b,inField:m,inNormalizationField:l,inFieldIndex:g,statisticType:k})}}function X(a,c,b){switch(b.type){case "dot-density":return Y(a,c,b.attributes);case "simple":case "class-breaks":case "unique-value":return Z(a,c,b.visualVariables);case "heatmap":case "dictionary":return null}}
function Y(a,c,b){return b&&b.length?{type:"dot-density",mapping:b.map(function(b,e){b=q(a,{valueExpression:b.valueExpression,field:b.field,resultType:"numeric",target:c});return{binding:e,field:b.field,fieldIndex:b.fieldIndex}}),target:c}:{type:"dot-density",mapping:[],target:c}}function Z(a,c,b){if(!b||!b.length)return{type:"visual-variable",mapping:[],target:c};var d={storage:!0};return{type:"visual-variable",mapping:N.simplifyVisualVariables(b).map(function(b){var e,f=L.getVVType(b.type),g=q(a,
{target:c,valueExpression:b.valueExpression,field:b.field,context:d,resultType:"numeric"}),m=g.field,g=g.fieldIndex;switch(b.type){case "size":return"$view.scale"===b.valueExpression?null:{type:"size",binding:f,field:m,fieldIndex:g,normalizationField:q(a,{target:c,field:b.normalizationField,context:d,resultType:"numeric"}).field,valueRepresentation:null!==(e=b.valueRepresentation)&&void 0!==e?e:null};case "color":return{type:"color",binding:f,field:m,fieldIndex:g,normalizationField:q(a,{target:c,
field:b.normalizationField,context:d,resultType:"numeric"}).field};case "opacity":return{type:"opacity",binding:f,field:m,fieldIndex:g,normalizationField:q(a,{target:c,field:b.normalizationField,context:d,resultType:"numeric"}).field};case "rotation":return{type:"rotation",binding:f,field:m,fieldIndex:g}}}).filter(function(a){return a}),target:c}}function G(a,c,b,d){void 0===d&&(d=!1);a=y.unwrapOr(a,{indexCount:0,fields:{}});switch(b.type){case "simple":case "dot-density":a="dot-density"===b.type;
void 0===d&&(d=!1);var e=b.getSymbols();return{type:"simple",symbol:l(e.length?e[0]:null,b,d),isDotDensity:a};case "class-breaks":return aa(a,c,b,d);case "unique-value":void 0===d&&(d=!1);var e=[],h=b.backgroundFillSymbol;c={target:c,context:{mesh:!0},resultType:"string"};if(b.field&&"string"!==typeof b.field)throw new v("ValidationError","Expected renderer.field to be a string",b);for(var k=q(a,f.__assign(f.__assign({},c),{field:b.field,valueExpression:b.valueExpression})),g=k.field,k=k.fieldIndex,
m=0,n=b.uniqueValueInfos;m<n.length;m++){var p=n[m];e.push({value:""+p.value,symbol:l(p.symbol,b,d)})}return{type:"map",attributes:a.fields,field:g,fieldIndex:k,field2:q(a,f.__assign(f.__assign({},c),{field:b.field2})).field,field3:q(a,f.__assign(f.__assign({},c),{field:b.field3})).field,fieldDelimiter:b.fieldDelimiter,backgroundFillSymbol:l(h,b),defaultSymbol:l(b.defaultSymbol,b),map:e};case "dictionary":return a=d,void 0===a&&(a=!1),{type:"dictionary",renderer:b.toJSON()}}}function aa(a,c,b,d){void 0===
d&&(d=!1);var e=b.backgroundFillSymbol,f=q(a,{target:c,field:b.field,valueExpression:b.valueExpression,resultType:"numeric",context:{mesh:!0,use:"renderer.field"}});c=f.field;var f=f.fieldIndex,g=b.normalizationType,g="log"===g?"esriNormalizeByLog":"percent-of-total"===g?"esriNormalizeByPercentOfTotal":"field"===g?"esriNormalizeByField":null,n=b.classBreakInfos.map(function(a){return{symbol:l(a.symbol,b,d),min:a.minValue,max:a.maxValue}}).sort(function(a,b){return a.min-b.min});return{type:"interval",
attributes:a.fields,field:c,fieldIndex:f,backgroundFillSymbol:l(e,b,d),defaultSymbol:l(b.defaultSymbol,b,d),intervals:n,normalizationField:b.normalizationField,normalizationTotal:b.normalizationTotal,normalizationType:g,isMaxInclusive:b.isMaxInclusive}}Object.defineProperty(n,"__esModule",{value:!0});n.createMatcherSchema=n.createSchema=n.createSymbolSchema=void 0;var w=J.getLogger("esri.views.2d.layers.features.schemaUtils"),T={esriGeometryPoint:"above-right above-center above-left center-center center-left center-right below-center below-left below-right".split(" "),
esriGeometryPolygon:["always-horizontal"],esriGeometryPolyline:["center-along"],esriGeometryMultipoint:null};n.createSymbolSchema=l;n.createSchema=function(a,c){void 0===c&&(c=0);H("esri-2d-update-debug")&&console.debug("Created new schema",B(a,c,!0));return B(a,c)};n.createMatcherSchema=G});