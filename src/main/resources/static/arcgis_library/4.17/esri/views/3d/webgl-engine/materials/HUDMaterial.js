// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.17/esri/copyright.txt for details.
//>>built
define("require exports tslib ../../../../core/mathUtils ../../../../core/maybe ../../../../core/screenUtils ../../../../core/libs/gl-matrix-2/mat3 ../../../../core/libs/gl-matrix-2/mat3f64 ../../../../core/libs/gl-matrix-2/mat4 ../../../../core/libs/gl-matrix-2/mat4f64 ../../../../core/libs/gl-matrix-2/vec2 ../../../../core/libs/gl-matrix-2/vec2f64 ../../../../core/libs/gl-matrix-2/vec3 ../../../../core/libs/gl-matrix-2/vec3f64 ../../../../core/libs/gl-matrix-2/types/mat4 ../../../../geometry/support/aaBoundingRect ../../support/buffer/InterleavedLayout ../lib/geometryDataUtils ../lib/GLMaterialTexture ../lib/Material ../lib/screenSizePerspectiveUtils ../lib/Util ./internal/bufferWriterUtils ./internal/MaterialUtil ./renderers/utils ../shaders/HUDMaterial.glsl ../shaders/HUDMaterialTechnique".split(" "),
function(O,t,q,J,Y,Z,P,Q,aa,R,ba,S,h,D,ca,da,ea,fa,ga,ha,H,f,z,K,ia,T,I){function U(f,a,b,e,c,d,n,g){a=a-c-(0<g[0]?e[0]*g[0]:0);var A=a+e[0]+2*c;b=b-c-(0<g[1]?e[1]*g[1]:0);c=b+e[1]+2*c;n.textureIsSignedDistanceField&&(n=n.distanceFieldBoundingBox,a+=e[0]*n[0],b+=e[1]*n[1],A-=e[0]*(1-n[2]),c-=e[1]*(1-n[3]),a-=d,A+=d,b-=d,c+=d);return f[0]>a&&f[0]<A&&f[1]>b&&f[1]<c}Object.defineProperty(t,"__esModule",{value:!0});O=function(v){function a(b,e){e=v.call(this,e)||this;e.techniqueConfig=new I.HUDMaterialTechniqueConfiguration;
e.params=K.copyParameters(b,ja);return e}q.__extends(a,v);a.prototype.setParameterValues=function(b){for(var e in b)"textureId"===e&&f.assert(!!this.params.textureId,"Can only change texture of material that already has a texture"),this.params[e]=b[e];this.parametersChanged()};a.prototype.getParameters=function(){return this.params};a.prototype.getTechniqueConfig=function(b){this.techniqueConfig.output=b;this.techniqueConfig.slicePlaneEnabled=this.params.slicePlaneEnabled;this.techniqueConfig.verticalOffset=
!!this.params.verticalOffset;this.techniqueConfig.screenSizePerspective=!!this.params.screenSizePerspective;this.techniqueConfig.screenCenterOffsetUnitsEnabled="screen"===this.params.centerOffsetUnits?1:0;this.techniqueConfig.polygonOffsetEnabled=this.params.polygonOffset;this.techniqueConfig.occlusionTestEnabled=this.params.occlusionTest;this.techniqueConfig.sdf=this.params.textureIsSignedDistanceField;this.techniqueConfig.vvSize=!!this.params.vvSizeEnabled;this.techniqueConfig.vvColor=!!this.params.vvColorEnabled;
0===b&&(this.techniqueConfig.debugDrawBorder=!!this.params.debugDrawBorder);4===b&&(this.techniqueConfig.binaryHighlightOcclusion=this.params.binaryHighlightOcclusion);this.techniqueConfig.depthEnabled=this.params.depthEnabled;return this.techniqueConfig};a.prototype.intersect=function(b,e,a,d,n,g,f,h,m){m?this.intersectDrapedHudGeometry(b,g,f,h):this.intersectHudGeometry(b,e,a,d,f,h)};a.prototype.intersectDrapedHudGeometry=function(b,e,a,d){var c=b.getAttribute(f.VertexAttrConstants.POSITION),g=
b.getAttribute(f.VertexAttrConstants.SIZE),A=this.params,h=T.calculateAnchorPosForRendering(A),m=1,p=1;d&&(p=d(V),m=p[0],p=p[5]);m*=b.screenToWorldRatio;p*=b.screenToWorldRatio;d=ka*b.screenToWorldRatio;for(var k=0;k<c.data.length/c.size;k++){var r=k*c.size,v=c.data[r],r=c.data[r+1],u=k*g.size;B[0]=g.data[u]*m;B[1]=g.data[u+1]*p;u=void 0;A.textureIsSignedDistanceField&&(u=A.outlineSize*b.screenToWorldRatio/2);U(e,v,r,B,d,u,A,h)&&a()}};a.prototype.intersectHudGeometry=function(b,e,a,d,n,g){if(d.options.selectionMode&&
d.options.hud&&!ia.isInstanceHidden(e)){var c=b.data;b=this.params;var v=e=1;P.mat3.fromMat4(L,a);if(g){v=g(V);e=v[0];v=v[5];g=L;var m=g[0],p=g[1],q=g[2],r=g[3],t=g[4],u=g[5],y=g[6],l=g[7],w=g[8],C=1/Math.sqrt(m*m+p*p+q*q),F=1/Math.sqrt(r*r+t*t+u*u),z=1/Math.sqrt(y*y+l*l+w*w);g[0]=m*C;g[1]=p*C;g[2]=q*C;g[3]=r*F;g[4]=t*F;g[5]=u*F;g[6]=y*z;g[7]=l*z;g[8]=w*z}g=c.getVertexAttr()[f.VertexAttrConstants.POSITION];m=c.getVertexAttr()[f.VertexAttrConstants.SIZE];p=c.getVertexAttr()[f.VertexAttrConstants.NORMAL];
c=c.getVertexAttr()[f.VertexAttrConstants.AUXPOS1];f.assert(3<=g.size);q=d.point;r=d.camera;t=T.calculateAnchorPosForRendering(b);e*=r.pixelRatio;v*=r.pixelRatio;u="screen"===this.params.centerOffsetUnits;for(y=0;y<g.data.length/g.size;y++)l=y*g.size,h.vec3.set(k,g.data[l],g.data[l+1],g.data[l+2]),h.vec3.transformMat4(k,k,a),l=y*m.size,B[0]=m.data[l]*e,B[1]=m.data[l+1]*v,h.vec3.transformMat4(k,k,r.viewMatrix),l=y*c.size,h.vec3.set(x,c.data[l+0],c.data[l+1],c.data[l+2]),u||(k[0]+=x[0],k[1]+=x[1],0!==
x[2]&&(l=x[2],h.vec3.normalize(x,k),h.vec3.subtract(k,k,h.vec3.scale(x,x,l)))),l=y*p.size,h.vec3.set(G,p.data[l],p.data[l+1],p.data[l+2]),this.normalAndViewAngle(G,L,r,M),this.applyVerticalOffsetTransformationView(k,M,r,N),r.applyProjection(k,E),-1<E[0]&&(l=Math.floor(E[0])+this.params.screenOffset[0],w=Math.floor(E[1])+this.params.screenOffset[1],u&&(l+=x[0],0!==x[1]&&(w+=H.applyScaleFactor(x[1],N.factorAlignment))),H.applyPrecomputedScaleFactor(B,N.factor,B),C=la*r.pixelRatio,F=void 0,b.textureIsSignedDistanceField&&
(F=b.outlineSize*r.pixelRatio/2),U(q,l,w,B,C,F,b,t)&&(w=d.ray,h.vec3.transformMat4(W,k,aa.mat4.invert(ma,r.viewMatrix)),E[0]=q[0],E[1]=q[1],r.unprojectPoint(E,k),l=D.vec3f64.create(),h.vec3.copy(l,w.direction),C=1/h.vec3.length(l),h.vec3.scale(l,l,C),w=h.vec3.distance(w.origin,k)*C,n(w,l,-1,1,!0,W)))}};a.prototype.computeAttachmentOrigin=function(b,a){b=b.data;var e="getVertexAttr"in b?b.getVertexAttr():"vertexAttr"in b?b.vertexAttr:null;if(!e)return null;var d=f.VertexAttrConstants.POSITION,e=e[d];
b="getIndices"in b?b.getIndices(d):"indices"in b?b.indices[d]:null;return fa.computeAttachmentOriginPoints(e,b,a)};a.prototype.createBufferWriter=function(){return new na(this)};a.prototype.normalAndViewAngle=function(b,a,c,d){ca.isMat4(a)&&(a=P.mat3.fromMat4(oa,a));h.vec3.transformMat3(d.normal,b,a);h.vec3.transformMat4(d.normal,d.normal,c.viewInverseTransposeMatrix);d.cosAngle=h.vec3.dot(X,pa);return d};a.prototype.updateScaleInfo=function(b,a,c){var e=this.params;e.screenSizePerspective?H.precomputeScaleFactor(c,
a,e.screenSizePerspective,b.factor):(b.factor.scale=1,b.factor.factor=0,b.factor.minPixelSize=0,b.factor.paddingPixels=0);e.screenSizePerspectiveAlignment?H.precomputeScaleFactor(c,a,e.screenSizePerspectiveAlignment,b.factorAlignment):(b.factorAlignment.factor=b.factor.factor,b.factorAlignment.scale=b.factor.scale,b.factorAlignment.minPixelSize=b.factor.minPixelSize,b.factorAlignment.paddingPixels=b.factor.paddingPixels)};a.prototype.applyShaderOffsetsView=function(b,a,c,d,n,g,f){a=this.normalAndViewAngle(a,
c,n,M);this.applyVerticalGroundOffsetView(b,a,n,f);this.applyVerticalOffsetTransformationView(f,a,n,g);this.applyPolygonOffsetView(f,a,d[3],n,f);this.applyCenterOffsetView(f,d,f);return f};a.prototype.applyShaderOffsetsNDC=function(b,a,c,d,n){this.applyCenterOffsetNDC(b,a,c,d);Y.isSome(n)&&h.vec3.copy(n,d);this.applyPolygonOffsetNDC(d,a,c,d);return d};a.prototype.applyPolygonOffsetView=function(b,a,c,d,n){var e=d.aboveGround?1:-1;c=J.sign(c);0===c&&(c=e);e*=c;if(0>=this.params.shaderPolygonOffset)return h.vec3.copy(n,
b);a=J.clamp(Math.abs(a.cosAngle),.01,1);d=1-Math.sqrt(1-a*a)/a/d.viewport[2];0<e?h.vec3.scale(n,b,d):h.vec3.scale(n,b,1/d);return n};a.prototype.applyVerticalGroundOffsetView=function(b,a,c,d){var e=h.vec3.length(b),g=c.aboveGround?1:-1;c=.5*c.computeRenderPixelSizeAtDist(e);a=h.vec3.scale(k,a.normal,g*c);h.vec3.add(d,b,a);return d};a.prototype.applyVerticalOffsetTransformationView=function(b,a,c,d){var e=this.params;if(!e.verticalOffset||!e.verticalOffset.screenLength){if(e.screenSizePerspective||
e.screenSizePerspectiveAlignment){var g=h.vec3.length(b);this.updateScaleInfo(d,g,a.cosAngle)}else d.factor.scale=1,d.factorAlignment.scale=1;return b}g=h.vec3.length(b);c=K.verticalOffsetAtDistance(c,g,e.verticalOffset,a.cosAngle,e.screenSizePerspectiveAlignment||e.screenSizePerspective);this.updateScaleInfo(d,g,a.cosAngle);h.vec3.scale(a.normal,a.normal,c);return h.vec3.add(b,b,a.normal)};a.prototype.applyCenterOffsetView=function(b,a,c){var d="screen"!==this.params.centerOffsetUnits;c!==b&&h.vec3.copy(c,
b);d&&(c[0]+=a[0],c[1]+=a[1],a[2]&&(h.vec3.normalize(G,c),h.vec3.add(c,c,h.vec3.scale(G,G,a[2]))));return c};a.prototype.applyCenterOffsetNDC=function(b,a,c,d){var e="screen"!==this.params.centerOffsetUnits;d!==b&&h.vec3.copy(d,b);e||(d[0]+=a[0]/c.fullWidth*2,d[1]+=a[1]/c.fullHeight*2);return d};a.prototype.applyPolygonOffsetNDC=function(b,a,c,d){var e=this.params.shaderPolygonOffset;b!==d&&h.vec3.copy(d,b);e&&(b=c.aboveGround?1:-1,a=b*J.sign(a[3]),d[2]-=(a||b)*e);return d};a.prototype.getGLMaterial=
function(b){if(0===b.output)return new qa(b);if(4===b.output)return new ra(b)};a.prototype.calculateRelativeScreenBounds=function(b,a,c){void 0===c&&(c=da.create());var d=this.params,e=c;void 0===e&&(e=sa);ba.vec2.copy(e,d.anchorPos);e[0]*=-b[0];e[1]*=-b[1];e[0]+=d.screenOffset[0]*a;e[1]+=d.screenOffset[1]*a;c[2]=c[0]+b[0];c[3]=c[1]+b[1];return c};return a}(ha.Material);t.default=O;t=function(f){function a(b){b=f.call(this,q.__assign(q.__assign({},b),b.material.getParameters()))||this;b.updateParameters();
return b}q.__extends(a,f);a.prototype.beginSlot=function(b){return b===(this.params.drawInSecondSlot?19:18)};a.prototype.updateParameters=function(){this.params=K.copyParameters(this.material.getParameters());this.updateTexture(this.params.textureId);this.selectProgram()};a.prototype.selectProgram=function(){this.technique=this.techniqueRep.acquireAndReleaseExisting(I.HUDMaterialTechnique,this.material.getTechniqueConfig(this.output),this.technique)};a.prototype.bind=function(b,a){b.bindProgram(this.technique.program);
this.bindTexture(b,this.technique.program);this.bindTextureScale(b,this.technique.program);this.technique.bindPass(b,this.params,a)};return a}(ga);var qa=function(f){function a(b){b=f.call(this,q.__assign(q.__assign({},b),{output:0}))||this;b.isOcclusionSlot=!1;return b}q.__extends(a,f);a.prototype.beginSlot=function(b){var a=this.params.drawInSecondSlot?19:18;if(this.params.occlusionTest)return this.isOcclusionSlot=12===b,12===b||b===a;this.isOcclusionSlot=!1;return b===a};a.prototype.getTechnique=
function(){return this.isOcclusionSlot?this.occlusionTechnique:this.technique};a.prototype.selectProgram=function(){this.technique=this.techniqueRep.acquireAndReleaseExisting(I.HUDMaterialTechnique,this.material.getTechniqueConfig(this.output),this.technique);this.occlusionTechnique=this.techniqueRep.acquireAndReleaseExisting(I.HUDMaterialTechnique,this.material.getTechniqueConfig(6),this.occlusionTechnique)};a.prototype.bind=function(a,e){var b=this.getTechnique();a.bindProgram(b.program);this.isOcclusionSlot||
(this.bindTexture(a,b.program),this.bindTextureScale(a,b.program));b.bindPass(a,this.params,e)};return a}(t),ra=function(f){function a(a){return f.call(this,q.__assign(q.__assign({},a),{output:4}))||this}q.__extends(a,f);return a}(t),N={factor:{scale:0,factor:0,minPixelSize:0,paddingPixels:0},factorAlignment:{scale:0,factor:0,minPixelSize:0,paddingPixels:0}},sa=S.vec2f64.create(),k=D.vec3f64.create(),G=D.vec3f64.create(),E=Z.createRenderScreenPointArray3(),X=D.vec3f64.create(),W=D.vec3f64.create(),
L=Q.mat3f64.create(),oa=Q.mat3f64.create(),ma=R.mat4f64.create(),x=D.vec3f64.create(),M={normal:X,cosAngle:0},V=R.mat4f64.create(),la=1,ka=2,B=[0,0],pa=D.vec3f64.fromValues(0,0,1),ja={texCoordScale:[1,1],occlusionTest:!0,binaryHighlightOcclusion:!0,drawInSecondSlot:!1,color:[1,1,1,1],outlineColor:[1,1,1,1],outlineSize:0,textureIsSignedDistanceField:!1,distanceFieldBoundingBox:null,vvSizeEnabled:!1,vvSizeMinSize:[1,1,1],vvSizeMaxSize:[100,100,100],vvSizeOffset:[0,0,0],vvSizeFactor:[1,1,1],vvColorEnabled:!1,
vvColorValues:[0,0,0,0,0,0,0,0],vvColorColors:[1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0],screenOffset:[0,0],verticalOffset:null,screenSizePerspective:null,screenSizePerspectiveAlignment:null,slicePlaneEnabled:!1,anchorPos:S.vec2f64.fromValues(.5,.5),shaderPolygonOffset:1E-5,polygonOffset:!1,textureId:null,centerOffsetUnits:"world",depthEnabled:!0,debugDrawBorder:!1},ta=ea.newLayout().vec3f(f.VertexAttrConstants.POSITION).vec3f(f.VertexAttrConstants.NORMAL).vec2f(f.VertexAttrConstants.UV0).vec4u8(f.VertexAttrConstants.COLOR).vec2f(f.VertexAttrConstants.SIZE).vec4f(f.VertexAttrConstants.AUXPOS1).vec4f(f.VertexAttrConstants.AUXPOS2),
na=function(){function h(a){this.material=a;this.vertexBufferLayout=ta}h.prototype.allocate=function(a){return this.vertexBufferLayout.createBuffer(a)};h.prototype.elementCount=function(a){return 6*a.indices[f.VertexAttrConstants.POSITION].length};h.prototype.write=function(a,b,e,c){z.writePosition(b.indices[f.VertexAttrConstants.POSITION],b.vertexAttr[f.VertexAttrConstants.POSITION].data,a.transformation,e.position,c,6);z.writeNormal(b.indices[f.VertexAttrConstants.NORMAL],b.vertexAttr[f.VertexAttrConstants.NORMAL].data,
a.invTranspTransformation,e.normal,c,6);a=b.vertexAttr[f.VertexAttrConstants.UV0].data;var d=void 0,h=void 0,g=void 0,k=void 0;null==a||4>a.length?(a=this.material.getParameters(),h=d=0,g=a.texCoordScale[0],k=a.texCoordScale[1]):(d=a[0],h=a[1],g=a[2],k=a[3]);var g=Math.min(1.99999,g+1),k=Math.min(1.99999,k+1),q=b.indices[f.VertexAttrConstants.POSITION].length,m=e.uv0;a=c;for(var p=0;p<q;++p)m.set(a,0,d),m.set(a,1,h),a+=1,m.set(a,0,g),m.set(a,1,h),a+=1,m.set(a,0,g),m.set(a,1,k),a+=1,m.set(a,0,g),m.set(a,
1,k),a+=1,m.set(a,0,d),m.set(a,1,k),a+=1,m.set(a,0,d),m.set(a,1,h),a+=1;z.writeColor(b.indices[f.VertexAttrConstants.COLOR],b.vertexAttr[f.VertexAttrConstants.COLOR].data,4,e.color,c,6);d=b.indices[f.VertexAttrConstants.SIZE];h=b.vertexAttr[f.VertexAttrConstants.SIZE].data;g=d.length;k=e.size;a=c;for(p=0;p<g;++p)for(var q=h[2*d[p]],m=h[2*d[p]+1],t=0;6>t;++t)k.set(a,0,q),k.set(a,1,m),a+=1;b.indices[f.VertexAttrConstants.AUXPOS1]&&b.vertexAttr[f.VertexAttrConstants.AUXPOS1]&&z.writeBufferVec4(b.indices[f.VertexAttrConstants.AUXPOS1],
b.vertexAttr[f.VertexAttrConstants.AUXPOS1].data,e.auxpos1,c,6);b.indices[f.VertexAttrConstants.AUXPOS2]&&b.vertexAttr[f.VertexAttrConstants.AUXPOS2]&&z.writeBufferVec4(b.indices[f.VertexAttrConstants.AUXPOS2],b.vertexAttr[f.VertexAttrConstants.AUXPOS2].data,e.auxpos2,c,6)};return h}()});