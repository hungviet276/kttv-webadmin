// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.17/esri/copyright.txt for details.
//>>built
define("require exports ../../../../../core/mathUtils ../../../../../core/maybe ../../../../../core/libs/gl-matrix-2/vec3 ../../../../../core/libs/gl-matrix-2/vec3f64 ../../../../../geometry/support/aaBoundingBox ../../lib/screenSizePerspectiveUtils ../../lib/Util ../renderers/utils".split(" "),function(da,c,M,I,u,B,J,Y,N,Z){function O(a,b,d,l,r,e){var g=P(b,d,aa);J.setMin(G,a.getBBMin());J.setMax(G,a.getBBMax());I.isSome(r)&&r.applyToAabb(G);if(Q(G,b,g,l)){var g=a.getPrimitiveIndices(),m=a.getIndices(),
c=a.getPosition(),f=g?g.length:m.length/3;if(f>ba&&(a=a.getChildren(),void 0!==a)){for(g=0;8>g;++g)void 0!==a[g]&&O(a[g],b,d,l,r,e);return}K(b,d,0,f,m,c,g,r,e)}}function K(a,b,d,l,r,e,g,c,R){var f,p,h;if(g){var t,k,m=e.data,C=e.offsetIdx;e=e.strideIdx;var u=a[0],F=a[1];a=a[2];var D=b[0]-u,E=b[1]-F;for(b=b[2]-a;d<l;++d){var z=g[d],v=3*z;k=C+e*r[v++];var q=m[k++],n=m[k++];f=m[k];k=C+e*r[v++];var x=m[k++];p=m[k++];t=m[k];k=C+e*r[v];v=m[k++];h=m[k++];k=m[k];I.isSome(c)&&(f=c.applyToVertex(q,n,f),q=f[0],
n=f[1],f=f[2],t=c.applyToVertex(x,p,t),x=t[0],p=t[1],t=t[2],k=c.applyToVertex(v,h,k),v=k[0],h=k[1],k=k[2]);x-=q;p-=n;t-=f;v-=q;h-=n;k-=f;var y=E*k-h*b,A=b*v-k*D,B=D*h-v*E,w=x*y+p*A+t*B;if(!(Math.abs(w)<=S)){q=u-q;n=F-n;f=a-f;y=q*y+n*A+f*B;if(0<w){if(0>y||y>w)continue}else if(0<y||y<w)continue;A=n*t-p*f;f=f*x-t*q;n=q*p-x*n;q=D*A+E*f+b*n;if(0<w){if(0>q||y+q>w)continue}else if(0<q||y+q<w)continue;n=(v*A+h*f+k*n)/w;0<=n&&(x=L(x,p,t,v,h,k,T),R(n,x,z))}}}else for(g=e.data,m=e.offsetIdx,C=e.strideIdx,e=
a[0],u=a[1],F=a[2],a=b[0]-e,D=b[1]-u,E=b[2]-F,b=d,d*=3;b<l;++b)if(h=m+C*r[d++],q=g[h++],n=g[h++],f=g[h],h=m+C*r[d++],z=g[h++],x=g[h++],p=g[h],h=m+C*r[d++],t=g[h++],v=g[h++],h=g[h],I.isSome(c)&&(f=c.applyToVertex(q,n,f),q=f[0],n=f[1],f=f[2],p=c.applyToVertex(z,x,p),z=p[0],x=p[1],p=p[2],h=c.applyToVertex(t,v,h),t=h[0],v=h[1],h=h[2]),z-=q,x-=n,p-=f,t-=q,v-=n,h-=f,w=D*h-v*E,y=E*t-h*a,A=a*v-t*D,k=z*w+x*y+p*A,!(Math.abs(k)<=S)){q=e-q;n=u-n;f=F-f;w=q*w+n*y+f*A;if(0<k){if(0>w||w>k)continue}else if(0<w||w<
k)continue;y=n*p-x*f;f=f*z-p*q;n=q*x-z*n;q=a*y+D*f+E*n;if(0<k){if(0>q||w+q>k)continue}else if(0<q||w+q<k)continue;n=(t*y+v*f+h*n)/k;0<=n&&(z=L(z,x,p,t,v,h,T),R(n,z,b))}}function L(a,b,d,l,c,e,g){u.vec3.set(U,a,b,d);u.vec3.set(V,l,c,e);u.vec3.cross(g,U,V);u.vec3.normalize(g,g);return g}function P(a,b,d){return u.vec3.set(d,1/(b[0]-a[0]),1/(b[1]-a[1]),1/(b[2]-a[2]))}function Q(a,b,d,l){return W(a,b,d,l,Infinity)}function W(a,b,d,l,c){var e=(a[0]-l-b[0])*d[0],g=(a[3]+l-b[0])*d[0],m=Math.min(e,g),e=Math.max(e,
g),g=(a[1]-l-b[1])*d[1],r=(a[4]+l-b[1])*d[1],e=Math.min(e,Math.max(g,r));if(0>e)return!1;m=Math.max(m,Math.min(g,r));if(m>e)return!1;g=(a[2]-l-b[2])*d[2];a=(a[5]+l-b[2])*d[2];e=Math.min(e,Math.max(g,a));if(0>e)return!1;m=Math.max(m,Math.min(g,a));return m>e?!1:m<c}function X(a,b){b=b?X(b):{};for(var d in a){var l=a[d];l&&l.forEach&&(l=ca(l));null==l&&d in b||(b[d]=l)}return b}function ca(a){var b=[];a.forEach(function(a){return b.push(a)});return b}Object.defineProperty(c,"__esModule",{value:!0});
c.colorMixModes=c.intersectDrapedRenderLineGeometry=c.updateParameters=c.copyParameters=c.bindScreenSizePerspective=c.verticalOffsetAtDistance=c.intersectAabbInvDirBefore=c.intersectAabbInvDir=c.computeInvDir=c.computeNormal=c.intersectTriangles=c.intersectTriangleGeometry=void 0;var G=J.create(),H=N.VertexAttrConstants;c.intersectTriangleGeometry=function(a,b,d,l,c,e,g){b=Z.isInstanceHidden(b);d=d.tolerance;b||(a.boundingInfo?(N.assert("triangle"===a.data.primitiveType),O(a.boundingInfo,l,c,d,e,
g)):(d=a.getIndices(H.POSITION),a=a.getAttribute(H.POSITION),K(l,c,0,d.length/3,d,a,void 0,e,g)))};var aa=B.vec3f64.create(),S=Math.pow(2,-52),T=B.vec3f64.create();c.intersectTriangles=K;var U=B.vec3f64.create(),V=B.vec3f64.create();c.computeNormal=L;c.computeInvDir=P;c.intersectAabbInvDir=Q;c.intersectAabbInvDirBefore=W;c.verticalOffsetAtDistance=function(a,b,d,c,r){var e=(d.screenLength||0)*a.pixelRatio;r&&(e=Y.scale(e,c,b,r));return M.glClamp(e*Math.tan(.5*a.fovY)/(.5*a.fullHeight)*b,d.minWorldLength||
0,null!=d.maxWorldLength?d.maxWorldLength:Infinity)};c.bindScreenSizePerspective=function(a,b,d){if(a){var c=a.parameters;b.setUniform4f(d,c.divisor,c.offset,c.minPixelSize,a.paddingPixelsOverride)}};c.copyParameters=X;c.updateParameters=function(a,b){var d=!1,c;for(c in b){var r=b[c];void 0!==r&&(d=!0,Array.isArray(r)?a[c]=r.slice():a[c]=r)}return d};c.intersectDrapedRenderLineGeometry=function(a,b,c,l,r){if(b.options.selectionMode){b=a.getAttribute(H.POSITION).data;var e=a.getAttribute(H.SIZE),
d=c[0];c=c[1];a=(((e&&e.data[0])+l)/2+4)*a.screenToWorldRatio;l=Number.MAX_VALUE;for(e=0;e<b.length-5;e+=3){var m=b[e],u=b[e+1],f=d-m,p=c-u,m=b[e+3]-m,u=b[e+4]-u,h=M.clamp((m*f+u*p)/(m*m+u*u),0,1),f=m*h-f,p=u*h-p,p=f*f+p*p;p<l&&(l=p)}l<a*a&&r()}};c.colorMixModes={multiply:1,ignore:2,replace:3,tint:4};var ba=1E3});