// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.17/esri/copyright.txt for details.
//>>built
define("require exports tslib ../../../core/Error ../../../core/events ../../../core/has ../../../core/scheduling ../../../core/SetUtils ../../../core/watchUtils ../../../core/libs/gl-matrix-2/common ../../../core/libs/gl-matrix-2/mat2d ../../../core/libs/gl-matrix-2/mat2df64 ../../../core/libs/gl-matrix-2/vec2 ../../../core/libs/gl-matrix-2/vec2f64 ../../webgl ./Container ./webgl/enums ./webgl/Painter ./webgl/Profiler ./webgl/WebGLDriverTest ./webgl/shaders/StencilPrograms ../support/Timeline ../../support/screenshotUtils".split(" "),
function(A,m,r,E,F,B,G,H,I,J,x,K,n,t,p,C,y,L,M,N,D,O,q){Object.defineProperty(m,"__esModule",{value:!0});m.Stage=m.EXTRA_RENDER_TIME=void 0;m.EXTRA_RENDER_TIME=2E3;A=function(z){function e(a,c){var b=z.call(this)||this;b._trash=new Set;b._clipData=new Float32Array(8);b._upperLeft=t.vec2f64.create();b._upperRight=t.vec2f64.create();b._lowerLeft=t.vec2f64.create();b._lowerRight=t.vec2f64.create();b._mat2=K.mat2df64.create();b._clipRendererInitialized=!1;b._supersampleScreenshots=!0;b.renderRequested=
!1;b.stage=b;b._stationary=!0;var d=c.canvas,d=void 0===d?document.createElement("canvas"):d,f=c.alpha,g=c.stencil,e=c.renderContext,h=c.supersampleScreenshots,h=void 0===h?!0:h,k=c.contextOptions,k=void 0===k?{}:k;b._canvas=d;f=p.createContextOrErrorHTML(d,{alpha:void 0===f?!0:f,antialias:!1,depth:!0,stencil:void 0===g?!0:g},void 0===e?"webgl":e);b.context=new p.RenderingContext(f,k);b.painter=new L.default(b.context,b);B("esri-2d-profiler")&&(b._debugOutput=document.createElement("div"),b._debugOutput.setAttribute("style",
"margin: 24px 64px; position: absolute; color: red;"),a.appendChild(b._debugOutput));b._renderParameters={drawPhase:0,state:b.state,pixelRatio:window.devicePixelRatio,stationary:!1,globalOpacity:1,blendMode:null,deltaTime:-1,time:0,inFadeTransition:!1,effects:null,context:b.context,painter:b.painter,timeline:c.timeline||new O.Timeline,renderingOptions:c.renderingOptions,driverTestResult:N.testWebGLDriver(b.context),profiler:new M.Profiler(b.context,b._debugOutput),dataUploadCounter:0};b._taskHandle=
G.addFrameTask({render:function(a){return b.renderFrame(a)}});b._taskHandle.pause();b._supersampleScreenshots=h;b._lostWebGLContextHandle=F.on(d,"webglcontextlost",function(){b.emit("webgl-error",{error:new E("webgl-context-lost")})});d.setAttribute("style","width: 100%; height:100%; display:block;");a.appendChild(d);return b}r.__extends(e,z);e.prototype.destroy=function(){this.removeAllChildren();this._emptyTrash();this._taskHandle.remove();this._boundFBO=this._taskHandle=null;this._clipFBO&&(this._clipFBO.dispose(),
this._clipFBO=null);this._clipVAO&&(this._clipVAO.dispose(),this._clipVBO=this._clipVAO=null);this._clipStencilProgram&&(this._clipStencilProgram.dispose(),this._clipStencilProgram=null);this._lostWebGLContextHandle&&(this._lostWebGLContextHandle.remove(),this._lostWebGLContextHandle=null);this._canvas.parentNode&&this._canvas.parentNode.removeChild(this._canvas);this._debugOutput&&this._debugOutput.parentNode&&this._debugOutput.parentNode.removeChild(this._debugOutput);this.highlightOptions=null;
this.painter.dispose();this.context.dispose();this._canvas=null};Object.defineProperty(e.prototype,"background",{get:function(){return this._background},set:function(a){this._background=a;this.requestRender()},enumerable:!1,configurable:!0});Object.defineProperty(e.prototype,"highlightOptions",{get:function(){return this._highlightOptions},set:function(a){var c=this;this._highlightOptionsHandle&&(this._highlightOptionsHandle.remove(),this._highlightOptionsHandle=null);if(this._highlightOptions=a)this._highlightOptionsHandle=
I.init(this._highlightOptions,"version",function(){c.painter.setHighlightOptions(a);c.requestRender()})},enumerable:!1,configurable:!0});Object.defineProperty(e.prototype,"renderingOptions",{get:function(){return this._renderingOptions},set:function(a){this._renderingOptions=a;this.requestRender()},enumerable:!1,configurable:!0});Object.defineProperty(e.prototype,"state",{get:function(){return this._state},set:function(a){this._state=a;this.requestRender()},enumerable:!1,configurable:!0});Object.defineProperty(e.prototype,
"stationary",{get:function(){return this._stationary},set:function(a){this._stationary!==a&&(this._stationary=a,this.requestRender())},enumerable:!1,configurable:!0});e.prototype.trashDisplayObject=function(a){this._trash.add(a);this.requestRender()};e.prototype.untrashDisplayObject=function(a){return this._trash.delete(a)};e.prototype.requestRender=function(){this._lastRenderRequestTime=performance.now();this.renderRequested||(this.renderRequested=!0,this.emit("will-render"),this._taskHandle.resume())};
e.prototype.renderFrame=function(a){a.time-this._lastRenderRequestTime>=m.EXTRA_RENDER_TIME&&this._taskHandle.pause();this.renderRequested=!1;this._renderParameters.state=this._state;this._renderParameters.stationary=this.stationary;this._renderParameters.pixelRatio=window.devicePixelRatio;this._renderParameters.globalOpacity=1;this._renderParameters.time=a.time;this._renderParameters.deltaTime=a.deltaTime;this._renderParameters.effects=null;this.processRender(this._renderParameters);this._emptyTrash();
this.emit("post-render")};e.prototype.renderChildren=function(a){this._renderChildren(this.children,a)};e.prototype._renderChildren=function(a,c){var b=this.context;c.profiler.recordStart("drawLayers");c.dataUploadCounter=0;this._beforeRenderChildren(c);c.drawPhase=y.WGLDrawPhase.MAP;this.painter.beforeRenderLayers(b,this.background);for(var d=0;d<a.length;d++){var f=a[d];f.processRender(c)}this.painter.renderLayers(b);if(this._isLabelDrawPhaseRequired(a)){c.drawPhase=y.WGLDrawPhase.LABEL;this.painter.beforeRenderLayers(b);
for(d=0;d<a.length;d++)f=a[d],f.processRender(c);this.painter.renderLayers(b)}if(B("esri-tiles-debug")){c.drawPhase=y.WGLDrawPhase.DEBUG;this.painter.beforeRenderLayers(b);for(d=0;d<a.length;d++)f=a[d],f.processRender(c);this.painter.renderLayers(b)}c.profiler.recordEnd("drawLayers");this._afterRenderChildren()};e.prototype._beforeRenderChildren=function(a){var c=this.context,b=a.state,d=a.pixelRatio;c.enforceState();var f=b.size;a=b.rotation;var g=Math.round(f[0]*d),f=Math.round(f[1]*d);this._boundFBO=
c.getBoundFramebufferObject();if(b.spatialReference&&(b.spatialReference._isWrappable?b.spatialReference._isWrappable():b.spatialReference.isWrappable)){var e=J.common.toRadian(a),h=Math.abs(Math.cos(e)),k=Math.abs(Math.sin(e)),l=Math.round(b.worldScreenWidth);if(Math.round(g*h+f*k)<=l)this._clipFrame=!1;else{this._clipFBO&&this._clipFBO.width===g&&this._clipFBO.height===f||(this._clipFBO=new p.FramebufferObject(c,{colorTarget:0,depthStencilTarget:3,width:g,height:f}));var m=(this.state.padding.left-
this.state.padding.right)/2,q=(this.state.padding.bottom-this.state.padding.top)/2,u=.5*g,r=.5*f,b=1/g,v=1/f,d=.5*l*d,w=.5*(g*k+f*h),g=this._upperLeft,h=this._upperRight,k=this._lowerLeft,l=this._lowerRight;n.vec2.set(g,-d,-w);n.vec2.set(h,d,-w);n.vec2.set(k,-d,w);n.vec2.set(l,d,w);x.mat2d.identity(this._mat2);x.mat2d.translate(this._mat2,this._mat2,[u+m,r+q]);0!==a&&x.mat2d.rotate(this._mat2,this._mat2,e);n.vec2.transformMat2d(g,g,this._mat2);n.vec2.transformMat2d(h,h,this._mat2);n.vec2.transformMat2d(k,
k,this._mat2);n.vec2.transformMat2d(l,l,this._mat2);a=this._clipData;a.set([2*k[0]*b-1,2*(f-k[1])*v-1,2*l[0]*b-1,2*(f-l[1])*v-1,2*g[0]*b-1,2*(f-g[1])*v-1,2*h[0]*b-1,2*(f-h[1])*v-1]);this._clipRendererInitialized||this._initializeClipRenderer(c);this._clipVBO.setData(a);this._boundFBO=c.getBoundFramebufferObject();c.bindFramebuffer(this._clipFBO);c.setDepthWriteEnabled(!0);c.setStencilWriteMask(255);c.setClearColor(0,0,0,0);c.setClearDepth(1);c.setClearStencil(0);c.clear(c.gl.COLOR_BUFFER_BIT|c.gl.DEPTH_BUFFER_BIT|
c.gl.STENCIL_BUFFER_BIT);c.setDepthWriteEnabled(!1);this._clipFrame=!0}}else this._clipFrame=!1};e.prototype._afterRenderChildren=function(){var a=this.context;a.logIno();if(this._clipFrame&&this._clipRendererInitialized){a.bindFramebuffer(this._boundFBO);this._boundFBO=null;a.bindVAO(this._clipVAO);a.bindProgram(this._clipStencilProgram);a.setDepthWriteEnabled(!1);a.setDepthTestEnabled(!1);a.setStencilTestEnabled(!0);a.setBlendingEnabled(!1);a.setColorMask(!1,!1,!1,!1);a.setStencilOp(7680,7680,7681);
a.setStencilWriteMask(255);a.setStencilFunction(519,1,255);a.drawElements(4,6,5123,0);a.bindVAO();a.setColorMask(!0,!0,!0,!0);if(null!=this.background){var c=this.background.color,b=c.a;a.setClearColor(b*c.r/255,b*c.g/255,b*c.b/255,b)}else a.setClearColor(0,0,0,0);a.clear(a.gl.COLOR_BUFFER_BIT);a.setBlendingEnabled(!0);a.setStencilFunction(514,1,255);this.painter.blitTexture(a,this._clipFBO.colorTexture,9728,1);a.setStencilTestEnabled(!1)}};e.prototype.doRender=function(a){var c=this.context,b=a.state,
d=a.pixelRatio;this._resizeCanvas(a);this.context.enforceState();c.setViewport(0,0,d*b.size[0],d*b.size[1]);c.setDepthWriteEnabled(!0);c.setStencilWriteMask(255);z.prototype.doRender.call(this,a)};e.prototype.takeScreenshot=function(a,c){return r.__awaiter(this,void 0,void 0,function(){var b,d,f,g,e,h,k,l,m,n,u,t,v,w;return r.__generator(this,function(x){b=q.screenshotSuperSampleSettings(a,this._supersampleScreenshots,this._state.padding);d=b.framebufferWidth;f=b.framebufferHeight;g=this.context;
e=a.layers;h=this.children;k=r.__assign(r.__assign({},this._renderParameters),{drawPhase:null,globalOpacity:1,stationary:!0,state:this._renderParameters.state.clone(),pixelRatio:b.pixelRatio,time:Date.now(),deltaTime:0,blendMode:null,effects:null,inFadeTransition:!1});null!=a.rotation&&(l=k.state.viewpoint,l.rotation=a.rotation,k.state.viewpoint=l);0<e.length&&(h=[],e.forEach(function(a){var b=c.find(function(b){return b.layer.id===a.id});b&&"container"in b&&b.container&&h.push(b.container)}));m=
new p.FramebufferObject(g,{colorTarget:0,depthStencilTarget:3,width:d,height:f});n=g.getBoundFramebufferObject();u=g.getViewport();g.bindFramebuffer(m);g.setViewport(0,0,d,f);this._renderChildren(h,k);t=this._readbackScreenshot(b);g.bindFramebuffer(n);g.setViewport(u.x,u.y,u.width,u.height);this.requestRender();v=this._ensureScreenshotEncodeCanvas();w=q.encodeResult(t,a,v,{flipY:!0,premultipliedAlpha:!0});return[2,w]})})};e.prototype._ensureScreenshotEncodeCanvas=function(){this._screenshotEncodeCanvas||
(this._screenshotEncodeCanvas=document.createElement("canvas"));return this._screenshotEncodeCanvas};e.prototype._readbackScreenshot=function(a){var c=a.framebufferWidth,b=a.framebufferHeight,d=a.region;a=a.resample;var f=this.context.gl;if(a){var e=q.createEmptyImageData(c,b,this._ensureScreenshotEncodeCanvas());f.readPixels(0,0,c,b,6408,5121,new Uint8Array(e.data.buffer));c=q.createEmptyImageData(d.width,d.height,this._ensureScreenshotEncodeCanvas());return q.resampleHermite(e,c,!0,a.region.x,b-
(a.region.y+a.region.height),a.region.width,a.region.height)}e=q.createEmptyImageData(d.width,d.height,this._ensureScreenshotEncodeCanvas());f.readPixels(d.x,b-(d.y+d.height),d.width,d.height,6408,5121,new Uint8Array(e.data.buffer));return e};e.prototype._resizeCanvas=function(a){var c=this._canvas,b=c.style,d=a.state.size,e=a.pixelRatio;a=d[0];var d=d[1],g=Math.round(a*e),e=Math.round(d*e);if(c.width!==g||c.height!==e)c.width=g,c.height=e;b.width=a+"px";b.height=d+"px"};e.prototype._initializeClipRenderer=
function(a){if(this._clipRendererInitialized)return!0;var c=D.stencil.attributes,b=p.createProgram(a,D.stencil);if(!b)return!1;var d=p.BufferObject.createVertex(a,35040,32),e=new Uint16Array([0,1,2,2,1,3]),e=p.BufferObject.createIndex(a,35044,e);a=new p.VertexArrayObject(a,c,{geometry:[{name:"a_pos",count:2,type:5126,offset:0,stride:8,normalized:!1,divisor:0}]},{geometry:d},e);this._clipStencilProgram=b;this._clipVBO=d;this._clipVAO=a;return this._clipRendererInitialized=!0};e.prototype._emptyTrash=
function(){for(;0<this._trash.size;){var a=H.valuesOfSet(this._trash);this._trash.clear();for(var c=0;c<a.length;c++)a[c].processDetach()}};e.prototype._isLabelDrawPhaseRequired=function(a){for(var c=!1,b=0;b<a.length;b++){var d=a[b];if(!(d instanceof C.Container)){c=c||!1;break}if(d.hasLabels)return!0;c=c||this._isLabelDrawPhaseRequired(d.children)}return c};return e}(C.Container);m.Stage=A});