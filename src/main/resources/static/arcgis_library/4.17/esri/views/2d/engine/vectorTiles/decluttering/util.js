// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.17/esri/copyright.txt for details.
//>>built
define(["require","exports","../../../../../core/maybe","./core"],function(m,e,n,t){Object.defineProperty(e,"__esModule",{value:!0});e.writeOpacityToBuffers=e.deserializeSymbols=e.GridIndex=e.tileCoordChange=e.TileForest=e.TileGraph=e.TileNode=void 0;var q=function(){return function(b){this.tile=b;this.parent=null;this.children=new Set}}();e.TileNode=q;var r=function(){function b(){this.nodes=new Map;this.roots=new Set}b.prototype.create=function(a){var h=this,c=new q(a),b,l=[];this.nodes.forEach(function(a){h._canConnectDirectly(c,
a)&&l.push(a);!b&&h._canConnectDirectly(a,c)&&(b=a)});if(b){for(var k=0;k<l.length;k++){var g=l[k];b.children.delete(g);c.children.add(g);g.parent=c}b.children.add(c);c.parent=b}else for(this.roots.add(c),k=0;k<l.length;k++)g=l[k],c.children.add(g),g.parent=c,this.roots.delete(g);this.nodes.set(a.key.id,c);return c};b.prototype.destroy=function(a){var b=this;n.isSome(a.parent)?(a.parent.children.delete(a),a.children.forEach(function(c){n.isSome(a.parent)&&a.parent.children.add(c)})):this.roots.delete(a);
a.children.forEach(function(c){(c.parent=a.parent)||b.roots.add(c)});this.nodes.delete(a.tile.key.id)};b.prototype.clear=function(){this.roots.clear();this.nodes.clear()};b.prototype._canConnectDirectly=function(a,b){var c=b.tile.key,h=c.level,l=c.row,c=c.col;for(b=b.tile.key.world;0<h;){h--;l>>=1;c>>=1;if(a.tile.key.level===h&&a.tile.key.row===l&&a.tile.key.col===c&&a.tile.key.world===b)return!0;if(this.nodes.has(h+"/"+l+"/"+c+"/"+b))break}return!1};return b}();e.TileGraph=r;m=function(){function b(){this._tileGraph=
new r;this._tileArray=null}b.prototype.has=function(a){return this.hasKey(a.key.id)};b.prototype.getAll=function(){var a=this;this._tileArray||(this._tileArray=[],this._tileGraph.nodes.forEach(function(b){a._tileArray.push(b.tile)}));return this._tileArray};b.prototype.getRoots=function(){var a=[];this._tileGraph.roots.forEach(function(b){a.push(b.tile)});return a};b.prototype.getParent=function(a){a=this._tileGraph.nodes.get(a.key.id);return n.isSome(a.parent)&&a.parent.tile};b.prototype.getChildren=
function(a){var b=[];this._tileGraph.nodes.get(a.key.id).children.forEach(function(a){b.push(a.tile)});return b};b.prototype.get=function(a){return this._tileGraph.nodes.get(a).tile};b.prototype.hasKey=function(a){return this._tileGraph.nodes.has(a)};b.prototype.removeKey=function(a){a=this._tileGraph.nodes.get(a);this._tileGraph.destroy(a);this._tileArray=null};b.prototype.forEach=function(a){this._tileGraph.nodes.forEach(function(b,c){return a(b.tile,c)})};b.prototype.add=function(a){this._tileGraph.create(a);
this._tileArray=null};b.prototype.remove=function(a){a=this._tileGraph.nodes.get(a.key.id);this._tileGraph.destroy(a);this._tileArray=null};b.prototype.clear=function(){this._tileGraph.clear();this._tileArray=[]};return b}();e.TileForest=m;e.tileCoordChange=function(b,a,h,c,e,l){h-=e;if(0<=h)return(a>>h)+(c-(l<<h))*(b>>h);h=-h;return a-(l-(c<<h))*(b>>h)<<h};m=function(){function b(a,b,c){this._rows=Math.ceil(b/c);this._columns=Math.ceil(a/c);this._cellSize=c;this.cells=Array(this._rows);for(a=0;a<
this._rows;a++)for(this.cells[a]=Array(this._columns),b=0;b<this._columns;b++)this.cells[a][b]=[]}b.prototype.getCell=function(a,b){b=Math.min(Math.max(Math.floor(b/this._cellSize),0),this._rows-1);a=Math.min(Math.max(Math.floor(a/this._cellSize),0),this._columns-1);return this.cells[b]&&this.cells[b][a]||null};b.prototype.getCellSpan=function(a,b,c,e){return[Math.min(Math.max(Math.floor(a/this._cellSize),0),this.columns-1),Math.min(Math.max(Math.floor(b/this._cellSize),0),this.rows-1),Math.min(Math.max(Math.floor(c/
this._cellSize),0),this.columns-1),Math.min(Math.max(Math.floor(e/this._cellSize),0),this.rows-1)]};Object.defineProperty(b.prototype,"cellSize",{get:function(){return this._cellSize},enumerable:!1,configurable:!0});Object.defineProperty(b.prototype,"columns",{get:function(){return this._columns},enumerable:!1,configurable:!0});Object.defineProperty(b.prototype,"rows",{get:function(){return this._rows},enumerable:!1,configurable:!0});return b}();e.GridIndex=m;e.deserializeSymbols=function(b,a,h,c,
e){for(var l=a[c++],k=0;k<l;k++){var g=new t.VTLSymbol;g.xTile=a[c++];g.yTile=a[c++];g.hash=a[c++];g.priority=a[c++];for(var f=a[c++],d=0;d<f;d++){var p=a[c++],u=a[c++],m=a[c++],n=a[c++],q=!!a[c++],r=a[c++],v=h[c++],w=h[c++],x=a[c++],y=a[c++];g.colliders.push({xTile:p,yTile:u,dxPixels:m,dyPixels:n,hard:q,partIndex:r,width:x,height:y,minLod:v,maxLod:w})}f=b[c++];for(d=0;d<f;d++)g.textVertexRanges.push([b[c++],b[c++]]);f=b[c++];for(d=0;d<f;d++)g.iconVertexRanges.push([b[c++],b[c++]]);e.push(g)}return c};
e.writeOpacityToBuffers=function(b,a,h){b.symbols.forEach(function(c,e){e=b.layerData[e];if(3===e.type){for(var l=0;l<c.length;l++){var k=c[l],g=k.unique,f=void 0;if(k.selectedForRendering){var d=g.parts[0],f=d.startOpacity,d=d.targetOpacity;b.allSymbolsFadingOut=b.allSymbolsFadingOut&&0===d;f=h?Math.floor(127*f)|d<<7:d?255:0;f|=f<<24|f<<16|f<<8}else f=0;for(var p=0,m=k.iconVertexRanges;p<m.length;p++)for(var d=m[p],n=d[0],q=d[1],d=n;d<n+q;d+=4)e.iconOpacity[d/4]=f;k.selectedForRendering?(g=g.parts[1],
f=g.startOpacity,d=g.targetOpacity,b.allSymbolsFadingOut=b.allSymbolsFadingOut&&0===d,f=h?Math.floor(127*f)|d<<7:d?255:0,f|=f<<24|f<<16|f<<8):f=0;g=0;for(k=k.textVertexRanges;g<k.length;g++)for(d=k[g],p=d[0],m=d[1],d=p;d<p+m;d+=4)e.textOpacity[d/4]=f}e.lastOpacityUpdate=a;e.opacityChanged=!0}})}});