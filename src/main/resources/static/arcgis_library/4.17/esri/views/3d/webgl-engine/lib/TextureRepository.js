// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.17/esri/copyright.txt for details.
//>>built
define("require exports ../../../../core/Evented ../../../../core/Logger ../../../../core/maybe ../../../../core/promiseUtils ./TextureTechnique ./Util ../../../support/Scheduler ../../../webgl/Texture".split(" "),function(g,d,u,v,e,n,k,w,p,q){Object.defineProperty(d,"__esModule",{value:!0});d.RefCountedTexture=d.TextureRepository=void 0;var r=v.getLogger("esri.views.3d.webgl-engine.lib.TextureRepository");g=function(){function a(c,b,a,h){this._textures=b;this.rctx=h;this._idToRefCountedTexture=new Map;
this._textureTechniqueConfig=new k.TextureTechniqueConfiguration;this._loadingCount=0;this._frameUpdates=new Map;this._fallbackTextureData=new Uint8Array(256);this._fallbackTextureTransparentData=new Uint8Array(256);this.events=new u;this._textureTechnique=a.acquireAndReleaseExisting(k.TextureTechnique,this._textureTechniqueConfig,this._textureTechnique);for(b=0;b<this._fallbackTextureData.length;++b)this._fallbackTextureData[b]=255,this._fallbackTextureTransparentData[b]=0!==(b+1)%4?255:0;this._fallbackTextureDesc=
{target:3553,pixelFormat:6408,dataType:5121,samplingMode:9728,width:8,height:8,maxAnisotropy:this.rctx.parameters.maxMaxAnisotropy};this._frameTask=e.isSome(c)?c.registerTask(p.Task.TEXTURE_UNLOAD,function(){},function(){return!1}):new p.TestTaskHandle}a.prototype.dispose=function(){this._frameTask.remove();e.isSome(this._fallbackTexture)&&(this._fallbackTexture.dispose(),this._fallbackTexture=null);e.isSome(this._fallbackTextureTransparent)&&(this._fallbackTextureTransparent.dispose(),this._fallbackTextureTransparent=
null);this._textures.forEach(function(c){return c.unload()})};a.prototype.acquire=function(c,b,a){void 0===b&&(b=!1);c=this._getOrCreateRef(c,b,a);c.ref();return c};a.prototype.update=function(){var c=this,b=!1;this._frameUpdates.forEach(function(a){var h=a.texture.frameUpdate(c.rctx,c._textureTechnique,a.previousToken);0<=h&&h!==a.previousToken&&(a.previousToken=h,b=!0)});b&&this.events.emit("changed",0)};a.prototype._getOrCreateRef=function(c,a,l){var b=this._idToRefCountedTexture.get(c);return b?
b:this._createNewRef(c,a,l)};a.prototype._createNewRef=function(c,a,l){var b=this,d=this._textures.get(c);w.assert(void 0!==d);var e=d.events.on("unloaded",function(){e.remove();b._onTextureUnloaded(c)}),f=new t;this._idToRefCountedTexture.set(c,f);var m=d.load(this.rctx,this._textureTechnique);this._loadingCount++;var g=function(a){b._loadingCount--;b._updateGLTexture(f,a);l&&l(f);d.requiresFrameUpdates&&b._frameUpdates.set(c,{texture:d,previousToken:-1});return f},k=function(a){b._loadingCount--;
n.isAbortError(a)||r.error(a)};n.isThenable(m)?(this._updateGLTexture(f,a?this.fallbackTextureTransparent:this.fallbackTexture),m.then(g,k)):g(m);return f};a.prototype._updateGLTexture=function(a,b){a.glTexture=b;this.events.emit("changed",1)};a.prototype.release=function(a){var b=this._idToRefCountedTexture.get(a);if(b&&(b.unref(),b.isUnreferenced)){var c=this._textures.get(a);this._frameTask.schedule(function(){b.isUnreferenced&&c.unload()})}};a.prototype.getTexture=function(a){return this._textures.get(a)};
Object.defineProperty(a.prototype,"loadingCount",{get:function(){return this._loadingCount},enumerable:!1,configurable:!0});a.prototype._onTextureUnloaded=function(a){this._idToRefCountedTexture.delete(a);this._frameUpdates.delete(a)};Object.defineProperty(a.prototype,"fallbackTexture",{get:function(){e.isNone(this._fallbackTexture)&&(this._fallbackTexture=new q(this.rctx,this._fallbackTextureDesc,this._fallbackTextureData));return this._fallbackTexture},enumerable:!1,configurable:!0});Object.defineProperty(a.prototype,
"fallbackTextureTransparent",{get:function(){e.isNone(this._fallbackTextureTransparent)&&(this._fallbackTextureTransparent=new q(this.rctx,this._fallbackTextureDesc,this._fallbackTextureTransparentData));return this._fallbackTextureTransparent},enumerable:!1,configurable:!0});return a}();d.TextureRepository=g;var t=function(){function a(){this._refCount=0;this.glTexture=null}Object.defineProperty(a.prototype,"isUnreferenced",{get:function(){return 0===this._refCount},enumerable:!1,configurable:!0});
a.prototype.ref=function(){++this._refCount};a.prototype.unref=function(){0===this._refCount?r.error("Cannot dereference texture that has no references!"):--this._refCount};return a}();d.RefCountedTexture=t});