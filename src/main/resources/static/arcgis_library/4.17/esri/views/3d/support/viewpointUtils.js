// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.17/esri/copyright.txt for details.
//>>built
define("require exports tslib ../../../Camera ../../../geometry ../../../Graphic ../../../Viewpoint ../../../core/asyncUtils ../../../core/compilerUtils ../../../core/Error ../../../core/maybe ../../../core/promiseUtils ../../../core/libs/gl-matrix-2/mat3 ../../../core/libs/gl-matrix-2/mat3f64 ../../../core/libs/gl-matrix-2/mat4f64 ../../../core/libs/gl-matrix-2/vec3 ../../../core/libs/gl-matrix-2/vec3f64 ../../../geometry/support/aaBoundingBox ../../../geometry/support/aaBoundingRect ../../../geometry/support/webMercatorUtils ../camera/intersectionUtils ./cameraUtils ./ElevationProvider ./geometryUtils ./mathUtils ./pointUtils ./projectionUtils".split(" "),
function(ta,n,f,N,x,fa,G,W,ga,O,ha,ia,X,ja,ka,l,E,v,Y,z,F,m,Z,la,aa,B,P){function Q(a){return 360-aa.cyclicalDeg.normalize(a)}function C(a){return aa.cyclicalDeg.normalize(360-a)}function H(a,b){a&&a.resolver&&(null==b?a.resolver.reject():a.resolver.resolve(b));return b}function ba(a,b,c,e){if(!b)return H(e);var d=a.spatialReference||x.SpatialReference.WGS84;if(b.camera){a=b.get("camera.position.spatialReference");if(!z.canProject(a,d))return H(e);b=b.camera.clone();a.equals(d)||(b.position=z.project(b.position,
d));return H(e,b)}var h=b.get("targetGeometry.spatialReference");if(h&&!z.canProject(h,d))return H(e);d=m.internalToExternal(a,a.state.camera);h=1;null!=b.rotation&&(d.heading=Q(b.rotation),h=0);null!=c&&(d.tilt=c);if("point"===b.targetGeometry.type){c=b.targetGeometry;var g=void 0,q=b.targetGeometry.clone(),g=null!=b.scale?m.scaleToDistance(a,b.scale,c.latitude):a.state.camera.distance;return m.fromCenterDistance(a,q,g,d,h,e)}return m.fromExtent(a,b.targetGeometry.extent,d.heading,d.tilt,h,e)}function R(a,
b){return null==b.scale&&null!=b.zoom?m.zoomToScale(a,b.zoom):b.scale}function S(a,b){var c=!1;null!=b.heading?(a.heading=b.heading,c=!0):null!=b.rotation&&(a.heading=Q(b.rotation),c=!0);null!=b.tilt&&(a.tilt=b.tilt,c=!0);null!=b.fov&&(a.fov=b.fov);return c}function I(a,b,c){var e=a.spatialReference||x.SpatialReference.WGS84;b=b||m.externalToInternal(a,c.camera);c.targetGeometry=B.vectorToPoint(b.center,a.renderSpatialReference,e);c.scale=m.computeScale(a,b);c.rotation=C(c.camera.heading);return c}
function J(a,b,c){if(b){if(!z.canProject(b.spatialReference,a.spatialReference))throw new O("viewpointutils:incompatible-spatialreference","Spatial reference ("+(b.spatialReference?b.spatialReference.wkid:"unknown")+") is incompatible with the view ("+a.spatialReference.wkid+")",{geometry:b});var e=[];if(!b.hasZ&&a.basemapTerrain){var d=void 0;switch(b.type){case "point":d=b;break;case "multipoint":case "polyline":case "mesh":d=b.extent.center;break;case "extent":d=b.center;break;case "polygon":d=
b.centroid;break;default:ga.neverReached(b)}d&&z.canProject(d,a.basemapTerrain.spatialReference)?k[2]=Z.getElevationAtPoint(a.elevationProvider,d)||0:k[2]=0}(0,ma[b.type])(b,function(a){e.push(a[0],a[1],a[2])},k);var h=e.length/3;if(0!==h&&(d=Array(e.length),P.bufferToBuffer(e,b.spatialReference,0,d,a.spatialReference,0,h)))for(b.hasZ&&(c.hasZ=!0),a=0;a<d.length;a+=3)b.hasZ?(k[0]=d[a+0],k[1]=d[a+1],k[2]=d[a+2]):(k[0]=d[a+0],k[1]=d[a+1]),v.expand(c.boundingBox,k)}}function na(a,b,c,e){return f.__awaiter(this,
void 0,void 0,function(){var d,h,g,q,m,k;return f.__generator(this,function(l){switch(l.label){case 0:return[4,W.result(a.whenViewForGraphic(b))];case 1:d=l.sent();if(!1===d.ok||ha.isNone(d.value)||!("whenGraphicBounds"in d.value))return J(a,b.geometry,e),[2];h=d.value;return[4,W.result(h.whenGraphicBounds(b,{minDemResolution:c}))];case 2:g=l.sent();if(!1===g.ok)return J(a,b.geometry,e),[2];q=g.value;m=q.screenSpaceObjects;k=q.boundingBox;v.expand(e.boundingBox,k);m&&m.forEach(function(a){e.screenSpaceObjects.push(a)});
isFinite(k[2])&&(e.hasZ=!0);return[2]}})})}function ca(a,b,c,e){return f.__awaiter(this,void 0,void 0,function(){var d,h;return f.__generator(this,function(g){switch(g.label){case 0:return Array.isArray(b)&&2===b.length&&(d=b[0],h=b[1],"number"===typeof d&&"number"===typeof h)?(p.x=d,p.y=h,p.z=void 0,p.spatialReference=a.spatialReference.isGeographic?a.spatialReference:x.SpatialReference.WGS84,J(a,p,e),[2]):b&&"function"===typeof b.map?[4,ia.eachAlways(b.map(function(b){return ca(a,b,c,e)}))]:[3,
2];case 1:return g.sent(),[2];case 2:if(!(b instanceof x.BaseGeometry))return[3,3];J(a,b,e);return[3,5];case 3:return b instanceof fa?[4,na(a,b,c,e)]:[3,5];case 4:g.sent(),g.label=5;case 5:return[2]}})})}function oa(a,b,c,e,d){return f.__awaiter(this,void 0,void 0,function(){var h,g,k;return f.__generator(this,function(l){switch(l.label){case 0:if(b.camera)return[2,da(a,b.camera,d)];d.scale=b.scale;d.rotation=b.rotation;d.targetGeometry=b.targetGeometry?b.targetGeometry.clone():null;d.camera=null;
null!=c.heading?d.rotation=C(c.heading):null!=c.rotation&&(d.rotation=c.rotation);h=R(a,c);null!=h&&(d.scale=h);g=m.createAsyncContext(e);ba(a,d,c.tilt,g);k=d;return[4,g.resolver.promise];case 1:return k.camera=l.sent(),[2,d]}})})}function da(a,b,c){c.camera=b.clone();c.camera.fov=a.camera.fov;b=a.spatialReference;var e=c.camera.position.spatialReference;if(!z.canProject(e,b))return null;e.equals(b)||(c.camera.position=z.project(c.camera.position,b));return I(a,null,c)}function T(a,b,c,e,d){return f.__awaiter(this,
void 0,void 0,function(){var h,g,q,p,n,t;return f.__generator(this,function(f){switch(f.label){case 0:if(!c)throw new O("createfromcenter","invalid point");d.targetGeometry=c.clone();h=F.cameraOnContentAlongViewDirection(a);if(b.position){f=d.targetGeometry;var v=h,u=a.renderSpatialReference;B.pointToVector(b.position,K,u);B.pointToVector(f,U,u);d.targetGeometry=new x.Point(f);d.camera.position=new x.Point(b.position);l.vec3.subtract(L,U,K);m.directionToHeadingTilt(a,K,L,v.up,d.camera);d.scale=m.distanceToScale(a,
l.vec3.distance(K,U),d.targetGeometry.latitude);d.rotation=C(d.camera.heading);return[2,d]}b.zoomFactor&&(g=h.distance/b.zoomFactor,q=l.vec3.scale(k,h.viewForward,-g),l.vec3.add(h.eye,h.center,q),h.markViewDirty(),d.scale=m.distanceToScale(a,g,c.latitude));m.internalToExternal(a,h,d.camera);p=S(d.camera,b)?0:1;if(b.zoomFactor)return[3,2];d.scale=R(a,b);null==d.scale&&(B.pointToVector(c,k,a.renderSpatialReference),la.frustum.intersectsPoint(h.frustum.planes,k)?d.scale=m.distanceToScale(a,l.vec3.distance(h.eye,
k),c.latitude):d.scale=m.computeScale(a,h));n=m.createAsyncContext(e);m.fromCenterScale(a,d.targetGeometry,d.scale,d.camera,p,n);t=d;return[4,n.resolver.promise];case 1:t.camera=f.sent(),f.label=2;case 2:return[2,d]}})})}function pa(a,b,c,e){return f.__awaiter(this,void 0,void 0,function(){var d,h;return f.__generator(this,function(g){d=F.cameraOnContentAlongViewDirection(a);h=B.vectorToPoint(d.center,a.renderSpatialReference,a.spatialReference,p);return[2,T(a,b,h,c,e)]})})}function qa(a,b,c,e,d){return f.__awaiter(this,
void 0,void 0,function(){var h,g,k,l;return f.__generator(this,function(f){switch(f.label){case 0:return d.targetGeometry=c.clone(),h=F.cameraOnContentAlongViewDirection(a),m.internalToExternal(a,h,d.camera),g=S(d.camera,b)?0:1,k=m.createAsyncContext(e),m.fromExtent(a,c,d.camera.heading,d.camera.tilt,g,k),l=d,[4,k.resolver.promise];case 1:return l.camera=f.sent(),[2,d]}})})}function ra(a,b,c,e,d,h,g){return f.__awaiter(this,void 0,void 0,function(){var q,n,p,t,x;return f.__generator(this,function(f){switch(f.label){case 0:g.targetGeometry=
c.clone();f=q=F.cameraOnContentAlongViewDirection(a);var u=0;c.hasZ?u=c.z:a.basemapTerrain&&(u=Z.getElevationAtPoint(a.elevationProvider,c));l.vec3.set(k,c.x,c.y,u);P.computeLinearTransformation(a.spatialReference,k,ea,a.renderSpatialReference);X.mat3.fromMat4(M,ea);X.mat3.transpose(M,M);v.empty(D);for(var w=[[0,1,2],[3,1,2],[0,4,2],[3,4,2],[0,1,5],[3,1,5],[0,4,5],[3,4,5]],A=0;A<w.length;A++){var y=w[A],r=e[y[2]];isFinite(r)||(r=u);l.vec3.set(k,e[y[0]],e[y[1]],r);P.vectorToVector(k,a.spatialReference,
k,a.renderSpatialReference);v.expand(D,l.vec3.transformMat3(k,k,M))}u=v.width(D);w=v.height(D);A=v.depth(D);y=1/Math.tan(f.fovY/2);n=Math.max(.5*Math.sqrt(u*u+A*A)*Math.max(y,1/Math.tan(f.fovX/2))+.5*w,.5*w*y+.5*Math.max(u,A))/d;m.internalToExternal(a,q,g.camera);p=S(g.camera,b)?0:1;g.scale=m.distanceToScale(a,n,g.targetGeometry.latitude);t=m.createAsyncContext(h);m.fromCenterScale(a,g.targetGeometry,g.scale,g.camera,p,t);x=g;return[4,t.resolver.promise];case 1:return x.camera=f.sent(),[2,g]}})})}
function w(a){a&&(a.rotation=C(a.camera.heading));return a}Object.defineProperty(n,"__esModule",{value:!0});n.create=n.fromCamera=n.fromInternalCamera=n.toCamera=n.headingToRotation=n.rotationToHeading=void 0;n.rotationToHeading=Q;n.headingToRotation=C;n.toCamera=ba;n.fromInternalCamera=function(a,b,c){c||(c=new G({camera:new N}));m.internalToExternal(a,b,c.camera);return I(a,b,c)};n.fromCamera=function(a,b,c){c||(c=new G);c.camera=b.clone();return I(a,null,c)};n.create=function(a,b,c){return f.__awaiter(this,
void 0,void 0,function(){var e,d,h,g,n,z,B,t,C,D,u,E,A;return f.__generator(this,function(f){switch(f.label){case 0:if(b&&a.spatialReference){f={target:null};if("declaredClass"in b||Array.isArray(b))f.target=b;else{for(var r in b)f[r]=b[r];b.center&&!f.target&&(f.target=b.center)}e=f}else e=null;if(!e)throw new O("viewpointutils-create:no-target","Missing target for creating viewpoint");d=new G({camera:new N({fov:a.camera.fov})});return e.target instanceof G?[4,oa(a,e.target,e,c,d)]:[3,2];case 1:return h=
f.sent(),[2,w(h)];case 2:if(e.target instanceof N)return[2,w(da(a,e.target,d))];g=null!=e.scale||null!=e.zoom;if(!(e.target instanceof x.Extent))return[3,6];n=e.target.xmin===e.target.xmax||e.target.ymin===e.target.ymax;if(!g&&!n)return[3,4];z=w;return[4,T(a,e,e.target.center,c,d)];case 3:return[2,z.apply(void 0,[f.sent()])];case 4:return B=w,[4,qa(a,e,e.target,c,d)];case 5:return[2,B.apply(void 0,[f.sent()])];case 6:return t={boundingBox:v.empty(),hasZ:!1,screenSpaceObjects:[]},C=g?m.scaleToResolution(a,
R(a,e)):void 0,[4,ca(a,e.target,C,t)];case 7:f.sent();if(!isFinite(t.boundingBox[0]))return[3,11];v.center(t.boundingBox,k);p.x=k[0];p.y=k[1];p.z=k[2];p.spatialReference=a.spatialReference;n=void 0;isFinite(p.z)&&t.hasZ?n=v.isPoint(t.boundingBox):(p.z=void 0,n=Y.isPoint(v.toRect(t.boundingBox,sa)));if(!g&&!n)return[3,9];D=w;return[4,T(a,e,p,c,d)];case 8:return[2,D.apply(void 0,[f.sent()])];case 9:r=t.screenSpaceObjects;if(r.length){f=Number.NEGATIVE_INFINITY;for(var q=0;q<r.length;q++){var y=r[q].screenSpaceBoundingRect;
f=Math.max(f,Math.abs(y[0]),Math.abs(y[1]),Math.abs(y[2]),Math.abs(y[3]))}u=.66-f/Math.min(a.width,a.height)*2}else u=.66;E=w;return[4,ra(a,e,p,t.boundingBox,u,c,d)];case 10:return[2,E.apply(void 0,[f.sent()])];case 11:if(e.position)return r=e,f=d,q=F.cameraOnContentAlongViewDirection(a),l.vec3.copy(L,q.viewForward),m.directionToHeadingTilt(a,q.eye,L,q.up,V),f.camera.position=new x.Point(r.position),f.camera.heading=null!=r.heading?r.heading:V.heading,f.camera.tilt=null!=r.tilt?r.tilt:V.tilt,r=I(a,
null,f),[2,w(r)];A=w;return[4,pa(a,e,c,d)];case 12:return[2,A.apply(void 0,[f.sent()])]}})})};var k=E.vec3f64.create(),ea=ka.mat4f64.create(),M=ja.mat3f64.create(),D=v.create(),sa=Y.create(),L=E.vec3f64.create(),K=E.vec3f64.create(),U=E.vec3f64.create(),V={heading:0,tilt:0},p=new x.Point,ma={point:function(a,b,c){c[0]=a.x;c[1]=a.y;a.hasZ&&(c[2]=a.z);b(c)},polygon:function(a,b,c){for(var e=a.hasZ,d=0;d<a.rings.length;d++)for(var f=a.rings[d],g=0;g<f.length;g++)c[0]=f[g][0],c[1]=f[g][1],e&&(c[2]=f[g][2]),
b(c)},polyline:function(a,b,c){for(var e=a.hasZ,d=0;d<a.paths.length;d++)for(var f=a.paths[d],g=0;g<f.length;g++)c[0]=f[g][0],c[1]=f[g][1],e&&(c[2]=f[g][2]),b(c)},multipoint:function(a,b,c){var e=a.points;a=a.hasZ;for(var d=0;d<e.length;d++)c[0]=e[d][0],c[1]=e[d][1],a&&(c[2]=e[d][2]),b(c)},extent:function(a,b,c){a.hasZ?(b(l.vec3.set(c,a.xmin,a.ymin,a.zmin)),b(l.vec3.set(c,a.xmax,a.ymin,a.zmin)),b(l.vec3.set(c,a.xmin,a.ymax,a.zmin)),b(l.vec3.set(c,a.xmax,a.ymax,a.zmin)),b(l.vec3.set(c,a.xmin,a.ymin,
a.zmax)),b(l.vec3.set(c,a.xmax,a.ymin,a.zmax)),b(l.vec3.set(c,a.xmin,a.ymax,a.zmax)),b(l.vec3.set(c,a.xmax,a.ymax,a.zmax))):(b(l.vec3.set(c,a.xmin,a.ymin,c[2])),b(l.vec3.set(c,a.xmax,a.ymin,c[2])),b(l.vec3.set(c,a.xmin,a.ymax,c[2])),b(l.vec3.set(c,a.xmax,a.ymax,c[2])))},mesh:function(a,b,c){if(a=a.vertexAttributes&&a.vertexAttributes.position)for(var e=0;e<a.length;e+=3)b(l.vec3.set(c,a[e+0],a[e+1],a[e+2]))}}});