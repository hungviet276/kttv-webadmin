// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.17/esri/copyright.txt for details.
//>>built
define("require exports tslib ../../../assets ../../../core/promiseUtils ../../webgl ../engine/DisplayObject ../engine/webgl/enums ../engine/webgl/shaders/MagnifierPrograms".split(" "),function(f,r,q,t,v,p,w,x,u){Object.defineProperty(r,"__esModule",{value:!0});f=function(f){function b(){var a=f.call(this)||this;a.visible=!1;return a}q.__extends(b,f);b.prototype.destroy=function(){this._readbackTexture&&(this._readbackTexture.dispose(),this._readbackTexture=null,this._maskTexture.dispose(),this._maskTexture=
null,this._overlayTexture.dispose(),this._overlayTexture=null,this._vertexArrayObject.dispose(),this._vertexArrayObject=null,this._program.dispose(),this._resourcesPromise=this._program=null)};Object.defineProperty(b.prototype,"background",{get:function(){return this._background},set:function(a){this._background=a;this.requestRender()},enumerable:!1,configurable:!0});Object.defineProperty(b.prototype,"magnifier",{get:function(){return this._magnifier},set:function(a){var g=this;this._magnifier=a;
this._handle&&this._handle.remove();this._handle=a.watch("version",function(){g.visible=a.visible;g.requestRender()});this.visible=a.visible;this.requestRender()},enumerable:!1,configurable:!0});b.prototype.doRender=function(a){var g,c=a.context;if(!this._resourcesPromise)this._resourcesPromise=this._loadResources("esri/images/magnifier/mask.png","esri/images/magnifier/overlay.png");else if(a.drawPhase===x.WGLDrawPhase.MAP&&this._canRender()){this._updateResources(c);var n=this._magnifier,e=1/n.factor,
d=Math.ceil(e*this.overlay.width),h=Math.ceil(e*this.overlay.height),k=a.state.size,l=a.pixelRatio,e=l*k[0];a=l*k[1];var m=n.position||{x:.5*k[0],y:.5*k[1]},k=l*m.x,l=a-l*m.y,m=.5*d,b=.5*h;m>k?k=m:k>=e-m&&(k=e-m-1);b>l?l=b:l>=a-b&&(l=a-b-1);var m=k-m,b=l-b,f=this._readbackTexture;c.bindTexture(f,0);c.gl.copyTexImage2D(f.descriptor.target,0,f.descriptor.pixelFormat,m,b,d,h,0);g=(d=null===(g=this.background)||void 0===g?void 0:g.color)?[d.a*d.r/255,d.a*d.g/255,d.a*d.b/255,d.a]:[1,1,1,1];d=-1+(k+n.offsetX)/
e*2;n=-1+(l-n.offsetY)/a*2;e=this.overlay.width/e*2;a=this.overlay.height/a*2;h=this._program;c.bindVAO(this._vertexArrayObject);c.bindTexture(this._overlayTexture,6);c.bindTexture(this._maskTexture,7);c.bindProgram(h);h.setUniform4fv("u_background",g);h.setUniform1i("u_readbackTexture",0);h.setUniform1i("u_overlyTexture",6);h.setUniform1i("u_maskTexture",7);h.setUniform2f("u_drawPos",d,n);h.setUniform1f("u_width",e);h.setUniform1f("u_height",a);c.setStencilTestEnabled(!1);c.drawArrays(5,0,4);c.bindVAO()}};
b.prototype._canRender=function(){return this.mask&&this.overlay&&null!=this._magnifier};b.prototype._loadResources=function(a,b){return q.__awaiter(this,void 0,void 0,function(){var c,g,e;return q.__generator(this,function(d){switch(d.label){case 0:return[4,v.all([t.fetchAsset(a,{responseType:"image"}),t.fetchAsset(b,{responseType:"image"})])];case 1:return c=d.sent(),g=c[0].data,e=c[1].data,this.mask=g,this.overlay=e,this.requestRender(),[2]}})})};b.prototype._updateResources=function(a){if(!this._readbackTexture){var b=
1/this._magnifier.factor,c=Math.ceil(b*this.overlay.width),b=Math.ceil(b*this.overlay.height);this._program=u.createMagnifierProgram(a);var f=new Uint16Array([0,1,0,0,1,1,1,0]);this._vertexArrayObject=new p.VertexArrayObject(a,u.magnifierProgramTemplate.attributes,{geometry:[{name:"a_pos",count:2,type:5123,offset:0,stride:4,normalized:!1,divisor:0}]},{geometry:p.BufferObject.createVertex(a,35044,f)});this._overlayTexture=new p.Texture(a,{target:3553,pixelFormat:6408,internalFormat:6408,dataType:5121,
wrapMode:33071,samplingMode:9728,flipped:!0},this.overlay);this._maskTexture=new p.Texture(a,{target:3553,pixelFormat:6408,internalFormat:6408,dataType:5121,wrapMode:33071,samplingMode:9728,flipped:!0},this.mask);this._readbackTexture=new p.Texture(a,{target:3553,pixelFormat:6408,internalFormat:6408,dataType:5121,wrapMode:33071,samplingMode:9729,flipped:!1,width:c,height:b})}};return b}(w.DisplayObject);r.default=f});