// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.17/esri/copyright.txt for details.
//>>built
define("require exports tslib ../../../../../core/Error ../../../../../core/Logger ../../../../../core/LRUCache ../../../../../core/promiseUtils ../../../../../support/arcadeOnDemand ../../../../../symbols/cim/cimSymbolUtils ../../../../../symbols/cim/utils ../../../arcade/callExpressionWithFeature ../../../layers/features/schemaUtils @dojo/framework/shim/Promise".split(" "),function(z,k,g,A,l,B,q,C,p,D,E,F){function G(h,e){return g.__awaiter(this,void 0,void 0,function(){var a,f;return g.__generator(this,
function(d){switch(d.label){case 0:return a=h||1,"number"===typeof a?[2,function(d,c,f){return a}]:[4,C.createRendererExpression(a,e.spatialReference,e.fields)];case 1:return f=d.sent(),[2,function(a,d,g){return E.default(f,a,{$view:g},e.geometryType,d)||1}]}})})}Object.defineProperty(k,"__esModule",{value:!0});k.DictionaryMatcher=k.MapMatcher=k.IntervalMatcher=k.FeatureMatcher=void 0;var v=l.getLogger("esri/views/2d/engine/webgl/util/Matcher");l=function(){function h(){this.type="feature";this._defaultResult=
null}h.fromBasicRenderer=function(e,a,f){return g.__awaiter(this,void 0,void 0,function(){var d,b,c;return g.__generator(this,function(g){switch(g.label){case 0:return d=new h,e.symbol?[4,p.expandSymbol(e.symbol,f)]:[3,2];case 1:b=g.sent(),c=a.createTemplateGroup(b,null),d.setDefault(c),g.label=2;case 2:return[2,d]}})})};h.prototype.size=function(){return 1};h.prototype.getDefault=function(){return this._defaultResult};h.prototype.setDefault=function(e){this._defaultResult=e};h.prototype.match=function(e,
a,f,d,b){return this.getDefault()};h.prototype.analyze=function(e,a,f,d,b){return g.__awaiter(this,void 0,void 0,function(){return g.__generator(this,function(a){return[2,null]})})};return h}();k.FeatureMatcher=l;var w=function(h){function e(a,f,d,b){var c=h.call(this)||this;c.type="interval";c._intervals=[];c._isMaxInclusive=f;c._fieldIndex=b;c._field=a;c._normalizationInfo=d;return c}g.__extends(e,h);e.fromCBRenderer=function(a,f,d){return g.__awaiter(this,void 0,void 0,function(){var b,c,h,n,x,
y,k,m,r,l,H=this;return g.__generator(this,function(t){switch(t.label){case 0:return b=a.isMaxInclusive,c=a.normalizationField,h=a.normalizationTotal,n=a.normalizationType,x=a.field,y={normalizationField:c,normalizationTotal:h,normalizationType:n},k=new e(x,b,y,a.fieldIndex),[4,p.expandSymbol(a.backgroundFillSymbol,d)];case 1:return m=t.sent(),[4,q.all(a.intervals.map(function(a){return g.__awaiter(H,void 0,void 0,function(){var c,b,e;return g.__generator(this,function(g){switch(g.label){case 0:return[4,
p.expandSymbol(a.symbol,d)];case 1:return c=g.sent(),[4,f.createTemplateGroup(c,m)];case 2:return b=g.sent(),e={min:a.min,max:a.max},k.add(e,b),[2]}})})}))];case 2:return t.sent(),[4,p.expandSymbol(a.defaultSymbol,d)];case 3:return(r=t.sent())?[4,f.createTemplateGroup(r,m)]:[3,5];case 4:l=t.sent(),k.setDefault(l),t.label=5;case 5:return[2,k]}})})};e.prototype.add=function(a,f){this._intervals.push({interval:a,result:f});this._intervals.sort(function(a,b){return a.interval.min-b.interval.min})};e.prototype.size=
function(){return h.prototype.size.call(this)+this._intervals.length};e.prototype.match=function(a,f,d,b,c){if(null==this._fieldIndex&&!this._field)return this.getDefault();a=null!=this._fieldIndex?f.getComputedNumericAtIndex(this._fieldIndex):this._getValueFromField(f);if(!a&&(null===a||void 0===a||isNaN(a)))return this.getDefault();for(f=0;f<this._intervals.length;f++)if(b=this._intervals[f],d=b.interval,b=b.result,c=this._isMaxInclusive?a<=d.max:a<d.max,a>=d.min&&c)return b;return this.getDefault()};
e.prototype._needsNormalization=function(){var a=this._normalizationInfo;return a&&(a.normalizationField||a.normalizationTotal||a.normalizationType)};e.prototype._getValueFromField=function(a){var f=a.readAttribute(this._field);if(!this._needsNormalization())return f;var d=this._normalizationInfo,b=d.normalizationField,c=d.normalizationTotal,d=d.normalizationType;a=!!b&&a.readAttribute(b);if(d)switch(d){case "esriNormalizeByField":return(a||void 0)&&f/a;case "esriNormalizeByLog":return Math.log(f)*
Math.LOG10E;case "esriNormalizeByPercentOfTotal":return f/c*100;default:v.error("Found unknown normalization type: "+d)}else v.error("Normalization is required, but no type was set!")};return e}(l);k.IntervalMatcher=w;w=function(h){function e(a,f,d){var b=h.call(this)||this;b.type="map";b._nullResult=null;b._resultsMap=new Map;b._fieldsIndex=d;b._fields=a;b._seperator=f||"";return b}g.__extends(e,h);e.fromUVRenderer=function(a,f,d){return g.__awaiter(this,void 0,void 0,function(){var b,c,h,n,k,l,
u=this;return g.__generator(this,function(m){switch(m.label){case 0:return b=a.fieldDelimiter,c=[a.field],a.field2&&c.push(a.field2),a.field3&&c.push(a.field3),[4,p.expandSymbol(a.backgroundFillSymbol,d)];case 1:return h=m.sent(),n=new e(c,b,a.fieldIndex),[4,q.all(a.map.map(function(a){return g.__awaiter(u,void 0,void 0,function(){var c,b;return g.__generator(this,function(e){switch(e.label){case 0:return[4,p.expandSymbol(a.symbol,d)];case 1:return c=e.sent(),[4,f.createTemplateGroup(c,h)];case 2:return b=
e.sent(),"\x3cNull\x3e"===a.value?n.setNullResult(b):n.add(a.value,b),[2]}})})}))];case 2:return m.sent(),[4,p.expandSymbol(a.defaultSymbol,d)];case 3:return(k=m.sent())?[4,f.createTemplateGroup(k,h)]:[3,5];case 4:l=m.sent(),n.setDefault(l),m.label=5;case 5:return[2,n]}})})};e.prototype.setNullResult=function(a){this._nullResult=a};e.prototype.add=function(a,f){this._resultsMap.set(a.toString(),f)};e.prototype.size=function(){return h.prototype.size.call(this)+this._resultsMap.size};e.prototype.match=
function(a,f,d,b,c){if(null==this._fieldsIndex&&!this._fields)return this.getDefault();a=null!=this._fieldsIndex?f.getComputedStringAtIndex(this._fieldsIndex):this._getValueFromFields(f);if(null!==this._nullResult&&(null==a||""===a||"\x3cNull\x3e"===a))return this._nullResult;if(!a&&null==a)return this.getDefault();a=a.toString();return this._resultsMap.has(a)?this._resultsMap.get(a):this.getDefault()};e.prototype._getValueFromFields=function(a){for(var f=[],d=0,b=this._fields;d<b.length;d++){var c=
a.readAttribute(b[d]);f.push(c)}return f.join(this._seperator)};return e}(l);k.MapMatcher=w;l=function(h){function e(a,f,d,b){var c=h.call(this)||this;c.type="dictionary";c._groupIdCache=new B(100);c._renderer=a;c._fieldMap=a.fieldMap;c._symbolFields=a.getSymbolFields();c._templates=f;c._info=d;c._scaleFn=b;return c}g.__extends(e,h);e.fromDictionaryRenderer=function(a,f,d){return g.__awaiter(this,void 0,void 0,function(){var b,c,h;return g.__generator(this,function(g){switch(g.label){case 0:return[4,
new Promise(function(a,c){z(["../../../../../renderers/DictionaryRenderer"],a,c)})];case 1:return b=g.sent(),c=b.fromJSON(a.renderer),[4,c.fetchResources({spatialReference:d.spatialReference,fields:d.fields})];case 2:return g.sent(),[4,G(c.scaleExpression,d)];case 3:return h=g.sent(),[2,new e(c,f,d,h)]}})})};e.prototype._analyzeFeature=function(a,f,d,b){return g.__awaiter(this,void 0,void 0,function(){var c,e,h,k,l,u,m,r,q=this;return g.__generator(this,function(n){switch(n.label){case 0:c=a.readLegacyFeature();
e=this._scaleFn(c,f,d);h=this._attributeHash(c)+"-"+e;if(k=this._groupIdCache.get(h))return[2,k];l=g.__assign(g.__assign({},d),{spatialReference:this._info.spatialReference,abortOptions:b,fields:this._info.fields});return[4,this._renderer.getSymbolAsync(c,l)];case 1:return u=n.sent(),m=F.createSymbolSchema(u,this._renderer),r=p.expandSymbol(m,this._info,b).then(function(a){if("expanded-cim"!==a.type)return v.error(new A("mapview-bad-type","Found unexpected type "+a.type+" in dictionary response")),
null;a.hash+="-"+e;for(var c=0,d=a.layers;c<d.length;c++){var b=d[c];b.scaleFactor=e;b.templateHash+="-"+e;"text"===b.type&&"string"===typeof b.text&&-1<b.text.indexOf("[")&&(b.text=D.createLabelOverrideFunction(q._fieldMap,b.text,b.cim.textCase))}return q._templates.createTemplateGroup(a,null)}),this._groupIdCache.put(h,r,1),[2,r]}})})};e.prototype.analyze=function(a,e,d,b,c){return g.__awaiter(this,void 0,void 0,function(){var a,f;return g.__generator(this,function(g){a=e.getCursor();for(f=[];a.next();)f.push(this._analyzeFeature(a,
d,b,c));return[2,q.all(f)]})})};e.prototype.match=function(a,e,d,b,c){return null};e.prototype._attributeHash=function(a){for(var e="",d=0,b=this._symbolFields;d<b.length;d++){var c=this._fieldMap[b[d]];c&&(e+=a.attributes[c]+"-")}return e};return e}(l);k.DictionaryMatcher=l});