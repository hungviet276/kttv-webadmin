// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.17/esri/copyright.txt for details.
//>>built
define(["require","exports","../../../../core/promiseUtils","../../../../layers/support/TilemapCache","../../tiling/TileKey"],function(l,m,f,h,g){return function(){function c(a){if(a instanceof h.TilemapCache)this._tilemapCache=a;else if(a&&"index"in a)this._tilemap=a.index;else throw Error("Invalid tilemap!");}c.prototype.dataKey=function(a,b){if(this._tilemapCache){var d=a.level,e=a.row,k=a.col,c=new g(a);return this._tilemapCache.fetchAvailabilityUpsample(d,e,k,c,b).then(function(){return c}).catch(function(a){if(f.isAbortError(a))throw a;
return null})}return this._getIndexedDataKey(a)};c.prototype.forEach=function(a,b,d,e,c){this._callback=c;this._maxLevel=b+a;this._forEach(this._tilemap,b,d,e)};c.prototype._forEach=function(a,b,d,e){0!==a&&(this._callback(b,d,e),b!==this._maxLevel&&"object"===typeof a&&(this._forEach(a[0],b+1,2*d,2*e),this._forEach(a[1],b+1,2*d,2*e+1),this._forEach(a[2],b+1,2*d+1,2*e),this._forEach(a[3],b+1,2*d+1,2*e+1)))};c.prototype._getIndexedDataKey=function(a){var b=[a];if(0>a.level||0>a.row||0>a.col||0<a.row>>
a.level||0<a.col>>a.level)return f.resolve(null);for(;0!==a.level;)a=new g(a.level-1,a.row>>1,a.col>>1,a.world),b.push(a);a=this._tilemap;var d=b.pop(),e,c;if(1===a)return f.resolve(d);for(;b.length;)if(e=b.pop(),c=(e.col&1)+((e.row&1)<<1),a){if(0===a[c]){d=null;break}if(1===a[c]){d=e;break}d=e;a=a[c]}return f.resolve(d)};return c}()});