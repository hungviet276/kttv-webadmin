// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.17/esri/copyright.txt for details.
//>>built
define("require exports tslib ../core/Error ../core/HandleOwner ../core/Logger ../core/maybe ../core/promiseUtils ../core/scheduling ../core/watchUtils ../core/accessorSupport/decorators ./support/WatchUpdatingTracking".split(" "),function(w,x,k,q,z,A,B,l,C,D,p,E){Object.defineProperty(x,"__esModule",{value:!0});var F=A.getLogger("esri.views.LayerViewManager"),r=new Map;r.set("view.map.basemap.baseLayers","view.basemapView.baseLayerViews");r.set("view.map.ground.layers","view.groundView.layerViews");
r.set("view.map.layers","view.layerViews");r.set("view.map.basemap.referenceLayers","view.basemapView.referenceLayerViews");var G=function(){function g(c,b,a){var m=this;this.layer=c;this.view=b;this.layerViewImporter=a;this._controller=l.createAbortController();this._deferred=l.createDeferred();this.done=this._started=!1;l.onAbort(this._controller.signal,function(){var a=new q("cancelled:layerview-create","layerview creation cancelled",{layer:c});m._deferred.reject(a)})}Object.defineProperty(g.prototype,
"promise",{get:function(){return this._deferred.promise},enumerable:!1,configurable:!0});g.prototype.destroy=function(){this._controller.abort();var c=this.layerView;if(c){var b=this.layer,a=this.view;b.emit("layerview-destroy",{view:a,layerView:c});a.emit("layerview-destroy",{layer:b,layerView:c});this.done=!0;this.layerViewImporter=this.view=this.layerView=this.layer=null}};g.prototype.start=function(){var c,b;return k.__awaiter(this,void 0,void 0,function(){var a,m,e,f,d,n,t,u,g,y,v,p=this;return k.__generator(this,
function(h){switch(h.label){case 0:if(this._started)return[2];this._started=!0;a=this;m=a._controller.signal;e=a.layer;f=a.view;this._map=f.map;h.label=1;case 1:return h.trys.push([1,13,,14]),[4,e.load({signal:m})];case 2:return h.sent(),"prefetchResources"in e?[4,e.prefetchResources({signal:m})]:[3,4];case 3:h.sent(),h.label=4;case 4:return e.createLayerView?[4,e.createLayerView(f,{signal:m})]:[3,6];case 5:return d=h.sent(),[3,8];case 6:if(!this.layerViewImporter.hasLayerViewModule(e))throw new q("layer:view-not-supported",
"No layerview implementation was found");return[4,this.layerViewImporter.importLayerView(e)];case 7:n=h.sent(),l.throwIfAborted(m),d="default"in n?new n.default({layer:e,view:f}):new n({layer:e,view:f}),h.label=8;case 8:u=function(){B.isSome(t)&&(t.remove(),t=null);d.destroy();d.layer=null;d.parent=null;d.view=null;p.done=!0},t=l.onAbort(m,u),l.throwIfAborted(m),h.label=9;case 9:return h.trys.push([9,11,,12]),[4,d.when()];case 10:return h.sent(),[3,12];case 11:throw g=h.sent(),u(),g;case 12:y=null===
(b=null===(c=this._map)||void 0===c?void 0:c.allLayers)||void 0===b?void 0:b.includes(e);if(!y)return this._deferred.reject(new q("view:no-layerview-for-layer","The layer has been removed from the map",{layer:e})),u(),[2];this.layerView=d;e.emit("layerview-create",{view:f,layerView:d});f.emit("layerview-create",{layer:e,layerView:d});this.done=!0;this._deferred.resolve(d);return[3,14];case 13:return v=h.sent(),e.emit("layerview-create-error",{view:f,error:v}),f.emit("layerview-create-error",{layer:e,
error:v}),this.done=!0,this._deferred.reject(new q("layerview:create-error","layerview creation failed",{layer:e,error:v})),[3,14];case 14:return[2]}})})};return g}();w=function(g){function c(b){var a=g.call(this,b)||this;a._layerLayerViewInfoMap=new Map;a._watchUpdatingTracking=new E.WatchUpdatingTracking;a.view=null;a._preloadLayerViewModules=function(){var b=a.view,e=a.get("view.map.allLayers");b&&e&&e.forEach(function(b){a.layerViewImporter.hasLayerViewModule(b)&&a.layerViewImporter.importLayerView(b)})};
a._reschedule=function(){a.handles.remove("reschedule");a.handles.add(C.schedule(a._doWork),"reschedule");a.notifyChange("updating")};a._doWork=function(){var b,e,c,d=a.get("view.map");a._map!==d&&(a.clear(),a._map=d);if(a.handles.has("reschedule")){a.handles.remove("reschedule");a.handles.remove("collection-change");var n=d&&d.allLayers;if(n){n.forEach(a._createLayerView,a);a._refreshCollections();var g=[];a._layerLayerViewInfoMap.forEach(function(a,b){n.includes(b)||g.push(a)});for(var k=0;k<g.length;k++){var l=
g[k];a._layerLayerViewInfoMap.delete(l.layer);l.destroy()}d=[null===(b=d.ground)||void 0===b?void 0:b.layers,null===(e=d.basemap)||void 0===e?void 0:e.baseLayers,null===(c=d.basemap)||void 0===c?void 0:c.referenceLayers,d.layers].filter(function(a){return!!a});a.handles.add(d.map(function(b){return a._watchUpdatingTracking.addOnCollectionChange(b,a._reschedule)}),"collection-change");a.notifyChange("updating")}}};a.handles.add([D.on(a,"view.map.allLayers","change",a._preloadLayerViewModules,a._preloadLayerViewModules),
a.watch(["view.map.basemap","view.map.ground","view.map.layers","view.ready"],a._reschedule,!0)]);return a}k.__extends(c,g);c.prototype.initialize=function(){this._preloadLayerViewModules()};c.prototype.destroy=function(){this.clear();this._watchUpdatingTracking.destroy();this._map=this.view=null};Object.defineProperty(c.prototype,"updating",{get:function(){if(this.handles.has("reschedule")||this._watchUpdatingTracking.updating)return!0;var b=!0;this._layerLayerViewInfoMap.forEach(function(a){return b=
b&&a.done});return!b},enumerable:!1,configurable:!0});c.prototype.clear=function(){this.destroyed||(this._layerLayerViewInfoMap.forEach(function(b){return b.destroy()}),this._layerLayerViewInfoMap.clear(),this._refreshCollections())};c.prototype.whenLayerView=function(b){this._reschedule();this._doWork();return this._layerLayerViewInfoMap.has(b)?this._layerLayerViewInfoMap.get(b).promise:l.reject(new q("view:no-layerview-for-layer","No layerview has been found for the layer",{layer:b}))};c.prototype._refreshCollections=
function(){var b=this;r.forEach(function(a,c){b._populateLayerViewsOwners(b.get(c),b.get(a),b.view)})};c.prototype._populateLayerViewsOwners=function(b,a,c){var e=this;if(b&&a){var f=0;b.forEach(function(b){var d=e._layerLayerViewInfoMap.get(b);d&&d.layerView&&(d=d.layerView,d.layer=b,d.parent=c,a.getItemAt(f)!==d&&a.splice(f,0,d),b.layers&&e._populateLayerViewsOwners(b.layers,d.layerViews,d),f+=1)});f<a.length&&a.splice(f,a.length)}else a&&a.removeAll()};c.prototype._createLayerView=function(b){var a=
this;if(this._layerLayerViewInfoMap.has(b))this.view.ready&&this._layerLayerViewInfoMap.get(b).start();else{b.load().catch(function(){});this.layerViewImporter.hasLayerViewModule(b)&&this.layerViewImporter.importLayerView(b);var c=new G(b,this.view,this.layerViewImporter);c.promise.then(function(){a._refreshCollections();a.notifyChange("updating")},function(c){var e,d;c&&(l.isAbortError(c)||"cancelled:layerview-create"===c.name)||F.error("Failed to create layerview for layer title:'"+(null!==(e=b.title)&&
void 0!==e?e:"no title")+"', id:'"+(null!==(d=b.id)&&void 0!==d?d:"no id")+"' of type '"+b.type+"'.",{layer:b,error:c});a._refreshCollections();a.notifyChange("updating")});this._layerLayerViewInfoMap.set(b,c);this.view.ready&&c.start()}this.notifyChange("updating")};k.__decorate([p.property({readOnly:!0})],c.prototype,"_watchUpdatingTracking",void 0);k.__decorate([p.property()],c.prototype,"layerViewImporter",void 0);k.__decorate([p.property({readOnly:!0,dependsOn:["_watchUpdatingTracking.updating"]})],
c.prototype,"updating",null);k.__decorate([p.property()],c.prototype,"view",void 0);return c=k.__decorate([p.subclass("esri.views.LayerViewManager")],c)}(z.HandleOwner);x.default=w});