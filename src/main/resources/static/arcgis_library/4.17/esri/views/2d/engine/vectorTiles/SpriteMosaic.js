// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.17/esri/copyright.txt for details.
//>>built
define(["require","exports","../../../webgl","./RectangleBinPack","../webgl/Rect"],function(t,u,q,p,r){return function(){function d(b,c,a){void 0===a&&(a=0);this._size=[];this._mosaicsData=[];this._textures=[];this._dirties=[];this._pageHeight=this._pageWidth=this._currentPage=this._maxItemSize=0;this._mosaicRects={};this.pixelRatio=1;(0>=b||0>=c)&&console.error("Sprites mosaic defaultWidth and defaultHeight must be greater than zero!");this._pageWidth=b;this._pageHeight=c;0<a&&(this._maxItemSize=
a);this._binPack=new p(b-4,c-4)}d.prototype.getWidth=function(b){return b>=this._size.length?-1:this._size[b][0]};d.prototype.getHeight=function(b){return b>=this._size.length?-1:this._size[b][1]};d.prototype.setSpriteSource=function(b){this.dispose();this.pixelRatio=b.devicePixelRatio;if(0===this._mosaicsData.length){this._binPack=new p(this._pageWidth-4,this._pageHeight-4);var c=new Uint32Array(Math.floor(this._pageWidth)*Math.floor(this._pageHeight));this._mosaicsData[0]=c;this._dirties.push(!0);
this._size.push([this._pageWidth,this._pageHeight]);this._textures.push(void 0)}this._sprites=b};d.prototype.getSpriteItem=function(b,c){void 0===c&&(c=!1);var a=this._mosaicRects[b];if(a)return a;if(!this._sprites||"loaded"!==this._sprites.loadStatus)return null;a=this._sprites.getSpriteInfo(b);if(!a||!a.width||!a.height||0>a.width||0>a.height)return null;var f=a.width,d=a.height,h=this._allocateImage(f,d),g=h[0],e=h[1];if(0>=g.width)return null;this._copy(g,a,e,h[2],c);a={rect:g,width:f,height:d,
sdf:a.sdf,simplePattern:!1,pixelRatio:a.pixelRatio,page:e};return this._mosaicRects[b]=a};d.prototype.preloadSpriteItems=function(){for(var b=0,c=this._sprites.spriteNames;b<c.length;b++)this.getSpriteItem(c[b],!0)};d.prototype.getSpriteItems=function(b){for(var c={},a=0;a<b.length;a++){var f=b[a];c[f]=this.getSpriteItem(f)}return c};d.prototype.getMosaicItemPosition=function(b,c){c=(b=this.getSpriteItem(b,c))&&b.rect;if(!c)return null;c.width=b.width;c.height=b.height;var a=this._size[b.page];return{size:[b.width,
b.height],tl:[(c.x+2)/a[0],(c.y+2)/a[1]],br:[(c.x+2+b.width)/a[0],(c.y+2+b.height)/a[1]],page:b.page}};d.prototype.bind=function(b,c,a,f){void 0===a&&(a=0);void 0===f&&(f=0);this._textures[a]||(this._textures[a]=new q.Texture(b,{pixelFormat:6408,dataType:5121,wrapMode:33071,width:this._size[a][0],height:this._size[a][1]},new Uint8Array(this._mosaicsData[a].buffer)));var d=this._textures[a];d.setSamplingMode(c);this._dirties[a]&&d.setData(new Uint8Array(this._mosaicsData[a].buffer));b.bindTexture(d,
f);this._dirties[a]=!1};d._copyBits=function(b,c,a,d,l,h,g,e,m,n,k){var f=d*c+a;g=e*h+g;if(k)for(g-=h,k=-1;k<=n;k++,f=((k+n)%n+d)*c+a,g+=h)for(e=-1;e<=m;e++)l[g+e]=b[f+(e+m)%m];else for(k=0;k<n;k++){for(e=0;e<m;e++)l[g+e]=b[f+e];f+=c;g+=h}};d.prototype._copy=function(b,c,a,f,l,h){if(this._sprites&&"loaded"===this._sprites.loadStatus&&!(a>=this._mosaicsData.length)){var g=new Uint32Array(h?h.buffer:this._sprites.image.buffer),e=this._mosaicsData[a];e&&g||console.error("Source or target images are uninitialized!");
d._copyBits(g,h?c.width:this._sprites.width,c.x,c.y,e,f[0],b.x+2,b.y+2,c.width,c.height,l);this._dirties[a]=!0}};d.prototype._allocateImage=function(b,c){b+=2;c+=2;var a=Math.max(b,c);if(this._maxItemSize&&this._maxItemSize<a)return a=new r.default(0,0,b,c),this._mosaicsData.push(new Uint32Array(b*c)),this._dirties.push(!0),this._size.push([b,c]),this._textures.push(void 0),[a,this._mosaicsData.length-1,[b,c]];var a=b%4?4-b%4:4,d=c%4?4-c%4:4;1===a&&(a=5);1===d&&(d=5);a=this._binPack.allocate(b+a,
c+d);return 0>=a.width?(this._dirties[this._currentPage]||(this._mosaicsData[this._currentPage]=null),this._currentPage=this._mosaicsData.length,this._mosaicsData.push(new Uint32Array(this._pageWidth*this._pageHeight)),this._dirties.push(!0),this._size.push([this._pageWidth,this._pageHeight]),this._textures.push(void 0),this._binPack=new p(this._pageWidth-4,this._pageHeight-4),this._allocateImage(b,c)):[a,this._currentPage,[this._pageWidth,this._pageHeight]]};d.prototype.dispose=function(){this._binPack=
null;this._mosaicRects={};for(var b=0,c=this._textures;b<c.length;b++){var a=c[b];a&&a.dispose()}this._textures.length=0};return d}()});