// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.17/esri/copyright.txt for details.
//>>built
define("require exports tslib ../../../geometry ../../../Graphic ../../../core/arrayUtils ../../../core/Logger ../../../core/maybe ../../../core/promiseUtils ../../../core/SetUtils ../../../core/unitUtils ../../../core/accessorSupport/decorators ../../../core/sql/WhereClause ../../../geometry/projection ../../../geometry/support/webMercatorUtils ../../../layers/support/fieldUtils ../../../tasks/support/Query ./I3SMeshView3D ./LayerView3D ./i3s/I3SGeometryUtil ./i3s/I3SQueryEngine ./i3s/I3SQueryFeatureAdapter ./i3s/I3SQueryFeatureStore ./i3s/I3SUtil ./support/DefinitionExpressionSceneLayerView ./support/fieldProperties ./support/layerViewUpdatingProperties ./support/PopupSceneLayerView ../support/projectionUtils ../../layers/SceneLayerView ../../layers/support/FeatureFilter ../../support/Scheduler".split(" "),
function(V,W,e,t,B,C,D,h,E,F,G,f,H,r,u,v,w,I,J,g,K,L,M,y,N,O,P,Q,R,S,T,U){var q=D.getLogger("esri.views.3d.layers.SceneLayerView3D"),z=O.defineFieldProperties(),A=[0,0,0,0];return function(n){function b(){var a=null!==n&&n.apply(this,arguments)||this;a._queryEngine=null;a.requiredFields=[];a.lodFactor=1;a.progressiveLoadFactor=1;a._elevationContext="scene";a._isIntegratedMesh=!1;a._supportsLabeling=!0;a._projectionEngineLoaded=!1;return a}e.__extends(b,n);Object.defineProperty(b.prototype,"filter",
{set:function(a){if(h.isNone(a))this._set("filter",null);else{var c=["contains","intersects","disjoint"];a.timeExtent?(q.warn("Filters with a timeExtent are not supported for mesh scene layers"),a=null):a.spatialRelationship&&-1===c.indexOf(a.spatialRelationship)&&(q.warn("Filters with spatialRelationship other than "+c.join(", ")+" are not supported for mesh scene layers"),a=null);this._set("filter",a)}},enumerable:!1,configurable:!0});Object.defineProperty(b.prototype,"parsedFilterWhereClause",
{get:function(){var a=h.isSome(this.filter)?this.filter.where:null;if(!a)return null;try{return H.WhereClause.create(a,this.layer.fieldsIndex)}catch(c){q.error("Failed to parse filter where clause: "+c)}return null},enumerable:!1,configurable:!0});Object.defineProperty(b.prototype,"filterSpatialRelationship",{get:function(){return h.isSome(this.filter)?this.filter.spatialRelationship:"intersects"},enumerable:!1,configurable:!0});Object.defineProperty(b.prototype,"parsedFilterGeometry",{get:function(){var a=
this;if(h.isNone(this.filter)||!this._geometryEngine)return null;var c=this.filter.geometry;if(!c)return null;var d=this.filter,b=d.distance,m=d.units,d=this.filterSpatialRelationship,c="mesh"===c.type?c.extent:c;if(!b)return g.processFilterGeometry(c,d);m=m||G.getUnitString(c.spatialReference);if(c.spatialReference.isWGS84)return b=this._geometryEngine.geodesicBuffer(c,b,m),g.processFilterGeometry(b,d);if(u.canProject(c,t.SpatialReference.WGS84))return b=u.project(this._geometryEngine.geodesicBuffer(u.project(c,
t.SpatialReference.WGS84),b,m),c.spatialReference),g.processFilterGeometry(b,d);if(!r.isSupported())return q.error("Filter by geodesic buffer (distance) unsupported due to lack of projection support."),null;if(!this._projectionEngineLoaded&&(this._loadAsyncModule(r.load()).then(function(){a._set("_projectionEngineLoaded",!0)}),!this._projectionEngineLoaded))return null;var k=null;try{k=r.project(c,t.SpatialReference.WGS84)}catch(l){}if(k)try{k=r.project(this._geometryEngine.geodesicBuffer(k,b,m),
c.spatialReference)}catch(l){k=null}k||q.error("Filter by geodesic buffer (distance) unsupported, failed to project input geometry ("+c.spatialReference.wkid+") to WGS84.");return g.processFilterGeometry(k,d)},enumerable:!1,configurable:!0});Object.defineProperty(b.prototype,"lodCrossfadeDuration",{get:function(){var a,c;return null!==(c=null===(a=this.view)||void 0===a?void 0:a.qualitySettings.sceneService["3dObject"].lodCrossfadeDuration)&&void 0!==c?c:0},enumerable:!1,configurable:!0});b.prototype.initialize=
function(){for(var a=this,c=0,b=["layer.renderer","layer.labelingInfo","layer.labelsVisible","definitionExpressionFields","filter"];c<b.length;c++){var p=b[c];this.updatingHandles.add(this,p,function(){return a.updatingHandles.addPromise(a._updateRequiredFields())})}this._updateRequiredFields();this.updatingHandles.add(this.layer,"rangeInfos",function(c){return a._rangeInfosChanged(c)},2);this.updatingHandles.add(this.layer,"renderer",function(c){return a.updatingHandles.addPromise(a._rendererChange(c))},
2);c=0;for(b=["parsedDefinitionExpression","layer.objectIdFilter","filter","parsedFilterWhereClause","parsedFilterGeometry"];c<b.length;c++)p=b[c],this.updatingHandles.add(this,p,function(){return a._filterChange()})};b.prototype.destroy=function(){};b.prototype._updateRequiredFields=function(){return e.__awaiter(this,void 0,void 0,function(){var a,c,b,p,m,k,l,f,g,n,x;return e.__generator(this,function(d){switch(d.label){case 0:return a=this,b=c=a.layer,p=b.fields,m=b.renderer,k=a.definitionExpressionFields,
l=new Set,[4,E.eachAlways([m?m.collectRequiredFields(l,p):null,v.collectLabelingFields(l,c),h.isSome(this.filter)?v.collectFilterFields(l,c,this.filter):null])];case 1:f=d.sent();g=0;for(n=f;g<n.length;g++)x=n[g],x.error&&q.error(x.error);v.collectFields(l,p,k);this._set("requiredFields",F.valuesOfSet(l).sort());return[2]}})})};b.prototype._rangeInfosChanged=function(a){null!=a&&0<a.length&&q.warn("Unsupported property: rangeInfos are currently only serialized to and from web scenes but do not affect rendering.")};
b.prototype.createQuery=function(){var a={outFields:["*"],returnGeometry:!1,outSpatialReference:this.view.spatialReference};return h.isSome(this.filter)?this.filter.createQuery(a):new w(a)};b.prototype.queryExtent=function(a){return this._ensureQueryEngine().executeQueryForExtent(this._ensureQuery(a))};b.prototype.queryFeatureCount=function(a){return this._ensureQueryEngine().executeQueryForCount(this._ensureQuery(a))};b.prototype.queryFeatures=function(a){var c=this;return this._ensureQueryEngine().executeQuery(this._ensureQuery(a)).then(function(a){if(null===
a||void 0===a||!a.features)return a;for(var b=c.layer,d=0,k=a.features;d<k.length;d++){var l=k[d];l.layer=b;l.sourceLayer=b}return a})};b.prototype.queryObjectIds=function(a){return this._ensureQueryEngine().executeQueryForIds(this._ensureQuery(a))};b.prototype._ensureQueryEngine=function(){this._queryEngine||(this._queryEngine=this._createQueryEngine());return this._queryEngine};b.prototype._createQueryEngine=function(){var a=this,b=g.createGetFeatureExtent(this.view.spatialReference,this.view.renderSpatialReference,
this._collection);return new K.default({layerView:this,task:U.Task.FEATURE_QUERY_ENGINE,spatialIndex:new M.default({featureAdapter:new L.I3SQueryFeatureAdapter({objectIdField:this.layer.objectIdField,attributeStorageInfo:this.layer.attributeStorageInfo,getFeatureExtent:b}),forAllFeatures:function(b,c){return a._forAllFeatures(function(a,c,d){return b({id:a,index:c,meta:d})},c,2)},getFeatureExtent:b,sourceSpatialReference:y.getIndexCrs(this.layer),viewSpatialReference:this.view.spatialReference})})};
b.prototype.highlight=function(a){var b=this._highlights;if(a instanceof w){var d=b.acquireSet(),e=d.set,d=d.handle;this.queryObjectIds(a).then(function(a){return b.setFeatureIds(e,a)});return d}return n.prototype.highlight.call(this,a)};b.prototype._createLayerGraphic=function(a){a=new B(null,null,a);a.layer=this.layer;a.sourceLayer=this.layer;return a};b.prototype.canResume=function(){return n.prototype.canResume.call(this)&&(!this._controller||this._controller.rootNodeVisible)};b.prototype.getFilters=
function(){var a=this,b=n.prototype.getFilters.call(this);if(this.layer.objectIdFilter){var d=new Float64Array(this.layer.objectIdFilter.ids),e="include"===this.layer.objectIdFilter.method;d.sort();b.push(function(b){return a._objectIdFilter(d,e,b)})}this.addSqlFilter(b,this.parsedDefinitionExpression,this.definitionExpressionFields,this.logError);if(h.isSome(this.filter)){var m=this.parsedFilterGeometry;h.isSome(m)&&b.push(function(b,c){return a._geometryFilter(b,c,m,a.filterSpatialRelationship)});
if(this.filter.objectIds){var f=new Float64Array(this.filter.objectIds);f.sort();b.push(function(b){return a._objectIdFilter(f,!0,b)})}}h.isSome(this.parsedFilterWhereClause)&&this.addSqlFilter(b,this.parsedFilterWhereClause,this.parsedFilterWhereClause.fieldNames,this.logError);return b};b.prototype._geometryFilter=function(a,b,d,e){var c=d[0].spatialReference||this.view.spatialReference;if(R.mbsToMbs(b.node.mbs,this._controller.crsIndex,A,c))for(var f=g.acquireMaskFilterContext(e,this.view,c,this._collection,
b.objectHandle),l=g.computeMaskNodeMBS(A,f),c=function(c){if(0===a.length)return{value:void 0};switch(g.testMaskWithGeometry(c,l,e)){case 1:return a.length=0,{value:void 0};case 0:return"continue"}y.filterInPlace(a,b.featureIds,function(a){return g.filterWithMask(c,a,f)})},p=0;p<d.length;p++){var h=c(d[p]);if("object"===typeof h)return h.value}else q.warnOnce("SceneLayerView.filter.geometry is using unsupported SpatialReference, skipping geometry filter")};b.prototype._filterChange=function(){var a=
this;h.isSome(this.filter)&&this.filter.geometry&&!this._geometryEngine?this._loadAsyncModule(g.loadGeometryEngine()).then(function(b){a.destroyed||(a._set("_geometryEngine",b),a._applyFilters(!0))}):n.prototype._filterChange.call(this)};b.prototype._objectIdFilter=function(a,b,d){for(var c=0,e=0;c<d.length;)0<=C.binaryIndexOf(a,d[c])===b&&(d[e]=d[c],e++),c++;d.length=e};b.prototype._ensureQuery=function(a){return this._addDefinitionExpressionToQuery(h.isNone(a)?this.createQuery():w.from(a))};e.__decorate([f.property()],
b.prototype,"layer",void 0);e.__decorate([f.property({aliasOf:"layer"})],b.prototype,"i3slayer",void 0);e.__decorate([f.property({dependsOn:["_controller.rootNodeVisible"]})],b.prototype,"suspended",void 0);e.__decorate([f.property(P.updatingProgress)],b.prototype,"updatingProgress",void 0);e.__decorate([f.property({type:T})],b.prototype,"filter",null);e.__decorate([f.property({readOnly:!0,dependsOn:["filter.where"]})],b.prototype,"parsedFilterWhereClause",null);e.__decorate([f.property({readOnly:!0,
dependsOn:["filter.spatialRelationship"]})],b.prototype,"filterSpatialRelationship",null);e.__decorate([f.property({readOnly:!0,dependsOn:"filter.geometry filter.distance filter.units filterSpatialRelationship _geometryEngine _projectionEngineLoaded".split(" ")})],b.prototype,"parsedFilterGeometry",null);e.__decorate([f.property(z.requiredFields)],b.prototype,"requiredFields",void 0);e.__decorate([f.property(z.availableFields)],b.prototype,"availableFields",void 0);e.__decorate([f.property({readOnly:!0,
aliasOf:"view.qualitySettings.sceneService.3dObject.lodFactor"})],b.prototype,"lodFactor",void 0);e.__decorate([f.property({readOnly:!0,dependsOn:["view.qualitySettings.sceneService.3dObject.lodCrossfadeDuration"]})],b.prototype,"lodCrossfadeDuration",null);e.__decorate([f.property({readOnly:!0,aliasOf:"_controller.updatingProgress"})],b.prototype,"updatingProgressValue",void 0);e.__decorate([f.property({readOnly:!0})],b.prototype,"_geometryEngine",void 0);e.__decorate([f.property({readOnly:!0})],
b.prototype,"_projectionEngineLoaded",void 0);return b=e.__decorate([f.subclass("esri.views.3d.layers.SceneLayerView3D")],b)}(I.I3SMeshView3D(N.DefinitionExpressionSceneLayerView(Q.PopupSceneLayerView(J.LayerView3D(S)))))});