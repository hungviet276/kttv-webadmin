// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.17/esri/copyright.txt for details.
//>>built
define("require exports tslib ../../../../core/Error ../../../../core/lang ../../../../core/mathUtils ../../../../core/maybe ../../../../core/libs/gl-matrix-2/mat2 ../../../../core/libs/gl-matrix-2/vec2 ../../../../core/libs/gl-matrix-2/vec2f64 ../../../../core/libs/gl-matrix-2/vec3 ../../../../core/libs/gl-matrix-2/vec3f32 ../../../../core/libs/gl-matrix-2/vec3f64 ../../../../geometry/support/aaBoundingBox ../../../../layers/graphics/dehydratedFeatures ./elevationAlignmentUtils ./elevationAlignmentUtils ./ElevationContext ./Graphics3DObject3DGraphicLayer ./Graphics3DSymbolLayer ./graphicUtils ../support/FastSymbolUpdates ../../support/projectionUtils ../../webgl-engine/lib/Geometry ../../webgl-engine/lib/Object3D ../../webgl-engine/lib/pathGeometryUtils ../../webgl-engine/materials/DefaultMaterial ../../webgl-engine/materials/PathMaterial".split(" "),
function(B,h,C,W,X,z,A,Y,I,Z,d,J,K,G,F,L,M,aa,ba,H,N,O,P,ca,da,c,ea,fa){function Q(q,a,k){switch(a){case "world":for(var b=0,t=q.vertices;b<t.length;b++)a=t[b],d.vec3.add(f,a.pos,q.offset),k.worldUpAtPosition(f,m),a.setFrameFromUpVector(m),a.computeRotationAxisAndAngleFromUpVector();break;case "path":for(d.vec3.add(f,q.vertices[0].pos,q.offset),k.worldUpAtPosition(f,m),c.computeMinimumRotationTangentFrame(q,m),k=0,q=q.vertices;k<q.length;k++){a=q[k];b=z.sign(d.vec3.dot(a.frame.right,a.vRight));d.vec3.cross(a.rotationFrame.up,
a.vRight,a.vLeft);d.vec3.scale(a.rotationFrame.up,a.rotationFrame.up,b);d.vec3.normalize(a.rotationFrame.up,a.rotationFrame.up);var t=d.vec3.dot(a.rotationFrame.up,a.frame.up),w=d.vec3.dot(a.rotationFrame.up,a.frame.right);d.vec3.scale(f,a.frame.up,-w);d.vec3.scale(R,a.frame.right,t);d.vec3.add(f,f,R);d.vec3.normalize(a.rotationFrame.right,f);c.vertexSpaceToProfileSpace(a.rotationRight,a.frame,a.rotationFrame.right);d.vec3.negate(f,a.vLeft);a.rotationAngle=-b*(Math.PI-z.acosClamped(d.vec3.dot(f,a.vRight)));
0<Math.abs(a.rotationAngle)&&(b=z.reciprocalClamped(Math.cos(.5*a.rotationAngle)),Y.mat2.set(a.miterStretch,1+(b-1)*a.rotationRight[0]*a.rotationRight[0],(b-1)*a.rotationRight[0]*a.rotationRight[1],(b-1)*a.rotationRight[0]*a.rotationRight[1],1+(b-1)*a.rotationRight[1]*a.rotationRight[1]));a.maxStretchDistance=Math.abs(Math.min(a.vLeftLength,a.vRightLength)*z.reciprocalClamped(Math.cos(.5*(Math.PI-a.rotationAngle))))}}}function S(c,a,k){switch(c){case "symbol-value":return k;case "proportional":return a;
default:return c}}function ga(c,a,k,b){c=c.stageObject;var t=c.geometryRecords,w=t.length,h=0;x.spatialReference=k.spatialReference;ha.spatialReference=b.spatialReference;for(var e=0;e<w;e++){var T=t[e].geometry,n=T.metadata,E=n.pathGeometry,y=E.builder.path;U.spatialReference=n.geometrySR;for(var p=y,v=a,q=k,g=b,l=0,r=0,u=p.vertices;r<u.length;r++){var f=u[r];x.x=f.posES[0];x.y=f.posES[1];x.z=f.posES[2];var A=L.evaluateElevationAlignmentAtPoint(x,q,v,g,V),l=l+V.sampledElevation;d.vec3.add(m,f.pos,
p.offset);g.setAltitude(A,m);d.vec3.subtract(f.pos,m,p.offset)}p.updatePathVertexInformation();h+=l/p.vertices.length;"world"!==y.upVector&&Q(y,n.upVectorAlignment,b);E.onPathChanged();T.invalidateBoundingInfo();c.geometryVertexAttrsUpdated(e)}return h/w}Object.defineProperty(h,"__esModule",{value:!0});h.NUM_CIRCLE_PROFILE_SUBDIVISIONS=h.NUM_ROUND_CAP_EXTRUSION_SUBDIVISIONS=h.NUM_ROUND_JOIN_SUBDIVISIONS=h.Graphics3DPathSymbolLayer=void 0;B=function(f){function a(a,b,t,c){a=f.call(this,a,b,t,c)||this;
a._intrinsicSize=Z.vec2f64.fromValues(1,1);a.upVectorAlignment="path";a.stencilWidth=.1;a.ensureDrapedStatus(!1);return a}C.__extends(a,f);a.prototype.doLoad=function(){return C.__awaiter(this,void 0,void 0,function(){var a,b,t,w,d,e,f,n,E,y,p,v,m,g;return C.__generator(this,function(k){a=A.isSome(this.symbolLayer.width)?this.symbolLayer.width:A.isSome(this.symbolLayer.height)?this.symbolLayer.height:this.symbolLayer.size;b=A.isSome(this.symbolLayer.height)?this.symbolLayer.height:a;this._vvConvertOptions=
{modelSize:[1,1,1],symbolSize:[a,1,b],unitInMeters:this._context.renderCoordsHelper.unitInMeters,transformation:{anchor:[0,0,0],scale:[1,1,1],rotation:[0,0,0]},supportedTypes:{size:!0,color:!0,opacity:!0,rotation:!1}};this._fastUpdates=this._context.renderer&&this._context.renderer.visualVariables&&0<this._context.renderer.visualVariables.length?O.initFastSymbolUpdatesState(this._context.renderer,this._vvConvertOptions):{enabled:!1};t=this.symbolLayer.anchor||"center";this.upVectorAlignment="path";
"heading"===this.symbolLayer.profileRotation&&(this.upVectorAlignment="world");w=this.symbolLayer.profile||"circle";switch(w){default:this._profile=c.Profile.circle(h.NUM_CIRCLE_PROFILE_SUBDIVISIONS);break;case "quad":this._profile=c.Profile.rect()}d=[0,0];"center"!==t&&(d={left:[.5,0],right:[-.5,0],top:[0,-.5],bottom:[0,.5]}[t],this._profile.translate(d[0],d[1]));e=this.symbolLayer.join||"simple";switch(e){case "round":this._extruder=new c.MiterExtruder(0,h.NUM_ROUND_JOIN_SUBDIVISIONS);break;case "bevel":this._extruder=
new c.MiterExtruder(0,1);break;case "miter":this._extruder=new c.MiterExtruder(.8*Math.PI,1);break;default:this._extruder=new c.SimpleExtruder}f=this.symbolLayer.cap||"butt";switch(f){case "none":this._startCap=new c.NoCapBuilder;this._endCap=new c.NoCapBuilder;break;default:this._startCap=new c.TriangulationCapBuilder(this._profile,0);this._endCap=new c.TriangulationCapBuilder(this._profile,0,!0);break;case "square":this._startCap=new c.TriangulationCapBuilder(this._profile,-.5);this._endCap=new c.TriangulationCapBuilder(this._profile,
.5,!0);break;case "round":n="quad"===w?!0:!1,this._startCap=new c.RoundCapBuilder({profile:this._profile,flip:!1,breakNormals:n,subdivisions:h.NUM_ROUND_CAP_EXTRUSION_SUBDIVISIONS}),this._endCap=new c.RoundCapBuilder({profile:this._profile,flip:!0,breakNormals:n,subdivisions:h.NUM_ROUND_CAP_EXTRUSION_SUBDIVISIONS})}E=this._getIdHint();y=A.get(this.symbolLayer,"material","color");p=this._getCombinedOpacityAndColor(y);v=K.vec3f64.fromArray(p);m=p[3];g={diffuse:v,ambient:v,opacity:m,transparent:1>m||
this.needsDrivenTransparentPass,vertexColors:!1,slicePlaneEnabled:this._context.slicePlaneEnabled,castShadows:this.symbolLayer.castShadows,cullFace:"none"===f?0:void 0,offsetTransparentBackfaces:!0};if(!this._drivenProperties.size&&(I.vec2.set(this._intrinsicSize,a,b),!N.isValidSize(this._intrinsicSize[0])||!N.isValidSize(this._intrinsicSize[1])))throw new W("graphics3dpathsymbollayer:invalid-size","Symbol sizes may not be negative values");this._fastUpdates.enabled&&this._fastUpdates.visualVariables.size||
I.vec2.scale(this._intrinsicSize,this._intrinsicSize,1/this._context.renderCoordsHelper.unitInMeters);this._fastUpdates.enabled?(X.mixin(g,this._fastUpdates.materialParameters,{size:[this._intrinsicSize[0],this._intrinsicSize[1],0]}),this._material=new fa(g,E+"_pathmat")):(g.vertexColors=this._drivenProperties.color||this._drivenProperties.opacity,this._material=new ea(g,E+"_pathmat"));this._material.setParameterValues({usePBR:this._context.physicalBasedRenderingEnabled,isSchematic:!0});this._context.stage.add(3,
this._material);return[2]})})};a.prototype.destroy=function(){f.prototype.destroy.call(this);this._material&&(this._context.stage.remove(3,this._material.id),this._material=null)};a.prototype.createGraphics3DGraphic=function(k){var b=k.graphic;if(!this._validateGeometryType(b.geometry,a.validGeometryTypes,this.symbolLayer.type)||!this._validateGeometry(b.geometry))return null;var c="graphic"+b.uid,d=this.setGraphicElevationContext(b,new aa.ElevationContext);return this._createAs3DShape(b,k.renderingInfo,
d,c,b.uid)};a.prototype.layerOpacityChanged=function(){var a=A.get(this.symbolLayer,"material","color"),a=this._getCombinedOpacity(a);this._material.setParameterValues({opacity:a,transparent:1>a||this.needsDrivenTransparentPass});return!0};a.prototype.layerElevationInfoChanged=function(a,b){return this.updateGraphics3DGraphicElevationInfo(a,b,M.needsElevationUpdates3D)};a.prototype.slicePlaneEnabledChanged=function(){this._material.setParameterValues({slicePlaneEnabled:this._context.slicePlaneEnabled});
return!0};a.prototype.physicalBasedRenderingChanged=function(){this._material.setParameterValues({usePBR:this._context.physicalBasedRenderingEnabled,isSchematic:!0});return!0};a.prototype.pixelRatioChanged=function(){return!0};a.prototype.applyRendererDiff=function(a,b){for(var c in a.diff)switch(c){case "visualVariables":if(O.updateFastSymbolUpdatesState(this._fastUpdates,b,this._vvConvertOptions))this._material.setParameterValues(this._fastUpdates.materialParameters);else return!1;break;default:return!1}return!0};
a.prototype.getVertexData=function(a){for(var b=0,c=a.paths,d=[],k=a.spatialReference,e=this._context.elevationProvider.spatialReference,f=this._context.renderCoordsHelper.spatialReference,n=0;n<c.length;n++)var h=c[n],b=b+h.length;for(var n=new Float64Array(3*b),m=new Float64Array(3*b),p=new Float64Array(3*b),v=0,q=0;q<c.length;q++){h=c[q];d.push({index:v,numVertices:h.length});for(var g=0;g<h.length;g++){var l=h[g];n[v++]=l[0];n[v++]=l[1];n[v++]=a.hasZ?l[2]:0}}a=!0;k.equals(e)?this._copyVertices(n,
0,m,0,b):a=P.bufferToBuffer(n,k,0,m,e,0,b);e.equals(f)?this._copyVertices(m,0,p,0,b):P.bufferToBuffer(m,e,0,p,f,0,b);return{pathVertexDataInfos:d,vertexDataGS:n,vertexDataES:m,vertexDataRS:p,projectionSuccess:a,terrainElevation:0}};a.prototype._copyVertices=function(a,b,c,d,f){b*=3;d*=3;for(var e=0;e<f;++e)c[d++]=a[b++],c[d++]=a[b++],c[d++]=a[b++]};a.prototype._createAs3DShape=function(a,b,f,h,q){var e=a.geometry,k=[],n=[],t=[],y=e.spatialReference,p=this._context.elevationProvider.spatialReference,
v=G.create(),w=this._context.renderCoordsHelper;U.spatialReference=y;x.spatialReference=p;e=this.getVertexData(e);if(!e.projectionSuccess)return this.logger.warn("PathSymbol3DLayer geometry failed to be created (failed to project geometry to view spatial reference)"),null;if(0<e.pathVertexDataInfos.length){for(p=0;p<e.pathVertexDataInfos.length;++p){var g=e.pathVertexDataInfos[p],l=g.index,g=g.numVertices;if(2>g)this.logger.warn("PathSymbol3DLayer geometry failed to be created (paths should contain at least 2 vertices)");
else{if(A.isSome(this._context.clippingExtent)&&(G.empty(v),G.expandWithBuffer(v,e.vertexDataES,3*l,g),!G.intersectsClippingArea(v,this._context.clippingExtent)))continue;for(var r=[],u=l;u<l+3*g;){var z=u++,B=u++,C=u++,D=new c.PathVertex;d.vec3.set(D.posGS,e.vertexDataGS[z],e.vertexDataGS[B],e.vertexDataGS[C]);d.vec3.set(D.posES,e.vertexDataES[z],e.vertexDataES[B],e.vertexDataES[C]);x.x=D.posES[0];x.y=D.posES[1];x.z=D.posES[2];var F=L.evaluateElevationAlignmentAtPoint(x,this._context.elevationProvider,
f,w,null);d.vec3.set(m,e.vertexDataRS[z],e.vertexDataRS[B],e.vertexDataRS[C]);w.setAltitude(F,m);d.vec3.set(D.pos,m[0],m[1],m[2]);r.push(D)}l=new c.Path(r);Q(l,this.upVectorAlignment,this._context.renderCoordsHelper);l=new c.Builder(l,this._profile,this._extruder,this._startCap,this._endCap);g=null;this._fastUpdates.enabled?(u=this._fastUpdates.visualVariables,g=u.size?H.getAttributeValue(u.size.field,a):0,r=u.color?H.getAttributeValue(u.color.field,a):0,u=u.opacity?H.getAttributeValue(u.opacity.field,
a):0,g=new c.FastUpdatePathGeometry(l,g,r,u)):(g=[this._intrinsicSize[0],this._intrinsicSize[1]],this._drivenProperties.size&&(g[0]*=S(b.size[0],"symbol-value"===b.size[2]?this.symbolLayer.height||0:b.size[2],this.symbolLayer.width||0),g[1]*=S(b.size[2],"symbol-value"===b.size[0]?this.symbolLayer.width||0:b.size[0],this.symbolLayer.height||0)),r=null,this._drivenProperties.color&&(r=b.color),this._drivenProperties.opacity&&null!=b.opacity&&(r=r?[r[0],r[1],r[2],b.opacity]:[1,1,1,b.opacity]),l=new c.StaticPathGeometry(l),
l.bake(g),r&&l.bakeVertexColors(r),g=l);l=g.createGeometryData();l=new ca(l,h+"path"+p);l.metadata={pathGeometry:g,geometrySR:y,upVectorAlignment:this.upVectorAlignment,stencilWidth:this.stencilWidth};k.push(l);n.push(this._material);t.push(g.xform)}}a={layerUid:this._context.layer.uid,graphicUid:q};if(0<k.length)return h=new da({geometries:k,materials:n,transformations:t,castShadow:!0,metadata:a,idHint:h}),k=new ba(this,h,k,null,null,ga,f),k.alignedSampledElevation=e.terrainElevation,k.needsElevationUpdates=
M.needsElevationUpdates3D(f.mode),k}else this.logger.warn("PathSymbol3DLayer geometry failed to be created (no paths were defined)");return null};a.validGeometryTypes=["polyline"];return a}(H.Graphics3DSymbolLayer);h.Graphics3DPathSymbolLayer=B;var ha=F.makeDehydratedPoint(0,0,0,null),x=F.makeDehydratedPoint(0,0,0,null),U=F.makeDehydratedPoint(0,0,0,null),m=K.vec3f64.create(),f=J.vec3f32.create(),R=J.vec3f32.create();h.NUM_ROUND_JOIN_SUBDIVISIONS=3;h.NUM_ROUND_CAP_EXTRUSION_SUBDIVISIONS=3;h.NUM_CIRCLE_PROFILE_SUBDIVISIONS=
10;var V={verticalDistanceToGround:0,sampledElevation:0};h.default=B});