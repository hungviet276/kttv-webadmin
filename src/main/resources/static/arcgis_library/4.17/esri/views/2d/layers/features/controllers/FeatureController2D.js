// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.17/esri/copyright.txt for details.
//>>built
define("require exports tslib ../../../../../core/HandleOwner ../../../../../core/has ../../../../../core/maybe ../../../../../core/promiseUtils ../../../../../core/promiseUtils ../../../../../core/watchUtils ../../../../../core/accessorSupport/decorators ../../../../../layers/graphics/featureConversionUtils ../../../../../layers/graphics/data/QueryEngine ../../../../../layers/support/FieldsIndex ../FeatureStore2D ../Source2D ../support/AttributeStore ../support/ClusterStore ../support/ComputedAttributeStorage ../support/FeatureSetReaderJSON ../support/UpdateToken ../../../../support/QueueProcessor".split(" "),
function(u,v,d,y,z,q,h,r,k,e,A,B,C,D,E,F,G,H,I,w,J){function f(d){if(!h.isAbortError(d)&&"worker:port-closed"!==d.name)throw d;}Object.defineProperty(v,"__esModule",{value:!0});u=function(t){function b(){var a=null!==t&&t.apply(this,arguments)||this;a._storage=new H.ComputedAttributeStorage;a._markedIdsBufId=a._storage.createBitset();a._lastCleanup=performance.now();a._cleanupNeeded=!1;a._invalidated=!1;a._tileToResolver=new Map;a.tileStore=null;a.config=null;a.processor=null;a.remoteClient=null;
a.service=null;a._editing=!1;return a}d.__extends(b,t);b.prototype.initialize=function(){var a=this;this._initAttributeStore();this._initStores();this._initQueryEngine();this._initSource();this._updateQueue=new J.QueueProcessor({concurrency:4,process:function(c,K){return a._onDisplayTilePatch(c,{signal:K})}});this.handles.add([this.tileStore.on("update",this.onTileUpdate.bind(this)),this.watch("updating",function(c){return!c&&a.onIdle()})])};b.prototype.startup=function(){return d.__awaiter(this,
void 0,void 0,function(){return d.__generator(this,function(a){this._initAttributeStore();return[2]})})};b.prototype._initSource=function(){var a=this;this._source=new E.Source2D(this.service,this.spatialReference,this.tileStore.tileScheme);this._source.onDisplayTilePatch=function(c,b){a._invalidated=!0;return a._patchTile(c,b)};this._source.canAcceptPatch=function(){return 50>a._updateQueue.length};var c=this._source.sourceEvents;"geoevent"===c.type&&(c=c.events,this.handles.add([c.on("connectionStatus",
function(c){return a.remoteClient.invoke("setProperty",{propertyName:"connectionStatus",value:c}).catch(f)}),c.on("errorString",function(c){return a.remoteClient.invoke("setProperty",{propertyName:"errorString",value:c}).catch(f)}),c.on("feature",function(c){return a.remoteClient.invoke("emitEvent",{name:"data-received",event:{attributes:c.attributes,centroid:c.centroid,geometry:c.geometry}}).catch(f)}),c.on("updateRate",function(c){return a.remoteClient.invoke("emitEvent",{name:"update-rate",event:d.__assign({},
c)}).catch(f)})]))};b.prototype._initAttributeStore=function(){var a=this;this.attributeStore?this.attributeStore.invalidateResources():this.attributeStore=new F.default({type:"remote",initialize:function(c,b){return r.ignoreAbortErrors(a.remoteClient.invoke("tileRenderer.featuresView.attributeView.initialize",c,{signal:b}).catch(f))},update:function(c,b){return r.ignoreAbortErrors(a.remoteClient.invoke("tileRenderer.featuresView.attributeView.requestUpdate",c,{signal:b}).catch(f))},render:function(c){return r.ignoreAbortErrors(a.remoteClient.invoke("tileRenderer.featuresView.requestRender",
void 0,{signal:c}).catch(f))}})};b.prototype._initStores=function(){var a=this,c={geometryInfo:{geometryType:this.service.geometryType,hasM:!1,hasZ:!1},spatialReference:this.spatialReference,fieldsIndex:this.fieldsIndex,fields:this.service.fields};this.featureStore=new D.FeatureStore2D(c,this._storage);this.aggregateStore=new G.ClusterStore(c,this.spatialReference,this._storage);this.handles.add(this.aggregateStore.events.on("valueRangesChanged",function(c){a.remoteClient.invoke("emitEvent",{name:"valueRangesChanged",
event:{valueRanges:c.valueRanges}}).catch(f)}))};b.prototype._initQueryEngine=function(){var a;null===(a=this.queryEngine)||void 0===a?void 0:a.destroy();this.queryEngine=new B.default({definitionExpression:this.config.definitionExpression,fields:this.service.fields,geometryType:this.service.geometryType,objectIdField:this.service.objectIdField,hasM:!1,hasZ:!1,spatialReference:this.spatialReference.toJSON(),cacheSpatialQueries:!0,featureStore:this.featureStore,timeInfo:this.service.timeInfo})};b.prototype.destroy=
function(){this._updateQueue.destroy();this._source.destroy();this.queryEngine.destroy();this.attributeStore&&this.attributeStore.destroy()};Object.defineProperty(b.prototype,"fieldsIndex",{get:function(){return new C(this.service.fields)},enumerable:!1,configurable:!0});Object.defineProperty(b.prototype,"hasAggregates",{get:function(){return!!this.config.schema.targets.aggregate},enumerable:!1,configurable:!0});Object.defineProperty(b.prototype,"spatialReference",{get:function(){return this.tileStore.tileScheme.spatialReference},
enumerable:!1,configurable:!0});Object.defineProperty(b.prototype,"updating",{get:function(){return this.isUpdating()},enumerable:!1,configurable:!0});b.prototype.isUpdating=function(){return this._source.updating||!!this._updateQueue.length};b.prototype.enableEvent=function(a){this._source.enableEvent(a.name,a.value)};b.prototype.invalidate=function(a){return d.__awaiter(this,void 0,void 0,function(){var c,b,g,n,p,l=this;return d.__generator(this,function(d){switch(d.label){case 0:if(!a.any())return[2];
z("esri-2d-update-debug")&&a.describe();c=this.tileStore.tiles.map(function(a){a=a.key;var c=h.createResolver();l._tileToResolver.set(a.id,c);return c.promise});b=this._updateQueue.takeAll();this._updateQueue.resume();if(!(this.hasAggregates&&a.mesh&&a.targets.aggregate)||a.queryFilter)return[3,1];this._repushAggregateMeshTiles(a);return[3,3];case 1:return this._source.resubscribe(a),h.all(c).then(function(){l._source.resume()}),a.mesh?[4,k.whenFalseOnce(this,"updating")]:[3,3];case 2:d.sent(),d.label=
3;case 3:return this.notifyChange("updating"),[4,h.all(c)];case 4:d.sent();this._updateQueue.pause();g=0;for(n=b;g<n.length;g++)p=n[g],this._patchTile(p);a.source&&(this._cleanupNeeded=!0);return[2]}})})};b.prototype.resume=function(){this._updateQueue.resume();return this._source.resume()};b.prototype.update=function(a,c,b){void 0===b&&(b=!1);return d.__awaiter(this,void 0,void 0,function(){return d.__generator(this,function(d){switch(d.label){case 0:return this._editing?[4,k.whenFalseOnce(this,
"updating")]:[3,2];case 1:d.sent(),d.label=2;case 2:return b&&(this._source.pause(),this._updateQueue.pause()),this._set("config",c),this._schema=c.schema,this._initQueryEngine(),[4,h.all([this._source.update(a,c.schema.source),this.featureStore.updateSchema(a,c.schema.targets.feature),this.attributeStore.update(a,c.schema.processors[0].storage),this.attributeStore.updateFilters(a,this)])];case 3:return d.sent(),[4,this.aggregateStore.updateSchema(a,c.schema.targets.aggregate)];case 4:return d.sent(),
[2]}})})};b.prototype.refresh=function(){return d.__awaiter(this,void 0,void 0,function(){return d.__generator(this,function(a){switch(a.label){case 0:return this._source.resubscribe(w.UpdateToken.all(),!0),this._cleanupNeeded=!0,this.notifyChange("updating"),[4,k.whenFalseOnce(this,"updating",!0)];case 1:return a.sent(),[2]}})})};b.prototype.onTileUpdate=function(a){this.aggregateStore.onTileUpdate(a);for(var c=0,b=a.added;c<b.length;c++){var d=b[c];this._source.subscribe(d);this._level=d.level}c=
0;for(a=a.removed;c<a.length;c++)b=a[c],this._source.unsubscribe(b),this._cleanupNeeded=!0,this._tileToResolver.has(b.id)&&(this._tileToResolver.get(b.id).resolve(),this._tileToResolver.delete(b.id));this.notifyChange("updating")};b.prototype.onIdle=function(){this.hasAggregates&&this._invalidated&&(this._repushAggregateMeshTiles(),this._invalidated=!1);this._markAndSweep()};b.prototype.onEdits=function(a){return d.__awaiter(this,void 0,void 0,function(){return d.__generator(this,function(c){switch(c.label){case 0:return this._editing?
[4,k.whenFalseOnce(this,"updating")]:[3,2];case 1:return c.sent(),[2,this.onEdits(a)];case 2:return this._editing=!0,[4,this._source.onEdits(a)];case 3:return c.sent(),[4,k.whenFalseOnce(this,"updating")];case 4:return c.sent(),this._editing=!1,[2]}})})};b.prototype.queryExtent=function(a){return this.queryEngine.executeQueryForExtent(a)};b.prototype.queryFeatures=function(a){return this.queryEngine.executeQuery(a)};b.prototype.queryFeatureCount=function(a){return this.queryEngine.executeQueryForCount(a)};
b.prototype.queryLatestObservations=function(a){return this.queryEngine.executeQueryForLatestObservations(a)};b.prototype.queryObjectIds=function(a){return this.queryEngine.executeQueryForIds(a)};b.prototype.queryStatistics=function(){return d.__awaiter(this,void 0,void 0,function(){return d.__generator(this,function(a){return[2,d.__assign(d.__assign({},this.featureStore.storeStatistics),{displayedFeatureCount:0,displayedVertexCount:0,displayPreProcessTime:0})]})})};b.prototype.getObjectId=function(a){return this.featureStore.lookupObjectId(a,
this._storage)};b.prototype.getDisplayId=function(a){if(this._schema.targets.aggregate){var c=this.aggregateStore.getDisplayId(a);return q.isNone(c)?(a=this.featureStore.lookupDisplayId(a),this.aggregateStore.getDisplayIdForReferenceId(a)):c}return this.featureStore.lookupDisplayId(a)};b.prototype.getFeature=function(a){a=this.featureStore.lookupFeatureByDisplayId(a,this._storage);if(q.isNone(a))return null;var c=a.readHydratedGeometry(),c=A.convertToGeometry(c,a.geometryType,a.hasZ,a.hasM);return{attributes:a.readAttributes(),
geometry:c}};b.prototype.getAggregate=function(a){return this.aggregateStore.getAggregate(a)};b.prototype.setHighlight=function(a){return d.__awaiter(this,void 0,void 0,function(){var c,b=this;return d.__generator(this,function(d){c=a.map(function(a){return b.getDisplayId(a)});return[2,this.attributeStore.setHighlight(a,c)]})})};b.prototype._repushAggregateMeshTiles=function(a){for(var c=0,b=this.tileStore.tiles;c<b.length;c++)this._patchTile({type:"replace",id:b[c].key.id,addOrUpdate:I.FeatureSetReaderJSON.fromOptimizedFeatures([],
this.service.geometryType),remove:[],end:!0,noData:!1,update:a||w.UpdateToken.create({mesh:!0,targets:{aggregate:!0}})})};b.prototype._maybeForceCleanup=function(){5E3<performance.now()-this._lastCleanup&&this._markAndSweep()};b.prototype._patchTile=function(a,c){var b=this;a=this._updateQueue.push(a,c).then(function(){b.notifyChange("updating")}).catch(function(a){b.notifyChange("updating")});this.notifyChange("updating");return a};b.prototype._onDisplayTilePatch=function(a,c){return d.__awaiter(this,
void 0,void 0,function(){var b,g,n,p,l,x,e,f,k;return d.__generator(this,function(m){switch(m.label){case 0:b=this.tileStore.get(a.id);g=a.update;a.remove.length&&(this._cleanupNeeded=!0);n=[];p=0;for(l=a.remove;p<l.length;p++)x=l[p],n.push(this.featureStore.lookupDisplayId(x));a.remove=n;h.throwIfAborted(c);m.label=1;case 1:m.trys.push([1,7,,8]);if(q.isNone(a.addOrUpdate))return this.processor.onTileData(b,d.__assign(d.__assign({},a),{addOrUpdate:null}),c).catch(function(a){h.throwIfNotAbortError(a)}),
this._finishedPatch(a),[2];a.addOrUpdate._storage=this._storage;e=a.addOrUpdate.hasFilter();f=a.addOrUpdate.instance;a.addOrUpdate._arcadeSpatialReference=this.spatialReference;if(!this.featureStore.hasInstance(f)||g.targets.feature&&!e)this.featureStore.onTileData(b,a,this._storage);if(!g.storage.data&&!g.storage.filters||e)return[3,4];this.attributeStore.onTileData(b,a);return this._source.isStream?[4,this.attributeStore.sendUpdates()]:[3,3];case 2:return m.sent(),[3,4];case 3:this.attributeStore.sendUpdates(),
m.label=4;case 4:return this.hasAggregates&&g.targets.aggregate&&(this.aggregateStore.onTileData(b,a,this._storage,this.featureStore,this.attributeStore,g.mesh),g.mesh&&(this.attributeStore.onTileData(b,a),this.attributeStore.sendUpdates())),g.mesh?[4,this.processor.onTileData(b,a,c)]:[3,6];case 5:m.sent(),m.label=6;case 6:return this._maybeForceCleanup(),this._finishedPatch(a),[3,8];case 7:return k=m.sent(),h.throwIfNotAbortError(k),[3,8];case 8:return[2]}})})};b.prototype._finishedPatch=function(a){(a.noData||
a.end)&&this._tileToResolver.has(a.id)&&(this._tileToResolver.get(a.id).resolve(),this._tileToResolver.delete(a.id))};b.prototype._markAndSweep=function(){var a=this;this._lastCleanup=performance.now();if(this._cleanupNeeded||this._source.isStream){this._cleanupNeeded=!1;var c=this._storage.getBitset(this._markedIdsBufId),b=new Set;c.clear();for(var d=function(d){d=a.featureStore.lookupDisplayId(d);var l=a._storage.getInstanceId(d);d&&(b.add((4294901760&l)>>>16),c.set(d))},e=0,f=this.tileStore.tiles;e<
f.length;e++)this._source.forEachRequest(f[e].key.id,function(a){if(!q.isNone(a.features))for(a=a.features.getCursor();a.next();){var b=a.getObjectId();d(b)}});this._source.forEachPendingEdit(function(a){return d(a)});this._updateQueue.forEach(function(a){var b=0;for(a=a.remove;b<a.length;b++)d(a[b])});this.config.schema.targets.aggregate&&(this.aggregateStore.sweepFeatures(c,this.featureStore),this.aggregateStore.sweepClusters(this._storage,this._level));this.featureStore.sweepFeatures(c,this._storage);
this.featureStore.sweepFeatureSets(b)}};d.__decorate([e.property({constructOnly:!0})],b.prototype,"tileStore",void 0);d.__decorate([e.property()],b.prototype,"config",void 0);d.__decorate([e.property({readOnly:!0,dependsOn:["service"]})],b.prototype,"fieldsIndex",null);d.__decorate([e.property()],b.prototype,"processor",void 0);d.__decorate([e.property({constructOnly:!0})],b.prototype,"remoteClient",void 0);d.__decorate([e.property({constructOnly:!0})],b.prototype,"service",void 0);d.__decorate([e.property({dependsOn:["tileStore"]})],
b.prototype,"spatialReference",null);d.__decorate([e.property()],b.prototype,"updating",null);return b=d.__decorate([e.subclass("esri.views.2d.layers.features.controllers.FeatureController2D")],b)}(y.HandleOwner);v.default=u});