// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.17/esri/copyright.txt for details.
//>>built
define("require exports tslib ../../../../core/has ../../../../core/promiseUtils ../../../webgl ./Rect ./RectangleBinPack".split(" "),function(v,w,g,q,m,r,n,p){function t(c){for(var b=new Set,a=0;a<c.length;a++)b.add(Math.floor(c[a]/256));return b}function u(c,b,a){c.has(b)||c.set(b,a().then(function(){c.delete(b)}).catch(function(a){c.delete(b);m.throwIfNotAbortError(a)}));return c.get(b)}return function(){function c(b,a,e){this.height=this.width=0;this._dirties=[];this._glyphData=[];this._currentPage=
0;this._glyphCache={};this._textures=[];this._rangePromises=new Map;this.width=b;this.height=a;this._glyphSource=e;this._binPack=new p(b-4,a-4);this._glyphData.push(new Uint8Array(b*a));this._dirties.push(!0);this._textures.push(null);this._initDecorationGlyph()}c.prototype.dispose=function(){this._binPack=null;for(var b=0,a=this._textures;b<a.length;b++){var e=a[b];e&&e.dispose()}this._textures.length=0;this._glyphData.length=0};c.prototype._initDecorationGlyph=function(){for(var b=[117,149,181,
207,207,181,149,117],a=[],e=0;e<b.length;e++)for(var c=b[e],d=0;11>d;d++)a.push(c);b={metrics:{width:5,height:2,left:0,top:0,advance:0},bitmap:new Uint8Array(a)};this._recordGlyph(b)};c.prototype.getGlyphItems=function(b,a,e){return g.__awaiter(this,void 0,void 0,function(){var c,d=this;return g.__generator(this,function(f){switch(f.label){case 0:return c=this._getGlyphCache(b),[4,this._fetchRanges(b,a,e)];case 1:return f.sent(),[2,a.map(function(a){return d._getMosaicItem(c,b,a)})]}})})};c.prototype.bind=
function(b,a,e,c){var d=this._getTexture(b,e);d.setSamplingMode(a);this._dirties[e]&&(d.setData(this._glyphData[e]),this._dirties[e]=!1);b.bindTexture(d,c)};c.prototype._getGlyphCache=function(b){this._glyphCache[b]||(this._glyphCache[b]={});return this._glyphCache[b]};c.prototype._getTexture=function(b,a){this._textures[a]||(this._textures[a]=new r.Texture(b,{pixelFormat:6406,dataType:5121,width:this.width,height:this.height},new Uint8Array(this.width*this.height)));return this._textures[a]};c.prototype._invalidate=
function(){this._dirties[this._currentPage]=!0};c.prototype._fetchRanges=function(b,a,e){return g.__awaiter(this,void 0,void 0,function(){var c,d,f=this;return g.__generator(this,function(h){switch(h.label){case 0:return c=t(a),d=[],c.forEach(function(a){d.push(f._fetchRange(b,a,e))}),[4,m.all(d)];case 1:return h.sent(),[2]}})})};c.prototype._fetchRange=function(b,a,e){return g.__awaiter(this,void 0,void 0,function(){var c,d=this;return g.__generator(this,function(f){if(256<a)return[2,null];c=b+a;
return[2,u(this._rangePromises,c,function(){return d._glyphSource.getRange(b,a,e)})]})})};c.prototype._getMosaicItem=function(b,a,c){if(!b[c]){a=this._glyphSource.getGlyph(a,c);if(!a||!a.metrics)return{rect:new n.default(0,0,0,0),page:0,metrics:{left:0,width:0,height:0,advance:0,top:0},code:c,sdf:!0};var e=this._recordGlyph(a);b[c]={rect:e,page:this._currentPage,metrics:a.metrics,code:c,sdf:!0};this._invalidate()}return b[c]};c.prototype._getMosaicItemsStable=function(b,a,c){var e=this,d=[],f=c.map(function(a){return a});
c.map(function(a){return a}).sort().map(function(c){return e._getMosaicItem(b,a,c)}).forEach(function(a){var b=f.indexOf(a.code);d[b]=a;f[b]=null});return d};c.prototype._recordGlyph=function(b){var a=b.metrics;if(0===a.width)a=new n.default(0,0,0,0);else{var c=a.width+6,g=a.height+6,a=this._binPack.allocate(c,g);a.isEmpty&&(this._dirties[this._currentPage]||(this._glyphData[this._currentPage]=null),this._currentPage=this._glyphData.length,this._glyphData.push(new Uint8Array(this.width*this.height)),
this._dirties.push(!0),this._textures.push(null),this._initDecorationGlyph(),this._binPack=new p(this.width-4,this.height-4),a=this._binPack.allocate(c,g));var d=this._glyphData[this._currentPage];b=b.bitmap;var f=void 0,h=void 0;if(b)for(var k=0;k<g;k++)for(var f=c*k,h=this.width*(a.y+k)+a.x,l=0;l<c;l++)d[h+l]=b[f+l];q("esri-glyph-debug")&&this._showDebugPage(d)}return a};c.prototype._showDebugPage=function(b){var a=document.createElement("canvas"),c=a.getContext("2d"),g=new ImageData(this.width,
this.height),d=g.data;a.width=this.width;a.height=this.height;a.style.border="1px solid black";for(var f=0;f<b.length;++f)d[4*f+0]=b[f],d[4*f+1]=0,d[4*f+2]=0,d[4*f+3]=255;c.putImageData(g,0,0);document.body.appendChild(a)};return c}()});