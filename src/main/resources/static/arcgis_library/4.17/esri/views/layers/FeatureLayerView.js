// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.17/esri/copyright.txt for details.
//>>built
define("require exports tslib ../../core/Error ../../core/Logger ../../core/maybe ../../core/promiseUtils ../../core/SetUtils ../../core/watchUtils ../../core/accessorSupport/decorators ../../layers/support/commonProperties ../../layers/support/fieldUtils ../../support/arcadeOnDemand ../../tasks/support/Query ./support/FeatureEffect ./support/FeatureFilter ./support/popupUtils".split(" "),function(J,e,f,y,B,t,v,C,D,d,E,g,F,G,H,I,w){Object.defineProperty(e,"__esModule",{value:!0});e.FeatureLayerView=
void 0;var z=B.getLogger("esri.views.layers.FeatureLayerView");e.FeatureLayerView=function(e){return function(e){function a(){for(var b=[],c=0;c<arguments.length;c++)b[c]=arguments[c];b=e.apply(this,b)||this;b._updatingRequiredFieldsPromise=null;b.effect=null;b.filter=null;b.layer=null;b.requiredFields=[];b.view=null;return b}f.__extends(a,e);a.prototype.initialize=function(){var b=this;D.init(this,"layer.renderer layer.labelingInfo layer.elevationInfo.featureExpressionInfo layer.displayField filter effect layer.timeInfo timeExtent".split(" "),
function(){return b._handleRequiredFieldsChange()},!0)};Object.defineProperty(a.prototype,"availableFields",{get:function(){var b=this.layer,c=this.layer.fields,a=this.requiredFields;return"outFields"in b&&b.outFields?g.fixFields(c,f.__spreadArrays(g.unpackFieldNames(c,b.outFields),a)):g.fixFields(c,a)},enumerable:!1,configurable:!0});Object.defineProperty(a.prototype,"maximumNumberOfFeatures",{get:function(){return 0},set:function(b){z.error("#maximumNumberOfFeatures\x3d","Setting maximum number of features is not supported")},
enumerable:!1,configurable:!0});Object.defineProperty(a.prototype,"maximumNumberOfFeaturesExceeded",{get:function(){return!1},enumerable:!1,configurable:!0});a.prototype.highlight=function(b,c){void 0===c&&(c={});throw Error("missing implementation");};a.prototype.createQuery=function(){var b={outFields:["*"],returnGeometry:!0,outSpatialReference:this.view.spatialReference},b=t.isSome(this.filter)?this.filter.createQuery(b):new G(b);this.timeExtent&&(b.timeExtent=b.timeExtent?b.timeExtent.intersection(this.timeExtent):
this.timeExtent.clone());return b};a.prototype.queryFeatures=function(b,c){throw Error("missing implementation");};a.prototype.queryObjectIds=function(b,c){throw Error("missing implementation");};a.prototype.queryFeatureCount=function(b,c){throw Error("missing implementation");};a.prototype.queryExtent=function(b,c){throw Error("missing implementation");};a.prototype._loadArcadeModules=function(b){if(b.get("expressionInfos.length"))return F.loadArcade()};a.prototype._handleRequiredFieldsChange=function(){var b=
this,c=this._updateRequiredFields();this._set("_updatingRequiredFieldsPromise",c);c.then(function(){b._updatingRequiredFieldsPromise===c&&b._set("_updatingRequiredFieldsPromise",null)})};a.prototype._updateRequiredFields=function(){return f.__awaiter(this,void 0,void 0,function(){var b,c,a,l,h,d,e,m,n,k,r,p,q,x,A;return f.__generator(this,function(f){switch(f.label){case 0:if(!this.layer||!this.view)return[2];b="3d"===this.view.type;c=this;l=a=c.layer;h=l.fields;d=l.objectIdField;e=l.renderer;m=l.displayField;
n=a.featureReduction;k=new Set;return[4,v.eachAlways([e?e.collectRequiredFields(k,h):null,g.collectLabelingFields(k,a),b?g.collectElevationFields(k,a):null,t.isSome(this.filter)?g.collectFilterFields(k,a,this.filter):null,this.effect?g.collectFilterFields(k,a,this.effect.filter):null,n?g.collectFeatureReductionFields(k,a,n):null])];case 1:r=f.sent();a.timeInfo&&this.timeExtent&&g.collectFields(k,a.fields,[a.timeInfo.startField,a.timeInfo.endField]);p=0;for(q=r;p<q.length;p++)x=q[p],x.error&&z.error(x.error);
g.collectField(k,h,d);b&&m&&g.collectField(k,h,m);A=C.valuesOfSet(k).sort();this._set("requiredFields",A);return[2]}})})};a.prototype.validateFetchPopupFeatures=function(b){var a=this.layer;if(!this.layer.popupEnabled)return new y("featurelayerview:fetchPopupFeatures","Popups are disabled",{layer:a});if(!w.getFetchPopupTemplate(this.layer,b))return new y("featurelayerview:fetchPopupFeatures","Layer does not define a popup template",{layer:a})};a.prototype.fetchClientPopupFeatures=function(b){return f.__awaiter(this,
void 0,void 0,function(){var a,d,l,h,e,u,m,n,k,r,p,q;return f.__generator(this,function(c){switch(c.label){case 0:a=t.isSome(b)?b.clientGraphics:null;if(!a||0===a.length)return[2,v.resolve([])];d=[];l=[];h=this.layer;e=w.getFetchPopupTemplate(h,b);return t.isSome(e)?[4,this._loadArcadeModules(e)]:[2,v.resolve([])];case 1:return m=(u=c.sent())&&u.arcadeUtils.hasGeometryOperations(e),[4,this.createPopupQuery(b)];case 2:n=c.sent();k=g.unpackFieldNames(h.fields,n.outFields);r=0;for(p=a;r<p.length;r++)q=
p[r],m||!g.featureHasFields(k,q)?l.push(q):d.push(q);if("stream"===h.type||0===l.length)return[2,v.resolve(d)];n.objectIds=l.map(function(a){return a.attributes[h.objectIdField]});return[2,h.queryFeatures(n).then(function(a){return d.concat(a.features)}).catch(function(){return l})]}})})};a.prototype.createPopupQuery=function(a){return f.__awaiter(this,void 0,void 0,function(){var b,d,e,h,g,u,m,n;return f.__generator(this,function(c){switch(c.label){case 0:return b=this.layer,d=b.createQuery(),e=
w.getFetchPopupTemplate(b,a),(g=t.isSome(e))?[4,this._loadArcadeModules(e)]:[3,2];case 1:g=c.sent(),c.label=2;case 2:return h=g,u=t.isSome(e)&&h&&h.arcadeUtils.hasGeometryOperations(e),m=!("point"!==b.geometryType&&!u),d.returnGeometry=m,d.returnZ=m,d.returnM=m,n=d,[4,w.getRequiredFields(this.layer,e)];case 3:return n.outFields=c.sent(),d.outSpatialReference=this.view.spatialReference,[2,d]}})})};a.prototype.canResume=function(){var a;return!e.prototype.canResume.call(this)||(null===(a=this.timeExtent)||
void 0===a?0:a.isEmpty)?!1:!0};f.__decorate([d.property()],a.prototype,"_updatingRequiredFieldsPromise",void 0);f.__decorate([d.property({readOnly:!0,dependsOn:["layer.outFields?","requiredFields"]})],a.prototype,"availableFields",null);f.__decorate([d.property({type:H})],a.prototype,"effect",void 0);f.__decorate([d.property({type:I})],a.prototype,"filter",void 0);f.__decorate([d.property(E.combinedViewLayerTimeExtentProperty)],a.prototype,"timeExtent",void 0);f.__decorate([d.property()],a.prototype,
"layer",void 0);f.__decorate([d.property({type:Number})],a.prototype,"maximumNumberOfFeatures",null);f.__decorate([d.property({readOnly:!0,type:Boolean})],a.prototype,"maximumNumberOfFeaturesExceeded",null);f.__decorate([d.property({readOnly:!0})],a.prototype,"requiredFields",void 0);f.__decorate([d.property({dependsOn:["timeExtent"]})],a.prototype,"suspended",void 0);f.__decorate([d.property()],a.prototype,"view",void 0);return a=f.__decorate([d.subclass("esri.views.layers.FeatureLayerView")],a)}(e)}});