// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.17/esri/copyright.txt for details.
//>>built
define("require exports ../../../../core/maybe ../../../../core/libs/gl-matrix-2/mat4 ../../../../core/libs/gl-matrix-2/mat4f32 ../../../../core/libs/gl-matrix-2/mat4f64 ../../../../core/libs/gl-matrix-2/vec3 ../../../../core/libs/gl-matrix-2/vec3f32 ../../../../core/libs/gl-matrix-2/vec3f64 ../../../../core/libs/gl-matrix-2/vec4 ../../../../geometry/support/aaBoundingBox ./PointHighlights ../../support/geometryUtils ../../support/geometryUtils ../../support/orientedBoundingBox ../../webgl-engine/core/shaderLibrary/Slice.glsl ../../webgl-engine/core/shaderLibrary/output/OutputHighlight.glsl ../../webgl-engine/lib/DefaultVertexAttributeLocations ../../webgl-engine/lib/intersectorUtils ../../webgl-engine/shaders/PointRendererTechnique ../../../webgl/BufferObject ../../../webgl/VertexArrayObject".split(" "),
function(v,e,p,C,P,Q,r,R,D,S,t,T,U,V,F,W,X,Y,Z,G,H,aa){function E(b,a,d,q,c){if(d.drawScreenSpace)return d.fixedSize*a*q;c=(c?256:64)*a*q;return d.drawFixedSize?Math.min(d.fixedSize/2,c):0<d.screenMinSize?Math.min(Math.max(d.screenMinSize*a*q,b/2),c):Math.min(b/2,c)}function w(b){return p.isSome(b.component)?b.component:-1}function ba(b,a){if(p.isNone(b))return b;b=b.filter(function(d){return d.id!==a});return 0===b.length?null:b}Object.defineProperty(e,"__esModule",{value:!0});e.PointRenderer=void 0;
var ca={positions:[{name:"position",count:3,type:5126,offset:0,stride:12,normalized:!1}],colors:[{name:"color",count:3,type:5121,offset:0,stride:3,normalized:!0}]};v=function(){function b(a){var d=this;this._params=a;this.type="Point";this.isGround=!1;this._bindParameters={inverseViewport:[0,0],highlightDepthTexture:null};this._highlights=new T.PointHighlights({forEachNode:function(a){return d.forEachNode(a)},addHighlight:function(a,c,b){return d.addHighlight(a,c,b)},removeHighlight:function(a,c){return d.removeHighlight(a,
c)}});this.canRender=!0;this.layerUid="";this._useFixedSizes=!1;this._scaleFactor=1;this._minSizePx=0;this._useRealWorldSymbolSizes=!1;this._sizePx=this._size=0;this._slicePlaneEnabled=!1;this._clipBox=t.create(t.POSITIVE_INFINITY);this._techniqueConfig=new G.PointRendererTechniqueConfiguration;this.tempMatrix4=P.mat4f32.create();this.tempVec3=R.vec3f32.create();this.nodes=[]}Object.defineProperty(b.prototype,"needsHighlight",{get:function(){return this._highlights.hasHighlights},enumerable:!1,configurable:!0});
b.prototype.initializeRenderContext=function(a){this._initContext=a;this._techniqueRep=this._initContext.shaderTechniqueRep;a.requestRender()};b.prototype.uninitializeRenderContext=function(){};b.prototype.intersect=function(a,d,b,c){var q=this,h=D.vec3f64.create(),g=D.vec3f64.create(),O=D.vec3f64.create(),I=D.vec3f64.create(),e=V.plane.create(),x=a.camera.perScreenPixelRatio/2,J=a.camera.near,m=this._getSizeParams();r.vec3.subtract(g,c,b);var p=1/r.vec3.length(g);r.vec3.scale(g,g,p);r.vec3.negate(O,
g);S.vec4.set(e,g[0],g[1],g[2],-r.vec3.dot(g,b));var M=function(){return function(){this.normal=this.dist=this.point=this.pointId=this.node=null;this.layerUid=""}}(),y=new M,z=new M,v=[],K=t.create(),L=t.create(this._clipBox);t.offset(L,-b[0],-b[1],-b[2],L);for(var n=function(k){var u=k.splatSize*C._scaleFactor,f=F.minimumDistancePlane(k.obb,e),l=F.maximumDistancePlane(k.obb,e),f=f-(m.drawScreenSpace?0:E(u,f+J,m,x,k.isLeaf)),l=l-(m.drawScreenSpace?0:E(u,l+J,m,x,k.isLeaf)),f=null!=y.dist&&null!=z.dist&&
y.dist<f*p&&z.dist>l*p;if(0>l||f)return"continue";l=E(u,l+J,m,x,k.isLeaf);if(!F.intersectLine(k.obb,b,g,l))return"continue";var A=l*l;F.toAaBoundingBox(k.obb,K);t.offset(K,-b[0],-b[1],-b[2],K);var w=!t.contains(L,K);r.vec3.subtract(I,k.origin,b);for(var l=k.coordinates.length/3,f=function(f){h[0]=I[0]+k.coordinates[3*f];h[1]=I[1]+k.coordinates[3*f+1];h[2]=I[2]+k.coordinates[3*f+2];if(w&&!t.containsPoint(L,h))return"continue";var l=r.vec3.dot(h,g),e=r.vec3.squaredLength(h)-l*l;if(e>A)return"continue";
var n=l+J,N=m.drawScreenSpace?0:E(u,n,m,x,k.isLeaf);if(0>l-N)return"continue";n=E(u,n-N,m,x,k.isLeaf);if(e>n*n)return"continue";var B=(l-N)*p,l=function(a){var b=a.point;null==b&&(b=D.vec3f64.create());b[0]=k.origin[0]+k.coordinates[3*f];b[1]=k.origin[1]+k.coordinates[3*f+1];b[2]=k.origin[2]+k.coordinates[3*f+2];a.point=b;a.dist=B;a.normal=O;a.node=k;a.pointId=f;a.layerUid=q.layerUid};(null==y.dist||B<y.dist)&&(null==d||d(b,c,B))&&l(y);0!==a.options.store&&(null==z.dist||B>z.dist)&&(null==d||d(b,
c,B))&&l(z);2!==a.options.store||null!=d&&!d(b,c,B)||(e=new M,l(e),v.push(e))},n=0;n<l;n++)f(n)},C=this,f=0,A=this.nodes;f<A.length;f++)n(A[f]);var G=function(a){var b=a.node,d=a.pointId;return{type:"external",point:a.point,metadata:{layerUid:a.layerUid,createGraphic:function(){return q._params.createGraphic(b,d,a.point)}}}},n=function(a,b){var d=G(b);a.set(d,b.layerUid+"/"+b.node.id+"/"+b.pointId,b.dist,b.normal,Q.mat4f64.IDENTITY,void 0);a.intersector="PointRenderer"};null!=y.dist&&(f=a.results.min,
(null==f.dist||y.dist<f.dist)&&n(f,y));null!=z.dist&&0!==a.options.store&&(f=a.results.max,(null==f.dist||z.dist>f.dist)&&n(f,z));if(2===a.options.store)for(f=U.ray.fromPoints(b,c),A=0;A<v.length;A++){var H=v[A],w=new Z.IntersectorResult(f);n(w,H);a.results.all.push(w)}};b.prototype.render=function(a){if(0!==a.pass&&1!==a.pass&&4!==a.pass)return!1;for(var b=1===a.pass,q=a.rctx,c=0,u=this.nodes;c<u.length;c++){var h=u[c];null==h.vao&&this._initNode(a,h)}var c=this._getSizeParams(),u=this.selectTechnique(a,
c),g=u.program;if(null==g||0===this.nodes.length)return!0;var e=this._clipBox,p=!t.equals(e,t.POSITIVE_INFINITY,function(a,b){return a===b});p||(r.vec3.set(this.tempVec3,-Infinity,-Infinity,-Infinity),g.setUniform3fv("uClipMin",this.tempVec3),r.vec3.set(this.tempVec3,Infinity,Infinity,Infinity),g.setUniform3fv("uClipMax",this.tempVec3));q.bindProgram(g);u.bindPipelineState(q);g.setUniformMatrix4fv("uProjectionMatrix",a.camera.projectionMatrix);b&&g.setUniform2f("nearFar",a.camera.near,a.camera.far);
a.isHighlightPass&&(this._bindParameters.inverseViewport[0]=1/a.camera.fullViewport[2],this._bindParameters.inverseViewport[1]=1/a.camera.fullViewport[3],this._bindParameters.highlightDepthTexture=a.highlightDepthTexture,X.OutputHighlight.bindOutputHighlight(q,g,this._bindParameters));b=a.camera.pixelRatio;c.drawFixedSize&&g.setUniform2f("uPointScale",c.fixedSize*b,a.camera.fullHeight);for(var v=this._slicePlaneEnabled?a.sliceHelper&&a.sliceHelper.plane:null,x=0,w=this.nodes;x<w.length;x++)if(h=w[x],
0!==h.coordinates.length&&(!a.isHighlightPass||h.highlights)){g.setUniform2f("uScreenMinMaxSize",c.screenMinSize*b,(h.isLeaf?256:64)*b);c.drawFixedSize||g.setUniform2f("uPointScale",h.splatSize*this._scaleFactor*b,a.camera.fullHeight/b);var m=h.origin;p&&(r.vec3.set(this.tempVec3,e[0]-m[0],e[1]-m[1],e[2]-m[2]),g.setUniform3fv("uClipMin",this.tempVec3),r.vec3.set(this.tempVec3,e[3]-m[0],e[4]-m[1],e[5]-m[2]),g.setUniform3fv("uClipMax",this.tempVec3));C.mat4.identity(this.tempMatrix4);C.mat4.translate(this.tempMatrix4,
this.tempMatrix4,m);C.mat4.multiply(this.tempMatrix4,a.camera.viewMatrix,this.tempMatrix4);g.setUniformMatrix4fv("uModelViewMatrix",this.tempMatrix4);W.Slice.bindUniforms(g,u.configuration,v,m);q.bindVAO(h.vao);a.isHighlightPass?this._renderHighlightFragments(q,h):q.drawArrays(0,0,h.coordinates.length/3)}return!0};b.prototype._renderHighlightFragments=function(a,b){var d=b.highlights;if(!p.isNone(d)){b=p.unwrap(d[0].component);for(var c=b+1,e=1;e<d.length;e++){var h=p.unwrap(d[e].component);h!==c&&
(c-=b,0<c&&a.drawArrays(0,b,c),b=h);c=h+1}d=c-b;0<d&&a.drawArrays(0,b,d)}};Object.defineProperty(b.prototype,"useFixedSizes",{get:function(){return this._useFixedSizes},set:function(a){this._useFixedSizes!==a&&(this._useFixedSizes=a,this._requestRender())},enumerable:!1,configurable:!0});Object.defineProperty(b.prototype,"scaleFactor",{get:function(){return this._scaleFactor},set:function(a){this._scaleFactor!==a&&(this._scaleFactor=a,this._requestRender())},enumerable:!1,configurable:!0});Object.defineProperty(b.prototype,
"minSizePx",{get:function(){return this._minSizePx},set:function(a){this._minSizePx!==a&&(this._minSizePx=a,this._requestRender())},enumerable:!1,configurable:!0});Object.defineProperty(b.prototype,"useRealWorldSymbolSizes",{get:function(){return this._useRealWorldSymbolSizes},set:function(a){this._useRealWorldSymbolSizes!==a&&(this._useRealWorldSymbolSizes=a,this._requestRender())},enumerable:!1,configurable:!0});Object.defineProperty(b.prototype,"size",{get:function(){return this._size},set:function(a){this._size!==
a&&(this._size=a,this._requestRender())},enumerable:!1,configurable:!0});Object.defineProperty(b.prototype,"sizePx",{get:function(){return this._sizePx},set:function(a){this._sizePx!==a&&(this._sizePx=a,this._requestRender())},enumerable:!1,configurable:!0});Object.defineProperty(b.prototype,"clippingBox",{set:function(a){t.set(this._clipBox,a||t.POSITIVE_INFINITY)},enumerable:!1,configurable:!0});Object.defineProperty(b.prototype,"slicePlane",{get:function(){return this._slicePlaneEnabled},set:function(a){this._slicePlaneEnabled!==
a&&(this._slicePlaneEnabled=a,this._requestRender())},enumerable:!1,configurable:!0});Object.defineProperty(b.prototype,"intersectionHandlerId",{get:function(){return this.layerUid},enumerable:!1,configurable:!0});b.prototype.addNode=function(a){this.nodes.push(a);this._highlights.nodeAdded(a);this._requestRender()};b.prototype.removeNode=function(a){var b=this,e=null;this.nodes=this.nodes.filter(function(c){return c.id===a?(e=c,c.vao&&(c.vao.dispose(!0),c.vao=null),b._highlights.nodeRemoved(c),!1):
!0});this._requestRender();return e};b.prototype.forEachNode=function(a){this.nodes.forEach(a)};b.prototype.removeAll=function(){this.nodes.forEach(function(a){a.vao&&(a.vao.dispose(!0),a.vao=null)});this._highlights.removeAll();this.nodes=[];this._requestRender()};b.prototype.highlight=function(a){return this._highlights.add(a)};b.prototype.addHighlight=function(a,b,e){var c=a.highlights;p.isNone(c)&&(c=[]);b={component:b,id:e};c.push(b);e=w(b);for(var d=c.length-1;0<d&&e<w(c[d-1]);)b=[c[d],c[d-
1]],c[d-1]=b[0],c[d]=b[1],--d;a.highlights=c;this._requestRender()};b.prototype.removeHighlight=function(a,b){a.highlights=ba(a.highlights,b);this._requestRender()};b.prototype._initNode=function(a,b){a=a.rctx;b.vao=new aa(a,Y.Default3D,ca,{positions:H.createVertex(a,35044,b.coordinates),colors:H.createVertex(a,35044,b.rgb)})};b.prototype._requestRender=function(){this._initContext&&this._initContext.requestRender()};b.prototype._getSizeParams=function(){var a=this._useFixedSizes,b=a&&!this._useRealWorldSymbolSizes,
e=b?this._sizePx:this._size,c=this._minSizePx;a&&(c=0);return{drawScreenSpace:b,drawFixedSize:a,fixedSize:e,screenMinSize:c}};b.prototype.selectTechnique=function(a,b){this._techniqueConfig.drawScreenSize=b.drawScreenSpace;this._techniqueConfig.slicePlaneEnabled=this._slicePlaneEnabled;this._techniqueConfig.sceneHasOcludees=a.hasOccludees;this._techniqueConfig.output=1===a.pass?1:4===a.pass?4:0;return this._techniqueRep.acquireAndReleaseExisting(G.PointRendererTechnique,this._techniqueConfig,this._technique)};
return b}();e.PointRenderer=v;(function(b){b.isInstanceOfNode=function(a){return a.hasOwnProperty("splatSize")}})(v=e.PointRenderer||(e.PointRenderer={}));e.PointRenderer=v});