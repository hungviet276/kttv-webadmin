// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.17/esri/copyright.txt for details.
//>>built
define("require exports tslib ../../../Graphic ../../../core/Error ../../../core/Logger ../../../core/maybe ../../../core/promiseUtils ../../../core/SetUtils ../../../core/accessorSupport/decorators ../../../core/sql/WhereClause ../../../layers/buildingSublayers/BuildingComponentSublayer ../../../layers/support/fieldUtils ../../../tasks/support/Query ./BuildingSublayerView3D ./I3SMeshView3D ./i3s/BuildingFilterUtil ./i3s/I3SGeometryUtil ./i3s/I3SQueryEngine ./i3s/I3SQueryFeatureAdapter ./i3s/I3SQueryFeatureStore ./i3s/I3SUtil ./support/DefinitionExpressionSceneLayerView ../../layers/BuildingComponentSublayerView ../../layers/support/popupUtils ../../support/Scheduler".split(" "),
function(P,Q,c,B,v,C,m,w,D,f,E,F,l,x,G,H,y,I,J,K,L,z,M,N,t,O){var n=C.getLogger("esri.views.3d.layers.BuildingComponentSublayerView3D");return function(g){function b(){var a=null!==g&&g.apply(this,arguments)||this;a.layerView=null;a._elevationContext="scene";a._isIntegratedMesh=!1;a._supportsLabeling=!1;a.lodFactor=1;a.progressiveLoadFactor=1;a._queryEngine=null;return a}c.__extends(b,g);Object.defineProperty(b.prototype,"layerUid",{get:function(){return this.sublayer.layer.uid},enumerable:!1,configurable:!0});
Object.defineProperty(b.prototype,"sublayerUid",{get:function(){return this.sublayer.uid},enumerable:!1,configurable:!0});b.prototype.initialize=function(){var a=this;this.updatingHandles.add(this,"sublayer.renderer,definitionExpressionFields,filterExpressionFields",function(){return a._updateRequiredFields()});this.updatingHandles.add(this.sublayer,"renderer",function(d){return a._rendererChange(d)},2);this.updatingHandles.add(this,"parsedDefinitionExpression",function(){return a._filterChange()});
this.updatingHandles.add(this,"parsedFilterExpressions",function(){return a._updateSymbologyOverride()},2);this.addResolvingPromise(this._updateRequiredFields())};Object.defineProperty(b.prototype,"parsedFilterExpressions",{get:function(){var a=this;return"Overview"===this.sublayer.modelName?[]:this.layerView.filterExpressions.map(function(d){var b=d[0];d=d[1];var h;try{h=E.WhereClause.create(b,a.sublayer.fieldsIndex)}catch(k){return n.error("Failed to parse filterExpression: "+k),null}if(!h.isStandardized)return n.error("filterExpression is using non standard function"),
null;b=[];z.findFieldsCaseInsensitive(h.fieldNames,a.sublayer.fields,{missingFields:b});return 0<b.length?(n.error("filterExpression references unknown fields: "+b.join(", ")),null):[h,d]}).filter(function(a){return null!=a})},enumerable:!1,configurable:!0});b.prototype._updateSymbologyOverride=function(){var a=this,b=this.parsedFilterExpressions;0<b.length?this._setSymbologyOverride(function(d,h){for(var k=0;k<b.length;k++){var e=b[k],c=e[0],e=e[1];try{if(c.testFeature(d))return y.applyFilterMode(h,
e)}catch(p){a.logError(p)}}return y.applyFilterMode(h,null)},this.filterExpressionFields):this._setSymbologyOverride(null,null)};Object.defineProperty(b.prototype,"filterExpressionFields",{get:function(){return l.fixFields(this.sublayer.fields,this.parsedFilterExpressions.reduce(function(a,b){return a.concat(b[0].fieldNames)},[]))},enumerable:!1,configurable:!0});Object.defineProperty(b.prototype,"availableFields",{get:function(){var a=this.sublayer,b=a.fields,e=this.requiredFields;if(a.outFields||
a.layer.outFields)a=c.__spreadArrays(a.outFields||[],a.layer.outFields||[]),e=c.__spreadArrays(l.unpackFieldNames(b,a),e);return l.fixFields(b,e)},enumerable:!1,configurable:!0});b.prototype._createLayerGraphic=function(a){a=new B(null,null,a);a.layer=this.sublayer.layer;a.sourceLayer=this.sublayer;return a};b.prototype.canResume=function(){return g.prototype.canResume.call(this)&&(!this._controller||this._controller.rootNodeVisible)};b.prototype.fetchPopupFeatures=function(a,b){return c.__awaiter(this,
void 0,void 0,function(){var a,d,k,f,A,p,g,q,u,r;return c.__generator(this,function(e){switch(e.label){case 0:if(a=this._validateFetchPopupFeatures(b))return[2,w.reject(a)];if(!m.isSome(b)||!b.clientGraphics||0===b.clientGraphics.length)return[2,[]];d=[];k=[];A=l.unpackFieldNames;p=[this.sublayer.fields];return[4,t.getRequiredFields(this.sublayer,t.getFetchPopupTemplate(this.sublayer,b))];case 1:f=A.apply(void 0,p.concat([e.sent()]));g=new Set;q=0;for(u=b.clientGraphics;q<u.length;q++)r=u[q],l.populateMissingFields(f,
r,g)?k.push(r):d.push(r);return 0===k.length?[2,w.resolve(d)]:m.isSome(this.sublayer.associatedLayer)?[4,this.sublayer.associatedLayer.load().catch(function(){return n.warn("Failed to load associated feature layer. Displaying popup attributes from cached attributes.")})]:[3,3];case 2:e.sent(),e.label=3;case 3:return[2,this.whenGraphicAttributes(k,D.valuesOfSet(g)).catch(function(){return k}).then(function(a){return d.concat(a)})]}})})};b.prototype._updateRequiredFields=function(){return c.__awaiter(this,
void 0,void 0,function(){var a,b,e,h;return c.__generator(this,function(d){switch(d.label){case 0:return b=l.fixFields,e=[this.sublayer.fields],this.sublayer.renderer?[4,this.sublayer.renderer.getRequiredFields(this.sublayer.fields)]:[3,2];case 1:return h=d.sent(),[3,3];case 2:h=[],d.label=3;case 3:return a=b.apply(void 0,e.concat([c.__spreadArrays.apply(void 0,[h,this.definitionExpressionFields||[],this.filterExpressionFields||[]])])),this._set("requiredFields",a),[2]}})})};b.prototype._validateFetchPopupFeatures=
function(a){var b=this.sublayer;if(!b.popupEnabled)return new v("buildingscenelayerview3d:fetchPopupFeatures","Popups are disabled",{sublayer:b});if(!t.getFetchPopupTemplate(b,a))return new v("buildingscenelayerview3d:fetchPopupFeatures","Layer does not define a popup template",{sublayer:b})};b.prototype.getFilters=function(){var a=g.prototype.getFilters.call(this);this.addSqlFilter(a,this.parsedDefinitionExpression,this.definitionExpressionFields,this.logError);return a};b.prototype.createQuery=
function(){return new x({outFields:["*"],returnGeometry:!1,outSpatialReference:this.view.spatialReference})};b.prototype.queryExtent=function(a){return this._ensureQueryEngine().executeQueryForExtent(this._ensureQuery(a))};b.prototype.queryFeatureCount=function(a){return this._ensureQueryEngine().executeQueryForCount(this._ensureQuery(a))};b.prototype.queryFeatures=function(a){var b=this;return this._ensureQueryEngine().executeQuery(this._ensureQuery(a)).then(function(a){if(null===a||void 0===a||
!a.features)return a;for(var d=b.sublayer,c=d.layer,e=0,f=a.features;e<f.length;e++){var g=f[e];g.layer=c;g.sourceLayer=d}return a})};b.prototype.queryObjectIds=function(a){return this._ensureQueryEngine().executeQueryForIds(this._ensureQuery(a))};b.prototype._ensureQueryEngine=function(){m.isNone(this._queryEngine)&&(this._queryEngine=this._createQueryEngine());return this._queryEngine};b.prototype._createQueryEngine=function(){var a=this,b=I.createGetFeatureExtent(this.view.spatialReference,this.view.renderSpatialReference,
this._collection);return new J.default({layerView:this,task:O.Task.FEATURE_QUERY_ENGINE,spatialIndex:new L.default({featureAdapter:new K.I3SQueryFeatureAdapter({objectIdField:this.sublayer.objectIdField,attributeStorageInfo:this.sublayer.attributeStorageInfo,getFeatureExtent:b}),forAllFeatures:function(b,c){return a._forAllFeatures(function(a,c,d){return b({id:a,index:c,meta:d})},c,2)},getFeatureExtent:b,sourceSpatialReference:z.getIndexCrs(this.sublayer),viewSpatialReference:this.view.spatialReference})})};
b.prototype._ensureQuery=function(a){return this._addDefinitionExpressionToQuery(m.isNone(a)?this.createQuery():x.from(a))};c.__decorate([f.property({aliasOf:"sublayer"})],b.prototype,"i3slayer",void 0);c.__decorate([f.property()],b.prototype,"layerView",void 0);c.__decorate([f.property({dependsOn:["_controller.rootNodeVisible"]})],b.prototype,"suspended",void 0);c.__decorate([f.property({readOnly:!0,aliasOf:"view.qualitySettings.sceneService.3dObject.lodFactor"})],b.prototype,"lodFactor",void 0);
c.__decorate([f.property({readOnly:!0,dependsOn:["layerView.filterExpressions","sublayer.fieldsIndex"]})],b.prototype,"parsedFilterExpressions",null);c.__decorate([f.property({type:[String],readOnly:!0,dependsOn:["parsedFilterExpressions"]})],b.prototype,"filterExpressionFields",null);c.__decorate([f.property({type:[String],readOnly:!0})],b.prototype,"requiredFields",void 0);c.__decorate([f.property({type:[String],readOnly:!0,dependsOn:["sublayer.outFields","sublayer.layer.outFields","requiredFields"]})],
b.prototype,"availableFields",null);return b=c.__decorate([f.subclass("esri.views.3d.layers.BuildingComponentSublayerView3D")],b)}(M.DefinitionExpressionSceneLayerView(H.I3SMeshView3D(G.BuildingSublayerView3DMixin(N,F))))});