// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.17/esri/copyright.txt for details.
//>>built
define(["require","exports","../../../../../../core/Logger","../../../../../webgl","../../VertexStream"],function(v,k,y,w,z){Object.defineProperty(k,"__esModule",{value:!0});k.DRA=void 0;var A=y.getLogger("esri.views.2d.engine.webgl.effects.post-processing.DRA");v=function(){function c(){this._fbos=null;this._colorAttachmentsPoints=[36064,36065];this._size=[0,0];this._programDesc={"min-max":{vsPath:"post-processing/pp",fsPath:"post-processing/dra/min-max",attributes:{a_position:0}},dra:{vsPath:"post-processing/pp",
fsPath:"post-processing/dra",attributes:{a_position:0}}}}c.prototype.dispose=function(){this._disposeFBOs();this._layerTexture&&(this._layerTexture.dispose(),this._layerTexture=null)};c.prototype.draw=function(b,g,a){this._createOrResizeResources(b);a=b.context;var d=b.pixelRatio,f=b.painter.materialManager,x=this._programDesc,h=b.state.size,c=this._fbos,l=[d*h[0],d*h[1]],k=a.capabilities.drawBuffers;if(k){this._quad||(this._quad=new z(a,[-1,-1,1,-1,-1,1,1,1]));d=this._layerTexture;g.copyToTexture(0,
0,l[0],l[1],0,0,d);h=this._quad;h.bind();var m=f.getProgram(b,x["min-max"]);a.bindProgram(m);a.setBlendingEnabled(!1);for(var r=g.colorTexture,t=g.colorTexture,e,u=[l[0],l[1]],n=[0,0],p=0;p<c.length;p++){var q=c[p];e=q.descriptor;n[0]=e.width;n[1]=e.height;a.bindFramebuffer(q);k.drawBuffers(this._colorAttachmentsPoints);a.setViewport(0,0,e.width,e.height);e=p;6<e&&(e=6);a.bindTexture(r,e);a.bindTexture(t,e+1);m.setUniform1i("u_minTexture",e);m.setUniform1i("u_maxTexture",e+1);m.setUniform2fv("u_srcResolution",
u);m.setUniform2fv("u_dstResolution",n);h.draw();r=q.getColorTexture(36064);t=q.getColorTexture(36065);u[0]=n[0];u[1]=n[1]}a.setViewport(0,0,l[0],l[1]);a.bindFramebuffer(g);b=f.getProgram(b,x.dra);a.bindProgram(b);a.bindTexture(r,5);a.bindTexture(t,6);a.bindTexture(d,7);b.setUniform1i("u_minColor",5);b.setUniform1i("u_maxColor",6);b.setUniform1i("u_texture",7);a.setStencilWriteMask(0);a.setStencilTestEnabled(!1);a.setDepthWriteEnabled(!1);a.setDepthTestEnabled(!1);h.draw();a.setBlendingEnabled(!0);
a.setBlendFunction(1,771);a.setStencilTestEnabled(!0);h.unbind()}else A.error("esri.DRA","WebGL Extension WEBGL_draw_buffers isn't supported!")};c.prototype._createOrResizeResources=function(b){var g=b.context,a=b.pixelRatio;b=b.state.size;var d=Math.round(a*b[0]),f=Math.round(a*b[1]);if(this._size[0]!==d||this._size[1]!==f){this._size[0]=d;this._size[1]=f;this._disposeFBOs();for(this._fbos=[];1<d||1<f;){var d=Math.max(1,Math.floor((d+2-1)/2)|0),f=Math.max(1,Math.floor((f+2-1)/2)|0),c={pixelFormat:6408,
internalFormat:6408,dataType:5121,samplingMode:9728,wrapMode:33071,flipped:!1,width:d,height:f},c=new w.FramebufferObject(g,{depthStencilTarget:0,width:d,height:f},[{attachmentPoint:36064,texture:c},{attachmentPoint:36065,texture:c}]);this._fbos.push(c)}this._layerTexture?this._layerTexture.resize(Math.round(a*b[0]),Math.round(a*b[1])):this._layerTexture=new w.Texture(g,{target:3553,pixelFormat:6408,internalFormat:6408,dataType:5121,wrapMode:33071,samplingMode:9729,flipped:!1,width:Math.round(a*b[0]),
height:Math.round(a*b[1])})}};c.prototype._disposeFBOs=function(){if(this._fbos){for(var b=0,c=this._fbos;b<c.length;b++)c[b].dispose();this._fbos.length=0;this._fbos=null}};return c}();k.DRA=v});