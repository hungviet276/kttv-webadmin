// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.17/esri/copyright.txt for details.
//>>built
define("require exports tslib ../../../Color ../../../core/Evented ../../../core/Handles ../../../core/maybe ../../../core/promiseUtils ../../../core/watchUtils ../../../core/accessorSupport/decorators ../../../core/libs/gl-matrix-2/vec3 ../../../core/libs/gl-matrix-2/vec3f64 ../../../core/libs/gl-matrix-2/vec4f64 ./EnvironmentRenderer ../support/earthUtils ../support/pointUtils ../support/projectionUtils ../support/sunUtils ../webgl-engine/lighting/Lightsources ../../../webscene/background/ColorBackground".split(" "),
function(l,e,f,y,z,A,q,r,m,h,g,k,t,B,u,C,v,n,p,D){Object.defineProperty(e,"__esModule",{value:!0});e.SceneViewEnvironmentManager=void 0;var w=k.vec3f64.fromValues(.5773502691896258,-.5773502691896258,.5773502691896258);l=function(e){function d(){for(var a=[],b=0;b<arguments.length;b++)a[b]=arguments[b];a=e.apply(this,a)||this;a._referencePointUpdateDelay=200;a._referencePointUpdateInterval=3E3;a._referencePointUpdateDistThreshold=1E6;a._referencePosUpdateQuery=null;a._referencePosMapCoordsRequested=
null;a._viewHandles=new A;a._preserveAbsoluteDateTime=!1;a._trackingEnabled=!1;a._referencePosResetPreserveAbsoluteTime=!1;a.referencePosUpdateTimer=null;a._referencePosWGS84Comparable=null;a._referencePosMapCoords=null;a._mainLight=new p.MainLight;a._ambientLight=new p.AmbientLight;a._moonLight=new p.FillLight;a._renderer=null;a._resetReferencePosition();return a}f.__extends(d,e);d.prototype.destroy=function(){this.disconnectView();this._viewHandles.destroy()};Object.defineProperty(d.prototype,"updating",
{get:function(){return!!(!this.disableQueries&&(this._referencePosUpdateQuery||this._referencePosMapCoordsRequested)||this._renderer&&this._renderer.updating)},enumerable:!1,configurable:!0});d.prototype.connectView=function(a){var b=this;this._renderer||(this._view=a,this._renderer=new B({view:a}),this._viewHandles.add([a.watch("environment.lighting.date",function(a){return b._lightingDateHandler(a)},!0),a.watch("stationary",function(){return b._interactingStationaryHandler()}),a.watch(["environment.lighting.directShadowsEnabled",
"environment.lighting.ambientOcclusionEnabled","environment.lighting.waterReflectionEnabled","environment.background.color"],function(){return b._updateRenderParamsHandler()},!0),a.watch("spatialReference",function(){return b._resetReferencePosition(!0)},!0),m.init(a,"viewingMode",function(){return b._resetReferencePosition(!0)},!0),m.init(a,"environment.lighting.cameraTrackingEnabled",function(a){return b._updateCameraTracking(a)},!0),m.init(a,"state.camera",function(){return b._cameraHandler(null)},
!0),this.watch("disableQueries",function(){return b._cameraHandler(null)})]),this._updateRenderParamsHandler(),this._updateLightParams(),this._cameraHandler(),this.notifyChange("updating"))};d.prototype.disconnectView=function(){this._renderer&&(this._viewHandles.removeAll(),this._resetReferencePosition(),this._renderer.destroy(),this._view=this._renderer=null)};d.prototype._updateCameraTracking=function(a){if(this._trackingEnabled=a)this._cameraHandler();else if(a=this._view.environment.lighting)a.positionTimezoneInfo.autoUpdated=
!1};d.prototype._lightingDateHandler=function(a){if(a){var b=this._view.environment.lighting;if(!b.positionTimezoneInfo.autoUpdated){this._preserveAbsoluteDateTime=!0;if(!v.canProjectToWGS84ComparableLonLat(this._view.spatialReference)){var c=this._view.camera.position;if(!this._referencePosMapCoords||!this._referencePosMapCoords.equals(c)){this._requestReferencePositionUpdate(c);return}}this._preupdateTracking(a);this._referencePosWGS84Comparable&&(c=u.positionToTimezone(this._referencePosWGS84Comparable,
x),q.isSome(c)&&(b.autoUpdate(null,c),this._trackingEnabled&&(b.positionTimezoneInfo.autoUpdated=!0)))}this._updateLightParams(a)}};d.prototype._preupdateTracking=function(a){!this._trackingEnabled&&this._view.environment.lighting.cameraTrackingEnabled&&this._cameraHandler(a)};d.prototype._cameraHandler=function(a){void 0===a&&(a=null);if(this._view.ready){var b=this._view.camera;b&&(this._cameraHandlerClientSide(b,a)||this._cameraHandlerServerSide(b))}};d.prototype._cameraHandlerClientSide=function(a,
b){if(!v.canProjectToWGS84ComparableLonLat(this._view.spatialReference))return!1;a=a.position;this._referencePosWGS84Comparable||(this._referencePosWGS84Comparable=k.vec3f64.create());C.pointToWGS84ComparableLonLat(a,this._referencePosWGS84Comparable);this._autoUpdateTimezone(this._referencePosWGS84Comparable,b)||this._updateLightParams(b);return!0};d.prototype._cameraHandlerServerSide=function(a){a=a.position;(!this._referencePosMapCoords||this._referencePosMapCoordsRequested||this._exceedsReferencePosDistThreshold(a))&&
this._requestReferencePositionUpdate(a,!0);this._view.mapCoordsHelper&&this._referencePosWGS84Comparable&&(this._referencePosWGS84Comparable[2]=a.z*this._view.mapCoordsHelper.unitInMeters,this._referencePosChanged())};d.prototype._interactingStationaryHandler=function(){this._view.stationary&&this._executePendingReferencePositionUpdate()};d.prototype._updateLightParams=function(a){var b=this._view.environment.lighting;a=a||b.date;var b=this._view._stage,c;this._referencePosWGS84Comparable?(c=n.computeColorAndIntensity(a,
this._referencePosWGS84Comparable),n.computeDirection(a,this._referencePosWGS84Comparable,this._view.viewingMode,c.diffuse.direction)):c={diffuse:{color:[1,1,1],intensity:.55,direction:w},ambient:{color:[1,1,1],intensity:.55},noonFactor:.5,globalFactor:0};g.vec3.scale(this._mainLight.intensity,c.diffuse.color,c.diffuse.intensity*Math.PI);g.vec3.negate(this._mainLight.direction,c.diffuse.direction);g.vec3.scale(this._ambientLight.intensity,c.ambient.color,c.ambient.intensity);g.vec3.lerp(this._moonLight.intensity,
E,F,c.globalFactor);g.vec3.scale(this._moonLight.intensity,this._moonLight.intensity,(1-.5*c.globalFactor)*(1-.4*c.noonFactor*(1-c.globalFactor)));g.vec3.copy(this._moonLight.direction,c.diffuse.direction);b.setLighting({lights:[this._mainLight,this._ambientLight,this._moonLight],globalFactor:c.globalFactor,groundLightingFactor:1-c.noonFactor});this._updateRenderParamsHandler()};d.prototype._autoUpdateTimezone=function(a,b){void 0===b&&(b=null);if(!this._view.environment.lighting.cameraTrackingEnabled)return!1;
var c=G;c.setTime((b||this._view.environment.lighting.date).getTime());a=u.positionToTimezone(a,x);if(q.isNone(a))return!1;var d=this._view.environment.lighting.positionTimezoneInfo;if(!d.autoUpdated)d=a;else if(d.hours===a.hours&&d.minutes===a.minutes&&d.seconds===a.seconds)return!1;var e=c.getUTCHours()-(a.hours-d.hours),f=c.getUTCMinutes()-(a.minutes-d.minutes),d=c.getUTCSeconds()-(a.seconds-d.seconds);c.setUTCHours(e);c.setUTCMinutes(f);c.setUTCSeconds(d);return b?!1:this._view.environment.lighting.autoUpdate(c,
a)};d.prototype._updateRenderParamsHandler=function(){var a=this._view._stage;if(a){var b=this._referencePosWGS84Comparable?n.computeShadowsEnabled(this._referencePosWGS84Comparable,this._view.viewingMode):!0,c=this._view.environment.background,c=c instanceof D?{type:"color",color:t.vec4f64.fromArray(y.toUnitRGBA(c.color))}:{type:"color",color:t.vec4f64.fromValues(0,0,0,1)};a.renderView.setRenderParameters({shadowMap:this._view.environment.lighting.directShadowsEnabled&&b,ssao:this._view.environment.lighting.ambientOcclusionEnabled,
waterReflectionEnabled:this._view.environment.lighting.waterReflectionEnabled,background:c})}};d.prototype._resetReferencePosition=function(a){void 0===a&&(a=!1);var b=this._cancelReferencePosUpdates();this._referencePosWGS84Comparable=this._referencePosResetPreserveAbsoluteTime=this._referencePosMapCoordsRequested=this._referencePosMapCoords=null;this.notifyChange("updating");b&&a&&this._cameraHandler(null)};d.prototype._requestReferencePositionUpdate=function(a,b){var c=this;void 0===b&&(b=!1);
if(!this.disableQueries&&(this._referencePosMapCoordsRequested?this._referencePosMapCoordsRequested.copy(a):this._referencePosMapCoordsRequested=a.clone(),this._referencePosResetPreserveAbsoluteTime=!!b,!this._referencePosUpdateQuery&&!this.referencePosUpdateTimer&&this._view.stationary)){var d=this._referencePosUpdateQuery=r.after(this._referencePointUpdateDelay).then(function(){if(c._referencePosUpdateQuery===d)return c._doReferencePositionUpdateQuery(function(){return c._referencePosUpdateQuery!==
d})}).catch(function(a){"mapcoordshelper:missing-geometry-service"===a.name&&(c.disableQueries=!0)}).then(function(){c._referencePosUpdateQuery===d&&(c._referencePosUpdateQuery=null,c.referencePosUpdateTimer||c._executePendingReferencePositionUpdate(),c.notifyChange("updating"))}),e=this.referencePosUpdateTimer=r.after(this._referencePointUpdateInterval).then(function(){c.referencePosUpdateTimer===e&&(c.referencePosUpdateTimer=null,c._referencePosUpdateQuery||c._executePendingReferencePositionUpdate())});
this.notifyChange("updating")}};d.prototype._doReferencePositionUpdateQuery=function(a){return f.__awaiter(this,void 0,void 0,function(){var b,c;return f.__generator(this,function(d){switch(d.label){case 0:return this._referencePosResetPreserveAbsoluteTime&&(this._preserveAbsoluteDateTime=!1),this._referencePosMapCoords?this._referencePosMapCoords.copy(this._referencePosMapCoordsRequested):this._referencePosMapCoords=this._referencePosMapCoordsRequested.clone(),this._referencePosMapCoordsRequested=
this._referencePosResetPreserveAbsoluteTime=null,[4,this._view.mapCoordsHelper.toGeographic(this._referencePosMapCoords)];case 1:return b=d.sent(),a()||isNaN(b[0])||isNaN(b[1])||(c=this._referencePosMapCoords.z*this._view.mapCoordsHelper.unitInMeters,this._referencePosWGS84Comparable?(this._referencePosWGS84Comparable[0]=b[0],this._referencePosWGS84Comparable[1]=b[1],this._referencePosWGS84Comparable[2]=c):this._referencePosWGS84Comparable=[b[0],b[1],c],this._referencePosChanged()),[2]}})})};d.prototype._executePendingReferencePositionUpdate=
function(){var a=this._referencePosMapCoordsRequested;a&&this._requestReferencePositionUpdate(a,this._referencePosResetPreserveAbsoluteTime)};d.prototype._referencePosChanged=function(){this._preserveAbsoluteDateTime?this._updateLightParams():this._autoUpdateTimezone(this._referencePosWGS84Comparable)||this._updateLightParams()};d.prototype._exceedsReferencePosDistThreshold=function(a){return this._referencePosMapCoords?(a=this._referencePosMapCoords.distance(a),this._view.mapCoordsHelper&&(a*=this._view.mapCoordsHelper.unitInMeters),
a>this._referencePointUpdateDistThreshold):!0};d.prototype._cancelReferencePosUpdates=function(){var a=!!this._referencePosUpdateQuery;this.referencePosUpdateTimer=this._referencePosUpdateQuery=null;return a};Object.defineProperty(d.prototype,"test",{get:function(){var a=this;return{renderer:this._renderer,set referencePointUpdateInterval(b){a._referencePointUpdateInterval=b},set referencePointUpdateDistThreshold(b){a._referencePointUpdateDistThreshold=b},set referencePosUpdateTimer(b){a.referencePosUpdateTimer=
b},set referencePointUpdateDelay(b){a._referencePointUpdateDelay=b}}},enumerable:!1,configurable:!0});d.FIXED_LIGHT_DIRECTION=w;f.__decorate([h.property({type:Boolean,dependsOn:["disableQueries","_renderer.updating"],readOnly:!0})],d.prototype,"updating",null);f.__decorate([h.property()],d.prototype,"disableQueries",void 0);f.__decorate([h.property()],d.prototype,"_renderer",void 0);return d=f.__decorate([h.subclass("esri.views.3d.environment.SceneViewEnvironmentManager")],d)}(z.EventedAccessor);
e.SceneViewEnvironmentManager=l;var G=new Date,x={hours:0,minutes:0,seconds:0},E=k.vec3f64.fromValues(.22,.22,.33),F=k.vec3f64.fromValues(.22,.22,.22);e.default=l});