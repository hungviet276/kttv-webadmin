// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.17/esri/copyright.txt for details.
//>>built
define("require exports tslib ../../../../../core/Evented ../../../../../core/maybe ./config ./core ./jobs ./SymbolDeclutterer ./SymbolRepository ./util".split(" "),function(e,d,k,l,f,g,m,n,p,q,h){Object.defineProperty(d,"__esModule",{value:!0});d.SymbolFader=void 0;e=function(d){function c(b){var a=d.call(this)||this;a.layers=b;a._tileToHandle=new Map;a._viewState={scale:0,rotation:0,center:[0,0],size:[0,0]};a._declutterViewState={scale:0,rotation:0,center:[0,0],size:[0,0]};a._completed=!1;a._tileForest=
new h.TileForest;a._symbolRepository=new q.SymbolRepository(4096,a._tileForest,function(){return new m.VTLUniqueSymbol});a._symbolDeclutterer=new p.SymbolDeclutterer(a._tileForest,a._symbolRepository,function(b,c,d){return new n.CollisionJob(b,c,d,a.layers,a._zoom,a._viewState.rotation)},function(a,b){a.allSymbolsFadingOut=!0;a.lastOpacityUpdate=b;h.writeOpacityToBuffers(a,b,!0);a.decluttered=!0;a.requestRender()});return a}k.__extends(c,d);c.prototype.addTile=function(b){var a=this;this._tileForest.has(b)||
(b.decluttered=!1,this._tileForest.add(b),this._tileToHandle.set(b,b.on("symbols-changed",function(){a._symbolRepository.addTile(b,!1);a.restartDeclutter()})),this._symbolRepository.addTile(b),this.restartDeclutter())};c.prototype.removeTile=function(b){this._tileForest.has(b)&&(this._symbolRepository.removeTile(b),this.restartDeclutter(),this._tileToHandle.get(b).remove(),this._tileToHandle.delete(b),this._tileForest.remove(b))};c.prototype.update=function(b,a){this._zoom=b;this._viewState={scale:a.scale,
rotation:a.rotation,center:[a.center[0],a.center[1]],size:[a.size[0],a.size[1]]};this._continueDeclutter();return this._completed};c.prototype.restartDeclutter=function(){this._completed=!1;this._symbolDeclutterer.restart();this._notifyUnstable()};Object.defineProperty(c.prototype,"stale",{get:function(){return this._zoom!==this._declutterZoom||this._viewState.size[0]!==this._declutterViewState.size[0]||this._viewState.size[1]!==this._declutterViewState.size[1]||this._viewState.scale!==this._declutterViewState.scale||
this._viewState.rotation!==this._declutterViewState.rotation},enumerable:!1,configurable:!0});c.prototype._continueDeclutter=function(){if(!this._completed||this.stale)this._symbolDeclutterer.running||(this._declutterZoom=this._zoom,this._declutterViewState.center[0]=this._viewState.center[0],this._declutterViewState.center[1]=this._viewState.center[1],this._declutterViewState.rotation=this._viewState.rotation,this._declutterViewState.scale=this._viewState.scale,this._declutterViewState.size[0]=this._viewState.size[0],
this._declutterViewState.size[1]=this._viewState.size[1],this._symbolDeclutterer.restart()),this._symbolDeclutterer.setScreenSize(this._viewState.size[0],this._viewState.size[1]),(this._completed=this._symbolDeclutterer.continue(g.DECLUTTER_BUDGET))&&this._scheduleNotifyStable()};c.prototype._scheduleNotifyStable=function(){var b=this;f.isSome(this._stableNotificationHandle)&&clearTimeout(this._stableNotificationHandle);this._stableNotificationHandle=setTimeout(function(){b._stableNotificationHandle=
null;b.emit("fade-complete")},1.5*g.FADE_DURATION)};c.prototype._notifyUnstable=function(){f.isSome(this._stableNotificationHandle)&&(clearTimeout(this._stableNotificationHandle),this._stableNotificationHandle=null);this.emit("fade-start")};return c}(l);d.SymbolFader=e});