// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.17/esri/copyright.txt for details.
//>>built
define("require exports tslib ../../../Camera ../../../Viewpoint ../../../core/Accessor ../../../core/Handles ../../../core/Logger ../../../core/maybe ../../../core/scheduling ../../../core/screenUtils ../../../core/watchUtils ../../../core/accessorSupport/decorators ../../../core/libs/gl-matrix-2/vec4 ../../../core/libs/gl-matrix-2/vec4f64 ../../../geometry/Extent ../../../geometry/Point ../../../geometry/support/webMercatorUtils ../camera/constraintUtils ../camera/intersectionUtils ./ConstraintsManager ./Frustum ./GoToOperation ./controllers/SurfaceCollisionCorrectionController ../support/cameraUtils ../support/PropertiesPool ../support/viewpointUtils ../webgl-engine/lib/Camera".split(" "),
function(r,l,e,m,t,z,A,B,u,C,D,n,g,v,E,w,F,G,H,x,I,J,K,L,f,M,y,N){Object.defineProperty(l,"__esModule",{value:!0});l.ViewStateManager=void 0;var h=B.getLogger("esri.views.3d.state.ViewStateManager");r=function(l){function b(a){a=l.call(this,a)||this;a.propertiesPool=new M.default({frustum:J.default},a);a.handles=new A;a.cameraSetByUser=!1;a.internalSetOrder=[];a.gotoOperation=null;a.ready=!1;a.updateDevicePixelRatio=null;return a}e.__extends(b,l);Object.defineProperty(b.prototype,"camera",{get:function(){if(!this.ready)return this._get("camera");
var a=f.internalToExternal(this.view,this.view.state.camera),c=this._get("camera");return a&&c&&a.equals(c)?c:a},set:function(a){this.updatePropertyBeforeReady("camera",a)||this.setStateCamera(f.externalToInternal(this.view,a),{applyConstraints:!1})||h.error("#camera\x3d","Invalid camera",a)},enumerable:!1,configurable:!0});Object.defineProperty(b.prototype,"center",{get:function(){return this.ready?this.view.pointsOfInterest.centerOnContent.location:this._get("center")},set:function(a){this.updatePropertyBeforeReady("center",
a)||(a?this.isCompatible(a)?this.setStateCamera(this.centerToCamera(a),{applyConstraints:!0})?this.view.pointsOfInterest.centerOnContent.update():h.error("#center\x3d","Invalid center",a):h.error("#center\x3d","Center has an incompatible spatial reference (center: "+(a.spatialReference?a.spatialReference.wkid:"none")+", view: "+this.view.spatialReference.wkid+")",a):h.error("#center\x3d","Center may not be null or undefined"))},enumerable:!1,configurable:!0});Object.defineProperty(b.prototype,"extent",
{get:function(){return this.ready?f.toExtent(this.view,this.view.state.camera,this.view.pointsOfInterest.centerOnContent.renderLocation):this._get("extent")},set:function(a){this.updatePropertyBeforeReady("extent",a)||(a?this.isCompatible(a)?this.setStateCamera(this.extentToCamera(a),{applyConstraints:!0})||h.error("#extent\x3d","Invalid extent",a):h.error("#extent\x3d","Extent has an incompatible spatial reference (extent: "+(a.spatialReference?a.spatialReference.wkid:"none")+", view: "+this.view.spatialReference.wkid+
")",a):h.error("#extent\x3d","Extent may not be null or undefined"))},enumerable:!1,configurable:!0});Object.defineProperty(b.prototype,"frustum",{get:function(){var a=this.propertiesPool.get("frustum");a.renderCoordsHelper=this.view.renderCoordsHelper;a.update(this.view.state.camera);return a},enumerable:!1,configurable:!0});Object.defineProperty(b.prototype,"hasInitialView",{get:function(){return!!this.view.get("map.initialViewProperties.viewpoint")},enumerable:!1,configurable:!0});Object.defineProperty(b.prototype,
"scale",{get:function(){if(!this.ready)return this._get("scale");var a=this.view.pointsOfInterest.centerOnContent;return f.distanceToScale(this.view,a.distance,a.location.latitude)},set:function(a){this.updatePropertyBeforeReady("scale",a)||this.setStateCamera(this.scaleToCamera(a),{applyConstraints:!0})||h.error("#scale\x3d","Invalid scale",a)},enumerable:!1,configurable:!0});Object.defineProperty(b.prototype,"padding",{get:function(){if(!this.ready)return this._get("padding");var a=this.view.state.camera,
c=a.padding,d=a.pixelRatio,a=this._get("padding"),b=Math.round(c[0]/d),e=Math.round(c[1]/d),f=Math.round(c[2]/d),c=Math.round(c[3]/d);return null!=a&&a.top===b&&a.right===e&&a.bottom===f&&a.left===c?a:{top:b,right:e,bottom:f,left:c}},set:function(a){this.updatePropertyBeforeReady("padding",a)||(this.paddingToArray(a,this.view.state.camera.pixelRatio,p),this.view.state.updateCamera(function(a){return a.padding=p}))},enumerable:!1,configurable:!0});b.prototype.paddingToArray=function(a,c,d){a?v.vec4.set(d,
a.top||0,a.right||0,a.bottom||0,a.left||0):v.vec4.set(d,0,0,0,0);for(a=0;4>a;a++)d[a]=Math.round(d[a]*c)};Object.defineProperty(b.prototype,"screenCenter",{get:function(){var a=this.padding;return D.createScreenPoint((this.view.width-(a.left+a.right))/2+a.left,(this.view.height-(a.top+a.bottom))/2+a.top)},enumerable:!1,configurable:!0});Object.defineProperty(b.prototype,"viewpoint",{get:function(){return this.ready?y.fromCamera(this.view,this.camera):this._get("viewpoint")},set:function(a){if(!this.updatePropertyBeforeReady("viewpoint",
a))if(a)if(this.isCompatible(a))this.setStateCamera(this.viewpointToCamera(a),{applyConstraints:!a.camera})||h.error("#viewpoint\x3d","Invalid viewpoint",a);else{var c=a.camera?a.camera.position:a.targetGeometry,c=c&&c.spatialReference;h.error("#viewpoint\x3d","Viewpoint has an incompatible spatial reference (viewpoint: "+(c?c.wkid:"none")+", view: "+this.view.spatialReference.wkid+")",a)}else h.error("#viewpoint\x3d","Viewpoint may not be null or undefined")},enumerable:!1,configurable:!0});Object.defineProperty(b.prototype,
"zoom",{get:function(){return this.ready?f.scaleToZoom(this.view,this.scale):this._get("zoom")},set:function(a){this.updatePropertyBeforeReady("zoom",a)||this.setStateCamera(this.zoomToCamera(a),{applyConstraints:!0})||h.error("#zoom\x3d","Invalid zoom",a)},enumerable:!1,configurable:!0});b.prototype.initialize=function(){var a=this;this.handles.add([this.view.state.watch("camera",function(c){return a.cameraChangedSync(c)},!0),n.on(this.view,"state.events","before-camera-change",function(c){return a.updateElevation(c.camera)})]);
n.once(this.view.state,"camera",function(c){return a.updateElevation(c)},!0);this.handles.add(C.addFrameTask({prepare:function(){return a.prepareFrame()}}));this.handles.add(this.view.state.watch("cameraController",function(){a.cameraSetByUser=!0;a.handles.remove(q)}));this.handles.add(n.on(this.view,"state.events","camera-projection-changed",function(){return a.notifyChange("scale")}))};b.prototype.destroy=function(){this.deinit();this.handles&&(this.handles.destroy(),this.handles=null);this.propertiesPool&&
(this.propertiesPool.destroy(),this.propertiesPool=null)};b.prototype.init=function(){var a=this;this.constraintsManager=new I.default({view:this.view});this.prepareFrame();var c=this.getInitialProperties();this.cameraSetByUser=!1;this._set("ready",!0);for(var d=0;d<c.length;d++){var b=c[d];this.set(b.name,b.value)}this.cameraSetByUser||((c=this.view.get("map.initialViewProperties.viewpoint")||this.view.initialExtent)&&this.isCompatible(c)?this.setInitialView(c):2===this.view.state.mode&&this.handles.add(n.whenOnce(this.view.basemapTerrain,
"ready",function(){a.handles.remove(q);a.setInitialView(a.view.groundExtent)}),q))};b.prototype.deinit=function(){this.cancelGoToOperation();this.ready&&(this._override("padding",this.padding),this._set("ready",!1),this._clearOverride("hasInitialView"),this.internalSetOrder.length=0,this.cameraSetByUser=!1,this.handles.remove(q),this.constraintsManager&&(this.constraintsManager.destroy(),this.constraintsManager=null))};b.prototype.goTo=function(a,c){return e.__awaiter(this,void 0,void 0,function(){var b;
return e.__generator(this,function(d){b=e.__assign({animate:!0},c);this.gotoOperation=u.isSome(this.gotoOperation)?this.gotoOperation.goTo(a,b):new K.GoToOperation(a,b,this.view);return[2,this.gotoOperation]})})};b.prototype.debugSetCameraOnContent=function(){this.setStateCamera(x.cameraOnContentAlongViewDirection(this.view),{applyConstraints:!1})};b.prototype.step=function(a){var c=this.view.state,b=c&&this.view.state.cameraController;b&&(c.updateCamera(function(c){b.stepController(a,c)}),b.steppingFinished&&
b.finishController())};b.prototype.cancelGoToOperation=function(){u.isSome(this.gotoOperation)&&(this.gotoOperation.abort(),this.gotoOperation=null)};b.prototype.getInitialProperties=function(){for(var a=new Set,c=[],b=0,e=O;b<e.length;b++){var f=e[b],g=f.propertyName,f=f.overrides,h=a.has(g),k=this._isOverridden(g);!h&&k&&c.push({name:g,value:this._get(g)});this._clearOverride(g);(h||k)&&f.forEach(function(c){return a.add(c)})}return c};b.prototype.setInitialView=function(a){if(a&&!this.cameraSetByUser)if(a instanceof
m)this.setStateCamera(f.externalToInternal(this.view,a),{applyConstraints:!1});else if(a instanceof t)if(a.targetGeometry instanceof w){var c=f.fromExtent(this.view,a.targetGeometry,0,.5,0);this.setStateCamera(f.externalToInternal(this.view,c),{applyConstraints:!0})}else c={applyConstraints:!a.camera},a=this.viewpointToCamera(a),this.setStateCamera(a,c);else c=f.fromExtent(this.view,a,0,.5,0),this.setStateCamera(f.externalToInternal(this.view,c),{applyConstraints:!0})};b.prototype.updatePropertyBeforeReady=
function(a,c){if(!this.ready){this._override(a,c);var b=this.internalSetOrder.indexOf(a);-1!==b&&(this.internalSetOrder=this.internalSetOrder.splice(b,1));c&&(this.internalSetOrder.push(a),-1!==P.indexOf(a)&&this._override("hasInitialView",!0));return!0}return!1};b.prototype.isCompatible=function(a){return a?a instanceof t?a.camera?this.isCompatible(a.camera):this.isCompatible(a.targetGeometry):a instanceof m?this.isCompatible(a.position):a.spatialReference&&G.canProject(a.spatialReference,this.view.spatialReference):
!1};b.prototype.getPreservingHeadingTilt=function(a){void 0===a&&(a=Q);this.cameraSetByUser?(a.heading=this.camera.heading,a.tilt=this.camera.tilt):(a.heading=0,a.tilt=.5);return a};b.prototype.centerPointAtDistanceToCamera=function(a,c,b){void 0===b&&(b=k);var d=this.getPreservingHeadingTilt();return(a=f.getObserverForPointAtDistance(this.view,d.heading,d.tilt,a,c,1))?(b.copyFrom(this.view.state.camera),b.eye=a.eye,b.center=a.center,b.up=a.up,b):null};b.prototype.centerToCamera=function(a){var c=
this.view.pointsOfInterest.centerOnContent;c.update();return this.centerPointAtDistanceToCamera(a,c.distance)};b.prototype.extentToCamera=function(a){var c=this.getPreservingHeadingTilt();a=f.fromExtent(this.view,a,c.heading,c.tilt,1,R);return f.externalToInternal(this.view,a)};b.prototype.scaleToCamera=function(a){if(null==a)return null;var c=this.view.pointsOfInterest.centerOnContent;c.update();var b=c.renderLocation;a=f.scaleToDistance(this.view,a,c.location.latitude);return this.centerPointAtDistanceToCamera(b,
a)};b.prototype.zoomToCamera=function(a){return this.scaleToCamera(f.zoomToScale(this.view,a))};b.prototype.viewpointToCamera=function(a){return(a=y.toCamera(this.view,a))?f.externalToInternal(this.view,a):null};b.prototype.setStateCamera=function(a,c){var b=this;if(!a||!this.view.state.stopActiveCameraController())return!1;this.cameraSetByUser=!0;c.doNotCancelGoToOperation||this.cancelGoToOperation();this.view.state.updateCamera(function(d){c.positionAndOrientationOnly?(d.eye=a.eye,d.center=a.center,
d.up=a.up):d.copyFrom(a);c.applyConstraints&&H.applyAll(b.view,d)});c.applyConstraints||(this.view.state.cameraController=new L.SurfaceCollisionCorrectionController({view:this.view,desiredCamera:a}));return!0};b.prototype.prepareFrame=function(){var a=this.view,b=a.container,d=a.canvas;if(b&&d){u.isSome(this.updateDevicePixelRatio)&&this.updateDevicePixelRatio();var a=this.view.pixelRatio,e=Math.round(b.clientWidth*a),b=Math.round(b.clientHeight*a);if(0!==e&&0!==b){if(d.width!==e||d.height!==b)d.width=
e,d.height=b;this.view.state&&(d=this.view.state.camera,d.fullWidth!==e||d.fullHeight!==b||d.pixelRatio!==a)&&(k.copyFrom(d),k.pixelRatio!==a&&(this.paddingToArray(this.padding,a,p),k.padding=p),k.fullWidth=e,k.fullHeight=b,k.pixelRatio=a,this.view.state.camera=k)}}};b.prototype.updateElevation=function(a){var b=this.view.basemapTerrain&&this.view.basemapTerrain.spatialReference,d=this.view.renderCoordsHelper.getAltitude(a.eye),b=b?x.surfaceElevationBelowEye(this.view,a):0;a.relativeElevation=d-b};
b.prototype.cameraChangedSync=function(a){a&&this.view._stage&&this.view._stage.setCamera(a)};e.__decorate([g.property({type:m,dependsOn:["view.state.camera","ready"]})],b.prototype,"camera",null);e.__decorate([g.property({type:F,dependsOn:["view.pointsOfInterest.centerOnContent.location","ready"]})],b.prototype,"center",null);e.__decorate([g.property({type:w,dependsOn:["view.state.camera","ready","view.pointsOfInterest.centerOnContent.location"]})],b.prototype,"extent",null);e.__decorate([g.property({readOnly:!0,
dependsOn:["view.state.camera","ready"]})],b.prototype,"frustum",null);e.__decorate([g.property({readOnly:!0,dependsOn:["view.map.initialViewProperties?.viewpoint"]})],b.prototype,"hasInitialView",null);e.__decorate([g.property({readOnly:!0,type:Boolean})],b.prototype,"ready",void 0);e.__decorate([g.property({dependsOn:["view.pointsOfInterest.centerOnContent.distance","ready"],type:Number})],b.prototype,"scale",null);e.__decorate([g.property({dependsOn:["view.state.camera","ready"]})],b.prototype,
"padding",null);e.__decorate([g.property({readOnly:!0,dependsOn:["view.width","view.height","padding"]})],b.prototype,"screenCenter",null);e.__decorate([g.property({constructOnly:!0})],b.prototype,"view",void 0);e.__decorate([g.property({type:t,dependsOn:["camera","ready"]})],b.prototype,"viewpoint",null);e.__decorate([g.property({type:Number,dependsOn:["scale"]})],b.prototype,"zoom",null);e.__decorate([g.property({constructOnly:!0})],b.prototype,"updateDevicePixelRatio",void 0);return b=e.__decorate([g.subclass("esri.views.3d.state.ViewStateManager")],
b)}(z);l.ViewStateManager=r;var P="camera viewpoint extent scale center zoom".split(" "),O=[{propertyName:"camera",overrides:["viewpoint"]},{propertyName:"viewpoint",overrides:["extent"]},{propertyName:"extent",overrides:["center","scale"]},{propertyName:"center",overrides:[]},{propertyName:"scale",overrides:["zoom"]},{propertyName:"zoom",overrides:[]},{propertyName:"padding",overrides:[]}],Q={heading:0,tilt:0},R=new m,k=new N.default,p=E.vec4f64.create(),q="pending-initial-view";l.default=r});