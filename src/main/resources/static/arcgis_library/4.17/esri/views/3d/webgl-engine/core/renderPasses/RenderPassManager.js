// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.17/esri/copyright.txt for details.
//>>built
define("require exports ../../../../../core/maybe ../../../../../core/libs/gl-matrix-2/mat3 ../../../../../core/libs/gl-matrix-2/mat3f64 ../../../../../core/libs/gl-matrix-2/mat4 ../../../../../core/libs/gl-matrix-2/vec2 ../../../../../core/libs/gl-matrix-2/vec3 ../../../../../core/libs/gl-matrix-2/vec3f64 ../../../../../core/libs/gl-matrix-2/vec4 ../../../support/geometryUtils ./AllRenderPasses ./RenderPass ../util/TwoVectorPosition ../../lib/depthRange".split(" "),function(p,h,k,l,t,u,q,f,v,w,x,
m,d,y,z){Object.defineProperty(h,"__esModule",{value:!0});h.RenderPassManager=void 0;p=function(){function b(a,c){this.rctx=a;this.shaderTechniqueRepository=c;this.canRender=!0;this._materialPassParams=new m.MaterialPassesParameters;this._shadowPassParams=new m.ShadowMapPassParameters;this._highlightPassParams=new m.HighlightPassParameters;this._systems=new Set;this._passes=[];this._shadowMapPass=this._registerPass(new d.RenderPass(a,this.shaderTechniqueRepository));this.passes={materialOpaque:this._registerPass(new d.RenderPass(a,
this.shaderTechniqueRepository)),materialTransparent:this._registerPass(new d.RenderPass(a,this.shaderTechniqueRepository,1)),materialIntegratedMesh:this._registerPass(new d.RenderPass(a,this.shaderTechniqueRepository)),shadowMap:this._shadowMapPass,highlight:this._registerPass(new d.RenderPass(a,this.shaderTechniqueRepository)),highlightIntegratedMesh:this._registerPass(new d.RenderPass(a,this.shaderTechniqueRepository))}}b.prototype.register=function(a){this._systems.add(a)};b.prototype.prepareRender=
function(a){var c=this;this._passes.forEach(function(a){return a.prepareSubmit()});this._systems.forEach(function(e){e.submit(c.passes,{camera:a})});this._passes.forEach(function(a){return a.finishSubmit()});this.shaderTechniqueRepository.frameUpdate()};b.prototype.render=function(a){if(4===a.slot)switch(this._configure(a),a.pass){case 0:this._materialPassParams.subPass=0;this._configureMaterialColorPass(a);this.passes.materialOpaque.dispatch(this._materialPassParams);break;case 1:this._materialPassParams.subPass=
1;this.passes.materialOpaque.dispatch(this._materialPassParams);break;case 2:this._materialPassParams.subPass=2;this.passes.materialOpaque.dispatch(this._materialPassParams);break;case 4:this.passes.highlight.dispatch(this._highlightPassParams);break;case 3:this._shadowMapPass.dispatch(this._shadowPassParams)}if(6===a.slot)switch(this._configure(a),a.pass){case 0:this._materialPassParams.subPass=0;this._configureMaterialColorPass(a);this.passes.materialTransparent.dispatch(this._materialPassParams);
break;case 1:this._materialPassParams.subPass=1;this.passes.materialTransparent.dispatch(this._materialPassParams);break;case 2:this._materialPassParams.subPass=2,this.passes.materialTransparent.dispatch(this._materialPassParams)}if(1===a.slot)switch(this._configure(a),a.pass){case 0:this._materialPassParams.subPass=0;this._configureMaterialColorPass(a);this._materialPassParams.ssrParams=a.ssrParams;this.passes.materialIntegratedMesh.dispatch(this._materialPassParams);break;case 1:this._materialPassParams.subPass=
1;this.passes.materialIntegratedMesh.dispatch(this._materialPassParams);break;case 2:this._materialPassParams.subPass=2;this.passes.materialIntegratedMesh.dispatch(this._materialPassParams);break;case 4:this.passes.highlightIntegratedMesh.dispatch(this._highlightPassParams)}return!0};b.prototype.notifyDirty=function(){this.initContext.requestRender()};b.prototype.slots=function(){return[4,6,1]};b.prototype.initializeRenderContext=function(a){this.initContext=a};b.prototype.uninitializeRenderContext=
function(){};b.prototype.queryDepthRange=function(a){var c={near:Infinity,far:-Infinity};this._systems.forEach(function(e){e=e.queryShadowCasterDepthRange(a);k.isSome(e)&&z.union(c,e,c)});return c};Object.defineProperty(b.prototype,"shadowCastingEnabled",{get:function(){return k.isSome(this.passes.shadowMap)},set:function(a){a?(this._materialPassParams.shadowsEnabled=!0,this.passes.shadowMap=this._shadowMapPass):(this._materialPassParams.shadowsEnabled=!1,this.passes.shadowMap=null)},enumerable:!1,
configurable:!0});Object.defineProperty(b.prototype,"screenSpaceReflectionsEnabled",{get:function(){return k.isSome(this._materialPassParams.ssrParams.ssrEnabled)},set:function(a){this._materialPassParams.ssrParams.ssrEnabled=a?!0:!1},enumerable:!1,configurable:!0});b.prototype._configureMaterialColorPass=function(a){var c=this;this._materialPassParams.shadowMap={bind:function(e,b){a.shadowMap.bind(e,b);b=c._materialPassParams.viewTransform;f.vec3.add(g,b.worldFromView_TL,b.worldFromView_TH);a.shadowMap.bindView(e,
g)}};this._materialPassParams.ambientOcclusion={bind:function(c,b){a.ssaoHelper.setUniforms(c,b)}};this._materialPassParams.ambientOcclusionEnabled=a.ssaoHelper.enabled;this._materialPassParams.sceneHasOcludees=a.hasOccludees};b.prototype._configure=function(a){this._updateParameters(a,3===a.pass?this._shadowPassParams:4===a.pass?this._highlightPassParams:this._materialPassParams)};b.prototype._updateParameters=function(a,c){var b=a.camera,d=b.viewInverseTransposeMatrix;f.vec3.set(g,d[3],d[7],d[11]);
n.set(g);f.vec3.copy(c.viewTransform.worldFromView_TH,n.high);f.vec3.copy(c.viewTransform.worldFromView_TL,n.low);l.mat3.fromMat4(c.viewTransform.viewFromCameraRelative_RS,b.viewMatrix);u.mat4.copy(c.viewTransform.projFromView,b.projectionMatrix);0===c.identifier?(this._materialPassParams.transparent=6===a.slot,this._materialPassParams.integratedMesh=1===a.slot,this._materialPassParams.lighting=a.scenelightingData,l.mat3.transpose(r,c.viewTransform.viewFromCameraRelative_RS),l.mat3.invert(c.transformNormal_ViewFromGlobal,
r),q.vec2.set(c.cameraNearFar,b.near,b.far)):1===c.identifier?q.vec2.set(c.cameraNearFar,b.near,b.far):2===c.identifier&&(c.highlightDepthTexture=a.highlightDepthTexture,w.vec4.copy(c.viewport,b.fullViewport),c.inverseViewport[0]=1/b.fullViewport[2],c.inverseViewport[1]=1/b.fullViewport[3]);x.boundedPlane.copy(a.sliceHelper.plane,c.slicePlane);f.vec3.subtract(c.slicePlane.origin,c.slicePlane.origin,g);c.slicePlaneEnabled=a.sliceHelper.isEnabled;this._materialPassParams.transparencyPassType=a.transparencyPassType};
b.prototype._registerPass=function(a){this._passes.push(a);return a};Object.defineProperty(b.prototype,"needsHighlight",{get:function(){return 0<this.passes.highlight.count||0<this.passes.highlightIntegratedMesh.count},enumerable:!1,configurable:!0});return b}();h.RenderPassManager=p;var g=v.vec3f64.create(),r=t.mat3f64.create(),n=new y.TwoVectorPosition});