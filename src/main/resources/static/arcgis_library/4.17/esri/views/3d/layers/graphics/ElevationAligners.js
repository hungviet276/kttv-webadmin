// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.17/esri/copyright.txt for details.
//>>built
define("require exports ../../../../core/maybe ../../../../core/libs/gl-matrix-2/mat4 ../../../../core/libs/gl-matrix-2/mat4f64 ../../../../core/libs/gl-matrix-2/vec3 ../../../../core/libs/gl-matrix-2/vec3f64 ../../../../geometry/Point ./elevationAlignmentUtils ./graphicUtils ../support/uvUtils ../../support/debugFlags ../../support/projectionUtils ../../support/buffer/BufferView ../../webgl-engine/lib/Util".split(" "),function(S,l,K,L,w,x,f,M,D,N,O,E,H,y,P){Object.defineProperty(l,"__esModule",{value:!0});
l.iterativeUpdatesEnabled=l.updateThresholdInMeters=l.perLodInstanceElevationAligner=l.perObjectElevationAligner=l.perVertexElevationAligner=void 0;var u=P.VertexAttrConstants;l.perVertexElevationAligner=function(d,a,b,c){d=d.stageObject;z.spatialReference=b.spatialReference;for(var g=d.geometryRecords,t=g.length,n="absolute-height"!==a.mode,I=0,r=0;r<t;r++){var p=g[r].geometry,e=g[r].getShaderTransformation();m[0]=e[12];m[1]=e[13];m[2]=e[14];p.invalidateBoundingInfo();for(var p=p.data.getVertexAttr(),
A=p[u.POSITION],e=A.data,B=p.mapPos.data,f=A.size,A=e.length/f,h=0,F=0,G=!1,w=0,x=0;x<A;x++){z.x=B[F++];z.y=B[F++];z.z=B[F++];v[0]=e[h];v[1]=e[h+1];v[2]=e[h+2];var C=D.evaluateElevationAlignmentAtPoint(z,b,a,c,n?q:null);n&&(w+=q.sampledElevation);k[0]=e[h]+m[0];k[1]=e[h+1]+m[1];k[2]=e[h+2]+m[2];c.setAltitude(C,k);e[h]=k[0]-m[0];e[h+1]=k[1]-m[1];e[h+2]=k[2]-m[2];if(E.TESTS_DISABLE_UPDATE_THRESHOLDS)G=!0;else if(C=l.updateThresholdInMeters/c.unitInMeters,Math.abs(v[0]-e[h])>=C||Math.abs(v[1]-e[h+1])>=
C||Math.abs(v[2]-e[h+2])>=C)G=!0;h+=f}p[u.BOUND1]&&(B=p[u.BOUND1].data,f=p[u.BOUND2].data,h=p[u.BOUND3].data,O.createMapSpaceUVCoords(y.BufferViewVec4f.fromTypedArray(p[u.UVMAPSPACE].data),y.BufferViewVec3f64.fromTypedArray(e),c,y.BufferViewVec3f64.fromTypedArray(B),y.BufferViewVec3f64.fromTypedArray(f),y.BufferViewVec3f64.fromTypedArray(h)));I+=w/A;G&&d.geometryVertexAttrsUpdated(r)}return I/t};l.perObjectElevationAligner=function(d,a,b,c){d=d.stageObject;var g=a.centerPointInElevationSR,t=0,n=0;
if(d.metadata.usesVerticalDistanceToGround)t=D.evaluateElevationAlignmentAtPoint(g,b,a,c,q),N.updateVertexAttributeAuxpos1w(d,q.verticalDistanceToGround),n=q.sampledElevation;else{var f="absolute-height"!==a.mode,t=D.evaluateElevationAlignmentAtPoint(g,b,a,c,f?q:null);f&&(n=q.sampledElevation)}a=L.mat4.copy(Q,d.objectTransformation);b=x.vec3.set(J,a[12],a[13],a[14]);E.DISABLE_ELEVATION_ALIGNERS_ITERATIVE_UPDATES?(k[0]=g.x,k[1]=g.y,k[2]=t,H.computeLinearTransformation(g.spatialReference,k,a,c.spatialReference)&&
(d.objectTransformation=a)):c.setAltitudeOfTransformation(t,a);c=l.updateThresholdInMeters/c.unitInMeters;if(Math.abs(a[12]-b[0])>=c||Math.abs(a[13]-b[1])>=c||Math.abs(a[14]-b[2])>=c)d.objectTransformation=a;return n};var Q=w.mat4f64.create();l.perLodInstanceElevationAligner=function(d,a,b,c){var g=d.graphics3DSymbolLayer.lodRenderer;if(K.isNone(g))return 0;var f=a.centerPointInElevationSR,n=0,m=0,r="absolute-height"!==a.mode,n=D.evaluateElevationAlignmentAtPoint(f,b,a,c,r?q:null);r&&(m=q.sampledElevation);
a=g.instanceData;d=d.instanceIndex;b=R;a.getGlobalTransform(d,b);g=x.vec3.set(J,b[12],b[13],b[14]);E.DISABLE_ELEVATION_ALIGNERS_ITERATIVE_UPDATES?(k[0]=f.x,k[1]=f.y,k[2]=n,H.computeLinearTransformation(f.spatialReference,k,b,c.spatialReference)&&a.setGlobalTransform(d,b)):c.setAltitudeOfTransformation(n,b);c=l.updateThresholdInMeters/c.unitInMeters;(Math.abs(b[12]-g[0])>=c||Math.abs(b[13]-g[1])>=c||Math.abs(b[14]-g[2])>=c)&&a.setGlobalTransform(d,b);return m};l.updateThresholdInMeters=.01;l.iterativeUpdatesEnabled=
!0;var z=new M,k=f.vec3f64.create(),m=f.vec3f64.create(),v=f.vec3f64.create(),R=w.mat4f64.create(),J=f.vec3f64.create(),q={verticalDistanceToGround:0,sampledElevation:0}});