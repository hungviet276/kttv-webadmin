// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.17/esri/copyright.txt for details.
//>>built
define("require exports tslib ../../../../core/asyncUtils ../../../../core/maybe ../../../../core/ObjectPool ../../../../core/libs/gl-matrix-2/vec2 ../../../../core/libs/gl-matrix-2/vec2f64 ../../../../core/libs/gl-matrix-2/vec3 ../../../../core/libs/gl-matrix-2/vec3f64 ../../../../geometry/Polygon ../../../../geometry/support/aaBoundingBox ../../../../geometry/support/aaBoundingRect ../../../../layers/graphics/dehydratedFeatures ../../../../layers/graphics/featureConversionUtils ./featureExpressionInfoUtils ../../support/projectionUtils".split(" "),
function(E,F,k,v,g,w,x,y,r,t,z,l,p,q,A,B,C){var u=new w(Array,function(c){return l.set(c,l.ZERO)},null,10,5),D=p.create();return function(){function c(a,b,d,c,e){this._labelGraphics=[];this._auxiliaryGraphics=[];for(var h=Array(2),f=0;f<h.length;f++)h[f]=Array(4);this._visibilityFlags=h;this._featureExpressionFeature=null;this._optimizedGeometry={geometry:null,hasZ:!1,hasM:!1};this._extent=null;this.isElevationSource=!1;++b.referenced;this.graphics3DSymbol=b;this.graphic=a;this._graphics=d;this._featureExpressionFeature=
e?B.createFeature(e,a,c):null;a=0;for(b=this._graphics;a<b.length;a++)d=b[a],g.isSome(d)&&(this.isElevationSource=this.isElevationSource||d.isElevationSource)}Object.defineProperty(c.prototype,"labelGraphics",{get:function(){return this._labelGraphics},enumerable:!1,configurable:!0});Object.defineProperty(c.prototype,"extent",{get:function(){return this._extent},enumerable:!1,configurable:!0});c.prototype.initialize=function(a,b,d){var c=this;this._layer=b;this._stage=a;this.forEachSymbolLayerGraphic(function(e){e.initialize(a,
b,d);e.setVisibility(c.isVisible())})};c.prototype.destroy=function(){this.forEachSymbolLayerGraphic(function(a){return a.destroy()});this._auxiliaryGraphics=this._graphics=null;--this.graphics3DSymbol.referenced;this.graphics3DSymbol=null};Object.defineProperty(c.prototype,"destroyed",{get:function(){return null==this._graphics},enumerable:!1,configurable:!0});c.prototype.clearLabelGraphics=function(){this.forEachLabelGraphic(function(a){return a.destroy()});this._labelGraphics.length=0};c.prototype.addLabelGraphic=
function(a,b,d){this._labelGraphics.push(a);a.initialize(b,d);a.setVisibility(this.isVisible(1))};c.prototype.addAuxiliaryGraphic=function(a){this._auxiliaryGraphics.push(a);this._layer&&(a.initialize(this._stage,this._layer),a.setVisibility(this.isVisible()))};Object.defineProperty(c.prototype,"isDraped",{get:function(){var a=!1;this.forEachSymbolLayerGraphic(function(b){"draped"===b.type&&(a=!0)});return a},enumerable:!1,configurable:!0});c.prototype.isVisible=function(a,b){void 0===a&&(a=0);for(var d=
0;d<=a;d++)for(var c=this._visibilityFlags[d],e=0;e<c.length;++e)if(!1===c[e]&&e!==b)return!1;return!0};c.prototype.hasVisibilityFlag=function(a,b){return null!=this._visibilityFlags[b][a]};c.prototype.setVisibilityFlag=function(a,b,d){var c=this.isVisible(d);this._visibilityFlags[d][a]=b;var e=this.isVisible(d);if(c===e)return!1;if(1===d)this.forEachLabelGraphic(function(a){return a.setVisibility(e)});else{this.forEachSymbolLayerGraphic(function(a){return a.setVisibility(e)});var g=this.isVisible(1);
this.forEachLabelGraphic(function(a){return a.setVisibility(g)})}return!0};c.prototype.clearVisibilityFlag=function(a,b){void 0===b&&(b=0);return this.setVisibilityFlag(a,void 0,b)};c.prototype.getBSRadius=function(){var a=0;this.forEachSymbolLayerGraphic(function(b){a=Math.max(a,b.getBSRadius())});return a};c.prototype.getCenterObjectSpace=function(a){void 0===a&&(a=t.vec3f64.create());if(0===this._graphics.length)return r.vec3.set(a,0,0,0),a;var b=this._graphics[0];return g.isSome(b)?b.getCenterObjectSpace(a):
a};c.prototype.computeExtent=function(a){if(!this._extent){var b=this.graphic.geometry;if(g.isNone(b))return!1;this._extent=p.create();q.computeAABR(b,this._extent);b=b.spatialReference;if(!b.equals(a)&&!C.boundingRectToBoundingRect(this._extent,b,this._extent,a))return this._extent=null,!1}return!0};c.prototype.getAsOptimizedGeometry=function(a,b){if(this._optimizedGeometry.geometry&&this._optimizedGeometry.hasZ===a&&this._optimizedGeometry.hasM===b)return this._optimizedGeometry.geometry;this._optimizedGeometry.geometry=
this._convertGraphicToOptimizedGeometry(this.graphic,a,b);this._optimizedGeometry.hasZ=a;this._optimizedGeometry.hasM=b;return this._optimizedGeometry.geometry};c.prototype._convertGraphicToOptimizedGeometry=function(a,b,d){a=a.geometry;if("mesh"===a.type||"extent"===a.type)a=z.fromExtent("mesh"===a.type?a.extent:a);return A.convertFromGeometry(a,b,d)};Object.defineProperty(c.prototype,"usedMemory",{get:function(){var a=this,b=q.estimateAttributesObjectSize(this.graphic.attributes);this.forEachSymbolLayerGraphic(function(d){var c=
d.graphics3DSymbolLayer.complexity;g.isNone(c)||(d="draped"===d.type?c.memory.draped:c.memory,b+=d.bytesPerFeature,d.bytesPerCoordinate&&(b+=q.numVertices(a.graphic.geometry)*d.bytesPerCoordinate))});return b},enumerable:!1,configurable:!0});c.prototype.computeAttachmentOrigin=function(){for(var a={render:{origin:t.vec3f64.create(),num:0},draped:{origin:y.vec2f64.create(),num:0}},b=0,c=this._graphics;b<c.length;b++){var h=c[b];g.isNone(h)||h.computeAttachmentOrigin(a)}a.render.num&&r.vec3.scale(a.render.origin,
a.render.origin,1/a.render.num);a.draped.num&&x.vec2.scale(a.draped.origin,a.draped.origin,1/a.draped.num);return a};c.prototype.getProjectedBoundingBox=function(a,b,c,h,e){return k.__awaiter(this,void 0,void 0,function(){var d=this;return k.__generator(this,function(f){switch(f.label){case 0:return e||(e={boundingBox:null,requiresDrapedElevation:!1,screenSpaceObjects:[]}),e.boundingBox?l.empty(e.boundingBox):e.boundingBox=l.empty(),e.requiresDrapedElevation=!1,[4,v.forEach(this._graphics,function(f){return k.__awaiter(d,
void 0,void 0,function(){var d,m,n;return k.__generator(this,function(k){switch(k.label){case 0:if(g.isNone(f))return[2];d="draped"===f.type?b:a;m=u.acquire();return[4,f.getProjectedBoundingBox(d,c,e.screenSpaceObjects,h,m)];case 1:return n=k.sent(),isFinite(n[2])&&isFinite(n[5])||(e.requiresDrapedElevation=!0),n&&l.expand(e.boundingBox,m),u.release(m),[2]}})})})];case 1:return f.sent(),l.allFinite(e.boundingBox)||p.allFinite(l.toRect(e.boundingBox,D))?[2,e]:[2,null]}})})};c.prototype.needsElevationUpdates=
function(){for(var a=0,b=this._graphics;a<b.length;a++){var c=b[a];if(g.isSome(c)&&("object3d"===c.type||"lod-instance"===c.type)&&c.needsElevationUpdates)return!0}a=0;for(b=this._labelGraphics;a<b.length;a++)if((c=b[a])&&c.needsElevationUpdates)return!0;return!1};c.prototype.alignWithElevation=function(a,b,c){var d=this;this.forEachRenderedGraphic(function(e){"object3d"!==e.type&&"lod-instance"!==e.type||e.alignWithElevation(a,b,d._featureExpressionFeature,c)})};c.prototype.addObjectStateSet=function(a,
b){this.forEachSymbolLayerGraphic(function(c){return c.addObjectState(a,b)})};c.prototype.removeObjectState=function(a){this.forEachSymbolLayerGraphic(function(b){return b.removeObjectState(a)})};c.prototype.forEachGraphicList=function(a,b){a.forEach(function(a){return a&&b(a)})};c.prototype.forEachSymbolLayerGraphic=function(a){this.forEachGraphicList(this._graphics,a);this.forEachGraphicList(this._auxiliaryGraphics,a)};c.prototype.forEachLabelGraphic=function(a){this.forEachGraphicList(this._labelGraphics,
a)};c.prototype.forEachRenderedGraphic=function(a){this.forEachSymbolLayerGraphic(a);this.forEachLabelGraphic(a)};return c}()});