// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.17/esri/copyright.txt for details.
//>>built
define("require exports tslib ../../../../../geometry ../../../../../core/Handles ../../../../../core/screenUtils ../../../../../core/watchUtils ../../../../../core/accessorSupport/decorators ../../../../../layers/graphics/hydratedFeatures ../../editingTools/dragEventPipeline3D ./DirectLineMeasurement3DModel ./DirectLineMeasurement3DView ../../../../interactive/dragEventPipeline ../../../../interactive/InteractiveToolBase".split(" "),function(f,v,c,m,n,h,p,e,q,k,r,g,l,t){f=function(f){function a(d){var b=
f.call(this,d)||this;b._handles=new n;b._cachedPickRequest=new g.PickRequest;b._cachedPickResult=new g.PickResult;b._isAnyPointerDown=!1;b.deferCreation=!0;b.startManipulator=null;b.endManipulator=null;b.model=new r({sceneView:d.view});return b}c.__extends(a,f);a.prototype.initialize=function(){var d=this;this._view=new g(this.model);var b=p.init(this,"state",function(a){"ready"!==a&&d.create();"measured"===a&&d.complete()},!0);this._handles.add(b);var b=this._view.createManipulators(),a=b.start,
c=b.end,b=function(a,b,c){return l.createManipulatorDragEventPipeline(a,function(a,e,f){var g=k.hideManipulatorWhileDragging(a);e.next(g).next(k.screenToMap3D(d.view)).next(function(a){return"start"!==a.action?a:null}).next(function(e){var f=q.clonePoint(e.mapEnd,u);d.model[b]=f;a.location=f;d.model[c]=d._surfaceLocation(f,e.surfaceType)});f.next(g).next(l.resetProperties(d.model,[b,c])).next(function(){a.location=d.model[b]})})};this._handles.add([b(a,"startPoint","startPointSurfaceLocation"),b(c,
"endPoint","endPointSurfaceLocation")]);[a,c].forEach(function(b){d._handles.add([b.events.on("grab-changed",function(){var b=a.grabbing||c.grabbing;b&&"measured"===d.model.state&&(d.model.state="editing");b||(d.model.finishMeasurement(),"editing"===d.model.state&&(d.model.state="measured"))})])});this.manipulators.add(a);this.manipulators.add(c);this.startManipulator=a;this.endManipulator=c};a.prototype.destroy=function(){this._view.destroy();this._view=null;this._handles.destroy();this._handles=
null};Object.defineProperty(a.prototype,"state",{get:function(){return this.model.isMeasuring?"measured"===this.model.state?"measured":"measuring":"ready"},enumerable:!1,configurable:!0});Object.defineProperty(a.prototype,"creating",{get:function(){return"initial"===this.model.state||"drawing"===this.model.state},enumerable:!1,configurable:!0});Object.defineProperty(a.prototype,"isSupported",{get:function(){return"3d"===this.get("view.type")},enumerable:!1,configurable:!0});Object.defineProperty(a.prototype,
"cursor",{get:function(){return!this.model.active||"drawing"!==this.model.state&&"initial"!==this.model.state?null:"crosshair"},enumerable:!1,configurable:!0});a.prototype.activate=function(){this.model.active=!0};a.prototype.deactivate=function(){this.model.active=!1};a.prototype.onDetach=function(){this.model.reset()};a.prototype.onShow=function(){this._view.show();this._updateManipulatorVisibility()};a.prototype.onHide=function(){this._view.hide()};a.prototype.onInputEvent=function(a){switch(a.type){case "immediate-click":this._handleImmediateClick(a);
break;case "pointer-move":this._handlePointerMove(a);break;case "pointer-down":this._handlePointerDown();break;case "pointer-up":this._handlePointerUp()}this._updateManipulatorVisibility()};a.prototype._handlePointerMove=function(a){this._clearCachedPickRequest();var b=h.createScreenPointFromEvent(a);"mouse"===a.pointerType&&(this._hoverAt(b),"drawing"===this.model.state&&(this.endManipulator.events.emit("drag",{action:"update",start:b,screenPoint:b}),a.stopPropagation()))};a.prototype._handlePointerDown=
function(){this._isAnyPointerDown=!0};a.prototype._handlePointerUp=function(){this._isAnyPointerDown=!1};a.prototype._handleImmediateClick=function(a){this._clearCachedPickRequest();if("mouse"!==a.pointerType||0===a.button){var b=h.createScreenPointFromEvent(a),d=!1;if(this.model.active)switch(this.model.state){case "initial":this.startManipulator.events.emit("drag",{action:"start",start:b,screenPoint:b});this.startManipulator.events.emit("drag",{action:"end",start:b,screenPoint:b});this.model.startPoint&&
(this.startManipulator.interactive=!1,this.endManipulator.interactive=!1,this.model.state="drawing",this.endManipulator.events.emit("drag",{action:"start",start:b,screenPoint:b}),d=!0);break;case "drawing":this.endManipulator.events.emit("drag",{action:"update",start:b,screenPoint:b}),null!=this.model.endPoint&&(this.endManipulator.events.emit("drag",{action:"end",start:b,screenPoint:b}),this.startManipulator.interactive=!0,this.endManipulator.interactive=!0,this.model.finishMeasurement(),d=!0)}d&&
a.stopPropagation();"mouse"===a.pointerType&&this._hoverAt(b)}};a.prototype._hoverAt=function(a){var b=this._isAnyPointerDown&&"drawing"!==this.model.state&&"editing"!==this.model.state;this._view.requiresCursorPoint&&!b?(a=this._pick(a),a.mapPoint&&(this.model.cursorPoint=a.mapPoint)):this.model.cursorPoint=null};a.prototype._pick=function(a){var b=this._cachedPickRequest.screenPoint;if(b&&b.x===a.x&&b.y===a.y)return this._cachedPickResult;this._cachedPickRequest.screenPoint=a;return this._cachedPickResult=
this._view.pick(this._cachedPickRequest)};a.prototype._clearCachedPickRequest=function(){this._cachedPickRequest.screenPoint=null};a.prototype._surfaceLocation=function(a,b){return 0===b?"on-the-surface":a.z>=this._view.getElevation(a)?"above-the-surface":"below-the-surface"};a.prototype._updateManipulatorVisibility=function(){this.startManipulator.available=null!=this.model.startPoint;this.endManipulator.available=null!=this.model.endPoint};c.__decorate([e.property({dependsOn:["model.isMeasuring",
"model.state"],readOnly:!0})],a.prototype,"state",null);c.__decorate([e.property({dependsOn:["model.state"],readOnly:!0})],a.prototype,"creating",null);c.__decorate([e.property({dependsOn:["view.type"],readOnly:!0})],a.prototype,"isSupported",null);c.__decorate([e.property({dependsOn:["model.active","model.state"],readOnly:!0})],a.prototype,"cursor",null);c.__decorate([e.property({constructOnly:!0})],a.prototype,"model",void 0);c.__decorate([e.aliasOf("model.mode")],a.prototype,"mode",void 0);c.__decorate([e.aliasOf("model.unit")],
a.prototype,"unit",void 0);c.__decorate([e.aliasOf("model.directDistance")],a.prototype,"directDistance",void 0);c.__decorate([e.aliasOf("model.validMeasurement")],a.prototype,"validMeasurement",void 0);c.__decorate([e.aliasOf("model.horizontalDistance")],a.prototype,"horizontalDistance",void 0);c.__decorate([e.aliasOf("model.verticalDistance")],a.prototype,"verticalDistance",void 0);c.__decorate([e.aliasOf("model.geodesicDistance")],a.prototype,"geodesicDistance",void 0);c.__decorate([e.aliasOf("model.geodesicAngle")],
a.prototype,"geodesicAngle",void 0);c.__decorate([e.aliasOf("model.triangleView")],a.prototype,"triangleView",void 0);return a=c.__decorate([e.subclass("esri.views.3d.interactive.measurementTools.directLineMeasurement3D.DirectLineMeasurement3DTool")],a)}(t.InteractiveToolBase);var u=new m.Point;return f});