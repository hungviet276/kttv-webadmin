// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.17/esri/copyright.txt for details.
//>>built
define("require exports tslib ../../../Color ../../../core/Accessor ../../../core/arrayUtils ../../../core/CollectionFlattener ../../../core/Evented ../../../core/Handles ../../../core/Logger ../../../core/mathUtils ../../../core/ObjectPool ../../../core/PooledArray ../../../core/promiseUtils ../../../core/watchUtils ../../../core/accessorSupport/decorators ../../../core/libs/gl-matrix-2/mat3f32 ../../../core/libs/gl-matrix-2/mat4 ../../../core/libs/gl-matrix-2/mat4f64 ../../../core/libs/gl-matrix-2/vec3 ../../../core/libs/gl-matrix-2/vec3f64 ../../../core/libs/gl-matrix-2/vec4f64 ../../../geometry/support/aaBoundingRect ../../../layers/support/layerUtils ../../../layers/support/LercDecoder ../../2d/engine/vectorTiles/decluttering/jobsUtil ../layers/ElevationLayerView3D ../support/debugFlags ../support/extentUtils ../support/geometryUtils ../support/pointUtils ../support/projectionUtils ./ElevationBounds ./ElevationData ./OverlayManager ./PlanarPatch ./SphericalPatch ./SurfaceExtentHelper ./SurfaceTilingSchemeLogic ./TerrainConst ./TerrainRenderer ./terrainUtils ./Tile ./tileUtils ./UpsampleInfo ../../support/Scheduler @dojo/framework/shim/Promise".split(" "),
function(R,q,e,S,T,F,U,V,W,X,H,A,G,l,r,f,Y,Z,aa,ba,I,ca,n,da,J,ea,fa,K,ga,L,ha,M,ia,N,ja,ka,la,O,ma,m,na,k,P,v,oa,pa){function Q(e,c){return e[0]===c[0]&&e[1]===c[1]&&e[2]===c[2]}function w(e){return e.isLeaf?!1:e.children[0].shouldRender||e.children[1].shouldRender||e.children[2].shouldRender||e.children[3].shouldRender||w(e.children[0])||w(e.children[1])||w(e.children[2])||w(e.children[3])}var p=X.getLogger("esri.views.3d.terrain.TerrainSurface");q=function(q){function c(a){a=q.call(this,a)||this;
a._clippingExtent=null;a._dataExtent=null;a._elevationBounds=new ia.ElevationBounds;a._rootExtent=n.create();a._iteratorPool=new A(v.IteratorPreorder);a._postorderIterator=new v.IteratorPostorder;a.pendingUpdates=!1;a._asyncWorkItems=0;a._visible=!1;a._usedMemory=x;a._isUpdating=!1;a._viewChangeUpdateDirty=!1;a._overlayOpacity=1;a._eyePosRenderSR=I.vec3f64.create();a._eyePosSurfaceSR=I.vec3f64.create();a._splitLimits=new P.SplitLimits;a._snapLevel=Infinity;a._frustum=L.frustum.create();a._viewProjectionMatrix=
aa.mat4f64.create();a._layerViews=[[],[]];a._layerIndexByLayerViewId=[new Map,new Map];a._basemapLayerViewHandles=new Map;a._handles=new W;a._allTiles=new G;a._upsampleInfoPool=new A(oa.UpsampleInfo);a._visibleLevels=new G({deallocator:null});a._getElevationData={spatialReference:null,rootTiles:null};a.maxTextureScale=1.2;a.rootTiles=null;a.backgroundImage=m.DEFAULT_TILE_BACKGROUND;a.backgroundColor=null;a._layerViewsDirty=!1;return a}e.__extends(c,q);c.prototype.initialize=function(){var a=this;
this._stage=this.view._stage;this._lercDecoder=J.acquireInstance(this.view.resourceController.scheduler);this._tilePool="planar"===this.manifold?new A(ka.PlanarPatch):new A(la.SphericalPatch);this._upsampleMapCache=this.view.resourceController.memoryController.getMemCache("esri.views.3d.terrain.upsample",function(a){return a.unloadMapData()});this._set("overlayManager",new ja.OverlayManager({terrainSurface:this,view:this.view}));this._handles.add([this.watch("overlayManager.hasHighlights",function(b){return a._renderer.setNeedsHighlight(b)}),
this.watch("overlayManager.rendersOccluded",function(b){return a._renderer.setRenderOccludedOverlay(b)})],"overlayManager");this._renderer=new na({manifold:this.manifold,overlayRenderer:this.overlayManager.renderer});this._renderer.install(this.view._stage);this._handles.add([r.init(this,"baseOpacity",function(b){a._handleLayerViewChanges();a._updateBaseOpacity(b)},!0),r.init(this,"_background",function(){a._handleLayerViewChanges();a._renderer.setTileBackground(a._background)},!0),this.view.watch("pointsOfInterest",
function(b){return a._renderer.pointsOfInterest=b}),r.whenTrue(K,"TERRAIN_DEBUG_POPUP",function(){(new Promise(function(a,b){R(["./support/TerrainDebugPopupOpener"],a,b)})).then(function(b){var g=new b.TerrainDebugPopupOpener({surface:a});r.whenFalseOnce(K,"TERRAIN_DEBUG_POPUP",function(){return g.destroy()})})})]);var b={layers:this.view.map.allLayers,layerViews:this.view.allLayerViews,spatialReference:this.view.spatialReference};this.extentHelper="spherical"===this.manifold?new O.SurfaceExtentHelperGlobal(b):
new O.SurfaceExtentHelperLocal(b);this._handles.add(r.init(this.extentHelper,"stencilEnabledExtents",function(b){return a._renderer.setStencilEnabledLayerExtents(b)}),"extentHelper");b=this.view.defaultsFromMap?new U({root:this.view.map,rootCollectionNames:this.view.defaultsFromMap.mapCollectionPaths,getChildrenFunction:function(a){return a.layers}}):this.view.map.allLayers;b=new ma({layers:b,extentHelper:this.extentHelper,manifold:this.manifold,viewSpatialReference:this.view.spatialReference});this._set("tilingSchemeLogic",
b);this._handles.add([this.tilingSchemeLogic.watch("tilingScheme",function(){return a._updateTilingSchemeAndExtent()},!0),this.tilingSchemeLogic.watch("extent",function(){return a._updateTilingSchemeAndExtent()},!0)],"tilingSchemeLogic");this._updateTilingSchemeAndExtent();this._elevationDataRequester=this.view.resourceController.createStreamDataRequester(0);this._mapDataRequester=this.view.resourceController.createStreamDataRequester(1);this._frameTask=this.view.resourceController.scheduler.registerTask(pa.Task.TERRAIN_SURFACE,
function(b){return a._update(b)},function(){return a.updating});this.view.resourceController.memoryController.events.on("quality-changed",function(){return a._viewChangeUpdate()});this._handles.add([this.view.on("resize",function(){return a._viewChangeUpdate()}),this.view.watch("state.camera",function(){return a._viewChangeUpdate()},!0),this.view.watch("qualitySettings.tiledSurface.lodBias",function(){return a._viewChangeUpdate()}),r.init(this.view,"qualitySettings.tiledSurface.textureFadeDuration",
function(b){return a._renderer.textureFadingEnabled=0<b}),this.view.watch("lodSnapping",function(){return a._viewChangeUpdate()}),this.view.watch("clippingArea",function(){return a._clippingChanged()})]);this._handles.add(this.view.allLayerViews.on("after-changes",function(){return a._layerViewsDirty=!0}));this._layerViewsDirty=!0;this._handleLayerViewChanges();this._updateClippingExtent();this.notifyChange("extent")};c.prototype.destroy=function(){var a=this;this._frameTask.remove();this._handles.destroy();
J.releaseInstance(this._lercDecoder);this._lercDecoder=null;this._removeAllTiles();this._upsampleMapCache.destroy();this._upsampleMapCache=null;this.tilingSchemeLogic.destroy();this._set("tilingSchemeLogic",null);this.extentHelper.destroy();this.extentHelper=null;this._basemapLayerViewHandles.forEach(function(b,g){return a._unregisterTiledLayerView(g)});this._mapDataRequester=this._elevationDataRequester=null;this.overlayManager&&(this.overlayManager.destroy(),this._set("overlayManager",null));this._tilePool.destroy();
this._tilePool=null;P.pruneAgents();this._renderer.uninstall(this._stage);this._renderer.destroy();this._renderer=null;this._iteratorPool.destroy();this._iteratorPool=null;this._set("view",null);this._stage=null;this._upsampleInfoPool.destroy();this._upsampleInfoPool=null};Object.defineProperty(c.prototype,"renderer",{get:function(){return this._renderer},enumerable:!1,configurable:!0});Object.defineProperty(c.prototype,"frustum",{get:function(){return this._frustum},enumerable:!1,configurable:!0});
Object.defineProperty(c.prototype,"snapLevel",{get:function(){return Math.round(this._snapLevel)},enumerable:!1,configurable:!0});Object.defineProperty(c.prototype,"upsampleInfoPool",{get:function(){return this._upsampleInfoPool},enumerable:!1,configurable:!0});Object.defineProperty(c.prototype,"upsampleMapCache",{get:function(){return this._upsampleMapCache},enumerable:!1,configurable:!0});Object.defineProperty(c.prototype,"extent",{get:function(){return this._clippingExtent||this._rootExtent},enumerable:!1,
configurable:!0});Object.defineProperty(c.prototype,"updating",{get:function(){return!(!(this.pendingUpdates||0<this._asyncWorkItems||this._renderer.updating||this.overlayManager.updating||this._layerViewsDirty||this._frameTask.updating)||!this.ready||this.suspended)},enumerable:!1,configurable:!0});Object.defineProperty(c.prototype,"ready",{get:function(){return!!this.rootTiles},enumerable:!1,configurable:!0});Object.defineProperty(c.prototype,"renderOrder",{set:function(a){this._renderer.renderOrder=
a;this._set("renderOrder",a)},enumerable:!1,configurable:!0});Object.defineProperty(c.prototype,"skirtScale",{get:function(){return this._renderer.skirtScale},set:function(a){this._renderer.skirtScale=a},enumerable:!1,configurable:!0});Object.defineProperty(c.prototype,"spatialReference",{get:function(){var a=this.tilingScheme&&this.tilingScheme.spatialReference||null;return this._getElevationData.spatialReference=a},enumerable:!1,configurable:!0});Object.defineProperty(c.prototype,"_background",
{get:function(){return null!=this.backgroundColor?this.backgroundColor:this.backgroundImage},enumerable:!1,configurable:!0});Object.defineProperty(c.prototype,"slicePlaneEnabled",{set:function(a){this._renderer.slicePlane=a;this._set("slicePlaneEnabled",a)},enumerable:!1,configurable:!0});Object.defineProperty(c.prototype,"velvetOverground",{set:function(a){a!==this.velvetOverground&&(this._renderer.velvetOverground=a);this._set("velvetOverground",a)},enumerable:!1,configurable:!0});Object.defineProperty(c.prototype,
"visible",{set:function(a){a!==this._visible&&(this._visible=a,this._renderer.setVisibility(a),this.suspended=!a)},enumerable:!1,configurable:!0});c.prototype.isOpaque=function(){return this._renderer.opaque};Object.defineProperty(c.prototype,"suspended",{set:function(a){this._set("suspended",a);this._viewChangeUpdate()},enumerable:!1,configurable:!0});Object.defineProperty(c.prototype,"lodSnapping",{get:function(){return this.view.qualitySettings.tiledSurface.reduceTileLevelDifferences?0:1},enumerable:!1,
configurable:!0});c.prototype.intersect=function(a,b,g,c){this._renderer.intersect(a,b,g,c)};c.prototype.getElevation=function(a,b,g,c){var d=this._getElevationData.rootTiles;if(!d||!d.length||0===d[0].layerInfo[0].length)return null;var e=z;e[0]=a;e[1]=b;e[2]=g;if(!M.vectorToVector(e,c,e,this._getElevationData.spatialReference))return p.error("TerrainSurface.getElevation(): could not project given point to tiling scheme coordinate system"),null;for(b=0;b<d.length;b++)if(a=d[b],a.containsPoint(e)){for(;a&&
!a.rendered&&!a.isLeaf;)d=0,e[0]>.5*(a.extent[0]+a.extent[2])&&(d+=1),e[1]<.5*(a.extent[1]+a.extent[3])&&(d+=2),a=a.children[d];if(d=(d=a.renderData)&&d.geometryState?d.geometryState.samplerData:null)return N.ElevationData.sample(e[0],e[1],d);break}return null};Object.defineProperty(c.prototype,"elevationBounds",{get:function(){return this._elevationBounds},enumerable:!1,configurable:!0});c.prototype.getScale=function(a){if(this.tilingScheme){if(!ha.pointToVector(a,z,this.spatialReference))return p.error("TerrainSurface.getElevation(): could not project given point to tiling scheme coordinate system"),
null;var b=this.rootTiles;if(b)for(var g=0;g<b.length;g++)if(a=b[g],a.containsPoint(z)){for(;null!=a.children[0];)b=0,z[0]>a.children[0].extent[2]&&(b+=1),z[1]<a.children[0].extent[1]&&(b+=2),a=a.children[b];return this._getLodBiasCorrectedScale(a.level)}}return 1E100};c.prototype.queryVisibleScaleRange=function(a,b,g,c){b=b?this.tilingScheme.levelAtScale(b):0;g=g?this.tilingScheme.levelAtScale(g):Infinity;var d=this.lodBias;this._renderer.queryVisibleLevelRange(a,b+d,g+d,c)};c.prototype._updateBaseOpacity=
function(a){var b=this._renderer.opaque;this._renderer.opaque=1<=a;this._renderer.isTransparent=this.allTransparentSurfaceLayers();this._updateTileTextures(b!==this._renderer.opaque)};c.prototype._updateTilingSchemeAndExtent=function(){var a=this.tilingSchemeLogic.extent,b=a&&!n.equals(a,this._dataExtent);b&&(this._dataExtent?n.set(this._dataExtent,a):this._dataExtent=n.create(a));var a=this.tilingSchemeLogic.tilingScheme,g=a!==this.tilingScheme;g&&(k.weakAssert(!!a,"tiling scheme cannot be reset to undefined"),
this.tilingScheme&&this._removeAllTiles(),this._set("tilingScheme",a),this._updateClippingExtent(),a&&(this._updateTiledLayers(),this._renderer.setTileSize(a.pixelSize),this.overlayManager.setSpatialReference(a.spatialReference,"spherical"===this.manifold)));(b||g)&&this._updateRootTiles()};c.prototype._acquireTile=function(a,b,g,c){var d=this._tilePool.acquire();B[0]=a;B[1]=b;B[2]=g;d.init(B,c,this);return d};c.prototype._updateRootTiles=function(){var a=this,b=this._clippingExtent||this._dataExtent,
g=this.tilingScheme;if(b&&g){var c=qa,y=g.rootTilesInExtent(b,c,5*m.MAX_ROOT_TILES),e=function(b){b=a._acquireTile(0,b[1],b[2],null);2===b.shouldSplit(a._splitLimits,a._eyePosRenderSR,a.lodSnapping)&&b.setPendingUpdate(2);a._loadTile(b);return b};if(this.rootTiles){if(y.length>m.MAX_ROOT_TILES){p.warn(m.TOO_MANY_ROOT_TILES_AFTER_CHANGE_ERROR);return}var b=this.rootTiles.map(function(a){return a.lij}),h=F.difference(b,y,Q);if(0<h.removed.length||0<h.added.length){var t=this.rootTiles.filter(function(b){return-1<
F.findIndex(h.removed,Q.bind(null,b.lij))?(a._purgeTile(b),!1):!0});h.added.forEach(function(a){return t.push(e(a))});this._setRootTiles(t)}}else y.length>m.MAX_ROOT_TILES&&(p.warn(m.TOO_MANY_ROOT_TILES_FOR_LAYER_ERROR),y=g.rootTilesInExtent(b,c,m.MAX_ROOT_TILES)),this._setRootTiles(y.map(function(a){return e(a)}));n.equals(c,this._rootExtent)||(this._rootExtent=n.create(c),this._hasFixedExtent()||this.notifyChange("extent"));this.visible=!0;this._viewChangeUpdate();this.overlayManager.setOverlayPlacementDirty();
this.notifyChange("ready")}};c.prototype._setRootTiles=function(a){this._set("rootTiles",a);this._allTiles.clear();if(a){var b=this._iteratorPool.acquire();for(b.reset(a);!b.done;)this._allTiles.push(b.next());this._iteratorPool.release(b)}this._getElevationData.rootTiles=a;this._renderer.setRootTiles(this.rootTiles);this._updateTiles(a)};c.prototype._runViewChangeUpdateIfDirty=function(){this._viewChangeUpdateDirty&&(this._viewChangeUpdateDirty=!1,this._viewChangeUpdate())};c.prototype._viewChangeUpdate=
function(){this._stage&&!this.suspended&&this.tilingScheme&&this._visible&&(this._isUpdating?this._viewChangeUpdateDirty=!0:(this._viewChangeUpdateDirty=!1,this._updateViewDependentParameters(),this._updateSkirts(),this.updateOverlayOpacity(),this._updateTiles(this.rootTiles)))};c.prototype._updateClippingStatus=function(a){a.updateClippingStatus(this._clippingExtent)&&a.resetPendingUpdate(32)&&this._updateTileGeometry(a)};c.prototype._updateTiles=function(a){if(a){var b=this._iteratorPool.acquire();
b.reset(a);var c;v.hasVisibleSiblings(a)?(a=this._elevationBounds.min,c=this._elevationBounds.max):(a=Infinity,c=-Infinity);for(;!b.done;){var d=b.next();this._updateClippingStatus(d);d.updateVisibility();d.setPendingUpdate(16);if(d.visible){d.updateScreenDepth(this._viewProjectionMatrix);d.renderData&&(a=Math.min(d.elevationBounds[0],a),c=Math.max(d.elevationBounds[1],c));var e=d.shouldSplit(this._splitLimits,this._eyePosRenderSR,this.lodSnapping);if(2===e){d.resetPendingUpdate(8);d.isLeaf&&(d.setPendingUpdate(2),
b.skipSubtree());continue}d.resetPendingUpdate(2)&&d.updateAgentSuspension();4===e&&d.updateAgents(0)}b.skipSubtree();if(!d.isLeaf){d.setPendingUpdate(8);d.resetPendingUpdate(2);e=this._iteratorPool.acquire();e.resetOne(d);for(d=e.next();!e.done;d=e.next())this._updateClippingStatus(d),d.updateVisibility(),d.visible&&d.updateScreenDepth(this._viewProjectionMatrix);this._iteratorPool.release(e)}}this._iteratorPool.release(b);this.pendingUpdates=!0;isFinite(a)&&isFinite(c)&&(this._elevationBounds.min!==
a||this._elevationBounds.max!==c)&&(this._elevationBounds.min=a,this._elevationBounds.max=c,this.emit("elevation-bounds-change",null))}};c.prototype._updateViewDependentParameters=function(){var a=this.view.state.camera,b=Math.tan(.5*a.fovX),c=Math.tan(.5*a.fovY),d=this.tilingScheme.pixelSize,e=Math.pow(2,-this.lodBias)*a.pixelRatio;this._splitLimits.aboveGround=a.aboveGround;this._splitLimits.fovX=b;this._splitLimits.fovY=c;this._splitLimits.relativeWidthLimit=d/a.width*this.maxTextureScale*e;this._splitLimits.relativeHeightLimit=
d/a.height*this.maxTextureScale*e;this._splitLimits.maxLod=this.tilingScheme.getMaxLod();this._splitLimits.angledSplitBias=this.view.qualitySettings.tiledSurface.angledSplitBias;L.frustum.copy(a.frustum,this._frustum);Z.mat4.multiply(this._viewProjectionMatrix,a.projectionMatrix,a.viewMatrix);ba.vec3.copy(this._eyePosRenderSR,a.eye);M.vectorToVector(this._eyePosRenderSR,this.view.renderSpatialReference,this._eyePosSurfaceSR,this.spatialReference)};c.prototype._updateSnapLevel=function(){if(1!==this.lodSnapping){var a=
this._findSnapLevel();if(!(.1>Math.abs(this._snapLevel-a))){var b=this.snapLevel;this._snapLevel=a;b!==this.snapLevel&&this._updateTiles(this.rootTiles)}}};c.prototype._findSnapLevel=function(){if(0>=this._visibleLevels.length)return this._snapLevel;var a=this._visibleLevels,b=Math.round(a.length*(Math.abs(this.view.camera.tilt-90)/90*.4+.3));if(b>=a.length)return this._snapLevel;a.sort(function(a,b){return a-b});for(var c=0,d=b;d<a.length;++d)c+=a.getItemAt(d);d=a.getItemAt(Math.round(.95*a.length)-
1);return H.clamp(c/(a.length-b),d-1,this._splitLimits.maxLod)};c.prototype._updateSkirts=function(){var a=this.view.state.camera;k.autoUpdateSkirtsVisibility(this,this._eyePosSurfaceSR,this.spatialReference,this.view.state.constraints.collision.enabled?0:1.11*a.near)};c.prototype._updateRenderData=function(a){a.rendered&&!a.shouldRender&&(w(a)?this._loadChildren(a):a.isLeaf&&a.parent&&a.parent.shouldRender&&this._loadParent(a))};c.prototype._updateTileGeometry=function(a){a.updateVisibility();this._renderer.updateTileGeometry(a);
this._elevationUpdate(a);this._usedMemory=x};c.prototype._elevationUpdate=function(a){C.spatialReference=this.spatialReference;C.tile=a;C.extent=a.extent;this.emit("elevation-change",C);n.containsPoint(a.extent,this._eyePosSurfaceSR)&&this._updateSkirts()};c.prototype._update=function(a){var b=this;this._handleLayerViewChanges();this._isUpdating=!0;this._mergeAndSplit(a);a.run(function(){return b._updateElevation(a)});a.run(function(){return b._updateTextures(a)});this._isUpdating=!1;this._runViewChangeUpdateIfDirty()};
c.prototype._mergeAndSplit=function(a){var b=this;if(!this.suspended&&this.pendingUpdates){this.pendingUpdates=!1;for(var c=this._eyePosRenderSR,d=0,e=!1,f=0===this.lodSnapping?function(a){var d=a.shouldSplit(b._splitLimits,c,1);a.visible&&2!==d&&a.parent&&2===a.parent.shouldSplit(b._splitLimits,c,1)&&(1===d?b._visibleLevels.fill(a.level+1,4):b._visibleLevels.push(a.level))}:function(){};!a.done;){this._visibleLevels.clear();var h=!this._allTiles.some(function(c){d+=c.usedMemory;f(c);c.resetPendingUpdate(8)?
(b._mergeTile(c),e=!0,a.madeProgress()):c.resetPendingUpdate(2)&&(b._splitTile(c),e=!0,a.madeProgress());c.resetPendingUpdate(16)&&(b._updateRenderData(c),a.madeProgress());b.pendingUpdates=b.pendingUpdates||c.updating;return a.done});e&&(this.pendingUpdates=!0,e=!1,v.sortTiles(this._renderer.renderOrder,this._allTiles));if(h){this._updateSnapLevel();this._usedMemory=d;break}this.pendingUpdates=!0}this._visibleLevels.clear()}};c.prototype._updateElevation=function(a){var b=this;this._allTiles.some(function(c){c.resetPendingUpdate(32)&&
(b._updateTileGeometry(c),a.madeProgress());return a.done});return a.hasProgressed};c.prototype._updateTextures=function(a){var b=this;this._allTiles.some(function(c){c.resetPendingUpdate(64)&&(b._renderer.updateTileTexture(c),b._usedMemory=x,a.madeProgress());return a.done});return a.hasProgressed};c.prototype._updateClippingExtent=function(){if(!this.spatialReference)return!1;var a=n.create(),b=null;ga.toBoundingRect(this.view.clippingArea,a,this.spatialReference)&&(b=a);if(n.equals(b,this._clippingExtent))return!1;
this._clippingExtent=b;this._renderer.clippingExtent=b;this.notifyChange("extent");this.updateTileOverlayParams();this.overlayManager.setOverlayPlacementDirty();return!0};c.prototype._clippingChanged=function(){this._updateClippingExtent()&&this._updateRootTiles()};Object.defineProperty(c.prototype,"lodBias",{get:function(){return this.view.qualitySettings.tiledSurface.lodBias-(1-this.view.resourceController.memoryController.memoryFactor)*m.MAX_MEMORY_LOD_BIAS},enumerable:!1,configurable:!0});c.prototype._getLodBiasCorrectedScale=
function(a){var b=this.tilingScheme.levels;a=H.clamp(a-this.lodBias,0,b.length-1);var c=a-Math.floor(a);return b[Math.floor(a)].scale*(1-c)+b[Math.ceil(a)].scale*c};c.prototype._removeAllTiles=function(){var a=this;this.rootTiles&&(this.rootTiles.forEach(function(b){return a._purgeTile(b)}),this._setRootTiles(null),this.notifyChange("ready"));this._allTiles.clear();this.visible=!1};c.prototype._purgeChildTiles=function(a){if(a.isLeaf)return!1;var b=this._purgeTile(a.children[0]),b=this._purgeTile(a.children[1])||
b,b=this._purgeTile(a.children[2])||b,b=this._purgeTile(a.children[3])||b;a.unsetChildren();return b};c.prototype._purgeTile=function(a){var b=this._purgeChildTiles(a)||a.rendered;this._allTiles.removeUnordered(a);a.unload(this._renderer);this._tilePool.release(a);return b};c.prototype._splitTile=function(a){k.weakAssert(a.isLeaf,"tile that is already split should not be split again!");var b=a.level+1,c=2*a.lij[1],d=2*a.lij[2];a.setChildren(this._createTile(b,c,d,a),this._createTile(b,c,d+1,a),this._createTile(b,
c+1,d,a),this._createTile(b,c+1,d+1,a));a.setPendingUpdate(16);a.updateAgentSuspension();this._allTiles.pushArray(a.children);this.pendingUpdates=!0;this._emitTileScaleChange(a,b);return a.children[0].hasPendingUpdate(2)||a.children[1].hasPendingUpdate(2)||a.children[2].hasPendingUpdate(2)||a.children[3].hasPendingUpdate(2)};c.prototype._emitTileScaleChange=function(a,b){void 0===b&&(b=a.level);D.spatialReference=this.spatialReference;D.extent=a.extent;D.scale=this._getLodBiasCorrectedScale(b);this.emit("scale-change",
D)};c.prototype._createTile=function(a,b,c,d){k.weakAssert(!!d,"_createTile sanity check");a=this._acquireTile(a,b,c,d);a.updateClippingStatus(this._clippingExtent);a.visible&&(a.updateScreenDepth(this._viewProjectionMatrix),2===a.shouldSplit(this._splitLimits,this._eyePosRenderSR,this.lodSnapping)&&a.setPendingUpdate(2));return a};c.prototype._mergeTile=function(a){k.weakAssert(!a.hasPendingUpdate(2),"_mergeTile sanity check");this._purgeChildTiles(a)&&(k.weakAssert(!a.renderData,"_mergeTile sanity check"),
this._loadTile(a));this.pendingUpdates=!0;this._emitTileScaleChange(a)};c.prototype._loadChildren=function(a){k.weakAssert(a.rendered,"parent should be rendered");a.unload(this._renderer);this._loadTile(a.children[0]);this._loadTile(a.children[1]);this._loadTile(a.children[2]);this._loadTile(a.children[3])};c.prototype._loadParent=function(a){a=a.parent;this._unloadChildren(a);this._loadTile(a)};c.prototype._unloadChildren=function(a){a.isLeaf||(this._unloadChildren(a.children[0]),a.children[0].unload(this._renderer),
this._unloadChildren(a.children[1]),a.children[1].unload(this._renderer),this._unloadChildren(a.children[2]),a.children[2].unload(this._renderer),this._unloadChildren(a.children[3]),a.children[3].unload(this._renderer))};c.prototype._loadTile=function(a){a.load(this._renderer);a.setPendingUpdate(16);this.overlayManager&&this.overlayManager.hasOverlays()&&this.overlayManager.setTileParameters(a,a.renderData,this._overlayOpacity);this._elevationUpdate(a)};c.prototype._elevationDataArrived=function(a,
b,c){c=new N.ElevationData(a.lij,a.extent,c);a.dataArrived(b,0,c);c=[a];a=a.level;var d=this._iteratorPool.acquire();for(d.reset(c);!d.done;){var g=d.next();g.findElevationBoundsForLayer(b,a);g.computeElevationBounds()}this._iteratorPool.release(d);this._updateTiles(c)};c.prototype._handleLayerViewChanges=function(){var a=this;if(this._layerViewsDirty){for(var b=this._layerViewsDirty=!1,c=new Set,d=-1,e=0,f=this.view.allLayerViews.items;e<f.length;e++){var h=f[e];c.add(h.uid);if(k.isSurfaceLayerView(h))if(this._basemapLayerViewHandles.has(h.uid)){var t=
this.layerClassFromLayerView(h),h=this._layerIndexByLayerViewId[t].get(h.uid);h<d&&(b=!0);d=h}else this._registerTiledLayerView(h),h.layer.loaded&&(b=!0)}this._basemapLayerViewHandles.forEach(function(d,g){c.has(g)||(a._unregisterTiledLayerView(g),b=!0)});b&&this._updateTiledLayers();this._renderer.isTransparent=this.allTransparentSurfaceLayers()}};c.prototype.allTransparentSurfaceLayers=function(){for(var a=0===this.view.map.ground.opacity,b=0,c=this.view.allLayerViews.items;b<c.length;b++){var d=
c[b];if(k.isSurfaceLayerView(d)&&!k.isElevationLayerView(d)&&!da.isBaseLayer(d.layer)&&0!==d.fullOpacity){a=!1;break}}return a};c.prototype.layerClassFromLayerView=function(a){return k.isElevationLayerView(a)?0:1};c.prototype._registerTiledLayerView=function(a){var b=this,c=[],d=this.layerClassFromLayerView(a);c.push(a.watch("suspended",function(){return b._updateTiledLayers()}));c.push(a.watch("fullOpacity",function(){return b._updateTileTextures(!1)}));c.push(a.layer.watch("scaleRangeId",function(){return b._restartAllAgents(d)}));
a.on("data-changed",function(){var c=b._layerIndexByLayerViewId[d].get(a.uid);null!=c&&b._invalidateLayerData(c,d)});this._basemapLayerViewHandles.set(a.uid,c)};c.prototype._unregisterTiledLayerView=function(a){var b=this._basemapLayerViewHandles.get(a);if(b){for(var c=0;c<b.length;c++)b[c].remove();this._basemapLayerViewHandles.delete(a)}};c.prototype._updateTiledLayers=function(){var a=this;if(this.tilingScheme&&!this.view.suspended){var b=this.view.allLayerViews,c=[[],[]],d=null,e=n.empty();b.forEach(function(b){var g=
b.layer;if(g&&!b.suspended&&k.isSurfaceLayerView(b)){var f=b.fullExtent;f?a.tilingScheme.compatibleWith(b.tileInfo)?(n.expand(e,f),g=a.layerClassFromLayerView(b),1===g&&(f=b.displayLevelRange,Infinity!==f.maxLevel&&(null===d||f.maxLevel>d)&&(d=f.maxLevel)),c[g].push(b)):p.warn("Terrain: tiling scheme of layer "+g.id+" is incompatible with other tiled layers, will not be drawn"):p.warn("Terrain: Map or elevation layer does not have fullExtent: "+g.id)}});for(b=0;2>b;b++){var f=this._layerViews[b],
h=c[b];h.reverse();var t=h.length,l=f.length!==t,m=Array(t),r=Array(f.length);this._layerIndexByLayerViewId[b].clear();for(var u=0;u<t;u++){this._layerIndexByLayerViewId[b].set(h[u].uid,u);var q=f.indexOf(h[u]);m[u]=q;u!==q&&(l=!0);-1<q&&(r[q]=u)}if(l){f=this._postorderIterator;for(f.reset(this.rootTiles);!f.done;)f.next().modifyLayers(r,m,b);this._layerViews[b]=h;this._restartAllAgents(b);this._updateTiles(this.rootTiles)}}this.tilingScheme.ensureMaxLod(d)&&this._viewChangeUpdate()}};c.prototype._restartAllAgents=
function(a){var b=this._postorderIterator;for(b.reset(this.rootTiles);!b.done;){var c=b.next();c.restartAgents(a);0===a&&c.computeElevationBounds()}};c.prototype._hasFixedExtent=function(){return!!this._clippingExtent};c.prototype.layerViewByIndex=function(a,b){return this._layerViews[b][a]};c.prototype.numLayers=function(a){return this._layerViews[a].length};c.prototype._updateTileTextures=function(a){var b=this;this._allTiles.forEachSimple(function(c){c.updateAgents(1);a?b.renderer.updateTileTexture(c):
c.updateRenderData(1)});this._renderer.isTransparent=this.allTransparentSurfaceLayers()};c.prototype._invalidateLayerData=function(a,b){this._allTiles.forEachSimple(function(c){return c.removeLayerAgent(a,b)});this._allTiles.forEachSimple(function(c){return c.invalidateLayerData(a,b)})};c.prototype.requestRender=function(a){void 0===a&&(a=1);this.renderer.setNeedsRender(a)};c.prototype.requestTileData=function(a,b,c,d){var g=this,f=this.layerViewByIndex(b,c);b=f.layer;if(!b.tilemapCache||k.isVectorTileLayerView(f))return this._requestTileData(a,
c,f,d);++this._asyncWorkItems;return b.tilemapCache.fetchAvailability(a.lij[0],a.lij[1],a.lij[2],e.__assign(e.__assign({},d),{timeout:6E3})).then(function(){return--g._asyncWorkItems}).catch(function(b){--g._asyncWorkItems;l.isAbortError(b)||g._dataMissing(a,c,f,{notInTilemap:!0});throw b;}).then(function(){return g._frameTask.schedule(function(){return g._requestTileData(a,c,f,d)},d.signal)})};c.prototype._requestTileData=function(a,b,c,d){return 0===b?this._requestElevationTileData(a,c,d):this._requestMapTileData(a,
c,d)};c.prototype._requestElevationTileData=function(a,b,c){var d=this;if(k.isElevationLayerView(b)){var e=function(e){--d._asyncWorkItems;if(!l.isAborted(c)){var g=d._layerIndexByLayerViewId[0].get(b.uid);null==g?p.warn("TerrainSurface: received data from unknown layer %d %s",0,a.lij.toString()):(d._usedMemory=x,d.pendingUpdates=!0,d._elevationDataArrived(a,g,e))}},g=function(c){--d._asyncWorkItems;l.isAbortError(c)||(d._dataMissing(a,0,b,c),d.pendingUpdates=!0)};++this._asyncWorkItems;if(k.useFetchTileForLayer(b.layer))return b.layer.fetchTile(a.lij[0],
a.lij[1],a.lij[2],{noDataValue:m.ELEVATION_NODATA_VALUE,signal:c.signal}).then(function(a){l.isAborted(c)?(p.warnOnce("A call to fetchTile resolved even though the request was aborted. fetchTile should not resolve if options.signal.aborted is true."),g(l.createAbortError())):e(a)},g);var f=b.getTileUrl(a.lij[0],a.lij[1],a.lij[2]);return this._elevationDataRequester.request(f,"binary",c).then(function(a){return d._lercDecoder.decode(a,{noDataValue:m.ELEVATION_NODATA_VALUE},c.signal)}).then(function(a){e({values:a.pixelData,
width:a.width,height:a.height,noDataValue:a.noDataValue,minValue:a.minValue,maxValue:a.maxValue})},g)}k.weakAssert(!1,"_requestElevationTileData can only be called for elevation layer views")};c.prototype._requestMapTileData=function(a,b,c){var d=this;if(b instanceof fa)return l.reject();++this._asyncWorkItems;var e=function(e){return d._frameTask.schedule(function(){--d._asyncWorkItems;d.pendingUpdates=!0;l.isAborted(c)?k.releaseTileData(e):d._dataArrived(a,1,b,e)},c.signal).catch(g)},g=function(e){return d._frameTask.schedule(function(){--d._asyncWorkItems;
l.isAborted(c)||(d._dataMissing(a,1,b,e),d.pendingUpdates=!0)})};if(k.isVectorTileLayerView(b)){var f=b.schemaHelper.getLevelRowColumn(a.lij);return b.tileHandler.getVectorTile(f[0],f[1],f[2],c).then(function(a){a.neededForCoverage=!0;a.transforms.tileUnitsToPixels=Y.mat3f32.fromValues(.125,0,0,0,.125,0,0,0,1);ea.declutterSingleTile(a);e(a)},g)}if(k.isImageryTileLayerView(b))return b.fetchTile(a.lij[0],a.lij[1],a.lij[2],c).then(e,g);if(k.useFetchTileForLayer(b.layer)&&k.isTileLayerView(b))return b.layer.fetchTile(a.lij[0],
a.lij[1],a.lij[2],c).then(function(a){l.isAborted(c)?(p.warnOnce("A call to fetchTile resolved even though the request was aborted. fetchTile should not resolve if options.signal.aborted is true."),g(l.createAbortError())):e(a)},g);f=b.getTileUrl(a.lij[0],a.lij[1],a.lij[2]);null!=b.refreshInterval&&b.refreshTimestamp&&(f+=(-1<f.indexOf("?")?"\x26":"?")+"_ts\x3d"+b.refreshTimestamp);return this._mapDataRequester.request(f,b.hasMixedImageFormats?"image+type":"image",c).then(e,g)};c.prototype._dataArrived=
function(a,b,c,d){c=this._layerIndexByLayerViewId[b].get(c.uid);null!=c?a.dataArrived(c,b,d):p.warn("TerrainSurface: received data from unknown layer")};c.prototype._dataMissing=function(a,b,c,d){c=this._layerIndexByLayerViewId[b].get(c.uid);null!=c?a.dataMissing(c,b,d):p.warn("TerrainSurface: received data from unknown layer")};c.prototype.updateTileOverlayParams=function(){var a=this;this.rootTiles&&(this._allTiles.forEachSimple(function(b){b.renderData&&a.overlayManager&&a.overlayManager.setTileParameters(b,
b.renderData,a._overlayOpacity)}),this._renderer.setNeedsRender())};c.prototype.updateOverlayOpacity=function(){if(this.overlayManager){var a=this.overlayManager.updateOpacity(this._eyePosSurfaceSR[2]);isNaN(a)||a===this._overlayOpacity||(this._allTiles.forEachSimple(function(b){return b.renderData&&(b.renderData.overlayOpacity=a)}),this._overlayOpacity=a,this._renderer.setNeedsRender())}};c.prototype.getStats=function(){var a={numNodes:this._allTiles.length,numLeaves:0,numVisible:0,numRendered:0,
numRenderedPerLevel:[],numLoadedPerLevel:[]};this._allTiles.forEachSimple(function(b){b.isLeaf&&a.numLeaves++;var c=b.level;b.renderData&&(a.numLoadedPerLevel[c]=(a.numLoadedPerLevel[c]||0)+1);b.visible&&(a.numVisible++,b.rendered&&(a.numRenderedPerLevel[c]=(a.numRenderedPerLevel[c]||0)+1,a.numRendered++))});return a};c.prototype.getUsedMemory=function(){var a=this;if(!this.tilingScheme)return 0;this._usedMemory===x&&(this._usedMemory=0,this._allTiles.forEachSimple(function(b){return a._usedMemory+=
b.usedMemory}));return this._usedMemory};c.prototype.getUsedMemoryForLayerView=function(a){var b=0,c=this.layerClassFromLayerView(a),d=this._layerIndexByLayerViewId[c].get(a.uid);this._allTiles.forEachSimple(function(a){return b+=a.getUsedMemoryForLayer(c,d)});return b};c.prototype.getTile=function(a){var b=a.split("/").map(function(a){return+a});if(0===b[0])return F.find(this.rootTiles,function(a){return a.lij[1]===b[1]&&a.lij[2]===b[2]});a=Math.pow(2,b[0]);var c=Math.floor(b[1]/a),d=Math.floor(b[2]/
a),e;this.rootTiles.some(function(a){return a.lij[1]===c&&a.lij[2]===d?(e=a,!0):!1});if(e){for(a=1<<b[0]-1;e.lij[0]<b[0];){var f=b[1]&a?2:0;0<(b[2]&a)&&f++;if(!e.children[f])return null;e=e.children[f];a>>=1}k.weakAssert(e.lij[0]===b[0]&&e.lij[1]===b[1]&&e.lij[2]===b[2],"not the right tile?");return e}return null};c.prototype.getRenderedTiles=function(){E.clear();this._allTiles.forEachSimple(function(a){a.visible&&a.rendered&&E.push(a)});v.sortTiles(this.renderOrder,E);return E.toArray()};Object.defineProperty(c.prototype,
"test",{get:function(){var a=this;return{renderer:this._renderer,lercDecoder:this._lercDecoder,mergeTile:function(b){return a._mergeTile(b)},updateTiles:function(b){return a._updateTiles(b)},getTiles:function(){return a._allTiles.toArray()}}},enumerable:!1,configurable:!0});e.__decorate([f.property()],c.prototype,"_renderer",void 0);e.__decorate([f.property()],c.prototype,"pendingUpdates",void 0);e.__decorate([f.property()],c.prototype,"_asyncWorkItems",void 0);e.__decorate([f.property()],c.prototype,
"_frameTask",void 0);e.__decorate([f.property({constructOnly:!0})],c.prototype,"view",void 0);e.__decorate([f.aliasOf("_renderer.cullBackFaces")],c.prototype,"cullBackFaces",void 0);e.__decorate([f.property({readOnly:!0})],c.prototype,"extent",null);e.__decorate([f.property({readOnly:!0,dependsOn:"ready suspended pendingUpdates _asyncWorkItems _renderer.updating _layerViewsDirty overlayManager.updating _frameTask.updating".split(" ")})],c.prototype,"updating",null);e.__decorate([f.property({aliasOf:"view.map.ground.opacity"})],
c.prototype,"baseOpacity",void 0);e.__decorate([f.property({readOnly:!0})],c.prototype,"overlayManager",void 0);e.__decorate([f.property({constructOnly:!0})],c.prototype,"manifold",void 0);e.__decorate([f.property()],c.prototype,"maxTextureScale",void 0);e.__decorate([f.property({readOnly:!0})],c.prototype,"ready",null);e.__decorate([f.property({value:1})],c.prototype,"renderOrder",null);e.__decorate([f.property({readOnly:!0})],c.prototype,"rootTiles",void 0);e.__decorate([f.property({readOnly:!0,
dependsOn:["tilingScheme.spatialReference"]})],c.prototype,"spatialReference",null);e.__decorate([f.property()],c.prototype,"backgroundImage",void 0);e.__decorate([f.property({type:S,aliasOf:"view.map.ground.surfaceColor"})],c.prototype,"backgroundColor",void 0);e.__decorate([f.property({dependsOn:["backgroundColor","backgroundImage"]})],c.prototype,"_background",null);e.__decorate([f.property({value:!1})],c.prototype,"slicePlaneEnabled",null);e.__decorate([f.property({readOnly:!0})],c.prototype,
"tilingScheme",void 0);e.__decorate([f.property({readOnly:!0,aliasOf:"tilingSchemeLogic.tilingSchemeLocked"})],c.prototype,"tilingSchemeLocked",void 0);e.__decorate([f.property({readOnly:!0,aliasOf:"tilingSchemeLogic.tilingSchemeDone"})],c.prototype,"tilingSchemeDone",void 0);e.__decorate([f.property({readOnly:!0})],c.prototype,"tilingSchemeLogic",void 0);e.__decorate([f.property({value:!0})],c.prototype,"velvetOverground",null);e.__decorate([f.aliasOf("_renderer.wireframe")],c.prototype,"wireframe",
void 0);e.__decorate([f.property({value:!1})],c.prototype,"suspended",null);e.__decorate([f.property({readOnly:!0,dependsOn:["view.qualitySettings.tiledSurface.reduceTileLevelDifferences"]})],c.prototype,"lodSnapping",null);e.__decorate([f.property({readOnly:!0,aliasOf:"view.qualitySettings.tiledSurface.textureFadeDuration"})],c.prototype,"textureFadeDuration",void 0);e.__decorate([f.property()],c.prototype,"_layerViewsDirty",void 0);e.__decorate([f.aliasOf("_renderer.renderPatchBorders")],c.prototype,
"renderPatchBorders",void 0);e.__decorate([f.aliasOf("_renderer.renderingDisabled")],c.prototype,"renderingDisabled",void 0);return c=e.__decorate([f.subclass("esri.views.3d.terrain.TerrainSurface")],c)}(V.EventedMixin(T));var x=-1,z=ca.vec4f64.create(),qa=n.create(),B=[0,0,0],E=new G,C={spatialReference:null,tile:null,extent:null,context:"ground"},D={spatialReference:null,extent:null,scale:0};return q});