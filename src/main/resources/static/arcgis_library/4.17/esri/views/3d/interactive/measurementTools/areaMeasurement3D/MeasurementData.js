// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.17/esri/copyright.txt for details.
//>>built
define("require exports ../../../../../core/mathUtils ../../../../../core/Quantity ../../../../../core/libs/earcut/earcut ../../../../../core/libs/gl-matrix-2/vec2 ../../../../../core/libs/gl-matrix-2/vec2f64 ../../../../../core/libs/gl-matrix-2/vec3 ../../../../../core/libs/gl-matrix-2/vec3f64 ../../../../../core/libs/gl-matrix-2/vec4f64 ../../../../../geometry/SpatialReference ../../../../../geometry/support/geodesicConstants ../../../../../geometry/support/intersects ../support/measurementUtils ../support/viewUtils ../../../support/mathUtils ../../../support/pointUtils ../../../support/projectionUtils".split(" "),
function(K,L,F,u,v,y,x,k,e,G,H,I,C,t,D,z,q,r){function E(e,a){for(var c=new Float64Array(e.length*a),d=0;d<e.length;++d)for(var b=e[d],f=0;f<a;++f)c[d*a+f]=b[f];return c}return function(){function g(){this.positionsWorldCoords=[];this.positionsRenderCoords=[];this.positionsProjectedWorldCoords=[];this.positionsFittedRenderCoords=[];this.positionsGeographic=[];this.positionsSpherical=[];this.positionsStereographic=[];this.pathSegmentLengths=[];this.geodesicPathSegmentLengths=[];this.perimeterSegmentLengths=
[];this.intersectingSegments=new Set;this.geodesicIntersectingSegments=new Set;this.areaCentroidWorldCoords=e.vec3f64.create();this.areaCentroidRenderCoords=e.vec3f64.create();this.geodesicAreaCentroidRenderCoords=e.vec3f64.create();this._length=0;this._centroidRenderCoords=e.vec3f64.create();this._planeWorldCoords=G.vec4f64.create();this._worldUp=e.vec3f64.create();this._worldTangent=e.vec3f64.create();this._frame=[e.vec3f64.create(),e.vec3f64.create(),e.vec3f64.create()];this._tempU=e.vec3f64.create();
this._tempV=e.vec3f64.create();this._tempVec3=e.vec3f64.create();this._tempSphere={center:e.vec3f64.create(),radius:0}}g.prototype.update=function(a,c,d,b,f,e,g,n){c.clear();this._resize(a.length);c=r.canProject(d.spatialReference,r.SphericalECEFSpatialReference)&&r.canProjectToWGS84ComparableLonLat(d.spatialReference);for(var J=this.positionsGeographic,l=this.positionsWorldCoords,h=this.positionsRenderCoords,A=this.positionsSpherical,m=0;m<a.length;++m){var p=a.vertex(m);q.pointToVector(p,l[m],g);
q.pointToVector(p,h[m],e);c&&(q.pointToWGS84ComparableLonLat(p,J[m]),q.pointToVector(p,A[m],r.SphericalECEFSpatialReference),k.vec3.normalize(A[m],A[m]))}a=this._updatePathLengths(f);this.pathLength=0<this._length?new u(b.normalizeDistance(a),"meters"):null;c?(a=this._updateGeodesicPathLengths(f),this.geodesicPathLength=0<this._length?new u(a,"meters"):null):this.geodesicPathLength=null;f?(this._updateArea(d,b,e,g,n),c&&this._updateGeodesicArea(d)):(this.geodesicTriangleIndices=this.triangleIndices=
this.perimeterLength=this.geodesicArea=this.area=null,this.intersectingSegments.clear(),this.geodesicIntersectingSegments.clear())};g.prototype._resize=function(a){a<this._length&&(this.positionsWorldCoords.length=a,this.positionsRenderCoords.length=a,this.positionsProjectedWorldCoords.length=a,this.positionsFittedRenderCoords.length=a,this.positionsGeographic.length=a,this.positionsSpherical.length=a,this.positionsStereographic.length=a,this.pathSegmentLengths.length=a,this.geodesicPathSegmentLengths.length=
a,this._length=this.perimeterSegmentLengths.length=a);for(;this._length<a;)this.positionsWorldCoords.push(e.vec3f64.create()),this.positionsRenderCoords.push(e.vec3f64.create()),this.positionsProjectedWorldCoords.push(x.vec2f64.create()),this.positionsFittedRenderCoords.push(e.vec3f64.create()),this.positionsGeographic.push(e.vec3f64.create()),this.positionsSpherical.push(e.vec3f64.create()),this.positionsStereographic.push(x.vec2f64.create()),this.pathSegmentLengths.push(0),this.geodesicPathSegmentLengths.push(0),
this.perimeterSegmentLengths.push(0),++this._length};g.prototype._updatePathLengths=function(a){for(var c=this.positionsWorldCoords,d=this.pathSegmentLengths,b=0,f=0;f<this._length;++f){var e=d[f]=k.vec3.distance(c[f],c[(f+1)%this._length]);if(f<this._length-1||a)b+=e}return b};g.prototype._updateGeodesicPathLengths=function(a){for(var c=this.positionsGeographic,d=this.geodesicPathSegmentLengths,b=0,f=0;f<this._length;++f){var e=d[f]=t.segmentLengthGeodesicVector(c[f],c[(f+1)%this._length]);if(f<
this._length-1||a)b+=e}return b};g.prototype._updateArea=function(a,c,d,b,f){var e=a.renderCoordsHelper;a=this.positionsWorldCoords;var g=this.positionsRenderCoords,n=this.positionsProjectedWorldCoords,q=this.positionsFittedRenderCoords,l=this._planeWorldCoords,h=this._centroidRenderCoords;D.midpoint(g,h);e.worldUpAtPosition(h,this._worldUp);e.worldBasisAtPosition(h,0,this._worldTangent);r.transformDirection(h,this._worldUp,d,this._worldUp,b);r.transformDirection(h,this._worldTangent,d,this._worldTangent,
b);t.bestFitPlane(a,l);this.fittingMode=this._selectFittingMode(l,a,this._worldUp,f);var v=0;if("horizontal"===this.fittingMode){var m=-Infinity;g.forEach(function(a,b){a=e.getAltitude(g[b]);a>m&&(m=a,v=b)})}f=a[v];var h=l,p=this._worldTangent;"horizontal"===this.fittingMode?h=this._worldUp:"vertical"===this.fittingMode&&(h=this._tempVec3,p=this._worldUp,z.makeOrthonormal(l,this._worldUp,h));k.vec3.copy(this._frame[2],h);z.makeOrthonormal(p,h,this._frame[0]);k.vec3.cross(this._frame[1],this._frame[0],
this._frame[2]);k.vec3.negate(this._frame[1],this._frame[1]);for(var l=this._tempVec3,h=this._tempU,p=this._tempV,w=0;w<this._length;++w){var B=n[w],x=q[w];k.vec3.subtract(l,a[w],f);y.vec2.set(B,k.vec3.dot(this._frame[0],l),k.vec3.dot(this._frame[1],l));k.vec3.scale(h,this._frame[0],B[0]);k.vec3.scale(p,this._frame[1],B[1]);k.vec3.add(l,h,p);k.vec3.add(l,l,f);r.vectorToVector(l,b,x,d)}this.perimeterLength=0<this._length?new u(c.normalizeDistance(this._updatePerimeterLengths()),"meters"):null;D.midpoint(q,
this.areaCentroidRenderCoords);r.vectorToVector(this.areaCentroidRenderCoords,d,this.areaCentroidWorldCoords,b);this._updateIntersectingSegments();this.area=0===this.intersectingSegments.size?new u(c.normalizeArea(this._computeArea()),"square-meters"):null};g.prototype._updateGeodesicArea=function(a){a=a.renderCoordsHelper;var c=this.positionsSpherical,d=this.positionsStereographic,b=this._tempVec3,f=t.fitHemisphere(c,b);if(f){var e=this._tempU,g=this._tempV;z.tangentFrame(b,e,g);for(var n=0;n<this._length;++n){var q=
k.vec3.dot(c[n],e),l=k.vec3.dot(c[n],g),h=k.vec3.dot(c[n],b);y.vec2.set(d[n],q/h,l/h)}k.vec3.scale(b,b,I.earthRadius);a.toRenderCoords(b,r.SphericalECEFSpatialReference,this.geodesicAreaCentroidRenderCoords);this._updateGeodesicIntersectingSegments();this.geodesicArea=f&&0===this.geodesicIntersectingSegments.size?new u(this._computeGeodesicArea(),"square-meters"):null}else this.geodesicArea=null};g.prototype._updatePerimeterLengths=function(){for(var a=this.positionsProjectedWorldCoords,c=this.perimeterSegmentLengths,
d=0,b=0;b<this._length;++b)var e=c[b]=y.vec2.distance(a[b],a[(b+1)%this._length]),d=d+e;return d};g.prototype._updateIntersectingSegments=function(){var a=this.positionsProjectedWorldCoords,c=this.intersectingSegments;c.clear();for(var d=0;d<this._length;++d)for(var b=d+2;b<this._length;++b)(b+1)%this._length!==d&&C.segmentIntersects(a[d],a[(d+1)%this._length],a[b],a[(b+1)%this._length])&&(c.add(d),c.add(b))};g.prototype._computeArea=function(){for(var a=this.positionsProjectedWorldCoords,c=E(a,2),
c=this.triangleIndices=new Uint32Array(v.earcut(c,[],2)),d=0,b=0;b<c.length;b+=3)d+=t.triangleAreaEuclidean(a[c[b]],a[c[b+1]],a[c[b+2]]);return d};g.prototype._updateGeodesicIntersectingSegments=function(){var a=this.positionsStereographic,c=this.geodesicIntersectingSegments;c.clear();for(var d=0;d<this._length;++d)for(var b=d+2;b<this._length;++b)(b+1)%this._length!==d&&C.segmentIntersects(a[d],a[(d+1)%this._length],a[b],a[(b+1)%this._length])&&(c.add(d),c.add(b))};g.prototype._computeGeodesicArea=
function(){for(var a=this.positionsGeographic,c=E(this.positionsStereographic,2),c=this.geodesicTriangleIndices=new Uint32Array(v.earcut(c,[],2)),d=0,b=0;b<c.length;b+=3)d+=t.triangleAreaGeodesic(a[c[b]],a[c[b+1]],a[c[b+2]],H.WGS84);return d};g.prototype._selectFittingMode=function(a,c,d,b){var e=c.map(function(b){return Math.abs(t.planePointDistance(a,b))}).reduce(function(a,b){return Math.max(a,b)},0);t.boundingSphere(c,this._tempSphere);c=e/(2*this._tempSphere.radius);var e=c<b.maxRelativeErrorAlmostCoplanar,
g="horizontal";c<b.maxRelativeErrorCoplanar?g="oblique":e&&(g=Math.abs(k.vec3.dot(d,a))>Math.cos(F.deg2rad(b.verticalAngleThreshold))?"horizontal":"vertical");return g};return g}()});