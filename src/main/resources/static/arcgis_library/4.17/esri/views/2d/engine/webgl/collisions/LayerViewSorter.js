// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.17/esri/copyright.txt for details.
//>>built
define(["require","exports","../../../../../core/Error","../../../../../core/Logger"],function(h,g,l,m){function k(b){return"esri.views.2d.layers.FeatureLayerView2D"===b.declaredClass||"esri.views.2d.layers.StreamLayerView2D"===b.declaredClass}Object.defineProperty(g,"__esModule",{value:!0});g.LayerViewSorter=void 0;var n=m.getLogger("esri.views.2d.engine.collisions.LayerViewSorter");h=function(){function b(a,c){this.registerLayer=a;this.unregisterLayer=c;this._layerViewState=new Map}b.prototype.findIndex=
function(a){return a.view.allLayerViews.findIndex(function(c){return c.uid===a.uid})};b.prototype.update=function(a){for(var c=a.added,e=0,d=a.removed;e<d.length;e++)a=d[e],k(a)&&this._layerViewState.has(a)&&this._deleteState(a);for(e=0;e<c.length;e++){a=c[e];if(d=k(a))a:if(a.layer&&a.layer.renderer)switch(a.layer.renderer.type){case "class-breaks":case "simple":case "unique-value":case "dictionary":case "dot-density":d=!0;break a;default:n.error(new l("mapview-labeling","Renderer of type "+a.layer.renderer.type+
" does not currently support labeling")),d=!1}else d=!1;d&&!this._layerViewState.has(a)&&this._createState(a)}this._recomputeOrder()};b.prototype.destroy=function(){this._layerViewState.forEach(function(a){return a.handles.forEach(function(a){return a.remove()})})};b.prototype._createState=function(a){var c={priority:-1,handles:null};c.handles=[a.layer.watch("visible",this._recomputeOrder.bind(this)),a.layer.watch("labelsVisible",this._recomputeOrder.bind(this)),a.layer.watch("labelingInfo",this._recomputeOrder.bind(this)),
a.layer.watch("featureReduction",this._recomputeOrder.bind(this))];this._layerViewState.set(a,c);return c};b.prototype._deleteState=function(a){if(this._layerViewState.has(a)){var c=this._layerViewState.get(a);c.handles.forEach(function(a){return a.remove()});-1!==c.priority&&this.unregisterLayer(a);this._layerViewState.delete(a)}};b.prototype._recomputeOrder=function(){var a=this;this._layerViewState.forEach(function(c,e){var d=e.view.map.allLayers.findIndex(function(a){return a.uid===e.layer.uid}),
b=e.layer,f=b.featureReduction,f=f&&"cluster"===f.type&&f.labelsVisible&&f.labelingInfo&&f.labelingInfo.length,f=b.labelsVisible&&b.labelingInfo&&b.labelingInfo.length||f,d=b.visible&&f?4294967295-d:-1;d!==c.priority&&(c.priority=d,a.unregisterLayer(e),-1!==d&&a.registerLayer(e,d))})};return b}();g.LayerViewSorter=h});