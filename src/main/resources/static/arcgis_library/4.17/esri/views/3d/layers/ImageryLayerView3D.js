// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.17/esri/copyright.txt for details.
//>>built
define("require exports tslib ../../../core/promiseUtils ../../../core/watchUtils ../../../core/accessorSupport/decorators ./DynamicLayerView3D ../../layers/ImageryLayerView".split(" "),function(r,t,b,k,m,n,p,q){return function(e){function c(){var a=null!==e&&e.apply(this,arguments)||this;a.updateWhenStationary=!0;a.redrawDebounced=k.debounce(function(d){return b.__awaiter(a,void 0,void 0,function(){var a=this;return b.__generator(this,function(b){this.redraw(function(d,b){return a.redrawImage(d,
{signal:b})},d);return[2]})})},2E3);return a}b.__extends(c,e);c.prototype.initialize=function(){var a=this;this.handles.add([m.whenOnce(this.view.basemapTerrain,"ready",function(){return a.initializeMaximumDataResolution()}),this.layer.on("redraw",function(){return a.redrawDebounced()})]);this.updatingHandles.add(this.layer,"exportImageServiceParameters.version",function(){a.updatingHandles.addPromise(a.refreshDebounced())});this.updatingHandles.add(this,"timeExtent",function(){return a.updatingHandles.addPromise(a.refreshDebounced())})};
c.prototype.initializeMaximumDataResolution=function(){var a=this.view.basemapTerrain.spatialReference,d=this.layer.fullExtent;d&&a.equals(d.spatialReference)&&(this.maximumDataResolution={x:this.layer.pixelSizeX,y:this.layer.pixelSizeY})};c.prototype.getFetchOptions=function(){return{timeExtent:this.timeExtent}};c.prototype.processResult=function(a,d,c){return b.__awaiter(this,void 0,void 0,function(){return b.__generator(this,function(b){switch(b.label){case 0:if(!d.imageElement)return[3,1];a.image=
d.imageElement;return[3,3];case 1:return a.image=document.createElement("canvas"),a.pixelData=d.pixelData,[4,this.redrawImage(a,{signal:c})];case 2:b.sent(),b.label=3;case 3:return[2]}})})};c.prototype.redrawImage=function(a,d){return b.__awaiter(this,void 0,void 0,function(){var c,e,l,g,f,h;return b.__generator(this,function(b){switch(b.label){case 0:if(!(a.image instanceof HTMLCanvasElement&&a.pixelData))return[2,k.reject()];c=a.image;e=c.getContext("2d");return[4,this.layer.applyRenderer(a.pixelData,
d)];case 1:return l=b.sent(),g=this.layer.applyFilter(l),f=g.pixelBlock,c.width=f.width,c.height=f.height,h=e.createImageData(f.width,f.height),h.data.set(g.pixelBlock.getAsRGBA()),e.putImageData(h,0,0),[2]}})})};return c=b.__decorate([n.subclass("esri.views.3d.layers.ImageryLayerView3D")],c)}(q.ImageryLayerView(p))});