// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.17/esri/copyright.txt for details.
//>>built
define("require exports tslib ../../../../Color ../../../../core/maybe ../../../../core/screenUtils ../../../../core/libs/earcut/earcut ../../../../core/libs/gl-matrix-2/mat4f64 ../../../../geometry/support/aaBoundingBox ./ElevationAligners ./elevationAlignmentUtils ./ElevationContext ./Graphics3DDrapedGraphicLayer ./Graphics3DObject3DGraphicLayer ./Graphics3DSymbolLayer ./graphicUtils ./lineUtils ./polygonUtils ../support/patternUtils ../support/uvUtils ../../support/buffer/BufferView ../../webgl-engine/lib/Geometry ../../webgl-engine/lib/Object3D ../../webgl-engine/lib/RenderGeometry ../../webgl-engine/lib/Util ../../webgl-engine/materials/lineStippleUtils ../../webgl-engine/materials/NativeLineMaterial ../../webgl-engine/materials/PatternMaterial ../../webgl-engine/materials/RibbonLineMaterial".split(" "),
function(t,n,u,w,h,x,y,z,l,E,p,F,G,H,I,J,A,r,K,B,q,C,L,D,M,N,v,O,P){Object.defineProperty(n,"__esModule",{value:!0});n.Graphics3DPolygonFillSymbolLayer=void 0;t=function(n){function f(a,b,k,c){a=n.call(this,a,b,k,c)||this;a._needsUV=!1;a._hasOutline=!1;return a}u.__extends(f,n);f.prototype.doLoad=function(){return u.__awaiter(this,void 0,void 0,function(){return u.__generator(this,function(a){return[2]})})};f.prototype.ensureMaterials=function(){this.ensureFillMaterial();this.ensureOutlineMaterial()};
f.prototype.ensureFillMaterial=function(){if(!h.isSome(this._material)){var a=h.get(this.symbolLayer,"material","color"),a=this._getCombinedOpacityAndColor(a);this._material=K.createMaterial(this.symbolLayer,{color:a,transparent:1>a[3]||this.needsDrivenTransparentPass,polygonOffset:!1,vertexColors:!0,slicePlaneEnabled:this._context.slicePlaneEnabled},{isDraped:this.draped,idHint:this._getIdHint()});this._needsUV=this._material instanceof O;this._context.stage.add(3,this._material)}};f.prototype.ensureOutlineMaterial=
function(){var a=this.symbolLayer.outline;if(!h.isSome(this._outlineMaterial)&&this._isValidOutline(a)){this._hasOutline=!0;var b;b=x.pt2px(a.size);var k=a.stipplePattern?N.createStipplePattern(a.stipplePattern.map(x.pt2px)):null,a=a.stippleOffColor?w.toUnitRGBA(a.stippleOffColor):null;b=1.5<b?new P({width:b,color:this._getOutlineColor(),polygonOffset:!0,slicePlaneEnabled:this._context.slicePlaneEnabled,isClosed:!0,stipplePattern:k,stippleIntegerRepeats:!0,stippleOffColor:a},this._getIdHint("_outline_ribbonlinemat")):
new v({color:this._getOutlineColor(),slicePlaneEnabled:this._context.slicePlaneEnabled,width:b,stipplePattern:k,stippleIntegerRepeats:!0,stippleOffColor:a},this._getIdHint("_outline_nativelinemat"));this._outlineMaterial=b;this._context.stage.add(3,this._outlineMaterial)}};f.prototype._isValidOutline=function(a){return h.isSome(a)&&a.size&&0<a.size&&h.isSome(a.color)};f.prototype.destroy=function(){n.prototype.destroy.call(this);h.isSome(this._material)&&(this._context.stage.remove(3,this._material.id),
this._material=null);h.isSome(this._outlineMaterial)&&(this._context.stage.remove(3,this._outlineMaterial.id),this._outlineMaterial=null)};f.prototype.createGraphics3DGraphic=function(a){var b=a.graphic;if(!this._validateGeometryType(b.geometry,f.validGeometryTypes,this.symbolLayer.type)||!this._validateGeometry(b.geometry))return null;var k="graphic"+b.uid;a=this._getVertexOpacityAndColor(a.renderingInfo,Uint8Array,255);var c=this.setGraphicElevationContext(b,new F.ElevationContext);this.ensureDrapedStatus("on-the-ground"===
c.mode);this.ensureMaterials();return this.draped?this._createAsOverlay(b,a,k):this._createAs3DShape(b,a,c,k)};f.prototype.layerOpacityChanged=function(){if(h.isSome(this._material)){var a=this._material.getParameters().color,b=h.get(this.symbolLayer,"material","color"),b=this._getCombinedOpacity(b);this._material.setParameterValues({color:[a[0],a[1],a[2],b],transparent:1>b||this.needsDrivenTransparentPass})}h.isSome(this._outlineMaterial)&&(a=this._outlineMaterial.getParameters().color,this._outlineMaterial.setParameterValues({color:[a[0],
a[1],a[2],this._getOutlineOpacity()]}));return!0};f.prototype.layerElevationInfoChanged=function(a,b,k){var c=this._elevationContext.mode;k=p.elevationModeChangeUpdateType(f.elevationModeChangeTypes,k,c);if(k!==p.SymbolUpdateType.UPDATE)return k;var e=p.needsElevationUpdates2D(c);return this.updateGraphics3DGraphicElevationInfo(a,b,function(){return e})};f.prototype.slicePlaneEnabledChanged=function(){h.isSome(this._material)&&this._material.setParameterValues({slicePlaneEnabled:this._context.slicePlaneEnabled});
h.isSome(this._outlineMaterial)&&this._outlineMaterial.setParameterValues({slicePlaneEnabled:this._context.slicePlaneEnabled});return!0};f.prototype.physicalBasedRenderingChanged=function(){return!0};f.prototype.pixelRatioChanged=function(){return!0};f.prototype._createAs3DShape=function(a,b,k,c){var e=r.geometryAsPolygon(a.geometry);if(h.isNone(e))return null;d.renderData=r.geometryToRenderInfo(e,this._context.elevationProvider,this._context.renderCoordsHelper,k);d.idHint=c;d.color=b;b=d.renderData.position.length/
3;this._needsUV&&(d.uvMapSpace=new Float32Array(4*b),d.bound1=new Float64Array(3*b),d.bound2=new Float64Array(3*b),d.bound3=new Float64Array(3*b));d.outNum=0;d.outGeometries=[];d.outTransforms=[];d.outMaterials=[];this._createAs3DShapeFill(d);this._hasOutline&&this._createAs3DShapeOutline(d);this._logGeometryCreationWarnings(d.renderData,e.rings,"rings","FillSymbol3DLayer");if(0===d.outNum)return null;this._needsUV&&B.createMapSpaceUVCoords(q.BufferViewVec4f.fromTypedArray(d.uvMapSpace),q.BufferViewVec3f64.fromTypedArray(d.renderData.position),
this._context.layerView.view.renderCoordsHelper,q.BufferViewVec3f64.fromTypedArray(d.bound1),q.BufferViewVec3f64.fromTypedArray(d.bound2),q.BufferViewVec3f64.fromTypedArray(d.bound3));a=new L({geometries:d.outGeometries,materials:d.outMaterials,transformations:d.outTransforms,castShadow:!1,metadata:{layerUid:this._context.layer.uid,graphicUid:a.uid},idHint:c});a=new H(this,a,d.outGeometries,null,null,E.perVertexElevationAligner,k);a.alignedSampledElevation=d.renderData.sampledElevation;a.needsElevationUpdates=
p.needsElevationUpdates2D(k.mode);return a};f.prototype._createAs3DShapeFill=function(a){for(var b=0,k=a.renderData.polygons;b<k.length;b++){var c=k[b],e=c.position,f=c.mapPosition,d=c.holeIndices,g=c.index,c=c.count;if(h.isSome(this._context.clippingExtent)&&(l.empty(m),l.expandWithBuffer(m,f),!l.intersectsClippingArea(m,this._context.clippingExtent)))continue;d=y.earcut(f,d,3);0!==d.length&&(d=new Uint32Array(d),e=r.createColorGeometryData({indices:d,attributeData:{position:e,color:a.color,mapPosition:f,
uvMapSpace:this._needsUV?new Float32Array(a.uvMapSpace.buffer,4*g*a.uvMapSpace.BYTES_PER_ELEMENT,4*c):null,bound1:this._needsUV?new Float64Array(a.bound1.buffer,3*g*a.bound1.BYTES_PER_ELEMENT,3*c):null,bound2:this._needsUV?new Float64Array(a.bound2.buffer,3*g*a.bound2.BYTES_PER_ELEMENT,3*c):null,bound3:this._needsUV?new Float64Array(a.bound3.buffer,3*g*a.bound3.BYTES_PER_ELEMENT,3*c):null}}),e=new C(e,a.idHint),a.outGeometries.push(e),a.outMaterials.push(h.unwrap(this._material)),a.outTransforms.push(z.mat4f64.IDENTITY),
a.outNum++)}};f.prototype._createAs3DShapeOutline=function(a){if(this._hasOutline)for(var b=a.renderData.outlines,k=this._outlineMaterial instanceof v,c=0;c<b.length;++c){var e=b[c],d=e.mapPosition,e=e.position;if(h.isSome(this._context.clippingExtent)&&(l.empty(m),l.expandWithBuffer(m,d),!l.intersectsClippingArea(m,this._context.clippingExtent)))continue;var d=A.createGeometryData({removeDuplicateStartEnd:k?0:1,attributeData:{position:e,mapPosition:d}}),f=d.vertexAttributes[M.VertexAttrConstants.POSITION];
f.data===e&&(f.data=new Float64Array(e));e=new C(d,a.idHint+"outline"+c);a.outGeometries.push(e);a.outMaterials.push(h.unwrap(this._outlineMaterial));a.outTransforms.push(z.mat4f64.IDENTITY);a.outNum++}};f.prototype._createAsOverlay=function(a,b,d){var c=r.geometryAsPolygon(a.geometry);if(h.isNone(c))return null;h.unwrap(this._material).renderPriority=this._renderPriority+this._renderPriorityStep/2;h.isSome(this._outlineMaterial)&&(this._outlineMaterial.renderPriority=this._renderPriority);g.renderData=
r.geometryToRenderInfoDraped(c,this._context.overlaySR);g.idHint=d;g.color=b;b=g.renderData.position.length/3;this._needsUV&&(g.uvMapSpace=new Float32Array(4*b));g.outNum=0;g.outGeometries=[];g.outBoundingBox=l.empty();g.layerUid=this._context.layer.uid;g.graphicsUid=a.uid;this._createAsOverlayFill(g);this._hasOutline&&this._createAsOverlayOutline(g);this._logGeometryCreationWarnings(g.renderData,c.rings,"rings","FillSymbol3DLayer");if(0===g.outNum)return null;this._needsUV&&B.createMapSpaceUVCoordsDraped(q.BufferViewVec4f.fromTypedArray(g.uvMapSpace),
q.BufferViewVec3f64.fromTypedArray(g.renderData.position),this._context.overlaySR);return 0<g.outNum?new G(this,g.outGeometries,g.outBoundingBox):null};f.prototype._createAsOverlayFill=function(a){for(var b=0,d=a.renderData.polygons;b<d.length;b++){var c=d[b],e=c.position,f=c.holeIndices,g=c.index,c=c.count;l.empty(m);l.expandWithBuffer(m,e);l.intersectsClippingArea(m,this._context.clippingExtent)&&(f=y.earcut(e,f,3),0!==f.length&&(l.expand(a.outBoundingBox,m),f=new Uint32Array(f),e=r.createColorGeometryData({indices:f,
attributeData:{position:e,color:a.color,uvMapSpace:this._needsUV?new Float32Array(a.uvMapSpace.buffer,4*g*a.uvMapSpace.BYTES_PER_ELEMENT,4*c):null}}),e=new D(e),e.data.layerUid=a.layerUid,e.data.graphicUid=a.graphicsUid,e.material=h.unwrap(this._material),g=m,e.center=[.5*(g[0]+g[3]),.5*(g[1]+g[4]),0],e.bsRadius=.5*Math.sqrt((g[3]-g[0])*(g[3]-g[0])+(g[4]-g[1])*(g[4]-g[1])),a.outGeometries.push(e),a.outNum++))}};f.prototype._createAsOverlayOutline=function(a){if(this._hasOutline)for(var b=a.renderData.outlines,
d=0;d<b.length;++d){var c=b[d].position;l.empty(m);l.expandWithBuffer(m,c);if(l.intersectsClippingArea(m,this._context.clippingExtent)){l.expand(a.outBoundingBox,m);c=A.createGeometryData({removeDuplicateStartEnd:this._outlineMaterial instanceof v?0:1,attributeData:{position:c}});c=new D(c);c.data.layerUid=a.layerUid;c.data.graphicUid=a.graphicsUid;c.material=h.unwrap(this._outlineMaterial);var e=m;c.center=[.5*(e[0]+e[3]),.5*(e[1]+e[4]),0];c.bsRadius=.5*Math.sqrt((e[3]-e[0])*(e[3]-e[0])+(e[4]-e[1])*
(e[4]-e[1]));a.outGeometries.push(c);a.outNum++}}};f.prototype._getOutlineOpacity=function(){var a=h.get(this.symbolLayer,"outline","color");return(this.draped?1:this._getLayerOpacity())*(h.isSome(a)?a.a:0)};f.prototype._getOutlineColor=function(){var a=h.get(this.symbolLayer,"outline","color"),b=this._getOutlineOpacity();return J.mixinColorAndOpacity(h.isSome(a)?w.toUnitRGB(a):null,b)};Object.defineProperty(f.prototype,"test",{get:function(){var a=this;return{createAsOverlay:function(b,d,c){return a._createAsOverlay(b,
d,c)},createAs3DShape:function(b,d,c,e){return a._createAs3DShape(b,d,c,e)}}},enumerable:!1,configurable:!0});f.validGeometryTypes=["polyline","polygon","extent"];f.elevationModeChangeTypes={definedChanged:p.SymbolUpdateType.RECREATE,staysOnTheGround:p.SymbolUpdateType.NONE,onTheGroundChanged:p.SymbolUpdateType.RECREATE};return f}(I.default);n.Graphics3DPolygonFillSymbolLayer=t;var m=l.create(),d={idHint:null,renderData:null,color:null,uvMapSpace:null,bound1:null,bound2:null,bound3:null,outNum:0,
outBoundingBox:null,outGeometries:null,outMaterials:null,outTransforms:null},g={idHint:null,renderData:null,color:null,uvMapSpace:null,outNum:0,outBoundingBox:null,outGeometries:null,outMaterials:null,outTransforms:null};n.default=t});