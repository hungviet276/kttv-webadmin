// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.17/esri/copyright.txt for details.
//>>built
define("require exports tslib ../../../../../geometry ../../../../../core/Evented ../../../../../core/Handles ../../../../../core/maybe ../../../../../core/screenUtils ../../../../../core/accessorSupport/decorators ../coordinateHelper ./DrawManipulator ./drawSurfaces ../editGeometry/EditGeometryHelper ../../../../interactive/dragEventPipeline".split(" "),function(k,g,f,m,n,p,d,q,r,t,u,v,h,w){Object.defineProperty(g,"__esModule",{value:!0});g.DrawOperation=void 0;k=function(g){function c(b){var a=
g.call(this)||this;a._manipulator=null;a._stagedVertex=null;a.drawingMode="hybrid";a.geometryType=null;a.elevationInfo=null;a.snappingEnabled=null;a._handles=new p;a._defaultZ=0;a._elevationDrawSurface=null;a._snappingDrawSurface=null;a._createOperationCompleted=!1;a.view=b.view;a.drawingMode=b.drawingMode;a.geometryType=b.geometryType;a.elevationInfo=b.elevationInfo;a.coordinateHelper=t.createCoordinateHelper(b.hasZ,b.hasM,a.view.spatialReference,a.view.viewingMode);a._defaultZ=b.defaultZ;a.snappingEnabled=
b.snappingEnabled;a._snappingDrawSurface=d.unwrap(b.snappingDrawSurface);a._elevationDrawSurface=new v.ElevationDrawSurface(a.elevationInfo,a._defaultZ,a.view);a._editGeometry=new h.EditGeometryHelper(new h.EditGeometry(a.coordinateHelper),"segment"===a.geometryType?"polyline":a.geometryType);a._activeComponent=new h.Component(a._editGeometry.data);a._editGeometry.data.components.push(a._activeComponent);a._editGeometry.on(["vertex-add","vertex-update","vertex-remove"],function(b){var c=b.vertices.map(function(b){return{componentIndex:0,
vertexIndex:b.index,coordinates:a.coordinateHelper.toArray(b.pos)}}),e=c.map(function(a){return a.coordinates});switch(b.type){case "vertex-add":a.emit(b.type,f.__assign(f.__assign({},b),{added:e,vertices:c}));break;case "vertex-update":a.emit(b.type,f.__assign(f.__assign({},b),{updated:e,vertices:c}));break;case "vertex-remove":a.emit(b.type,f.__assign(f.__assign({},b),{removed:e,vertices:c}))}});a._manipulator=new u.DrawManipulator;b.manipulators.add(a._manipulator);a._manipulator.grabbable="point"!==
a.geometryType;b=w.createManipulatorDragEventPipeline(a._manipulator,function(b,c,e,d){"click"===a.drawingMode||a.isCompleted||(c.next(a._screenToMapDragEventStep()).next(function(b){"start"===b.action&&(a.stagedVertex=b.mapStart,"segment"!==a.geometryType&&"hybrid"!==a.drawingMode||a.commitStagedVertex());return b}).next(function(b){switch(b.action){case "start":case "update":switch(a.drawingMode){case "freehand":case "hybrid":a.stagedVertex=b.mapEnd,"polygon"!==a.geometryType&&"polyline"!==a.geometryType||
a.commitStagedVertex()}break;case "end":"freehand"!==a.drawingMode&&"segment"!==a.geometryType&&"point"!==a.geometryType||a.complete()}return b}),e.next(function(a){}))});var c=a._manipulator.events.on("immediate-double-click",function(b){a.complete();b.stopPropagation()}),x=a._manipulator.events.on("immediate-click",function(b){var c=a._activeComponent,e=a._closeOnClickVertexIndex(b.screenPoint);if(d.isSome(e))a.discardStagedVertex(),a.complete();else if(e=a._screenToMap(b.screenPoint),d.isSome(e))switch(a.drawingMode){case "click":case "hybrid":a.discardStagedVertex(),
a._editGeometry.appendVertex(a.coordinateHelper.fromPoint(e)),("point"===a.geometryType||"segment"===a.geometryType&&2===c.vertices.length||"segment"===a.geometryType&&"hybrid"===a.drawingMode&&1===c.vertices.length)&&a.complete()}b.stopPropagation()});a._handles.add([b,x,c]);return a}f.__extends(c,g);Object.defineProperty(c.prototype,"isCompleted",{get:function(){return this._createOperationCompleted},enumerable:!1,configurable:!0});c.prototype.destroy=function(){this._handles.destroy();this._handles=
null};c.prototype.onInputEvent=function(b){if(!(this._manipulator.dragging||this._manipulator.grabbing&&"pointer-move"===b.type))switch(b.type){case "pointer-move":var a=q.createScreenPoint(b.x,b.y),c=this._closeOnClickVertexIndex(a);d.isSome(c)?(this.discardStagedVertex(),a={componentIndex:0,vertexIndex:c,coordinates:this.coordinateHelper.toArray(this._activeComponent.vertices[c].pos)},this.emit("cursor-update",{updated:null,vertices:[a],operation:"apply",type:"vertex-update"})):(a=this._screenToMap(a),
d.isSome(a)?(this.stagedVertex=a,this._manipulator.cursor="crosshair"):this._manipulator.cursor=null);b.stopPropagation()}};Object.defineProperty(c.prototype,"canRedo",{get:function(){return this._editGeometry.canRedo},enumerable:!1,configurable:!0});c.prototype.redo=function(){this._editGeometry.redo()};Object.defineProperty(c.prototype,"canUndo",{get:function(){return this._editGeometry.canUndo},enumerable:!1,configurable:!0});c.prototype.undo=function(){this._editGeometry.undo()};c.prototype.complete=
function(b){void 0===b&&(b=!1);this.commitStagedVertex();this._createOperationCompleted=!0;this.emit("complete",{vertices:this.vertices.map(function(a,b){return{componentIndex:0,vertexIndex:b,coordinates:a}}),aborted:b,type:"complete"})};c.prototype.cancel=function(){this.complete(!0)};Object.defineProperty(c.prototype,"interactive",{get:function(){return this._manipulator.interactive},set:function(b){this._manipulator.interactive=b},enumerable:!1,configurable:!0});Object.defineProperty(c.prototype,
"numVertices",{get:function(){return d.isSome(this._stagedVertex)?this._activeComponent.vertices.length+1:this._activeComponent.vertices.length},enumerable:!1,configurable:!0});Object.defineProperty(c.prototype,"numCommittedVertices",{get:function(){return this._activeComponent.vertices.length},enumerable:!1,configurable:!0});Object.defineProperty(c.prototype,"vertices",{get:function(){var b=this,a=this._activeComponent.vertices.map(function(a){return b.coordinateHelper.toArray(a.pos)});d.isSome(this._stagedVertex)&&
a.push(this.coordinateHelper.pointToArray(this._stagedVertex));return a},enumerable:!1,configurable:!0});Object.defineProperty(c.prototype,"spatialReference",{get:function(){return this.view.spatialReference},enumerable:!1,configurable:!0});Object.defineProperty(c.prototype,"hasStagedVertex",{get:function(){return d.isSome(this._stagedVertex)},enumerable:!1,configurable:!0});Object.defineProperty(c.prototype,"stagedVertex",{get:function(){return this._stagedVertex},set:function(b){d.isNone(b)?this.discardStagedVertex():
(this._stagedVertex=b,b={componentIndex:0,vertexIndex:this._activeComponent.vertices.length,coordinates:this.coordinateHelper.pointToArray(b)},this.emit("cursor-update",{updated:null,vertices:[b],operation:"apply",type:"vertex-update"}))},enumerable:!1,configurable:!0});c.prototype.commitStagedVertex=function(){if(d.isSome(this._stagedVertex)){var b=this._stagedVertex;this._stagedVertex=null;this._editGeometry.appendVertex(this.coordinateHelper.fromPoint(b))}};c.prototype.discardStagedVertex=function(){this._stagedVertex=
null};c.prototype._screenToMapDragEventStep=function(){var b=this,a=null;return function(c){"start"===c.action&&(a=b._screenToMap(c.screenStart));if(d.isNone(a))return null;var e=b._screenToMap(c.screenEnd);return d.isSome(e)?f.__assign(f.__assign({},c),{mapStart:a,mapEnd:e}):null}};c.prototype._screenToMap=function(b){return this._getDrawSurface().screenToMap(b)};c.prototype._mapToScreen=function(b){return this._getDrawSurface().mapToScreen(b)};c.prototype._getDrawSurface=function(){var b=null;if(this.coordinateHelper.hasZ){var b=
this._defaultZ,a=!1;d.isSome(this.elevationInfo)&&"absolute-height"===this.elevationInfo.mode&&(a=!0);d.isSome(this.snappingEnabled)&&(a=this.snappingEnabled);d.isSome(this.elevationInfo)&&"on-the-ground"===this.elevationInfo.mode&&(a=!1);var c=this._activeComponent.vertices.length;("segment"===this.geometryType||"polygon"===this.geometryType)&&0<c&&(b=this.coordinateHelper.zFromArray(this._activeComponent.vertices[0].pos),a=!1);a?b=this._snappingDrawSurface:(this._elevationDrawSurface.defaultZ=b,
b=this._elevationDrawSurface)}else this._elevationDrawSurface.defaultZ=null,b=this._elevationDrawSurface;return b};c.prototype._vertexWithinPointerDistance=function(b,a){var c=this._mapToScreen(b);d.isSome(c)?(b=c.x-a.x,a=c.y-a.y,a=25>=b*b+a*a):a=!1;return a};c.prototype._closeOnClickVertexIndex=function(b){var a=this._activeComponent;if("polygon"===this.geometryType&&2<a.vertices.length){if(this._vertexWithinPointerDistance(this.coordinateHelper.toPoint(a.vertices[0].pos,l),b))return 0;if(this._vertexWithinPointerDistance(this.coordinateHelper.toPoint(a.vertices[a.vertices.length-
1].pos,l),b))return a.vertices.length-1}return null};return c=f.__decorate([r.subclass("esri.views.3d.interactive.editingTools.draw3D.DrawOperation")],c)}(n);g.DrawOperation=k;var l=new m.Point({x:0,y:0,z:0})});