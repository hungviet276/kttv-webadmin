// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.17/esri/copyright.txt for details.
//>>built
define(["require","exports","../../../core/maybe","./TileCoverage","./TileKey"],function(h,e,k,t,q){Object.defineProperty(e,"__esModule",{value:!0});e.TileManager=void 0;h=function(){function c(a){this._tiles=new Map;this.buffer=0;this.acquireTile=a.acquireTile;this.releaseTile=a.releaseTile;this.tileInfoView=a.tileInfoView;this.buffer=a.buffer}c.prototype.destroy=function(){};c.prototype.clear=function(){var a=this;this._tiles.forEach(function(b){return a._releaseTile(b)})};c.prototype.tileKeys=
function(){var a=[];this._tiles.forEach(function(b,f){return a.push(f)});return a};c.prototype.update=function(a){var b=this;a=this.tileInfoView.getTileCoverage(a.state,this.buffer,"closest");for(var f=a.spans,c=a.lodInfo,d=c.level,e=[],h=[],l=new Set,m=new Set,n=0;n<f.length;n++)for(var g=f[n],k=g.row,u=g.colTo,g=g.colFrom;g<=u;g++){var r=q.getId(d,k,c.normalizeCol(g),c.getWorldForColumn(g)),p=this._getOrAcquireTile(e,r);l.add(r);p.isReady?p.visible=!0:m.add(p.key)}m.forEach(function(a){return b._addPlaceholders(l,
a)});this._tiles.forEach(function(a){l.has(a.key.id)||(h.push(a.key.id),b._releaseTile(a))});t.pool.release(a);return{hasMissingTiles:0<m.size,added:e,removed:h}};c.prototype._getOrAcquireTile=function(a,b){if(!this._tiles.has(b)){var f=this.acquireTile(new q(b));a.push(b);this._tiles.set(b,f);f.visible=!1}return this._tiles.get(b)};c.prototype._getTile=function(a){return this._tiles.get(a)};c.prototype._releaseTile=function(a){this._tiles.delete(a.key.id);this.releaseTile(a)};c.prototype._addPlaceholders=
function(a,b){var f=this._addPlaceholderChildren(a,b);1E-6>Math.abs(1-f)||this._addPlaceholderParent(a,b)||(this._getTile(b.id).visible=!0)};c.prototype._addPlaceholderChildren=function(a,b){var f=this,c=0;this._tiles.forEach(function(d){c+=f._addPlaceholderChild(a,d,b)});return c};c.prototype._addPlaceholderChild=function(a,b,c){if(b.key.level<=c.level||!b.hasData||!c.contains(b.key))return 0;b.visible=!0;a.add(b.key.id);return 1/(1<<2*(b.key.level-c.level))};c.prototype._addPlaceholderParent=function(a,
b){b=b.getParentKey();for(var c=0,e=null;k.isSome(b);){if(a.has(b.id))return!0;var d=this._getTile(b.id);if(null===d||void 0===d?0:d.isReady)return d.visible=!0,a.add(d.key.id),!0;(null===d||void 0===d?0:d.hasData)&&d.patchCount>c&&(c=d.patchCount,e=d);b=b.getParentKey()}return e?(e.visible=!0,a.add(e.key.id),!0):!1};return c}();e.TileManager=h});