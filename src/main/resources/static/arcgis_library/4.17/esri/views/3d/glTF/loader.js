// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.17/esri/copyright.txt for details.
//>>built
define("require exports tslib ../../../core/maybe ../../../core/promiseUtils ../../../core/libs/gl-matrix-2/mat4f64 ./DefaultErrorContext ./LoaderResult ./internal/Resource".split(" "),function(M,w,r,v,C,D,E,x,F){function G(e){var a=null;e.json.nodes.forEach(function(c){c=c.extras;v.isSome(c)&&(c.ESRI_proxyEllipsoid||c.ESRI_lod)&&(a=c)});return a}function H(e,a){return r.__awaiter(this,void 0,void 0,function(){function c(f,m){return r.__awaiter(this,void 0,void 0,function(){var t,B,q,p,k,l,h,n,g;
return r.__generator(this,function(d){switch(d.label){case 0:t=b.nodes[f];B=e.getNodeTransform(f);y.warnUnsupportedIf(null!=t.weights,"Morph targets are not supported.");if(null==t.mesh)return[3,4];q=b.meshes[t.mesh];p=0;k=q.primitives;d.label=1;case 1:if(!(p<k.length))return[3,4];l=k[p];return[4,a(l,B,m,q.name)];case 2:d.sent(),d.label=3;case 3:return p++,[3,1];case 4:h=0,n=t.children||[],d.label=5;case 5:if(!(h<n.length))return[3,8];g=n[h];return[4,c(g,m)];case 6:d.sent(),d.label=7;case 7:return h++,
[3,5];case 8:return[2]}})})}var b,k,f,l,g,h,m,u,n,v;return r.__generator(this,function(a){switch(a.label){case 0:b=e.json,k=b.scenes[b.scene||0],f=k.nodes,l=1<f.length,g=0,h=f,a.label=1;case 1:if(!(g<h.length))return[3,4];m=h[g];u=b.nodes[m];n=[c(m,0)];u.extensions&&u.extensions.MSFT_lod&&Array.isArray(u.extensions.MSFT_lod.ids)&&!l&&(v=u.extensions.MSFT_lod.ids,n.push.apply(n,v.map(function(a,b){return c(a,b+1)})));return[4,C.all(n)];case 2:a.sent(),a.label=3;case 3:return g++,[3,1];case 4:return[2]}})})}
function I(e,a,c){var b=function(a){var b=c+"_tex_"+(a&&a.id)+(a&&a.name?"_"+a.name:"");if(a&&!e.textures.has(b)){var f=x.makeTextureSource(a.data,{wrap:{s:z(a.wrapS),t:z(a.wrapT)},mipmap:J.some(function(b){return b===a.minFilter}),noUnpackFlip:!0});e.textures.set(b,f)}return b},k=c+"_mat_"+a.id+"_"+a.name;e.materials.has(k)||(a=x.makeMaterialParameters({color:[a.color[0],a.color[1],a.color[2]],opacity:a.color[3],alphaMode:a.alphaMode,alphaCutoff:a.alphaCutoff,doubleSided:a.doubleSided,colorMixMode:a.ESRI_externalColorMixMode,
textureColor:a.colorTexture?b(a.colorTexture):void 0,textureNormal:a.normalTexture?b(a.normalTexture):void 0,textureOcclusion:a.occlusionTexture?b(a.occlusionTexture):void 0,textureEmissive:a.emissiveTexture?b(a.emissiveTexture):void 0,textureMetallicRoughness:a.metallicRoughnessTexture?b(a.metallicRoughnessTexture):void 0,emissiveFactor:[a.emissiveFactor[0],a.emissiveFactor[1],a.emissiveFactor[2]],metallicFactor:a.metallicFactor,roughnessFactor:a.roughnessFactor}),e.materials.set(k,a));return k}
function z(e){if(33071===e||33648===e||10497===e)return e;y.error("Unexpected TextureSampler WrapMode: "+e)}Object.defineProperty(w,"__esModule",{value:!0});w.load=void 0;var K=0;w.load=function(e,a,c){void 0===c&&(c={});return r.__awaiter(this,void 0,void 0,function(){var b,k,f,l,g=this;return r.__generator(this,function(h){switch(h.label){case 0:return[4,F.Resource.load(e,y,a,c)];case 1:return b=h.sent(),k="gltf_"+K++,f={lods:[],materials:new Map,textures:new Map,meta:G(b)},l=!(!b.json.asset.extras||
"symbolResource"!==b.json.asset.extras.ESRI_type),[4,H(b,function(a,e,n,h){return r.__awaiter(g,void 0,void 0,function(){var g,l,t,m,q,p,u,w,x,z,A;return r.__generator(this,function(d){switch(d.label){case 0:g=void 0!==a.mode?a.mode:4;a:switch(g){case 4:case 5:case 6:l=g;break a;default:l=null}return v.isNone(l)?(y.warnUnsupported("Unsupported primitive mode ("+L[g]+"). Skipping primitive."),[2]):b.hasPositions(a)?[4,b.getMaterial(a,c)]:(y.warn("Skipping primitive without POSITION vertex attribute."),
[2]);case 1:return t=d.sent(),q={transform:D.mat4f64.clone(e)},p={},[4,b.getPositionData(a,c)];case 2:return q.attributes=(p.position=d.sent(),p.normal=null,p.texCoord0=null,p.color=null,p.tangent=null,p),[4,b.getIndexData(a,c)];case 3:m=(q.indices=d.sent(),q.primitiveType=l,q.material=I(f,t,k),q);if(!b.hasNormals(a))return[3,5];u=m.attributes;return[4,b.getNormalData(a,c)];case 4:u.normal=d.sent(),d.label=5;case 5:if(!b.hasTangents(a))return[3,7];w=m.attributes;return[4,b.getTangentData(a,c)];case 6:w.tangent=
d.sent(),d.label=7;case 7:if(!b.hasTextureCoordinates(a))return[3,9];x=m.attributes;return[4,b.getTextureCoordinates(a,c)];case 8:x.texCoord0=d.sent(),d.label=9;case 9:if(!b.hasVertexColors(a))return[3,11];z=m.attributes;return[4,b.getVertexColors(a,c)];case 10:z.color=d.sent(),d.label=11;case 11:return A=null,v.isSome(f.meta)&&v.isSome(f.meta.ESRI_lod)&&"screenSpaceRadius"===f.meta.ESRI_lod.metric&&(A=f.meta.ESRI_lod.thresholds[n]),f.lods[n]=f.lods[n]||{parts:[],name:h,lodThreshold:A},f.lods[n].parts.push(m),
[2]}})})})];case 2:return h.sent(),[2,{model:f,meta:{isEsriSymbolResource:l,uri:b.uri},customMeta:{}}]}})})};var y=new E.DefaultErrorContext,J=[9987,9985],L="POINTS LINES LINE_LOOP LINE_STRIP TRIANGLES TRIANGLE_STRIP TRIANGLE_FAN".split(" ")});