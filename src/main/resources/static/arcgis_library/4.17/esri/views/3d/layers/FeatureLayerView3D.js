// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.17/esri/copyright.txt for details.
//>>built
define("require exports tslib ../../../core/compilerUtils ../../../core/Error ../../../core/promiseUtils ../../../core/watchUtils ../../../core/accessorSupport/decorators ../../../layers/graphics/hydratedFeatures ../../../layers/graphics/controllers/FeatureTileController3D ./FeatureLikeLayerView3D ./LayerView3D ./support/FeatureTileFetcher3DLayerViewContext ./support/layerViewUpdatingProperties ../support/EventedSet ../../layers/FeatureLayerView ../../layers/LayerView ../../layers/RefreshableLayerView".split(" "),
function(F,G,c,p,q,r,t,d,u,v,w,x,y,z,A,B,C,D){var E={point:5E3,polygon:500,polyline:1E3};return function(f){function b(a){a=f.call(this,a)||this;a._controllerTotal=0;a._graphicsCoreTotal=0;a.suspendResumeExtentMode="data";return a}c.__extends(b,f);b.prototype.destroy=function(){this.fetcherContext&&(this.fetcherContext.destroy(),this.fetcherContext=null)};Object.defineProperty(b.prototype,"updatingProgressValue",{get:function(){var a=1;if(this.controller&&this.controller.updating){var e=this.controller.updatingRemaining,
b=this.controller.updatingTotal;0<b&&(this._controllerTotal=Math.max(b,this._controllerTotal),a=(b-e)/b)}var c=1;this.graphics3d&&this.graphics3d.graphicsCore&&(e=this.graphics3d.graphicsCore.updatingRemaining,b=this.graphics3d.graphicsCore.updatingTotal,0<b&&(this._graphicsCoreTotal=Math.max(b,this._graphicsCoreTotal),c=(b-e)/b));1===a&&1===c&&(this._graphicsCoreTotal=this._controllerTotal=0);return.5*(a+c)},enumerable:!1,configurable:!0});Object.defineProperty(b.prototype,"maximumNumberOfFeatures",
{get:function(){var a,b;return null!==(b=null===(a=this.controller)||void 0===a?void 0:a.maximumNumberOfFeatures)&&void 0!==b?b:this._get("maximumNumberOfFeatures")},set:function(a){this._set("maximumNumberOfFeatures",a);this.controller&&(this.controller.maximumNumberOfFeatures=a)},enumerable:!1,configurable:!0});Object.defineProperty(b.prototype,"maximumNumberOfFeaturesExceeded",{get:function(){return this.controller?!(this.suspended||!this.controller.maximumNumberOfFeaturesExceeded):!1},enumerable:!1,
configurable:!0});Object.defineProperty(b.prototype,"asyncGraphicsUpdates",{get:function(){if(this.controller)switch(this.controller.mode){case "snapshot":var a=E[this.layer.geometryType];return null==a||this.controller.serviceDataCount>a;case "tiles":break;default:p.neverReached(this.controller.mode)}return!0},enumerable:!1,configurable:!0});Object.defineProperty(b.prototype,"hasZ",{get:function(){var a=this.layer,b=a.capabilities&&a.capabilities.data;return b&&b.supportsZ?"returnZ"in a&&null!=a.returnZ?
a.returnZ:b.supportsZ:!1},enumerable:!1,configurable:!0});Object.defineProperty(b.prototype,"hasM",{get:function(){var a=this.layer,b=a.capabilities&&a.capabilities.data;return b&&b.supportsM?"returnM"in a&&null!=a.returnM?a.returnM:!1:!1},enumerable:!1,configurable:!0});b.prototype.fetchPopupFeatures=function(a,b){return c.__awaiter(this,void 0,void 0,function(){var a;return c.__generator(this,function(e){return(a=this.validateFetchPopupFeatures(b))?[2,r.reject(a)]:[2,this.fetchClientPopupFeatures(b)]})})};
b.prototype.setVisibility=function(a,b){this.graphics3d&&this.graphics3d.graphicsCore.setObjectIdVisibility(a,b)};b.prototype.createQuery=function(){return f.prototype.createQuery.call(this)};b.prototype.queryFeatures=function(a,b){var c=this,e=function(){return f.prototype.queryFeatures.call(c,a,b)};return"mesh"===this.layer.geometryType?this._queryFeaturesMesh(this._ensureQuery(a),e):e()};b.prototype.beforeSetController=function(a){a.maximumNumberOfFeatures=this.maximumNumberOfFeatures};b.prototype.createController=
function(){var a=this;this.fetcherContext=new y.FeatureTileFetcher3DLayerViewContext({layerView:this,returnZ:this.hasZ,returnM:this.hasM});var b=new v({layerView:this,context:this.fetcherContext,graphics:new A.EventedSet,extent:this.clippingExtent});this.updatingHandles.add(b,"serviceDataExtent",function(b){a.graphics3d&&(a.graphics3d.dataExtent=b)},2);this.handles.add(t.init(this,"suspended",function(a){a?b.suspend():b.resume()},!0));this.updatingHandles.add(this.graphics3d.graphicsCore,"displayFeatureLimit",
function(){return a.updateDisplayFeatureLimit(b)},2);this.handles.add(this.view.resourceController.memoryController.events.on("quality-changed",function(){return a.updateDisplayFeatureLimit()}));return b};b.prototype.doRefresh=function(){return c.__awaiter(this,void 0,void 0,function(){return c.__generator(this,function(a){!this.suspended&&this.controller&&this.controller.refetch();return[2]})})};b.prototype.getUsedMemory=function(){var a=this.graphics3d&&this.graphics3d.graphicsCore;return(a?a.usedMemory:
0)+(this.controller?this.controller.memoryForUnusedFeatures:0)};b.prototype.getUnloadedMemory=function(){var a=this.graphics3d&&this.graphics3d.graphicsCore;return(a?a.unprocessedMemoryEstimate:0)+(this.controller?this.controller.expectedFeatureDiff*a.usedMemoryPerGraphic:0)};b.prototype.ignoresMemoryFactor=function(){return this.controller&&this.controller.hasMaximumNumberOfFeaturesOverride};b.prototype.updateDisplayFeatureLimit=function(a){void 0===a&&(a=this.controller);if(a&&this.graphics3d&&
this.graphics3d.graphicsCore){var b=this.graphics3d.graphicsCore.displayFeatureLimit,k=this.view.resourceController.memoryController.memoryFactor;if(1===k)a.displayFeatureLimit=b;else{var d=Math.ceil(b.maximumNumberOfFeatures*k),g=Math.ceil(b.maximumTotalNumberOfFeatures*k),k=Math.ceil(b.minimumTotalNumberOfFeatures*k);a.displayFeatureLimit=c.__assign(c.__assign({},b),{maximumNumberOfFeatures:d,maximumTotalNumberOfFeatures:g,minimumTotalNumberOfFeatures:k})}}};b.prototype._queryFeaturesMesh=function(a,
b){return c.__awaiter(this,void 0,void 0,function(){var e,d,g,h,m,n,l,f;return c.__generator(this,function(c){switch(c.label){case 0:return[4,this._validateQueryFeaturesMesh(a)];case 1:return c.sent(),[4,b()];case 2:e=c.sent();if(a&&a.outStatistics)return[2,e];d=this.layer.objectIdField;g=this.graphics3d.graphicsCore.graphics3DGraphicsByObjectID;h=[];m=0;for(n=e.features;m<n.length;m++)if(l=n[m],l.geometry){if(f=g.get(l.attributes[d]))l.geometry=u.hydrateGeometry(f.graphic.geometry),h.push(l)}else h.push(l);
e.features=h;return[2,e]}})})};b.prototype._validateQueryFeaturesMesh=function(a){return c.__awaiter(this,void 0,void 0,function(){var b,d,f,g,h;return c.__generator(this,function(c){if(!a)return[2];b=function(a){throw new q("feature-layer-view:unsupported-query","Queries on Mesh feature collection layers do not support '"+a+"'");};d=["quantizationParameters","geometryPrecision","maxAllowableOffset"];f=0;for(g=d;f<g.length;f++)h=g[f],null!=a[h]&&b(h);"returnM"in a&&a.returnM&&b("returnM");"returnCentroid"in
a&&a.returnCentroid&&b("returnCentroid");a.outSpatialReference&&!a.outSpatialReference.equals(this.view.spatialReference)&&b("outSpatialReference");return[2]})})};Object.defineProperty(b.prototype,"performanceInfo",{get:function(){var a=this.controller&&this.controller.displayFeatureLimit,a=(a=a&&a.maximumSymbolComplexity)?"f:"+a.primitivesPerFeature+",v:"+a.primitivesPerCoordinate:"n/a",a=c.__assign(c.__assign({},this._getResourceInfo()),{storedFeatures:0,totalVertices:0,partial:this.maximumNumberOfFeaturesExceeded,
mode:this.controller?this.controller.mode:"n/a",symbolComplexity:a,nodes:this.controller?this.controller.tileDescriptors.length:0});if(this.controller&&a.displayedNumberOfFeatures){var b=this.controller.debug;a.storedFeatures=b.storedFeatures;a.totalVertices=b.totalVertices}return a},enumerable:!1,configurable:!0});c.__decorate([d.property()],b.prototype,"layer",void 0);c.__decorate([d.property()],b.prototype,"controller",void 0);c.__decorate([d.property({readOnly:!0,dependsOn:["controller.updatingRemaining",
"controller.updatingTotal","graphics3d.graphicsCore.updatingRemaining","graphics3d.graphicsCore.updatingTotal"]})],b.prototype,"updatingProgressValue",null);c.__decorate([d.property({dependsOn:["controller.maximumNumberOfFeatures"]})],b.prototype,"maximumNumberOfFeatures",null);c.__decorate([d.property({dependsOn:["suspended","controller.maximumNumberOfFeaturesExceeded"]})],b.prototype,"maximumNumberOfFeaturesExceeded",null);c.__decorate([d.property(z.updatingProgress)],b.prototype,"updatingProgress",
void 0);c.__decorate([d.property({readOnly:!0,dependsOn:["controller.mode","layer.geometryType","controller.serviceDataCount"]})],b.prototype,"asyncGraphicsUpdates",null);c.__decorate([d.property({readOnly:!0})],b.prototype,"hasZ",null);c.__decorate([d.property({readOnly:!0})],b.prototype,"hasM",null);c.__decorate([d.property()],b.prototype,"suspendResumeExtentMode",void 0);return b=c.__decorate([d.subclass("esri.views.3d.layers.FeatureLayerView3D")],b)}(D.RefreshableLayerView(w.FeatureLikeLayerView3D(B.FeatureLayerView(x.LayerView3D(C)))))});