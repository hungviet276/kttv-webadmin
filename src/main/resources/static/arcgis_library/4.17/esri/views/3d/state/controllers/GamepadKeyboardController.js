// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.17/esri/copyright.txt for details.
//>>built
define("require exports tslib ../../../../core/compilerUtils ../../../../core/mathUtils ../../../../core/maybe ../../../../core/accessorSupport/decorators ../../../../core/libs/gl-matrix-2/mat4 ../../../../core/libs/gl-matrix-2/mat4f64 ../../../../core/libs/gl-matrix-2/vec3 ../../../../core/libs/gl-matrix-2/vec3f64 ../../../../geometry/support/geodesicConstants ../../camera/constraintUtils ../Constraints ./InteractiveController ../utils/navigationUtils ../utils/navigationUtils ../utils/viewUtils ../../support/cameraUtils ../../support/cameraUtilsInternal ../../support/geometryUtils ../../support/mathUtils ../../support/stack ../../webgl-engine/lib/Camera ../../../navigation/gamepadAndKeyboardUtils".split(" "),
function(A,z,r,H,q,I,w,m,B,f,J,C,p,t,K,L,u,D,M,N,x,O,l,E,h){Object.defineProperty(z,"__esModule",{value:!0});z.GamepadKeyboardController=void 0;A=function(y){function d(a){a=y.call(this,a)||this;a.transformation={translation:[0,0,0],heading:0,tilt:0,zoom:0};a.keysButtonState=[0,0,0,0,0,0,0,0,0,0,0,0];a.tmpCamera=new E.default;a.constraintOptions={selection:15,interactionType:0,interactionStartCamera:new E.default,interactionFactor:0,interactionDirection:null,tiltMode:1};return a}r.__extends(d,y);
d.prototype.handleEventGamepad=function(a){var b=h.extractTransformation(a,this.view.navigation.gamepad,this.transformation);("end"===a.action||h.isZeroTransformation(b))&&this.finishController()};d.prototype.activateDirection=function(a){this.keysButtonState[a]=1;h.extractTransformationKeyboard(this.keysButtonState,this.transformation)};d.prototype.deactivateDirection=function(a){this.keysButtonState[a]=0;a=h.extractTransformationKeyboard(this.keysButtonState,this.transformation);h.isZeroTransformation(a)&&
this.finishController()};d.prototype.onControllerStart=function(a){this.filteredSurfaceElevation=this.view.pointsOfInterest.cameraOnSurface.location.z;this.headingStart=this.view.camera.heading;y.prototype.onControllerStart.call(this,a)};d.prototype.updateFilteredSurfaceElevation=function(a){this.filteredSurfaceElevation+=1*(this.view.pointsOfInterest.cameraOnSurface.location.z-this.filteredSurfaceElevation)*a};d.prototype.stepController=function(a,b){this.updateStartHeading();this.updateFilteredSurfaceElevation(a);
this.currentCamera.copyViewFrom(b);this.updateCameraCenter();this.constraintOptions.interactionStartCamera.copyFrom(this.currentCamera);this.calculateControlTransformation(a,this.currentCamera,n);this.applyDisabledMovementTypes(n);this.applyPan(n.pan);this.applyRotate(n.rotate);this.applyZoom(n.zoom);this.applyAscend(n.ascend);this.constraintOptions.interactionType=0;this.constraintOptions.selection=8;p.applyAll(this.view,this.currentCamera,this.constraintOptions);y.prototype.stepController.call(this,
a,b)};d.prototype.updateStartHeading=function(){0!==this.transformation.heading&&(this.headingStart=this.view.camera.heading)};d.prototype.applyRotate=function(a){if(a.enabled){var b=this.currentCamera,c=b.center,g=b.up,e=b.eye;f.vec3.subtract(c,c,e);f.vec3.transformMat4(c,c,a.matrix);f.vec3.add(c,c,e);f.vec3.transformMat4(g,g,a.matrix);b.markViewDirty();this.constraintOptions.interactionType=3;this.constraintOptions.selection=7;p.applyAll(this.view,b,this.constraintOptions)}};d.prototype.applyPan=
function(a,b){void 0===b&&(b=this.currentCamera);if(a.enabled){var c=b.center,g=b.eye,e=b.up;f.vec3.transformMat4(g,g,a.matrix);f.vec3.transformMat4(c,c,a.matrix);this.view.state.isGlobal&&f.vec3.transformMat4(e,e,a.matrix);b.markViewDirty();this.constraintOptions.interactionType=4;this.constraintOptions.selection=15;p.applyAll(this.view,b,this.constraintOptions)}};d.prototype.applyZoom=function(a){if(a){var b=this.currentCamera,c=b.eye,b=b.viewForward;f.vec3.add(c,c,f.vec3.scale(l.sv3d.get(),b,a));
this.currentCamera.markViewDirty();f.vec3.copy(v,b);f.vec3.negate(v,v);this.constraintOptions.interactionDirection=v;this.constraintOptions.interactionType=1;this.constraintOptions.selection=7;p.applyAll(this.view,this.currentCamera,this.constraintOptions);this.constraintOptions.interactionDirection=null}};d.prototype.applyAscend=function(a){if(a){var b=this.currentCamera,c=b.center,b=b.eye,g=this.view.renderCoordsHelper.worldUpAtPosition(b,l.sv3d.get());this.constraintOptions.interactionDirection=
f.vec3.copy(v,g);this.view.state.isGlobal?(g=f.vec3.length(b),a=(g+a)/g,f.vec3.scale(b,b,a),f.vec3.scale(c,c,a)):(a=f.vec3.scale(l.sv3d.get(),g,a),f.vec3.add(b,b,a),f.vec3.add(c,c,a));this.currentCamera.markViewDirty();this.updateCameraCenter();this.constraintOptions.interactionType=5;this.constraintOptions.selection=8;p.applyAll(this.view,this.currentCamera,this.constraintOptions)&&this.updateCameraCenter();this.constraintOptions.selection=7;p.applyAll(this.view,this.currentCamera,this.constraintOptions);
this.constraintOptions.interactionDirection=null}};d.prototype.calculateControlTransformation=function(a,b,c){c.zoom=0;c.ascend=0;c.pan.enabled=!1;m.mat4.identity(c.pan.matrix);c.rotate.enabled=!1;m.mat4.identity(c.rotate.matrix);a=this.computeVelocities(a);this.view.state.isLocal?this.calculateControlTransformationLocal(a,b,c):this.calculateControlTransformationGlobal(a,b,c)};d.prototype.updateCameraCenter=function(){var a=this.currentCamera;this.view.renderCoordsHelper.intersectManifoldClosestSilhouette(a.ray,
this.view.pointsOfInterest.centerOnSurfaceFrequent.estimatedSurfaceAltitude,a.center);this.currentCamera.markViewDirty()};d.prototype.calculateControlTransformationLocal=function(a,b,c){var g=b.viewRight,e=b.viewForward,d=this.transformation,k=this.view.navigation.gamepad,e=f.vec3.set(l.sv3d.get(),e[0],e[1],0);f.vec3.normalize(e,e);var h=d.translation[0]*a.pan;0!==h&&(h=f.vec3.scale(l.sv3d.get(),g,h),m.mat4.translate(c.pan.matrix,c.pan.matrix,h),c.pan.enabled=!0);switch(k.mode){case "pan":k=-d.translation[1]*
a.pan;0!==k&&(k=f.vec3.scale(l.sv3d.get(),e,k),m.mat4.translate(c.pan.matrix,c.pan.matrix,k),c.pan.enabled=!0);c.zoom=d.zoom*a.zoom;break;case "zoom":c.zoom=(-d.translation[1]+d.zoom)*a.zoom;break;default:H.neverReached(k.mode)}c.ascend=d.translation[2]*a.ascend;k=-d.heading*a.rotate;0!==k&&(m.mat4.rotate(c.rotate.matrix,c.rotate.matrix,k,this.view.renderCoordsHelper.worldUpAtPosition(b.eye,l.sv3d.get())),c.rotate.enabled=!0);a=d.tilt*a.rotate;b=D.viewAngle(this.view.renderCoordsHelper,b.center,b.eye);
if(b=q.clamp(b+a,t.TiltDefault.min,t.TiltDefault.max)-b)m.mat4.rotate(c.rotate.matrix,c.rotate.matrix,b,g),c.rotate.enabled=!0};d.prototype.calculateControlTransformationGlobal=function(a,b,c){var g=b.eye,e=b.viewRight,d=this.transformation,k=this.view.navigation.gamepad,g=f.vec3.cross(l.sv3d.get(),e,g);f.vec3.normalize(g,g);f.vec3.negate(g,g);L.panMotionToRotationMatrix(this.beginCamera,b,d,a,this.view.camera.heading,this.headingStart,this.view.camera.tilt,c,k);this.tmpCamera.copyFrom(this.currentCamera);
this.applyPan(n.pan,this.tmpCamera);k=this.view.pointsOfInterest.centerOnSurfaceFrequent.estimatedSurfaceAltitude;c.ascend=d.translation[2]*a.ascend;g=-d.heading*a.rotate;0!==g&&(m.mat4.rotate(c.rotate.matrix,c.rotate.matrix,g,this.tmpCamera.eye),c.rotate.enabled=!0);b=this.clampTiltDeltaGlobalToValidRange(d.tilt*a.rotate,b.ray,k);0!==b&&(m.mat4.rotate(c.rotate.matrix,c.rotate.matrix,b,this.tmpCamera.viewRight),c.rotate.enabled=!0);c.zoom=d.zoom*a.zoom};d.prototype.clampTiltDeltaGlobalToValidRange=
function(a,b,c){var d=u.onSurfaceTiltToEyeTiltGlobal(t.TiltDefault.min,b.origin,c),e=0,h=0,e=l.sv3d.get();this.view.renderCoordsHelper.intersectManifold(b,c,e)?(e=D.viewAngle(this.view.renderCoordsHelper,e,b.origin),e=u.onSurfaceTiltToEyeTiltGlobal(e,b.origin,c),h=u.onSurfaceTiltToEyeTiltGlobal(t.TiltDefault.max,b.origin,c)):(x.sphere.closestPointOnSilhouette(x.sphere.wrap(c+C.earthRadius),b,e),e=q.acosClamped(-f.vec3.dot(b.direction,f.vec3.normalize(e,e))),e=u.offSurfaceTiltToEyeTiltGlobal(e,b.origin,
c),h=u.offSurfaceTiltToEyeTiltGlobal(t.TiltDefault.max,b.origin,c));return q.clamp(e+a,d,h)-e};d.prototype.getPointAbsoluteSurfaceElevation=function(a,b,c){var d=this.view.renderCoordsHelper,e=d.getAltitude(a);b+=Math.abs(e-b);f.vec3.copy(c,a);d.setAltitude(b,c);return b};d.prototype.clampedDistanceToSurface=function(a,b){var c=this.view.renderCoordsHelper,d=this.view.state.camera,e=M.headingTiltToDirectionUp(this.view,b,0,F,P).direction,e=c.intersectManifoldClosestSilhouette(x.ray.wrap(b,e),a,l.sv3d.get()),
e=f.vec3.distance(b,e);a=c.intersectManifoldClosestSilhouette(x.ray.wrap(b,O.directionFromTo(l.sv3d.get(),b,d.center)),a,l.sv3d.get());b=f.vec3.distance(b,a);return Math.min(e,b)};d.prototype.computeHeadingRotateRadius=function(a){var b=this.view,c=b.renderCoordsHelper,d=b.state,b=d.isGlobal,d=c.intersectManifoldClosestSilhouette(d.camera.ray,this.filteredSurfaceElevation,l.sv3d.get());if(b)return b=f.vec3.subtract(l.sv3d.get(),a,d),c=f.vec3.length(b),f.vec3.scale(b,b,1/c),a=f.vec3.normalize(l.sv3d.get(),
a),a=q.acosClamped(f.vec3.dot(a,b)),c*Math.sin(Math.min(Q,a));a=f.vec3.copy(l.sv3d.get(),a);c.setAltitude(this.filteredSurfaceElevation,a);return f.vec3.distance(d,a)};d.prototype.minimumAscendVelocity=function(){return this.view.state.constraints.collision.enabled?0:R};d.prototype.computeVelocities=function(a){var b=this.filteredSurfaceElevation,c=b+C.earthRadius,d=this.view.state,e=d.camera,f=d.isGlobal,k=l.sv3d.get(),h=this.getPointAbsoluteSurfaceElevation(e.eye,b,k),m=this.clampedDistanceToSurface(b,
k),n=e.width/2,p=G*e.width,d=G*e.width,e=m*Math.tan(.5*e.fovX)/n,r=e/c,c=e/this.computeHeadingRotateRadius(k),f=(f?r:e)*p*a,b=h-b,b=Math.max(this.minimumAscendVelocity()*a,Math.pow(2,p*a/n)*b-b),m=Math.pow(2,p*a/n)*m-m;a*=q.clamp(c*d,S,T);return{pan:f,ascend:b,zoom:m,rotate:a}};d.prototype.applyDisabledMovementTypes=function(a){!I.isSome(this.disableMovements)||void 0!==this.disableMovements.mode&&this.view.state.mode!==this.disableMovements.mode||(a.zoom=this.disableMovements.zoom?0:a.zoom,a.ascend=
this.disableMovements.ascend?0:a.ascend,a.pan.enabled=!this.disableMovements.pan,this.disableMovements.pan&&m.mat4.identity(a.pan.matrix),a.rotate.enabled=!this.disableMovements.rotate,this.disableMovements.rotate&&m.mat4.identity(a.rotate.matrix))};d.activatesFor=function(a,b){a=h.extractTransformation(b,a.navigation.gamepad,U);return!("end"===b.action||h.isZeroTransformation(a))};r.__decorate([w.property({constructOnly:!0})],d.prototype,"view",void 0);r.__decorate([w.property({constructOnly:!0})],
d.prototype,"gamepadDevice",void 0);r.__decorate([w.property({constructOnly:!0})],d.prototype,"disableMovements",void 0);return d=r.__decorate([w.subclass("esri.views.3d.state.controllers.GamepadKeyboardController")],d)}(K.InteractiveController);z.GamepadKeyboardController=A;var U={translation:[0,0,0],heading:0,tilt:0,zoom:0},F=80,Q=q.deg2rad(F),G=.75,R=5,S=q.deg2rad(30),T=q.deg2rad(80),n={zoom:0,ascend:0,pan:{enabled:!1,matrix:B.mat4f64.create()},rotate:{enabled:!1,matrix:B.mat4f64.create()}},v=
J.vec3f64.create(),P=N.createDirectionUp()});