// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.17/esri/copyright.txt for details.
//>>built
define(["require","exports","../../../../../webgl","../../VertexStream"],function(r,k,h,u){Object.defineProperty(k,"__esModule",{value:!0});k.Bloom=void 0;var v=[1,0],w=[0,1],x=[1,.8,.6,.4,.2],y=[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1];r=function(){function d(){this._compositeFBO=this._intensityFBO=null;this._mipsFBOs=Array(5);this._nMips=5;this._kernelSizeArray=[3,5,7,9,11];this._size=[0,0];this._programDesc={luminosityHighPass:{vsPath:"post-processing/pp",fsPath:"post-processing/bloom/luminosityHighPass",
attributes:{a_position:0}},gaussianBlur:{vsPath:"post-processing/pp",fsPath:"post-processing/bloom/gaussianBlur",attributes:{a_position:0}},composite:{vsPath:"post-processing/pp",fsPath:"post-processing/bloom/composite",attributes:{a_position:0}},blit:{vsPath:"post-processing/pp",fsPath:"post-processing/blit",attributes:{a_position:0}}}}d.prototype.dispose=function(){this._quad&&(this._quad.dispose(),this._quad=null);this._intensityFBO&&(this._intensityFBO.dispose(),this._intensityFBO=null);this._compositeFBO&&
(this._compositeFBO.dispose(),this._compositeFBO=null);if(this._mipsFBOs){for(var c=0;c<this._nMips;c++)this._mipsFBOs[c]&&(this._mipsFBOs[c].horizontal.dispose(),this._mipsFBOs[c].vertical.dispose());this._mipsFBOs=null}};d.prototype.draw=function(c,t,b){var a=c.context,h=c.pixelRatio,d=c.state.size,n=c.painter.materialManager,l=a.gl,p=this._programDesc,f=Math.round(h*d[0]),k=Math.round(h*d[1]),h=b.strength,d=b.radius,g=b.threshold;this._quad||(this._quad=new u(a,[-1,-1,1,-1,-1,1,1,1]));this._createOrResizeResources(c);
a.setStencilTestEnabled(!1);a.setBlendingEnabled(!0);a.setBlendFunction(1,771);a.setStencilWriteMask(0);b=this._quad;b.bind();a.bindFramebuffer(this._intensityFBO);var e=n.getProgram(c,p.luminosityHighPass);a.bindProgram(e);a.bindTexture(t.colorTexture,0);e.setUniform1i("u_texture",0);e.setUniform3fv("u_defaultColor",[0,0,0]);e.setUniform1f("u_defaultOpacity",0);e.setUniform1f("u_luminosityThreshold",g);e.setUniform1f("u_smoothWidth",.01);g=[Math.round(f/2),Math.round(k/2)];a.setViewport(0,0,g[0],
g[1]);a.setClearColor(0,0,0,0);a.clear(l.COLOR_BUFFER_BIT);b.draw();a.setBlendingEnabled(!1);l=this._intensityFBO.colorTexture;for(e=0;e<this._nMips;e++){var m=n.getProgram(c,p.gaussianBlur,[{name:"radius",value:this._kernelSizeArray[e]}]);a.bindProgram(m);a.bindTexture(l,e+1);m.setUniform1i("u_colorTexture",e+1);m.setUniform2fv("u_texSize",g);m.setUniform2fv("u_direction",v);a.setViewport(0,0,g[0],g[1]);var q=this._mipsFBOs[e];a.bindFramebuffer(q.horizontal);b.draw();l=q.horizontal.colorTexture;
a.bindFramebuffer(q.vertical);a.bindTexture(l,e+1);m.setUniform2fv("u_direction",w);b.draw();l=q.vertical.colorTexture;g[0]=Math.round(g[0]/2);g[1]=Math.round(g[1]/2)}a.setViewport(0,0,f,k);f=n.getProgram(c,p.composite,[{name:"nummips",value:5}]);a.bindFramebuffer(this._compositeFBO);a.bindProgram(f);f.setUniform1f("u_bloomStrength",h);f.setUniform1f("u_bloomRadius",d);f.setUniform1fv("u_bloomFactors",x);f.setUniform3fv("u_bloomTintColors",y);a.bindTexture(this._mipsFBOs[0].vertical.colorTexture,
1);f.setUniform1i("u_blurTexture1",1);a.bindTexture(this._mipsFBOs[1].vertical.colorTexture,2);f.setUniform1i("u_blurTexture2",2);a.bindTexture(this._mipsFBOs[2].vertical.colorTexture,3);f.setUniform1i("u_blurTexture3",3);a.bindTexture(this._mipsFBOs[3].vertical.colorTexture,4);f.setUniform1i("u_blurTexture4",4);a.bindTexture(this._mipsFBOs[4].vertical.colorTexture,5);f.setUniform1i("u_blurTexture5",5);b.draw();a.bindFramebuffer(t);a.setBlendingEnabled(!0);c=n.getProgram(c,p.blit);a.bindProgram(c);
a.bindTexture(this._compositeFBO.colorTexture,6);c.setUniform1i("u_texture",6);a.setBlendFunction(1,1);b.draw();b.unbind();a.setBlendFunction(1,771);a.setStencilTestEnabled(!0)};d.prototype._createOrResizeResources=function(c){var d=c.context,b=c.pixelRatio,a=c.state.size;c=Math.round(b*a[0]);a=Math.round(b*a[1]);if(!this._compositeFBO||this._size[0]!==c||this._size[1]!==a)for(this._size[0]=c,this._size[1]=a,b=[Math.round(c/2),Math.round(a/2)],this._compositeFBO?this._compositeFBO.resize(c,a):this._compositeFBO=
new h.FramebufferObject(d,{colorTarget:0,depthStencilTarget:0,width:c,height:a}),this._intensityFBO?this._intensityFBO.resize(b[0],b[1]):this._intensityFBO=new h.FramebufferObject(d,{colorTarget:0,depthStencilTarget:0,width:b[0],height:b[1]},{target:3553,pixelFormat:6408,internalFormat:6408,dataType:5121,wrapMode:33071,samplingMode:9729,flipped:!1,width:b[0],height:b[1]}),c=0;c<this._nMips;c++)this._mipsFBOs[c]?(this._mipsFBOs[c].horizontal.resize(b[0],b[1]),this._mipsFBOs[c].vertical.resize(b[0],
b[1])):this._mipsFBOs[c]={horizontal:new h.FramebufferObject(d,{colorTarget:0,depthStencilTarget:0,width:b[0],height:b[1]},{target:3553,pixelFormat:6408,internalFormat:6408,dataType:5121,wrapMode:33071,samplingMode:9729,flipped:!1,width:b[0],height:b[1]}),vertical:new h.FramebufferObject(d,{colorTarget:0,depthStencilTarget:0,width:b[0],height:b[1]},{target:3553,pixelFormat:6408,internalFormat:6408,dataType:5121,wrapMode:33071,samplingMode:9729,flipped:!1,width:b[0],height:b[1]})},b[0]=Math.round(b[0]/
2),b[1]=Math.round(b[1]/2)};return d}();k.Bloom=r});