// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.17/esri/copyright.txt for details.
//>>built
define("require exports tslib ../../../../Graphic ../../../../core/Logger ../../../../core/promiseUtils ../../../../core/screenUtils ../../../../core/accessorSupport/decorators ../../../../layers/support/rasterFunctions/pixelUtils ../../engine/BitmapContainer ../../engine/Container ../../engine/ImageryBitmapSource ../LayerView2D ../support/ExportStrategy ../../../layers/LayerView".split(" "),function(k,l,d,m,n,f,p,e,q,r,t,u,v,w,x){Object.defineProperty(l,"__esModule",{value:!0});var y=n.getLogger("esri.views.2d.layers.imagery.ImageryView2D");
k=function(g){function b(){var a=null!==g&&g.apply(this,arguments)||this;a.container=new t.Container;a.type="Imagery";a._bitmapView=null;return a}d.__extends(b,g);Object.defineProperty(b.prototype,"updating",{get:function(){var a;return null===(a=this.strategy)||void 0===a?void 0:a.updating},enumerable:!1,configurable:!0});b.prototype.update=function(a){this.strategy.update(a).catch(function(a){f.isAbortError(a)||y.error(a)})};b.prototype.detach=function(){this.strategy.destroy();this._bitmapView.removeAllChildren();
this.container.removeAllChildren()};b.prototype.hitTest=function(a,b){if(this.suspended)return f.resolve(null);a=this.view.toMap(p.createScreenPoint(a,b));return f.resolve(new m({attributes:{},geometry:a,layer:this.layer}))};b.prototype.attach=function(){var a=this,b=10<=this.layer.version,h=10.1<=this.layer.version?this.layer.imageMaxHeight:2048,c=10.1<=this.layer.version?this.layer.imageMaxWidth:2048;this._bitmapView=new r.BitmapContainer;this.strategy=new w({container:this._bitmapView,imageNormalizationSupported:b,
imageMaxHeight:h,imageMaxWidth:c,fetchSource:this._fetchImage.bind(this),requestUpdate:function(){return a.requestUpdate()}})};b.prototype.moveStart=function(){};b.prototype.viewChange=function(){};b.prototype.moveEnd=function(){};b.prototype.install=function(a){this.container.addChild(this._bitmapView);a.addChild(this.container)};b.prototype.uninstall=function(a){this.container.removeChild(this._bitmapView);a.removeChild(this.container)};b.prototype.redraw=function(){var a=this;this.strategy.updateExports(function(b){b.source instanceof
HTMLImageElement?b.requestRender():a.layer.applyRenderer({pixelBlock:b.source.pixelBlock}).then(function(h){var c=b.source;c.pixelBlock=h.pixelBlock;c.filter=function(b){return a.layer.applyFilter(b)};a.container.requestRender()})})};b.prototype.isUpdating=function(){return this.strategy.updating||this.updateRequested};b.prototype.getPixelData=function(){if(this.updating)return null;var a=this.strategy.container.children;if(1===a.length&&a[0].source)return{extent:a[0].source.extent,pixelBlock:a[0].source.originalPixelBlock};
if(1<a.length){var b=this.view.extent,a=a.map(function(a){return a.source}).filter(function(a){return a.extent&&a.extent.intersects(b)}).map(function(a){return{extent:a.extent,pixelBlock:a.originalPixelBlock}});return(a=q.mosaicPixelData(a,b))?{extent:a.extent,pixelBlock:a.pixelBlock}:null}return null};b.prototype._fetchImage=function(a,b,d,c){var e=this;c=c||{};c.timeExtent=this.timeExtent;c.requestAsImageElement=!0;return this.layer.fetchImage(a,b,d,c).then(function(a){return a.imageElement?a.imageElement:
e.layer.applyRenderer(a.pixelData,{signal:c.signal}).then(function(b){b=new u.default(b.pixelBlock,b.extent.clone(),a.pixelData.pixelBlock);b.filter=function(a){return e.layer.applyFilter(a)};return b})})};d.__decorate([e.property()],b.prototype,"container",void 0);d.__decorate([e.property()],b.prototype,"layer",void 0);d.__decorate([e.property()],b.prototype,"strategy",void 0);d.__decorate([e.property()],b.prototype,"timeExtent",void 0);d.__decorate([e.property({dependsOn:["strategy.updating"]})],
b.prototype,"updating",null);d.__decorate([e.enumeration({imagery:"Imagery"})],b.prototype,"type",void 0);return b=d.__decorate([e.subclass("esri.views.2d.layers.imagery.ImageryView2D")],b)}(v.LayerView2DMixin(x));l.default=k});