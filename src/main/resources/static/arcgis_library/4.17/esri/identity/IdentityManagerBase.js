// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.17/esri/copyright.txt for details.
//>>built
define("require exports tslib ../config ../kernel ../request ../core/cookie ../core/Error ../core/Evented ../core/global ../core/lang ../core/object ../core/promiseUtils ../core/string ../core/urlUtils ../core/urlUtils ../core/accessorSupport/decorators ./IdentityForm ./IdentityModal ./OAuthCredential ./OAuthInfo ./ServerInfo".split(" "),function(I,A,q,F,h,y,J,r,K,S,B,D,v,L,u,z,t,T,M,N,O,G){Object.defineProperty(A,"__esModule",{value:!0});A.Credential=A.IdentityManagerBase=void 0;var E={},P=function(h){var d=
(new z.Url(h.owningSystemUrl)).host;h=(new z.Url(h.server)).host;var a=/.+\.arcgis\.com$/i;return a.test(d)&&a.test(h)},H=function(h,d){return!!(P(h)&&d&&d.some(function(a){return a.test(h.server)}))};I=function(h){function d(){var a=h.call(this)||this;a._portalConfig=S.esriGeowConfig;a.serverInfos=[];a.oAuthInfos=[];a.credentials=[];a._soReqs=[];a._xoReqs=[];a._portals=[];a.defaultOAuthInfo=null;a.defaultTokenValidity=60;a.dialog=null;a.formConstructor=T;a.tokenValidity=null;a.signInPage=null;a.useSignInPage=
!0;a.normalizeWebTierAuth=!1;a._busy=null;a._rejectOnPersistedPageShow=!1;a._oAuthHash=null;a._gwTokenUrl="/sharing/rest/generateToken";a._agsRest="/rest/services";a._agsPortal=/\/sharing(\/|$)/i;a._agsAdmin=/(https?:\/\/[^\/]+\/[^\/]+)\/admin\/?(\/.*)?$/i;a._adminSvcs=/\/rest\/admin\/services(\/|$)/i;a._gwDomains=[{regex:/^https?:\/\/www\.arcgis\.com/i,customBaseUrl:"maps.arcgis.com",tokenServiceUrl:"https://www.arcgis.com/sharing/rest/generateToken"},{regex:/^https?:\/\/(?:dev|[a-z\d-]+\.mapsdev)\.arcgis\.com/i,
customBaseUrl:"mapsdev.arcgis.com",tokenServiceUrl:"https://dev.arcgis.com/sharing/rest/generateToken"},{regex:/^https?:\/\/(?:devext|[a-z\d-]+\.mapsdevext)\.arcgis\.com/i,customBaseUrl:"mapsdevext.arcgis.com",tokenServiceUrl:"https://devext.arcgis.com/sharing/rest/generateToken"},{regex:/^https?:\/\/(?:qaext|[a-z\d-]+\.mapsqa)\.arcgis\.com/i,customBaseUrl:"mapsqa.arcgis.com",tokenServiceUrl:"https://qaext.arcgis.com/sharing/rest/generateToken"},{regex:/^https?:\/\/[a-z\d-]+\.maps\.arcgis\.com/i,
customBaseUrl:"maps.arcgis.com",tokenServiceUrl:"https://www.arcgis.com/sharing/rest/generateToken"}];a._legacyFed=[];a._regexSDirUrl=/http.+\/rest\/services\/?/gi;a._regexServerType=/(\/(FeatureServer|GPServer|GeoDataServer|GeocodeServer|GeoenrichmentServer|GeometryServer|GlobeServer|ImageServer|MapServer|MobileServer|NAServer|NetworkDiagramServer|ParcelFabricServer|RelationalCatalogServer|SceneServer|StreamServer|UtilityNetworkServer|ValidationServer|VectorTileServer|VersionManagementServer)).*/gi;
a._gwUser=/http.+\/users\/([^\/]+)\/?.*/i;a._gwItem=/http.+\/items\/([^\/]+)\/?.*/i;a._gwGroup=/http.+\/groups\/([^\/]+)\/?.*/i;a._rePortalTokenSvc=/\/sharing(\/rest)?\/generatetoken/i;a._createDefaultOAuthInfo=!0;a._hasTestedIfAppIsOnPortal=!1;a._getOAuthHash();window.addEventListener("pageshow",function(b){a._pageShowHandler(b)});return a}q.__extends(d,h);d.prototype.registerServers=function(a){var b=this,c=this.serverInfos;c?(a=a.filter(function(a){return!b.findServerInfo(a.server)}),this.serverInfos=
c.concat(a)):this.serverInfos=a;a.forEach(function(a){a.owningSystemUrl&&b._portals.push(a.owningSystemUrl);a.hasPortal&&b._portals.push(a.server)})};d.prototype.registerOAuthInfos=function(a){var b=this,c=this.oAuthInfos;c?(a=a.filter(function(a){return!b.findOAuthInfo(a.portalUrl)}),this.oAuthInfos=c.concat(a)):this.oAuthInfos=a};d.prototype.registerToken=function(a){a=q.__assign({},a);var b=this._sanitizeUrl(a.server),c=this._isServerRsrc(b),e=this.findServerInfo(b),f=!0,k;e||(e=new G,e.server=
this._getServerInstanceRoot(b),c?e.hasServer=!0:(e.tokenServiceUrl=this._getTokenSvcUrl(b),e.hasPortal=!0),this.registerServers([e]));(k=this._findCredential(b))?(delete a.server,B.mixin(k,a),f=!1):(k=new w({userId:a.userId,server:e.server,token:a.token,expires:a.expires,ssl:a.ssl,scope:c?"server":"portal"}),k.resources=[b],this.credentials.push(k));k.emitTokenChange(!1);f||k.refreshServerTokens()};d.prototype.toJSON=function(){return B.fixJson({serverInfos:this.serverInfos.map(function(a){return a.toJSON()}),
oAuthInfos:this.oAuthInfos.map(function(a){return a.toJSON()}),credentials:this.credentials.map(function(a){return a.toJSON()})})};d.prototype.initialize=function(a){var b=this;if(a){"string"===typeof a&&(a=JSON.parse(a));var c=a.serverInfos,e=a.oAuthInfos;a=a.credentials;if(c){var f=[];c.forEach(function(a){a.server&&a.tokenServiceUrl&&f.push(a.declaredClass?a:new G(a))});f.length&&this.registerServers(f)}if(e){var k=[];e.forEach(function(a){a.appId&&k.push(a.declaredClass?a:new O(a))});k.length&&
this.registerOAuthInfos(k)}a&&a.forEach(function(a){a.server&&a.token&&a.expires&&a.expires>Date.now()&&(a=a.declaredClass?a:new w(a),a.emitTokenChange(),b.credentials.push(a))})}};d.prototype.findServerInfo=function(a){var b;a=this._sanitizeUrl(a);for(var c=0,e=this.serverInfos;c<e.length;c++){var f=e[c];if(this._hasSameServerInstance(f.server,a)){b=f;break}}return b};d.prototype.findOAuthInfo=function(a){var b;a=this._sanitizeUrl(a);for(var c=0,e=this.oAuthInfos;c<e.length;c++){var f=e[c];if(this._hasSameServerInstance(f.portalUrl,
a)){b=f;break}}return b};d.prototype.findCredential=function(a,b){var c,e;a=this._sanitizeUrl(a);e=this._isServerRsrc(a)?"server":"portal";if(b)for(var f=0,k=this.credentials;f<k.length;f++){var d=k[f];if(this._hasSameServerInstance(d.server,a)&&b===d.userId&&d.scope===e){c=d;break}}else for(b=0,f=this.credentials;b<f.length;b++)if(d=f[b],this._hasSameServerInstance(d.server,a)&&-1!==this._getIdenticalSvcIdx(a,d)&&d.scope===e){c=d;break}return c};d.prototype.getCredential=function(a,b){var c,e,f=
!0;b&&(c=!!b.token,e=b.error,f=!1!==b.prompt);b=q.__assign({},b);a=this._sanitizeUrl(a);var d=v.createAbortController(),l=v.createResolver();if(b.signal)v.onAbort(b.signal,function(){d.abort()});v.onAbort(d,function(){l.reject(new r("identity-manager:user-aborted","ABORTED"))});if(v.isAborted(d))return l.promise;b.signal=d.signal;var g=this._isAdminResource(a),m=c&&this._doPortalSignIn(a)?this._getEsriAuthCookie():null;if((c=c?this.findCredential(a):null)&&e&&e.details&&498===e.details.httpStatus)c.destroy(),
m&&m.token===b.token&&(J.writeCookie("esri_auth",null,{expires:-1,path:"/",domain:document.domain}),L.endsWith(window.location.hostname,".arcgis.com")&&J.writeCookie("esri_auth",null,{expires:-1,path:"/",domain:"arcgis.com"}));else if(m||c)return a=new r("identity-manager:not-authorized","You are currently signed in as: '"+(m&&m.email||c&&c.userId)+"'. You do not have access to this resource: "+a,{error:e}),l.reject(a),l.promise;if(e=this._findCredential(a,b))return l.resolve(e),l.promise;e=this.findServerInfo(a);
if(e)!e.hasServer&&this._isServerRsrc(a)&&(e._restInfoPms=this._getTokenSvcUrl(a),e.hasServer=!0);else{m=this._getTokenSvcUrl(a);if(!m)return a=new r("identity-manager:unknown-resource","Unknown resource - could not find token service endpoint."),l.reject(a),l.promise;e=new G;e.server=this._getServerInstanceRoot(a);"string"===typeof m?(e.tokenServiceUrl=m,e.hasPortal=!0):(e._restInfoPms=m,e.hasServer=!0);this.registerServers([e])}f&&e.hasPortal&&void 0===e._selfReq&&!this._findOAuthInfo(a)&&(e._selfReq=
{owningTenant:b&&b.owningTenant,selfDfd:this._getPortalSelf(e.tokenServiceUrl.replace(this._rePortalTokenSvc,"/sharing/rest/portals/self"),a)});return this._enqueue(a,e,b,l,g)};d.prototype.getResourceName=function(a){return this._isRESTService(a)?a.replace(this._regexSDirUrl,"").replace(this._regexServerType,"")||"":this._gwUser.test(a)&&a.replace(this._gwUser,"$1")||this._gwItem.test(a)&&a.replace(this._gwItem,"$1")||this._gwGroup.test(a)&&a.replace(this._gwGroup,"$1")||""};d.prototype.generateToken=
function(a,b,c){var e=this._rePortalTokenSvc.test(a.tokenServiceUrl),f=new z.Url(window.location.href.toLowerCase()),d=this._getEsriAuthCookie(),l=a.shortLivedTokenValidity,g,m,n,p,x,Q,R,C;b&&(C=this.tokenValidity||l||this.defaultTokenValidity,C>l&&0<l&&(C=l));c&&(m=c.isAdmin,n=c.serverUrl,p=c.token,Q=c.signal,R=c.ssl,a.customParameters=c.customParameters);m?l=a.adminTokenServiceUrl:(l=a.tokenServiceUrl,x=new z.Url(l.toLowerCase()),d&&(g=(g=d.auth_tier)&&g.toLowerCase()),("web"===g||a.webTierAuth)&&
c&&c.serverUrl&&!R&&"http"===f.scheme&&(u.hasSameOrigin(f.uri,l,!0)||"https"===x.scheme&&f.host===x.host&&"7080"===f.port&&"7443"===x.port)&&(l=l.replace(/^https:/i,"http:").replace(/:7443/i,":7080")));c=B.mixin({query:B.mixin({request:"getToken",username:b&&b.username,password:b&&b.password,serverUrl:n,token:p,expiration:C,referer:m||e?window.location.host:null,client:m?"referer":null,f:"json"},a.customParameters),method:"post",authMode:"anonymous",useProxy:this._useProxy(a,c),signal:Q},c&&c.ioArgs);
e||(c.withCredentials=!1);return y(l,c).then(function(c){c=c.data;if(!c||!c.token)return new r("identity-manager:authentication-failed","Unable to generate token");var e=a.server;E[e]||(E[e]={});b&&(E[e][b.username]=b.password);c.validity=C;return c})};d.prototype.isBusy=function(){return!!this._busy};d.prototype.checkSignInStatus=function(a){return this.checkAppAccess(a,"").then(function(a){return a.credential})};d.prototype.checkAppAccess=function(a,b,c){var e=this,f=!1;return this.getCredential(a,
{prompt:!1}).then(function(d){var k,g={f:"json"};if("portal"===d.scope)if(b&&(e._doPortalSignIn(a,!0)||c&&c.force))k=d.server+"/sharing/rest/oauth2/validateAppAccess",g.client_id=b;else if(d.token)k=d.server+"/sharing/rest";else return{credential:d};else if(d.token)k=d.server+"/rest/services";else return{credential:d};d.token&&(g.token=d.token);return y(k,{query:g,authMode:"anonymous"}).then(function(a){if(!1===a.data.valid)throw new r("identity-manager:not-authorized","You are currently signed in as: '"+
d.userId+"'.");f=!!a.data.viewOnlyUserTypeApp;return{credential:d}}).catch(function(a){if("identity-manager:not-authorized"===a.name)throw a;a=a.details&&a.details.httpStatus;if(498===a)throw d.destroy(),new r("identity-manager:not-authenticated","User is not signed in.");if(400===a)throw new r("identity-manager:invalid-request");return{credential:d}})}).then(function(a){return{credential:a.credential,viewOnly:f}})};d.prototype.setOAuthResponseHash=function(a){var b=this._oAuthDfd;this._oAuthDfd=
null;if(b&&a)if(clearInterval(this._oAuthIntervalId),"#"===a.charAt(0)&&(a=a.substring(1)),a=u.queryToObject(a),a.error){var c="access_denied"===a.error;a=new r(c?"identity-manager:user-aborted":"identity-manager:authentication-failed",c?"ABORTED":"OAuth: "+a.error+" - "+a.error_description);b.reject(a)}else{var c=b.oinfo_._oAuthCred,e=new w({userId:a.username,server:b.sinfo_.server,token:a.access_token,expires:Date.now()+1E3*Number(a.expires_in),ssl:"true"===a.ssl,_oAuthCred:c});c.storage=a.persist?
window.localStorage:window.sessionStorage;c.token=e.token;c.expires=e.expires;c.userId=e.userId;c.ssl=e.ssl;c.save();b.resolve(e)}};d.prototype.setRedirectionHandler=function(a){this._redirectFunc=a};d.prototype.setOAuthRedirectionHandler=function(a){this._oAuthRedirectFunc=a};d.prototype.setProtocolErrorHandler=function(a){this._protocolFunc=a};d.prototype.signIn=function(a,b,c){var e=this;void 0===c&&(c={});var f=v.createResolver(),d=function(){var a;null===m||void 0===m?void 0:m.remove();null===
n||void 0===n?void 0:n.remove();null===p||void 0===p?void 0:p.remove();null===g||void 0===g?void 0:g.destroy();null===(a=e.dialog)||void 0===a?void 0:a.destroy();e.dialog=g=m=n=p=null},l=function(){d();e._oAuthDfd=null;f.reject(new r("identity-manager:user-aborted","ABORTED"))};if(c.signal)v.onAbort(c.signal,function(){l()});var g=new this.formConstructor;g.resource=this.getResourceName(a);g.server=b.server;this.dialog=new M;this.dialog.content=g;this.dialog.open=!0;this.emit("dialog-create");var m=
g.on("cancel",l),n=this.dialog.watch("open",l),p=g.on("submit",function(a){e.generateToken(b,a,{isAdmin:c.isAdmin,signal:c.signal}).then(function(e){d();e=new w({userId:a.username,server:b.server,token:e.token,expires:null!=e.expires?Number(e.expires):null,ssl:!!e.ssl,isAdmin:c.isAdmin,validity:e.validity});f.resolve(e)}).catch(function(a){g.error=a;g.signingIn=!1})});return f.promise};d.prototype.oAuthSignIn=function(a,b,c,e){var f=this,d=this._oAuthDfd=v.createResolver();if(null===e||void 0===e?
0:e.signal)v.onAbort(e.signal,function(){var a=f._oAuthDfd&&f._oAuthDfd.oAuthWin_;a&&!a.closed?a.close():f.dialog&&g()});d.resUrl_=a;d.sinfo_=b;d.oinfo_=c;e=!e||!1!==e.oAuthPopupConfirmation;if(!c.popup||!e)return this._doOAuthSignIn(a,b,c),d.promise;var l=new this.formConstructor;l.oAuthPrompt=!0;l.server=b.server;this.dialog=new M;this.dialog.content=l;this.dialog.open=!0;this.emit("dialog-create");var g=function(){x();f._oAuthDfd=null;d.reject(new r("identity-manager:user-aborted","ABORTED"))},
m=l.on("cancel",g),n=this.dialog.watch("open",g),p=l.on("submit",function(){x();f._doOAuthSignIn(a,b,c)}),x=function(){m.remove();n.remove();p.remove();l.destroy();f.dialog.destroy();f.dialog=null};return d.promise};d.prototype.destroyCredentials=function(){this.credentials&&this.credentials.slice().forEach(function(a){a.destroy()});this.emit("credentials-destroy")};d.prototype._getOAuthHash=function(){var a=window.location.hash;if(a){"#"===a.charAt(0)&&(a=a.substring(1));var a=u.queryToObject(a),
b=!1;a.access_token&&a.expires_in&&a.state&&a.hasOwnProperty("username")?(a.state=JSON.parse(a.state),this._oAuthHash=a,b=!0):a.error&&a.error_description&&(console.log("IdentityManager OAuth Error: ",a.error," - ",a.error_description),"access_denied"===a.error&&(b=!0));b&&(window.location.hash="object"===typeof a.state&&a.state.hash||"")}};d.prototype._pageShowHandler=function(a){a.persisted&&this.isBusy()&&this._rejectOnPersistedPageShow&&(a=new r("identity-manager:user-aborted","ABORTED"),this._errbackFunc(a))};
d.prototype._findCredential=function(a,b){var c=this,e=-1,d,k,l,g=b&&b.token;b=b&&b.resource;var m=this._isServerRsrc(a)?"server":"portal",n=this.credentials.filter(function(b){return c._hasSameServerInstance(b.server,a)&&b.scope===m});a=b||a;if(n.length)if(1===n.length)if(b=n[0],k=(d=(l=this.findServerInfo(b.server))&&l.owningSystemUrl)&&this.findCredential(d,b.userId),e=this._getIdenticalSvcIdx(a,b),g)-1!==e&&(b.resources.splice(e,1),this._removeResource(a,k));else return-1===e&&b.resources.push(a),
this._addResource(a,k),b;else{var p,x;n.some(function(b){x=c._getIdenticalSvcIdx(a,b);return-1!==x?(p=b,k=(d=(l=c.findServerInfo(p.server))&&l.owningSystemUrl)&&c.findCredential(d,p.userId),e=x,!0):!1});if(g)p&&(p.resources.splice(e,1),this._removeResource(a,k));else if(p)return this._addResource(a,k),p}};d.prototype._findOAuthInfo=function(a){var b=this.findOAuthInfo(a);if(!b)for(var c=0,e=this.oAuthInfos;c<e.length;c++){var d=e[c];if(this._isIdProvider(d.portalUrl,a)){b=d;break}}return b};d.prototype._addResource=
function(a,b){b&&-1===this._getIdenticalSvcIdx(a,b)&&b.resources.push(a)};d.prototype._removeResource=function(a,b){var c=-1;b&&(c=this._getIdenticalSvcIdx(a,b),-1<c&&b.resources.splice(c,1))};d.prototype._useProxy=function(a,b){return b&&b.isAdmin&&!u.hasSameOrigin(a.adminTokenServiceUrl,window.location.href)||!this._isPortalDomain(a.tokenServiceUrl)&&"10.1"===String(a.currentVersion)&&!u.hasSameOrigin(a.tokenServiceUrl,window.location.href)};d.prototype._getOrigin=function(a){a=new z.Url(a);return a.scheme+
"://"+a.host+(null!=a.port?":"+a.port:"")};d.prototype._getServerInstanceRoot=function(a){var b=a.toLowerCase(),c=b.indexOf(this._agsRest);-1===c&&this._isAdminResource(a)&&(c=this._agsAdmin.test(a)?a.replace(this._agsAdmin,"$1").length:a.search(this._adminSvcs));-1===c&&(c=b.indexOf("/sharing"));-1===c&&"/"===b.substr(-1)&&(c=b.length-1);return-1<c?a.substring(0,c):a};d.prototype._hasSameServerInstance=function(a,b){"/"===a.substr(-1)&&(a=a.slice(0,-1));a=a.toLowerCase();b=this._getServerInstanceRoot(b).toLowerCase();
a=this._normalizeAGOLorgDomain(a);b=this._normalizeAGOLorgDomain(b);a=a.substr(a.indexOf(":"));b=b.substr(b.indexOf(":"));return a===b};d.prototype._normalizeAGOLorgDomain=function(a){var b=/^https?:\/\/(?:cdn|[a-z\d-]+\.maps)\.arcgis\.com/i,c=/^https?:\/\/(?:cdndev|[a-z\d-]+\.mapsdevext)\.arcgis\.com/i,e=/^https?:\/\/(?:cdnqa|[a-z\d-]+\.mapsqa)\.arcgis\.com/i;b.test(a)?a=a.replace(b,"https://www.arcgis.com"):c.test(a)?a=a.replace(c,"https://devext.arcgis.com"):e.test(a)&&(a=a.replace(e,"https://qaext.arcgis.com"));
return a};d.prototype._sanitizeUrl=function(a){var b=(F.request.proxyUrl||"").toLowerCase(),c=b?a.toLowerCase().indexOf(b+"?"):-1;-1!==c&&(a=a.substring(c+b.length+1));a=u.normalize(a);return u.urlToObject(a).path};d.prototype._isRESTService=function(a){return-1<a.indexOf(this._agsRest)};d.prototype._isAdminResource=function(a){return this._agsAdmin.test(a)||this._adminSvcs.test(a)};d.prototype._isServerRsrc=function(a){return this._isRESTService(a)||this._isAdminResource(a)};d.prototype._isIdenticalService=
function(a,b){var c;this._isRESTService(a)&&this._isRESTService(b)?(a=this._getSuffix(a).toLowerCase(),b=this._getSuffix(b).toLowerCase(),c=a===b,c||(c=/(.*)\/(MapServer|FeatureServer).*/gi,c=a.replace(c,"$1")===b.replace(c,"$1"))):this._isAdminResource(a)&&this._isAdminResource(b)?c=!0:this._isServerRsrc(a)||this._isServerRsrc(b)||!this._isPortalDomain(a)||(c=!0);return c};d.prototype._isPortalDomain=function(a){var b=this,c=new z.Url(a.toLowerCase());a=this._portalConfig;var e=this._gwDomains.some(function(a){return a.regex.test(c.uri)});
!e&&a&&(e=this._hasSameServerInstance(this._getServerInstanceRoot(a.restBaseUrl),c.uri));e||F.portalUrl&&(e=u.hasSameOrigin(c,F.portalUrl,!0));e||(e=this._portals.some(function(a){return b._hasSameServerInstance(a,c.uri)}));return e=e||this._agsPortal.test(c.path)};d.prototype._isIdProvider=function(a,b){var c=-1,e=-1;this._gwDomains.forEach(function(d,f){-1===c&&d.regex.test(a)&&(c=f);-1===e&&d.regex.test(b)&&(e=f)});var d=!1;if(-1<c&&-1<e)if(0===c||4===c){if(0===e||4===e)d=!0}else if(1===c){if(1===
e||2===e)d=!0}else 2===c?2===e&&(d=!0):3===c&&3===e&&(d=!0);if(!d){var k=this.findServerInfo(b),l=k&&k.owningSystemUrl;l&&P(k)&&this._isPortalDomain(l)&&this._isIdProvider(a,l)&&(d=!0)}return d};d.prototype._getIdenticalSvcIdx=function(a,b){for(var c=-1,e=0;e<b.resources.length;e++)if(this._isIdenticalService(a,b.resources[e])){c=e;break}return c};d.prototype._getSuffix=function(a){return a.replace(this._regexSDirUrl,"").replace(this._regexServerType,"$1")};d.prototype._getTokenSvcUrl=function(a){var b=
this,c,e;if(this._isRESTService(a)||this._isAdminResource(a))return e=this._getServerInstanceRoot(a),c=e+"/admin/generateToken",a=e+"/rest/info",e=y(a,{query:{f:"json"}}).then(function(a){return a.data}),{adminUrl:c,promise:e};if(this._isPortalDomain(a)){var d="";this._gwDomains.some(function(b){b.regex.test(a)&&(d=b.tokenServiceUrl);return!!d});d||this._portals.some(function(c){b._hasSameServerInstance(c,a)&&(d=c+b._gwTokenUrl);return!!d});d||(c=a.toLowerCase().indexOf("/sharing"),-1!==c&&(d=a.substring(0,
c)+this._gwTokenUrl));d||(d=this._getOrigin(a)+this._gwTokenUrl);d&&(c=(new z.Url(a)).port,/^http:\/\//i.test(a)&&"7080"===c&&(d=d.replace(/:7080/i,":7443")),d=d.replace(/http:/i,"https:"));return d}if(-1!==a.toLowerCase().indexOf("premium.arcgisonline.com"))return"https://premium.arcgisonline.com/server/tokens"};d.prototype._exchangeToken=function(a,b,c){return y(a+"/sharing/rest/oauth2/exchangeToken",{authMode:"anonymous",method:"post",query:{f:"json",client_id:b,token:c}}).then(function(a){return a.data.token})};
d.prototype._getPortalSelf=function(a,b){var c;this._gwDomains.some(function(b){b.regex.test(a)&&(c=b.customBaseUrl);return!!c});if(c)return v.resolve({allSSL:!0,currentVersion:"4.4",customBaseUrl:c,portalMode:"multitenant",supportsOAuth:!0});"https:"===window.location.protocol?a=a.replace(/^http:/i,"https:").replace(/:7080/i,":7443"):/^http:/i.test(b)&&(a=a.replace(/^https:/i,"http:").replace(/:7443/i,":7080"));return y(a,{query:{f:"json"},authMode:"anonymous",withCredentials:!0}).then(function(a){return a.data})};
d.prototype._hasPortalSession=function(){return!!this._getEsriAuthCookie()};d.prototype._getEsriAuthCookie=function(){var a=null;if(navigator.cookieEnabled){for(var b=this._getAllCookies("esri_auth"),c=void 0,e=0;e<b.length;e++){var d=JSON.parse(b[e]);if(d.portalApp){a=d;break}c?c.push(d):c=[d]}if(!a&&c)for(b=0;b<c.length;b++)if(d=c[b],d.urlKey&&window.location.hostname===d.urlKey.toLowerCase()+"."+d.customBaseUrl){a=d;break}}a&&(d=null,a.expires&&("number"===typeof a.expires?d=a.expires:"string"===
typeof a.expires&&(d=Date.parse(a.expires)),isNaN(d)&&(d=null),a.expires=d),d&&d<Date.now()&&(a=null));return a};d.prototype._getAllCookies=function(a){var b=[];if(a=document.cookie.match(new RegExp("(?:^|; )"+L.escapeRegExpString(a)+"\x3d([^;]*)","g")))for(var c=0;c<a.length;c++){var e=a[c],d=e.indexOf("\x3d");-1<d&&(e=e.substring(d+1),b.push(decodeURIComponent(e)))}return b};d.prototype._doPortalSignIn=function(a,b){if(navigator.cookieEnabled){var c=this._getEsriAuthCookie(),e=this._portalConfig,
d=window.location.href,k=this.findServerInfo(a);if((b||this.useSignInPage)&&(e||this._isPortalDomain(d)||c)&&(k?k.hasPortal||k.owningSystemUrl&&this._isPortalDomain(k.owningSystemUrl):this._isPortalDomain(a))&&(this._isIdProvider(d,a)||e&&(this._hasSameServerInstance(this._getServerInstanceRoot(e.restBaseUrl),a)||this._isIdProvider(e.restBaseUrl,a))||u.hasSameOrigin(d,a,!0)))return!0}return!1};d.prototype._canUsePortalSignInWorkflow=function(a){return this._doPortalSignIn(a)&&(window===window.top||
this._hasPortalSession())};d.prototype._checkProtocol=function(a,b,c,e){var d=!0;e=e?b.adminTokenServiceUrl:b.tokenServiceUrl;0===e.trim().toLowerCase().indexOf("https:")&&0!==window.location.href.toLowerCase().indexOf("https:")&&u.getProxyRule(e)&&(d=this._protocolFunc?!!this._protocolFunc({resourceUrl:a,serverInfo:b}):!1,d||(a=new r("identity-manager:aborted","Aborted the Sign-In process to avoid sending password over insecure connection."),c(a)));return d};d.prototype._enqueue=function(a,b,c,e,
d,k){e||(e=v.createResolver());e.resUrl_=a;e.sinfo_=b;e.options_=c;e.admin_=d;e.refresh_=k;this._busy?this._hasSameServerInstance(this._getServerInstanceRoot(a),this._busy.resUrl_)?(this._oAuthDfd&&this._oAuthDfd.oAuthWin_&&this._oAuthDfd.oAuthWin_.focus(),this._soReqs.push(e)):this._xoReqs.push(e):this._doSignIn(e);return e.promise};d.prototype._doSignIn=function(a){var b=this;this._busy=a;this._rejectOnPersistedPageShow=!1;var c=function(c){var d=a.options_&&a.options_.resource,e=a.resUrl_,n=a.refresh_,
f=!1;-1===b.credentials.indexOf(c)&&(n&&-1!==b.credentials.indexOf(n)?(n.userId=c.userId,n.token=c.token,n.expires=c.expires,n.validity=c.validity,n.ssl=c.ssl,n.creationTime=c.creationTime,f=!0,c=n):b.credentials.push(c));c.resources||(c.resources=[]);c.resources.push(d||e);c.scope=b._isServerRsrc(e)?"server":"portal";c.emitTokenChange();var d=b._soReqs,k={};b._soReqs=[];d.forEach(function(a){if(!b._isIdenticalService(e,a.resUrl_)){var d=b._getSuffix(a.resUrl_);k[d]||(k[d]=!0,c.resources.push(a.resUrl_))}});
a.resolve(c);d.forEach(function(a){b._hasSameServerInstance(b._getServerInstanceRoot(e),a.resUrl_)?a.resolve(c):b._soReqs.push(a)});b._busy=a.resUrl_=a.sinfo_=a.refresh_=null;f||b.emit("credential-create",{credential:c});b._soReqs.length?b._doSignIn(b._soReqs.shift()):b._xoReqs.length&&b._doSignIn(b._xoReqs.shift())},d=function(c){a.reject(c);b._busy=a.resUrl_=a.sinfo_=a.refresh_=null;b._soReqs.length?b._doSignIn(b._soReqs.shift()):b._xoReqs.length&&b._doSignIn(b._xoReqs.shift())},f=function(e,f,
k,l){var n=a.sinfo_,g=!a.options_||!1!==a.options_.prompt,p=n.hasPortal&&b._findOAuthInfo(a.resUrl_),m;if(b._canUsePortalSignInWorkflow(a.resUrl_))f=b._getEsriAuthCookie(),e=b._portalConfig,f?(n.webTierAuth||"web"!==(f.auth_tier&&f.auth_tier.toLowerCase())||(n.webTierAuth=!0),m=new w({userId:f.email,server:n.server,token:n.webTierAuth?null:f.token,expires:f.expires}),m.token?a._pendingDfd=b._exchangeToken(m.server,p?p.appId:"arcgisonline",m.token).then(function(a){m.token=a;c(m)}).catch(function(){c(m)}):
c(m)):g?(g="",p=window.location.href,g=b.signInPage?b.signInPage:e?e.baseUrl+e.signin:b._isIdProvider(p,a.resUrl_)?b._getOrigin(p)+"/home/signin.html":n.tokenServiceUrl.replace(b._rePortalTokenSvc,"")+"/home/signin.html",g=g.replace(/http:/i,"https:"),e&&!1===e.useSSL&&(g=g.replace(/https:/i,"http:")),0===p.toLowerCase().replace("https","http").indexOf(g.toLowerCase().replace("https","http"))?(n=new r("identity-manager:unexpected-error","Cannot redirect to Sign-In page from within Sign-In page. URL of the resource that triggered this workflow: "+
a.resUrl_),d(n)):(b._rejectOnPersistedPageShow=!0,b._redirectFunc?b._redirectFunc({signInPage:g,returnUrlParamName:"returnUrl",returnUrl:p,resourceUrl:a.resUrl_,serverInfo:n}):window.location.href=g+"?returnUrl\x3d"+encodeURIComponent(p))):(n=new r("identity-manager:not-authenticated","User is not signed in."),d(n));else if(e)c(new w({userId:e,server:n.server,token:k,expires:null!=l?Number(l):null,ssl:!!f}));else if(p){var h=p._oAuthCred;h||(e=new N(p,window.localStorage),f=new N(p,window.sessionStorage),
e.isValid()&&f.isValid()?e.expires>f.expires?(h=e,f.destroy()):(h=f,e.destroy()):h=e.isValid()?e:f,p._oAuthCred=h);h.isValid()?(m=new w({userId:h.userId,server:n.server,token:h.token,expires:h.expires,ssl:h.ssl,_oAuthCred:h}),p.appId!==h.appId&&b._doPortalSignIn(a.resUrl_,!0)?a._pendingDfd=b._exchangeToken(m.server,p.appId,m.token).then(function(a){m.token=a;h.token=a;h.save();c(m)}).catch(function(){c(m)}):c(m)):b._oAuthHash&&b._oAuthHash.state.portalUrl===p.portalUrl?(g=b._oAuthHash,m=new w({userId:g.username,
server:n.server,token:g.access_token,expires:Date.now()+1E3*Number(g.expires_in),ssl:"true"===g.ssl,oAuthState:g.state,_oAuthCred:h}),h.storage=g.persist?window.localStorage:window.sessionStorage,h.token=m.token,h.expires=m.expires,h.userId=m.userId,h.ssl=m.ssl,h.save(),b._oAuthHash=null,c(m)):g?a._pendingDfd=b.oAuthSignIn(a.resUrl_,n,p,a.options_).then(c,d):(n=new r("identity-manager:not-authenticated","User is not signed in."),d(n))}else g?b._checkProtocol(a.resUrl_,n,d,a.admin_)&&(g=a.options_,
a.admin_&&(g=g||{},g.isAdmin=!0),a._pendingDfd=b.signIn(a.resUrl_,n,g).then(c,d)):(n=new r("identity-manager:not-authenticated","User is not signed in."),d(n))},k=function(){var e=a.sinfo_,f=e.owningSystemUrl,g=a.options_,k,l,m,h;g&&(k=g.token,l=g.error,m=g.prompt);h=b._findCredential(f,{token:k,resource:a.resUrl_});if(!h)for(var g=0,r=b.credentials;g<r.length;g++){var q=r[g];if(b._isIdProvider(f,q.server)){h=q;break}}h?(f=b.findCredential(a.resUrl_,h.userId))?c(f):H(e,b._legacyFed)?(q=h.toJSON(),
q.server=e.server,q.resources=null,c(new w(q))):(a._pendingDfd=b.generateToken(b.findServerInfo(h.server),null,{serverUrl:a.resUrl_,token:h.token,signal:a.options_.signal,ssl:h.ssl})).then(function(b){c(new w({userId:h.userId,server:e.server,token:b.token,expires:null!=b.expires?Number(b.expires):null,ssl:!!b.ssl,isAdmin:a.admin_,validity:b.validity}))},d):(b._busy=null,k&&(a.options_.token=null),(a._pendingDfd=b.getCredential(f.replace(/\/?$/,"/sharing"),{resource:a.resUrl_,owningTenant:e.owningTenant,
signal:a.options_.signal,token:k,error:l,prompt:m})).then(function(){b._enqueue(a.resUrl_,a.sinfo_,a.options_,a,a.admin_)},function(a){d(a)}))};this._errbackFunc=d;var l=a.sinfo_.owningSystemUrl,g=this._isServerRsrc(a.resUrl_),m=a.sinfo_._restInfoPms;m?m.promise.then(function(c){var d=a.sinfo_;d._restInfoPms&&(d.adminTokenServiceUrl=d._restInfoPms.adminUrl,d._restInfoPms=null,d.tokenServiceUrl=D.getDeepValue("authInfo.tokenServicesUrl",c)||D.getDeepValue("authInfo.tokenServiceUrl",c)||D.getDeepValue("tokenServiceUrl",
c),d.shortLivedTokenValidity=D.getDeepValue("authInfo.shortLivedTokenValidity",c),d.currentVersion=c.currentVersion,d.owningTenant=c.owningTenant,(c=d.owningSystemUrl=c.owningSystemUrl)&&b._portals.push(c));g&&d.owningSystemUrl?k():f()},function(){a.sinfo_._restInfoPms=null;var b=new r("identity-manager:server-identification-failed","Unknown resource - could not find token service endpoint.");d(b)}):g&&l?k():a.sinfo_._selfReq?a.sinfo_._selfReq.selfDfd.then(function(c){var d={},e,f,g,k;c&&(e=c.user&&
c.user.username,d.username=e,d.allSSL=c.allSSL,f=c.supportsOAuth,g=c.currentVersion,"multitenant"===c.portalMode&&(k=c.customBaseUrl));a.sinfo_.webTierAuth=!!e;return e&&b.normalizeWebTierAuth?b.generateToken(a.sinfo_,null,{ssl:d.allSSL}).catch(function(){return null}).then(function(a){d.portalToken=a&&a.token;d.tokenExpiration=a&&a.expires;return d}):!e&&f&&4.4<=parseFloat(g)&&!b._canUsePortalSignInWorkflow(a.resUrl_)?b._generateOAuthInfo({portalUrl:a.sinfo_.server,customBaseUrl:k,owningTenant:a.sinfo_._selfReq.owningTenant}).catch(function(){return null}).then(function(){return d}):
d}).catch(function(){return null}).then(function(b){a.sinfo_._selfReq=null;b?f(b.username,b.allSSL,b.portalToken,b.tokenExpiration):f()}):f()};d.prototype._generateOAuthInfo=function(a){var b=this,c,d=a.portalUrl,f=a.customBaseUrl,k=a.owningTenant;if(a=!this.defaultOAuthInfo&&this._createDefaultOAuthInfo&&!this._hasTestedIfAppIsOnPortal){c=window.location.href;var h=c.indexOf("?");-1<h&&(c=c.slice(0,h));h=c.search(/\/(apps|home)\//);c=-1<h?c.slice(0,h):null}a&&c?(this._hasTestedIfAppIsOnPortal=!0,
a=y(c+"/sharing/rest",{query:{f:"json"}}).then(function(){b.defaultOAuthInfo=new O({appId:"arcgisonline",popup:!0,popupCallbackUrl:c+"/home/oauth-callback.html"})})):a=v.resolve();return a.then(function(){if(b.defaultOAuthInfo)return d=d.replace(/^http:/i,"https:"),y(d+"/sharing/rest/oauth2/validateRedirectUri",{query:{accountId:k,client_id:b.defaultOAuthInfo.appId,redirect_uri:u.makeAbsolute(b.defaultOAuthInfo.popupCallbackUrl),f:"json"}}).then(function(a){if(a.data.valid){var c=b.defaultOAuthInfo.clone();
c.portalUrl=a.data.urlKey&&f?"https://"+a.data.urlKey.toLowerCase()+"."+f:d;b.oAuthInfos.push(c)}})})};d.prototype._doOAuthSignIn=function(a,b,c){var d=this,f={portalUrl:c.portalUrl};!c.popup&&c.preserveUrlHash&&window.location.hash&&(f.hash=window.location.hash);f={client_id:c.appId,response_type:"token",state:JSON.stringify(f),expiration:c.expiration,locale:c.locale,redirect_uri:c.popup?u.makeAbsolute(c.popupCallbackUrl):window.location.href.replace(/#.*$/,"")};c.forceLogin&&(f.force_login=!0);
var h=c.portalUrl.replace(/^http:/i,"https:")+"/sharing/oauth2/authorize",l=h+"?"+u.objectToQuery(f);if(c.popup){var g=window.open(l,"esriJSAPIOAuth",c.popupWindowFeatures);g?(g.focus(),this._oAuthDfd.oAuthWin_=g,this._oAuthIntervalId=setInterval(function(){if(g.closed){clearInterval(d._oAuthIntervalId);var a=d._oAuthDfd;if(a){var b=new r("identity-manager:user-aborted","ABORTED");a.reject(b)}}},500)):(a=new r("identity-manager:popup-blocked","ABORTED"),this._oAuthDfd.reject(a))}else this._rejectOnPersistedPageShow=
!0,this._oAuthRedirectFunc?this._oAuthRedirectFunc({authorizeParams:f,authorizeUrl:h,resourceUrl:a,serverInfo:b,oAuthInfo:c}):window.location.href=l};return d=q.__decorate([t.subclass("esri.identity.IdentityManagerBase")],d)}(K);A.IdentityManagerBase=I;var w=function(r){function d(a){var b=r.call(this,a)||this;b._oAuthCred=null;b.tokenRefreshBuffer=2;a&&a._oAuthCred&&(b._oAuthCred=a._oAuthCred);return b}q.__extends(d,r);d.prototype.initialize=function(){this.resources=this.resources||[];null==this.creationTime&&
(this.creationTime=Date.now())};d.prototype.refreshToken=function(){var a=this,b=h.id.findServerInfo(this.server),c=b&&b.owningSystemUrl,d=!!c&&"server"===this.scope,f=d&&H(b,h.id._legacyFed),k=b.webTierAuth,l=k&&h.id.normalizeWebTierAuth,g=E[this.server],m=g&&g[this.userId],g=this.resources&&this.resources[0],n=d&&h.id.findServerInfo(c),p={username:this.userId,password:m},q;if(!k||l)if(d&&!n&&h.id.serverInfos.some(function(a){h.id._isIdProvider(c,a.server)&&(n=a);return!!n}),k=n&&h.id.findCredential(n.server,
this.userId),!d||k)if(f)k.refreshToken();else{if(d)q={serverUrl:g,token:k&&k.token,ssl:k&&k.ssl};else if(l)p=null,q={ssl:this.ssl};else if(m)this.isAdmin&&(q={isAdmin:!0});else return d=void 0,g&&(g=h.id._sanitizeUrl(g),this._enqueued=1,d=h.id._enqueue(g,b,null,null,this.isAdmin,this),d.then(function(){a._enqueued=0;a.refreshServerTokens()}).catch(function(){a._enqueued=0})),d;return h.id.generateToken(d?n:b,d?null:p,q).then(function(b){a.token=b.token;a.expires=null!=b.expires?Number(b.expires):
null;a.creationTime=Date.now();a.validity=b.validity;a.emitTokenChange();a.refreshServerTokens()}).catch(function(){})}};d.prototype.refreshServerTokens=function(){var a=this;"portal"===this.scope&&h.id.credentials.forEach(function(b){var c=h.id.findServerInfo(b.server),d=c&&c.owningSystemUrl;b!==a&&b.userId===a.userId&&d&&"server"===b.scope&&(h.id._hasSameServerInstance(a.server,d)||h.id._isIdProvider(d,a.server))&&(H(c,h.id._legacyFed)?(b.token=a.token,b.expires=a.expires,b.creationTime=a.creationTime,
b.validity=a.validity,b.emitTokenChange()):b.refreshToken())})};d.prototype.emitTokenChange=function(a){clearTimeout(this._refreshTimer);var b=this.server&&h.id.findServerInfo(this.server),c=(b=b&&b.owningSystemUrl)&&h.id.findServerInfo(b);!1===a||b&&"portal"!==this.scope&&(!c||!c.webTierAuth||h.id.normalizeWebTierAuth)||null==this.expires&&null==this.validity||this._startRefreshTimer();this.emit("token-change")};d.prototype.destroy=function(){this.userId=this.server=this.token=this.expires=this.validity=
this.resources=this.creationTime=null;this._oAuthCred&&(this._oAuthCred.destroy(),this._oAuthCred=null);var a=h.id.credentials.indexOf(this);-1<a&&h.id.credentials.splice(a,1);this.emitTokenChange();this.emit("destroy")};d.prototype.toJSON=function(){var a=B.fixJson({userId:this.userId,server:this.server,token:this.token,expires:this.expires,validity:this.validity,ssl:this.ssl,isAdmin:this.isAdmin,creationTime:this.creationTime,scope:this.scope}),b=this.resources;b&&0<b.length&&(a.resources=b.slice());
return a};d.prototype._startRefreshTimer=function(){clearTimeout(this._refreshTimer);var a=6E4*this.tokenRefreshBuffer,b=(this.validity?this.creationTime+6E4*this.validity:this.expires)-Date.now();0>b&&(b=0);this._refreshTimer=setTimeout(this.refreshToken.bind(this),b>a?b-a:b)};q.__decorate([t.property()],d.prototype,"creationTime",void 0);q.__decorate([t.property()],d.prototype,"expires",void 0);q.__decorate([t.property()],d.prototype,"isAdmin",void 0);q.__decorate([t.property()],d.prototype,"oAuthState",
void 0);q.__decorate([t.property()],d.prototype,"resources",void 0);q.__decorate([t.property()],d.prototype,"scope",void 0);q.__decorate([t.property()],d.prototype,"server",void 0);q.__decorate([t.property()],d.prototype,"ssl",void 0);q.__decorate([t.property()],d.prototype,"token",void 0);q.__decorate([t.property()],d.prototype,"tokenRefreshBuffer",void 0);q.__decorate([t.property()],d.prototype,"userId",void 0);q.__decorate([t.property()],d.prototype,"validity",void 0);return d=q.__decorate([t.subclass("esri.identity.Credential")],
d)}(K.EventedAccessor);A.Credential=w});