// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.17/esri/copyright.txt for details.
//>>built
define("require exports tslib ../../request ../../core/maybe ../../core/promiseUtils ../../core/urlUtils ../../geometry/support/jsonUtils ../../geometry/support/normalizeUtils ./pbfQueryUtils ./queryZScale ./urlUtils @dojo/framework/shim/Promise".split(" "),function(y,c,e,q,r,l,m,t,u,v,w,x){function n(a,b){var d=a.geometry;a=a.toJSON();d&&(a.geometry=JSON.stringify(d),a.geometryType=t.getJsonType(d),a.inSR=d.spatialReference.wkid||JSON.stringify(d.spatialReference));a.groupByFieldsForStatistics&&
(a.groupByFieldsForStatistics=a.groupByFieldsForStatistics.join(","));a.objectIds&&(a.objectIds=a.objectIds.join(","));a.orderByFields&&(a.orderByFields=a.orderByFields.join(","));!a.outFields||!a.returnDistinctValues&&((null===b||void 0===b?0:b.returnCountOnly)||(null===b||void 0===b?0:b.returnExtentOnly)||(null===b||void 0===b?0:b.returnIdsOnly))?delete a.outFields:-1!==a.outFields.indexOf("*")?a.outFields="*":a.outFields=a.outFields.join(",");a.outSR?a.outSR=a.outSR.wkid||JSON.stringify(a.outSR):
d&&(a.returnGeometry||a.returnCentroid)&&(a.outSR=a.inSR);a.returnGeometry&&delete a.returnGeometry;a.outStatistics&&(a.outStatistics=JSON.stringify(a.outStatistics));a.pixelSize&&(a.pixelSize=JSON.stringify(a.pixelSize));a.quantizationParameters&&(a.quantizationParameters=JSON.stringify(a.quantizationParameters));a.parameterValues&&(a.parameterValues=JSON.stringify(a.parameterValues));a.rangeValues&&(a.rangeValues=JSON.stringify(a.rangeValues));a.dynamicDataSource&&(a.layer=JSON.stringify({source:a.dynamicDataSource}),
delete a.dynamicDataSource);if(a.timeExtent){d=a.timeExtent;b=d.start;d=d.end;if(null!=b||null!=d)a.time=b===d?b:(null==b?"null":b)+","+(null==d?"null":d);delete a.timeExtent}return a}function p(a,b,d){return k(a,b,"pbf",d)}function k(a,b,d,f,c){void 0===f&&(f={});var g="string"===typeof a?m.urlToObject(a):a;a=b.geometry?[b.geometry]:[];f.responseType="pbf"===d?"array-buffer":"json";return u.normalizeCentralMeridian(a,null,f).then(function(a){a=a&&a[0];r.isSome(a)&&(b=b.clone(),b.geometry=a);a=x.mapParameters(e.__assign(e.__assign(e.__assign(e.__assign({},
g.query),{f:d}),c),n(b,c)));return q(m.join(g.path,"query"),e.__assign(e.__assign({},f),{query:e.__assign(e.__assign({},f.query),a)}))})}Object.defineProperty(c,"__esModule",{value:!0});c.runQuery=c.executeQueryForExtent=c.executeQueryForCount=c.executeQueryForIds=c.executeQueryPBFBuffer=c.executeQueryPBF=c.executeQuery=c.queryToQueryStringParameters=void 0;c.queryToQueryStringParameters=n;c.executeQuery=function(a,b,d,f){var c;return e.__awaiter(this,void 0,void 0,function(){var g,h;return e.__generator(this,
function(e){switch(e.label){case 0:if(null===(c=b.timeExtent)||void 0===c||!c.isEmpty)return[3,1];h={data:{features:[]}};return[3,3];case 1:return[4,k(a,b,"json",f)];case 2:h=e.sent(),e.label=3;case 3:return g=h,w.applyFeatureSetZUnitScaling(b,d,g.data),[2,g]}})})};c.executeQueryPBF=function(a,b,d,c){var f;return e.__awaiter(this,void 0,void 0,function(){var g,h;return e.__generator(this,function(e){switch(e.label){case 0:return(null===(f=b.timeExtent)||void 0===f?0:f.isEmpty)?[2,l.resolve({data:d.createFeatureResult()})]:
[4,p(a,b,c)];case 1:return h=g=e.sent(),h.data=v.parsePBFFeatureQuery(g.data,d),[2,h]}})})};c.executeQueryPBFBuffer=p;c.executeQueryForIds=function(a,b,d){var c;return(null===(c=b.timeExtent)||void 0===c?0:c.isEmpty)?l.resolve({data:{objectIds:[]}}):k(a,b,"json",d,{returnIdsOnly:!0})};c.executeQueryForCount=function(a,b,c){var d;return(null===(d=b.timeExtent)||void 0===d?0:d.isEmpty)?l.resolve({data:{count:0}}):k(a,b,"json",c,{returnIdsOnly:!0,returnCountOnly:!0})};c.executeQueryForExtent=function(a,
b,c){var d;return(null===(d=b.timeExtent)||void 0===d?0:d.isEmpty)?l.resolve({data:{count:0,extent:null}}):k(a,b,"json",c,{returnExtentOnly:!0,returnCountOnly:!0}).then(function(a){var b=a.data;if(b.hasOwnProperty("extent"))return a;if(b.features)throw Error("Layer does not support extent calculation.");if(b.hasOwnProperty("count"))throw Error("Layer does not support extent calculation.");return a})};c.runQuery=k});