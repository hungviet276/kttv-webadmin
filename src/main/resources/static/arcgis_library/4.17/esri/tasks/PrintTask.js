// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.17/esri/copyright.txt for details.
//>>built
define("require exports tslib ../kernel ../request ../core/Error ../core/has ../core/jsonMap ../core/lang ../core/promiseUtils ../core/screenUtils ../core/SetUtils ../core/string ../core/urlUtils ../core/accessorSupport/decorators ../geometry/Polygon ../renderers/visualVariables/support/visualVariableUtils ./Geoprocessor ./Task ./support/fileFormat ./support/layoutTemplate ./support/printTaskUtils ./support/PrintTemplate ./support/Query @dojo/framework/shim/Promise".split(" "),function(V,ja,d,D,P,
W,Q,E,M,X,w,Y,R,A,F,Z,aa,ba,ca,da,ea,q,fa,ga){function I(d){return d&&(d.path||"image/svg+xml"===d.contentType||d.url&&R.endsWith(d.url,".svg"))}var S={Feet:"ft",Kilometers:"km",Meters:"m",Miles:"mi"},T=new E.default({esriFeet:"Feet",esriKilometers:"Kilometers",esriMeters:"Meters",esriMiles:"Miles"}),ha=new E.default({esriExecutionTypeSynchronous:"sync",esriExecutionTypeAsynchronous:"async"}),ia=new ga({returnGeometry:!0});return function(E){function h(){for(var a=[],b=0;b<arguments.length;b++)a[b]=
arguments[b];a=E.apply(this,a)||this;a._ssExtent=null;a._legendLayers=[];a._legendLayerNameMap={};a._gpServerUrl=null;a._cimVersion=null;a._is11xService=!1;a._gpMetadata=null;a.updateDelay=1E3;return a}d.__extends(h,E);Object.defineProperty(h.prototype,"_geoprocessor",{get:function(){return new ba({url:this.url})},enumerable:!1,configurable:!0});Object.defineProperty(h.prototype,"mode",{get:function(){return this._gpMetadata&&this._gpMetadata.executionType?ha.fromJSON(this._gpMetadata.executionType):
"sync"},enumerable:!1,configurable:!0});h.prototype.execute=function(a,b){var e=this,c=this.url,f=c.lastIndexOf("/GPServer/");0<f&&(c=c.slice(0,f+9));return X.resolve().then(function(){if(e._gpServerUrl===c)return{data:e._gpMetadata};e._gpServerUrl=c;return P(c,{query:{f:"json"}})}).then(function(c){e._gpMetadata=c.data;e._cimVersion=e._gpMetadata.cimVersion;e._is11xService=!!e._cimVersion;return e._getGpPrintParams(a)}).then(function(a){var c=function(a){return"sync"===e.mode?a.results&&a.results[0]&&
a.results[0].value:e._geoprocessor.getResultData(a.jobId,"Output_File",b).then(function(a){return a.value})};return"async"===e.mode?e._geoprocessor.submitJob(a,b).then(function(a){return e._geoprocessor.waitForJobCompletion(a.jobId,{interval:e.updateDelay}).then(c)}):e._geoprocessor.execute(a,b).then(c)})};h.prototype._createOperationalLayers=function(a,b){return d.__awaiter(this,void 0,void 0,function(){var e,c,f,r,k,n,l,g,m;return d.__generator(this,function(d){switch(d.label){case 0:e=[],c={layerView:null,
printTemplate:b,view:a},f=0,b.scalePreserved&&(f=b.outScale||a.scale),r=q.getVisibleLayerViews(a,f),k=0,n=r,d.label=1;case 1:if(!(k<n.length))return[3,29];l=n[k];g=l.layer;if(!g.loaded||q.isGroupLayer(g))return[3,28];m=void 0;c.layerView=l;if(!q.isBingMapsLayer(g))return[3,2];m=this._createBingMapsLayerJSON(g);return[3,27];case 2:return q.isCSVLayer(g)?[4,this._createCSVLayerJSON(g,c)]:[3,4];case 3:return m=d.sent(),[3,27];case 4:return q.isFeatureLayer(g)?[4,this._createFeatureLayerJSON(g,c)]:[3,
6];case 5:return m=d.sent(),[3,27];case 6:return q.isGeoJSONLayer(g)?[4,this._createGeoJSONLayer(g,c)]:[3,8];case 7:return m=d.sent(),[3,27];case 8:return q.isGraphicsLayer(g)?[4,this._createGraphicsLayerJSON(g,c)]:[3,10];case 9:return m=d.sent(),[3,27];case 10:if(!q.isImageryLayer(g))return[3,11];m=this._createImageryLayerJSON(g);return[3,27];case 11:return q.isKMLLayer(g)?[4,this._createKMLLayerJSON(g,c)]:[3,13];case 12:return m=d.sent(),[3,27];case 13:if(!q.isMapImageLayer(g))return[3,14];m=this._createMapImageLayerJSON(g,
c);return[3,27];case 14:return q.isMapNotesLayer(g)?[4,this._createMapNotesLayerJSON(c)]:[3,16];case 15:return m=d.sent(),[3,27];case 16:if(!q.isOpenStreetMapLayer(g))return[3,17];m=this._createOpenStreetMapLayerJSON();return[3,27];case 17:return q.isStreamLayer(g)?[4,this._createStreamLayerJSON(g,c)]:[3,19];case 18:return m=d.sent(),[3,27];case 19:if(!q.isTileLayer(g))return[3,20];m=this._createTileLayerJSON(g);return[3,27];case 20:return q.isVectorTileLayer(g)?[4,this._createVectorTileLayerJSON(g,
c)]:[3,22];case 21:return m=d.sent(),[3,27];case 22:if(!q.isWebTileLayer(g))return[3,23];m=this._createWebTileLayerJSON(g);return[3,27];case 23:if(!q.isWMSLayer(g))return[3,24];m=this._createWMSLayerJSON(g);return[3,27];case 24:if(!q.isWMTSLayer(g))return[3,25];m=this._createWMTSLayerJSON(g);return[3,27];case 25:return[4,this._createScreenshotJSON(g,c)];case 26:m=d.sent(),d.label=27;case 27:m&&(Array.isArray(m)?e.push.apply(e,m):(m.id=g.id,m.title=this._legendLayerNameMap[g.id]||g.title,m.opacity=
g.opacity,m.minScale=g.minScale||0,m.maxScale=g.maxScale||0,e.push(m))),d.label=28;case 28:return k++,[3,1];case 29:return f&&e.forEach(function(a){a.minScale=0;a.maxScale=0}),a.graphics&&a.graphics.length?[4,this._createFeatureCollectionJSON(null,a.graphics,b)]:[3,31];case 30:(m=d.sent())&&e.push(m),d.label=31;case 31:return[2,e]}})})};h.prototype._createBingMapsLayerJSON=function(a){return{culture:a.culture,key:a.key,type:"BingMaps"+("aerial"===a.style?"Aerial":"hybrid"===a.style?"Hybrid":"Road")}};
h.prototype._createCSVLayerJSON=function(a,b){var e=b.layerView,c=b.printTemplate;return d.__awaiter(this,void 0,void 0,function(){var b,r;return d.__generator(this,function(f){switch(f.label){case 0:this._legendLayers&&this._legendLayers.push({id:a.id});if(!this._is11xService)return[3,1];b={type:"CSV"};a.write(b,{origin:"web-map"});delete b.popupInfo;delete b.layerType;b.showLabels=c.showLabels&&a.labelsVisible;return[3,3];case 1:return[4,this._getGraphics(e)];case 2:return r=f.sent(),[2,this._createFeatureCollectionJSON(a,
r,c)];case 3:return[2,b]}})})};h.prototype._createFeatureCollectionJSON=function(a,b,e){var c,f;return d.__awaiter(this,void 0,void 0,function(){var r,k,n,l,g,m,h,G,t,v,y,x,z,B,U,p,w,H,J,K,L,N,C,O;return d.__generator(this,function(u){switch(u.label){case 0:k=q.createPolygonLayer();n=q.createPolylineLayer();l=q.createPointLayer();g=q.createMultipointLayer();m=q.createPointLayer();m.layerDefinition.name="textLayer";delete m.layerDefinition.drawingInfo;a&&("esri.layers.FeatureLayer"===a.declaredClass||
"esri.layers.StreamLayer"===a.declaredClass?k.layerDefinition.name=n.layerDefinition.name=l.layerDefinition.name=g.layerDefinition.name=this._legendLayerNameMap[a.id]||a.get("arcgisProps.title")||a.title:"esri.layers.GraphicsLayer"===a.declaredClass&&(b=a.graphics.items),a.renderer&&(h=a.renderer.toJSON(),k.layerDefinition.drawingInfo.renderer=h,n.layerDefinition.drawingInfo.renderer=h,l.layerDefinition.drawingInfo.renderer=h,g.layerDefinition.drawingInfo.renderer=h),e.showLabels&&a.labelsVisible&&
"function"===typeof a.write&&(G=a.write({},{origin:"web-map"}),t=null===(f=null===(c=G.layerDefinition)||void 0===c?void 0:c.drawingInfo)||void 0===f?void 0:f.labelingInfo))&&(r=!0,k.layerDefinition.drawingInfo.labelingInfo=t,n.layerDefinition.drawingInfo.labelingInfo=t,l.layerDefinition.drawingInfo.labelingInfo=t,g.layerDefinition.drawingInfo.labelingInfo=t);null!==a&&void 0!==a&&a.renderer||r||(delete k.layerDefinition.drawingInfo,delete n.layerDefinition.drawingInfo,delete l.layerDefinition.drawingInfo,
delete g.layerDefinition.drawingInfo);y=a&&a.fields;x=a&&a.renderer;if(!y||!x||"function"!==typeof x.collectRequiredFields)return[3,2];z=new Set;return[4,x.collectRequiredFields(z,y)];case 1:u.sent(),v=Y.valuesOfSet(z),u.label=2;case 2:y&&(B=y.map(function(a){return a.toJSON()}),k.layerDefinition.fields=B,n.layerDefinition.fields=B,l.layerDefinition.fields=B,g.layerDefinition.fields=B),U=b&&b.length,w=function(c){var f,r,h,u,t,x;return d.__generator(this,function(d){switch(d.label){case 0:f=b[c]||
b.getItemAt(c);if(!1===f.visible||!f.geometry)return[2,"continue"];p=f.toJSON();p.hasOwnProperty("popupTemplate")&&delete p.popupTemplate;p.geometry&&p.geometry.z&&delete p.geometry.z;if(p.symbol&&p.symbol.outline&&"esriCLS"===p.symbol.outline.type&&!H._is11xService)return[2,"continue"];!H._is11xService&&p.symbol&&p.symbol.outline&&p.symbol.outline.color&&p.symbol.outline.color[3]&&(p.symbol.outline.color[3]=255);r=a&&a.renderer&&("valueExpression"in a.renderer&&a.renderer.valueExpression||"hasVisualVariables"in
a.renderer&&a.renderer.hasVisualVariables());if(p.symbol||!a||!a.renderer||!r||H._is11xService)return[3,2];h=a.renderer;return[4,h.getSymbolAsync(f)];case 1:u=d.sent();if(!u)return[2,"continue"];p.symbol=u.toJSON();"hasVisualVariables"in h&&h.hasVisualVariables()&&q.applyVisualVariables(p.symbol,{renderer:h,graphic:f,symbol:u});d.label=2;case 2:if(!p.symbol)return[3,5];p.symbol.angle||delete p.symbol.angle;if(!I(p.symbol))return[3,4];t=p;return[4,H._convertSvgToPictureMarkerSymbolJson(p.symbol)];
case 3:return t.symbol=d.sent(),[3,5];case 4:p.symbol.text&&delete p.attributes,d.label=5;case 5:return e&&e.forceFeatureAttributes||!v||!v.length||(x={},v.forEach(function(a){p.attributes&&p.attributes.hasOwnProperty(a)&&(x[a]=p.attributes[a])}),p.attributes=x),"polygon"===f.geometry.type?k.featureSet.features.push(p):"polyline"===f.geometry.type?n.featureSet.features.push(p):"point"===f.geometry.type?p.symbol&&p.symbol.text?m.featureSet.features.push(p):l.featureSet.features.push(p):"multipoint"===
f.geometry.type?g.featureSet.features.push(p):"extent"===f.geometry.type&&(p.geometry=Z.fromExtent(f.geometry).toJSON(),k.featureSet.features.push(p)),[2]}})},H=this,J=0,u.label=3;case 3:return J<U?[5,w(J)]:[3,6];case 4:u.sent(),u.label=5;case 5:return J++,[3,3];case 6:K=[k,n,g,l,m].filter(function(a){return 0<a.featureSet.features.length}),L=0,N=K,u.label=7;case 7:if(!(L<N.length))return[3,10];C=N[L];O=C.featureSet.features.every(function(a){return a.symbol});!O||e&&e.forceFeatureAttributes||C.featureSet.features.forEach(function(a){delete a.attributes});
O&&delete C.layerDefinition.drawingInfo;return C.layerDefinition.drawingInfo&&C.layerDefinition.drawingInfo.renderer?[4,this._convertSvgRenderer(C.layerDefinition.drawingInfo.renderer)]:[3,9];case 8:u.sent(),u.label=9;case 9:return L++,[3,7];case 10:return[2,K.length?{featureCollection:{layers:K},showLabels:r}:null]}})})};h.prototype._createFeatureLayerJSON=function(a,b){var e,c,f,r;return d.__awaiter(this,void 0,void 0,function(){var k,n,l,g,m,h,q,t,v,y;return d.__generator(this,function(d){switch(d.label){case 0:this._legendLayers&&
this._legendLayers.push({id:a.id});n=a.renderer;if(a.featureReduction||n&&"dot-density"===n.type&&(!this._is11xService||2.6>parseFloat(this._cimVersion)))return[2,this._createScreenshotJSON(a,b)];l=b.layerView;g=b.printTemplate;m=b.view;h=n&&("valueExpression"in n&&n.valueExpression||"hasVisualVariables"in n&&n.hasVisualVariables());q="feature-layer"!==(null===(e=a.source)||void 0===e?void 0:e.type)&&"ogc-feature"!==(null===(c=a.source)||void 0===c?void 0:c.type);if(!this._is11xService&&h||a.featureReduction||
q||!n||"field"in n&&null!=n.field&&("string"!==typeof n.field||!a.getField(n.field)))return[3,3];d=a.write();k={id:d.id,title:d.title,opacity:d.opacity,minScale:d.minScale,maxScale:d.maxScale,url:d.url,layerDefinition:d.layerDefinition};k.showLabels=g.showLabels&&a.labelsVisible;this._setURLandToken(k,a);if(null===(r=null===(f=k.layerDefinition)||void 0===f?void 0:f.drawingInfo)||void 0===r||!r.renderer)return[3,2];delete k.layerDefinition.minScale;delete k.layerDefinition.maxScale;return[4,this._convertSvgRenderer(k.layerDefinition.drawingInfo.renderer)];
case 1:d.sent(),"visualVariables"in n&&n.visualVariables&&n.visualVariables[0]&&(t=n.visualVariables[0],"size"===t.type&&t.maxSize&&"number"!==typeof t.maxSize&&t.minSize&&"number"!==typeof t.minSize&&(v=aa.getSizeRangeAtScale(t,m.scale),k.layerDefinition.drawingInfo.renderer.visualVariables[0].minSize=v.minSize,k.layerDefinition.drawingInfo.renderer.visualVariables[0].maxSize=v.maxSize)),d.label=2;case 2:return[3,6];case 3:return[4,this._getGraphics(l)];case 4:return y=d.sent(),[4,this._createFeatureCollectionJSON(a,
y,g)];case 5:k=d.sent(),d.label=6;case 6:return[2,k]}})})};h.prototype._createGeoJSONLayer=function(a,b){var e=b.layerView,c=b.printTemplate;return d.__awaiter(this,void 0,void 0,function(){var b;return d.__generator(this,function(f){switch(f.label){case 0:return this._legendLayers&&this._legendLayers.push({id:a.id}),[4,this._getGraphics(e)];case 1:return b=f.sent(),[2,this._createFeatureCollectionJSON(a,b,c)]}})})};h.prototype._createGraphicsLayerJSON=function(a,b){var e=b.printTemplate;return d.__awaiter(this,
void 0,void 0,function(){return d.__generator(this,function(c){return[2,this._createFeatureCollectionJSON(a,null,e)]})})};h.prototype._createImageryLayerJSON=function(a){this._legendLayers&&this._legendLayers.push({id:a.id});var b={bandIds:a.bandIds,compressionQuality:a.compressionQuality,format:a.format,interpolation:a.interpolation};if(a.mosaicRule||a.definitionExpression)b.mosaicRule=a.exportImageServiceParameters.mosaicRule.toJSON();if(a.renderingRule||a.renderer)if(this._is11xService)a.renderingRule&&
(b.renderingRule=a.renderingRule.toJSON()),a.renderer&&(b.layerDefinition=b.layerDefinition||{},b.layerDefinition.drawingInfo=b.layerDefinition.drawingInfo||{},b.layerDefinition.drawingInfo.renderer=a.renderer.toJSON());else{var e=a.exportImageServiceParameters.combineRendererWithRenderingRule();e&&(b.renderingRule=e.toJSON())}this._setURLandToken(b,a);return b};h.prototype._createKMLLayerJSON=function(a,b){return d.__awaiter(this,void 0,void 0,function(){var e,c,f,r,k,n,l;return d.__generator(this,
function(g){switch(g.label){case 0:e=b.printTemplate;if(this._is11xService)return c={type:"kml"},a.write(c,{origin:"web-map"}),delete c.layerType,c.url=A.normalize(a.url),[2,c];f=[];r=b.layerView;r.allVisibleMapImages.forEach(function(c,b){b={id:a.id+"_image"+b,type:"image",title:a.id,minScale:a.minScale||0,maxScale:a.maxScale||0,opacity:a.opacity,extent:c.extent};"data:image/png;base64,"===c.href.substr(0,22)?b.imageData=c.href.substr(22):b.url=c.href;f.push(b)});k=d.__spreadArrays(r.allVisiblePoints.items,
r.allVisiblePolylines.items,r.allVisiblePolygons.items);l=[{id:a.id}];return[4,this._createFeatureCollectionJSON(null,k,e)];case 1:return n=d.__assign.apply(void 0,l.concat([g.sent()])),f.push(n),[2,f]}})})};h.prototype._createMapImageLayerJSON=function(a,b){var e,c={id:a.id,subLayerIds:[]},f=[],d=b.view.scale,k=function(a){var b=0===d,e=0===a.minScale||d<=a.minScale,m=0===a.maxScale||d>=a.maxScale;a.visible&&(b||e&&m)&&(a.sublayers?a.sublayers.forEach(k):(b=a.toExportImageJSON(),f.unshift({id:a.id,
name:a.title,layerDefinition:{drawingInfo:b.drawingInfo,definitionExpression:b.definitionExpression,source:b.source}}),c.subLayerIds.push(a.id)))};a.sublayers&&a.sublayers.forEach(k);f.length&&(f=f.map(function(a){return{id:a.id,name:a.name,layerDefinition:a.layerDefinition}}),e={layers:f,visibleLayers:c.subLayerIds},this._setURLandToken(e,a),this._legendLayers.push(c));return e};h.prototype._createMapNotesLayerJSON=function(a){var b=a.layerView,e=a.printTemplate;return d.__awaiter(this,void 0,void 0,
function(){var a,f,r,k,n;return d.__generator(this,function(c){switch(c.label){case 0:a=[],f=0,r=b.graphicsViews,c.label=1;case 1:if(!(f<r.length))return[3,4];k=r[f];return[4,this._createFeatureCollectionJSON(k,k.graphics,e)];case 2:(n=c.sent())&&a.push.apply(a,n.featureCollection.layers),c.label=3;case 3:return f++,[3,1];case 4:return[2,{featureCollection:{layers:a}}]}})})};h.prototype._createOpenStreetMapLayerJSON=function(){return{type:"OpenStreetMap"}};h.prototype._createScreenshotJSON=function(a,
b){var e=b.printTemplate,c=b.view;return d.__awaiter(this,void 0,void 0,function(){var b,r,k,n,l,g,m,h,q,t;return d.__generator(this,function(d){switch(d.label){case 0:return b={type:"image"},r={format:"png",ignoreBackground:!0,layers:[a],rotation:0},k=this._ssExtent||c.extent.clone(),n=96,g=l=!0,e.exportOptions&&(m=e.exportOptions,0<m.dpi&&(n=m.dpi),0<m.width&&(l=m.width%2===c.width%2),0<m.height&&(g=m.height%2===c.height%2)),"map-only"!==e.layout||!e.scalePreserved||e.outScale&&e.outScale!==c.scale||
96!==n||l&&g||(r.area={x:0,y:0,width:c.width,height:c.height},l||--r.area.width,g||--r.area.height,this._ssExtent||(h=c.toMap(w.createScreenPoint(r.area.width,r.area.height)),k.ymin=h.y,k.xmax=h.x,this._ssExtent=k)),b.extent=k.clone()._normalize(!0).toJSON(),[4,c.takeScreenshot(r)];case 1:return q=d.sent(),t=A.dataComponents(q.dataUrl),b.imageData=t.data,[2,b]}})})};h.prototype._createStreamLayerJSON=function(a,b){var e=b.layerView,c=b.printTemplate;return d.__awaiter(this,void 0,void 0,function(){var b;
return d.__generator(this,function(d){switch(d.label){case 0:return this._legendLayers&&this._legendLayers.push({id:a.id}),[4,this._getGraphics(e)];case 1:return b=d.sent(),[2,this._createFeatureCollectionJSON(a,b,c)]}})})};h.prototype._createTileLayerJSON=function(a){var b={};this._setURLandToken(b,a);return b};h.prototype._createVectorTileLayerJSON=function(a,b){return d.__awaiter(this,void 0,void 0,function(){var e,c,f;return d.__generator(this,function(d){return this._is11xService&&a.serviceUrl&&
a.styleUrl&&(e=D.id&&D.id.findCredential(a.styleUrl),c=D.id&&D.id.findCredential(a.serviceUrl),!e&&!c||"2.1.0"!==this._cimVersion)?(f={type:"VectorTileLayer"},f.styleUrl=A.normalize(a.styleUrl),e&&(f.token=e.token),c&&c.token!==f.token&&(f.additionalTokens=[{url:a.serviceUrl,token:c.token}]),[2,f]):[2,this._createScreenshotJSON(a,b)]})})};h.prototype._createWebTileLayerJSON=function(a){var b={type:"WebTiledLayer",urlTemplate:a.urlTemplate.replace(/\${/g,"{"),credits:a.copyright};a.subDomains&&0<a.subDomains.length&&
(b.subDomains=a.subDomains);return b};h.prototype._createWMSLayerJSON=function(a){var b,e=[],c=function(a){a.visible&&(a.sublayers?a.sublayers.forEach(c):a.name&&e.unshift(a.name))};a.sublayers&&a.sublayers.forEach(c);e.length&&(b={type:"wms",customLayerParameters:a.customLayerParameters,customParameters:a.customParameters,transparentBackground:a.imageTransparency,visibleLayers:e,url:A.normalize(a.url),version:a.version});return b};h.prototype._createWMTSLayerJSON=function(a){var b=a.activeLayer;
return{type:"wmts",customLayerParameters:a.customLayerParameters,customParameters:a.customParameters,format:b.imageFormat,layer:b.id,style:b.styleId,tileMatrixSet:b.tileMatrixSetId,url:A.normalize(a.url)}};h.prototype._setURLandToken=function(a,b){var e;b.url&&(a.url=A.normalize(a.url||b.url),b=null===(e=D.id)||void 0===e?void 0:e.findCredential(b.url))&&(a.token=b.token)};h.prototype._convertSvgToPictureMarkerSymbolJson=function(a){var b;return d.__awaiter(this,void 0,void 0,function(){var e,c,f,
h,k,n,l,g,m,u,G,t,v,y,x,z;return d.__generator(this,function(d){switch(d.label){case 0:if(Q("trident"))return[2,null];this._canvas||(this._canvas=document.createElement("canvas"));e=1024;this._canvas.width=e;this._canvas.height=e;c=this._canvas.getContext("2d");if(!a.path)return[3,4];k=void 0;if(!Q("edge"))return[3,2];k=new Path2D;return[4,new Promise(function(a,b){V(["../libs/draw-svg-path/index"],a,b)})];case 1:return n=d.sent(),n.draw(k,a.path),[3,3];case 2:k=new Path2D(a.path),d.label=3;case 3:k.closePath();
c.fillStyle=Array.isArray(a.color)?"rgba("+a.color[0]+","+a.color[1]+","+a.color[2]+","+a.color[3]/255+")":"rgb(0,0,0)";c.fill(k);l=q.getContextBoundingBox(c);if(!l)return[2,null];c.clearRect(0,0,e,e);g=w.pt2px(a.size)/Math.max(l.width,l.height);c.scale(g,g);m=e/g;u=m/2-l.width/2-l.x;G=m/2-l.height/2-l.y;c.translate(u,G);Array.isArray(a.color)&&c.fill(k);(null===(b=a.outline)||void 0===b?0:b.width)&&Array.isArray(a.outline.color)&&(t=a.outline,c.lineWidth=w.pt2px(t.width)/g,c.lineJoin="round",c.strokeStyle=
"rgba("+t.color[0]+","+t.color[1]+","+t.color[2]+","+t.color[3]/255+")",c.stroke(k),l.width+=c.lineWidth,l.height+=c.lineWidth);l.width*=g;l.height*=g;v=c.getImageData(e/2-l.width/2,e/2-l.height/2,Math.ceil(l.width),Math.ceil(l.height));f=v.width;h=v.height;c.canvas.width=f;c.canvas.height=h;c.putImageData(v,0,0);return[3,6];case 4:return y="image/svg+xml"===a.contentType?"data:image/svg+xml;base64,"+a.imageData:a.url,[4,P(y,{responseType:"image"})];case 5:x=d.sent().data,f=w.pt2px(a.width),h=w.pt2px(a.height),
c.canvas.width=f,c.canvas.height=h,c.drawImage(x,0,0,c.canvas.width,c.canvas.height),d.label=6;case 6:return z=c.canvas.toDataURL("image/png"),[2,{type:"esriPMS",imageData:z.substr(22),angle:a.angle,contentType:"image/png",height:w.px2pt(h),width:w.px2pt(f),xoffset:a.xoffset,yoffset:a.yoffset}]}})})};h.prototype._convertSvgRenderer=function(a){return d.__awaiter(this,void 0,void 0,function(){var b,e,c,f,h,k,n,l,g;return d.__generator(this,function(d){switch(d.label){case 0:b=a.type;if("simple"!==
b||!I(a.symbol))return[3,2];e=a;return[4,this._convertSvgToPictureMarkerSymbolJson(a.symbol)];case 1:return e.symbol=d.sent(),[3,8];case 2:if("unique-value"!==b&&"class-breaks"!==b)return[3,8];if(!I(a.defaultSymbol))return[3,4];c=a;return[4,this._convertSvgToPictureMarkerSymbolJson(a.defaultSymbol)];case 3:c.defaultSymbol=d.sent(),d.label=4;case 4:f="unique-value"===b?"uniqueValueInfos":"classBreakInfos";h=a[f];if(!h)return[3,8];k=0;n=h;d.label=5;case 5:if(!(k<n.length))return[3,8];l=n[k];if(!I(l.symbol))return[3,
7];g=l;return[4,this._convertSvgToPictureMarkerSymbolJson(l.symbol)];case 6:g.symbol=d.sent(),d.label=7;case 7:return k++,[3,5];case 8:return[2]}})})};h.prototype._getGraphics=function(a){return a.queryFeatures(ia).then(function(a){return a.features})};h.prototype._getPrintDefinition=function(a,b){return d.__awaiter(this,void 0,void 0,function(){var e,c,f,h,k;return d.__generator(this,function(d){switch(d.label){case 0:return e=a.view,c=e.spatialReference,h={},[4,this._createOperationalLayers(e,b)];
case 1:return f=(h.operationalLayers=d.sent(),h),k=this._ssExtent||a.extent||e.extent,c&&c.isWrappable&&(k=k.clone()._normalize(!0),c=k.spatialReference),f.mapOptions={extent:k&&k.toJSON(),spatialReference:c&&c.toJSON(),showAttribution:b.attributionVisible},this._ssExtent=null,e.rotation&&(f.mapOptions.rotation=-e.rotation),b.scalePreserved&&(f.mapOptions.scale=b.outScale||e.scale),[2,f]}})})};h.prototype._getGpPrintParams=function(a){return d.__awaiter(this,void 0,void 0,function(){var b,e,c,f,h,
k,n,l,g,m,q,w,t,v,y,x,z,B,A,p=this;return d.__generator(this,function(d){switch(d.label){case 0:b=a.template||new fa;null==b.showLabels&&(b.showLabels=!0);e=b.exportOptions;f=ea.toJSON(b.layout);e&&(h=e.dpi,c={dpi:h},"map_only"===f.toLowerCase()||""===f)&&(k=e.width,n=e.height,c.outputSize=[k,n]);if(l=b.layoutOptions){q=m=void 0;if("Miles"===l.scalebarUnit||"Kilometers"===l.scalebarUnit)m="Kilometers",q="Miles";else if("Meters"===l.scalebarUnit||"Feet"===l.scalebarUnit)m="Meters",q="Feet";g={titleText:l.titleText,
authorText:l.authorText,copyrightText:l.copyrightText,customTextElements:l.customTextElements,scaleBarOptions:{metricUnit:T.toJSON(m),metricLabel:S[m],nonMetricUnit:T.toJSON(q),nonMetricLabel:S[q]}}}w=null;l&&l.legendLayers&&(w=l.legendLayers.map(function(a){p._legendLayerNameMap[a.layerId]=a.title;var b={id:a.layerId};a.subLayerIds&&(b.subLayerIds=a.subLayerIds);return b}));return[4,this._getPrintDefinition(a,b)];case 1:return t=d.sent(),t.operationalLayers&&(v=/[\u4E00-\u9FFF\u0E00-\u0E7F\u0900-\u097F\u3040-\u309F\u30A0-\u30FF\u31F0-\u31FF]/,
y=/[\u0600-\u06FF]/,x=function(a){var b=a.text,c=(a=a.font)&&a.family&&a.family.toLowerCase();b&&a&&("arial"===c||"arial unicode ms"===c)&&(a.family=v.test(b)?"Arial Unicode MS":"Arial","normal"!==a.style&&y.test(b)&&(a.family="Arial Unicode MS"))},z=function(){throw new W("print-task:cim-symbol-unsupported","CIMSymbol is not supported by a print service published from ArcMap");},t.operationalLayers.forEach(function(a){var b,c,d;(null===(b=a.featureCollection)||void 0===b?0:b.layers)?a.featureCollection.layers.forEach(function(a){var b,
c,d,e;if(null===(d=null===(c=null===(b=a.layerDefinition)||void 0===b?void 0:b.drawingInfo)||void 0===c?void 0:c.renderer)||void 0===d?0:d.symbol)b=a.layerDefinition.drawingInfo.renderer,"esriTS"===b.symbol.type?x(b.symbol):"CIMSymbolReference"!==b.symbol.type||p._is11xService||z();(null===(e=a.featureSet)||void 0===e?0:e.features)&&a.featureSet.features.forEach(function(a){a.symbol&&("esriTS"===a.symbol.type?x(a.symbol):"CIMSymbolReference"!==a.symbol.type||p._is11xService||z())})}):!p._is11xService&&
(null===(d=null===(c=a.layerDefinition)||void 0===c?void 0:c.drawingInfo)||void 0===d?0:d.renderer)&&R.includes(JSON.stringify(a.layerDefinition.drawingInfo.renderer),'"type":"CIMSymbolReference"')&&z()})),a.outSpatialReference&&(t.mapOptions.spatialReference=a.outSpatialReference.toJSON()),M.mixin(t,{exportOptions:c,layoutOptions:g}),M.mixin(t.layoutOptions,{legendOptions:{operationalLayers:null!=w?w:this._legendLayers.slice()}}),this._legendLayers.length=0,B=JSON.stringify(t),A={Web_Map_as_JSON:B,
Format:da.toJSON(b.format),Layout_Template:f},a.extraParameters&&M.mixin(A,a.extraParameters),[2,A]}})})};d.__decorate([F.property({dependsOn:["url"]})],h.prototype,"_geoprocessor",null);d.__decorate([F.property()],h.prototype,"_gpMetadata",void 0);d.__decorate([F.property({dependsOn:["_gpMetadata"],readOnly:!0})],h.prototype,"mode",null);d.__decorate([F.property()],h.prototype,"updateDelay",void 0);return h=d.__decorate([F.subclass("esri.tasks.PrintTask")],h)}(ca)});