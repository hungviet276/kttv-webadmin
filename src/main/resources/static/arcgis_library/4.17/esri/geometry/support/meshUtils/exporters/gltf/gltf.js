// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.17/esri/copyright.txt for details.
//>>built
define("require exports ../../../../../core/libs/gl-matrix-2/quat ../../../../../core/libs/gl-matrix-2/quatf64 ../../../../../core/libs/gl-matrix-2/vec3 ../../../../../core/libs/gl-matrix-2/vec3f64 ../../../MeshMaterialMetallicRoughness ../../georeference ./buffer ./geometry ./gltftypes ./imageutils".split(" "),function(x,v,C,y,z,p,D,E,A,B,d,w){Object.defineProperty(v,"__esModule",{value:!0});v.GLTF=void 0;x=function(){function f(a,b,c){this.params={};this.materialMap=[];this.gltf={asset:{version:"2.0",
copyright:a.copyright,generator:a.generator},extras:{options:b,binChunkBuffer:null,promises:[]}};c&&(this.params=c);this.addScenes(a)}f.prototype.addScenes=function(a){var b=this;this.gltf.scene=a.defaultScene;var c=this.gltf.extras.options.bufferOutputType===d.BufferOutputType.GLB||this.gltf.extras.options.imageOutputType===d.ImageOutputType.GLB;c&&(this.gltf.extras.binChunkBuffer=new A.Buffer(this.gltf));a.forEachScene(function(a){b.addScene(a)});c&&this.gltf.extras.binChunkBuffer.finalize()};f.prototype.addScene=
function(a){var b=this;this.gltf.scenes||(this.gltf.scenes=[]);var c={};a.name&&(c.name=a.name);a.forEachNode(function(a){c.nodes||(c.nodes=[]);a=b.addNode(a);c.nodes.push(a)});this.gltf.scenes.push(c)};f.prototype.addNode=function(a){var b=this;this.gltf.nodes||(this.gltf.nodes=[]);var c={};a.name&&(c.name=a.name);var g=a.translation;z.vec3.exactEquals(g,p.vec3f64.ZEROS)||(c.translation=p.vec3f64.clone(g));g=a.rotation;C.quat.exactEquals(g,y.quatf64.IDENTITY)||(c.rotation=y.quatf64.clone(g));g=a.scale;
z.vec3.exactEquals(g,p.vec3f64.ONES)||(c.scale=p.vec3f64.clone(g));a.mesh&&a.mesh.vertexAttributes.position?c.mesh=this.addMesh(a.mesh):a.forEachNode(function(a){c.children||(c.children=[]);a=b.addNode(a);c.children.push(a)});a=this.gltf.nodes.length;this.gltf.nodes.push(c);return a};f.prototype.addMesh=function(a){this.gltf.meshes||(this.gltf.meshes=[]);var b={primitives:[]},c=this.gltf.extras.options.bufferOutputType===d.BufferOutputType.GLB,g;g=c?this.gltf.extras.binChunkBuffer:new A.Buffer(this.gltf);
a=a.clone();this.params.origin||(this.params.origin=B.computeOrigin(a));a.rotate(-90,0,0,{origin:this.params.origin});B.smoothNormalsMesh(a);var k=E.ungeoreference(a.vertexAttributes,this.params.origin,{geographic:this.params.geographic,unit:"meters"});a.vertexAttributes.position=k.position;a.vertexAttributes.normal=k.normal;a.vertexAttributes.tangent=k.tangent;var k=g.addBufferView(d.ComponentType.FLOAT,d.DataType.VEC3,d.TargetBuffer.ARRAY_BUFFER),h;a.vertexAttributes.normal&&(h=g.addBufferView(d.ComponentType.FLOAT,
d.DataType.VEC3,d.TargetBuffer.ARRAY_BUFFER));var l;a.vertexAttributes.uv&&(l=g.addBufferView(d.ComponentType.FLOAT,d.DataType.VEC2,d.TargetBuffer.ARRAY_BUFFER));var m;a.vertexAttributes.tangent&&(m=g.addBufferView(d.ComponentType.FLOAT,d.DataType.VEC4,d.TargetBuffer.ARRAY_BUFFER));var n;a.vertexAttributes.color&&(n=g.addBufferView(d.ComponentType.UNSIGNED_BYTE,d.DataType.VEC4,d.TargetBuffer.ARRAY_BUFFER));k.startAccessor("POSITION");h&&h.startAccessor("NORMAL");l&&l.startAccessor("TEXCOORD_0");m&&
m.startAccessor("TANGENT");n&&n.startAccessor("COLOR_0");for(var f=a.vertexAttributes.position.length/3,e=0;e<f;++e)k.push(a.vertexAttributes.position[3*e+0]),k.push(a.vertexAttributes.position[3*e+1]),k.push(a.vertexAttributes.position[3*e+2]),h&&(h.push(a.vertexAttributes.normal[3*e+0]),h.push(a.vertexAttributes.normal[3*e+1]),h.push(a.vertexAttributes.normal[3*e+2])),l&&(l.push(a.vertexAttributes.uv[2*e+0]),l.push(a.vertexAttributes.uv[2*e+1])),m&&(m.push(a.vertexAttributes.tangent[4*e+0]),m.push(a.vertexAttributes.tangent[4*
e+1]),m.push(a.vertexAttributes.tangent[4*e+2]),m.push(a.vertexAttributes.tangent[4*e+3])),n&&(n.push(a.vertexAttributes.color[4*e+0]),n.push(a.vertexAttributes.color[4*e+1]),n.push(a.vertexAttributes.color[4*e+2]),n.push(a.vertexAttributes.color[4*e+3]));var f=k.endAccessor(),f=this.addAccessor(k.index,f),q;h&&(q=h.endAccessor(),q=this.addAccessor(h.index,q));var r;l&&(r=l.endAccessor(),r=this.addAccessor(l.index,r));var t;m&&(t=m.endAccessor(),t=this.addAccessor(m.index,t));var u;n&&(u=n.endAccessor(),
u=this.addAccessor(n.index,u));var p;a.components&&0<a.components.length&&a.components[0].faces?(p=g.addBufferView(d.ComponentType.UNSIGNED_INT,d.DataType.SCALAR,d.TargetBuffer.ELEMENT_ARRAY_BUFFER),this.addMeshVertexIndexed(p,a.components,b,f,q,r,t,u)):this.addMeshVertexNonIndexed(a.components,b,f,q,r,t,u);k.finalize();h&&h.finalize();l&&l.finalize();m&&m.finalize();p&&p.finalize();n&&n.finalize();c||g.finalize();c=this.gltf.meshes.length;this.gltf.meshes.push(b);return c};f.prototype.addMaterial=
function(a){if(null!==a){var b=this.materialMap.indexOf(a);if(-1!==b)return b;this.gltf.materials||(this.gltf.materials=[]);b={};switch(a.alphaMode){case "mask":b.alphaMode=d.AlphaMode.MASK;break;case "auto":case "blend":b.alphaMode=d.AlphaMode.BLEND}.5!==a.alphaCutoff&&(b.alphaCutoff=a.alphaCutoff);a.doubleSided&&(b.doubleSided=a.doubleSided);b.pbrMetallicRoughness={};var c=function(a){a=a.toRgba();a[0]=Math.pow(a[0]/255,2.1);a[1]=Math.pow(a[1]/255,2.1);a[2]=Math.pow(a[2]/255,2.1);return a};a.color&&
(b.pbrMetallicRoughness.baseColorFactor=c(a.color));a.colorTexture&&(b.pbrMetallicRoughness.baseColorTexture={index:this.addTexture(a.colorTexture)});a.normalTexture&&(b.normalTexture={index:this.addTexture(a.normalTexture)});a instanceof D?(a.emissiveTexture&&(b.emissiveTexture={index:this.addTexture(a.emissiveTexture)}),a.emissiveColor&&(c=c(a.emissiveColor),b.emissiveFactor=[c[0],c[1],c[2]]),a.occlusionTexture&&(b.occlusionTexture={index:this.addTexture(a.occlusionTexture)}),a.metallicRoughnessTexture&&
(b.pbrMetallicRoughness.metallicRoughnessTexture={index:this.addTexture(a.metallicRoughnessTexture)}),b.pbrMetallicRoughness.metallicFactor=a.metallic,b.pbrMetallicRoughness.roughnessFactor=a.roughness):(b.pbrMetallicRoughness.metallicFactor=1,b.pbrMetallicRoughness.roughnessFactor=1);c=this.gltf.materials.length;this.gltf.materials.push(b);this.materialMap.push(a);return c}};f.prototype.addTexture=function(a){this.gltf.textures||(this.gltf.textures=[]);a={sampler:this.addSampler(a),source:this.addImage(a)};
var b=this.gltf.textures.length;this.gltf.textures.push(a);return b};f.prototype.addImage=function(a){this.gltf.images||(this.gltf.images=[]);var b={};if(a.url)b.uri=a.url;else{b.extras=a.data;for(var c=0;c<this.gltf.images.length;++c)if(a.data===this.gltf.images[c].extras)return c;switch(this.gltf.extras.options.imageOutputType){case d.ImageOutputType.GLB:var g=this.gltf.extras.binChunkBuffer.addBufferView(d.ComponentType.UNSIGNED_BYTE,d.DataType.SCALAR);g.writeAsync(w.imageToArrayBuffer(a.data)).then(function(){g.finalize()});
b.bufferView=g.index;b.mimeType="image/png";break;case d.ImageOutputType.DataURI:b.uri=w.imageToDataURI(a.data);break;default:this.gltf.extras.promises.push(w.imageToArrayBuffer(a.data).then(function(a){b.uri=a}))}}a=this.gltf.images.length;this.gltf.images.push(b);return a};f.prototype.addSampler=function(a){this.gltf.samplers||(this.gltf.samplers=[]);var b=10497,c=10497;if("string"===typeof a.wrap)switch(a.wrap){case "clamp":c=b=33071;break;case "mirror":c=b=33648}else{switch(a.wrap.vertical){case "clamp":c=
33071;break;case "mirror":c=33648}switch(a.wrap.horizontal){case "clamp":b=33071;break;case "mirror":b=33648}}a={wrapS:b,wrapT:c};for(b=0;b<this.gltf.samplers.length;++b)if(JSON.stringify(a)===JSON.stringify(this.gltf.samplers[b]))return b;b=this.gltf.samplers.length;this.gltf.samplers.push(a);return b};f.prototype.addAccessor=function(a,b){this.gltf.accessors||(this.gltf.accessors=[]);a={bufferView:a,byteOffset:b.byteOffset,componentType:b.componentType,count:b.count,type:b.type,min:b.min,max:b.max,
name:b.name};b.normalized&&(a.normalized=!0);b=this.gltf.accessors.length;this.gltf.accessors.push(a);return b};f.prototype.addMeshVertexIndexed=function(a,b,c,d,f,h,l,m){for(var g=0;g<b.length;g++){var k=b[g];a.startAccessor("INDICES");for(var e=0;e<k.faces.length;++e)a.push(k.faces[e]);e=a.endAccessor();e={attributes:{POSITION:d},indices:this.addAccessor(a.index,e),material:this.addMaterial(k.material)};f&&"flat"!==k.shading&&(e.attributes.NORMAL=f);h&&(e.attributes.TEXCOORD_0=h);l&&"flat"!==k.shading&&
(e.attributes.TANGENT=l);m&&(e.attributes.COLOR_0=m);c.primitives.push(e)}};f.prototype.addMeshVertexNonIndexed=function(a,b,c,d,f,h,l){c={attributes:{POSITION:c}};d&&(c.attributes.NORMAL=d);f&&(c.attributes.TEXCOORD_0=f);h&&(c.attributes.TANGENT=h);l&&(c.attributes.COLOR_0=l);a&&(c.material=this.addMaterial(a[0].material));b.primitives.push(c)};return f}();v.GLTF=x});