// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.17/esri/copyright.txt for details.
//>>built
define(["require","exports","../../../../../core/promiseUtils","./gltftypes"],function(h,g,f,e){Object.defineProperty(g,"__esModule",{value:!0});g.BufferView=void 0;h=function(){function d(a,b,c,d,f){this.buffer=a;this.componentType=c;this.dataType=d;this.data=[];this.isFinalized=!1;this.accessorIndex=-1;this.accessorMax=this.accessorMin=this.accessorAttribute=null;b.bufferViews||(b.bufferViews=[]);this.index=b.bufferViews.length;this.bufferView={buffer:a.index,byteLength:-1,target:f};a=this.getElementSize();
4<=a&&f!==e.TargetBuffer.ELEMENT_ARRAY_BUFFER&&(this.bufferView.byteStride=a);b.bufferViews.push(this.bufferView)}d.prototype.push=function(a){var b=this.data.length;this.data.push(a);if(0<=this.accessorIndex){var b=b%this.numComponentsForDataType(),c=this.accessorMin[b];this.accessorMin[b]="number"!==typeof c?a:Math.min(c,a);c=this.accessorMax[b];this.accessorMax[b]="number"!==typeof c?a:Math.max(c,a)}};Object.defineProperty(d.prototype,"dataSize",{get:function(){return this.data.length*this.sizeComponentType()},
enumerable:!1,configurable:!0});Object.defineProperty(d.prototype,"size",{get:function(){return 4*Math.ceil(this.dataSize/4)},enumerable:!1,configurable:!0});d.prototype.getByteOffset=function(){if(!this.isFinalized)throw Error("Cannot get BufferView offset until it is finalized");return this.buffer.getByteOffset(this)};Object.defineProperty(d.prototype,"byteOffset",{get:function(){if(!this.isFinalized)throw Error("Cannot get BufferView offset until it is finalized");return this.buffer.getByteOffset(this)},
enumerable:!1,configurable:!0});d.prototype.writeOutToBuffer=function(a,b){void 0===b&&(b=this.size);a=new DataView(a,b);b=this.sizeComponentType();for(var c=0;c<this.data.length;++c)this.writeValue(a,c*b,this.data[c])};d.prototype.writeAsync=function(a){var b=this;if(this.asyncWritePromise)throw Error("Can't write multiple bufferView vlaues asynchronously");return this.asyncWritePromise=a.then(function(a){a=new Uint8Array(a);for(var c=0;c<a.byteLength;++c)b.data.push(a[c]);delete b.asyncWritePromise})};
d.prototype.startAccessor=function(a){if(0<=this.accessorIndex)throw Error("Accessor was started without ending the previous one");this.accessorIndex=this.data.length;this.accessorAttribute=a;a=this.numComponentsForDataType();this.accessorMin=Array(a);this.accessorMax=Array(a)};d.prototype.endAccessor=function(){if(0>this.accessorIndex)throw Error("An accessor was not started, but was attempted to be ended");var a=this.getElementSize(),b=this.numComponentsForDataType(),c=(this.data.length-this.accessorIndex)/
b;if(c%1)throw Error("An accessor was ended with missing component values");for(var d=0;d<this.accessorMin.length;++d)"number"!==typeof this.accessorMin[d]&&(this.accessorMin[d]=0),"number"!==typeof this.accessorMax[d]&&(this.accessorMax[d]=0);a={byteOffset:this.accessorIndex/b*a,componentType:this.componentType,count:c,type:this.dataType,min:this.accessorMin,max:this.accessorMax,name:this.accessorAttribute};switch(this.accessorAttribute){case "TEXCOORD_0":case "TEXCOORD_1":case "COLOR_0":case "WEIGHTS_0":switch(this.componentType){case e.ComponentType.UNSIGNED_BYTE:case e.ComponentType.UNSIGNED_SHORT:a.normalized=
!0}}this.accessorIndex=-1;this.accessorMax=this.accessorMin=this.accessorAttribute=null;return a};Object.defineProperty(d.prototype,"finalized",{get:function(){var a=this;return this.finalizedPromise?this.finalizedPromise:this.isFinalized?this.finalizedPromise=f.resolve():this.finalizedPromise=f.create(function(b){return a.finalizedPromiseResolve=b})},enumerable:!1,configurable:!0});d.prototype.finalize=function(){var a=this,b=this.bufferView;return f.create(function(b){var c=a.buffer.getViewFinalizePromises(a);
a.asyncWritePromise&&c.push(a.asyncWritePromise);b(f.eachAlways(c))}).then(function(){a.isFinalized=!0;b.byteOffset=a.getByteOffset();b.byteLength=a.dataSize;a.finalizedPromiseResolve&&a.finalizedPromiseResolve()})};d.prototype.getElementSize=function(){return this.sizeComponentType()*this.numComponentsForDataType()};d.prototype.sizeComponentType=function(){switch(this.componentType){case e.ComponentType.BYTE:case e.ComponentType.UNSIGNED_BYTE:return 1;case e.ComponentType.SHORT:case e.ComponentType.UNSIGNED_SHORT:return 2;
case e.ComponentType.UNSIGNED_INT:case e.ComponentType.FLOAT:return 4}};d.prototype.numComponentsForDataType=function(){switch(this.dataType){case e.DataType.SCALAR:return 1;case e.DataType.VEC2:return 2;case e.DataType.VEC3:return 3;case e.DataType.VEC4:case e.DataType.MAT2:return 4;case e.DataType.MAT3:return 9;case e.DataType.MAT4:return 16}};d.prototype.writeValue=function(a,b,c){switch(this.componentType){case e.ComponentType.BYTE:a.setInt8(b,c);break;case e.ComponentType.UNSIGNED_BYTE:a.setUint8(b,
c);break;case e.ComponentType.SHORT:a.setInt16(b,c,!0);break;case e.ComponentType.UNSIGNED_SHORT:a.setUint16(b,c,!0);break;case e.ComponentType.UNSIGNED_INT:a.setUint32(b,c,!0);break;case e.ComponentType.FLOAT:a.setFloat32(b,c,!0);break;default:throw Error("Unsupported data type: "+this.componentType);}};return d}();g.BufferView=h});