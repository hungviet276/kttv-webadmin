// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.17/esri/copyright.txt for details.
//>>built
define("require exports tslib ../../Color ../../core/Logger ../../core/promiseUtils ../../core/screenUtils ../../core/string ../../support/arcadeOnDemand ./CIMSymbolHelper ./SDFHelper ./utils ../../views/2d/arcade/callExpressionWithFeature".split(" "),function(la,D,J,V,W,X,Y,w,K,A,Q,x,L){function M(a){switch(a){case "Butt":return 0;case "Square":return 2;default:return 1}}function N(a){switch(a){case "Bevel":return 0;case "Miter":return 2;default:return 1}}function Z(a){switch(a){default:return"left";
case "Right":return"right";case "Center":return"center";case "Justify":return"justify"}}function aa(a){switch(a){default:return"top";case "Center":return"middle";case "Baseline":return"baseline";case "Bottom":return"bottom"}}function ba(a){var c="normal",e="normal";a&&(a=a.toLowerCase(),-1!==a.indexOf("italic")?c="italic":-1!==a.indexOf("oblique")&&(c="oblique"),-1!==a.indexOf("bold")?e="bold":-1!==a.indexOf("light")&&(e="lighter"));return{style:c,weight:e}}function R(a,c,e,b){var g;a[c]?g=a[c]:(g=
{},a[c]=g);g[e]=b}function S(a){return(a=a.markerPlacement)&&a.angleToLine?1:0}function ca(a,c,e,b,g,n){if(a){var q=a.symbolLayers;if(q){var h,l=A.CIMSymbolHelper.getSize(a);"CIMPointSymbol"===a.type&&"Map"===a.angleAlignment&&(h=1);for(var p=q.length;p--;){var d=q[p];if(d&&!1!==d.enable){var m=[];A.OverrideHelper.findApplicableOverrides(d,c,m);switch(d.type){case "CIMSolidFill":da(d,e,m,b,g);break;case "CIMPictureFill":ea(d,e,m,b,g);break;case "CIMHatchFill":fa(d,e,m,b,g);break;case "CIMGradientFill":var r=
e,k=b,u=g,v=w.numericHash(JSON.stringify(d)).toString();u.push({type:"fill",templateHash:v,materialHash:0===m.length?v:E(v,r,m,k),cim:d,materialOverrides:null,colorLocked:d.colorLocked,effects:d.effects,color:{r:128,g:128,b:128,a:1},height:0,angle:0,offsetX:0,offsetY:0,scaleX:1});break;case "CIMSolidStroke":ga(d,e,m,b,g,"CIMPolygonSymbol"===a.type,l);break;case "CIMPictureStroke":ha(d,e,m,b,g,"CIMPolygonSymbol"===a.type,l);break;case "CIMGradientStroke":var r=e,k=b,u=g,v="CIMPolygonSymbol"===a.type,
C=l,t=d.primitiveName,y=void 0!==d.width?d.width:4,z=M(d.capStyle),x=N(d.joinStyle),B=d.miterLimit,F=w.numericHash(JSON.stringify(d)).toString();u.push({type:"line",templateHash:F,materialHash:0===m.length?F:E(F,r,m,k),cim:d,materialOverrides:null,isOutline:v,colorLocked:d.colorLocked,effects:d.effects,color:{r:128,g:128,b:128,a:1},width:f(t,r,"Width",k,y),cap:f(t,r,"CapStyle",k,z),join:f(t,r,"JoinStyle",k,x),miterLimit:f(t,r,"MiterLimit",k,B),referenceWidth:C,zOrder:H(d.name),isDashed:!1});break;
case "CIMCharacterMarker":I(d,e,m,b,g);break;case "CIMPictureMarker":if(I(d,e,m,b,g))break;"CIMLineSymbol"===a.type&&(h=S(d));ia(d,e,m,b,g,h,l);break;case "CIMVectorMarker":if(I(d,e,m,b,g))break;"CIMLineSymbol"===a.type&&(h=S(d));r=e;k=b;u=g;v=h;C=l;t=n;if(x=d.markerGraphics)for(y=0,d.scaleSymbolsProportionally&&(z=d.frame)&&(y=z.ymax-z.ymin),z=0;z<x.length;z++)if(B=x[z])if(F=B.symbol)switch(F.type){case "CIMPointSymbol":case "CIMLineSymbol":case "CIMPolygonSymbol":ja(d,B,m,r,k,u,v,C,y,t);break;case "CIMTextSymbol":ka(d,
B,r,m,k,u,v,C,y)}break;default:T.error("Cannot analyze CIM layer",d.type)}}}}}}function da(a,c,e,b,g){var n=a.primitiveName,q=x.fromCIMColor(a.color),h=w.numericHash(JSON.stringify(a)).toString();g.push({type:"fill",templateHash:h,materialHash:0===e.length?h:function(){return h},cim:a,materialOverrides:null,colorLocked:a.colorLocked,color:f(n,c,"Color",b,q,B),height:0,angle:0,offsetX:0,offsetY:0,scaleX:1,effects:a.effects})}function ea(a,c,e,b,g){var n=a.primitiveName,q=a.tintColor?x.fromCIMColor(a.tintColor):
{r:255,g:255,b:255,a:1},h=w.numericHash(JSON.stringify(a)).toString(),l=w.numericHash(""+a.url+JSON.stringify(a.colorSubstitutions)).toString();g.push({type:"fill",templateHash:h,materialHash:0===e.length?l:function(){return l},cim:a,materialOverrides:null,colorLocked:a.colorLocked,effects:a.effects,color:f(n,c,"TintColor",b,q,B),height:f(n,c,"Height",b,a.height),scaleX:f(n,c,"ScaleX",b,a.scaleX),angle:f(n,c,"Rotation",b,a.rotation),offsetX:f(n,c,"OffsetX",b,a.offsetX),offsetY:f(n,c,"OffsetY",b,a.offsetY)})}
function fa(a,c,e,b,g){var n=["Rotation","OffsetX","OffsetY"],q=e.filter(function(d){return d.primitiveName!==a.primitiveName&&-1===n.indexOf(d.propertyName)}),h=a.primitiveName,l=w.numericHash(JSON.stringify(a)).toString(),p=w.numericHash(""+a.separation+JSON.stringify(a.lineSymbol)).toString();g.push({type:"fill",templateHash:l,materialHash:0===e.length?p:E(p,c,q,b),cim:a,materialOverrides:q,colorLocked:a.colorLocked,effects:a.effects,color:{r:255,g:255,b:255,a:1},height:f(h,c,"Separation",b,a.separation),
scaleX:1,angle:f(h,c,"Rotation",b,a.rotation),offsetX:f(h,c,"OffsetX",b,a.offsetX),offsetY:f(h,c,"OffsetY",b,a.offsetY)})}function ga(a,c,e,b,g,n,q){var h=w.numericHash(JSON.stringify(a)).toString(),l=a.primitiveName,p=x.fromCIMColor(a.color),d=void 0!==a.width?a.width:4,m=M(a.capStyle),r=N(a.joinStyle),k=a.miterLimit;g.push({type:"line",templateHash:h,materialHash:0===e.length?h:function(){return h},cim:a,materialOverrides:null,isOutline:n,colorLocked:a.colorLocked,effects:a.effects,color:f(l,c,
"Color",b,p,B),width:f(l,c,"Width",b,d),cap:f(l,c,"CapStyle",b,m),join:f(l,c,"JoinStyle",b,r),miterLimit:f(l,c,"MiterLimit",b,k),referenceWidth:q,zOrder:H(a.name),isDashed:!1})}function ha(a,c,e,b,g,n,q){var h=w.numericHash(""+a.url+JSON.stringify(a.colorSubstitutions)).toString(),l=a.primitiveName,p=x.fromCIMColor(a.tintColor),d=void 0!==a.width?a.width:4,m=M(a.capStyle),r=N(a.joinStyle),k=a.miterLimit,u=w.numericHash(JSON.stringify(a)).toString();g.push({type:"line",templateHash:u,materialHash:0===
e.length?h:function(){return h},cim:a,materialOverrides:null,isOutline:n,colorLocked:a.colorLocked,effects:a.effects,color:f(l,c,"TintColor",b,p,B),width:f(l,c,"Width",b,d),cap:f(l,c,"CapStyle",b,m),join:f(l,c,"JoinStyle",b,r),miterLimit:f(l,c,"MiterLimit",b,k),referenceWidth:q,zOrder:H(a.name),isDashed:!1})}function I(a,c,e,b,g){var n=a.markerPlacement;if(!n||"CIMMarkerPlacementInsidePolygon"!==n.type)return!1;var q=["Rotation","OffsetX","OffsetY"],h=e.filter(function(b){return b.primitiveName!==
a.primitiveName&&-1===q.indexOf(b.propertyName)}),l=w.numericHash(JSON.stringify(a)).toString();g.push({type:"fill",templateHash:l,materialHash:0===e.length?l:E(l,c,h,b),cim:a,materialOverrides:h,colorLocked:a.colorLocked,effects:a.effects,color:{r:255,g:255,b:255,a:1},height:f(n.primitiveName,c,"StepY",b,n.stepY),scaleX:1,angle:f(n.primitiveName,c,"GridAngle",b,n.gridAngle),offsetX:f(n.primitiveName,c,"OffsetX",b,n.offsetX),offsetY:f(n.primitiveName,c,"OffsetY",b,n.offsetY)});return!0}function ia(a,
c,e,b,g,n,q){for(var h=a.primitiveName,l=a.size,p=a.scaleX,d=a.rotation,m=a.offsetX,r=a.offsetY,k=x.fromCIMColor(a.tintColor),u=w.numericHash(""+a.url+JSON.stringify(a.colorSubstitutions)).toString(),v=!1,C="",t=0;t<e.length;t++){var y=e[t];y.primitiveName===h&&(void 0!==y.value?C+="-"+y.primitiveName+"-"+y.propertyName+"-"+JSON.stringify(y.value):y.valueExpressionInfo&&(v=!0))}g.push({type:"marker",templateHash:w.numericHash(JSON.stringify(a)+C).toString(),materialHash:v?function(){return u}:u,cim:a,
materialOverrides:null,colorLocked:a.colorLocked,effects:a.effects,scaleSymbolsProportionally:!1,alignment:n,size:f(h,c,"Size",b,l),scaleX:f(h,c,"ScaleX",b,p),rotation:f(h,c,"Rotation",b,d),offsetX:f(h,c,"OffsetX",b,m),offsetY:f(h,c,"OffsetY",b,r),color:f(h,c,"TintColor",b,k,B),anchorPoint:a.anchorPoint,isAbsoluteAnchorPoint:"Relative"!==a.anchorPointUnits,outlineColor:{r:0,g:0,b:0,a:0},outlineWidth:0,frameHeight:0,rotateClockwise:a.rotateClockwise,referenceSize:q,sizeRatio:1,markerPlacement:a.markerPlacement})}
function ka(a,c,e,b,g,n,q,h,l){A.OverrideHelper.findApplicableOverrides(c,b,[]);var p=c.geometry;if("x"in p&&"y"in p){var d=c.symbol,m;m=d.underline?"underline":d.strikethrough?"line-through":"none";var r=ba(d.fontStyleName);d.font=J.__assign({family:d.fontFamilyName,decoration:m},r);var k=a.frame,u=a.size/l;l=a.primitiveName;m=(d.height||0)*u;var r=d.angle||0,v=((d.offsetX||0)+(p.x-.5*(k.xmin+k.xmax)))*u,p=((d.offsetY||0)+(p.y-.5*(k.ymin+k.ymax)))*u,k=x.fromCIMColor(A.CIMSymbolHelper.getFillColor(d)),
C=x.fromCIMColor(A.CIMSymbolHelper.getStrokeColor(d)),t=A.CIMSymbolHelper.getStrokeWidth(d);t||(C=x.fromCIMColor(A.CIMSymbolHelper.getFillColor(d.haloSymbol)),t=d.haloSize*u);for(var u="",y=0;y<b.length;y++){var z=b[y];z.primitiveName===l&&void 0!==z.value&&(u+="-"+z.primitiveName+"-"+z.propertyName+"-"+JSON.stringify(z.value))}b=JSON.stringify(a.effects)+Number(a.colorLocked)+JSON.stringify(a.anchorPoint)+a.anchorPointUnits+JSON.stringify(a.markerPlacement);b=w.numericHash(JSON.stringify(c)+b+u).toString();
n.push({type:"text",templateHash:b,materialHash:function(){return w.numericHash(JSON.stringify(d.font)).toString()},cim:d,materialOverrides:null,colorLocked:a.colorLocked,effects:a.effects,alignment:q,anchorPoint:{x:a.anchorPoint?a.anchorPoint.x:0,y:a.anchorPoint?a.anchorPoint.y:0},isAbsoluteAnchorPoint:"Relative"!==a.anchorPointUnits,fontName:d.fontFamilyName,decoration:"none",weight:"normal",style:"normal",size:f(l,e,"Size",g,m),angle:f(l,e,"Rotation",g,r),offsetX:f(l,e,"OffsetX",g,v),offsetY:f(l,
e,"OffsetY",g,p),horizontalAlignment:Z(d.horizontalAlignment),verticalAlignment:aa(d.verticalAlignment),text:f(c.primitiveName,e,"TextString",g,c.textString,x._adjustTextCase,d.textCase),color:k,outlineColor:C,outlineSize:t,referenceSize:h,sizeRatio:1,markerPlacement:a.markerPlacement})}}function ja(a,c,e,b,g,n,q,h,l,p){var d=c.geometry;if(d){var m=c.symbol.symbolLayers;if(m)if(p)U(a,c,b,e,g,n,q,h,l);else{var r=m.length;for(p=function(){var k=m[r];if(!k||!1===k.enable)return"continue";switch(k.type){case "CIMSolidFill":case "CIMSolidStroke":var p=
Q.getExtent(d);if(!p)return"continue";var v=Q.getSDFMetrics(p,a.frame,a.size,a.anchorPoint,"Relative"!==a.anchorPointUnits),p=v[0],C=v[1],v=v[2],t="CIMSolidFill"===k.type,y={type:"sdf",geom:d,asFill:t},z=a.primitiveName,D=a.size,E=a.rotation||0,F=a.offsetX,K=a.offsetY,O=k.primitiveName,M=t?x.fromCIMColor(A.CIMSymbolHelper.getFillColor(k)):x.fromCIMColor(A.CIMSymbolHelper.getStrokeColor(k)),N=t?{r:0,g:0,b:0,a:0}:x.fromCIMColor(A.CIMSymbolHelper.getStrokeColor(k)),H=A.CIMSymbolHelper.getStrokeWidth(k);
if(!t&&!H)break;for(var t=!1,I="",P=0;P<e.length;P++){var G=e[P];if(G.primitiveName===O||G.primitiveName===z)void 0!==G.value?I+="-"+G.primitiveName+"-"+G.propertyName+"-"+JSON.stringify(G.value):G.valueExpressionInfo&&(t=!0)}var z=JSON.stringify(J.__assign(J.__assign({},a),{markerGraphics:null})),L=w.numericHash(JSON.stringify(y)).toString(),k={type:"marker",templateHash:w.numericHash(JSON.stringify(c)+JSON.stringify(k)+z+I).toString(),materialHash:t?function(){return L}:L,cim:y,materialOverrides:null,
colorLocked:a.colorLocked,effects:a.effects,scaleSymbolsProportionally:a.scaleSymbolsProportionally,alignment:q,anchorPoint:{x:C,y:v},isAbsoluteAnchorPoint:!1,size:f(a.primitiveName,b,"Size",g,D),rotation:f(a.primitiveName,b,"Rotation",g,E),offsetX:f(a.primitiveName,b,"OffsetX",g,F),offsetY:f(a.primitiveName,b,"OffsetY",g,K),scaleX:1,frameHeight:l,rotateClockwise:a.rotateClockwise,referenceSize:h,sizeRatio:p,color:f(O,b,"Color",g,M,B),outlineColor:f(O,b,"Color",g,N,B),outlineWidth:f(O,b,"Width",g,
H),markerPlacement:a.markerPlacement};n.push(k);break;default:U(a,c,b,e,g,n,q,h,l)}};r--;)p()}}}function U(a,c,e,b,g,n,q,h,l){c={type:a.type,enable:!0,name:a.name,colorLocked:a.colorLocked,primitiveName:a.primitiveName,anchorPoint:a.anchorPoint,anchorPointUnits:a.anchorPointUnits,offsetX:0,offsetY:0,rotateClockwise:a.rotateClockwise,rotation:0,size:a.size,billboardMode3D:a.billboardMode3D,depth3D:a.depth3D,frame:a.frame,markerGraphics:[c],scaleSymbolsProportionally:a.scaleSymbolsProportionally,respectFrame:a.respectFrame,
clippingPath:a.clippingPath,effects:a.effects};for(var p=[],d=["Rotation","OffsetX","OffsetY"],p=b.filter(function(b){return b.primitiveName!==a.primitiveName||-1===d.indexOf(b.propertyName)}),m="",r=0;r<b.length;r++){var k=b[r];void 0!==k.value&&(m+="-"+k.primitiveName+"-"+k.propertyName+"-"+JSON.stringify(k.value))}k=A.CIMSymbolHelper.getTextureAnchor(c);b=k[0];var r=k[1],k=k[2],u=a.primitiveName,v=a.rotation||0,x=a.offsetX||0,t=a.offsetY||0,m=w.numericHash(JSON.stringify(c)+m).toString();e={type:"marker",
templateHash:m,materialHash:0===p.length?m:E(m,e,p,g),cim:c,materialOverrides:p,colorLocked:a.colorLocked,effects:a.effects,scaleSymbolsProportionally:a.scaleSymbolsProportionally,alignment:q,anchorPoint:{x:b,y:r},isAbsoluteAnchorPoint:!1,size:a.size,rotation:f(u,e,"Rotation",g,v),offsetX:f(u,e,"OffsetX",g,x),offsetY:f(u,e,"OffsetY",g,t),color:{r:0,g:0,b:0,a:0},outlineColor:{r:0,g:0,b:0,a:0},outlineWidth:0,scaleX:1,frameHeight:l,rotateClockwise:a.rotateClockwise,referenceSize:h,sizeRatio:k/Y.pt2px(a.size),
markerPlacement:a.markerPlacement};n.push(e)}function H(a){return a&&0===a.indexOf("Level_")?parseInt(a.substr(6),10):0}function B(a){if(!a||0===a.length)return null;a=(new V(a)).toRgba();return{r:a[0],g:a[1],b:a[2],a:a[3]}}function f(a,c,e,b,g,f,q){if(a=c[a]){var h=a[e];if("string"===typeof h||"number"===typeof h||h instanceof Array)return f?f.call(null,h,q):h;if(null!=h&&h instanceof K.default)return function(a,c,d){a=L.default(h,a,{$view:d},b.geometryType,c);null!==a&&f&&(a=f.call(null,a,q));return null!==
a?a:g}}return g}function E(a,c,e,b){for(var g=function(a){if(a.valueExpressionInfo){var e=c[a.primitiveName]&&c[a.primitiveName][a.propertyName];e instanceof K.default&&(a.fn=function(a,c,d){return L.default(e,a,{$view:d},b.geometryType,c)})}},f=0;f<e.length;f++)g(e[f]);return function(b,c,g){for(var f=0;f<e.length;f++){var d=e[f];d.fn&&(d.value=d.fn(b,c,g))}return w.numericHash(a+A.OverrideHelper.buildOverrideKey(e)).toString()}}Object.defineProperty(D,"__esModule",{value:!0});D.analyzeCIMResource=
D.analyzeCIMSymbol=void 0;var T=W.getLogger("esri.symbols.cim.cimAnalyzer");D.analyzeCIMSymbol=function(a,c,e,b){return J.__awaiter(this,void 0,void 0,function(){var g,f,q,h,l,p,d,m,r;return J.__generator(this,function(k){switch(k.label){case 0:g=e?e:[];if(!a)return[2,g];h={};if("CIMSymbolReference"!==a.type)return[3,3];f=a.symbol;q=a.primitiveOverrides;if(!q)return[3,2];l=[];p=function(a){var b=a.valueExpressionInfo;b&&c?(b=K.createRendererExpression(b.expression,c.spatialReference,c.fields).then(function(b){b&&
R(h,a.primitiveName,a.propertyName,b)}),l.push(b)):null!=a.value&&R(h,a.primitiveName,a.propertyName,a.value)};d=0;for(m=q;d<m.length;d++)r=m[d],p(r);return[4,X.all(l)];case 1:k.sent(),k.label=2;case 2:return[3,4];case 3:return T.error("Expect cim type to be 'CIMSymbolReference'"),[2,g];case 4:switch(f.type){case "CIMPointSymbol":case "CIMLineSymbol":case "CIMPolygonSymbol":ca(f,q,h,c,g,b)}return[2,g]}})})};D.analyzeCIMResource=function(a,c){if(!c||0===c.length)return a;a=JSON.parse(JSON.stringify(a));
A.OverrideHelper.applyOverrides(a,c);return a}});