// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.17/esri/copyright.txt for details.
//>>built
define("require exports tslib ../../Color ../../core/Logger ../../core/mathUtils ../cim/CIMPlacements ./CIMSymbolDrawHelper ./packingUtils".split(" "),function(p,l,y,z,A,B,w,t,C){function u(g,a){switch(a.type){case "CIMSymbolReference":var b={type:"point",x:0,y:0};g.drawSymbol(a.symbol,b);break;case "CIMPointSymbol":b={type:"point",x:0,y:0};g.drawSymbol(a,b);break;case "CIMVectorMarker":b=new w.Placement,g.drawMarker(a,b)}return g.envelope()}Object.defineProperty(l,"__esModule",{value:!0});l.OverrideHelper=
l.SymbolHelper=l.CIMSymbolHelper=void 0;var x=Math.PI,D=x/2,v=A.getLogger("esri.symbols.cim.CIMSymbolHelper");p=function(){function g(){}g.getEnvelope=function(a){var b=new t.EnvDrawHelper;if(Array.isArray(a)){for(var c=void 0,d=0;d<a.length;d++){var f=a[d];c?c.union(u(b,f)):c=u(b,f)}return c}return u(b,a)};g.getTextureAnchor=function(a){a=this.getEnvelope(a);if(!a||0>=a.width||0>=a.height)return[0,0,0];var b=96/72,c=a.height*b+2;return[(a.x+.5*a.width)*b/(a.width*b+2),-(a.y+.5*a.height)*b/c,c]};
g.rasterize=function(a,b,c,d){void 0===d&&(d=!0);var f=c||this.getEnvelope(b);if(!f||0>=f.width||0>=f.height)return[null,0,0,0,0];var e=96/72,g=(f.x+.5*f.width)*e,h=(f.y+.5*f.height)*e;a.width=f.width*e;a.height=f.height*e;c||(a.width+=2,a.height+=2);c=a.getContext("2d");e=t.Transformation.createScale(e,-e);e.translate(.5*a.width-g,.5*a.height+h);e=new t.CanvasDrawHelper(c,e);switch(b.type){case "CIMPointSymbol":e.drawSymbol(b,{type:"point",x:0,y:0});break;case "CIMVectorMarker":f=new w.Placement,
e.drawMarker(b,f)}b=c.getImageData(0,0,a.width,a.height);b=new Uint8Array(b.data);if(d)for(d=void 0,c=0;c<b.length;c+=4)d=b[c+3]/255,b[c]*=d,b[c+1]*=d,b[c+2]*=d;return[b,a.width,a.height,-g/a.width,-h/a.height]};g.fromSimpleMarker=function(a){var b,c,d=a.style;if("circle"===d||"esriSMSCircle"===d){b=Math.acos(.995);c=Math.ceil(x/b/4);0===c&&(c=1);b=D/c;c*=4;d=[];d.push([50,0]);for(var f=1;f<c;f++)d.push([50*Math.cos(f*b),-50*Math.sin(f*b)]);d.push([50,0]);b={rings:[d]};c={xmin:-50,ymin:-50,xmax:50,
ymax:50}}else if("cross"===d||"esriSMSCross"===d)b=0,b={rings:[[[b,50],[b,b],[50,b],[50,-b],[b,-b],[b,-50],[-b,-50],[-b,-b],[-50,-b],[-50,b],[-b,b],[-b,50],[b,50]]]},c={xmin:-50,ymin:-50,xmax:50,ymax:50};else if("diamond"===d||"esriSMSDiamond"===d)b={rings:[[[-50,0],[0,50],[50,0],[0,-50],[-50,0]]]},c={xmin:-50,ymin:-50,xmax:50,ymax:50};else if("square"===d||"esriSMSSquare"===d)b={rings:[[[-50,-50],[-50,50],[50,50],[50,-50],[-50,-50]]]},c={xmin:-50,ymin:-50,xmax:50,ymax:50};else if("x"===d||"esriSMSX"===
d)b=0,b={rings:[[[0,b],[50-b,50],[50,50-b],[b,0],[50,b-50],[50-b,-50],[0,-b],[b-50,-50],[-50,b-50],[-b,0],[-50,50-b],[b-50,50],[0,b]]]},c={xmin:-50,ymin:-50,xmax:50,ymax:50};else if("triangle"===d||"esriSMSTriangle"===d)c=2/3*100,d=c-100,b={rings:[[[-57.735026918962575,d],[0,c],[57.735026918962575,d],[-57.735026918962575,d]]]},c={xmin:-57.735026918962575,ymin:d,xmax:57.735026918962575,ymax:c};else if("arrow"===d||"esriSMSArrow"===d)b={rings:[[[-50,50],[50,0],[-50,-50],[-33,-20],[-33,20],[-50,50]]]},
c={xmin:-50,ymin:-50,xmax:50,ymax:50};var e;b&&c&&(e=[{type:"CIMSolidFill",enable:!0,color:a.color}],a.outline&&e.push({type:"CIMSolidStroke",enable:!0,width:a.outline.width,color:a.outline.color}),e={type:"CIMPointSymbol",symbolLayers:[{type:"CIMVectorMarker",enable:!0,rotation:a.angle,size:a.size,offsetX:a.xoffset,offsetY:a.yoffset,frame:c,markerGraphics:[{type:"CIMMarkerGraphic",geometry:b,symbol:{type:"CIMPolygonSymbol",symbolLayers:e}}]}]});return e};g.fromCIMHatchFill=function(a){for(var b=
void 0!==a.separation?a.separation:4,c=b/2,d=this._getLineSymbolPeriod(a.lineSymbol)||4;4>d;)d*=2;d/=2;return{type:"CIMVectorMarker",frame:{xmin:-d,xmax:d,ymin:-c,ymax:c},markerGraphics:[{type:"CIMMarkerGraphic",geometry:{paths:[[[-d,0],[d,0]]]},symbol:a.lineSymbol}],size:b}};g._getLineSymbolPeriod=function(a){if(a){var b=this._getEffectsRepeat(a.effects);if(b)return b;if(a.symbolLayers)for(b=0,a=a.symbolLayers;b<a.length;b++){var c=a[b],d=this._getEffectsRepeat(c.effects);if(d)return d;if(c&&(c=
this._getPlacementRepeat(c.markerPlacement)))return c}}return 0};g._getEffectsRepeat=function(a){if(a)for(var b=0;b<a.length;b++){var c=a[b];if(c)switch(c.type){case "CIMGeometricEffectDashes":if((c=c.dashTemplate)&&c.length){for(var b=a=0,d=c;b<d.length;b++)a+=d[b];c.length&1&&(a*=2);return a}break;case "CIMGeometricEffectWave":return c.period;default:v.error("unsupported geometric effect type "+c.type)}}return 0};g._getPlacementRepeat=function(a){if(a)switch(a.type){case "CIMMarkerPlacementAlongLineSameSize":case "CIMMarkerPlacementAlongLineRandomSize":case "CIMMarkerPlacementAlongLineVariableSize":if((a=
a.placementTemplate)&&a.length){for(var b=0,c=0;c<a.length;c++)b+=a[c];a.length&1&&(b*=2);return b}}return 0};g.fromCIMInsidePolygon=function(a){var b=a.markerPlacement,c=b.stepX/2,d=b.stepY/2,c={xmin:-c,xmax:c,ymin:-d,ymax:d};a=y.__assign({type:a.type},a);a.markerPlacement=null;a.anchorPoint=null;return{type:"CIMVectorMarker",frame:c,markerGraphics:[{type:"CIMMarkerGraphic",geometry:{x:0,y:0},symbol:{type:"CIMPointSymbol",symbolLayers:[a]}}],size:b.stepY}};g.getFillColor=function(a){if(!a)return null;
switch(a.type){case "CIMPolygonSymbol":if(a.symbolLayers){var b=0;for(a=a.symbolLayers;b<a.length;b++){var c=g.getFillColor(a[b]);if(null!=c)return c}}break;case "CIMTextSymbol":return g.getFillColor(a.symbol);case "CIMSolidFill":return a.color}};g.getStrokeColor=function(a){if(a)switch(a.type){case "CIMPolygonSymbol":case "CIMLineSymbol":if(a.symbolLayers){var b=0;for(a=a.symbolLayers;b<a.length;b++){var c=g.getStrokeColor(a[b]);if(void 0!==c)return c}}break;case "CIMTextSymbol":return g.getStrokeColor(a.symbol);
case "CIMSolidStroke":return a.color}};g.getStrokeWidth=function(a){if(a)switch(a.type){case "CIMPolygonSymbol":case "CIMLineSymbol":if(a.symbolLayers){var b=0;for(a=a.symbolLayers;b<a.length;b++){var c=g.getStrokeWidth(a[b]);if(void 0!==c)return c}}break;case "CIMTextSymbol":return g.getStrokeWidth(a.symbol);case "CIMSolidStroke":case "CIMGradientStroke":case "CIMPictureStroke":return a.width}};g.getSize=function(a){if(a)switch(a.type){case "CIMPointSymbol":case "CIMLineSymbol":case "CIMPolygonSymbol":var b=
0;if(a.symbolLayers){var c=0;for(a=a.symbolLayers;c<a.length;c++){var d=g.getSize(a[c]);d>b&&(b=d)}}return b;case "CIMSolidStroke":case "CIMPictureStroke":case "CIMGradientStroke":return a.width;case "CIMCharacterMarker":case "CIMPictureMarker":case "CIMVectorMarker":return a.size}};g.getMarkerScaleRatio=function(a){if(a)switch(a.type){case "CIMVectorMarker":if(!1!==a.scaleSymbolsProportionally&&a.frame)return a.size/(a.frame.ymax-a.frame.ymin)}return 1};return g}();l.CIMSymbolHelper=p;p=function(){function g(){}
g.rasterizeSimpleFill=function(a,b,c){"solid"!==b&&"none"!==b&&"esriSFSSolid"!==b&&"esriSFSNull"!==b||console.error("Unexpected: style does not require rasterization");c=B.nextPowerOfTwo(Math.ceil(c));var d=16*c,f=2*c;a.width=d;a.height=d;var e=a.getContext("2d");e.strokeStyle="#FFFFFF";e.lineWidth=c;e.beginPath();if("vertical"===b||"cross"===b||"esriSFSCross"===b||"esriSFSVertical"===b)e.moveTo(d/2,-f),e.lineTo(d/2,d+f);if("horizontal"===b||"cross"===b||"esriSFSCross"===b||"esriSFSHorizontal"===
b)e.moveTo(-f,d/2),e.lineTo(d+f,d/2);if("forward-diagonal"===b||"diagonal-cross"===b||"esriSFSDiagonalCross"===b||"esriSFSForwardDiagonal"===b)e.moveTo(-f,-f),e.lineTo(d+f,d+f),e.moveTo(d-f,-f),e.lineTo(d+f,f),e.moveTo(-f,d-f),e.lineTo(f,d+f);if("backward-diagonal"===b||"diagonal-cross"===b||"esriSFSBackwardDiagonal"===b||"esriSFSDiagonalCross"===b)e.moveTo(d+f,-f),e.lineTo(-f,d+f),e.moveTo(f,-f),e.lineTo(-f,f),e.moveTo(d+f,d-f),e.lineTo(d-f,d+f);e.stroke();b=e.getImageData(0,0,a.width,a.height);
b=new Uint8Array(b.data);for(d=0;d<b.length;d+=4)c=b[d+3]/255,b[d]*=c,b[d+1]*=c,b[d+2]*=c;return[b,a.width,a.height]};g.rasterizeSimpleLine=function(a,b){switch(b){case "butt":b="Butt";break;case "square":b="Square";break;default:b="Round"}var c="Butt"===b;switch(a){case "dash":case "esriSLSDash":a=c?[4,3]:[3,4];break;case "dash-dot":case "esriSLSDashDot":a=c?[4,3,1,3]:[3,4,0,4];break;case "dot":case "esriSLSDot":a=c?[1,3]:[0,4];break;case "long-dash":case "esriSLSLongDash":a=c?[8,3]:[7,4];break;
case "long-dash-dot":case "esriSLSLongDashDot":a=c?[8,3,1,3]:[7,4,0,4];break;case "long-dash-dot-dot":case "esriSLSDashDotDot":a=c?[8,3,1,3,1,3]:[7,4,0,4,0,4];break;case "short-dash":case "esriSLSShortDash":a=c?[4,1]:[3,2];break;case "short-dash-dot":case "esriSLSShortDashDot":a=c?[4,1,1,1]:[3,2,0,2];break;case "short-dash-dot-dot":case "esriSLSShortDashDotDot":a=c?[4,1,1,1,1,1]:[3,2,0,2,0,2];break;case "short-dot":case "esriSLSShortDot":a=c?[1,1]:[0,2];break;case "solid":case "esriSLSSolid":case "none":v.error("Unexpected: style does not require rasterization");
a=[0,0];break;default:v.error("Tried to rasterize SLS, but found an unexpected style: "+a+"!"),a=[0,0]}return this.rasterizeDash(a,b)};g.rasterizeDash=function(a,b){var c="Butt"===b,d="Square"===b;b=!c&&!d;for(var f=0,e=0;e<a.length;e++)var g=a[e],f=f+g;for(var f=15*f,h=31*f,e=new Float32Array(h),k=b?225:15,g=0;g<h;++g)e[g]=k;for(var k=h=0,l=!0,p=0;p<a.length;p++){for(var g=a[p],h=k,k=k+15*g,n=h;n<k;){for(var r=0;31>r;){var g=r*f+n,q=b?(r-15)*(r-15):Math.abs(r-15);e[g]=l?c?Math.max(Math.max(h+7.5-
n,q),Math.max(n-k+7.5,q)):q:b?Math.min((n-h)*(n-h)+q,(n-k)*(n-k)+q):d?Math.min(Math.max(n-h,q),Math.max(k-n,q)):Math.min(Math.max(n-h+7.5,q),Math.max(k+7.5-n,q));r++}n++}l=!l}a=e.length;c=new Uint8Array(4*a);for(g=0;g<a;++g)C.packFloatRGBA((b?Math.sqrt(e[g]):e[g])/15,c,4*g);return[c,f,31]};return g}();l.SymbolHelper=p;p=function(){function g(){}g.findApplicableOverrides=function(a,b,c){if(b){if(a.primitiveName){for(var d=!1,f=0;f<c.length;f++){var e=c[f];if(e.primitiveName===a.primitiveName){d=!0;
break}}if(!d)for(d=0;d<b.length;d++)e=b[d],e.primitiveName===a.primitiveName&&c.push(e)}switch(a.type){case "CIMPointSymbol":case "CIMLineSymbol":case "CIMPolygonSymbol":if(a.effects)for(d=0,f=a.effects;d<f.length;d++)e=f[d],g.findApplicableOverrides(e,b,c);if(a.symbolLayers)for(e=0,a=a.symbolLayers;e<a.length;e++)g.findApplicableOverrides(a[e],b,c);break;case "CIMSolidStroke":case "CIMPictureStroke":case "CIMGradientStroke":case "CIMSolidFill":case "CIMPictureFill":case "CIMHatchFill":case "CIMGradientFill":case "CIMVectorMarker":case "CIMCharacterMarker":case "CIMPictureMarker":if(a.effects)for(d=
0,f=a.effects;d<f.length;d++)e=f[d],g.findApplicableOverrides(e,b,c);a.markerPlacement&&g.findApplicableOverrides(a.markerPlacement,b,c);if("CIMVectorMarker"===a.type){if(a.markerGraphics)for(e=0,a=a.markerGraphics;e<a.length;e++)d=a[e],g.findApplicableOverrides(d,b,c),g.findApplicableOverrides(d.symbol,b,c)}else"CIMCharacterMarker"===a.type?g.findApplicableOverrides(a.symbol,b,c):"CIMHatchFill"===a.type&&g.findApplicableOverrides(a.lineSymbol,b,c)}}};g.applyOverrides=function(a,b,c,d){if(b){if(a.primitiveName)for(var f=
0;f<b.length;f++){var e=b[f];if(e.primitiveName===a.primitiveName){var m;m=(m=e.propertyName)?m.charAt(0).toLowerCase()+m.substr(1):m;d&&d.push({cim:a,nocapPropertyName:m,value:a[m]});e.expression&&(e.value=g.toValue(e.propertyName,e.expression));if(c){for(var h=!1,k=0,l=c;k<l.length;k++)l[k].primitiveName===a.primitiveName&&(h=!0);h||c.push(e)}a[m]=e.value}}switch(a.type){case "CIMPointSymbol":case "CIMLineSymbol":case "CIMPolygonSymbol":if(a.effects)for(e=0,m=a.effects;e<m.length;e++)f=m[e],g.applyOverrides(f,
b,c,d);if(a.symbolLayers)for(f=0,a=a.symbolLayers;f<a.length;f++)g.applyOverrides(a[f],b,c,d);break;case "CIMSolidStroke":case "CIMSolidFill":case "CIMVectorMarker":if(a.effects)for(e=0,m=a.effects;e<m.length;e++)f=m[e],g.applyOverrides(f,b,c,d);if("CIMVectorMarker"===a.type&&a.markerGraphics)for(f=0,a=a.markerGraphics;f<a.length;f++)e=a[f],g.applyOverrides(e,b,c,d),g.applyOverrides(e.symbol,b,c,d)}}};g.restoreOverrides=function(a){for(var b=0;b<a.length;b++){var c=a[b];c.cim[c.nocapPropertyName]=
c.value}};g.buildOverrideKey=function(a){for(var b="",c=0;c<a.length;c++){var d=a[c];void 0!==d.value&&(b+=""+d.primitiveName+d.propertyName+JSON.stringify(d.value))}return b};g.toValue=function(a,b){return"DashTemplate"===a?b.split(" ").map(function(a){return Number(a)}):"Color"===a?(a=(new z(b)).toRgba(),a[3]*=255,a):b};return g}();l.OverrideHelper=p});