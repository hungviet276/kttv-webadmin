// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.17/esri/copyright.txt for details.
//>>built
define("require exports tslib ../../core/Logger ../../geometry/support/aaBoundingRect ../../geometry/support/boundsUtils ../../geometry/support/jsonUtils ../cim/CIMEffects ../cim/CIMOperators ../cim/CIMPlacements ./Rect".split(" "),function(m,k,v,p,x,y,h,z,w,A,B){Object.defineProperty(k,"__esModule",{value:!0});k.CanvasDrawHelper=k.EnvDrawHelper=k.CIMSymbolDrawHelper=k.Transformation=k.C_DEG_TO_RAD=void 0;k.C_DEG_TO_RAD=Math.PI/180;var C=p.getLogger("esri.symbols.cim.CIMSymbolDrawHelper"),u=function(){function c(a){this._t=
a}c.createIdentity=function(){return new c([1,0,0,0,1,0])};c.prototype.clone=function(){return new c(this._t.slice())};c.prototype.transform=function(a){var b=this._t;return[b[0]*a[0]+b[1]*a[1]+b[2],b[3]*a[0]+b[4]*a[1]+b[5]]};c.createScale=function(a,b){return new c([a,0,0,0,b,0])};c.prototype.scale=function(a,b){var d=this._t;d[0]*=a;d[1]*=a;d[2]*=a;d[3]*=b;d[4]*=b;d[5]*=b;return this};c.prototype.scaleRatio=function(){return Math.sqrt(this._t[0]*this._t[0]+this._t[1]*this._t[1])};c.createTranslate=
function(a,b){return new c([0,0,a,0,0,b])};c.prototype.translate=function(a,b){var d=this._t;d[2]+=a;d[5]+=b;return this};c.createRotate=function(a){var b=Math.cos(a);a=Math.sin(a);return new c([b,-a,0,a,b,0])};c.prototype.rotate=function(a){return this.multiply(c.createRotate(a))};c.prototype.multiply=function(a){var b=this._t;a=a._t;var d=b[1]*a[0]+b[4]*a[1],g=b[2]*a[0]+b[5]*a[1]+a[2],f=b[0]*a[3]+b[3]*a[4],e=b[1]*a[3]+b[4]*a[4],c=b[2]*a[3]+b[5]*a[4]+a[5];b[0]=b[0]*a[0]+b[3]*a[1];b[1]=d;b[2]=g;b[3]=
f;b[4]=e;b[5]=c;return this};return c}();k.Transformation=u;m=function(){function c(a){this._transfos=[];this._sizeTransfos=[];this._transfos.push(a||u.createIdentity());this._sizeTransfos.push(a?a.scaleRatio():1)}c.prototype.transformPt=function(a){return this._transfos[this._transfos.length-1].transform(a)};c.prototype.transformSize=function(a){return a*this._sizeTransfos[this._sizeTransfos.length-1]};c.prototype.back=function(){return this._transfos[this._transfos.length-1]};c.prototype.push=function(a,
b){b=b?a.scaleRatio():1;a.multiply(this.back());this._transfos.push(a);this._sizeTransfos.push(this._sizeTransfos[this._sizeTransfos.length-1]*b)};c.prototype.pop=function(){this._transfos.splice(-1,1);this._sizeTransfos.splice(-1,1)};c.prototype.drawSymbol=function(a,b){if(a)switch(a.type){case "CIMPointSymbol":case "CIMLineSymbol":case "CIMPolygonSymbol":this.drawMultiLayerSymbol(a,b)}};c.prototype.drawMultiLayerSymbol=function(a,b){if(a){var d=a.symbolLayers;if(d)if(a=a.effects){if(b=this.executeEffects(a,
b))for(a=b.next();a;)this.drawSymbolLayers(d,a),a=b.next()}else this.drawSymbolLayers(d,b)}};c.prototype.executeEffects=function(a,b){b=new z.SimpleGeometryCursor(b);for(var d=0;d<a.length;d++){var g=a[d],f=w.getEffectOperator(g);f&&(b=f.execute(b,g,1))}return b};c.prototype.drawSymbolLayers=function(a,b){for(var d=a.length;d--;){var g=a[d];if(g&&!1!==g.enable){var f=g.effects;if(f){if(f=this.executeEffects(f,b))for(var e=f.next();e;)this.drawSymbolLayer(g,e),e=f.next()}else this.drawSymbolLayer(g,
b)}}};c.prototype.drawSymbolLayer=function(a,b){switch(a.type){case "CIMSolidFill":this.drawSolidFill(b,a.color);break;case "CIMHatchFill":this.drawHatchFill(a,b);break;case "CIMSolidStroke":this.drawSolidStroke(b,a.color,a.width,a.capStyle,a.joinStyle,a.miterLimit);break;case "CIMCharacterMarker":case "CIMPictureMarker":case "CIMVectorMarker":this.drawMarkerLayer(a,b)}};c.prototype.drawHatchFill=function(a,b){var d=this._buildHatchPolyline(a,b,1);d&&(this.pushClipPath(b),this.drawMultiLayerSymbol(a.lineSymbol,
d),this.popClipPath())};c.prototype.drawMarkerLayer=function(a,b){var d=a.markerPlacement;if(d){var g=w.getPlacementOperator(d);if(g){var f="CIMMarkerPlacementInsidePolygon"===d.type;f&&this.pushClipPath(b);if(b=g.execute(b,d,1))for(d=b.next();d;)this.drawMarker(a,d),d=b.next();f&&this.popClipPath()}}else f=new A.Placement,f.tx=b.x,f.ty=b.y,this.drawMarker(a,f)};c.prototype.drawMarker=function(a,b){switch(a.type){case "CIMCharacterMarker":case "CIMPictureMarker":this.drawPictureMarker(a,b);break;
case "CIMVectorMarker":this.drawVectorMarker(a,b)}};c.prototype.drawPictureMarker=function(a,b){};c.prototype.drawVectorMarker=function(a,b){if(a){var d=a.markerGraphics;if(d){var g=a.size,f=a.frame,e=f?f.ymax-f.ymin:0,g=g&&e?g/e:1,e=u.createIdentity();f&&e.translate(.5*-(f.xmax+f.xmin),.5*-(f.ymax+f.ymin));var c=a.anchorPoint;if(c){var n=c.x,c=c.y;"Absolute"!==a.anchorPointUnits&&f&&(n*=f.xmax-f.xmin,c*=f.ymax-f.ymin);e.translate(-n,-c)}1!==g&&e.scale(g,g);a.rotation&&e.rotate(a.rotation*k.C_DEG_TO_RAD);
e.translate(a.offsetX||0,a.offsetY||0);e.translate(b.tx,b.ty);this.push(e,a.scaleSymbolsProportionally);for(a=0;a<d.length;a++)(b=d[a])&&b.symbol&&b.geometry||C.error("Invalid marker graphic",b),this.drawSymbol(b.symbol,b.geometry);this.pop()}}};c.prototype._buildHatchPolyline=function(a,b,d){var g=(void 0!==a.separation?a.separation:4)*d,f=void 0!==a.rotation?a.rotation:0;if(0===g)return null;0>g&&(g=-g);for(var e=0,c=.5*g;e>c;)e-=g;for(;e<-c;)e+=g;e=x.create();y.getBoundsXY(e,b);e[0]-=c;e[1]-=c;
e[2]+=c;e[3]+=c;for(var n=[[e[0],e[1]],[e[0],e[3]],[e[2],e[3]],[e[2],e[1]]];180<f;)f-=180;for(;0>f;)f+=180;var c=Math.cos(f*k.C_DEG_TO_RAD),l=Math.sin(f*k.C_DEG_TO_RAD),f=-g*l;b=g*c;var e=(void 0!==a.offsetX?a.offsetX*d:0)*l-(void 0!==a.offsetY?a.offsetY*d:0)*c,h,m;h=a=Number.MAX_VALUE;m=d=-Number.MAX_VALUE;for(var q=0;q<n.length;q++){var r=n[q],t=r[0],p=r[1],r=c*t+l*p,t=-l*t+c*p;h=Math.min(h,r);a=Math.min(a,t);m=Math.max(m,r);d=Math.max(d,t)}a=Math.floor(a/g)*g;n=c*h-l*a-f*e/g;h=l*h+c*a-b*e/g;q=
c*m-l*a-f*e/g;e=l*m+c*a-b*e/g;g=1+Math.round((d-a)/g);c=[];for(l=0;l<g;l++)n+=f,h+=b,q+=f,e+=b,c.push([[n,h],[q,e]]);return{paths:c}};return c}();k.CIMSymbolDrawHelper=m;p=function(c){function a(){var b=c.call(this)||this;b.reset();return b}v.__extends(a,c);a.prototype.reset=function(){this._xmin=this._ymin=Infinity;this._xmax=this._ymax=-Infinity;this._clipCount=0};a.prototype.envelope=function(){return new B.default(this._xmin,this._ymin,this._xmax-this._xmin,this._ymax-this._ymin)};a.prototype.drawSolidFill=
function(b){!b||0<this._clipCount||(h.isPolygon(b)?this._processPath(b.rings,0):h.isPolyline(b)&&this._processPath(b.paths,0))};a.prototype.drawSolidStroke=function(b,a,c){!b||0<this._clipCount||(a=.5*this.transformSize(c),h.isPolygon(b)?this._processPath(b.rings,a):h.isPolyline(b)&&this._processPath(b.paths,a))};a.prototype.pushClipPath=function(b){this.drawSolidFill(b);++this._clipCount};a.prototype.popClipPath=function(){--this._clipCount};a.prototype._processPath=function(b,a){if(b)for(var d=
0;d<b.length;d++){var c=b[d],e=c?c.length:0;if(1<e){this._merge(this.transformPt(c[0]),a);for(var h=1;h<e;++h)this._merge(this.transformPt(c[h]),a)}}};a.prototype._merge=function(b,a){b[0]-a<this._xmin&&(this._xmin=b[0]-a);b[0]+a>this._xmax&&(this._xmax=b[0]+a);b[1]-a<this._ymin&&(this._ymin=b[1]-a);b[1]+a>this._ymax&&(this._ymax=b[1]+a)};return a}(m);k.EnvDrawHelper=p;m=function(c){function a(a,d){d=c.call(this,d)||this;d._ctx=a;return d}v.__extends(a,c);a.prototype.drawSolidFill=function(a,d){if(a){if(h.isPolygon(a))this._buildPath(a.rings,
!0);else if(h.isPolyline(a))this._buildPath(a.paths,!0);else return;a=this._ctx;a.fillStyle="string"===typeof d?d:"rgba("+Math.round(d[0])+","+Math.round(d[1])+","+Math.round(d[2])+","+d[3]/255+")";a.fill("evenodd")}};a.prototype.drawSolidStroke=function(a,d,c,f,e,k){if(a&&d&&0!==c){if(h.isPolygon(a))this._buildPath(a.rings,!0);else if(h.isPolyline(a))this._buildPath(a.paths,!1);else return;a=this._ctx;a.strokeStyle="string"===typeof d?d:"rgba("+Math.round(d[0])+","+Math.round(d[1])+","+Math.round(d[2])+
","+d[3]/255+")";a.lineWidth=this.transformSize(c)+.5;this._setCapStyle(f);this._setJoinStyle(e);a.miterLimit=k;a.stroke()}};a.prototype.pushClipPath=function(a){this._ctx.save();h.isPolygon(a)?this._buildPath(a.rings,!0):h.isPolyline(a)&&this._buildPath(a.paths,!0);this._ctx.clip("evenodd")};a.prototype.popClipPath=function(){this._ctx.restore()};a.prototype._buildPath=function(a,c){var b=this._ctx;b.beginPath();if(a)for(var d=0;d<a.length;d++){var e=a[d],h=e?e.length:0;if(1<h){var k=this.transformPt(e[0]);
b.moveTo(k[0],k[1]);for(var l=1;l<h;++l)k=this.transformPt(e[l]),b.lineTo(k[0],k[1]);c&&b.closePath()}}};a.prototype._setCapStyle=function(a){switch(a){case "Butt":this._ctx.lineCap="butt";break;case "Round":this._ctx.lineCap="round";break;case "Square":this._ctx.lineCap="square"}};a.prototype._setJoinStyle=function(a){switch(a){case "Bevel":this._ctx.lineJoin="bevel";break;case "Round":this._ctx.lineJoin="round";break;case "Miter":this._ctx.lineJoin="miter"}};return a}(m);k.CanvasDrawHelper=m});