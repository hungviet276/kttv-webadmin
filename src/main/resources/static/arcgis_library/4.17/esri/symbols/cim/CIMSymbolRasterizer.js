// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.17/esri/copyright.txt for details.
//>>built
define("require exports tslib ../../request ../../core/promiseUtils ../../core/screenUtils ../../core/string ../../geometry/support/jsonUtils ./cimAnalyzer ./Rasterizer ./TextRasterizer ./utils ../support/cimSymbolUtils ../support/Symbol3DAnchorPosition2D".split(" "),function(F,r,t,L,G,n,M,C,H,N,O,m,P,Q){function R(c){return(c?Object.keys(c):[]).map(function(a){return{name:a,alias:a,type:"string"===typeof c[a]?"esriFieldTypeString":"esriFieldTypeDouble"}})}function S(c){if(!(c&&c.data&&c.data.symbol))return null;
switch(c.data.symbol.type){case "CIMPointSymbol":case "CIMTextSymbol":return"esriGeometryPoint";case "CIMLineSymbol":return"esriGeometryPolyline";case "CIMPolygonSymbol":return"esriGeometryPolygon";default:return null}}function y(c,a,b,d){if("function"===typeof c.materialHash){var e=c.materialHash;a=e(a,b,d);c=H.analyzeCIMResource(c.cim,c.materialOverrides)}else a=c.materialHash,c=c.cim;return{analyzedCIM:c,hash:a}}Object.defineProperty(r,"__esModule",{value:!0});r.CIMSymbolRasterizer=r.GeometryStyle=
void 0;var I;(function(c){c.Legend="legend";c.Preview="preview"})(I=r.GeometryStyle||(r.GeometryStyle={}));var E=function(c,a,b){if(c&&c.targetSize){var d=void 0;return d=b?c.targetSize/n.pt2px(Math.max(b.frame.xmax-b.frame.xmin,b.frame.ymax-b.frame.ymin)):c.targetSize/a.referenceSize}return c&&c.scaleFactor?c.scaleFactor:1},J={fill:{legend:{frame:{xmax:15,xmin:0,ymax:15,ymin:0},geometry:{rings:[[[0,15],[15,7.5],[15,0],[0,0],[0,15]]]},canvasPaths:{rings:[[[0,15],[0,0],[15,7.5],[15,15],[0,15]]]}},
preview:{frame:{xmax:100,xmin:0,ymax:100,ymin:0},geometry:{rings:[[[0,100],[100,100],[100,0],[0,0],[0,100]]]},canvasPaths:{rings:[[[0,100],[0,0],[100,0],[100,100],[0,100]]]}}},stroke:{legend:{frame:{xmax:24,xmin:0,ymax:-2,ymin:2},geometry:{paths:[[[0,0],[12,0],[24,0]]]},canvasPaths:{paths:[[[0,2],[12,2],[24,2]]]}},preview:{frame:{xmax:100,xmin:0,ymax:-2,ymin:2},geometry:{paths:[[[0,0],[50,0],[100,0]]]},canvasPaths:{paths:[[[0,2],[50,2],[100,2]]]}}}};F=function(){function c(a,b){this._spatialReference=
a;this._avoidSDF=b;this._resourceCache=new Map;this._rasterizer=new N.default;this._textRasterizer=new O.default;this._pictureMarkerCache=new Map}c.prototype.rasterizeCIMSymbolAsync=function(a,b,d,e,h,l,q,f){return t.__awaiter(this,void 0,void 0,function(){var g;return t.__generator(this,function(c){switch(c.label){case 0:return e=e||(b?null!=b.centroid?"esriGeometryPolygon":C.getJsonType(b.geometry):null)||S(a),[4,this.analyzeCIMSymbol(a,b?R(b.attributes):null,d,e,f)];case 1:return g=c.sent(),[2,
this.rasterizeCIMSymbol(g,b,e,h,l,q)]}})})};c.prototype.analyzeCIMSymbol=function(a,b,d,e,h){return t.__awaiter(this,void 0,void 0,function(){var l,q,f,g,c,k;return t.__generator(this,function(p){switch(p.label){case 0:return l=[],q=b?{geometryType:e,spatialReference:this._spatialReference,fields:b}:null,[4,H.analyzeCIMSymbol(a.data,q,l,this._avoidSDF)];case 1:p.sent();G.throwIfAborted(h);g=0;for(c=l;g<c.length;g++){k=c[g];if("CIMPictureMarker"===k.cim.type||"CIMPictureFill"===k.cim.type||"CIMPictureStroke"===
k.cim.type)f||(f=[]),f.push(this.fetchPictureMarkerResource(k,h));d&&"text"===k.type&&"string"===typeof k.text&&-1<k.text.indexOf("[")&&(k.text=m.createLabelOverrideFunction(d,k.text,k.cim.textCase))}return f?[4,G.all(f)]:[3,3];case 2:p.sent(),p.label=3;case 3:return[2,l]}})})};c.prototype.fetchPictureMarkerResource=function(a,b){return t.__awaiter(this,void 0,void 0,function(){var d,e,h;return t.__generator(this,function(c){switch(c.label){case 0:return d=a.materialHash,this._pictureMarkerCache.get(d)?
[3,2]:[4,L(a.cim.url,{responseType:"image",signal:b&&b.signal})];case 1:e=c.sent(),h=e.data,this._pictureMarkerCache.set(d,h),c.label=2;case 2:return[2]}})})};c.prototype.rasterizeCIMSymbol=function(a,b,d,e,h,c){for(var q=[],f=0;f<a.length;f++){var g=a[f];e&&"function"===typeof e.scaleFactor&&(e.scaleFactor=e.scaleFactor(b,h,c));var l=this._getRasterizedResource(g,b,d,e,h,c);if(l){var k=0,n=l.anchorX||0,w=l.anchorY||0,K=!1,r=0,z=0;if("esriGeometryPoint"===d)if(z=E(e,g,null),r=m.evaluateValueOrFunction(g.offsetX,
b,h,c)*z||0,z=m.evaluateValueOrFunction(g.offsetY,b,h,c)*z||0,"marker"===g.type)k=m.evaluateValueOrFunction(g.rotation,b,h,c)||0,K=g.rotateClockwise?g.rotateClockwise:!1;else if("text"===g.type){k=m.evaluateValueOrFunction(g.angle,b,h,c)||0;if(void 0!==g.horizontalAlignment)switch(g.horizontalAlignment){case "left":n=-.5;break;case "right":n=.5;break;default:n=0}if(void 0!==g.verticalAlignment)switch(g.verticalAlignment){case "top":w=.5;break;case "bottom":w=-.5;break;case "baseline":w=-.25;break;
default:w=0}}null!=l&&q.push({angle:k,rotateClockWise:K,anchorX:n,anchorY:w,offsetX:r,offsetY:z,rasterizedResource:l})}}return this.getSymbolImage(q)};c.prototype.getSymbolImage=function(a){for(var b=document.createElement("canvas"),d=b.getContext("2d"),e=0,c=0,l=0,q=0,f=[],g=0;g<a.length;g++){var p=a[g],k=p.rasterizedResource;if(k){var m=k.size,w=p.offsetX,r=p.offsetY,t=p.anchorX,z=p.anchorY,y=p.rotateClockWise||!1,p=p.angle,u=n.pt2px(w)-m[0]*(.5+t),A=n.pt2px(r)-m[1]*(.5+z),D=u+m[0],x=A+m[1];if(p){y&&
(p=-p);var v=Math.sin(p*Math.PI/180),B=Math.cos(p*Math.PI/180),m=u*B-A*v,C=u*v+A*B,E=u*B-x*v,F=u*v+x*B,G=D*B-x*v,x=D*v+x*B,H=D*B-A*v,v=D*v+A*B,u=Math.min(m,E,G,H),A=Math.min(C,F,x,v),D=Math.max(m,E,G,H),x=Math.max(C,F,x,v)}e=u<e?u:e;c=A<c?A:c;l=D>l?D:l;q=x>q?x:q;u=d.createImageData(k.size[0],k.size[1]);u.data.set(new Uint8ClampedArray(k.image.buffer));k={offsetX:w,offsetY:r,rotateClockwise:y,angle:p,rasterizedImage:u,anchorX:t,anchorY:z};f.push(k)}}b.width=l-e;b.height=q-c;a=-e;for(g=0;g<f.length;g++)k=
f[g],e=this._imageDataToCanvas(k.rasterizedImage),c=a-k.rasterizedImage.width*(.5+k.anchorX),l=q-k.rasterizedImage.height*(.5-k.anchorY),k.angle?(w=(360-k.angle)*Math.PI/180,d.save(),d.translate(n.pt2px(k.offsetX),-n.pt2px(k.offsetY)),d.translate(a,q),d.rotate(w),d.translate(-a,-q),d.drawImage(e,c,l),d.restore()):d.drawImage(e,c+n.pt2px(k.offsetX),l-n.pt2px(k.offsetY));f=new Q.default({x:a/b.width-.5,y:q/b.height-.5});return{imageData:0!==b.width&&0!==b.height?d.getImageData(0,0,b.width,b.height):
d.createImageData(1,1),anchorPosition:f}};c.prototype._imageDataToCanvas=function(a){this._imageDataCanvas||(this._imageDataCanvas=document.createElement("canvas"));var b=this._imageDataCanvas,d=b.getContext("2d");b.width=a.width;b.height=a.height;d.putImageData(a,0,0);return b};c.prototype._imageTo32Array=function(a,b,d){this._imageDataCanvas||(this._imageDataCanvas=document.createElement("canvas"));var c=this._imageDataCanvas,h=c.getContext("2d");c.width=b;c.height=d;h.drawImage(a,0,0,b,d);return new Uint32Array(h.getImageData(0,
0,b,d).data.buffer)};c.prototype._getRasterizedResource=function(a,b,c,e,h,l){var d,f,g;if("esriGeometryPolyline"===c||"esriGeometryPolygon"===c)if(d=e&&e.style?e.style:I.Legend,d="esriGeometryPolyline"===c?J.stroke[d]:J.fill[d],"line"===a.type)if("CIMSolidStroke"===a.cim.type)a=y(a,b,h,l),f=a.analyzedCIM,g=a.hash,f=this._embedCIMLayerInVectorMarker(f,d);else return"CIMPictureStroke"===a.cim.type?(f=m.evaluateValueOrFunction(a.width,b,h,l),g=e=c=void 0,b=this._getPictureResource(a,f),c=b.image,e=
b.width,g=b.height,this._rasterizePictureResource(a,c,e,g,d,f)):null;else if("marker"===a.type)if("CIMPictureMarker"!==a.cim.type&&"CIMVectorMarker"===a.cim.type)a.cim.offsetX=m.evaluateValueOrFunction(a.offsetX,b,h,l),a.cim.offsetY=m.evaluateValueOrFunction(a.offsetY,b,h,l),a.cim.rotation=m.evaluateValueOrFunction(a.rotation,b,h,l),a.cim.markerPlacement=a.markerPlacement,f=y(a,b,h,l).analyzedCIM,g=M.numericHash(JSON.stringify(f)).toString(),f=this._embedCIMLayerInVectorMarker(f,d);else return null;
else{if("text"===a.type)return null;if("fill"===a.type){if("CIMHatchFill"===a.cim.type||"CIMVectorMarker"===a.cim.type||"CIMPictureMarker"===a.cim.type||"CIMPictureFill"===a.cim.type)return f=a.cim.size||a.cim.height,g=e=c=void 0,"CIMPictureMarker"===a.cim.type||"CIMPictureFill"===a.cim.type?(b=this._getPictureResource(a,f),c=b.image,e=b.width,g=b.height):(b=y(a,b,h,l),f=b.analyzedCIM,g=b.hash,b=this._rasterizer.rasterizeJSONResource(f,1,this._avoidSDF),c=b.image,e=b.size[0],g=b.size[1]),this._rasterizePictureResource(a,
c,e,g,d,null);if("CIMSolidFill"===a.cim.type)a=y(a,b,h,l),f=a.analyzedCIM,g=a.hash,f=this._embedCIMLayerInVectorMarker(f,d);else return null}}else{if("text"===a.type)return d=this._rasterizeTextResource(a,b,e,h,l);d=y(a,b,h,l);f=d.analyzedCIM;g=d.hash;d=E(e,a,null);if("CIMPictureMarker"===a.cim.type)return f=m.evaluateValueOrFunction(a.size,b,h,l)*d,d=this._getPictureResource(a,f),c=d.image,e=d.width,g=d.height,d={image:c,size:[e,g],sdf:!1,simplePattern:!1,anchorX:a.anchorPoint?a.anchorPoint.x:0,
anchorY:a.anchorPoint?a.anchorPoint.y:0};P.scaleCIMMarker(f,d)}g+=c;e&&(g+=JSON.stringify(e));a=this._resourceCache;if(a.has(g))return a.get(g);d=this._rasterizer.rasterizeJSONResource(f,window.devicePixelRatio||1,this._avoidSDF);a.set(g,d);return d};c.prototype._rasterizeTextResource=function(a,b,c,e,h){var d=E(c,a,null);c=m.evaluateValueOrFunction(a.text,b,e,h);if(!c||0===c.length)return null;var q=m.evaluateValueOrFunction(a.fontName,b,e,h),f=m.evaluateValueOrFunction(a.style,b,e,h),g=m.evaluateValueOrFunction(a.weight,
b,e,h),p=m.evaluateValueOrFunction(a.decoration,b,e,h),d=m.evaluateValueOrFunction(a.size,b,e,h)*d,k=m.evaluateValueOrFunction(a.horizontalAlignment,b,e,h),n=m.evaluateValueOrFunction(a.verticalAlignment,b,e,h),r=m.colorToArray(m.evaluateValueOrFunction(a.color,b,e,h)),t=m.colorToArray(m.evaluateValueOrFunction(a.outlineColor,b,e,h));a=m.evaluateValueOrFunction(a.outlineSize,b,e,h);return this._textRasterizer.rasterizeText(c,{color:r,size:d,horizontalAlignment:k,verticalAlignment:n,font:{family:q,
style:f,weight:g,decoration:p},halo:{size:a||0,color:t,style:f},pixelRatio:1,premultiplyColors:!this._avoidSDF})};c.prototype._rasterizePictureResource=function(a,b,c,e,h,l){var d=document.createElement("canvas"),f=d.getContext("2d");d.height=n.pt2px(Math.max(Math.abs(h.frame.ymax-h.frame.ymin),l));d.width=n.pt2px(Math.abs(h.frame.xmax-h.frame.xmin));c=f.createImageData(c,e);c.data.set(new Uint8ClampedArray(b.buffer));b=this._imageDataToCanvas(c);b=f.createPattern(b,"repeat");c=Math.cos((-a.cim.rotation||
0)*Math.PI/180);e=Math.sin((-a.cim.rotation||0)*Math.PI/180);b.setTransform({m11:c,m12:e,m21:-e,m22:c,m41:n.pt2px(a.cim.offsetX)||0,m42:n.pt2px(a.cim.offsetY)||0});a=h.canvasPaths;var g,m,k;C.isPolygon(a)?(g=a.rings,f.fillStyle=b,m=f.fill,k=["evenodd"]):C.isPolyline(a)&&(g=a.paths,f.strokeStyle=b,f.lineWidth=l,m=f.stroke,g[0][0][1]=d.height/2,g[0][1][1]=d.height/2);f.beginPath();for(l=0;l<g.length;l++)if(h=(a=g[l])?a.length:0,1<h){b=a[0];f.moveTo(n.pt2px(b[0]),n.pt2px(b[1]));for(c=1;c<h;++c)b=a[c],
f.lineTo(n.pt2px(b[0]),n.pt2px(b[1]));f.closePath()}m.apply(f,k);f=f.getImageData(0,0,d.width,d.height);f=new Uint8Array(f.data);return{size:[d.width,d.height],image:new Uint32Array(f.buffer),sdf:!1,simplePattern:!1,anchorX:0,anchorY:0}};c.prototype._getPictureResource=function(a,b){a=this._pictureMarkerCache.get(a.materialHash);if(!a)return null;var c=a.height/a.width,e=b?1<c?n.pt2px(b):n.pt2px(b)/c:a.width;b=b?1<c?n.pt2px(b)*c:n.pt2px(b):a.height;return{image:this._imageTo32Array(a,e,b),width:e,
height:b}};c.prototype._embedCIMLayerInVectorMarker=function(a,b){var c=C.isPolygon(b.geometry)?"CIMPolygonSymbol":"CIMLineSymbol";return{type:"CIMVectorMarker",frame:b.frame,markerGraphics:[{type:"CIMMarkerGraphic",geometry:b.geometry,symbol:{type:c,symbolLayers:[a]}}]}};return c}();r.CIMSymbolRasterizer=F});