// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.17/esri/copyright.txt for details.
//>>built
define("require exports tslib ../../../core/arrayUtils ../../../intl/messages ../../../intl/substitute ../../../layers/support/fieldUtils ../../../popup/content ../../../popup/ExpressionInfo ../../../popup/FieldInfo ../../../renderers/support/utils ../../../renderers/visualVariables/support/visualVariableUtils".split(" "),function(K,b,t,v,z,w,F,A,G,B,H,I){function C(a){return"hasVisualVariables"in a&&a.hasVisualVariables()?a.visualVariables.filter(function(a){return I.viewScaleRE.test(a.valueExpression)||
"target"in a&&"outline"===a.target?!1:!0}):[]}function u(a,b){var e=null;"popupTemplate"in a&&a.popupTemplate&&(e=a.popupTemplate.fieldInfos);var c=a.getField(b),g=null;e&&e.some(function(a){return a&&a.fieldName.toLowerCase()===c.name.toLowerCase()?(g=a.clone(),!0):!1});g||(a=-1<F.numericTypes.indexOf(c.type),b="integer"===c.type||"small-integer"===c.type,g=new B({fieldName:c.name,isEditable:c.editable,visible:!0,format:a?{places:b?0:2,digitSeparator:!0}:null}));g.label||(g.label=c.alias);return g}
function x(a){var b=a.expression,e=a.title;a=a.returnType;return new G({name:"expr"+J++,expression:b,title:e,returnType:a})}function y(a){return new B({fieldName:""+b.expressionFieldPrefix+a.name,visible:!0,format:"number"===a.returnType?{places:2,digitSeparator:!0}:null})}Object.defineProperty(b,"__esModule",{value:!0});b.hasNormalizedField=b.getContentFromFieldInfos=b.getFieldAndExpressionInfos=b.getFieldInfoFromExpressionInfo=b.getExpressionInfo=b.getFieldInfo=b.getPrimaryVisualVariables=b.expressionFieldPrefix=
void 0;var J=0;b.expressionFieldPrefix="expression/";b.getPrimaryVisualVariables=C;b.getFieldInfo=u;b.getExpressionInfo=x;b.getFieldInfoFromExpressionInfo=y;b.getFieldAndExpressionInfos=function(a){return t.__awaiter(this,void 0,void 0,function(){var b,e,c,g,h,m,n,k,p,d,f,q,D,E,r;return t.__generator(this,function(l){switch(l.label){case 0:return[4,z.loadMessageBundle("esri/smartMapping/t9n/smartMapping")];case 1:b=l.sent();e=a.renderer;c=a.layer;g=a.normFieldExpressionTemplate;h=[];m=[];n=H.getAttributes(e,
C);k=0;for(p=n;k<p.length;k++)d=p[k],"field"===d.type?h.push(u(c,d.field)):"normalized-field"===d.type?(f=c.getField(d.field),q=c.getField(d.normalizationField),D='\n      $feature["'+f.name+'"];\n      $feature["'+q.name+'"];\n      '+("percentage"===g?'($feature["'+f.name+'"] / $feature["'+q.name+'"]) * 100;':'$feature["'+f.name+'"] / $feature["'+q.name+'"];')+"\n      ",E="percentage"===g?w.substitute(b.normFieldLabelAsPercent,{expression1:f.alias,expression2:q.alias}):w.substitute(b.normFieldLabel,
{expression1:f.alias,expression2:q.alias}),r=x({type:"expression",expression:D,title:E,returnType:"number"}),h.push(y(r),u(c,d.field),u(c,d.normalizationField)),m.push(r)):"expression"===d.type&&(r=x(d),h.push(y(r)),m.push(r));return[2,{fieldInfos:v.unique(h,function(a,b){return a.fieldName===b.fieldName}),expressionInfos:v.unique(m,function(a,b){return a.expression===b.expression})}]}})})};b.getContentFromFieldInfos=function(a,l){return t.__awaiter(this,void 0,void 0,function(){var e,c,g,h,m,n,k,
p;return t.__generator(this,function(d){switch(d.label){case 0:return e=l.fieldInfos,c=l.expressionInfos,[4,z.loadMessageBundle("esri/smartMapping/t9n/smartMapping")];case 1:g=d.sent();if(2<e.length)return[2,[new A.FieldsContent({fieldInfos:e})]];h=[];m=function(f){var e=f.fieldName;f=f.label;if(!f){var d=a.getField(e);if(d)f=d.alias||e;else if(c){var l=e.split(b.expressionFieldPrefix)[1];(d=c[v.findIndex(c,function(a){return a.name===l})])&&(f=d.title||d.name)}}h.push(new A.TextContent({text:w.substitute(g.fieldInfo,
{fieldLabel:f,fieldValue:"{"+e+"}"})}))};n=0;for(k=e;n<k.length;n++)p=k[n],m(p);return[2,h]}})})};b.hasNormalizedField=function(a){return"normalizationField"in a&&a.normalizationField?!0:"hasVisualVariables"in a&&a.hasVisualVariables()&&a.visualVariables.some(function(a){return!!("normalizationField"in a&&a.normalizationField)})}});