// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.17/esri/copyright.txt for details.
//>>built
define("require exports tslib ../../renderers ../../core/Error ../../core/maybe ../../core/promiseUtils ../../core/screenUtils ../../intl/messages ../../intl/substitute ../../renderers/support/AuthoringInfo ../../renderers/support/AuthoringInfoVisualVariable ../../renderers/support/utils ../../renderers/visualVariables/SizeVariable ../heuristics/ageUnit ../heuristics/outline ../heuristics/sizeRange ./support/utils ../statistics/support/ageUtils ../support/utils ../support/adapters/support/layerUtils ../symbology/size".split(" "),
function(ka,t,f,N,h,G,K,O,L,X,P,Y,Z,Q,aa,R,ba,n,J,I,C,E){function ca(b){return f.__awaiter(this,void 0,void 0,function(){var a,g,c,e,d,k,m;return f.__generator(this,function(l){switch(l.label){case 0:if(!(b&&b.layer&&(b.field||b.valueExpression||b.sqlExpression)))throw new h("size-visual-variable:missing-parameters","'layer' and 'field', 'valueExpression' or 'sqlExpression' parameters are required");if(b.valueExpression&&!b.sqlExpression&&!b.view)throw new h("size-visual-variable:missing-parameters",
"View is required when 'valueExpression' is specified");a=f.__assign({},b);g=[0,2,1,3];c=C.createLayerAdapter(a.layer,g);a.layer=c;if(!c)throw new h("size-visual-variable:invalid-parameters","'layer' must be one of these types: "+C.getLayerTypeLabels(g).join(", "));"height"===a.axis&&(a.sizeOptimizationEnabled=!1);e=G.isSome(a.signal)?{signal:a.signal}:null;return[4,c.load(e)];case 1:l.sent();d=c.geometryType;if("mesh"===d)throw new h("size-visual-variable:invalid-parameters","Size visualization is not applicable to layers with 'mesh' geometry type");
if(a.worldScale){if("polyline"===d||"polygon"===d)throw new h("size-visual-variable:not-supported","'worldScale' sizing is not supported for polyline and polygon layers");if(!a.view||"3d"!==a.view.type)throw new h("size-visual-variable:invalid-parameters","'view' parameter should be an instance of SceneView when 'worldScale' parameter is true");}return[4,I.getFieldsList({field:a.field,normalizationField:a.normalizationField,valueExpression:a.valueExpression})];case 2:k=l.sent();if(m=n.verifyBasicFieldValidity(c,
k,"size-visual-variable:invalid-parameters"))throw m;return[2,a]}})})}function da(b){return f.__awaiter(this,void 0,void 0,function(){var a,g,c,e,d,k,m,l;return f.__generator(this,function(q){switch(q.label){case 0:if(!(b&&b.layer&&(b.field||b.valueExpression||b.sqlExpression)))throw new h("size-continuous-renderer:missing-parameters","'layer' and 'field', 'valueExpression' or 'sqlExpression' parameters are required");if(b.valueExpression&&!b.sqlExpression&&!b.view)throw new h("size-continuous-renderer:missing-parameters",
"View is required when 'valueExpression' is specified");a=f.__assign({},b);a.symbolType=a.symbolType||"2d";a.defaultSymbolEnabled=null==a.defaultSymbolEnabled?!0:a.defaultSymbolEnabled;g=[0,2,1,3];c=C.createLayerAdapter(a.layer,g);a.layer=c;if(!c)throw new h("size-continuous-renderer:invalid-parameters","'layer' must be one of these types: "+C.getLayerTypeLabels(g).join(", "));e=G.isSome(a.signal)?{signal:a.signal}:null;return[4,c.load(e)];case 1:q.sent();d=c.geometryType;k=-1<a.symbolType.indexOf("3d");
a.outlineOptimizationEnabled="polygon"===d?a.outlineOptimizationEnabled:!1;if("mesh"===d)throw new h("size-continuous-renderer:invalid-parameters","Size visualization is not applicable to layers with 'mesh' geometry type");if(k&&("polyline"===d||"polygon"===d))throw new h("size-continuous-renderer:not-supported","3d symbols are not supported for polyline and polygon layers");if(-1<a.symbolType.indexOf("3d-volumetric")&&(!a.view||"3d"!==a.view.type))throw new h("size-continuous-renderer:invalid-parameters",
"'view' parameter should be an instance of SceneView when 'symbolType' parameter is '3d-volumetric' or 3d-volumetric-uniform");return[4,I.getFieldsList({field:a.field,normalizationField:a.normalizationField,valueExpression:a.valueExpression})];case 2:m=q.sent();if(l=n.verifyBasicFieldValidity(c,m,"size-continuous-renderer:invalid-parameters"))throw l;return[2,a]}})})}function ea(b){return f.__awaiter(this,void 0,void 0,function(){var a,g,c,e,d,k,m,l,q;return f.__generator(this,function(p){switch(p.label){case 0:if(!b||
!b.layer||!b.field&&!b.valueExpression)throw new h("size-class-breaks-renderer:missing-parameters","'layer' and 'field' or 'valueExpression' parameters are required");if(b.valueExpression&&!b.view)throw new h("size-class-breaks-renderer:missing-parameters","View is required when 'valueExpression' is specified");a=f.__assign({},b);a.symbolType=a.symbolType||"2d";a.defaultSymbolEnabled=null==a.defaultSymbolEnabled?!0:a.defaultSymbolEnabled;a.classificationMethod=a.classificationMethod||"equal-interval";
a.normalizationType=I.getNormalizationType(a);g=[0,2,1,3];c=C.createLayerAdapter(a.layer,g);a.layer=c;if(!c)throw new h("size-class-breaks-renderer:invalid-parameters","'layer' must be one of these types: "+C.getLayerTypeLabels(g).join(", "));e=null!=a.minValue&&null!=a.maxValue;if(!e&&(null!=a.minValue||null!=a.maxValue))throw new h("size-class-breaks-renderer:missing-parameters","Both 'minValue' and 'maxValue' are required when specifying custom data range");d=G.isSome(a.signal)?{signal:a.signal}:
null;return[4,c.load(d)];case 1:p.sent();k=c.geometryType;m=-1<a.symbolType.indexOf("3d");a.outlineOptimizationEnabled="polygon"===k?a.outlineOptimizationEnabled:!1;if("mesh"===k)throw new h("size-class-breaks-renderer:invalid-parameters","Size visualization is not applicable to layers with 'mesh' geometry type");if(m&&("polyline"===k||"polygon"===k))throw new h("size-class-breaks-renderer:not-supported","3d symbols are not supported for polyline and polygon layers");if(-1<a.symbolType.indexOf("3d-volumetric")&&
(!a.view||"3d"!==a.view.type))throw new h("size-class-breaks-renderer:invalid-parameters","'view' parameter should be an instance of SceneView when 'symbolType' parameter is '3d-volumetric' or 3d-volumetric-uniform");return[4,I.getFieldsList({field:a.field,normalizationField:a.normalizationField})];case 2:l=p.sent();if(q=n.verifyBasicFieldValidity(c,l,"size-class-breaks-renderer:invalid-parameters"))throw q;return[2,a]}})})}function fa(b){b=f.__assign({},b);delete b.basemap;delete b.sizeScheme;delete b.legendOptions;
delete b.symbolType;delete b.defaultSymbolEnabled;b.analyzeData=!(null!=b.minValue&&null!=b.maxValue);return b}function S(b){b=f.__assign({},b);var a=-1<b.symbolType.indexOf("3d-volumetric");if(b.worldScale=a)b.axis="3d-volumetric-uniform"===b.symbolType?"all":"height";delete b.symbolType;delete b.defaultSymbolEnabled;return b}function ga(b){return f.__awaiter(this,void 0,void 0,function(){var a,g,c,e,d,k,m;return f.__generator(this,function(l){switch(l.label){case 0:if(!(b&&b.layer&&b.view&&b.startTime&&
b.endTime))throw new h("size-age-renderer:missing-parameters","'layer', 'view', 'startTime', 'endTime' parameters are required");a=f.__assign({},b);a.symbolType=a.symbolType||"2d";a.defaultSymbolEnabled=null==a.defaultSymbolEnabled?!0:a.defaultSymbolEnabled;g=[0,2,1,3];c=C.createLayerAdapter(a.layer,g);a.layer=c;if(!c)throw new h("size-age-renderer:invalid-parameters","'layer' must be one of these types: "+C.getLayerTypeLabels(g).join(", "));e=G.isSome(a.signal)?{signal:a.signal}:null;return[4,c.load(e)];
case 1:l.sent();d=c.geometryType;k=-1<a.symbolType.indexOf("3d");a.outlineOptimizationEnabled="polygon"===d?a.outlineOptimizationEnabled:!1;if("mesh"===d)throw new h("size-age-renderer:invalid-parameters","Size visualization is not applicable to layers with 'mesh' geometry type");if(k&&("polyline"===d||"polygon"===d))throw new h("size-age-renderer:not-supported","3d symbols are not supported for polyline and polygon layers");if(-1<a.symbolType.indexOf("3d-volumetric")&&(!a.view||"3d"!==a.view.type))throw new h("size-age-renderer:invalid-parameters",
"'view' parameter should be an instance of SceneView when 'symbolType' parameter is '3d-volumetric' or 3d-volumetric-uniform");if(m=J.verifyDates(c,a.startTime,a.endTime,"size-age-renderer:invalid-parameters"))throw m;if(a.unit&&-1===J.supportedAgeUnits.indexOf(a.unit))throw new h("size-age-renderer:invalid-unit","Supported units are: "+J.supportedAgeUnits.join(", "));return[2,a]}})})}function T(b){return f.__awaiter(this,void 0,void 0,function(){var a,g,c,e,d;return f.__generator(this,function(k){switch(k.label){case 0:return a=
b.sizeScheme,c=g=null,[4,n.getBasemapInfo(b.basemap,b.view)];case 1:e=k.sent();g=G.isSome(e.basemapId)?e.basemapId:null;c=G.isSome(e.basemapTheme)?e.basemapTheme:null;if(a)return[2,{scheme:E.cloneScheme(a),basemapId:g,basemapTheme:c}];if(d=E.getSchemes({basemap:g,basemapTheme:c,geometryType:b.geometryType,worldScale:b.worldScale,view:b.view}))a=d.primaryScheme,g=d.basemapId,c=d.basemapTheme;return[2,{scheme:a,basemapId:g,basemapTheme:c}]}})})}function U(b,a){var g;switch(a){case "point":case "multipoint":g=
[b.minSize,b.maxSize];break;case "polyline":g=[b.minWidth,b.maxWidth];break;case "polygon":g=[b.marker.minSize,b.marker.maxSize]}return g}function ha(b,a,g,c){return f.__awaiter(this,void 0,void 0,function(){var e,d,k,m,l,q,p,B,w,x,u,r,y,z,v,A,H,D,F,t;return f.__generator(this,function(f){switch(f.label){case 0:return e=c.layer,d=c.field,k="function"===typeof d,l=(m=d&&!k?e.getField(d):null)&&"date"===m.type,q=e.geometryType,[4,T({basemap:c.basemap,geometryType:q,sizeScheme:c.sizeScheme,worldScale:c.worldScale,
view:c.view})];case 1:p=f.sent();B=p.scheme;if(!B)throw new h("size-visual-variable:insufficient-info","Unable to find size scheme");x=(w=a&&[a.minSize,a.maxSize])||U(B,q);r=(u=n.getDefaultDataRange(b,l,!1))||[b.min,b.max];y=[];v=(z="height"===c.axis)?c.axis:void 0;A=x[0];H=x[1];z&&"number"===typeof A&&"number"===typeof H&&(D=n.getSizeRangeForAxis({minSize:A,maxSize:H},v),y.push(new Q({axis:"width-and-depth",minSize:D.minSize})),H=D.maxSize);y.unshift(new Q({field:d,valueExpression:c.valueExpression,
valueExpressionTitle:c.valueExpressionTitle,valueUnit:"unknown",normalizationField:g,axis:v,minSize:A,maxSize:H,minDataValue:r[0],maxDataValue:r[1],legendOptions:c.legendOptions}));F=new Y({type:"size",minSliderValue:null!=c.minValue?c.minValue:b.min,maxSliderValue:null!=c.maxValue?c.maxValue:b.max});t=new P({visualVariables:[F]});return[2,{basemapId:p.basemapId,basemapTheme:p.basemapTheme,visualVariables:y,statistics:b,defaultValuesUsed:!!u,sizeScheme:E.cloneScheme(B),authoringInfo:t}]}})})}function V(b,
a,g,c,e){return f.__awaiter(this,void 0,void 0,function(){var d,k,m,l,q,p,h,w,x,u,r,y,z;return f.__generator(this,function(f){switch(f.label){case 0:return[4,L.loadMessageBundle("esri/smartMapping/t9n/smartMapping")];case 1:return d=f.sent(),k=e.layer,m=e.field,l=k.geometryType,q=e.defaultSymbolEnabled,p=E.cloneScheme(b.sizeScheme),w=(h="polygon"===l)?p.marker:p,x=h?p.background:null,u=h?"point":l,r=a&&a.opacity,y=b.visualVariables.map(function(a){return a.clone()}),a&&a.visualVariables&&a.visualVariables.length&&
y.push.apply(y,a.visualVariables.map(function(a){return a.clone()})),z=new N.ClassBreaksRenderer({backgroundFillSymbol:x&&n.createSymbol(l,{type:e.symbolType,color:x.color,outline:n.getSymbolOutlineFromScheme(x,l,r)}),classBreakInfos:[{minValue:-W,maxValue:W,symbol:n.createSymbol(u,{type:e.symbolType,color:w.color,size:n.getSymbolSizeFromScheme(w,u),outline:n.getSymbolOutlineFromScheme(w,u,r)})}],defaultLabel:q?d.other:null,defaultSymbol:q?n.createSymbol(u,{type:e.symbolType,color:w.noDataColor,size:n.getSymbolSizeFromScheme(w,
u,!0),outline:n.getSymbolOutlineFromScheme(w,u,r)}):null,field:m,normalizationField:c,normalizationType:g,valueExpression:e.valueExpression,valueExpressionTitle:e.valueExpressionTitle,visualVariables:y,authoringInfo:b.authoringInfo&&b.authoringInfo.clone()}),[2,{renderer:z,visualVariables:b.visualVariables.map(function(a){return a.clone()}),statistics:b.statistics,defaultValuesUsed:b.defaultValuesUsed,sizeScheme:E.cloneScheme(b.sizeScheme),basemapId:b.basemapId,basemapTheme:b.basemapTheme}]}})})}
function ia(b,a){var g=O.toPt(b.minSize);b=(O.toPt(b.maxSize)-g)/(4<=a?a-1:a);for(var c=[],e=0;e<a;e++)c.push(g+b*e);return c}function ja(b,a){return f.__awaiter(this,void 0,void 0,function(){var g,c,e,d,k,m,l,h,p,B,w,x,u,r,y,z,v,A,t,D,F;return f.__generator(this,function(f){switch(f.label){case 0:return[4,L.loadMessageBundle("esri/smartMapping/t9n/smartMapping")];case 1:return g=f.sent(),c=b.layer,e=b.defaultSymbolEnabled,d=c.geometryType,k="polygon"===d,m=-1<b.symbolType.indexOf("3d-volumetric"),
[4,T({basemap:b.basemap,geometryType:d,sizeScheme:b.sizeScheme,worldScale:m,view:b.view})];case 2:return l=f.sent(),h=l.scheme,p=a.result,B=a.outlineResult,w=p.classBreakInfos,x=b.classificationMethod,u=b.normalizationType,r=k?h.marker:h,y=k?h.background:null,z=k?"point":d,v=U(r,z),A=m&&n.getSizeRangeForAxis({minSize:v[0],maxSize:v[1]},"height"),t=ia({minSize:v[0],maxSize:m?A.maxSize:v[1]},w.length),D=B&&B.opacity,F=new N.ClassBreaksRenderer({backgroundFillSymbol:y&&n.createSymbol(d,{type:b.symbolType,
color:y.color,outline:n.getSymbolOutlineFromScheme(y,d,D)}),classBreakInfos:w.map(function(a,c){return{minValue:a.minValue,maxValue:a.maxValue,symbol:n.createSymbol(z,{type:b.symbolType,color:r.color,size:t[c],widthAndDepth:A&&A.minSize,outline:n.getSymbolOutlineFromScheme(r,z,D)}),label:a.label}}),defaultLabel:e?g.other:null,defaultSymbol:e?n.createSymbol(z,{type:b.symbolType,color:r.noDataColor,size:n.getSymbolSizeFromScheme(r,z,!0),widthAndDepth:A&&A.minSize,outline:n.getSymbolOutlineFromScheme(r,
z,D)}):null,field:b.field,valueExpression:b.valueExpression,valueExpressionTitle:b.valueExpressionTitle,normalizationType:u,normalizationField:b.normalizationField,normalizationTotal:"percent-of-total"===u?p.normalizationTotal:void 0,legendOptions:b.legendOptions,authoringInfo:new P({type:"class-breaks-size",classificationMethod:x,standardDeviationInterval:b.standardDeviationInterval})}),"standard-deviation"!==x&&Z.setLabelsForClassBreaks({classBreakInfos:F.classBreakInfos,classificationMethod:x,
normalizationType:u,round:!0}),B&&B.visualVariables&&B.visualVariables.length&&(F.visualVariables=B.visualVariables.map(function(a){return a.clone()})),[2,{renderer:F,sizeScheme:E.cloneScheme(h),classBreaksResult:p,defaultValuesUsed:a.defaultValuesUsed,basemapId:l.basemapId,basemapTheme:l.basemapTheme}]}})})}function M(b){return f.__awaiter(this,void 0,void 0,function(){var a,g,c,e,d,k,h,l,q;return f.__generator(this,function(f){switch(f.label){case 0:return[4,ca(b)];case 1:return a=f.sent(),g=a.view,
c=a.layer,e=a.normalizationField,d=a.signal,k=e?"field":void 0,[4,K.all([a.statistics?a.statistics:n.getSummaryStatistics({layer:c,field:a.field,valueExpression:a.valueExpression,sqlExpression:a.sqlExpression,sqlWhere:a.sqlWhere,normalizationType:k,normalizationField:e,minValue:a.minValue,maxValue:a.maxValue,view:g,signal:d}),a.sizeOptimizationEnabled?ba({view:g,layer:c,signal:d}):null])];case 2:return h=f.sent(),l=h[0],q=h[1],[2,ha(l,q,e,a)]}})})}Object.defineProperty(t,"__esModule",{value:!0});
t.createAgeRenderer=t.createClassBreaksRenderer=t.createContinuousRenderer=t.createVisualVariables=void 0;var W=Math.pow(2,53)-1;t.createVisualVariables=M;t.createContinuousRenderer=function(b){return f.__awaiter(this,void 0,void 0,function(){var a,g,c,e,d,h,m;return f.__generator(this,function(f){switch(f.label){case 0:return[4,da(b)];case 1:return a=f.sent(),g={layer:a.layer,view:a.view,signal:a.signal},[4,K.all([M(S(a)),a.outlineOptimizationEnabled?R(g):null])];case 2:return c=f.sent(),e=c[0],
d=c[1],m=(h=a.normalizationField)?"field":void 0,[2,V(e,d,m,h,a)]}})})};t.createClassBreaksRenderer=function(b){return f.__awaiter(this,void 0,void 0,function(){var a,g;return f.__generator(this,function(c){switch(c.label){case 0:return[4,ea(b)];case 1:return a=c.sent(),[4,n.getClassBreaks(fa(a),a.outlineOptimizationEnabled)];case 2:return g=c.sent(),[2,ja(a,g)]}})})};t.createAgeRenderer=function(b){return f.__awaiter(this,void 0,void 0,function(){var a,g,c,e,d,h,m,l,q,p,t,w,x,u,r,y,z,v,A,H,D,F,C,
G,E,I;return f.__generator(this,function(k){switch(k.label){case 0:return[4,ga(b)];case 1:a=k.sent();g=a.defaultSymbolEnabled;c=a.view;e=a.startTime;d=a.endTime;h=a.symbolType;m=a.minValue;l=a.maxValue;q=a.signal;p=a.layer;t={layer:a.layer,view:a.view,signal:q};y=(r=K).all;if(!a.unit)return[3,2];z={unit:a.unit,statistics:null,valueExpression:null};return[3,4];case 2:return[4,aa({view:c,layer:p,startTime:e,endTime:d,minValue:m,maxValue:l,signal:q})];case 3:z=k.sent(),k.label=4;case 4:return[4,y.apply(r,
[[z,a.outlineOptimizationEnabled?R(t):null]])];case 5:return w=k.sent(),x=w[0],u=w[1],v=x.unit,A=x.statistics,H=J.getAgeExpressions({layer:p,startTime:e,endTime:d,unit:v}).valueExpression,[4,L.loadMessageBundle("esri/smartMapping/t9n/smartMapping")];case 6:return D=k.sent(),F=X.substitute(D["ageInfo_"+v],{unit:v,startTime:n.formatDate(e,v,p),endTime:n.formatDate(d,v,p)}),[4,M(S({layer:p,basemap:a.basemap,valueExpression:H,symbolType:h,statistics:A,legendOptions:{title:F},sizeScheme:a.sizeScheme,sizeOptimizationEnabled:a.sizeOptimizationEnabled,
view:a.view,minValue:m,maxValue:l,signal:q}))];case 7:return C=k.sent(),G={layer:p,valueExpression:H,defaultSymbolEnabled:g,symbolType:h},[4,V(C,u,null,null,G)];case 8:return E=k.sent(),I=E.renderer.authoringInfo.visualVariables,I.forEach(function(a){return n.updateAgeRendererAuthoringInfoVV(a,e,d,v)}),[2,f.__assign(f.__assign({},E),{unit:v})]}})})}});