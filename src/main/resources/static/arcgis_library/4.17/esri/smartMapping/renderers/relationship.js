// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.17/esri/copyright.txt for details.
//>>built
define("require exports tslib ../../core/Error ../../core/lang ../../core/maybe ../../core/promiseUtils ../../intl/messages ../../renderers/support/AuthoringInfo ../../renderers/support/AuthoringInfoClassBreakInfo ../../renderers/support/AuthoringInfoFieldInfo ./type ./support/utils ../support/adapters/support/layerUtils ../symbology/relationship ../../symbols/support/utils".split(" "),function(da,p,h,l,M,v,N,O,P,w,x,Q,t,I,A,R){function S(b){return h.__awaiter(this,void 0,void 0,function(){var a,
c,d,f,e,g,m,k,n,y;return h.__generator(this,function(q){switch(q.label){case 0:if(!(b&&b.layer&&b.view&&b.field1&&b.field2))throw new l("relationship-renderer:missing-parameters","'layer', 'view', 'field1' and 'field2' parameters are required");a=h.__assign({},b);a.symbolType=a.symbolType||"2d";a.defaultSymbolEnabled=null==a.defaultSymbolEnabled?!0:a.defaultSymbolEnabled;a.classificationMethod=a.classificationMethod||"quantile";a.numClasses=a.numClasses||3;a.focus=a.focus||null;if(-1===T.indexOf(a.classificationMethod))throw new l("relationship-renderer:invalid-parameters",
"classification method "+a.classificationMethod+" is not supported");if(2>a.numClasses||4<a.numClasses)throw new l("relationship-renderer:invalid-parameters","'numClasses' must be 2, 3 or 4");if(b.focus&&-1===U.indexOf(b.focus))throw new l("relationship-renderer:invalid-parameters","'focus' must be 'HH', 'HL', 'LH', 'LL' or null");c=[0,2,1,3];d=I.createLayerAdapter(a.layer,c);a.layer=d;if(!d)throw new l("relationship-renderer:invalid-parameters","'layer' must be one of these types: "+I.getLayerTypeLabels(c).join(", "));
f=v.isSome(a.signal)?{signal:a.signal}:null;return[4,d.load(f)];case 1:q.sent();e=d.geometryType;g=-1<a.symbolType.indexOf("3d");a.outlineOptimizationEnabled="polygon"===e?a.outlineOptimizationEnabled:!1;a.sizeOptimizationEnabled="point"===e||"multipoint"===e||"polyline"===e?a.sizeOptimizationEnabled:!1;if("mesh"===e)a.symbolType="3d-volumetric",a.colorMixMode=a.colorMixMode||"replace",a.edgesType=a.edgesType||"none";else{if("3d-volumetric-uniform"===a.symbolType&&"point"!==e)throw new l("relationship-renderer:not-supported",
"3d-volumetric-uniform symbols are supported for point layers only");if(g&&"polygon"===e)throw new l("relationship-renderer:not-supported","3d symbols are not supported for polygon layers");if(-1<a.symbolType.indexOf("3d-volumetric")&&(!a.view||"3d"!==a.view.type))throw new l("relationship-renderer:invalid-parameters","'view' parameter should be an instance of SceneView when 'symbolType' parameter is '3d-volumetric' or '3d-volumetric-uniform'");}m=a.field1;k=a.field2;n=[m.field,k.field];m.normalizationField&&
n.push(m.normalizationField);k.normalizationField&&n.push(k.normalizationField);if(y=t.verifyBasicFieldValidity(d,n,"relationship-renderer:invalid-parameters"))throw y;return[2,a]}})})}function V(b){return h.__awaiter(this,void 0,void 0,function(){var a,c,d,f,e,g;return h.__generator(this,function(m){if(!(b&&b.renderer&&b.numClasses))throw new l("update-relationship-renderer:missing-parameters","'renderer' and 'numClasses' parameters are required");a=b.field1;c=b.field2;d=b.renderer;f=b.numClasses;
e=b.colors;g=Math.pow(f,2);if((a||c)&&!(a&&c&&a.field&&c.field))throw new l("update-relationship-renderer:missing-parameters","'field1' and 'field2' parameters are required");if(a&&!a.classBreakInfos||c&&!c.classBreakInfos)throw new l("update-relationship-renderer:missing-parameters","'field1.classBreakInfos' and 'field2.classBreakInfos' are required");if(!d.authoringInfo)throw new l("update-relationship-renderer:missing-parameters","'renderer.authoringInfo' is required");if(d.uniqueValueInfos.length!==
g)throw new l("update-relationship-renderer:invalid-parameters","Renderer must have "+g+" unique value infos to support "+f+" classes");if(e&&e.length!==g)throw new l("update-relationship-renderer:invalid-parameters","The scheme must have "+g+" colors");return[2,b]})})}function W(b){return h.__awaiter(this,void 0,void 0,function(){var a,c,d,f,e;return h.__generator(this,function(g){switch(g.label){case 0:return a=b.relationshipScheme,d=c=null,[4,t.getBasemapInfo(b.basemap,b.view)];case 1:f=g.sent();
c=v.isSome(f.basemapId)?f.basemapId:null;d=v.isSome(f.basemapTheme)?f.basemapTheme:null;if(a)return[2,{scheme:A.cloneScheme(a),basemapId:c,basemapTheme:d}];if(e=A.getSchemes({basemap:c,basemapTheme:d,geometryType:b.geometryType,theme:b.theme,worldScale:b.worldScale,view:b.view}))a=e.primaryScheme,c=e.basemapId,d=e.basemapTheme;return[2,{scheme:a,basemapId:c,basemapTheme:d}]}})})}function J(b,a){b=M.clone(X[b]);return A.flatten2DArray(b,a)}function Y(b,a){return J(b,a).map(function(a){return{value:a,
count:0}})}function K(b,a,c,d){var f=b.field;b=b.normalizationField;var e=a.field;a=a.normalizationField;c=c.map(function(a){return[a.minValue,a.maxValue]});d=d.map(function(a){return[a.minValue,a.maxValue]});var g=Z[c.length];return"\n  var field1 \x3d $feature['"+f+"'];\n  var field2 \x3d $feature['"+e+"'];\n  var hasNormField1 \x3d "+(b?"true":"false")+";\n  var hasNormField2 \x3d "+(a?"true":"false")+";\n  var normField1 \x3d "+(b?"$feature['"+b+"']":"null")+";\n  var normField2 \x3d "+(a?"$feature['"+
a+"']":"null")+";\n\n  if (\n    IsEmpty(field1) ||\n    IsEmpty(field2) ||\n    (hasNormField1 \x26\x26 (IsEmpty(normField1) || normField1 \x3d\x3d 0)) ||\n    (hasNormField2 \x26\x26 (IsEmpty(normField2) || normField2 \x3d\x3d 0))\n  ) {\n    return null;\n  }\n\n  var value1 \x3d IIf(hasNormField1, (field1 / normField1), field1);\n  var value2 \x3d IIf(hasNormField2, (field2 / normField2), field2);\n\n  var breaks1 \x3d "+JSON.stringify(c)+";\n  var breaks2 \x3d "+JSON.stringify(d)+";\n  var classCodes \x3d "+
JSON.stringify(g)+";\n\n  function getClassCode(value, breaks) {\n    var code \x3d null;\n\n    for (var i in breaks) {\n      var info \x3d breaks[i];\n      if (value \x3e\x3d info[0] \x26\x26 value \x3c\x3d info[1]) {\n        code \x3d classCodes[i];\n        break;\n      }\n    }\n\n    return code;\n  }\n\n  var code1 \x3d getClassCode(value1, breaks1);\n  var code2 \x3d getClassCode(value2, breaks2);\n\n  var classValue \x3d IIf(IsEmpty(code1) || IsEmpty(code2), null, code1 + code2);\n  return classValue;\n  "}
function aa(b,a,c){return h.__awaiter(this,void 0,void 0,function(){var d,f,e,g,m,k,n,y,q,r,u,L,p,t,B,z,C,v,w,D,G,H,x;return h.__generator(this,function(E){switch(E.label){case 0:return[4,O.loadMessageBundle("esri/smartMapping/t9n/smartMapping")];case 1:d=E.sent();f=b.basemap;e=b.classificationMethod;g=b.field1;m=b.field2;k=b.focus;n=b.numClasses;y=b.signal;q=b.layer;r=a.classBreakInfos;u=c.classBreakInfos;if(n!==r.length||r.length!==u.length)throw new l("relationship-renderer:error","incompatible class breaks");
L=Y(n,k);p=K(b.field1,b.field2,r,u);return[4,W({basemap:f,geometryType:q.geometryType,theme:"default",relationshipScheme:b.relationshipScheme,worldScale:-1<b.symbolType.indexOf("3d-volumetric"),view:b.view})];case 2:return t=E.sent(),B=t.scheme,[4,Q.createRenderer({layer:q,basemap:f,valueExpression:p,valueExpressionTitle:d.relationship.legendTitle,numTypes:-1,sortEnabled:!1,defaultSymbolEnabled:b.defaultSymbolEnabled,typeScheme:h.__assign({colors:A.getColors(B,n,k)},B),statistics:{uniqueValueInfos:L},
legendOptions:b.legendOptions,outlineOptimizationEnabled:b.outlineOptimizationEnabled,sizeOptimizationEnabled:b.sizeOptimizationEnabled,symbolType:b.symbolType,colorMixMode:b.colorMixMode,edgesType:b.edgesType,view:b.view,signal:y})];case 3:z=E.sent();C=z.renderer;v=C.uniqueValueInfos;w=d.relationship;D=0;for(G=v;D<G.length;D++)H=G[D],H.label=w[H.value];x=new P({type:"relationship",classificationMethod:e,numClasses:n,focus:k,field1:{field:g.field,normalizationField:g.normalizationField,label:g.label,
classBreakInfos:r.map(F)},field2:{field:m.field,normalizationField:m.normalizationField,label:m.label,classBreakInfos:u.map(F)}});C.authoringInfo=x;return[2,{renderer:C,classBreaks:{field1:a,field2:c},uniqueValueInfos:z.uniqueValueInfos,relationshipScheme:B,basemapId:z.basemapId,basemapTheme:z.basemapTheme}]}})})}function ba(b,a,c){var d=J(a,c);b.sort(function(a,b){a=d.indexOf(a.value);b=d.indexOf(b.value);var c=0;a<b?c=-1:a>b&&(c=1);return c})}function ca(b,a){var c=b.authoringInfo;c.numClasses=
a.numClasses;c.focus=a.focus||null;c.focus||delete c.focus;var d=a.field1;a=a.field2;c.field1=new x.default({field:d.field,normalizationField:d.normalizationField,label:d.label,classBreakInfos:d.classBreakInfos.map(function(a){return new w.default(F(a))})});c.field2=new x.default({field:a.field,normalizationField:a.normalizationField,label:a.label,classBreakInfos:a.classBreakInfos.map(function(a){return new w.default(F(a))})});b.authoringInfo=c}Object.defineProperty(p,"__esModule",{value:!0});p.createRenderer=
p.updateRenderer=void 0;var T=["equal-interval","natural-breaks","quantile"],U=["HH","HL","LH","LL"],X={2:[["HL","HH"],["LL","LH"]],3:[["HL","HM","HH"],["ML","MM","MH"],["LL","LM","LH"]],4:[["HL","HM1","HM2","HH"],["M2L","M2M1","M2M2","M2H"],["M1L","M1M1","M1M2","M1H"],["LL","LM1","LM2","LH"]]},Z={2:["L","H"],3:["L","M","H"],4:["L","M1","M2","H"]},F=function(b){return{minValue:b.minValue,maxValue:b.maxValue}};p.updateRenderer=function(b){return h.__awaiter(this,void 0,void 0,function(){var a,c,d,
f,e,g,m,k,l;return h.__generator(this,function(h){switch(h.label){case 0:return[4,V(b)];case 1:return a=h.sent(),c=a.field1,d=a.field2,f=a.renderer,e=a.numClasses,g=a.focus,m=a.colors,k=f.clone(),k.valueExpression=K(c,d,c.classBreakInfos,d.classBreakInfos),ba(k.uniqueValueInfos,e,g),m&&(l=t.createColors(m,m.length),k.uniqueValueInfos.forEach(function(a,b){return R.applyColorToSymbol(a.symbol,l[b])})),ca(k,a),[2,k]}})})};p.createRenderer=function(b){return h.__awaiter(this,void 0,void 0,function(){var a,
c,d,f,e,g,m,k,n,p,q,r,u;return h.__generator(this,function(h){switch(h.label){case 0:return[4,S(b)];case 1:return a=h.sent(),c=a.layer,d=a.classificationMethod,f=a.field1,e=a.field2,g=a.numClasses,m=a.view,k=a.signal,n={layer:c,classificationMethod:d,field:f.field,normalizationField:f.normalizationField,normalizationType:f.normalizationField?"field":null,minValue:f.minValue,maxValue:f.maxValue,analyzeData:!(null!=f.minValue&&null!=f.maxValue),numClasses:g,view:m,signal:k},p={layer:c,classificationMethod:d,
field:e.field,normalizationField:e.normalizationField,normalizationType:e.normalizationField?"field":null,minValue:e.minValue,maxValue:e.maxValue,analyzeData:!(null!=e.minValue&&null!=e.maxValue),numClasses:g,view:m,signal:k},[4,N.all([t.getClassBreaks(n),t.getClassBreaks(p)])];case 2:q=h.sent();r=q[0];u=q[1];if(!r||!u)throw new l("relationship-renderer:error","error when calculating class breaks");return[2,aa(a,r.result,u.result)]}})})}});