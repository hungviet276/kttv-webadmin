// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.17/esri/copyright.txt for details.
//>>built
define(["require","exports","../../support/utils"],function(u,c,l){function m(a){return"("+a.map(function(a){return a+" \x3e\x3d 0"}).join(" OR ")+")"}function n(a,b){var c=b.returnFieldName,d=b.defaultValue,e=b.layer,f=[];c&&d&&(b=a.map(function(a){return a+" \x3c\x3d 0"}).join(" AND "),f.push("WHEN "+b+" THEN "+d));b=function(b){var t=a.reduce(function(a,c){b!==c&&a.push(b+" \x3e "+c);return a},[]).join(" AND "),d=e&&l.isIntegerField(e,b),d=c&&"'"+b+"'"?"'"+b+"'":d?l.castIntegerFieldToFloat(b):
b;f.push("WHEN "+t+" THEN "+d)};for(var g=0;g<a.length;g++)b(a[g]);return"CASE "+f.join(" ")+" ELSE "+(d||"0")+" END"}function h(a){return a&&a.map(function(a){return'$feature["'+a+'"];'}).join("\n")+"\n"||""}function k(a,b){void 0===b&&(b=!1);a=a.map(function(a){return'"'+a+'"'});return"\n  var fieldNames \x3d [ "+a.join(", ")+" ];\n  var numFields \x3d "+a.length+";\n  var maxValueField \x3d null;\n  var maxValue \x3d -Infinity;\n  var value, i, totalValue \x3d null;\n\n  for(i \x3d 0; i \x3c numFields; i++) {\n    value \x3d $feature[fieldNames[i]];\n\n    if(value \x3e 0) {\n      if(value \x3e maxValue) {\n        maxValue \x3d value;\n        maxValueField \x3d fieldNames[i];\n      }\n      else if (value \x3d\x3d maxValue) {\n        maxValueField \x3d null;\n      }\n    }\n    "+
(b?"\n  if(value !\x3d null \x26\x26 value \x3e\x3d 0) {\n    if (totalValue \x3d\x3d null) { totalValue \x3d 0; }\n    totalValue \x3d totalValue + value;\n  }\n  ":"")+"\n  }\n  "}function p(a){var b=k(a);return"\n  "+h(a)+"\n  "+b+"\n  return maxValueField;\n  "}function q(a){var b=h(a);a=a.map(function(a){return'"'+a+'"'});return"\n  "+b+"\n  var fieldNames \x3d [ "+a.join(", ")+" ];\n  var numFields \x3d "+a.length+";\n  var value, i, totalValue \x3d null;\n\n  for(i \x3d 0; i \x3c numFields; i++) {\n    value \x3d $feature[fieldNames[i]];\n\n    if(value !\x3d null \x26\x26 value \x3e\x3d 0) {\n      if (totalValue \x3d\x3d null) { totalValue \x3d 0; }\n      totalValue \x3d totalValue + value;\n    }\n  }\n\n  return totalValue;\n  "}
function r(a){var b=k(a,!0);return"\n  "+h(a)+"\n  "+b+"\n\n  var strength \x3d null;\n\n  if (maxValueField !\x3d null \x26\x26 totalValue \x3e 0) {\n    strength \x3d (maxValue / totalValue) * 100;\n  }\n\n  return strength;\n  "}Object.defineProperty(c,"__esModule",{value:!0});c.getArcadeForOrderedFields=c.getArcadeForStrengthOfPredominance=c.getArcadeForSumOfFields=c.getArcadeForPredominanceMargin=c.getArcadeForPredominantCategoryAlias=c.getArcadeForPredominantCategoryValue=c.getArcadeForPredominantCategory=
c.getPredominanceExpressions=c.getSQLForPredominantCategoryName=c.noDominantCategoryField=void 0;c.noDominantCategoryField="no_dominant_category";c.getSQLForPredominantCategoryName=function(a){return{expression:n(a,{returnFieldName:!0,defaultValue:"'"+c.noDominantCategoryField+"'"})}};c.getPredominanceExpressions=function(a,b){var c=b.join(" + "),d={sqlExpression:"("+c+")",sqlWhere:m(b)};a={sqlExpression:"(( ("+n(b,{layer:a})+") / ("+c+") ) * 100)",sqlWhere:m(b)+" AND (("+c+") \x3e 0)"};return{predominantCategory:{valueExpression:p(b)},
size:{valueExpression:q(b),statisticsQuery:d,histogramQuery:d},opacity:{valueExpression:r(b),statisticsQuery:a,histogramQuery:a}}};c.getArcadeForPredominantCategory=p;c.getArcadeForPredominantCategoryValue=function(a){var b=k(a);return"\n  "+h(a)+"\n  "+b+"\n  return maxValue;\n  "};c.getArcadeForPredominantCategoryAlias=function(a,b){var c=a.map(function(a){return a.fieldName}),d=h(c),e=a.map(function(a){return a.label?'"'+a.label+'"':'"'+a.fieldName+'"'}),f=c.map(function(a){return'Number($feature["'+
a+'"])'}),g=[];b&&b.forEach(function(a,b){g.push("function getValueForExpr"+b+"() {\n  "+a.expression+" \n}");f.push("Number(getValueForExpr"+b+"())");e.push('"'+(a.title||a.name)+'"')});return"\n  "+d+"\n\n  "+(g.length?g.join("\n"):"")+"\n\n  var values \x3d [ "+f.join(", ")+" ];\n  var aliases \x3d [ "+e.join(", ")+" ];\n  var numValues \x3d "+f.length+';\n  var maxValueAlias \x3d null;\n  var maxValue \x3d -Infinity;\n  var value, i, totalValue \x3d null;\n\n  for(i \x3d 0; i \x3c numValues; i++) {\n    value \x3d values[i];\n\n    if(value \x3e 0) {\n      if(value \x3e maxValue) {\n        maxValue \x3d value;\n        maxValueAlias \x3d aliases[i];\n      }\n      else if (value \x3d\x3d maxValue) {\n        maxValueAlias \x3d "Tie";\n      }\n    }\n  }\n  return maxValueAlias;\n  '};
c.getArcadeForPredominanceMargin=function(a){var b=h(a);a=a.map(function(a){return'$feature["'+a+'"]'});return"\n  "+b+"\n  var fieldValues \x3d [ "+a.join(", ")+" ];\n  var totalValue \x3d Sum(fieldValues);\n  var order \x3d Reverse(Sort(fieldValues));\n  return IIF(totalValue \x3e 0, Round(((order[0] - order[1]) / totalValue) * 100, 2), null);\n  "};c.getArcadeForSumOfFields=q;c.getArcadeForStrengthOfPredominance=r;c.getArcadeForOrderedFields=function(a,b){var c=a.map(function(a){return a.fieldName}),
c=h(c),d=a.map(function(a){return'{\n    value: Number($feature["'+a.fieldName+'"]),\n    alias: "'+(a.label||a.fieldName)+'"\n    }'}),e=[];b&&b.forEach(function(a,b){e.push("function getValueForExpr"+b+"() {\n  "+a.expression+" \n}");d.push("{\n          value: Number(getValueForExpr"+b+'()),\n          alias: "'+(a.title||a.name)+'"\n          }')});return"\n  "+c+"\n\n  "+(e.length?e.join("\n"):"")+"\n\n  var groups \x3d [ "+d.join(", ")+' ];\n  var numTopValues \x3d Count(groups);\n\n  function getValuesArray(arr){\n    var valuesArray \x3d []\n    for(var i in arr){\n      valuesArray[i] \x3d arr[i].value;\n    }\n    return valuesArray;\n  }\n\n  function findAliases(top5Array, fullArray){\n    var aliases \x3d [];\n    var found \x3d "";\n    for(var i in top5Array){\n      for(var k in fullArray){\n        if(top5Array[i] \x3d\x3d fullArray[k].value \x26\x26 Find(fullArray[k].alias, found) \x3d\x3d -1){\n          found +\x3d fullArray[k].alias;\n          aliases[Count(aliases)] \x3d {\n            alias: fullArray[k].alias,\n            value: top5Array[i]\n          };\n        }\n      }\n    }\n    return aliases;\n  }\n\n  function getTopGroups(groupsArray){\n    var values \x3d getValuesArray(groupsArray);\n    var top5Values \x3d IIF(Max(values) \x3e 0, Top(Reverse(Sort(values)),numTopValues), "no data");\n    var top5Aliases \x3d findAliases(top5Values,groupsArray);\n\n    if(TypeOf(top5Values) \x3d\x3d "String"){\n      return top5Values;\n    } else {\n      var content \x3d "";\n      for(var i in top5Aliases){\n        if(top5Aliases[i].value \x3e 0){\n          content +\x3d (i+1) + ". " + top5Aliases[i].alias + " (" + Text(top5Aliases[i].value, "#,###") + ")";\n          content +\x3d IIF(i \x3c numTopValues-1, TextFormatting.NewLine, "");\n        }\n      }\n    }\n\n    return content;\n  }\n\n  getTopGroups(groups);\n  '}});