// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.17/esri/copyright.txt for details.
//>>built
define("require exports tslib ../../../geometry ../../../core/arrayUtils ../../../core/Error ../../../core/Logger ../../../core/maybe ../../../core/promiseUtils ../../../core/watchUtils ../../../core/accessorSupport/decorators ../../../geometry/support/quantizationUtils ../../../geometry/support/spatialReferenceUtils ../../../layers/support/arcgisLayerUrl ../../../layers/support/fieldUtils ../../statistics/support/predominanceUtils ../../statistics/support/utils ../utils ./LayerAdapter ./support/utils ../../../tasks/GenerateRendererTask ../../../tasks/support/GenerateRendererParameters ../../../tasks/support/QuantizationParameters ../../../tasks/support/StatisticDefinition ../../../tasks/support/UniqueValueDefinition".split(" "),
function(V,W,r,K,F,u,L,M,m,N,G,H,I,O,B,C,q,P,Q,n,R,D,S,E,T){var U=L.getLogger("esri.smartMapping.support.adapters.FeatureLayerAdapter");return function(J){function e(a){return J.call(this,a)||this}r.__extends(e,J);e.prototype.destroy=function(){this._hasLocalSource=null};e.prototype._isStatsSupportedOnService=function(){var a=this.layer;return!a.get("capabilities.query.supportsStatistics")||"multipatch"===this.geometryType&&!O.isHostedAgolService(a.url)&&10.5>a.version?m.reject(new u("feature-layer-adapter:not-supported",
"Layer does not support statistics query")):m.resolve()};e.prototype._fetchFeaturesFromMemory=function(a,c,b){return r.__awaiter(this,void 0,void 0,function(){var d,g,f,h,l;return r.__generator(this,function(k){switch(k.label){case 0:return d=this.layer,this._hasLocalSource?[4,d.queryFeatures(c)]:[3,2];case 1:return g=k.sent(),[2,g.features];case 2:if(!a)throw new u("feature-layer-adapter:insufficient-data","layerView is required to fetch the features");f=m.createAbortController();h=N.whenFalseOnce(a,
"updating",f.signal);return[4,m.timeout(h,5E3,f).catch(function(a){U.warn("LayerView is taking too long to update. Aborting fetch from layerView.");throw a;})];case 3:return k.sent(),[4,a.queryFeatures(c,{signal:b})];case 4:return l=k.sent(),[2,l.features]}})})};e.prototype._fetchFeaturesFromService=function(a,c){return this.layer.queryFeatures(a,{signal:c}).then(function(a){return a&&a.features})};e.prototype._fetchFeaturesForStats=function(a){var c=this;return P.getFieldsList({field:a.field,normalizationField:a.normalizationField,
valueExpression:a.valueExpression}).then(function(b){return c.getSampleFeatures({sampleSize:-1,view:a.view,returnGeometry:a.returnGeometry,requiredFields:b,signal:a.signal})})};e.prototype._summaryStatsFromGenRend=function(a){var c=a.normalizationType,b=a.normalizationField;return this.classBreaks({field:a.field,numClasses:5,classificationMethod:"standard-deviation",standardDeviationInterval:.25,normalizationType:c,normalizationField:"field"===c?b:void 0,minValue:a.minValue,maxValue:a.maxValue,signal:a.signal}).then(function(a){var b,
c,d;a.classBreakInfos.some(function(a){a.hasAvg&&(b=a);return!!b});b&&(d=b.maxValue-b.minValue,c=b.minValue+d/2,d*=4);return n.processSummaryStatisticsResult({min:a.minValue,max:a.maxValue,avg:c,stddev:d})})};e.prototype._getSummaryStatsQuery=function(a,c){var b=a.field,d=a.normalizationType,g=a.normalizationField,f=a.normalizationTotal;c=this.supportsSQLExpression&&c?n.msSinceUnixEpochSQL(this,b):a.sqlExpression;var f=n.getFieldExpr({field:b,normalizationType:d,normalizationField:g,normalizationTotal:f,
layer:this}),h=c||f,f=h?q.getRangeExpr(h,a.minValue,a.maxValue):null,b=q.getSQLFilterForNormalization({field:b,normalizationField:g,normalizationType:d});a=q.mergeWhereClauses(a.sqlWhere,b);a=q.mergeWhereClauses(a,f);b=this.layer.createQuery();b.where=q.mergeWhereClauses(b.where,a);b.sqlFormat=c?"standard":null;b.outStatistics=n.statisticTypes.map(function(a){var b=new E;b.statisticType="variance"===a?"var":a;b.onStatisticField=h;b.outStatisticFieldName=a+"_value";return b});return b};e.prototype._summaryStatsFromServiceQuery=
function(a,c){return r.__awaiter(this,void 0,void 0,function(){var b,d,g,f;return r.__generator(this,function(h){switch(h.label){case 0:return[4,this._isStatsSupportedOnService()];case 1:h.sent();if("percent-of-total"!==a.normalizationType)return[3,3];b=a;return[4,this._getNormalizationTotal(a.field,a.normalizationType)];case 2:b.normalizationTotal=h.sent(),h.label=3;case 3:return d=this._getSummaryStatsQuery(a,c),[4,this.layer.queryFeatures(d,{signal:a.signal})];case 4:return g=h.sent(),f=n.getSummaryStatisticsFromFeatureSet(g,
c),[2,n.processSummaryStatisticsResult(f)]}})})};e.prototype._summaryStatsFromClientQuery=function(a,c){return r.__awaiter(this,void 0,void 0,function(){var b,d,g;return r.__generator(this,function(f){switch(f.label){case 0:return b=this._getSummaryStatsQuery(a,c),[4,this.layer.queryFeatures(b,{signal:a.signal})];case 1:return d=f.sent(),g=n.getSummaryStatisticsFromFeatureSet(d,c),[2,n.processSummaryStatisticsResult(g)]}})})};e.prototype._summaryStatsFromMemory=function(a,c){return r.__awaiter(this,
void 0,void 0,function(){var b,d,g,f,h,l,k,v,e,z,t;return r.__generator(this,function(p){switch(p.label){case 0:return b=a.field,d=a.valueExpression,g=a.view,f={field:b,valueExpression:d,normalizationField:a.normalizationField,view:g,signal:a.signal},(l=a.features)?[3,2]:[4,this._fetchFeaturesForStats(f)];case 1:l=p.sent(),p.label=2;case 2:k=(h=l)&&h.length;if(!k)throw new u("feature-layer-adapter:insufficient-data","No features are available to calculate statistics");v=r.__assign({},a);return"percent-of-total"!==
v.normalizationType?[3,4]:[4,n.calculateStatsFromMemory({field:b},h)];case 3:e=p.sent();z=e.sum;if(null==z)throw new u("feature-layer-adapter:invalid","invalid normalizationTotal");v.normalizationTotal=z;p.label=4;case 4:return[4,n.calculateStatsFromMemory(v,h,c)];case 5:return t=p.sent(),[2,n.processSummaryStatisticsResult(t)]}})})};e.prototype._uvFromGenRenderer=function(a,c){var b=this,d=a.field,g=new T;g.attributeField=d;var f=new D;f.classificationDefinition=g;return this.generateRenderer(f,
a.signal).then(function(a){var c={},g=b.getField(d);a.uniqueValues.forEach(function(a){var b=a.value;if(null==b||""===b||"string"===typeof b&&(""===b.trim()||"\x3cnull\x3e"===b.toLowerCase()))b=null;null==c[b]?c[b]={count:a.count,data:B.isNumericField(g)&&b?Number(b):b}:c[b].count+=a.count});return{count:c}}).then(function(b){return n.createUVResult(b,c,a.returnAllCodedValues)})};e.prototype._getUVQuery=function(a){var c=a.field,b=a.sqlExpression,d="countOF"+(c||"Expr"),g=new E;g.statisticType="count";
g.onStatisticField=b?"1":c;g.outStatisticFieldName=d;d=this.layer.createQuery();d.where=q.mergeWhereClauses(d.where,a.sqlWhere);d.sqlFormat=b?"standard":null;d.outStatistics=[g];d.groupByFieldsForStatistics=[c||b];return d};e.prototype._uvFromServiceQuery=function(a,c){var b=this;return this._isStatsSupportedOnService().then(function(){return b.layer.queryFeatures(b._getUVQuery(a),{signal:a.signal})}).then(function(c){return n.getUniqueValuesFromFeatureSet(c,b,a.field,null,a.signal)}).then(function(b){return n.createUVResult(b,
c,a.returnAllCodedValues)})};e.prototype._uvFromClientQuery=function(a,c){return r.__awaiter(this,void 0,void 0,function(){var b,d,g,f;return r.__generator(this,function(h){switch(h.label){case 0:return b=a.signal,d=this._getUVQuery(a),[4,this.layer.queryFeatures(d,{signal:b})];case 1:return g=h.sent(),[4,n.getUniqueValuesFromFeatureSet(g,this,a.field,null,b)];case 2:return f=h.sent(),[2,n.createUVResult(f,c,a.returnAllCodedValues)]}})})};e.prototype._uvFromMemory=function(a,c){return r.__awaiter(this,
void 0,void 0,function(){var b,d,g,f,h,l,k;return r.__generator(this,function(e){switch(e.label){case 0:b=a.field;d=a.valueExpression;g=a.view;f=a.signal;h={field:b,valueExpression:d,view:g,signal:f};if(!a.features)return[3,1];k=a.features;return[3,3];case 1:return[4,this._fetchFeaturesForStats(h)];case 2:k=e.sent(),e.label=3;case 3:return l=k,[2,n.calculateUniqueValuesFromMemory(a,l,c)]}})})};e.prototype._calcBinsSQL=function(a,c){var b=[],d=c.length;c.forEach(function(c,f){c=q.mergeWhereClauses(a+
" \x3e\x3d "+c[0],a+(f===d-1?" \x3c\x3d ":" \x3c ")+c[1]);b.push("WHEN ("+c+") THEN "+(f+1))});return["CASE",b.join(" "),"ELSE 0 END"].join(" ")};e.prototype._getNormalizationTotal=function(a,c,b){return a&&"percent-of-total"===c?this.summaryStatistics({field:a,signal:b}).then(function(a){return a.sum}):m.resolve(null)};e.prototype._getQueryParamsForExpr=function(a,c){var b=a.signal;if(!a.valueExpression&&!a.sqlExpression){var d=a.field,g=d?this.getField(d):null,g=B.isDateField(g);c={field:d,normalizationType:a.normalizationType,
normalizationField:a.normalizationField,normalizationTotal:c,layer:this};return{sqlExpression:g?n.msSinceUnixEpochSQL(this,d):n.getFieldExpr(c),sqlWhere:g?null:a.sqlWhere||q.getSQLFilterForNormalization(a),signal:b}}return{valueExpression:a.valueExpression,sqlExpression:a.sqlExpression,sqlWhere:a.sqlWhere,signal:b}};e.prototype._getDataRange=function(a,c,b){return null!=c&&null!=b?m.resolve({min:c,max:b}):this.summaryStatistics(a).then(function(a){return{min:a.min,max:a.max}})};e.prototype._histogramForExpr=
function(a){var c=this;return this._getNormalizationTotal(a.field,a.normalizationType,a.signal).then(function(b){var d=c._getQueryParamsForExpr(a,b);return c._getDataRange(d,a.minValue,a.maxValue).then(function(g){var f=g.min,h=g.max,l=a.numBins||10;g=n.getEqualIntervalBins(f,h,l);g=c._calcBinsSQL(d.sqlExpression,g);var k=new E({statisticType:"count",outStatisticFieldName:"countOFExpr",onStatisticField:"1"}),e=c.layer.createQuery();e.where=q.mergeWhereClauses(e.where,d.sqlWhere);e.sqlFormat="standard";
e.outStatistics=[k];e.groupByFieldsForStatistics=[g];e.orderByFields=[g];return c._isStatsSupportedOnService().then(function(){return c.layer.queryFeatures(e,{signal:d.signal})}).then(function(a){return n.getHistogramFromFeatureSet(a,f,h,l,b)})})})};e.prototype._histogramForField=function(a){var c=this,b=null,b=null!=a.minValue&&null!=a.maxValue?m.resolve({min:a.minValue,max:a.maxValue}):this.summaryStatistics(a).then(function(a){if(!a.count)throw new u("feature-layer-adapter:insufficient-data","Either the layer has no features or none of the features have data for the field");
return{min:a.min,max:a.max}});return b.then(function(b){return c._getBins({min:b.min,max:b.max},a.field,a.numBins,a.signal)})};e.prototype._getBins=function(a,c,b,d){void 0===b&&(b=10);var g=a.min,f=a.max,h=a.normTotal,l=a.excludeZerosExpr,k=a.intervals||n.getEqualIntervalBins(g,f,b);return this._queryBins(k,a.sqlExpr||c,l,d).then(function(a){return{bins:a.map(function(a,b){return{minValue:k[b][0],maxValue:k[b][1],count:a.value}}),minValue:g,maxValue:f,normalizationTotal:h}})};e.prototype._queryBins=
function(a,c,b,d){for(var g=this,f=[],h=a.length,l=0;l<h;l++){var k=q.mergeWhereClauses(b,q.mergeWhereClauses(c+" \x3e\x3d "+a[l][0],null!==a[l][1]?c+(l===h-1?" \x3c\x3d ":" \x3c ")+a[l][1]:""));f.push(k)}return m.eachAlways(f.map(function(a){return g.queryFeatureCount(a,d)}))};e.prototype._binParamsFromGenRend=function(a,c){var b=this,d=a.field,g=a.normalizationType,f=a.normalizationField,h=a.signal,l=q.getSQLFilterForNormalization({field:d,normalizationType:g,normalizationField:f});a=new D({classificationDefinition:n.createCBDefn({field:d,
normalizationType:g,normalizationField:f,classificationMethod:a.classificationMethod,standardDeviationInterval:a.standardDeviationInterval,breakCount:a.numBins||10}),where:q.mergeWhereClauses(l,c)});return this.generateRenderer(a,h).then(function(a){return n.generateBinParams({field:d,normalizationType:g,normalizationField:f,normalizationTotal:a.normalizationTotal,classBreaks:a.classBreaks,where:l,layer:b})})};e.prototype._histogramFromMemory=function(a){var c=this,b=a.field,d=a.normalizationType,
g=a.valueExpression,f=a.classificationMethod,h=a.minValue,l=a.maxValue,k=a.view,e=a.signal,p={field:b,valueExpression:g,normalizationField:a.normalizationField,view:k,signal:e};return(a.features?m.resolve(a.features):this._fetchFeaturesForStats(p)).then(function(v){if(!v||!v.length)throw new u("feature-layer-adapter:insufficient-data","No features are available to calculate histogram");var t=null!=h&&null!=l,p=null;f&&"equal-interval"!==f||d?(t=r.__assign({},a),t.features=v,p=c._getBinParamsFromMemory(t)):
p=t?m.resolve({min:h,max:l,source:"parameters"}):c.summaryStatistics({field:b,valueExpression:g,features:v,view:k,signal:e}).then(function(a){return a.count?{min:a.min,max:a.max}:m.reject(new u("feature-layer-adapter:insufficient-data","No features are available to calculate histogram"))});return p.then(function(b){return n.calculateHistogramFromMemory(a,b,v)})})};e.prototype._getBinParamsFromMemory=function(a){return r.__awaiter(this,void 0,void 0,function(){var c,b,d,g,f,h,e,k,v,p,m,t=this;return r.__generator(this,
function(l){c=a.field;b=a.valueExpression;d=a.classificationMethod;g=a.standardDeviationInterval;f=a.normalizationType;h=a.normalizationField;e=a.minValue;k=a.maxValue;v=a.features;p=a.view;m=a.signal;return[2,this._classBreaksFromMemory({field:c,valueExpression:b,normalizationType:f,normalizationField:h,classificationMethod:d,standardDeviationInterval:g,minValue:e,maxValue:k,numClasses:a.numBins,features:v,view:p,signal:m}).then(function(a){var b=a.normalizationTotal;a=a.classBreakInfos;var d=q.getSQLFilterForNormalization({field:c,
normalizationType:f,normalizationField:h});return n.generateBinParams({field:c,normalizationType:f,normalizationField:h,normalizationTotal:b,classBreaks:a,where:d,layer:t})})]})})};e.prototype._classBreaksFromGenRend=function(a){var c=a.field,b=a.normalizationType,d=a.normalizationField,g=a.normalizationTotal,f=a.signal,h=q.getSQLFilterForNormalization({field:c,normalizationType:b,normalizationField:d}),g=n.getFieldExpr({field:c,normalizationType:b,normalizationField:d,normalizationTotal:g,layer:this}),
g=q.getRangeExpr(g,a.minValue,a.maxValue),c=n.createCBDefn({field:c,normalizationType:b,normalizationField:d,classificationMethod:a.classificationMethod,standardDeviationInterval:a.standardDeviationInterval,breakCount:a.numClasses||5}),b=new D;b.classificationDefinition=c;b.where=q.mergeWhereClauses(h,g);return this.generateRenderer(b,f).then(function(b){return n.resolveCBResult(a,b)})};e.prototype._classBreaksFromInterpolation=function(a){for(var c=a.minValue,b=a.maxValue,d=a.numClasses||5,g=[],
f=(b-c)/d,h=0;h<d;h++){var e=c+h*f;g.push({minValue:e,maxValue:e+f})}g[d-1].maxValue=b;a=n.resolveCBResult(a,{classBreaks:g,normalizationTotal:a.normalizationTotal});return m.resolve(a)};e.prototype._classBreaksFromMemory=function(a){return r.__awaiter(this,void 0,void 0,function(){var c,b,d,g,f,h,e,k,v,p,m,t;return r.__generator(this,function(l){switch(l.label){case 0:return c=a.field,b=a.normalizationField,d=a.valueExpression,g=a.view,f=a.signal,h={field:c,valueExpression:d,normalizationField:b,
view:g,signal:f},(k=a.features)?[3,2]:[4,this._fetchFeaturesForStats(h)];case 1:k=l.sent(),l.label=2;case 2:v=(e=k)&&e.length;if(!v)throw new u("feature-layer-adapter:insufficient-data","No features are available to calculate statistics");p=r.__assign({},a);return"percent-of-total"!==p.normalizationType?[3,4]:[4,n.calculateStatsFromMemory({field:c},e)];case 3:m=l.sent();t=m.sum;if(null==t)throw new u("feature-layer-adapter:invalid","invalid normalizationTotal");p.normalizationTotal=t;l.label=4;case 4:return[2,
n.calculateClassBreaksFromMemory(p,e)]}})})};e.prototype._heatmapStatsFromMemory=function(a,c){return r.__awaiter(this,void 0,void 0,function(){var b,d,g,f,h,e,k,v,p,m,t,q;return r.__generator(this,function(l){switch(l.label){case 0:return b=a.blurRadius,d=a.field,g=a.view,f=a.signal,h=g.state,e=h.resolution,k=h.size,v=new S.default({extent:g.extent,tolerance:e}),m=this._quantizeFeatures,(t=a.features)?[3,2]:[4,this._fetchFeaturesForStats({field:d,view:g,returnGeometry:!0,signal:f})];case 1:t=l.sent(),
l.label=2;case 2:p=m.apply(this,[t,v,g]);if(!p||!p.length)return[2,{count:0,min:null,max:null,avg:null,stddev:null}];if(q=n.calculateHeatmapStats(p,b,c,d,k[0],k[1]))return[2,{count:q.count,min:q.min,max:q.max,avg:q.mean,stddev:q.stdDev}];throw new u("feature-layer-adapter:invalid","unable to calculate heatmap statistics");}})})};e.prototype._quantizeFeatures=function(a,c,b){var d=this,g=H.toQuantizationTransform(c);c=b.spatialReference;var f=b.size,h=I.isWrappable(c);b=I.getInfo(c);var e=Math.round((b.valid[1]-
b.valid[0])/g.scale[0]);return a.map(function(a){var b=new K.Point(M.unwrap(a.geometry));H.quantizePoint(g,b,b,b.hasZ,b.hasM);a.geometry=h?d._wrapPoint(b,e,f[0]):b;return a})};e.prototype._wrapPoint=function(a,c,b){0>a.x?a.x+=c:a.x>b&&(a.x-=c);return a};e.prototype.getField=function(a){void 0===a&&(a="");return this.layer.getField(a)};e.prototype.getFieldUsageInfo=function(a){return this.getField(a)?{supportsLabelingInfo:!0,supportsRenderer:!0,supportsPopupTemplate:!0,supportsLayerQuery:!0,supportsStatistics:!0}:
null};e.prototype.getFieldDomain=function(a,c){return this.layer.getFieldDomain(a,c)};e.prototype.summaryStatistics=function(a){var c=this,b=a.field,b=b?this.getField(b):null,d=B.isDateField(b),g=(b=a.valueExpression||a.sqlExpression)&&!a.sqlExpression,f=a.view,f=f&&"3d"===f.type;return this._hasLocalSource||a.features||g?g||a.features||f?this._summaryStatsFromMemory(a,d):this._summaryStatsFromClientQuery(a,d):this.supportsSQLExpression||!d&&!b?(a.normalizationType&&!this.supportsSQLExpression?this._summaryStatsFromGenRend(a):
this._summaryStatsFromServiceQuery(a,d)).catch(function(){m.throwIfAborted(a.signal);return c._summaryStatsFromMemory(a,d)}):m.reject(new u("feature-layer-adapter:not-supported","Layer does not support standardized SQL expression for queries"))};e.prototype.uniqueValues=function(a){var c=this,b=a.field,d=a.valueExpression,g=a.sqlExpression,f=a.signal,h=(b?this.getField(b):null)&&this.getFieldDomain(b),e=d&&(!g||!this.supportsSQLExpression),k=(b=a.view)&&"3d"===b.type;return this._hasLocalSource||
a.features||e?e||a.features||k?this._uvFromMemory(a,h):this._uvFromClientQuery(a,h):this._uvFromServiceQuery(a,h).catch(function(b){m.throwIfAborted(f);return a.field?c._uvFromGenRenderer(a,h):b}).catch(function(){m.throwIfAborted(f);return e||a.features||k?c._uvFromMemory(a,h):c._uvFromClientQuery(a,h)})};e.prototype.histogram=function(a){var c=this,b=a.field,d=a.normalizationType,g=a.normalizationField,f=a.classificationMethod,h=a.signal,e=b?this.getField(b):null,e=B.isDateField(e),k=a.valueExpression||
a.sqlExpression,r=k&&!a.sqlExpression,p=this.supportsSQLExpression,z=!f||"equal-interval"===f,t=a.minValue,x=a.maxValue,w=null!=t&&null!=x,y=a.numBins||10;return this._hasLocalSource||a.features||r?this._histogramFromMemory(a):(k||p)&&z?k&&!p?m.reject(new u("feature-layer-adapter:not-supported","Layer does not support standardized SQL expression for queries")):this._histogramForExpr(a):e&&z?m.reject(new u("feature-layer-adapter:not-supported","Normalization and date field are not allowed when layer does not support standardized SQL expression for queries")):
d||!z?this._binParamsFromGenRend(a).then(function(f){if(!w)return c._getBins(f,b,y,h);if(t>f.max||x<f.min)throw new u("histogram:insufficient-data","Range defined by 'minValue' and 'maxValue' does not intersect available data range of the field");if(z)return c._getBins({min:t,max:x,sqlExpr:f.sqlExpr,excludeZerosExpr:f.excludeZerosExpr},b,y,h);f=n.getFieldExpr({field:b,normalizationType:d,normalizationField:g,normalizationTotal:f.normTotal,layer:c});f=q.getRangeExpr(f,t,x);return c._binParamsFromGenRend(a,
f).then(function(a){return c._getBins(a,b,y,h)})}):this._histogramForField(a)};e.prototype.classBreaks=function(a){var c=this,b=!1!==a.analyzeData,d=this._hasLocalSource||a.features||a.valueExpression;return b&&d?this._classBreaksFromMemory(a):(b?this._classBreaksFromGenRend(a):this._classBreaksFromInterpolation(a)).catch(function(){m.throwIfAborted(a.signal);return c._classBreaksFromMemory(a)})};e.prototype.queryFeatureCount=function(a,c){if(this._hasLocalSource)return m.reject(new u("feature-layer-adapter:not-supported",
"Layer does not support count query"));var b=this.layer,d=b.createQuery();d.where=q.mergeWhereClauses(d.where,a);return b.queryFeatureCount(d,{signal:c})};e.prototype.generateRenderer=function(a,c){var b=this.layer;if(this._hasLocalSource||10.1>b.version)return m.reject(new u("feature-layer-adapter:not-supported","Layer does not support generateRenderer operation (requires ArcGIS Server version 10.1+)"));var d=new R({url:b.parsedUrl.path,source:b.dynamicDataSource,gdbVersion:b.gdbVersion}),b=b.createQuery();
a.where=q.mergeWhereClauses(a.where,b.where);return d.execute(a,{signal:c})};e.prototype.heatmapStatistics=function(a){var c=this,b=a.field,d=a.fieldOffset,g=a.signal;return(b&&null==d?this.summaryStatistics({field:b,signal:g}):m.resolve(null)).then(function(b){var f=d||0;if(b){var g=b.min,e=b.max;b.count?g===e&&0===g?f=1:0>=e?f="abs":0>g&&(f=-1.01*g):f=1}return c._heatmapStatsFromMemory(a,f).then(function(a){return r.__assign(r.__assign({},a),{summaryStatistics:b,fieldOffset:f})})})};e.prototype.predominantCategories=
function(a){return r.__awaiter(this,void 0,void 0,function(){var c,b,d,g,f,e,l,k,n,p,m,t,q,w,y,A;return r.__generator(this,function(h){switch(h.label){case 0:if(!this._hasLocalSource&&!this.supportsSQLExpression)throw new u("feature-layer-adapter:not-supported","Layer does not support advanced SQL expressions and standardized queries");c=a.fields;b=a.view;d=a.signal;g=C.getArcadeForPredominantCategory(c);f=C.getSQLForPredominantCategoryName(c);return b&&this._hasLocalSource?[4,this._uvFromMemory({valueExpression:g,
view:b,signal:d})]:[3,2];case 1:return l=h.sent(),[3,4];case 2:return[4,this._uvFromServiceQuery({sqlExpression:f.expression,valueExpression:g,signal:d})];case 3:l=h.sent(),h.label=4;case 4:e=l;k=e.uniqueValueInfos;n=k.map(function(a){return a.value});p=c.filter(function(a){return-1===n.indexOf(a)});m=0;for(t=p;m<t.length;m++)q=t[m],k.push({value:q,count:0});k.sort(function(a,b){return c.indexOf(a.value)-c.indexOf(b.value)});w=0;for(y=k;w<y.length;w++)A=y[w],A.value===C.noDominantCategoryField&&(A.value=
null);return[2,{predominantCategoryInfos:k}]}})})};e.prototype.getSampleFeatures=function(a){return r.__awaiter(this,void 0,void 0,function(){var c,b,d,g,f,e,l,k,q,p,u,t,x,w,y,A;return r.__generator(this,function(h){switch(h.label){case 0:c=a.view;b=a.sampleSize;d=a.requiredFields;g=a.returnGeometry;f=a.signal;e=this.layer.createQuery();l=1;e.outSpatialReference=a.spatialReference||c&&c.spatialReference;e.returnGeometry=!!g;e.outFields=d;k=[];q=!1;if(!c)return[3,7];h.label=1;case 1:return h.trys.push([1,
6,,7]),[4,c.whenLayerView(this.layer)];case 2:return p=h.sent(),[4,n.getMissingFields(this,d,p)];case 3:return u=h.sent(),(q=!u.length)?[4,this._fetchFeaturesFromMemory(p,e,f)]:[3,5];case 4:k=h.sent();if(k.length&&0<b&&b<=k.length)return[2,F.pickRandom(k,b,l)];h.label=5;case 5:return[3,7];case 6:return h.sent(),m.throwIfAborted(f),[3,7];case 7:return h.trys.push([7,11,,12]),this._hasLocalSource?[2,q?k:this._fetchFeaturesFromService(e,f)]:[4,this.queryFeatureCount(null,f)];case 8:t=h.sent();x=this.layer.capabilities.query.maxRecordCount;
w=-1===b?t:b;w=x&&w>x?x:w;if(t<=k.length||k.length>=x)return[2,k];y=c.extent.width/c.width/c.scale*4E5;e.maxAllowableOffset=a.resolution||y;return t<=w?[2,this._fetchFeaturesFromService(e,f)]:2E4>=t?[4,this.layer.queryObjectIds()]:[3,10];case 9:return A=h.sent(),e.objectIds=F.pickRandom(A,w,l),[2,this._fetchFeaturesFromService(e,f)];case 10:return this.layer.get("capabilities.query.supportsPagination")&&(e.num=Math.min(w,2E4)),[2,this._fetchFeaturesFromService(e,f)];case 11:return h.sent(),m.throwIfAborted(f),
[2,k];case 12:return[2]}})})};e.prototype.load=function(a){var c=this;a=this.layer.load(a).then(function(a){c.geometryType=a.geometryType;c.objectIdField=a.objectIdField;c.supportsSQLExpression=a.get("capabilities.query.supportsSqlExpression");c._hasLocalSource=!a.url&&!!a.source;c.hasQueryEngine=c._hasLocalSource;c.minScale=a.minScale;c.maxScale=a.maxScale;c.fullExtent=a.fullExtent});this.addResolvingPromise(a);return m.resolve(this)};r.__decorate([G.property({constructOnly:!0})],e.prototype,"layer",
void 0);return e=r.__decorate([G.subclass("esri.smartMapping.support.adapters.FeatureLayerAdapter")],e)}(Q)});