// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.17/esri/copyright.txt for details.
//>>built
define("require exports tslib ../../core/Error ../../core/maybe ../../core/promiseUtils ./support/utils ../support/utils ../support/adapters/support/layerUtils".split(" "),function(D,E,k,q,x,y,z,A,u){function B(a){return k.__awaiter(this,void 0,void 0,function(){var e,l,d,g,h,c,r,b,m,p,f,t,v,w;return k.__generator(this,function(n){switch(n.label){case 0:if(!(a&&a.layer&&a.attributes))throw new q("summary-statistics-for-attributes:missing-parameters","'layer' and 'attributes' parameters are required");
if((e=a.attributes.some(function(a){return!!a.valueExpression}))&&!a.view)throw new q("summary-statistics-for-attributes:missing-parameters","View is required when 'valueExpression' is specified in attributes");l=[2,1];d=a.layer;g=k.__rest(a,["layer"]);h=u.createLayerAdapter(d,l);c=k.__assign({layerAdapter:h},g);c.includeZeros=null==c.includeZeros||c.includeZeros;c.includeNegatives=null==c.includeNegatives||c.includeNegatives;if(!h)throw new q("summary-statistics-for-attributes:invalid-parameters",
"'layer' must be one of these types: "+u.getLayerTypeLabels(l).join(", "));r=c.view;b=x.isSome(c.signal)?{signal:c.signal}:null;return[4,y.all([r&&r.when(),h.load(b)])];case 1:n.sent(),m=[],p=0,f=c.attributes,n.label=2;case 2:if(!(p<f.length))return[3,5];t=f[p];return[4,A.getFieldsList({field:t.field,valueExpression:t.valueExpression})];case 3:v=n.sent(),Array.prototype.push.apply(m,v),n.label=4;case 4:return p++,[3,2];case 5:if(w=z.verifyBasicFieldValidity(h,m,"summary-statistics-for-attributes:invalid-parameters"))throw w;
return[2,c]}})})}function C(a,e,l){var d=[],g=[],h=[],c=[],k=[];a.forEach(function(a,f){var b=a.field?"field":"expression",e=a.field||a.valueExpression;a.field?(k.push(e),g.push("var "+b+f+' \x3d Number($feature["'+e+'"]);')):(d.push("function getValueForExpr"+f+"() {\n  "+e+" \n}"),g.push("var "+b+f+" \x3d Number(getValueForExpr"+f+"());"));l||h.push(""+b+f+" \x3d IIf("+b+f+" \x3c 0, 0, "+b+f+");");c.push(""+b+f)});a="return sum;";var b=d.length?null:k.reduce(function(a,b){return a+" + "+b}),m=null;
e||l?e?l||(a="return IIf(sum \x3e\x3d 0, sum, null);",b&&(m="(( "+b+" ) \x3e\x3d 0)")):(a="return IIf(sum !\x3d 0, sum, null);",b&&(m="(( "+b+" ) \x3c\x3e 0)")):(a="return IIf(sum \x3e 0, sum, null);",b&&(m="(( "+b+" ) \x3e 0)"));return{valueExpression:[d.length?d.join("\n"):"",g.join("\n"),h.join("\n"),"var sum \x3d "+c.join(" + ")+";",a].filter(Boolean).join("\n\n"),sqlExpression:b,sqlWhere:m}}return function(a){return k.__awaiter(this,void 0,void 0,function(){var e,l,d,g;return k.__generator(this,
function(h){switch(h.label){case 0:return[4,B(a)];case 1:return e=h.sent(),l=e.layerAdapter,d=k.__rest(e,["layerAdapter"]),g=C(d.attributes,d.includeZeros,d.includeNegatives),[2,l.summaryStatistics({valueExpression:g.valueExpression,sqlExpression:g.sqlExpression,sqlWhere:g.sqlWhere,view:d.view,signal:d.signal})]}})})}});