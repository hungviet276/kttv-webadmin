// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.17/esri/copyright.txt for details.
//>>built
define("require exports tslib ../../../Graphic ../../../core/arrayUtils ../../../core/Error ../../../core/maybe ../../../core/promiseUtils ../../../core/watchUtils ../../../core/accessorSupport/decorators ../../../layers/support/fieldUtils ../../statistics/support/utils ../utils ./FeatureLayerAdapter ./LayerAdapter ./support/utils ../../../tasks/support/FeatureSet".split(" "),function(I,J,p,w,x,m,B,n,C,y,t,D,E,F,G,q,z){return function(A){function c(a){return A.call(this,a)||this}p.__extends(c,A);
c.prototype._hasCachedStatistics=function(a){return this.layer.hasCachedStatistics(a)};c.prototype._updateQuery=function(a,b,d){var e=this;void 0===b&&(b=[]);void 0===d&&(d=[]);if(!d.length)return a;var g=this.layer.objectIdField;a=a.clone();b=b.filter(function(a){a=e.layer.getField(a);return-1===d.indexOf(a.name)});var f=b.some(function(a){return e.layer.getField(a).name===g});a.outFields=f?b:p.__spreadArrays(b,[g]);return a};c.prototype._fetchFeaturesFromMemory=function(a,b,d){return p.__awaiter(this,
void 0,void 0,function(){var e,g,f,l,k,r,h;return p.__generator(this,function(c){switch(c.label){case 0:if(!a)throw new m("scene-layer-adapter:insufficient-data","view is required to fetch the features from layerView");return[4,a.whenLayerView(this.layer)];case 1:return e=c.sent(),g=n.createAbortController(),f=C.whenFalseOnce(e,"updating",g.signal),[4,n.timeout(f,5E3,g)];case 2:return c.sent(),[4,q.getMissingFields(this,d,e)];case 3:return l=c.sent(),k=this._updateQuery(b,d,l),[4,e.queryFeatures(k)];
case 4:return r=c.sent(),h=r.features,[2,l.length?e.whenGraphicAttributes(h,l):h]}})})};c.prototype._fetchFeaturesForStats=function(a){var b=this;return E.getFieldsList({field:a.field,normalizationField:a.normalizationField,valueExpression:a.valueExpression}).then(function(d){return b.getSampleFeatures({sampleSize:-1,view:a.view,returnGeometry:a.returnGeometry,requiredFields:d,signal:a.signal})})};c.prototype._generateFeatureSetForCachedHistogram=function(a,b,d,e){void 0===b&&(b=a.minimum);void 0===
d&&(d=a.maximum);for(var g=[],f=0;f<e;f++)g[f]=0;for(var l=a.counts.length,k=a.minimum,r=a.maximum,f=0;f<l;f++){var h=(f+.5)/l,h=((1-h)*k+h*r-b)/(d-b)*e;0<=h&&h<=e&&(g[h===e?e-1:Math.floor(h)]+=a.counts[f])}var c=[];g.forEach(function(a,b){var g=new w({attributes:{}});g.attributes.EXPR_1=b+1;g.attributes.countOFExpr=a;c.push(g)});a=new z;a.features=c;return a};c.prototype._getCachedStatistics=function(a,b){var d=this.layer;return a.valueExpression||a.sqlExpression||a.sqlWhere||a.minValue||a.maxValue?
n.reject(new m("scene-layer-adapter:not-supported","This Layer does not support calculating statistics when 'valueExpression', 'sqlExpression', 'sqlWhere', 'minValue' or 'maxValue' is specified")):d.queryCachedStatistics(b&&b.name,{signal:a.signal}).then(function(a){var b=a.stats;a=b.min;var d=b.max,e=b.avg,k=b.stddev,c=b.sum,h=b.variance,b=b.count;if(0!==a||0!==d)e=0===e?null:e,c=0===c?null:c,k=0===k?null:k,h=0===h?null:h,b=0===b?null:b;null==b&&null!=c&&null!=e&&(b=Math.round(c/e));return{avg:e,
count:b,max:d,min:a,stddev:k,sum:c,variance:h}})};c.prototype._getSummaryStatisticsFromMemory=function(a,b){return p.__awaiter(this,void 0,void 0,function(){var d,e,g,c,l,k,r,h,n;return p.__generator(this,function(f){switch(f.label){case 0:d={field:a.field,valueExpression:a.valueExpression,normalizationField:a.normalizationField,view:a.view,signal:a.signal};if(!a.features)return[3,1];g=a.features;return[3,3];case 1:return[4,this._fetchFeaturesForStats(d)];case 2:g=f.sent(),f.label=3;case 3:c=(e=g)&&
e.length;if(!c)throw new m("scene-layer-adapter:insufficient-data","No features are available to calculate statistics");l=t.isDateField(b);k=p.__assign({},a);return"percent-of-total"!==k.normalizationType?[3,5]:[4,q.calculateStatsFromMemory({field:k.field},e)];case 4:r=f.sent();h=r.sum;if(null==h)throw new m("scene-layer-adapter:invalid","invalid normalizationTotal");k.normalizationTotal=h;f.label=5;case 5:return[4,q.calculateStatsFromMemory(k,e,l)];case 6:return n=f.sent(),[2,q.processSummaryStatisticsResult(n)]}})})};
c.prototype._getCachedStatisticsForUniqueValues=function(a,b){var d=this,e=this.layer,c=b&&b.name,f=b&&this.getFieldDomain(a.field);return a.valueExpression||a.sqlExpression||a.sqlWhere?n.reject(new m("scene-layer-adapter:not-supported","This Layer does not support calculating statistics when 'valueExpression', 'sqlExpression' or 'sqlWhere' is specified")):e.queryCachedStatistics(c,{signal:a.signal}).then(function(g){var f=g.stats;if(!f.mostFrequentValues)return n.reject();g=g.labels&&g.labels.labels;
var l={},h=[],p="countOF"+c;f.mostFrequentValues.forEach(function(a){var d=new w({attributes:{}});d.attributes[c]=b&&b.name!==e.objectIdField&&(t.isNumericField(b)||t.isDateField(b))?Number(a.value):a.value;d.attributes[p]=a.count;h.push(d)});g&&g.forEach(function(a){l[a.value]=a.label});f=new z;f.features=h;return q.getUniqueValuesFromFeatureSet(f,d,a.field,l,a.signal)}).then(function(b){return q.createUVResult(b,f,a.returnAllCodedValues)})};c.prototype._getUniqueValuesFromMemory=function(a,b){var d=
b&&this.getFieldDomain(a.field);b={field:a.field,valueExpression:a.valueExpression,view:a.view,signal:a.signal};return(a.features?n.resolve(a.features):this._fetchFeaturesForStats(b)).then(function(b){return q.calculateUniqueValuesFromMemory(a,b,d)})};c.prototype._getCachedStatisticsForHistogram=function(a,b){var d=this,e=this.layer;return a.valueExpression||a.sqlExpression||a.sqlWhere||a.normalizationType?n.reject(new m("scene-layer-adapter:not-supported","This Layer does not support calculating statistics when 'valueExpression' or 'sqlExpression' or 'sqlWhere' or 'normalizationType' is specified")):
e.queryCachedStatistics(b&&b.name,{signal:a.signal}).then(function(b){b=b.stats;var e=a.minValue,c=a.maxValue,e=null!=e?e:b.min,c=null!=c?c:b.max,g=a.numBins||10;b=d._generateFeatureSetForCachedHistogram(b.histogram,e,c,g);return q.getHistogramFromFeatureSet(b,e,c,g)})};c.prototype._getClassBreaksFromMemory=function(a){return p.__awaiter(this,void 0,void 0,function(){var b,d,e,c,f,l,k;return p.__generator(this,function(g){switch(g.label){case 0:b={field:a.field,valueExpression:a.valueExpression,normalizationField:a.normalizationField,
view:a.view,signal:a.signal};if(!a.features)return[3,1];e=a.features;return[3,3];case 1:return[4,this._fetchFeaturesForStats(b)];case 2:e=g.sent(),g.label=3;case 3:c=(d=e)&&d.length;if(!c)throw new m("scene-layer-adapter:insufficient-data","No features are available to calculate statistics");f=p.__assign({},a);return"percent-of-total"!==f.normalizationType?[3,5]:[4,q.calculateStatsFromMemory({field:f.field},d)];case 4:l=g.sent();k=l.sum;if(null==k)throw new m("scene-layer-adapter:invalid","invalid normalizationTotal");
f.normalizationTotal=k;g.label=5;case 5:return[2,q.calculateClassBreaksFromMemory(f,d)]}})})};c.prototype._getHistogramFromMemory=function(a){var b=this,d={field:a.field,valueExpression:a.valueExpression,normalizationField:a.normalizationField,view:a.view,signal:a.signal};return(a.features?n.resolve(a.features):this._fetchFeaturesForStats(d)).then(function(d){if(!d||!d.length)throw new m("scene-layer-adapter:insufficient-data","No features are available to calculate histogram");var c=a.field,e=a.normalizationType,
l=a.valueExpression,k=a.classificationMethod,r=a.minValue,h=a.maxValue,H=a.view,u=null!=r&&null!=h,v=null;k&&"equal-interval"!==k||e?(c=p.__assign({},a),c.features=d,v=b._getBinParamsFromMemory(c)):v=u?n.resolve({min:r,max:h}):b.summaryStatistics({field:c,valueExpression:l,features:d,view:H,signal:a.signal}).then(function(a){return a.count?{min:a.min,max:a.max}:n.reject(new m("feature-layer-adapter:insufficient-data","No features are available to calculate histogram"))});return v.then(function(b){return q.calculateHistogramFromMemory(a,
b,d)})})};c.prototype._getBinParamsFromMemory=function(a){return p.__awaiter(this,void 0,void 0,function(){var b,d,c,g,f,l,k,n,h,m,u=this;return p.__generator(this,function(e){b=a.field;d=a.valueExpression;c=a.classificationMethod;g=a.standardDeviationInterval;f=a.normalizationType;l=a.normalizationField;k=a.minValue;n=a.maxValue;h=a.features;m=a.view;return[2,this._getClassBreaksFromMemory({field:b,valueExpression:d,normalizationType:f,normalizationField:l,classificationMethod:c,standardDeviationInterval:g,
minValue:k,maxValue:n,numClasses:a.numBins,features:h,view:m}).then(function(a){var d=a.normalizationTotal;a=a.classBreakInfos;var c=D.getSQLFilterForNormalization({field:b,normalizationType:f,normalizationField:l});return q.generateBinParams({field:b,normalizationType:f,normalizationField:l,normalizationTotal:d,classBreaks:a,where:c,layer:u})})]})})};c.prototype.getField=function(a){void 0===a&&(a="");return this.layer.getField(a)};c.prototype.getFieldUsageInfo=function(a){a=this.getField(a);if(!a)return null;
a=this.layer.getFieldUsageInfo(a.name);return{supportsLabelingInfo:a.supportsLabelingInfo,supportsPopupTemplate:a.supportsPopupTemplate,supportsRenderer:a.supportsRenderer,supportsLayerQuery:a.supportsLayerQuery,supportsStatistics:!0}};c.prototype.getFieldDomain=function(a,b){return this._featureLayerAdapter?this._featureLayerAdapter.getFieldDomain(a,b):null};c.prototype.summaryStatistics=function(a){var b=this,d=this.getField(a.field);return this._featureLayerAdapter?this._featureLayerAdapter.summaryStatistics(a):
this._hasCachedStatistics(d&&d.name)?this._getCachedStatistics(a,d).catch(function(){n.throwIfAborted(a.signal);return b._getSummaryStatisticsFromMemory(a,d)}):this._getSummaryStatisticsFromMemory(a,d)};c.prototype.uniqueValues=function(a){var b=this,d=this.getField(a.field);return this._featureLayerAdapter?this._featureLayerAdapter.uniqueValues(a):this._hasCachedStatistics(d&&d.name)?this._getCachedStatisticsForUniqueValues(a,d).catch(function(){n.throwIfAborted(a.signal);return b._getUniqueValuesFromMemory(a,
d)}):this._getUniqueValuesFromMemory(a,d)};c.prototype.histogram=function(a){var b=this,d=this.getField(a.field);return this._featureLayerAdapter?this._featureLayerAdapter.histogram(a):this._hasCachedStatistics(d&&d.name)?this._getCachedStatisticsForHistogram(a,d).catch(function(){n.throwIfAborted(a.signal);return b._getHistogramFromMemory(a)}):this._getHistogramFromMemory(a)};c.prototype.classBreaks=function(a){var b=this.getField(a.field);return this._featureLayerAdapter?this._featureLayerAdapter.classBreaks(a):
this._hasCachedStatistics(b&&b.name)?n.reject(new m("scene-layer-adapter:not-supported","Cached stats not supported")):this._getClassBreaksFromMemory(a)};c.prototype.queryFeatureCount=function(a,b){return this._featureLayerAdapter?this._featureLayerAdapter.queryFeatureCount(a,b):n.reject(new m("scene-layer-adapter:not-supported","SceneLayer without associated FeatureLayer does not support count query"))};c.prototype.generateRenderer=function(a,b){return this._featureLayerAdapter?this._featureLayerAdapter.generateRenderer(a,
b):n.reject(new m("scene-layer-adapter:not-supported","SceneLayer without associated FeatureLayer does not support generateRenderer operation"))};c.prototype.heatmapStatistics=function(a){return this._featureLayerAdapter?this._featureLayerAdapter.heatmapStatistics(a):n.reject(new m("scene-layer-adapter:not-supported","SceneLayer without associated FeatureLayer does not support heatmapStatistics operation"))};c.prototype.predominantCategories=function(a){return p.__awaiter(this,void 0,void 0,function(){return p.__generator(this,
function(b){if(this._featureLayerAdapter)return[2,this._featureLayerAdapter.predominantCategories(a)];throw new m("scene-layer-adapter:not-supported","SceneLayer without associated FeatureLayer does not support predominantCategories");})})};c.prototype.getSampleFeatures=function(a){return p.__awaiter(this,void 0,void 0,function(){var b,d,c,g,f,l,k,m,h,q;return p.__generator(this,function(e){switch(e.label){case 0:b=a.view,d=a.sampleSize,c=a.requiredFields,g=a.returnGeometry,f=a.signal,l=1,k=this.layer.createQuery(),
k.outFields=c,k.returnGeometry=!!g,k.where=null,k.num=d,m=[],e.label=1;case 1:return e.trys.push([1,3,,4]),[4,this._fetchFeaturesFromMemory(b,k,c)];case 2:return m=e.sent(),m.length&&0<d&&d<=m.length?[2,x.pickRandom(m,d,l)]:[3,4];case 3:return e.sent(),n.throwIfAborted(f),[3,4];case 4:h=null;if(!this._featureLayerAdapter)return[3,6];q=p.__assign({},a);delete q.view;return[4,this._featureLayerAdapter.getSampleFeatures(q)];case 5:h=e.sent(),e.label=6;case 6:return h&&h.length?[2,h]:[2,x.pickRandom(m,
m.length,l)]}})})};c.prototype.load=function(a){var b=this,c=this.layer.load(a).then(function(c){var d=c.associatedLayer;b.geometryType=c.geometryType;if(B.isSome(d))return b._featureLayerAdapter=new F({layer:d}),b._featureLayerAdapter.load(a).then(function(){b.objectIdField=b._featureLayerAdapter.objectIdField;b.supportsSQLExpression=b._featureLayerAdapter.supportsSQLExpression;b.minScale=b._featureLayerAdapter.minScale;b.maxScale=b._featureLayerAdapter.maxScale;b.fullExtent=b._featureLayerAdapter.fullExtent});
b.objectIdField=c.objectIdField;b.supportsSQLExpression=!1;b.hasQueryEngine=!1;b.fullExtent=c.fullExtent});this.addResolvingPromise(c);return n.resolve(this)};p.__decorate([y.property({constructOnly:!0})],c.prototype,"layer",void 0);return c=p.__decorate([y.subclass("esri.smartMapping.support.adapters.SceneLayerAdapter")],c)}(G)});