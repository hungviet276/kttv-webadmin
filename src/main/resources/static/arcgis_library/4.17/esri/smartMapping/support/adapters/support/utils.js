// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.17/esri/copyright.txt for details.
//>>built
define("require exports tslib ../../../../core/promiseUtils ../../../../renderers/support/heatmapUtils ../../utils ../../../../support/arcadeOnDemand ../../../../tasks/support/ClassBreaksDefinition ../../../../tasks/support/generateRendererUtils".split(" "),function(W,d,p,F,G,w,N,O,P){function H(a,b,c){b=null==b?-Infinity:b;c=null==c?Infinity:c;return a.filter(function(a){return null!=a&&q(a)&&a>=b&&a<=c})}function v(a,b){return p.__awaiter(this,void 0,void 0,function(){var c,e,f,g,m,h,l,k,d,r,Q;
return p.__generator(this,function(n){switch(n.label){case 0:return c=a.field,e="function"===typeof c,f=a.valueExpression,g=a.normalizationType,m=a.normalizationField,h=a.normalizationTotal,l=[],k=a.view,r=d=null,f?u?[3,2]:[4,N.loadArcade()]:[3,3];case 1:u=Q=n.sent().arcadeUtils,n.label=2;case 2:d=u.createFunction(f),r=k&&u.getViewInfo({viewingMode:"2d"===k.type?"map":k.viewingMode,scale:k.scale,spatialReference:k.spatialReference}),n.label=3;case 3:if(!b)return[2,l];b.forEach(function(a){var b=a.attributes,
k;f?(k=u.createExecContext(a,r),k=u.executeFunction(d,k)):e?k=c.call(null,a):b&&(k=b[c]);g&&null!=k&&q(k)&&(b=b&&parseFloat(b[m]),"log"===g&&0!==k?k=Math.log(k)*Math.LOG10E:"percent-of-total"===g&&q(h)&&0!==h?k=k/h*100:"field"===g&&q(b)&&0!==b&&(k/=b));l.push(k)});return[2,l]}})})}function R(a,b){for(var c=Number.POSITIVE_INFINITY,e=Number.NEGATIVE_INFINITY,f=null,g=null,d=null,h=null,l=0;l<a.length;l++)var k=a[l],f=f+k,c=Math.min(c,k),e=Math.max(e,k);if(l=a.length){g=f/l;for(h=d=0;h<a.length;h++)k=
a[h],d+=Math.pow(k-g,2);h=b?1<l?d/(l-1):0:0<l?d/l:0;d=Math.sqrt(h)}else e=c=null;return{avg:g,count:l,max:e,min:c,stddev:d,sum:f,variance:h}}function I(a){var b=a.field,c=a.classificationMethod||"equal-interval",e=a.normalizationType,f=a.normalizationField,g=new O;g.classificationField=b;g.breakCount=a.breakCount;g.classificationMethod=c;g.standardDeviationInterval="standard-deviation"===c?a.standardDeviationInterval||1:void 0;g.normalizationType=e;g.normalizationField="field"===e?f:void 0;return g}
function J(a,b){var c=b.classBreaks,e=c[0].minValue,f=c[c.length-1].maxValue,g="standard-deviation"===a.classificationMethod,d=S,c=c.map(function(a){var b=a.label;a={minValue:a.minValue,maxValue:a.maxValue,label:b};if(g&&b){var c=b.match(d).map(function(a){return+a.trim()});2===c.length?(a.minStdDev=c[0],a.maxStdDev=c[1],0>c[0]&&0<c[1]&&(a.hasAvg=!0)):1===c.length&&(-1<b.indexOf("\x3c")?(a.minStdDev=null,a.maxStdDev=c[0]):-1<b.indexOf("\x3e")&&(a.minStdDev=c[0],a.maxStdDev=null))}return a});return{minValue:e,
maxValue:f,classBreakInfos:c,normalizationTotal:b.normalizationTotal}}function y(a,b,c){b=(b-a)/c;for(var e=[],f,g=1;g<=c;g++)f=a+b,f=Number(f.toFixed(16)),e.push([a,f]),a=f;return e}function K(a){var b=a.field,c=a.normalizationType,e=a.normalizationField,f=a.normalizationTotal;a=w.isIntegerField(a.layer,b);var g=b;"percent-of-total"===c?g="(("+(a?w.castIntegerFieldToFloat(b):b)+" / "+f+") * 100)":"log"===c?g="(log("+b+") * "+T+")":"field"===c&&(g="("+(a?w.castIntegerFieldToFloat(b):b)+" / "+e+")");
return g}function U(a,b){for(var c=-1,e=a.length-1;0<=e;e--)if(b>=a[e][0]){c=e;break}return c}function L(a,b){var c;b=b.toLowerCase();if(a)for(var e in a)if(e.toLowerCase()!==b){c=a[e];break}return c}function D(a,b){var c;b=b.toLowerCase();if(a)for(var e in a)if(e.toLowerCase()===b){c=a[e];break}return c}function E(a,b){if(b)for(var c in a)a[c].label=b[c];return{count:a}}function M(a,b,c){var e=a.count;a=[];c&&b&&"coded-value"===b.type&&b.codedValues.forEach(function(a){a=a.code;e.hasOwnProperty(a)||
(e[a]={data:a,count:0})});for(var f in e)b=e[f],a.push({value:b.data,count:b.count,label:b.label});return{uniqueValueInfos:a}}function q(a){return"number"===typeof a&&!isNaN(a)&&Infinity!==a&&-Infinity!==a}Object.defineProperty(d,"__esModule",{value:!0});d.isValidNumber=d.msSinceUnixEpochSQL=d.calculateUniqueValuesFromMemory=d.createUVResult=d.getUniqueValuesFromFeatureSet=d.getHistogramFromFeatureSet=d.calculateHistogramFromMemory=d.getFieldExpr=d.generateBinParams=d.getEqualIntervalBins=d.resolveCBResult=
d.calculateClassBreaksFromMemory=d.calculateHeatmapStats=d.createCBDefn=d.processSummaryStatisticsResult=d.getDataValues=d.calculateStatsFromMemory=d.getSummaryStatisticsFromFeatureSet=d.getMissingFields=d.statisticTypes=void 0;var V=/_value$/i,S=/\s*(\+|-)?((\d+(\.\d+)?)|(\.\d+))\s*/gi,T=Math.LOG10E;d.statisticTypes="min max avg stddev count sum variance".split(" ");var u=null;d.getMissingFields=function(a,b,c){return p.__awaiter(this,void 0,void 0,function(){var e,f,g,d,h;return p.__generator(this,
function(l){e=[];if(b)for(f=0,g=b;f<g.length;f++)d=g[f],h=a.getField(d),"availableFields"in c&&-1===c.availableFields.indexOf(h.name)&&e.push(h.name);return[2,e]})})};d.getSummaryStatisticsFromFeatureSet=function(a,b){a=(a=a&&a.features)&&a[0]&&a[0].attributes;var c={},e;for(e in a)c[e.replace(V,"").toLowerCase()]=a[e];c.min===c.max&&null!=c.min&&null==c.stddev&&(c.stddev=c.variance=0);b&&("min max avg stddev sum variance".split(" ").forEach(function(a){null!=c[a]&&(c[a]=Math.ceil(c[a]))}),c.min===
c.max&&null!=c.min&&(c.avg=c.min,c.stddev=c.variance=0));return c};d.calculateStatsFromMemory=function(a,b,c){return p.__awaiter(this,void 0,void 0,function(){var e,f;return p.__generator(this,function(d){switch(d.label){case 0:return[4,v(a,b)];case 1:return e=d.sent(),e=H(e,a.minValue,a.maxValue),f=R(e,!a.normalizationType),c&&["avg","stddev","variance"].forEach(function(a){null!=f[a]&&(f[a]=Math.ceil(f[a]))}),[2,f]}})})};d.getDataValues=v;d.processSummaryStatisticsResult=function(a){for(var b in a)-1<
d.statisticTypes.indexOf(b)&&(q(a[b])||(a[b]=null));return a};d.createCBDefn=I;d.calculateHeatmapStats=function(a,b,c,e,d,g){void 0===b&&(b=10);var f=new Float64Array(d*g),h=G.createKernel(b);b=Math.round(3*b);var l=Number.POSITIVE_INFINITY,k=Number.NEGATIVE_INFINITY,n=0,r=0,p=0,t=0;c=G.createValueFunction(e,c);for(e=0;e<a.length;e++)for(var A=a[e],x=A.geometry,q=x.x-b,u=x.y-b,v=Math.max(0,q),n=Math.max(0,u),w=Math.min(g,x.y+b),x=Math.min(d,x.x+b),A=+c(A.attributes),B=n;B<w;B++)for(var y=h[B-u],C=
v;C<x;C++){var n=B*d+C,z=f[n],n=f[n]+=y*h[C-q]*A,z=n-z,r=r+z,p=p+z*z;n<l&&(l=n);n>k&&(k=n);t++}return t?{mean:r/t,stdDev:Math.sqrt((p-r*r/t)/t),min:l,max:k,mid:(k-l)/2,count:t}:{mean:0,stddev:0,min:0,max:0,mid:0,count:0}};d.calculateClassBreaksFromMemory=function(a,b){return p.__awaiter(this,void 0,void 0,function(){var c,e,d,g;return p.__generator(this,function(f){switch(f.label){case 0:return c=a.normalizationTotal,e=I({field:a.field,normalizationType:a.normalizationType,normalizationField:a.normalizationField,
classificationMethod:a.classificationMethod,standardDeviationInterval:a.standardDeviationInterval,breakCount:a.numClasses||5}),[4,v(a,b)];case 1:return d=f.sent(),d=H(d,a.minValue,a.maxValue),g=P.createGenerateRendererClassBreaks({definition:e,values:d,normalizationTotal:c}),[2,J(a,g)]}})})};d.resolveCBResult=J;d.getEqualIntervalBins=y;d.generateBinParams=function(a){var b=[],c=a.classBreaks,e=c[0].minValue,d=c[c.length-1].maxValue;c.forEach(function(a){b.push([a.minValue,a.maxValue])});return{min:e,
max:d,intervals:b,sqlExpr:K({field:a.field,normalizationType:a.normalizationType,normalizationField:a.normalizationField,normalizationTotal:a.normalizationTotal,layer:a.layer}),excludeZerosExpr:a.where,normTotal:a.normalizationTotal}};d.getFieldExpr=K;d.calculateHistogramFromMemory=function(a,b,c){return p.__awaiter(this,void 0,void 0,function(){var d,f,g,m,h,l,k,n,r,q,t;return p.__generator(this,function(e){switch(e.label){case 0:return d=b.min,f=b.max,g=b.normTotal,m=a.numBins||10,h=b.intervals||
y(d,f,m),l=h.map(function(a,c){return{minValue:h[c][0],maxValue:h[c][1],count:0}}),[4,v(a,c)];case 1:k=e.sent();n=0;for(r=k;n<r.length;n++)q=r[n],null!=q&&q>=d&&q<=f&&(t=U(h,q),-1<t&&l[t].count++);return[2,{bins:l,minValue:d,maxValue:f,normalizationTotal:g}]}})})};d.getHistogramFromFeatureSet=function(a,b,c,d,f){var e={};a&&a.features&&a.features.forEach(function(a){var c=a.attributes;a=L(c,"countOFExpr");c=D(c,"countOFExpr");0!==a&&(e[a]=c)});var m=[];y(b,c,d).forEach(function(a,c){c=(c+1).toString();
m.push({minValue:a[0],maxValue:a[1],count:e.hasOwnProperty(c)?e[c]:0})});return{bins:m,minValue:b,maxValue:c,normalizationTotal:f}};d.getUniqueValuesFromFeatureSet=function(a,b,c,d,f){var e="countOF"+(c||"Expr"),m={},h=!1;(a&&a.features).forEach(function(a){var b=a.attributes;a=D(b,e);b=c?D(b,c):L(b,e);null===b&&0===a&&(h=!0);if(null==b||"string"===typeof b&&""===b.trim())b=null;null==m[b]?m[b]={count:a,data:b}:m[b].count+=a});return c&&h?b.queryFeatureCount(c+" is NULL",f).then(function(a){m["null"].count+=
a||0;return E(m,d)}).catch(function(){F.throwIfAborted(f);return E(m,d)}):F.resolve(E(m,d))};d.createUVResult=M;d.calculateUniqueValuesFromMemory=function(a,b,c){return p.__awaiter(this,void 0,void 0,function(){var d,f,g,m,h;return p.__generator(this,function(e){switch(e.label){case 0:return[4,v(a,b)];case 1:d=e.sent();f={};g=0;for(m=d;g<m.length;g++){h=m[g];if(null==h||"string"===typeof h&&""===h.trim())h=null;null==f[h]?f[h]={count:1,data:h}:f[h].count++}return[2,M({count:f},c,a.returnAllCodedValues)]}})})};
d.msSinceUnixEpochSQL=function(a,b){return w.getDateDiffSQL(a,new Date(0),b,"milliseconds").sqlExpression};d.isValidNumber=q});