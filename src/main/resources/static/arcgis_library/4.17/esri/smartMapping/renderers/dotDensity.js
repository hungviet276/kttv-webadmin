// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.17/esri/copyright.txt for details.
//>>built
define("require exports tslib ../../renderers ../../core/Error ../../core/maybe ../../core/promiseUtils ../../geometry/support/scaleUtils ../../renderers/support/AuthoringInfo ../heuristics/outline ./support/dotDensityUtils ./support/utils ../statistics/spatialStatistics ../statistics/summaryStatisticsForAttributes ../statistics/support/attributeDensity ../support/utils ../support/adapters/support/layerUtils ../symbology/dotDensity".split(" "),function(R,y,b,G,t,z,A,C,H,I,u,B,J,K,L,M,D,E){function N(c){return b.__awaiter(this,
void 0,void 0,function(){var a,d,e,g,f;return b.__generator(this,function(h){switch(h.label){case 0:if(!(c&&c.layer&&c.view&&c.attributes&&c.attributes.length))throw new t("dot-density-renderer:missing-parameters","'layer', 'view' and 'attributes' parameters are required");if(8<c.attributes.length)throw new t("dot-density-renderer:invalid-parameters","Dot density renderer does not support more than 8 attributes");a=b.__assign({},c);d=[2,1];e=D.createLayerAdapter(a.layer,d);a.layer=e;a.dotBlendingEnabled=
null==a.dotBlendingEnabled?!0:a.dotBlendingEnabled;a.dotValueOptimizationEnabled=null==a.dotValueOptimizationEnabled?!0:a.dotValueOptimizationEnabled;if(!e)throw new t("dot-density-renderer:invalid-parameters","'layer' must be one of these types: "+D.getLayerTypeLabels(d).join(", "));g=z.isSome(a.signal)?{signal:a.signal}:null;return[4,A.all([a.view.when(),e.load(g)])];case 1:h.sent();f=e.geometryType;if("polygon"!==f)throw new t("dot-density-renderer:not-supported","Dot density renderer is supported for polygon layers only");
return[2,a]}})})}function O(c){return b.__awaiter(this,void 0,void 0,function(){var a,d,e,g,f;return b.__generator(this,function(h){switch(h.label){case 0:return a=c.dotDensityScheme,e=d=null,[4,B.getBasemapInfo(c.basemap,c.view)];case 1:g=h.sent();d=z.isSome(g.basemapId)?g.basemapId:null;e=z.isSome(g.basemapTheme)?g.basemapTheme:null;if(a)return[2,{scheme:E.cloneScheme(a),basemapId:d,basemapTheme:e}];if(f=E.getSchemes({basemap:d,numColors:c.attributes.length,basemapTheme:e}))a=f.primaryScheme,d=
f.basemapId,e=f.basemapTheme;return[2,{scheme:a,basemapId:d,basemapTheme:e}]}})})}function P(c){return b.__awaiter(this,void 0,void 0,function(){var a,d,e,g,f,h,n,p,m,k,l,r,q;return b.__generator(this,function(b){switch(b.label){case 0:return a=c.view,d=c.layer,e=c.attributes,g=c.signal,[4,d.getSampleFeatures({view:a,sampleSize:500,returnGeometry:!0,signal:g})];case 1:return f=b.sent(),[4,A.all([J({features:f,geometryType:d.geometryType}),K({layer:d,attributes:e,includeZeros:!1,includeNegatives:!1,
view:a,signal:g})])];case 2:h=b.sent();n=h[0];p=h[1];m="avgSize"in n&&n.avgSize;k=p.avg;if(!m)throw new t("dot-density-renderer:insufficient-info","Average polygon size is invalid");if(!k)throw new t("dot-density-renderer:insufficient-info","Average attribute value is invalid");l=C.getResolutionForScale(a.scale,a.spatialReference);r=m*m/(l*l)*.1;q=u.roundValue(k/r);return[2,{dotValue:q||1,referenceScale:a.scale,minSliderValue:1,maxSliderValue:u.roundValue(k)}]}})})}function Q(c){return b.__awaiter(this,
void 0,void 0,function(){var a,d,e,g,f,h,n,p,m,k,l,r,q,F,v,w;return b.__generator(this,function(b){switch(b.label){case 0:a=c.view,d=c.layer,e=c.attributes,g=c.signal,f=[],h=0,n=e,b.label=1;case 1:if(!(h<n.length))return[3,4];p=n[h];return[4,M.getFieldsList({field:p.field,valueExpression:p.valueExpression})];case 2:m=b.sent(),f.push.apply(f,m),b.label=3;case 3:return h++,[3,1];case 4:return[4,d.getSampleFeatures({view:a,sampleSize:500,requiredFields:f,returnGeometry:!0,signal:g})];case 5:return k=
b.sent(),[4,L({features:k,attributes:e,includeZeros:!1,includeNegatives:!1,view:a})];case 6:l=b.sent();if(!l.avgDensity||!l.minDensity||!l.maxDensity)throw new t("dot-density-renderer:insufficient-info","Invalid density values");r=C.getResolutionForScale(a.scale,a.spatialReference);q=r*r;F=u.roundValue(l.minDensity*q);v=u.roundValue(l.maxDensity*q);w=u.roundValue(l.avgDensity*q*10)||1;w>v&&(w=v);return[2,{dotValue:w,referenceScale:a.scale,minSliderValue:F,maxSliderValue:v}]}})})}Object.defineProperty(y,
"__esModule",{value:!0});y.createRenderer=void 0;y.createRenderer=function(c){return b.__awaiter(this,void 0,void 0,function(){var a,d,e,g,f,h,n,p,m,k,l,r,q,u,v,w,x;return b.__generator(this,function(b){switch(b.label){case 0:return[4,N(c)];case 1:return a=b.sent(),d=a.layer,e=d.geometryType,[4,O(a)];case 2:f=(g=b.sent())&&g.scheme;if(!f)throw new t("dot-density-renderer:insufficient-info","Unable to find dot-density scheme");h={layer:d,view:a.view,attributes:a.attributes,signal:a.signal};n={layer:a.layer,
view:a.view,signal:a.signal};return[4,A.all([a.trueDensity?Q(h):P(h),a.outlineOptimizationEnabled?I(n):null])];case 3:return p=b.sent(),m=p[0],k=p[1],l=m.dotValue,r=m.referenceScale,q=m.minSliderValue,u=m.maxSliderValue,v=B.createColors(f.colors,a.attributes.length),w=a.attributes.map(function(a,b){return{field:a.field,valueExpression:a.valueExpression,label:a.label,valueExpressionTitle:a.valueExpressionTitle,color:v[b]}}),x=new G.DotDensityRenderer({attributes:w,dotBlendingEnabled:a.dotBlendingEnabled,
outline:k?B.getSymbolOutlineFromScheme(f,e,k.opacity):null,dotValue:l,referenceScale:a.dotValueOptimizationEnabled?r:null,legendOptions:a.legendOptions}),k&&k.visualVariables&&k.visualVariables.length&&(x.visualVariables=k.visualVariables.map(function(a){return a.clone()})),x.authoringInfo=new H({type:"dot-density",minSliderValue:q,maxSliderValue:u}),[2,{renderer:x,dotDensityScheme:f,basemapId:g.basemapId,basemapTheme:g.basemapTheme}]}})})}});