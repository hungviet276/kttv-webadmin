// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.17/esri/copyright.txt for details.
//>>built
define("require exports tslib ../../../geometry ../../../core/Error ../../../core/maybe ../../../core/accessorSupport/decorators ../RasterInfo ../RasterStorageInfo ./BaseRaster ../rasterFormats/TiffDecoder ../rasterFormats/TiffTags".split(" "),function(P,Q,b,E,G,L,k,M,N,O,F,z){var D=function(b,c){return(b=b.get(c))&&b.values},x=function(b,c){return(b=b.get(c))&&b.values[0]};return function(A){function c(){var e=null!==A&&A.apply(this,arguments)||this;e._files=null;e._headerInfo=null;e._bufferSize=
1048576;e.datasetFormat="TIFF";return e}b.__extends(c,A);c.prototype.open=function(e){return b.__awaiter(this,void 0,void 0,function(){var t,l,d,m,h,f,a,g,B,c,H,I,u,p,q,r,v,y,J,C,w,k,z,x,A,D,K;return b.__generator(this,function(n){switch(n.label){case 0:return[4,this.init()];case 1:return n.sent(),t=e?L.unwrap(e.signal):null,[4,this.request(this.url,{range:{from:0,to:this._bufferSize},responseType:"array-buffer",signal:t})];case 2:l=n.sent().data;if(!l)throw new G("tiffraster:open","failed to open url "+
this.url);this.datasetName=this.url.slice(this.url.lastIndexOf("/")+1);d=F.parseSignature(l);m=d.littleEndian;h=d.firstIFD;f=[];return[4,this.readIFDs(f,l,m,h,0,4,t)];case 3:n.sent();a=F.getImageInfo(f);g=a.width;B=a.height;c=a.tileWidth;H=a.tileHeight;I=a.planes;u=a.pixelType;p=a.compression;q=a.firstPyramidLevel;r=a.maximumPyramidLevel;v=a.pyramidBlockWidth;y=a.pyramidBlockHeight;J=a.tileBoundary;C=a.metadata;w=E.Extent.fromJSON(a.extent);k=w.spatialReference;z=w?new E.Point({x:w.xmin,y:w.ymax,
spatialReference:k}):new E.Point({x:0,y:0});x=new N({blockWidth:c,blockHeight:H,pyramidBlockWidth:v,pyramidBlockHeight:y,compression:p,origin:z,firstPyramidLevel:q,maximumPyramidLevel:r,blockBoundary:J});A=new E.Point({x:(w.xmax-w.xmin)/g,y:(w.ymax-w.ymin)/B,spatialReference:k});D=C?{BandProperties:C.bandProperties,DataType:C.dataType}:{};K=new M({width:g,height:B,bandCount:I,pixelType:u,compression:p,pixelSize:A,storageInfo:x,spatialReference:k,keyProperties:D,extent:w,statistics:C?C.statistics:
null});this._set("rasterInfo",K);this._headerInfo=b.__assign({littleEndian:m,ifds:f},a);if(!this._headerInfo.isSupported)throw new G("tiffraster:open","this tiff is not supported: "+this._headerInfo.message);this.updateTileInfo();return[2]}})})};c.prototype.fetchRawTile=function(e,t,c,d){void 0===d&&(d={});return b.__awaiter(this,void 0,void 0,function(){var m,h,f,a,g,B,n,l,k,u,p,q,r,v,y;return b.__generator(this,function(b){switch(b.label){case 0:if(!this._headerInfo&&this._headerInfo.isSupported)return[2,
null];m=this.rasterInfo.storageInfo.blockBoundary;h=0<e?this.rasterInfo.storageInfo.pyramidBlockWidth:this.rasterInfo.storageInfo.blockWidth;f=0<e?this.rasterInfo.storageInfo.pyramidBlockHeight:this.rasterInfo.storageInfo.blockHeight;a=m[e];if(!a||a.maxRow<t||a.maxCol<c||a.minRow>t||a.minCol>c)return[2,null];g=this.getTileLocation(e,t,c);if(!g)return[2,null];B=g.range;n=g.actualTileWidth;l=g.actualTileHeight;k=g.ifd;return[4,this.request(this.url,{range:B,responseType:"array-buffer",signal:d.signal})];
case 1:return u=b.sent().data,[4,this.decodePixelBlock(u,{format:"tiff",customOptions:{headerInfo:this._headerInfo,ifd:k,offset:0,size:0},width:h,height:f,planes:null,pixelType:null})];case 2:p=b.sent();if(n!==h||l!==f)if(y=p.mask)for(q=0;q<f;q++)for(v=q*h,r=q<l?n:0;r<h;r++)y[v+r]=0;else for(y=new Uint8Array(h*f),p.mask=y,q=0;q<l;q++)for(v=q*h,r=0;r<n;r++)y[v+r]=1;return[2,p]}})})};c.prototype.readIFDs=function(e,c,l,d,m,h,f){void 0===h&&(h=4);return b.__awaiter(this,void 0,void 0,function(){var a,
g;return b.__generator(this,function(b){switch(b.label){case 0:return d?d>=c.byteLength||0>d?[4,this.request(this.url,{range:{from:d+m,to:d+m+this._bufferSize},responseType:"array-buffer",signal:f})]:[3,2]:[2,null];case 1:a=b.sent(),c=a.data,m=d+m,d=0,b.label=2;case 2:return[4,this.readIFD(c,l,d,m,z.TIFF_TAGS,h,f)];case 3:return g=b.sent(),e.push(g.ifd),g.nextIFD?[4,this.readIFDs(e,c,l,g.nextIFD-m,m,h,f)]:[2,null];case 4:return b.sent(),[2]}})})};c.prototype.readIFD=function(e,c,l,d,m,h,f){void 0===
m&&(m=z.TIFF_TAGS);void 0===h&&(h=4);return b.__awaiter(this,void 0,void 0,function(){var a,g,k,n,t,x,u,p,q,r,v;return b.__generator(this,function(b){switch(b.label){case 0:if(!e)return[2,null];a=F.parseIFD(e,c,l,d,m,h);if(!a.success)return[3,5];g=[];a.ifd.forEach(function(a){a.values||g.push(a)});if(!(0<g.length))return[3,2];k=g.map(function(a){return a.offlineOffsetSize});n=Math.min.apply(null,k.map(function(a){return a[0]}));t=Math.min.apply(null,k.map(function(a){return a[0]+a[1]}));return t-
n<=this._bufferSize?[4,this.request(this.url,{range:{from:n,to:n+this._bufferSize},responseType:"array-buffer",signal:f})]:[3,2];case 1:e=x=b.sent().data,d=n,g.forEach(function(a){return F.parseFieldValues(e,c,a,d)}),b.label=2;case 2:if(!a.ifd.has("GEOKEYDIRECTORY"))return[3,4];u=a.ifd.get("GEOKEYDIRECTORY");p=u.values;if(!(p&&4<p.length))return[3,4];q=p[0]+"."+p[1]+"."+p[2];return[4,this.readIFD(e,c,u.valueOffset+6-d,d,z.GEO_KEYS,2,f)];case 3:r=b.sent(),u.data=r.ifd,u.data&&u.data.set("GEOTIFFVersion",
{id:0,type:2,valueCount:1,valueOffset:null,values:[q]}),b.label=4;case 4:return[2,a];case 5:return a.requiredBufferSize&&a.requiredBufferSize!==e.byteLength?[4,this.request(this.url,{range:{from:d,to:d+a.requiredBufferSize+4},responseType:"array-buffer",signal:f})]:[3,7];case 6:return v=b.sent(),e=v.data,e.byteLength<a.requiredBufferSize?[2,null]:[2,this.readIFD(e,c,0,d,z.TIFF_TAGS,4,f)];case 7:return[2]}})})};c.prototype.getTileLocation=function(b,c,l){var d=this.rasterInfo.storageInfo,e=d.firstPyramidLevel,
h=d.blockBoundary,f=0===b?0:b-(e-1);b=this._headerInfo.ifds[f];if(!b)return null;d=D(b,"TILEOFFSETS");if(void 0===d)return null;var e=D(b,"TILEBYTECOUNTS"),f=h[f],a=f.minRow,g=f.minCol,h=f.maxRow,f=f.maxCol;if(c>h||l>f||c<a||l<g)return null;var a=x(b,"IMAGEWIDTH"),g=x(b,"IMAGELENGTH"),k=x(b,"TILEWIDTH"),n=x(b,"TILELENGTH"),t=c*(f+1)+l,d=d[t],e=e[t];return null==d||null==e?null:{range:{from:d,to:d+e-1},ifd:b,actualTileWidth:l===f?a%k:k,actualTileHeight:c===h?g%n:n}};b.__decorate([k.property()],c.prototype,
"_files",void 0);b.__decorate([k.property()],c.prototype,"_headerInfo",void 0);b.__decorate([k.property()],c.prototype,"_bufferSize",void 0);b.__decorate([k.property({type:String,json:{write:!0}})],c.prototype,"datasetFormat",void 0);return c=b.__decorate([k.subclass("esri.layers.support.rasterDatasets.TIFFRaster")],c)}(O)});