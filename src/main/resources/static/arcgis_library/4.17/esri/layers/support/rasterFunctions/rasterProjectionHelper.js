// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.17/esri/copyright.txt for details.
//>>built
define("require exports tslib ../../../geometry ../../../core/Error ../../../core/unitUtils ../../../geometry/projection ../../../geometry/support/spatialReferenceUtils ../../../geometry/support/webMercatorUtils".split(" "),function(L,l,I,r,C,w,u,y,x){function H(a,b,c,d){void 0===d&&(d=null);if(a.spatialReference.equals(b))return a;var e=D(a.spatialReference,b);if(e&&!u.isLoaded())throw new C("rasterprojectionhelper-projectResolution","projection engine is not loaded");c=c.center;a=new r.Extent({xmin:c.x-
a.x/2,xmax:c.x+a.x/2,ymin:c.y-a.y/2,ymax:c.y+a.y/2,spatialReference:a.spatialReference});b=e?u.project(a,b,d):x.project(a,b);return null==b?null:{x:b.xmax-b.xmin,y:b.ymax-b.ymin}}function J(a,b){void 0===b&&(b=.01);return w.getMetersPerUnitForSR(a)?b/w.getMetersPerUnitForSR(a):0}function E(a,b,c,d){var e,h;void 0===c&&(c=null);void 0===d&&(d=!0);var g=a.spatialReference;if(g.equals(b))return a;var m=D(g,b);if(m&&!u.isLoaded())throw new C("rasterprojectionhelper-projectResolution","projection engine is not loaded");
(c=m?u.project(a,b,c):x.project(a,b))&&d&&b.isGeographic&&(b=g.isWebMercator?y.getInfo(g).origin:null!==(h=null===(e=y.getInfo(g))||void 0===e?void 0:e.valid)&&void 0!==h?h:[],e=b[0],h=b[1],(g=J(g))&&null!=e&&null!=h&&(Math.abs(a.x-e)<g&&5E-4>Math.abs(180-c.x)?c.x-=360:Math.abs(a.x-h)<g&&5E-4>Math.abs(180+c.x)&&(c.x+=360)));return c}function K(a,b,c,d){var e,h,g,m;void 0===c&&(c=null);void 0===d&&(d=!0);var k=a.spatialReference;if(k.equals(b))return a;var f=D(k,b);if(f&&!u.isLoaded())throw new C("rasterprojectionhelper-projectExtent",
"projection engine is not loaded");var f=f?u.project(a,b,c):x.project(a,b),l=null!==(h=null===(e=y.getInfo(k))||void 0===e?void 0:e.origin)&&void 0!==h?h:[];e=l[0];h=l[1];f&&d&&k.isWebMercator&&b.isGeographic&&null!=e&&null!=h&&(.001>Math.abs(a.xmin-e)&&1E3<Math.abs(h-a.xmax)&&5E-4>Math.abs(180-f.xmax)&&(f.xmin=-180,d=[],d.push(new r.Point(a.xmax,a.ymin,k)),d.push(new r.Point(a.xmax,(a.ymin+a.ymax)/2,k)),d.push(new r.Point(a.xmax,a.ymax,k)),d=d.map(function(a){return E(a,b,c)}).filter(function(a){return!isNaN(null===
a||void 0===a?void 0:a.x)}).map(function(a){return a.x}),f.xmax=Math.max.apply(null,d)),.001>Math.abs(a.xmax-h)&&1E3<Math.abs(e-a.xmin)&&5E-4>Math.abs(180+f.xmin)&&(f.xmax=180,d=[],d.push(new r.Point(a.xmin,a.ymin,k)),d.push(new r.Point(a.xmin,(a.ymin+a.ymax)/2,k)),d.push(new r.Point(a.xmin,a.ymax,k)),d=d.map(function(a){return E(a,b,c)}).filter(function(a){return!isNaN(null===a||void 0===a?void 0:a.x)}).map(function(a){return a.x}),f.xmin=Math.min.apply(null,d)));a=b.isWebMercator?y.getInfo(b).origin:
null!==(m=null===(g=y.getInfo(b))||void 0===g?void 0:g.valid)&&void 0!==m?m:[];e=a[0];h=a[1];(g=J(b))&&null!=e&&null!=h&&(Math.abs(f.xmin-e)<g&&(f.xmin=e),Math.abs(f.xmax-h)<g&&(f.xmax=h));return f}Object.defineProperty(l,"__esModule",{value:!0});l.computeProjectedScales=l.snapPyramid=l.getProjectionOffsetGrid=l.projectExtent=l.projectPoint=l.projectResolution=l.load=l.defaultGridSpacing=void 0;var D=function(a,b){var c=(a.isWGS84||a.isWebMercator)&&(b.isWGS84||b.isWebMercator);return!(a.equals(b)||
c)};l.defaultGridSpacing=32;l.load=function(){return I.__awaiter(this,void 0,void 0,function(){return I.__generator(this,function(a){switch(a.label){case 0:return u.isLoaded()||!u.isSupported()?[2,null]:[4,u.load()];case 1:return a.sent(),[2]}})})};l.projectResolution=H;l.projectPoint=E;l.projectExtent=K;l.getProjectionOffsetGrid=function(a,b,c,d,e,h){var g,m;void 0===d&&(d=null);void 0===e&&(e=!1);void 0===h&&(h=[l.defaultGridSpacing,l.defaultGridSpacing]);if(D(a.spatialReference,b.spatialReference)&&
!u.isLoaded())throw new C("rasterprojectionhelper-projectResolution","projection engine is not loaded");if(!(a&&b&&c))return null;var k=a.xmin,f=a.ymin,v=a.xmax,A=a.ymax,F=a.spatialReference,w=b.spatialReference;a=null!==(m=null===(g=y.getInfo(F))||void 0===g?void 0:g.valid)&&void 0!==m?m:[];var G=a[0],x=a[1],B=h[0]*c.x,q=h[1]*c.y,v=Math.ceil((v-k)/B-.1)+1,f=Math.ceil((A-f)/q-.1)+1,p;c=[];var z;g=!1;for(m=0;m<v;m++){var n=[];for(a=0;a<f;a++)p=new r.Point({x:k+B*m,y:A-q*a,spatialReference:F}),p=E(p,
w,d),n.push(p),0<m&&e&&p&&z[a]&&null!=G&&p.x<z[a].x&&(p.x+=x-G),p?(c.push((p.x-b.xmin)/(b.xmax-b.xmin)),c.push((b.ymax-p.y)/(b.ymax-b.ymin))):(c.push(NaN),c.push(NaN),g=!0);z=n}b=[Math.abs((c[0]+c[4]+c[4*v]+c[4*v+4])/4-c[2*f+2]),Math.abs((c[1]+c[5]+c[4*f+1]+c[4*f+5])/4-c[2*f+3])];d=new Float32Array((v-1)*(f-1)*12);e=new Float32Array([-0,-1,1,-1,1,-0,1,-0,-0]);k=new Float32Array([-1,1,0,0,-1,1,1,0,0]);for(m=0;m<v-1;m++){for(a=0;a<f-1;a++){q=m*f*2+2*a;A=c[q];z=c[q+1];F=c[q+2];w=c[q+3];q+=2*f;G=c[q];
x=c[q+1];B=c[q+2];q=c[q+3];n=0;p=12*(a*(v-1)+m);for(var t=0;3>t;t++)d[p++]=e[n++]*A+e[n++]*F+e[n++]*B;for(t=n=0;3>t;t++)d[p++]=e[n++]*z+e[n++]*w+e[n++]*q;for(t=n=0;3>t;t++)d[p++]=k[n++]*A+k[n++]*G+k[n++]*B;for(t=n=0;3>t;t++)d[p++]=k[n++]*z+k[n++]*x+k[n++]*q}if(g)for(a=0;a<d.length;a++)isNaN(d[a])&&(d[a]=-1)}return{offsets:c,error:b,coefficients:d,spacing:h,size:[v-1,f-1]}};l.snapPyramid=function(a,b,c){var d=Math.log(a.x/b.pixelSize.x)/Math.LN2,e=Math.log(a.y/b.pixelSize.y)/Math.LN2;a=b.storageInfo.maximumPyramidLevel||
0;c="down"===c?Math.floor(Math.min(d,e)):"up"===c?Math.ceil(Math.max(d,e)):Math.round((d+e)/2);d=!1;0>c?c=0:c>a&&(d=c>a+3,c=a);a=Math.pow(2,c);b=new r.Point({x:a*b.pixelSize.x,y:a*b.pixelSize.y,spatialReference:b.spatialReference});return{pyramidLevel:c,pyramidResolution:b,excessiveReading:d}};l.computeProjectedScales=function(a,b,c,d){void 0===c&&(c=512);void 0===d&&(d=!0);var e=a.extent,h=a.spatialReference,g=a.pixelSize,m=H(new r.Point({x:g.x,y:g.y,spatialReference:h}),b,e);if(null==m)return{projectedPixelSize:null,
scales:null,srcResolutions:null};var k=(m.x+m.y)/2,f=w.getMetersPerUnitForSR(b),k=k*f*96*39.37;c=b.isGeographic?512/c*2.958287637958547E8:512/c*5.91657527591555E8;var l=!1;d&&(b.isGeographic||b.isWebMercator)&&(d=K(e,b),l=0>d.xmin*d.xmax);d=k;if(l)d=c,a=d/(96*f*39.37),b=H(new r.Point({x:a,y:a,spatialReference:b}),h,e);else{b={x:g.x,y:g.y};a=Math.ceil(Math.log(Math.min(a.width,a.height)/32)/Math.LN2);for(e=0;d<.5005*c&&e<a;)e++,d*=2,b.x*=2,b.y*=2;1.001>=Math.max(d,c)/Math.min(d,c)&&(d=c)}a=[];e=[];
for(k=Math.min(70.5310735,k)/1.001;d>=k;)a.push(d),e.push({x:b.x,y:b.y}),d/=2,b.x/=2,b.y/=2;return{projectedPixelSize:m,scales:a,srcResolutions:e}}});