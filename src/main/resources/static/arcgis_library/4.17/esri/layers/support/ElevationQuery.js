// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.17/esri/copyright.txt for details.
//>>built
define("require exports tslib ../../core/arrayUtils ../../core/asyncUtils ../../core/Error ../../core/promiseUtils ../../core/unitUtils ../../geometry/Multipoint ../../geometry/Point ../../geometry/Polyline ../../geometry/support/aaBoundingRect ../../geometry/support/webMercatorUtils ./ElevationSampler ./ElevationTile".split(" "),function(u,p,g,C,D,n,m,w,x,y,E,t,q,z,A){function v(f,a){var b=f.lods.length-1;0<a&&(f=C.findIndex(f.lods,function(b){return b.resolution<a}),0===f?b=0:0<f&&(b=f-1));return b}
Object.defineProperty(p,"__esModule",{value:!0});p.getFinestLodIndex=p.GeometryDescriptor=p.ElevationQuery=void 0;u=function(){function f(){}f.prototype.queryAll=function(a,b,c){return g.__awaiter(this,void 0,void 0,function(){var d,e,k,h,l;return g.__generator(this,function(f){switch(f.label){case 0:a=c&&c.ignoreInvisibleLayers?a.filter(function(a){return a.visible}):a.slice();if(!a.length)return[2,m.reject(new n("elevation-query:invalid-layer","Elevation queries require at least one elevation layer to fetch tiles from"))];
d=r.fromGeometry(b);e=!1;c&&c.returnSampleInfo||(e=!0);k=g.__assign(g.__assign({noDataValue:0,maximumAutoTileRequests:20},c),{returnSampleInfo:!0,demResolution:"auto"});return[4,this.query(a[a.length-1],d,k)];case 1:return h=f.sent(),[4,this._queryAllContinue(a,h,k)];case 2:return l=f.sent(),l.geometry=l.geometry.export(),e&&delete l.sampleInfo,[2,l]}})})};f.prototype.query=function(a,b,c){return g.__awaiter(this,void 0,void 0,function(){var d;return g.__generator(this,function(e){switch(e.label){case 0:if(!a)return[2,
m.reject(new n("elevation-query:invalid-layer","Elevation queries require an elevation layer to fetch tiles from"))];if(!b||!(b instanceof r)&&"point"!==b.type&&"multipoint"!==b.type&&"polyline"!==b.type)return[2,m.reject(new n("elevation-query:invalid-geometry","Only point, polyline and multipoint geometries can be used to query elevation"))];c=g.__assign({noDataValue:0,demResolution:"auto",minDemResolution:0,maximumAutoTileRequests:20,returnSampleInfo:!1},c);d=new F(a,b.spatialReference,c);return[4,
a.load(c)];case 1:return e.sent(),this._createGeometryDescriptor(d,b),[4,this._selectTiles(d)];case 2:return e.sent(),[4,this._populateElevationTiles(d)];case 3:return e.sent(),this._sampleGeometryWithElevation(d),[2,this._createQueryResult(d)]}})})};f.prototype.createSampler=function(a,b,c){return g.__awaiter(this,void 0,void 0,function(){return g.__generator(this,function(d){if(!a)return[2,m.reject(new n("elevation-query:invalid-layer","Elevation queries require an elevation layer to fetch tiles from"))];
if(!b||"extent"!==b.type)return[2,m.reject(new n("elevation-query:invalid-extent","Invalid or undefined extent"))];c=g.__assign({noDataValue:0,demResolution:"auto",maximumAutoTileRequests:20,returnSampleInfo:!1},c);return[2,this._createSampler(a,b,c)]})})};f.prototype.createSamplerAll=function(a,b,c){return g.__awaiter(this,void 0,void 0,function(){var d,e;return g.__generator(this,function(k){switch(k.label){case 0:a=c&&c.ignoreInvisibleLayers?a.filter(function(a){return a.visible}):a.slice();if(!a.length)return[2,
m.reject(new n("elevation-query:invalid-layer","Elevation queries require at least one elevation layer to fetch tiles from"))];if(!b||"extent"!==b.type)return[2,m.reject(new n("elevation-query:invalid-extent","Invalid or undefined extent"))];d=g.__assign(g.__assign({noDataValue:0,maximumAutoTileRequests:20},c),{returnSampleInfo:!0,demResolution:"auto"});return[4,this._createSampler(a[a.length-1],b,d)];case 1:return e=k.sent(),[2,this._createSamplerAllContinue(a,b,e,d)]}})})};f.prototype._createSampler=
function(a,b,c,d){return g.__awaiter(this,void 0,void 0,function(){var e,k,h;return g.__generator(this,function(l){switch(l.label){case 0:return[4,a.load()];case 1:l.sent();e=b.spatialReference;k=a.tileInfo.spatialReference;if(!e.equals(k)){if(!q.canProject(e,k))return[2,m.reject(new n("elevation-query:invalid-extent","Extent spatial reference ("+e.wkid+") must be compatible with tile spatial reference ("+k.wkid+")"))];b=q.project(b,k)}h=new G(a,b,c,d);return[4,this._selectTiles(h)];case 2:return l.sent(),
[4,this._populateElevationTiles(h)];case 3:return l.sent(),[2,new z.MultiTileElevationSampler(h.elevationTiles,h.layer.tileInfo,h.options.noDataValue)]}})})};f.prototype._createSamplerAllContinue=function(a,b,c,d){return g.__awaiter(this,void 0,void 0,function(){var e,k,h,l;return g.__generator(this,function(f){switch(f.label){case 0:a.pop();if(!a.length)return[2,c];e=c.samplers.map(function(a){return t.fromExtent(a.extent)});return[4,this._createSampler(a[a.length-1],b,d,e)];case 1:k=f.sent();if(0===
k.samplers.length)return[2,c];h=c.samplers.concat(k.samplers);l=new z.MultiTileElevationSampler(h,d.noDataValue);return[2,this._createSamplerAllContinue(a,b,l,d)]}})})};f.prototype._queryAllContinue=function(a,b,c){return g.__awaiter(this,void 0,void 0,function(){var d,e,k,h,l,f,m;return g.__generator(this,function(g){switch(g.label){case 0:d=a.pop();b.geometry.coordinates.forEach(function(a,c){0<=b.sampleInfo[c].demResolution&&!b.sampleInfo[c].source&&(b.sampleInfo[c].source=d)});if(!a.length)return[2,
b];e=b.geometry.coordinates;k=[];h=[];for(l=0;l<e.length;l++)0>b.sampleInfo[l].demResolution&&(k.push(e[l]),h.push(l));if(0===k.length)return[2,b];f=b.geometry.clone(k);return[4,this.query(a[a.length-1],f,c)];case 1:return m=g.sent(),h.forEach(function(a,c){e[a].z=m.geometry.coordinates[c].z;b.sampleInfo[a].demResolution=m.sampleInfo[c].demResolution}),[2,this._queryAllContinue(a,b,c)]}})})};f.prototype._createQueryResult=function(a){var b={geometry:(a.outSpatialReference.equals(a.geometry.spatialReference)?
a.geometry:a.geometry.project(a.outSpatialReference)).export(),noDataValue:a.options.noDataValue};a.options.returnSampleInfo&&(b.sampleInfo=this._extractSampleInfo(a));a.geometry.coordinates.forEach(function(a){a.tile=null;a.elevationTile=null});return b};f.prototype._createGeometryDescriptor=function(a,b){var c,d=a.layer.tileInfo.spatialReference;c=b instanceof r?b.project(d):q.project(b,d);if(!c)throw new n("elevation-query:spatial-reference-mismatch","Cannot query elevation in '"+b.spatialReference.wkid+
"' on an elevation service in '"+d.wkid+"'");a.geometry=r.fromGeometry(c)};f.prototype._selectTiles=function(a){return g.__awaiter(this,void 0,void 0,function(){var b;return g.__generator(this,function(c){switch(c.label){case 0:b=a.options.demResolution;"geometry"===a.type&&this._preselectOutsideLayerExtent(a);if("number"!==typeof b)return[3,1];this._selectTilesClosestResolution(a);return[3,6];case 1:return"finest-contiguous"!==b?[3,3]:[4,this._selectTilesFinestContiguous(a)];case 2:return c.sent(),
[3,6];case 3:return"auto"!==b?[3,5]:[4,this._selectTilesAuto(a)];case 4:return c.sent(),[3,6];case 5:throw new n("elevation-query:invalid-dem-resolution","Invalid dem resolution value '"+b+'\', expected a number, "finest-contiguous" or "auto"');case 6:return[2]}})})};f.prototype._preselectOutsideLayerExtent=function(a){var b=new A.ElevationTile(null);b.sample=function(){return a.options.noDataValue};a.outsideExtentTile=b;var c=a.layer.fullExtent;a.geometry.coordinates.forEach(function(a){var d=a.x,
k=a.y;if(d<c.xmin||d>c.xmax||k<c.ymin||k>c.ymax)a.elevationTile=b})};f.prototype._selectTilesClosestResolution=function(a){var b=this._findNearestDemResolutionLODIndex(a.layer.tileInfo,a.options.demResolution);a.selectTilesAtLOD(b)};f.prototype._findNearestDemResolutionLODIndex=function(a,b){var c=w.getMetersPerUnitForSR(a.spatialReference);b/=c;for(var c=a.lods[0],d=0,e=1;e<a.lods.length;e++){var k=a.lods[e];Math.abs(k.resolution-b)<Math.abs(c.resolution-b)&&(c=k,d=e)}return d};f.prototype._selectTilesFinestContiguous=
function(a){return g.__awaiter(this,void 0,void 0,function(){var b;return g.__generator(this,function(c){switch(c.label){case 0:return b=v(a.layer.tileInfo,a.options.minDemResolution),[4,this._selectTilesFinestContiguousAt(a,b)];case 1:return c.sent(),[2]}})})};f.prototype._selectTilesFinestContiguousAt=function(a,b){return g.__awaiter(this,void 0,void 0,function(){var c,d,e,k;return g.__generator(this,function(h){switch(h.label){case 0:c=a.layer;a.selectTilesAtLOD(b);if(0>b)return[2];d=c.tilemapCache;
e=a.getTilesToFetch();h.label=1;case 1:return h.trys.push([1,6,,8]),d?[4,m.all(e.map(function(b){return d.fetchAvailability(b.level,b.row,b.col,{signal:a.options.signal})}))]:[3,3];case 2:return h.sent(),[3,5];case 3:return[4,this._populateElevationTiles(a)];case 4:h.sent();if(!a.allElevationTilesFetched())throw a.clearElevationTiles(),new n("elevation-query:has-unavailable-tiles");h.label=5;case 5:return[3,8];case 6:k=h.sent();if(m.isAbortError(k))throw k;return[4,this._selectTilesFinestContiguousAt(a,
b-1)];case 7:return h.sent(),[3,8];case 8:return[2]}})})};f.prototype._populateElevationTiles=function(a){return g.__awaiter(this,void 0,void 0,function(){var b,c,d;return g.__generator(this,function(e){switch(e.label){case 0:return b=a.getTilesToFetch(),c={},d=b.map(function(b){return a.layer.fetchTile(b.level,b.row,b.col,{noDataValue:a.options.noDataValue,signal:a.options.signal}).then(function(a){return c[b.id]=new A.ElevationTile(b,a)})}),[4,m.eachAlways(d)];case 1:return e.sent(),m.throwIfAborted(a.options.signal),
a.populateElevationTiles(c),[2]}})})};f.prototype._selectTilesAuto=function(a){return g.__awaiter(this,void 0,void 0,function(){var b,c,d,e,k=this;return g.__generator(this,function(h){switch(h.label){case 0:this._selectTilesAutoFinest(a);this._reduceTilesForMaximumRequests(a);b=a.layer.tilemapCache;if(!b)return[2,this._selectTilesAutoPrefetchUpsample(a)];c=a.getTilesToFetch();d={};e=c.map(function(c){return g.__awaiter(k,void 0,void 0,function(){var k,e;return g.__generator(this,function(h){switch(h.label){case 0:return k=
{id:null,level:0,row:0,col:0,extent:t.create()},[4,D.result(b.fetchAvailabilityUpsample(c.level,c.row,c.col,k,{signal:a.options.signal}))];case 1:e=h.sent();if(!1===e.ok&&m.isAbortError(e.error))throw e.error;!0===e.ok&&(d[c.id]=k);return[2]}})})});return[4,m.all(e)];case 1:return h.sent(),a.remapTiles(d),[2]}})})};f.prototype._reduceTilesForMaximumRequests=function(a){var b=a.layer.tileInfo,c=0,d={},e=function(a){a.id in d?d[a.id]++:(d[a.id]=1,c++)},k=function(a){var b=d[a.id];1===b?(delete d[a.id],
c--):d[a.id]=b-1};a.forEachTileToFetch(e,k);for(var h=!0;h&&(h=!1,a.forEachTileToFetch(function(d){c<=a.options.maximumAutoTileRequests||(k(d),b.upsampleTile(d)&&(h=!0),e(d))},k),h););};f.prototype._selectTilesAutoFinest=function(a){var b=v(a.layer.tileInfo,a.options.minDemResolution);a.selectTilesAtLOD(b,a.options.maximumAutoTileRequests)};f.prototype._selectTilesAutoPrefetchUpsample=function(a){return g.__awaiter(this,void 0,void 0,function(){var b,c;return g.__generator(this,function(d){switch(d.label){case 0:return b=
a.layer.tileInfo,[4,this._populateElevationTiles(a)];case 1:return d.sent(),c=!1,a.forEachTileToFetch(function(a,d){b.upsampleTile(a)?c=!0:d()}),c?[4,this._selectTilesAutoPrefetchUpsample(a)]:[3,3];case 2:d.sent(),d.label=3;case 3:return[2]}})})};f.prototype._sampleGeometryWithElevation=function(a){a.geometry.coordinates.forEach(function(b){var c=b.elevationTile,d=a.options.noDataValue;c&&(c=c.sample(b.x,b.y),void 0!==c?d=c:b.elevationTile=null);b.z=d})};f.prototype._extractSampleInfo=function(a){var b=
a.layer.tileInfo,c=w.getMetersPerUnitForSR(b.spatialReference);return a.geometry.coordinates.map(function(d){var e=-1;d.elevationTile&&d.elevationTile!==a.outsideExtentTile&&(e=b.lodAt(d.elevationTile.tile.level).resolution*c);return{demResolution:e}})};return f}();p.ElevationQuery=u;var r=function(){function f(){}f.prototype.export=function(){return this._exporter(this.coordinates,this.spatialReference)};f.prototype.clone=function(a){var b=this,c=new f;c.geometry=this.geometry;c.spatialReference=
this.spatialReference;c.coordinates=a||this.coordinates.map(function(a){return b._cloneCoordinate(a)});c._exporter=this._exporter;return c};f.prototype.project=function(a){var b=this;if(this.spatialReference.equals(a))return this.clone();if(q.canProject(this.spatialReference,a)){var c=a.isWGS84?q.xyToLngLat:q.lngLatToXY,d=[0,0],e=this.coordinates.map(function(a){a=b._cloneCoordinate(a);c(a.x,a.y,d);a.x=d[0];a.y=d[1];return a}),e=this.clone(e);e.spatialReference=a;return e}return null};f.prototype._cloneCoordinate=
function(a){return{x:a.x,y:a.y,z:a.z,m:a.m,tile:null,elevationTile:null}};f.fromGeometry=function(a){var b=new f;b.geometry=a;b.spatialReference=a.spatialReference;if(a instanceof f)b.coordinates=a.coordinates.map(function(a){return b._cloneCoordinate(a)}),b._exporter=function(b,c){b=a.clone(b);b.spatialReference=c;return b};else switch(a.type){case "point":b.coordinates=a.hasM?[{x:a.x,y:a.y,m:a.m}]:[{x:a.x,y:a.y}];b._exporter=function(b,c){return a.hasM?new y(b[0].x,b[0].y,b[0].z,b[0].m,c):new y(b[0].x,
b[0].y,b[0].z,c)};break;case "multipoint":b.coordinates=a.points.map(function(b){return a.hasM?{x:b[0],y:b[1],m:b[a.hasZ?3:2]}:{x:b[0],y:b[1]}});b._exporter=function(b,c){return a.hasM?new x({points:b.map(function(a){return[a.x,a.y,a.z,a.m]}),hasZ:!0,hasM:!0,spatiaReference:c}):new x(b.map(function(a){return[a.x,a.y,a.z]}),c)};break;case "polyline":var c=[],d=[],e=0;a.paths.forEach(function(b){d.push([e,e+b.length]);e+=b.length;c.push.apply(c,b.map(function(b){return a.hasM?{x:b[0],y:b[1],m:b[a.hasZ?
3:2]}:{x:b[0],y:b[1]}}))});b.coordinates=c;b._exporter=function(b,c){var e=a.hasM?b.map(function(a){return[a.x,a.y,a.z,a.m]}):b.map(function(a){return[a.x,a.y,a.z]});b=d.map(function(a){return e.slice(a[0],a[1])});return new E({paths:b,hasM:a.hasM,hasZ:!0,spatialReference:c})}}return b};return f}();p.GeometryDescriptor=r;var B=function(){return function(f,a){this.layer=f;this.options=a}}(),F=function(f){function a(a,c,d){a=f.call(this,a,d)||this;a.type="geometry";a.outSpatialReference=c;return a}
g.__extends(a,f);a.prototype.selectTilesAtLOD=function(a){if(0>a)this.geometry.coordinates.forEach(function(a){return a.tile=null});else{var b=this.layer.tileInfo,d=b.lods[a].level;this.geometry.coordinates.forEach(function(a){a.tile=b.tileAt(d,a.x,a.y)})}};a.prototype.allElevationTilesFetched=function(){return!this.geometry.coordinates.some(function(a){return!a.elevationTile})};a.prototype.clearElevationTiles=function(){for(var a=0,c=this.geometry.coordinates;a<c.length;a++){var d=c[a];d.elevationTile!==
this.outsideExtentTile&&(d.elevationTile=null)}};a.prototype.populateElevationTiles=function(a){for(var b=0,d=this.geometry.coordinates;b<d.length;b++){var e=d[b];!e.elevationTile&&e.tile&&(e.elevationTile=a[e.tile.id])}};a.prototype.remapTiles=function(a){for(var b=0,d=this.geometry.coordinates;b<d.length;b++){var e=d[b];e.tile=a[e.tile.id]}};a.prototype.getTilesToFetch=function(){for(var a={},c=[],d=0,e=this.geometry.coordinates;d<e.length;d++){var k=e[d],f=k.tile;k.elevationTile||!k.tile||a[f.id]||
(a[f.id]=f,c.push(f))}return c};a.prototype.forEachTileToFetch=function(a){for(var b=function(b){b.tile&&!b.elevationTile&&a(b.tile,function(){return b.tile=null})},d=0,e=this.geometry.coordinates;d<e.length;d++)b(e[d])};return a}(B),G=function(f){function a(a,c,d,e){d=f.call(this,a,d)||this;d.type="extent";d.elevationTiles=[];d.candidateTiles=[];d.fetchedCandidates=new Set;d.extent=c.intersection(a.fullExtent);d.maskExtents=e;return d}g.__extends(a,f);a.prototype.selectTilesAtLOD=function(a,c){c=
this._maximumLodForRequests(c);a=Math.min(c,a);0>a?this.candidateTiles.length=0:this._selectCandidateTilesCoveringExtentAt(a)};a.prototype._maximumLodForRequests=function(a){var b=this.layer.tileInfo;if(!a)return b.lods.length-1;for(var d=this.extent,e=b.lods.length-1;0<=e;e--){var f=b.lods[e];if(Math.ceil(d.width/(f.resolution*b.size[0]))*Math.ceil(d.height/(f.resolution*b.size[1]))<=a)return e}return-1};a.prototype.allElevationTilesFetched=function(){return this.candidateTiles.length===this.elevationTiles.length};
a.prototype.clearElevationTiles=function(){this.elevationTiles.length=0;this.fetchedCandidates.clear()};a.prototype.populateElevationTiles=function(a){for(var b=0,d=this.candidateTiles;b<d.length;b++){var e=d[b],f=a[e.id];f&&(this.fetchedCandidates.add(e),this.elevationTiles.push(f))}};a.prototype.remapTiles=function(a){this.candidateTiles=this._uniqueNonOverlappingTiles(this.candidateTiles.map(function(b){return a[b.id]}))};a.prototype.getTilesToFetch=function(){return this.candidateTiles};a.prototype.forEachTileToFetch=
function(a,c){var b=this,e=this.candidateTiles;this.candidateTiles=[];e.forEach(function(d){if(b.fetchedCandidates.has(d))c&&c(d);else{var e=!1;a(d,function(){return e=!0});e?c&&c(d):b.candidateTiles.push(d)}});this.candidateTiles=this._uniqueNonOverlappingTiles(this.candidateTiles,c)};a.prototype._uniqueNonOverlappingTiles=function(a,c){for(var b={},e=[],f=0;f<a.length;f++){var h=a[f];b[h.id]?c&&c(h):(b[h.id]=h,e.push(h))}var g=e.sort(function(a,b){return a.level-b.level});return g.filter(function(a,
b){for(var d=0;d<b;d++)if(t.contains(g[d].extent,a.extent))return c&&c(a),!1;return!0})};a.prototype._selectCandidateTilesCoveringExtentAt=function(a){this.candidateTiles.length=0;var b=this.layer.tileInfo,d=b.lods[a],e=this.extent;a=b.tileAt(d.level,e.xmin,e.ymin);for(var f=Math.ceil((e.xmax-a.extent[0])/(d.resolution*b.size[0])),d=Math.ceil((e.ymax-a.extent[1])/(d.resolution*b.size[1])),e=0;e<d;e++)for(var h=0;h<f;h++){var g={id:null,level:a.level,row:a.row-e,col:a.col+h};b.updateTileInfo(g);this._tileIsMasked(g)||
this.candidateTiles.push(g)}};a.prototype._tileIsMasked=function(a){return this.maskExtents?this.maskExtents.some(function(b){return t.contains(b,a.extent)}):!1};return a}(B);p.getFinestLodIndex=v;p.default=u});