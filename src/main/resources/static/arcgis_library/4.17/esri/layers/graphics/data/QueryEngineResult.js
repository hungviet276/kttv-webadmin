// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.17/esri/copyright.txt for details.
//>>built
define("require exports tslib ../../../core/MapUtils ../../../core/maybe ../../../core/promiseUtils ../../../core/SetUtils ../../../geometry/support/quantizationUtils ../../../geometry/support/spatialReferenceUtils ../featureConversionUtils ./AttributesBuilder ./attributeSupport ./projectionSupport ./timeSupport ./utils".split(" "),function(A,E,u,K,M,n,N,B,x,O,H,P,C,Q,q){function D(c){return c.substr(24,12)+c.substr(19,4)+c.substr(16,2)+c.substr(14,2)+c.substr(11,2)+c.substr(9,2)+c.substr(6,2)+c.substr(4,
2)+c.substr(2,2)+c.substr(0,2)}function L(c,a,b,d){if(b&&"esriFieldTypeDate"===b.type){var g=(new Date(c)).getTime(),f=(new Date(a)).getTime();if(!isNaN(g)&&!isNaN(f))return d?f-g:g-f}return"number"===typeof c&&"number"===typeof a?d?a-c:c-a:"string"===typeof c&&"string"===typeof a?(g=c.toUpperCase(),f=a.toUpperCase(),!b||"esriFieldTypeGUID"!==b.type&&"esriFieldTypeGlobalID"!==b.type?d=(d?g>f:g<f)?-1:(d?g<f:g>f)?1:0:(c=D(g),f=D(f),d=(d?c>f:c<f)?-1:(d?c<f:c>f)?1:0),d):d?1:-1}Object.defineProperty(E,
"__esModule",{value:!0});A=function(){function c(a,b,d){this.items=a;this.queryGeometry=b;this.definitionExpression=d.definitionExpression;this.geometryType=d.geometryType;this.hasM=d.hasM;this.hasZ=d.hasZ;this.objectIdField=d.objectIdField;this.spatialReference=d.spatialReference;this.fieldsIndex=d.fieldsIndex;this.timeInfo=d.timeInfo;this.featureAdapter=d.featureAdapter}Object.defineProperty(c.prototype,"size",{get:function(){return this.items.length},enumerable:!1,configurable:!0});c.prototype.createQueryResponseForCount=
function(a){var b=new H.default(a,this.featureAdapter,this.fieldsIndex);if(!a.outStatistics)return b.countDistinctValues(this.items);var d=a.groupByFieldsForStatistics,g=a.having;if(null===d||void 0===d||!d.length)return 1;var f=new Map,e=new Map,m=new Set,l=0;for(a=a.outStatistics;l<a.length;l++){var k=a[l],k="exceedslimit"!==k.statisticType?k.onStatisticField:void 0;if(!e.has(k)){for(var c=[],h=0,p=d;h<p.length;h++){var I=this._getAttributeValues(b,p[h],f);c.push(I)}e.set(k,this._calculateUniqueValues(c))}var k=
e.get(k),t;for(t in k)h=k[t],c=h.items,h=h.data.join(","),g&&!b.validateItems(c,g)||m.add(h)}return m.size};c.prototype.createQueryResponse=function(a){var b;b=a.outStatistics?a.outStatistics.some(function(a){return"exceedslimit"===a.statisticType})?this._createExceedsLimitQueryResponse(a):this._createStatisticsQueryResponse(a):this._createFeatureQueryResponse(a);a.returnQueryGeometry&&(x.isValid(a.outSR)&&!x.equals(this.queryGeometry.spatialReference,a.outSR)?b.queryGeometry=q.cleanFromGeometryEngine(u.__assign({spatialReference:a.outSR},
C.project(this.queryGeometry,this.queryGeometry.spatialReference,a.outSR))):b.queryGeometry=q.cleanFromGeometryEngine(u.__assign({spatialReference:a.outSR},this.queryGeometry)));return b};c.prototype.executeAttributesQuery=function(a){var b=P.getWhereClause(a.where,this.fieldsIndex);if(!b)return n.resolve(this);if(b.isStandardized){for(var d=0,g=[],f=0,e=this.items;f<e.length;f++){var m=e[f];b.testFeature(m,this.featureAdapter)&&(g[d++]=m)}b=new c(g,this.queryGeometry,this);b.definitionExpression=
a.where;return n.resolve(b)}return n.reject(new TypeError("Where clause is not standardized"))};c.prototype.executeObjectIdsQuery=function(a){if(!a.objectIds||!a.objectIds.length)return n.resolve(this);var b=N.SetFromValues(a.objectIds),d=this.featureAdapter.getObjectId;return n.resolve(new c(this.items.filter(function(a){return b.has(d(a))}),this.queryGeometry,this))};c.prototype.executeTimeQuery=function(a){a=Q.getTimeOperator(this.timeInfo,a.timeExtent,this.featureAdapter);if(!M.isSome(a))return n.resolve(this);
a=this.items.filter(a);return n.resolve(new c(a,this.queryGeometry,this))};c.prototype.filterLatest=function(){for(var a=this.timeInfo,b=a.trackIdField,d=a.startTimeField,a=a.endTimeField||d,d=new Map,g=this.featureAdapter.getAttribute,f=0,e=this.items;f<e.length;f++){var m=e[f],l=g(m,b),k=g(m,a),r=d.get(l);(!r||k>g(r,a))&&d.set(l,m)}b=K.valuesOfMap(d);return n.resolve(new c(b,this.queryGeometry,this))};c.prototype.project=function(a){return u.__awaiter(this,void 0,void 0,function(){var b,d,g,f=this;
return u.__generator(this,function(e){switch(e.label){case 0:if(!a||x.equals(this.spatialReference,a))return[2,this];b=this.featureAdapter;return[4,C.projectMany(this.items.map(function(a){return q.getGeometry(f.geometryType,f.hasZ,f.hasM,b.getGeometry(a))}),this.spatialReference,a)];case 1:return d=e.sent(),g=d.map(function(a,d){return b.cloneWithGeometry(f.items[d],O.convertFromGeometry(a,f.hasZ,f.hasM))}),[2,new c(g,this.queryGeometry,{definitionExpression:this.definitionExpression,geometryType:this.geometryType,
hasM:this.hasM,hasZ:this.hasZ,objectIdField:this.objectIdField,spatialReference:a,fieldsIndex:this.fieldsIndex,timeInfo:this.timeInfo,featureAdapter:this.featureAdapter})]}})})};c.prototype._sortFeatures=function(a,b,d){if(1<a.length&&b&&b.length){var g=function(b){b=b.split(" ");var e=b[0],g=f.fieldsIndex.get(e),c=b[1]&&"desc"===b[1].toLowerCase();a.sort(function(a,b){a=d(a,e,g);b=d(b,e,g);return L(a,b,g,c)})},f=this,e=0;for(b=b.reverse();e<b.length;e++)g(b[e])}};c.prototype._createFeatureQueryResponse=
function(a){var b=this,d=this.items,g=this.geometryType,f=this.hasM,e=this.hasZ,c=this.objectIdField,l=this.spatialReference,k=a.outFields,r=a.outSR,h=a.quantizationParameters,p=a.resultRecordCount,I=a.resultOffset,t=a.returnZ,n=a.returnM,p=null!=p?d.length>(I||0)+p:!1,k=k&&(-1<k.indexOf("*")?u.__spreadArrays(this.fieldsIndex.fields):k.map(function(a){return b.fieldsIndex.get(a)}));return{exceededTransferLimit:p,features:this._createFeatures(a,d),fields:k,geometryType:g,hasM:f&&n,hasZ:e&&t,objectIdFieldName:c,
spatialReference:q.cleanFromGeometryEngine(r?r:l),transform:h&&B.toQuantizationTransform(h)||null}};c.prototype._createFeatures=function(a,b){var d=new H.default(a,this.featureAdapter,this.fieldsIndex),g=a.orderByFields,f=a.quantizationParameters,e=a.returnGeometry,c=a.returnCentroid,l=a.maxAllowableOffset,k=a.resultOffset,r=a.resultRecordCount,h=a.returnZ;a=a.returnM;var p=this.hasZ&&(void 0===h?!1:h),n=this.hasM&&(void 0===a?!1:a),h=[];a=0;b=u.__spreadArrays(b);this._sortFeatures(b,g,function(a,
b,c){return d.getFieldValue(a,b,c)});if(e||c)if(g=B.toQuantizationTransform(f),e&&!c)for(c=0;c<b.length;c++)e=b[c],h[a++]={attributes:d.getAttributes(e),geometry:q.getGeometry(this.geometryType,this.hasZ,this.hasM,this.featureAdapter.getGeometry(e),l,g,p,n)};else if(!e&&c)for(l=0;l<b.length;l++)e=b[l],h[a++]={attributes:d.getAttributes(e),centroid:q.transformCentroid(this,this.featureAdapter.getCentroid(e,this),g)};else for(c=0;c<b.length;c++)e=b[c],h[a++]={attributes:d.getAttributes(e),centroid:q.transformCentroid(this,
this.featureAdapter.getCentroid(e,this),g),geometry:q.getGeometry(this.geometryType,this.hasZ,this.hasM,this.featureAdapter.getGeometry(e),l,g,p,n)};else for(l=0;l<b.length;l++)e=b[l],(p=d.getAttributes(e))&&(h[a++]={attributes:p});k=k||0;null!=r&&(h=h.slice(k,Math.min(h.length,k+r)));return h};c.prototype._createExceedsLimitQueryResponse=function(a){var b=!1,d=Number.POSITIVE_INFINITY,c=Number.POSITIVE_INFINITY,b=Number.POSITIVE_INFINITY,f=0;for(a=a.outStatistics;f<a.length;f++){var e=a[f];if("exceedslimit"===
e.statisticType){d=null!=e.maxPointCount?e.maxPointCount:Number.POSITIVE_INFINITY;c=null!=e.maxRecordCount?e.maxRecordCount:Number.POSITIVE_INFINITY;b=null!=e.maxVertexCount?e.maxVertexCount:Number.POSITIVE_INFINITY;break}}if("esriGeometryPoint"===this.geometryType)b=this.items.length>d;else if(this.items.length>c)b=!0;else var d=this.hasZ?this.hasM?4:3:this.hasM?3:2,m=this.featureAdapter,b=this.items.reduce(function(a,b){b=m.getGeometry(b);return a+(b&&b.coords.length||0)},0)/d>b;return{fields:[{name:"exceedslimit",
type:"esriFieldTypeInteger",alias:"exceedslimit",sqlType:"sqlTypeInteger",domain:null,defaultValue:null}],features:[{attributes:{exceedslimit:Number(b)}}]}};c.prototype._createStatisticsQueryResponse=function(a){var b=this,d={attributes:{}},c=[],f=new Map,e=new Map,m=new Map,l=new Map,k=new H.default(a,this.featureAdapter,this.fieldsIndex),r=a.outStatistics,h=a.groupByFieldsForStatistics,p=a.having;a=a.orderByFields;for(var n=h&&h.length,t=!!n,q=t&&h[0],u=t&&!this.fieldsIndex.get(q),x=0;x<r.length;x++){var v=
r[x],F=v.outStatisticFieldName,w=v.statisticType,y=v,z="exceedslimit"!==w?v.onStatisticField:void 0,A="percentile_disc"===w||"percentile_cont"===w,E=t&&1===n&&(z===q||u)&&"count"===w;if(t){if(!m.has(z)){for(var v=[],w=0,B=h;w<B.length;w++){var G=this._getAttributeValues(k,B[w],f);v.push(G)}m.set(z,this._calculateUniqueValues(v))}var C=m.get(z),v=function(a){var d=C[a];a=d.count;var c=d.data,e=d.items,g=d.itemPositions,d=c.join(",");if(!p||k.validateItems(e,p)){var m=l.get(d)||{attributes:{}},e=null;
if(E)e=a;else{var n=J._getAttributeValues(k,z,f);a=g.map(function(a){return n[a]});e=A&&"statisticParameters"in y?J._getPercentileValue(y,a):J._getStatisticValue(y,a)}m.attributes[F]=e;h.forEach(function(a,d){return m.attributes[b.fieldsIndex.get(a)?a:"EXPR_"+(d+1)]=c[d]});l.set(d,m)}},J=this,D;for(D in C)v(D)}else G=this._getAttributeValues(k,z,f),d.attributes[F]=A&&"statisticParameters"in y?this._getPercentileValue(y,G):this._getStatisticValue(y,G,e);c.push({name:F,alias:F,type:"esriFieldTypeDouble"})}d=
t?K.valuesOfMap(l):[d];this._sortFeatures(d,a,function(a,b){return a.attributes[b]});return{fields:c,features:d}};c.prototype._getStatisticValue=function(a,b,d){var c=a.onStatisticField;a=a.statisticType;b=d&&d.has(c)?d.get(c):this._calculateStatistics(b);d&&d.set(c,b);return b["var"===a?"variance":a]};c.prototype._getPercentileValue=function(a,b){var d=a.statisticParameters,c=a.statisticType,f=d.value,e="desc"===d.orderBy,m=this.fieldsIndex.get(a.onStatisticField);a=u.__spreadArrays(b).filter(function(a){return null!=
a}).sort(function(a,b){return L(a,b,m,e)});return this._calculatePercentile(a,f,"percentile_disc"===c)};c.prototype._getAttributeValues=function(a,b,d){if(d.has(b))return d.get(b);var c=this.fieldsIndex.get(b),f=this.items.map(function(d){return a.getFieldValue(d,b,c)});d.set(b,f);return f};c.prototype._calculateStatistics=function(a){for(var b=Number.POSITIVE_INFINITY,d=Number.NEGATIVE_INFINITY,c=null,f=null,e=null,m=null,l=[],k=0,n=0;n<a.length;n++){var h=a[n];"string"===typeof h?k++:null==h||isNaN(h)||
(c+=h,b=Math.min(b,h),d=Math.max(d,h),l.push(h),k++)}if(k){f=c/k;for(e=a=0;e<l.length;e++)h=l[e],a+=Math.pow(h-f,2);m=1<k?a/(k-1):0;e=Math.sqrt(m)}else d=b=null;return{avg:f,count:k,max:d,min:b,stddev:e,sum:c,variance:m}};c.prototype._calculateUniqueValues=function(a){for(var b={},d=this.items,c=d.length,f=0;f<c;f++){for(var e=d[f],m=[],l=0,k=a;l<k.length;l++)m.push(k[l][f]);l=m.join(",");null==b[l]?b[l]={count:1,data:m,items:[e],itemPositions:[f]}:(b[l].count++,b[l].items.push(e),b[l].itemPositions.push(f))}return b};
c.prototype._calculatePercentile=function(a,b,d){if(0===a.length)return null;if(0>=b)return a[0];if(1<=b)return a[a.length-1];var c=(a.length-1)*b,f=Math.floor(c);b=f+1;var c=c%1,f=a[f],e=a[b];return b>=a.length||d||"string"===typeof f||"string"===typeof e?f:f*(1-c)+e*c};return c}();E.default=A});