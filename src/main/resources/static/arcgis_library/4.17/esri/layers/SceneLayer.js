// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.17/esri/copyright.txt for details.
//>>built
define("require exports tslib ../PopupTemplate ../renderers ../request ../core/Error ../core/Logger ../core/maybe ../core/MultiOriginJSONSupport ../core/promiseUtils ../core/urlUtils ../core/watchUtils ../core/accessorSupport/decorators ../core/accessorSupport/utils ./Layer ./mixins/ArcGISService ./mixins/OperationalLayer ./mixins/PortalLayer ./mixins/ScaleRangeLayer ./mixins/SceneService ./support/commonProperties ./support/commonProperties ./support/FeatureReduction ./support/FeatureReductionSelection ./support/FetchAssociatedFeatureLayer ./support/fieldProperties ./support/FieldsIndex ./support/fieldUtils ./support/I3SLayerDefinitions ./support/LabelClass ./support/labelingInfo ./support/RangeInfo ../renderers/support/styleUtils ../support/popupUtils ../tasks/support/Query @dojo/framework/shim/Promise".split(" "),
function(W,X,c,v,w,x,f,y,g,z,m,A,B,d,C,D,E,F,G,H,I,k,J,K,L,M,N,O,p,l,P,q,Q,R,S,T){var U=["3DObject","Point"],h=y.getLogger("esri.layers.SceneLayer"),r=N.defineFieldProperties(),t={"mesh-pyramids":"mesh-pyramids",meshpyramids:"mesh-pyramids","features-meshes":"mesh-pyramids",points:"points","features-points":"points",lines:"lines","features-lines":"lines",polygons:"polygons","features-polygons":"polygons"},V={"mesh-pyramids":"mesh",points:"point",lines:"polyline",polygons:"polygon"};return function(u){function b(){for(var a=
[],e=0;e<arguments.length;e++)a[e]=arguments[e];a=u.apply(this,a)||this;a.featureReduction=null;a.rangeInfos=null;a.operationalLayerType="ArcGISSceneServiceLayer";a.type="scene";a.fields=null;a.outFields=null;a.nodePages=null;a.materialDefinitions=null;a.textureSetDefinitions=null;a.geometryDefinitions=null;a.serviceUpdateTimeStamp=null;a.definitionExpression=null;a.path=null;a.labelsVisible=!0;a.labelingInfo=null;a.legendEnabled=!0;a.cachedDrawingInfo={color:!1};a.popupEnabled=!0;a.popupTemplate=
null;a.objectIdField=null;a.objectIdFilter=null;a._fieldUsageInfo={};a.screenSizePerspectiveEnabled=!0;return a}c.__extends(b,u);b.prototype.normalizeCtorArgs=function(a,e){return"string"===typeof a?c.__assign({url:a},e):a};b.prototype.getField=function(a){return this.fieldsIndex.get(a)};b.prototype.getFieldDomain=function(a){return(a=this.getField(a))&&a.domain?a.domain:null};Object.defineProperty(b.prototype,"fieldsIndex",{get:function(){return new O(this.fields)},enumerable:!1,configurable:!0});
b.prototype.readNodePages=function(a,e,b){"Point"===e.layerType&&(a=e.pointNodePages);return null==a||"object"!==typeof a?null:l.I3SNodePageDefinition.fromJSON(a,b)};Object.defineProperty(b.prototype,"elevationInfo",{set:function(a){this._set("elevationInfo",a);this.loaded&&this._validateElevationInfo()},enumerable:!1,configurable:!0});Object.defineProperty(b.prototype,"geometryType",{get:function(){return V[this.profile]||"mesh"},enumerable:!1,configurable:!0});Object.defineProperty(b.prototype,
"renderer",{set:function(a){p.fixRendererFields(a,this.fields);this._set("renderer",a)},enumerable:!1,configurable:!0});b.prototype.readCachedDrawingInfo=function(a){if(null==a||"object"!==typeof a)a={};null==a.color&&(a.color=!1);return a};Object.defineProperty(b.prototype,"defaultPopupTemplate",{get:function(){return g.isSome(this.associatedLayer)||this.attributeStorageInfo?this.createPopupTemplate():null},enumerable:!1,configurable:!0});b.prototype.readObjectIdField=function(a,e){!a&&e.fields&&
e.fields.some(function(e){"esriFieldTypeOID"===e.type&&(a=e.name);return!!a});return a||void 0};b.prototype.readProfile=function(a,e){a=e.store.profile;if(null!=a&&t[a])return t[a];h.error("Unknown or missing profile",{profile:a,layer:this});return"mesh-pyramids"};b.prototype.load=function(a){var e=this,b=g.isSome(a)?a.signal:null;a=this.loadFromPortal({supportedTypes:["Scene Service"]},a).then(function(){return e._fetchService(b)},function(){return e._fetchService(b)}).then(function(){return m.all([e._verifyRootNodeAndUpdateExtent(e.nodePages,
b),e._setAssociatedFeatureLayer(b)])}).then(function(){return e._validateElevationInfo()}).then(function(){return e._applyAssociatedLayerOverrides()}).then(function(){return e._populateFieldUsageInfo()}).then(function(){return R.loadStyleRenderer(e,{origin:"service"},b)}).then(function(){return p.fixRendererFields(e.renderer,e.fields)});this.addResolvingPromise(a);return m.resolve(this)};b.prototype.createQuery=function(){var a=new T;"mesh"!==this.geometryType&&(a.returnGeometry=!0,a.returnZ=!0);
a.where=this.definitionExpression||"1\x3d1";a.sqlFormat="standard";return a};b.prototype.queryExtent=function(a,e){var b=this;return this._getAssociatedLayerForQuery().then(function(c){return c.queryExtent(a||b.createQuery(),e)})};b.prototype.queryFeatureCount=function(a,e){var b=this;return this._getAssociatedLayerForQuery().then(function(c){return c.queryFeatureCount(a||b.createQuery(),e)})};b.prototype.queryFeatures=function(a,e){var b=this;return this._getAssociatedLayerForQuery().then(function(c){return c.queryFeatures(a||
b.createQuery(),e)}).then(function(a){if(a&&a.features)for(var e=0,c=a.features;e<c.length;e++){var d=c[e];d.layer=b;d.sourceLayer=b}return a})};b.prototype.queryObjectIds=function(a,e){var b=this;return this._getAssociatedLayerForQuery().then(function(c){return c.queryObjectIds(a||b.createQuery(),e)})};b.prototype.getFieldUsageInfo=function(a){var b={supportsLabelingInfo:!1,supportsRenderer:!1,supportsPopupTemplate:!1,supportsLayerQuery:!1};return this.loaded?this._fieldUsageInfo[a]||b:(h.error("#getFieldUsageInfo()",
"Unavailable until layer is loaded"),b)};b.prototype.createPopupTemplate=function(a){return S.createPopupTemplate(this,a)};b.prototype._getAssociatedLayerForQuery=function(){var a=this.associatedLayer;return g.isSome(a)&&a.loaded?m.resolve(a):this._loadAssociatedLayerForQuery()};b.prototype._loadAssociatedLayerForQuery=function(){return c.__awaiter(this,void 0,void 0,function(){var a;return c.__generator(this,function(b){switch(b.label){case 0:return[4,this.load()];case 1:b.sent();if(g.isNone(this.associatedLayer))throw new f("scenelayer:query-not-available",
"SceneLayer queries are not available without an associated feature layer",{layer:this});b.label=2;case 2:return b.trys.push([2,4,,5]),[4,this.associatedLayer.load()];case 3:return b.sent(),[3,5];case 4:throw a=b.sent(),new f("scenelayer:query-not-available","SceneLayer associated feature layer could not be loaded",{layer:this,error:a});case 5:return[2,this.associatedLayer]}})})};b.prototype.hasCachedStatistics=function(a){return null!=this.statisticsInfo&&this.statisticsInfo.some(function(b){return b.name===
a})};b.prototype.queryCachedStatistics=function(a,b){return c.__awaiter(this,void 0,void 0,function(){var e,d,n,g,h;return c.__generator(this,function(c){switch(c.label){case 0:return[4,this.load(b)];case 1:c.sent();if(!this.statisticsInfo)throw new f("scenelayer:no-cached-statistics","Cached statistics are not available for this layer");e=this.fieldsIndex.get(a);if(!e)throw new f("scenelayer:field-unexisting","Field '"+a+"' does not exist on the layer");d=0;for(n=this.statisticsInfo;d<n.length;d++)if(g=
n[d],g.name===e.name)return h=A.join(this.parsedUrl.path,g.href),[2,x(h,{query:{f:"json"},responseType:"json",signal:b?b.signal:null}).then(function(a){return a.data})];throw new f("scenelayer:no-cached-statistics","Cached statistics for this attribute are not available");}})})};b.prototype.saveAs=function(a,b){return c.__awaiter(this,void 0,void 0,function(){var e=this;return c.__generator(this,function(d){return[2,this._debouncedSaveOperations(1,c.__assign(c.__assign({},b),{getTypeKeywords:function(){return e._getTypeKeywords()},
portalItemLayerType:"scene"}),a)]})})};b.prototype.save=function(){return c.__awaiter(this,void 0,void 0,function(){var a,b=this;return c.__generator(this,function(e){a={getTypeKeywords:function(){return b._getTypeKeywords()},portalItemLayerType:"scene"};return[2,this._debouncedSaveOperations(0,a)]})})};b.prototype.validateLayer=function(a){if(a.layerType&&-1===U.indexOf(a.layerType))throw new f("scenelayer:layer-type-not-supported","SceneLayer does not support this layer type",{layerType:a.layerType});
if(isNaN(this.version.major)||isNaN(this.version.minor))throw new f("layer:service-version-not-supported","Service version is not supported.",{serviceVersion:this.version.versionString,supportedVersions:"1.x"});if(1<this.version.major)throw new f("layer:service-version-too-new","Service version is too new.",{serviceVersion:this.version.versionString,supportedVersions:"1.x"});a=this.normalReferenceFrame;var b=this.spatialReference,c=!1,d=!1;if(null==a)d=c=!0;else switch(b=b&&b.isGeographic,a){case "east-north-up":case "earth-centered":c=
!0;d=b;break;case "vertex-reference-frame":c=!0;d=!b;break;default:c=!1}if(!c)throw new f("scenelayer:unsupported-normal-reference-frame","Normal reference frame is invalid.");if(!d)throw new f("scenelayer:incompatible-normal-reference-frame","Normal reference frame is incompatible with layer spatial reference.");};b.prototype._getTypeKeywords=function(){var a=[];if("points"===this.profile)a.push("Point");else if("mesh-pyramids"===this.profile)a.push("3DObject");else throw new f("scenelayer:unknown-profile",
"SceneLayer:save() encountered an unknown SceneLayer profile: "+this.profile);return a};b.prototype._populateFieldUsageInfo=function(){this._fieldUsageInfo={};if(this.fields)for(var a=function(a){var c=!(!b.attributeStorageInfo||!b.attributeStorageInfo.some(function(b){return b.name===a.name})),e=!!(g.isSome(b.associatedLayer)&&b.associatedLayer.fields&&b.associatedLayer.fields.some(function(b){return b&&a.name===b.name}));b._fieldUsageInfo[a.name]={supportsLabelingInfo:c,supportsRenderer:c,supportsPopupTemplate:c||
e,supportsLayerQuery:e}},b=this,c=0,d=this.fields;c<d.length;c++)a(d[c])};b.prototype._applyAssociatedLayerOverrides=function(){if(!g.isNone(this.associatedLayer)){if(this.associatedLayer.fields){for(var a=null,b=0,c=this.associatedLayer.fields;b<c.length;b++){var d=c[b];this.getField(d.name)||(a||(a=this.fields?this.fields.slice():[]),a.push(d.clone()))}a&&this._set("fields",a)}a=["popupTemplate","popupEnabled"];b=C.getProperties(this);for(c=0;c<a.length;c++)d=a[c],this._buddyIsMoreImportant(d)&&
(b.setDefaultOrigin(this.associatedLayer.originOf(d)),b.set(d,this.associatedLayer[d]),b.setDefaultOrigin("user"))}};b.prototype._setAssociatedFeatureLayer=function(a){return c.__awaiter(this,void 0,void 0,function(){var b,d,f;return c.__generator(this,function(c){switch(c.label){case 0:if(-1===["mesh-pyramids","points"].indexOf(this.profile))return[2];b=new M.FetchAssociatedFeatureLayer(this.parsedUrl,this.portalItem,a);c.label=1;case 1:return c.trys.push([1,3,,4]),d=this,[4,b.fetch()];case 2:return d.associatedLayer=
c.sent(),[3,4];case 3:return f=c.sent(),m.isAbortError(f)||this._logWarningOnPopupEnabled(),[3,4];case 4:return[2]}})})};b.prototype._logWarningOnPopupEnabled=function(){var a=this;B.whenValidOnce(this,["popupTemplate","popupEnabled"],function(){return a.popupEnabled&&null!=a.popupTemplate}).then(function(){return function(){var b="this SceneLayer: "+a.title;null==a.attributeStorageInfo?h.warn("Associated FeatureLayer could not be loaded and no binary attributes found. Popups will not work on "+b):
h.info("Associated FeatureLayer could not be loaded. Falling back to binary attributes for Popups on "+b)}})};b.prototype._buddyIsMoreImportant=function(a){if(g.isNone(this.associatedLayer))return!1;var b=this.originIdOf(a);a=this.associatedLayer.originIdOf(a);return null!=a&&2>=a?null==b||2>b:null!=a&&3>=a?null==b||3>b:!1};b.prototype._validateElevationInfo=function(){var a=this.elevationInfo;a&&("mesh-pyramids"===this.profile&&"absolute-height"!==a.mode&&h.warn(".elevationInfo\x3d","Mesh scene layers only support absolute-height elevation mode"),
a.featureExpressionInfo&&"0"!==a.featureExpressionInfo.expression&&h.warn(".elevationInfo\x3d","Scene layers do not support featureExpressionInfo"))};c.__decorate([d.property({types:{key:"type",base:K.default,typeMap:{selection:L}},json:{origins:{"web-scene":{name:"layerDefinition.featureReduction",write:!0},"portal-item":{name:"layerDefinition.featureReduction",write:!0}}}})],b.prototype,"featureReduction",void 0);c.__decorate([d.property({type:[Q.default],json:{read:!1,origins:{"web-scene":{name:"layerDefinition.rangeInfos",
write:!0},"portal-item":{name:"layerDefinition.rangeInfos",write:!0}}}})],b.prototype,"rangeInfos",void 0);c.__decorate([d.property({json:{read:!1}})],b.prototype,"associatedLayer",void 0);c.__decorate([d.property({type:["show","hide"]})],b.prototype,"listMode",void 0);c.__decorate([d.property({type:["ArcGISSceneServiceLayer"]})],b.prototype,"operationalLayerType",void 0);c.__decorate([d.property({json:{read:!1},readOnly:!0})],b.prototype,"type",void 0);c.__decorate([d.property(c.__assign(c.__assign({},
r.fields),{readOnly:!0,json:{read:!1,origins:{service:{read:!0}}}}))],b.prototype,"fields",void 0);c.__decorate([d.property({readOnly:!0,dependsOn:["fields"]})],b.prototype,"fieldsIndex",null);c.__decorate([d.property(r.outFields)],b.prototype,"outFields",void 0);c.__decorate([d.property({type:l.I3SNodePageDefinition,readOnly:!0,json:{read:!1}})],b.prototype,"nodePages",void 0);c.__decorate([d.reader("service","nodePages",["nodePages","pointNodePages"])],b.prototype,"readNodePages",null);c.__decorate([d.property({type:[l.I3SMaterialDefinition],
readOnly:!0})],b.prototype,"materialDefinitions",void 0);c.__decorate([d.property({type:[l.I3STextureSetDefinition],readOnly:!0})],b.prototype,"textureSetDefinitions",void 0);c.__decorate([d.property({type:[l.I3SGeometryDefinition],readOnly:!0})],b.prototype,"geometryDefinitions",void 0);c.__decorate([d.property({readOnly:!0})],b.prototype,"serviceUpdateTimeStamp",void 0);c.__decorate([d.property({readOnly:!0})],b.prototype,"attributeStorageInfo",void 0);c.__decorate([d.property({readOnly:!0})],b.prototype,
"statisticsInfo",void 0);c.__decorate([d.property({type:String,json:{origins:{service:{read:!1,write:!1}},name:"layerDefinition.definitionExpression",write:!0}})],b.prototype,"definitionExpression",void 0);c.__decorate([d.property({type:String,json:{origins:{"web-scene":{read:!0,write:!0}},read:!1}})],b.prototype,"path",void 0);c.__decorate([d.property(k.elevationInfo)],b.prototype,"elevationInfo",null);c.__decorate([d.property({type:String,dependsOn:["profile"]})],b.prototype,"geometryType",null);
c.__decorate([d.property(k.labelsVisible)],b.prototype,"labelsVisible",void 0);c.__decorate([d.property({type:[P],json:{origins:{service:{name:"drawingInfo.labelingInfo",read:{reader:q.reader},write:!1}},name:"layerDefinition.drawingInfo.labelingInfo",read:{reader:q.reader},write:!0}})],b.prototype,"labelingInfo",void 0);c.__decorate([d.property(k.legendEnabled)],b.prototype,"legendEnabled",void 0);c.__decorate([d.property(k.opacityDrawingInfo)],b.prototype,"opacity",void 0);c.__decorate([d.property({types:w.webSceneRendererTypes,
json:{origins:{service:{read:{source:"drawingInfo.renderer"}}},name:"layerDefinition.drawingInfo.renderer",write:!0},value:null})],b.prototype,"renderer",null);c.__decorate([d.property({json:{read:!1}})],b.prototype,"cachedDrawingInfo",void 0);c.__decorate([d.reader("service","cachedDrawingInfo")],b.prototype,"readCachedDrawingInfo",null);c.__decorate([d.property(k.popupEnabled)],b.prototype,"popupEnabled",void 0);c.__decorate([d.property({type:v,json:{name:"popupInfo",write:!0}})],b.prototype,"popupTemplate",
void 0);c.__decorate([d.property({readOnly:!0,json:{read:!1},dependsOn:["fields","title","attributeStorageInfo","associatedLayer"]})],b.prototype,"defaultPopupTemplate",null);c.__decorate([d.property({type:String,json:{read:!1}})],b.prototype,"objectIdField",void 0);c.__decorate([d.reader("service","objectIdField",["objectIdField","fields"])],b.prototype,"readObjectIdField",null);c.__decorate([d.property({json:{read:!1}})],b.prototype,"objectIdFilter",void 0);c.__decorate([d.property({type:String,
json:{read:!1}})],b.prototype,"profile",void 0);c.__decorate([d.reader("service","profile",["store.profile"])],b.prototype,"readProfile",null);c.__decorate([d.property({readOnly:!0,type:String,json:{origins:{service:{read:{source:"store.normalReferenceFrame"}}},read:!1}})],b.prototype,"normalReferenceFrame",void 0);c.__decorate([d.property(J.screenSizePerspectiveEnabled)],b.prototype,"screenSizePerspectiveEnabled",void 0);return b=c.__decorate([d.subclass("esri.layers.SceneLayer")],b)}(I.SceneService(E.ArcGISService(F.OperationalLayer(G.PortalLayer(H.ScaleRangeLayer(z.MultiOriginJSONMixin(D)))))))});