// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.17/esri/copyright.txt for details.
//>>built
define("require exports tslib ../../../geometry ../../../core/arrayUtils ../../../core/Error ../../../core/maybe ../../../core/promiseUtils ../../../core/accessorSupport/decorators ../DimensionalDefinition ../wmsUtils ./BaseRaster ./multipartParser ./wcsCapabilitiesParser ./wcsCoverageParser ../rasterFunctions/pixelUtils".split(" "),function(Q,R,h,D,x,y,E,F,z,H,I,J,K,L,G,M){var N=["nearest neighbor","bilinear","bicubic"],O=["nearest","linear","cubic"],P=["nearest-neighbor","linear","cubic"];return function(B){function e(){var a=
null!==B&&B.apply(this,arguments)||this;a.datasetFormat="WCSServer";return a}h.__extends(e,B);e.prototype.open=function(a){var c;return h.__awaiter(this,void 0,void 0,function(){var f,b,d,l,A,g,k,m,q,r=this;return h.__generator(this,function(n){switch(n.label){case 0:return[4,this.init()];case 1:return n.sent(),f=null===a||void 0===a?void 0:a.signal,[4,this._getCapabilities(f)];case 2:this.capabilities=b=n.sent();this.version||(d=null===(c=b.capabilitiesVersion)||void 0===c?void 0:c.slice(0,3),this.version=
"2.0"===d||"1.1"===d||"1.0"===d?b.capabilitiesVersion:d=x.find(b.supportedVersions,function(a){return"2.0.1"===a})||x.find(b.supportedVersions,function(a){return"2.0"===a.slice(0,3)})||x.find(b.supportedVersions,function(a){return"1.1"===a.slice(0,3)})||x.find(b.supportedVersions,function(a){return"1.0"===a.slice(0,3)})||"1.0.0");this.coverageId||(this.coverageId=b.coverages[0].id);l=b.coverages.filter(function(a){return a.id===r.coverageId})[0];if(null==l)throw new y("wcsraster-open","the coverageId "+
this.coverageId+" does not exist in capabilities");return[4,this._describeCoverage(f)];case 3:return A=n.sent(),this.coverageInfo=A[0],"2.0"===this.version.slice(0,3)&&(this.coverageInfo.lonLatEnvelope=l.lonLatEnvelope,this.coverageInfo.supportedInterpolations=G.standardizeInterpolations(b.supportedInterpolations)),this.datasetName=this.coverageInfo.title,g=this.coverageInfo.rasterInfo,this.createRemoteDatasetStorageInfo(g,512,512),this._set("rasterInfo",g),[4,this._getPixelTypeAndBandCount(f)];case 4:return k=
n.sent(),m=k.pixelType,q=k.bandCount,g.pixelType=m,1===g.bandCount&&1<q&&(g.bandCount=q),this.updateTileInfo(),[2]}})})};e.prototype.fetchRawTile=function(a,c,f,b){void 0===b&&(b={});return h.__awaiter(this,void 0,void 0,function(){var d,l,A,g,k,m,q,r,n,e,p,u,t,w;return h.__generator(this,function(h){switch(h.label){case 0:return d=this.rasterInfo.storageInfo,l=d.tileInfo,A=d.maximumPyramidLevel,g=l.lodAt(Math.max(A-a,0)),k=new D.Point({x:g.resolution,y:g.resolution,spatialReference:l.spatialReference}),
m=this.getTileExtent(k,c,f,l),q=l.size,r=q[0],n=q[1],e=this.rasterInfo.extent,p=m.xmax>e.xmax||m.ymin<e.ymin,u=m,p&&(u=m.clone().intersection(e),r=Math.floor((u.xmax-u.xmin)/g.resolution),n=Math.floor((u.ymax-u.ymin)/g.resolution)),1>=r||1>=n?[2,null]:[4,this._getCoverage(u,r,n,b)];case 1:return(t=h.sent())?[4,this.decodePixelBlock(t,{width:r,height:n,planes:null,pixelType:null})]:[2,null];case 2:if((w=h.sent())&&(w.width!==r||w.height!==n))throw new y("wcsraster-fetch","the reponse has unexpected dimension width: "+
w.width+", height: {pixelBlock.height}");p&&(w=M.clip(w,{x:0,y:0},{width:l.size[0],height:l.size[1]}));return[2,w]}})})};e.prototype._getCapabilities=function(a){return h.__awaiter(this,void 0,void 0,function(){var c,f,b;return h.__generator(this,function(d){switch(d.label){case 0:c={service:"WCS",request:"GetCapabilities"},this.version&&(c.version=this.version,c.acceptVersions=this.version),d.label=1;case 1:return d.trys.push([1,3,,4]),[4,this.request(this.url,{query:c,responseType:"xml",signal:a})];
case 2:return f=d.sent().data,[2,L.parseCapabilities(f)];case 3:b=d.sent();if(!F.isAbortError(b))throw new y("wcslayer:open","wcs capabilities is not valid or supported");throw b;case 4:return[2]}})})};e.prototype._describeCoverage=function(a){return h.__awaiter(this,void 0,void 0,function(){var c,f,b,d;return h.__generator(this,function(l){switch(l.label){case 0:c={service:"WCS",request:"DescribeCoverage",version:this.version},f=this.version.slice(0,3),"1.0"===f?c.coverage=this.coverageId:"1.1"===
f?c.identifiers=this.coverageId:"2.0"===f&&(c.coverageId=this.coverageId),l.label=1;case 1:return l.trys.push([1,3,,4]),[4,this.request(this.url,{query:c,responseType:"xml",signal:a})];case 2:return b=l.sent().data,[2,G.parseCoverages(b,this.version)];case 3:d=l.sent();if(!F.isAbortError(d))throw new y("wcslayer:open","wcs coverage description is not valid or supported");throw d;case 4:return[2]}})})};e.prototype._getPixelTypeAndBandCount=function(a){return h.__awaiter(this,void 0,void 0,function(){var c,
f,b,d,l,A,g,k,m,e;return h.__generator(this,function(h){switch(h.label){case 0:return c=this.rasterInfo,f=c.pixelSize,b=c.extent,d=c.multidimensionalInfo,l=b.center,A=new D.Extent({xmin:l.x-f.x,xmax:l.x+f.x,ymin:l.y-f.y,ymax:l.y+f.y,spatialReference:b.spatialReference}),E.isSome(d)&&(k=d.variables[0],g=[],k.dimensions.forEach(function(a){g.push(new H({variableName:k.name,dimensionName:a.name,values:a.hasRegularIntervals?a.extent[0]:a.values[0],isSlice:!0}))})),[4,this._getCoverage(A,2,2,{multidimensionalDefinition:g,
signal:E.unwrap(a)})];case 1:m=h.sent();if(!m)throw new y("wcsraster-open","unable to determine pixel type");return[4,this.decodePixelBlock(m,{width:2,height:2,planes:null,pixelType:null})];case 2:return e=h.sent(),[2,{pixelType:e.pixelType,bandCount:e.getPlaneCount()}]}})})};e.prototype._getCoverage=function(a,c,f,b){return h.__awaiter(this,void 0,void 0,function(){var d,l,e,g,k,m;return h.__generator(this,function(h){switch(h.label){case 0:return d=this.coverageInfo.coverageDescription,l=d.version,
e="2.0"===d.version?this._getCoverage201Parameters(a,c,f,b,d):"1.1"===d.version?this._getCoverage110Parameters(a,c,f,b,d):this._getCoverage100Parameters(a,c,f,b),[4,this.request(this.url,{query:e,signal:b.signal,responseType:"array-buffer"})];case 1:g=h.sent();if("1.0"===l)return[2,g.data];k=K.parse(g);if(k.isMultipart)return m=k.data.filter(function(a){var b;return-1<(null===(b=a.contentType)||void 0===b?void 0:b.toLowerCase().indexOf("image"))})[0],[2,m.contentData];throw new y("wcsraster:getcoverage",
"response is not a valid coverage");}})})};e.prototype._getInterpolationIndex=function(a){return-1===this.coverageInfo.supportedInterpolations.indexOf(a)?0:"nearest"===a?0:"bilinear"===a?1:"cubic"===a?2:0};e.prototype._getCoverage100Parameters=function(a,c,f,b){var d=this,l=a.xmin+","+a.ymin+","+a.xmax+","+a.ymax;a=a.spatialReference.wkid;var e=x.find(this.coverageInfo.supportedFormats||[],function(a){return-1<a.toLowerCase().indexOf("tiff")})||"GEOTIFF",g=b.bandIds;b=this._getInterpolationIndex(b.interpolation);
g=g?g.map(function(a){return d.coverageInfo.bandNames[a]}):null;return{service:"WCS",request:"GetCoverage",version:this.version,coverage:this.coverageId,format:e,crs:"EPSG:"+a,bbox:l,width:c,height:f,interpolation:N[b],band:null===g||void 0===g?void 0:g.join(",")}};e.prototype._getCoverage110Parameters=function(a,c,f,b,d){var e=this,h=b.multidimensionalDefinition,g=b.bandIds,k=b.interpolation;b=a.spatialReference.wkid;var m="urn:ogc:def:crs:EPSG::"+b,q=x.find(this.coverageInfo.supportedFormats||[],
function(a){return-1<a.toLowerCase().indexOf("tiff")})||"image/tiff",k=this._getInterpolationIndex(k),r=O[k],k=d.domain.spatialDomain,n=k.origin.x<=k.envelope.xmin&&k.origin.y<=k.envelope.ymin,v=a.width/c,p=a.height/f*(n?1:-1);f=n?[a.xmin,a.ymin]:[a.xmin,a.ymax];f=(k=k.useEPSGAxis&&I.coordsReversed(b))?f[1]+","+f[0]:f[0]+","+f[1];c=k?p+",0,0,"+v:v+",0,0,"+p;var n=v/2,v=a.xmin+n,n=a.xmax-n,u=Math.abs(p)/2,p=a.ymin+u;a=a.ymax-u;a=k?p+","+v+","+a+","+n+","+m:v+","+p+","+n+","+a+","+m;var t=(k=d.range.filter(function(a){return a.axis.some(function(a){return-1<
a.identifier.toLowerCase().indexOf("band")})})[0])&&r&&g?k.identifier+":"+r+"["+k.axis[0].identifier+"["+g.join(",")+"]]":null,w;if(h)for(g=function(a){var b=h[a].values,c=h[a].dimensionName.toLowerCase(),f=h[a].variableName.toLowerCase();if(0<b.length)if(b[0]instanceof Array&&(b=b[0]),"stdtime"===c)w=b.map(function(a){return e._convertToISOTime(a)}).join(",");else if(a=d.range.filter(function(a){return a.identifier.toLowerCase()===f})[0]){var g=a.axis.filter(function(a){return a.identifier.toLowerCase()===
c})[0];g&&(t=a.identifier+":"+r+"["+g.identifier+"["+b.join(",")+"]]")}},k=0;k<h.length;k++)g(k);return{service:"WCS",request:"GetCoverage",version:this.version,identifier:this.coverageId,format:q,crs:"EPSG:"+b,boundingbox:a,gridCS:"urn:ogc:def:cs:OGC:0.0:Grid2dSquareCS",gridType:"urn:ogc:def:method:WCS:1.1:2dGridIn2dCrs",gridOrigin:f,gridOffsets:c,gridBaseCRS:m,timeSequence:w,rangeSubset:t}};e.prototype._convertToISOTime=function(a,c){void 0===c&&(c=!1);return(c?new Date(864E5*(a-25569)):new Date(a)).toISOString()};
e.prototype._getCoverage201Parameters=function(a,c,f,b,d){var h=this,e=b.multidimensionalDefinition,g=this._getInterpolationIndex(b.interpolation),g="http://www.opengis.net/def/interpolation/OGC/1/"+P[g],k=x.find(this.coverageInfo.supportedFormats||[],function(a){return-1<a.toLowerCase().indexOf("tiff")})||"image/tiff",m=this.coverageInfo.bandNames,q=d.boundedBy,r=d.domainSet,n=d.rangeType,v=q.isEastFirst?0:1,p=r.axisLabels;d=p[v];var v=p[1-v],u="http://www.opengis.net/def/crs/EPSG/0/"+a.spatialReference.wkid,
t=[];t.push(d+","+u+"("+a.xmin+","+a.xmax+")");t.push(v+","+u+"("+a.ymin+","+a.ymax+")");var w=[];if(2<p.length)for(a=2;a<p.length;a++){var y=r.origin[a];if(-1<p[a].toLowerCase().indexOf("time")){var z=y.toString();-1<q.uomLabels[a].toLowerCase().indexOf("ole")&&(w.push(p[a]),z=this._convertToISOTime(y,!0));t.push(p[a]+",http://www.opengis.net("+z+")")}else t.push(p[a]+",http://www.opengis.net("+y+")")}q=null;if(e){var B=[];n.forEach(function(a){return a.forEach(function(a){return B.push(a.name)})});
var C=[];b=function(a){var b=x.find(p,function(b){return b===e[a].dimensionName}),d=x.find(B,function(b){return b===e[a].variableName});-1===C.indexOf(d)&&C.push(d);if(b){var c=e[a].values;0<c.length&&(Array.isArray(c[0])&&(c=c[0]),d="",d=-1<b.toLowerCase().indexOf("time")?c.map(function(a){return h._convertToISOTime(a)}).join(","):c.join(","),c=x.findIndex(t,function(a){return 0===a.indexOf(b+",http://www.opengis.net")}),-1===c&&t.push(b+",http://www.opengis.net("+d+")"),-1!==c&&-1===t[c].indexOf("("+
d+")")&&t.splice(c,1,b+",http://www.opengis.net("+d+")"))}};for(a=0;a<e.length;a++)b(a);C.length&&(q=C.join(","))}else if(null===m||void 0===m?0:m.length)q=(b.bandIds?b.bandIds.map(function(a){return m[a]}):m).join(",");b=t.join("\x26subset\x3d");return{service:"WCS",request:"GetCoverage",version:this.version,coverageId:this.coverageId,rangesubset:q,interpolation:g,scaleSize:d+"("+c+"),"+v+"("+f+")",subset:b,format:k,outputcrs:u}};h.__decorate([z.property({type:String,json:{write:!0}})],e.prototype,
"datasetFormat",void 0);h.__decorate([z.property()],e.prototype,"tileType",void 0);h.__decorate([z.property({type:String,json:{write:!0}})],e.prototype,"version",void 0);h.__decorate([z.property({type:String,json:{write:!0}})],e.prototype,"coverageId",void 0);return e=h.__decorate([z.subclass("esri.layers.support.rasterDatasets.ImageServerRaster")],e)}(J)});