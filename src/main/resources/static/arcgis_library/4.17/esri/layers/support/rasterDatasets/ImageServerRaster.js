// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.17/esri/copyright.txt for details.
//>>built
define("require exports tslib ../../../geometry ../../../core/Error ../../../core/maybe ../../../core/promiseUtils ../../../core/promiseUtils ../../../core/urlUtils ../../../core/accessorSupport/decorators ../RasterInfo ../RasterStorageInfo ../serviceTileInfoProperty ../TileInfo ../TilemapCache ./BaseRaster ../rasterFunctions/pixelUtils ../../../tasks/support/FeatureSet".split(" "),function(U,V,g,w,D,J,K,L,M,G,I,N,O,P,Q,R,S,T){return function(H){function l(){var k=null!==H&&H.apply(this,arguments)||
this;k._levelOffset=0;k._slices=null;k._tilemapCache=null;k.datasetFormat="RasterTileServer";return k}g.__extends(l,H);l.prototype.open=function(k){return g.__awaiter(this,void 0,void 0,function(){var a,f,n,b,d,e,c,h,m,l,p,r,t,x,B,y,z,F,A,u,q,v,C,E,w;return g.__generator(this,function(g){switch(g.label){case 0:return[4,this.init()];case 1:g.sent();a=k&&k.signal;if(!this.sourceJSON)return[3,2];n={data:this.sourceJSON};return[3,4];case 2:return[4,this.request(this.url,{query:{f:"json"},signal:a})];
case 3:n=g.sent(),g.label=4;case 4:f=n;f.ssl&&(this.url=this.url.replace(/^http:/i,"https:"));this.sourceJSON=b=f.data;d="jpg jpeg png png8 png24 png32 mixed".split(" ");this.tileType=b.cacheType;null==this.tileType&&(-1<d.indexOf(b.tileInfo.format.toLowerCase())?this.tileType="Map":"lerc"===b.tileInfo.format.toLowerCase()?this.tileType="Elevation":this.tileType="Raster");if(!b)throw new D("imageserverraster:open","cannot initialize tiled image service, missing service info");if(!b.tileInfo)throw new D("imageserverraster:open",
"use ImageryLayer to open non-tiled image services");this.datasetName=b.name.slice(b.name.indexOf("/")+1);return[4,this._fetchRasterInfo({signal:a})];case 5:e=g.sent();if(J.isSome(e)){c="Map"===this.tileType?O.readServiceTileInfo(b.tileInfo,b,null):P.fromJSON(b.tileInfo);h=e.extent;m=e.pixelSize;l=.5/e.width*m.x;r=p=void 0;t=c.lodAt(Math.max.apply(null,c.lods.map(function(a){return a.level})));"Map"!==this.tileType&&0!==b.maxScale&&("Raster"===this.tileType?(p=c.lods.filter(function(a){return a.resolution===
m.x})[0])||(p=c.lods[c.lods.length-1]):(p=c.lods.filter(function(a){return Math.abs(a.scale-b.maxScale)<l})[0])||(p=c.lods.filter(function(a){return a.scale>b.maxScale}).sort(function(a,b){return a.scale>b.scale?1:-1})[0]),m.x=m.y=p.resolution,e.width=Math.ceil((h.xmax-h.xmin)/m.x-.1),e.height=Math.ceil((h.ymax-h.ymin)/m.y-.1));p||(p=t);x=c.lodAt(Math.min.apply(null,c.lods.map(function(a){return a.level})));"Map"===this.tileType?this._levelOffset=c.lods[0].level:0!==b.minScale&&"Elevation"===this.tileType&&
(r=c.lods.filter(function(a){return Math.abs(a.scale-b.minScale)<l})[0],this._levelOffset=r.level-x.level);r||(r=x);B=Math.max(m.x,m.y);if(Math.abs(m.x-m.y)>l||!c.lods.some(function(a){return Math.abs(a.resolution-B)<l}))m.x=m.y=p.resolution,e.width=Math.ceil((h.xmax-h.xmin)/m.x-.1),e.height=Math.ceil((h.ymax-h.ymin)/m.y-.1);y=p.level-r.level;z=c.size;F=z[0];A=z[1];u=c.origin;q=m.x;v=m.y;C=[{minCol:Math.floor((h.xmin-u.x+.1*q)/F/q),maxCol:Math.floor((h.xmax-u.x-.1*q)/F/q),minRow:Math.floor((u.y-h.ymax+
.1*v)/A/v),maxRow:Math.floor((u.y-h.ymin-.1*v)/A/v)}];if(0<y)for(E=0;E<y;E++)q*=2,v*=2,C.push({minCol:Math.floor((h.xmin-u.x+.1*q)/F/q),maxCol:Math.floor((h.xmax-u.x-.1*q)/F/q),minRow:Math.floor((u.y-h.ymax+.1*v)/A/q),maxRow:Math.floor((u.y-h.ymin-.1*v)/A/q)});e.storageInfo=new N({blockWidth:c.size[0],blockHeight:c.size[1],pyramidBlockWidth:c.size[0],pyramidBlockHeight:c.size[1],compression:c.format,origin:c.origin,firstPyramidLevel:1,maximumPyramidLevel:y,tileInfo:c,blockBoundary:C});this._set("rasterInfo",
e)}else throw new D("image-server-raster:open","cannot initialize image service");-1<b.capabilities.toLowerCase().indexOf("tilemap")&&(w={tileInfo:e.storageInfo.tileInfo,parsedUrl:M.urlToObject(this.url),url:this.url,tileServers:[],type:"tile"},this._tilemapCache=new Q.TilemapCache({layer:w}));return[2]}})})};l.prototype.fetchRawTile=function(k,a,f,n){void 0===n&&(n={});return g.__awaiter(this,void 0,void 0,function(){var b,d,e,c,h,m,l,p,r,t,x,B,y,z,w,A,u,q,v,C,E,D;return g.__generator(this,function(g){switch(g.label){case 0:return b=
this.rasterInfo,d=b.storageInfo,e=b.extent,c=b.pixelSize,h=d.maximumPyramidLevel-k+this._levelOffset,m=this.url+"/tile/"+h+"/"+a+"/"+f,l=this._slices?{sliceId:n.sliceId||0}:null,[4,this.request(m,{query:l,responseType:"array-buffer",signal:n.signal})];case 1:return(p=g.sent().data)?[4,this.decodePixelBlock(p,{width:d.tileInfo.size[0],height:d.tileInfo.size[1],planes:null,pixelType:null,isPoint:"Elevation"===this.tileType})]:[2,null];case 2:r=g.sent();t=d.blockBoundary[k];if("jpg"!==d.compression||
f>t.minCol&&f<t.maxCol&&a>t.minRow&&a<t.maxRow)return[2,r];x=d.origin;B=d.blockWidth;y=d.blockHeight;z=Math.pow(2,k);w=Math.round((e.xmin-x.x)/(c.x*z))%B;A=Math.round((e.xmax-x.x)/(c.x*z))%B;u=Math.round((x.y-e.ymax)/(c.x*z))%y;q=Math.round((x.y-e.ymin)/(c.x*z))%y;v=f===t.minCol?w:0;C=a===t.minRow?u:0;E=f===t.maxCol?A:B;D=a===t.maxRow?q:y;S.setValidBoundary(r,{x:v,y:C},{width:E-v,height:D-C});return[2,r]}})})};l.prototype.getSliceIndex=function(k){if(null===k||void 0===k||!k.length||!this._slices)return null;
for(var a=0;a<this._slices.length;a++){var f=this._slices[a].multidimensionalDefinition;if(f.length===k.length&&!f.some(function(a){var b=k.filter(function(b){return a.variableName===b.variableName&&b.dimensionName===a.dimensionName})[0];if(!b)return!0;var d=Array.isArray(a.values[0])?a.values[0][0]:a.values[0],b=Array.isArray(b.values[0])?b.values[0][0]:b.values[0];return d!==b}))return a}return null};l.prototype.fetchVariableStatisticsHistograms=function(k,a){return g.__awaiter(this,void 0,void 0,
function(){var f,n,b;return g.__generator(this,function(d){switch(d.label){case 0:return f=this.request(this.url+"/statistics",{query:{variable:k,f:"json"},signal:a}).then(function(a){var b;return null===(b=a.data)||void 0===b?void 0:b.statistics}),n=this.request(this.url+"/histograms",{query:{variable:k,f:"json"},signal:a}).then(function(a){var b;return null===(b=a.data)||void 0===b?void 0:b.histograms}),[4,L.all([f,n])];case 1:return b=d.sent(),b[0]&&b[0].forEach(function(a){a.avg=a.mean;a.stddev=
a.standardDeviation}),[2,{statistics:b[0]||null,histograms:b[1]||null}]}})})};l.prototype.computeBestPyramidLevelForLocation=function(k,a){void 0===a&&(a={});return g.__awaiter(this,void 0,void 0,function(){var f,n,b,d,e,c;return g.__generator(this,function(h){switch(h.label){case 0:if(!this._tilemapCache)return[2,0];f=this.identifyPixelLocation(k,0,a.datumTransformation);if(null===f)return[2,null];n=0;b=this.rasterInfo.storageInfo.maximumPyramidLevel;d=b-n+this._levelOffset;e=f.srcLocation;h.label=
1;case 1:if(!(0<=d))return[3,6];h.label=2;case 2:return h.trys.push([2,4,,5]),[4,this._tilemapCache.fetchAvailability(d,f.row,f.col,a)];case 3:return c=h.sent(),"available"===c?[3,6]:[3,5];case 4:return h.sent(),[3,5];case 5:return d--,n++,f=this.identifyPixelLocation(e,n,a.datumTransformation),null===f?[2,null]:[3,1];case 6:return-1===d||null==f?[2,null]:[2,n]}})})};l.prototype._fetchRasterInfo=function(k){return g.__awaiter(this,void 0,void 0,function(){var a,f,n,b,d,e,c,h,m,l,p,r,t=this;return g.__generator(this,
function(g){a=this.sourceJSON;f=Math.ceil((a.extent.xmax-a.extent.xmin)/a.pixelSizeX-.1);n=Math.ceil((a.extent.ymax-a.extent.ymin)/a.pixelSizeY-.1);b=w.SpatialReference.fromJSON(a.spatialReference||a.extent.spatialReference);if("Map"===this.tileType)return[2,new I({width:f,height:n,bandCount:3,extent:w.Extent.fromJSON(a.extent),spatialReference:b,pixelSize:new w.Point({x:a.pixelSizeX,y:a.pixelSizeY,spatialReference:b}),pixelType:"u8",statistics:null,keyProperties:{DataType:"processed"}})];d=k.slice;
e=k.signal;c=a.hasRasterAttributeTable?this.request(this.url+"/rasterAttributeTable",{query:{slice:d,f:"json"},signal:e}).then(function(a){return T.fromJSON(a.data)}).catch(function(){return null}):!1;h=a.hasColormap?this.request(this.url+"/colormap",{query:{slice:d,f:"json"},signal:e}).then(function(a){var b;return null===(b=a.data)||void 0===b?void 0:b.colormap}):!1;m=a.hasHistograms?this.request(this.url+"/histograms",{query:{slice:d,f:"json"},signal:e}).then(function(a){var b;return null===(b=
a.data)||void 0===b?void 0:b.histograms}):!1;l=this.request(this.url+"/keyProperties",{query:{f:"json"},signal:e}).then(function(a){return a.data}).catch(function(){});p=a.hasMultidimensions?this._fetchMultidimensionalInfo():!1;r=a.hasMultidimensions?this.request(this.url+"/slices",{query:{f:"json"},signal:e}).then(function(a){return a.data&&a.data.slices}).catch(function(){}):!1;return[2,K.all([c,h,m,l,p,r]).then(function(d){var c=null;if(a.minValues&&a.minValues.length===a.bandCount)for(var c=[],
e=0;e<a.minValues.length;e++)c.push({min:a.minValues[e],max:a.maxValues[e],avg:a.meanValues[e],stddev:a.stdvValues[e]});t._slices=d[5]||null;return new I({width:f,height:n,bandCount:a.bandCount,extent:w.Extent.fromJSON(a.extent),spatialReference:b,pixelSize:new w.Point({x:a.pixelSizeX,y:a.pixelSizeY,spatialReference:b}),pixelType:a.pixelType.toLowerCase(),statistics:c,attributeTable:d[0]||null,colormap:d[1]||null,histograms:d[2]||null,keyProperties:d[3]||{},multidimensionalInfo:d[4]||null})})]})})};
l.prototype._fetchMultidimensionalInfo=function(k){var a;return g.__awaiter(this,void 0,void 0,function(){var f;return g.__generator(this,function(g){switch(g.label){case 0:return[4,this.request(this.url+"/multidimensionalInfo",{query:{f:"json"},signal:k}).then(function(a){var b;return null===(b=a.data)||void 0===b?void 0:b.multidimensionalInfo})];case 1:return f=g.sent(),(null===(a=f.variables)||void 0===a?0:a.length)&&f.variables.forEach(function(a){var b;(null===(b=a.statistics)||void 0===b?0:
b.length)&&a.statistics.forEach(function(a){a.avg=a.mean;a.stddev=a.standardDeviation})}),[2,f]}})})};g.__decorate([G.property({type:String,json:{write:!0}})],l.prototype,"datasetFormat",void 0);g.__decorate([G.property()],l.prototype,"tileType",void 0);return l=g.__decorate([G.subclass("esri.layers.support.rasterDatasets.ImageServerRaster")],l)}(R)});