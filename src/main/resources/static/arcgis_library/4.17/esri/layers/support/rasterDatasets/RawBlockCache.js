// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.17/esri/copyright.txt for details.
//>>built
define(["require","exports","../../../geometry","./EphemeralBlockCache","../rasterFunctions/rasterProjectionHelper"],function(C,e,z,A,t){function B(a,b){if(!g.has(a))return null;a=g.get(a);return null==a[b]?null:a[b]}Object.defineProperty(e,"__esModule",{value:!0});e.update=e.deleteBlock=e.putBlock=e.getBlock=e.decreaseRefCount=e.deleteRaster=e.unregister=e.register=e.getRasterId=void 0;var g=new Map,h=new A;e.getRasterId=function(a,b){return null==b?a:a+"?sliceId\x3d"+b};e.register=function(a,b){b=
{extent:null,rasterInfo:b,cache:new Map};if(g.has(a))return a=g.get(a),a.push(b),a.length-1;g.set(a,[b]);return 0};e.unregister=function(a,b){g.has(a)&&(g.get(a)[b]=null)};e.deleteRaster=function(a){g.delete(a)};e.decreaseRefCount=function(a,b,c){if(!g.has(a))return null==b?h.decreaseRefCount(a,c):0;var d=g.get(a);if(null==d[b])return h.decreaseRefCount(a,c);b=d[b].cache;if(b.has(c)){a=b.get(c);a.refCount--;if(0===a.refCount){b.delete(c);for(b=0;b<d.length;b++)d[b]&&d[b].cache.has(c)&&d[b].cache.delete(c);
a.controller&&a.controller.abort()}return a.refCount}return 0};e.getBlock=function(a,b,c){if(!g.has(a))return null==b?h.getBlock(a,c):null;var d=g.get(a);if(null==d[b]){for(var f=0;f<d.length;f++)if(d[f]&&d[f].cache.has(c))return c=d[f].cache.get(c),c.refCount++,c.block;return h.getBlock(a,c)}a=d[b].cache;if(a.has(c))return c=a.get(c),c.refCount++,c.block;for(f=0;f<d.length;f++)if(f!==b&&d[f]&&d[f]&&d[f].cache.has(c))return b=d[f].cache.get(c),b.refCount++,a.set(c,b),b.block;return null};e.putBlock=
function(a,b,c,d,f){void 0===f&&(f=null);if(g.has(a)){var e=g.get(a);if(null==e[b])h.putBlock(a,c,d,f);else{var n={refCount:1,block:d,isResolved:!1,isRejected:!1,controller:f};d.then(function(){return n.isResolved=!0}).catch(function(){return n.isRejected=!0});e[b].cache.set(c,n)}}else null==b&&h.putBlock(a,c,d,f)};e.deleteBlock=function(a,b,c){if(g.has(a)){var d=g.get(a);null==d[b]?h.deleteBlock(a,c):d[b].cache.delete(c)}else null==b&&h.deleteBlock(a,c)};e.update=function(a,b,c,d,f,e,g){void 0===
g&&(g=null);a=B(a,b);var h=a.extent,n=a.cache;b=a.rasterInfo;if(!h||h.xmin!==c.xmin||h.xmax!==c.xmax||h.ymin!==c.ymin||h.ymax!==c.ymax){for(var h=c.clone().normalize(),v=b.spatialReference,w=new Set,u=0;u<h.length;u++){var k=h[u];if(!(k.xmax-k.xmin<=d||k.ymax-k.ymin<=d)){var l=t.projectExtent(k,v,g),p=new z.Point({x:d,y:d,spatialReference:k.spatialReference});if(null===f&&(f=t.projectResolution(p,v,k,g),!f))return;var p=t.snapPyramid(f,b,e||"closest"),k=p.pyramidLevel,m=p.pyramidResolution;if(p.excessiveReading)return;
for(var r=Math.max(0,Math.floor((l.xmin-b.storageInfo.origin.x)/m.x)),q=Math.max(0,Math.floor((b.storageInfo.origin.y-l.ymax)/m.y)),x=0<k?b.storageInfo.pyramidBlockWidth:b.storageInfo.blockWidth,y=0<k?b.storageInfo.pyramidBlockHeight:b.storageInfo.blockHeight,p=Math.max(0,Math.floor(r/x)-1),r=Math.floor((r+Math.ceil((l.xmax-l.xmin)/m.x-.1)-1)/x)+1,l=Math.floor((q+Math.ceil((l.ymax-l.ymin)/m.y-.1)-1)/y)+1,m=Math.max(0,Math.floor(q/y)-1);m<=l;m++)for(q=p;q<=r;q++)w.add(k+"/"+m+"/"+q)}}n.forEach(function(a,
b){w.has(b)||(a=n.get(b),(null==a||a.isResolved||a.isRejected)&&n.delete(b))});a.extent={xmin:c.xmin,ymin:c.ymin,xmax:c.xmax,ymax:c.ymax}}}});