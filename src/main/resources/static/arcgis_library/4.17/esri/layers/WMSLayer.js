// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.17/esri/copyright.txt for details.
//>>built
define("require exports tslib ../config ../Graphic ../PopupTemplate ../request ../core/Collection ../core/CollectionFlattener ../core/Handles ../core/jsonMap ../core/lang ../core/maybe ../core/MultiOriginJSONSupport ../core/promiseUtils ../core/urlUtils ../core/accessorSupport/decorators ../core/accessorSupport/write ../geometry/Extent ../geometry/SpatialReference ../geometry/support/scaleUtils ../geometry/support/spatialReferenceUtils ./Layer ./mixins/BlendLayer ./mixins/OperationalLayer ./mixins/PortalLayer ./mixins/RefreshableLayer ./mixins/ScaleRangeLayer ./mixins/TemporalLayer ./support/arcgisLayerUrl ./support/commonProperties ./support/ExportWMSImageParameters ./support/WMSSublayer ./support/wmsUtils".split(" "),
function(Z,aa,e,w,C,D,u,x,E,y,F,G,H,I,J,K,d,L,M,h,N,O,P,Q,R,S,T,U,V,W,z,X,p,m){function Y(e,b){return e.some(function(a){for(var f in a)if(L.willPropertyWrite(a,f,null,b))return!0;return!1})}function B(e,b,a){var f=new Map;e.every(function(c){return null==c.id})&&(e=G.clone(e),e.forEach(function(c,a){return c.id=a}));for(var c=0,k=e;c<k.length;c++){var d=k[c],g=new p;g.read(d,b);-1===(null===a||void 0===a?void 0:a.indexOf(g.name))&&(g.visible=!1);f.set(g.id,g)}b=[];for(a=0;a<e.length;a++)d=e[a],g=
f.get(d.id),null!=d.parentLayerId&&0<=d.parentLayerId?(d=f.get(d.parentLayerId),d.sublayers||(d.sublayers=new x),d.sublayers.unshift(g)):b.unshift(g);return b}var v=new F.JSONMap({bmp:"image/bmp",gif:"image/gif",jpg:"image/jpeg",png:"image/png",svg:"image/svg+xml"},{ignoreUnknown:!1});return function(A){function b(){for(var a=[],f=0;f<arguments.length;f++)a[f]=arguments[f];var c=A.apply(this,a)||this;c._sublayersHandles=new y;c.allSublayers=new E({root:c,rootCollectionNames:["sublayers"],getChildrenFunction:function(c){return c.sublayers}});
c.customParameters=null;c.customLayerParameters=null;c.copyright=null;c.description=null;c.dimensions=null;c.fullExtent=null;c.fullExtents=null;c.featureInfoFormat=null;c.featureInfoUrl=null;c.imageFormat=null;c.imageMaxHeight=2048;c.imageMaxWidth=2048;c.imageTransparency=!0;c.legendEnabled=!0;c.mapUrl=null;c.isReference=null;c.operationalLayerType="WMS";c.spatialReference=null;c.spatialReferences=null;c.sublayers=null;c.type="wms";c.url=null;c.version=null;c.watch("sublayers",function(a,f){f&&(f.forEach(function(c){c.layer=
null}),c._sublayersHandles.removeAll(),c._sublayersHandles=null);a&&(a.forEach(function(a){a.parent=c;a.layer=c}),c._sublayersHandles||(c._sublayersHandles=new y),c._sublayersHandles.add([a.on("after-add",function(a){a=a.item;a.parent=c;a.layer=c}),a.on("after-remove",function(a){a=a.item;a.parent=null;a.layer=null})]))},!0);return c}e.__extends(b,A);b.prototype.normalizeCtorArgs=function(a,f){return"string"===typeof a?e.__assign({url:a},f):a};b.prototype.destroy=function(){var a;null===(a=this._exportWMSImageParameters)||
void 0===a?void 0:a.destroy()};b.prototype.load=function(a){var f=this,c=H.isSome(a)?a.signal:null;this.addResolvingPromise(this.loadFromPortal({supportedTypes:["WMS"]},a).then(function(){return f._fetchService(c)},function(){return f._fetchService(c)}));return J.resolve(this)};b.prototype.readFullExtentFromItemOrMap=function(a,f){a=f.extent;return new M({xmin:a[0][0],ymin:a[0][1],xmax:a[1][0],ymax:a[1][1]})};b.prototype.writeFullExtent=function(a,f){f.extent=[[a.xmin,a.ymin],[a.xmax,a.ymax]]};b.prototype.readImageFormat=
function(a,f){return(a=f.supportedImageFormatTypes)&&-1<a.indexOf("image/png")?"image/png":a&&a[0]};b.prototype.readSpatialReferenceFromItemOrDocument=function(a,f){return new h(f.spatialReferences[0])};b.prototype.writeSpatialReferences=function(a,f){var c=this.spatialReference&&this.spatialReference.wkid;a&&c?(f.spatialReferences=a.filter(function(a){return a!==c}),f.spatialReferences.unshift(c)):f.spatialReferences=a};b.prototype.readSublayersFromItemOrMap=function(a,f,c){return B(f.layers,c,f.visibleLayers)};
b.prototype.readSublayers=function(a,f,c){return B(f.layers,c)};b.prototype.writeSublayers=function(a,f,c,b){f.layers=[];var d=new Map;a=a.flatten(function(a){return(a=a.sublayers)&&a.toArray()}).toArray();a.forEach(function(a){"number"===typeof a.parent.id&&(d.has(a.parent.id)?d.get(a.parent.id).push(a.id):d.set(a.parent.id,[a.id]))});a.forEach(function(a){var c=e.__assign({sublayer:a},b),k=a.write({parentLayerId:"number"===typeof a.parent.id?a.parent.id:-1},c);d.has(a.id)&&(k.sublayerIds=d.get(a.id));
!a.sublayers&&a.name&&(a=a.write({},c),delete a.id,f.layers.push(a))});f.visibleLayers=a.filter(function(a){return a.visible&&!a.sublayers}).map(function(a){return a.name})};b.prototype.createExportImageParameters=function(a,f,c,b){var e;c=b&&b.pixelRatio||1;f=N.getScale({extent:a,width:f})*c;null===(e=this._exportWMSImageParameters)||void 0===e?void 0:e.destroy();this._exportWMSImageParameters=new X({layer:this,extent:a,scale:f});return this._exportWMSImageParameters.toJSON()};b.prototype.fetchImage=
function(a,b,c,d){var f,g;return e.__awaiter(this,void 0,void 0,function(){var k,l,q,n,r,h,t;return e.__generator(this,function(p){k=this.mapUrl;l=this.createExportImageParameters(a,b,c,d);if(!l.layers)return q=document.createElement("canvas"),q.width=b,q.height=c,[2,q];n=null===(f=null===d||void 0===d?void 0:d.timeExtent)||void 0===f?void 0:f.start;r=null===(g=null===d||void 0===d?void 0:d.timeExtent)||void 0===g?void 0:g.end;h=n&&r?n.getTime()===r.getTime()?m.toISOString(n):m.toISOString(n)+"/"+
m.toISOString(r):void 0;t={responseType:"image",query:this._mixCustomParameters(e.__assign(e.__assign({width:b,height:c},l),{time:h})),signal:null===d||void 0===d?void 0:d.signal};if(null===d||void 0===d?0:d.timestamp)t.query=e.__assign({_ts:d.timestamp},t.query);return[2,u(k,t).then(function(a){return a.data})]})})};b.prototype.fetchFeatureInfo=function(a,b,c,d,h){var f=this,k=m.getPopupLayers(this._exportWMSImageParameters.visibleSublayers);if(!this.featureInfoUrl||!k)return null;d=e.__assign({query_layers:k,
request:"GetFeatureInfo",info_format:this.featureInfoFormat,feature_count:25,width:b,height:c},"1.3.0"===this.version?{I:d,J:h}:{x:d,y:h});var l=e.__assign(e.__assign({},this.createExportImageParameters(a,b,c)),d),l=this._mixCustomParameters(l);return u(this.featureInfoUrl,{query:l,responseType:"text"}).then(function(a){var c=f.featureInfoUrl,c=c+(-1===c.indexOf("?")?"?":""),b;for(b in l)c+="?"===c.substring(c.length-1,c.length)?"":"\x26",c+=b+"\x3d"+l[b];b=document.createElement("iframe");b.src=
c;b.frameBorder="0";b.marginHeight="0";b.marginWidth="0";b.innerHTML=a.data;b.style.width="100%";return new C({sourceLayer:f,popupTemplate:new D({title:f.title,content:b})})})};b.prototype.findSublayerById=function(a){return this.allSublayers.find(function(b){return b.id===a})};b.prototype.findSublayerByName=function(a){return this.allSublayers.find(function(b){return b.name===a})};b.prototype.supportsSpatialReference=function(a){return W.isWmsServer(this.url)||this.spatialReferences.some(function(b){b=
900913===b?h.WebMercator:new h({wkid:b});return O.equals(b,a)})};b.prototype._fetchService=function(a){return e.__awaiter(this,void 0,void 0,function(){var b,c;return e.__generator(this,function(d){switch(d.label){case 0:if(this.resourceInfo)return[3,2];this.parsedUrl.query&&this.parsedUrl.query.service&&(this.parsedUrl.query.SERVICE=this.parsedUrl.query.service,delete this.parsedUrl.query.service);this.parsedUrl.query&&this.parsedUrl.query.request&&(this.parsedUrl.query.REQUEST=this.parsedUrl.query.request,
delete this.parsedUrl.query.request);return[4,u(this.parsedUrl.path,{query:e.__assign(e.__assign({SERVICE:"WMS",REQUEST:"GetCapabilities"},this.parsedUrl.query),this.customParameters),responseType:"xml",signal:a})];case 1:b=d.sent(),this.resourceInfo=m.parseCapabilities(b.data),d.label=2;case 2:return this.parsedUrl&&(c=new K.Url(this.parsedUrl.path),"https"!==c.scheme||c.port&&"443"!==c.port||-1!==w.request.httpsDomains.indexOf(c.host)||w.request.httpsDomains.push(c.host)),this.read(this.resourceInfo,
{origin:"service"}),[2]}})})};b.prototype._mixCustomParameters=function(a){if(!this.customLayerParameters&&!this.customParameters)return a;var b=e.__assign(e.__assign({},this.customParameters),this.customLayerParameters),c;for(c in b)a[c.toLowerCase()]=b[c];return a};e.__decorate([d.property({readOnly:!0})],b.prototype,"allSublayers",void 0);e.__decorate([d.property({json:{type:Object,write:!0}})],b.prototype,"customParameters",void 0);e.__decorate([d.property({json:{type:Object,write:!0}})],b.prototype,
"customLayerParameters",void 0);e.__decorate([d.property({type:String,json:{write:!0}})],b.prototype,"copyright",void 0);e.__decorate([d.property()],b.prototype,"description",void 0);e.__decorate([d.property({readOnly:!0})],b.prototype,"dimensions",void 0);e.__decorate([d.property({json:{type:[[Number]],read:{source:"extent"},write:{target:"extent"},origins:{service:{read:{source:"extent"}}}}})],b.prototype,"fullExtent",void 0);e.__decorate([d.reader(["web-document","portal-item"],"fullExtent",["extent"])],
b.prototype,"readFullExtentFromItemOrMap",null);e.__decorate([d.writer(["web-document","portal-item"],"fullExtent",{extent:{type:[[Number]]}})],b.prototype,"writeFullExtent",null);e.__decorate([d.property()],b.prototype,"fullExtents",void 0);e.__decorate([d.property({type:String,json:{write:{ignoreOrigin:!0}}})],b.prototype,"featureInfoFormat",void 0);e.__decorate([d.property({type:String,json:{write:{ignoreOrigin:!0}}})],b.prototype,"featureInfoUrl",void 0);e.__decorate([d.property({type:String,
json:{origins:{"web-document":{default:"image/png",type:v.jsonValues,read:{reader:v.read,source:"format"},write:{writer:v.write,target:"format"}}}}})],b.prototype,"imageFormat",void 0);e.__decorate([d.reader("imageFormat",["supportedImageFormatTypes"])],b.prototype,"readImageFormat",null);e.__decorate([d.property({type:Number,json:{read:{source:"maxHeight"},write:{target:"maxHeight"}}})],b.prototype,"imageMaxHeight",void 0);e.__decorate([d.property({type:Number,json:{read:{source:"maxWidth"},write:{target:"maxWidth"}}})],
b.prototype,"imageMaxWidth",void 0);e.__decorate([d.property()],b.prototype,"imageTransparency",void 0);e.__decorate([d.property(z.legendEnabled)],b.prototype,"legendEnabled",void 0);e.__decorate([d.property({type:["show","hide","hide-children"]})],b.prototype,"listMode",void 0);e.__decorate([d.property({type:String,json:{write:{ignoreOrigin:!0}}})],b.prototype,"mapUrl",void 0);e.__decorate([d.property({type:Boolean,json:{read:!1,write:{enabled:!0,overridePolicy:function(){return{enabled:!1}}}}})],
b.prototype,"isReference",void 0);e.__decorate([d.property({type:["WMS"]})],b.prototype,"operationalLayerType",void 0);e.__decorate([d.property({type:h,json:{origins:{service:{read:{source:"extent.spatialReference"}}},write:!1}})],b.prototype,"spatialReference",void 0);e.__decorate([d.reader(["web-document","portal-item"],"spatialReference",["spatialReferences"])],b.prototype,"readSpatialReferenceFromItemOrDocument",null);e.__decorate([d.property({type:[Number],json:{read:{source:"spatialReferences"},
write:{ignoreOrigin:!0}}})],b.prototype,"spatialReferences",void 0);e.__decorate([d.writer(["web-document","portal-item"],"spatialReferences")],b.prototype,"writeSpatialReferences",null);e.__decorate([d.property({type:x.ofType(p),json:{write:{target:"layers",overridePolicy:function(a,b,c){if(Y(this.allSublayers,c))return{ignoreOrigin:!0}}}}})],b.prototype,"sublayers",void 0);e.__decorate([d.reader(["web-document","portal-item"],"sublayers",["layers","visibleLayers"])],b.prototype,"readSublayersFromItemOrMap",
null);e.__decorate([d.reader("service","sublayers",["layers"])],b.prototype,"readSublayers",null);e.__decorate([d.writer("sublayers",{layers:{type:[p]},visibleLayers:{type:[String]}})],b.prototype,"writeSublayers",null);e.__decorate([d.property({json:{read:!1},readOnly:!0,value:"wms"})],b.prototype,"type",void 0);e.__decorate([d.property(z.url)],b.prototype,"url",void 0);e.__decorate([d.property({type:String,json:{write:{ignoreOrigin:!0}}})],b.prototype,"version",void 0);return b=e.__decorate([d.subclass("esri.layers.WMSLayer")],
b)}(Q.BlendLayer(V.TemporalLayer(T.RefreshableLayer(U.ScaleRangeLayer(R.OperationalLayer(S.PortalLayer(I.MultiOriginJSONMixin(P))))))))});