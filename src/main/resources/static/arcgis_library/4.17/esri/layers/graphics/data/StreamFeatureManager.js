// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.17/esri/copyright.txt for details.
//>>built
define(["require","exports","../../../core/CircularArray","../../../core/mathUtils","../../../core/maybe"],function(k,e,l,m,f){Object.defineProperty(e,"__esModule",{value:!0});e.ESRI_TIMESTAMP=e.DEFAULT_STREAM_ID_FIELD=void 0;e.DEFAULT_STREAM_ID_FIELD="__esri_stream_id__";e.ESRI_TIMESTAMP="__esri_timestamp__";k=function(){function c(a,b,d,h,g){void 0===g&&(g=128);this._trackIdToObservations=new Map;this._idCounter=0;this._lastPurge=performance.now();this._addOrUpdated=new Map;this._removed=[];this._maxAge=
0;this._timeInfo=d;this._purgeOptions=h;this.store=a;this.objectIdField=b;this.purgeInterval=g;this._useGeneratedIds=this.objectIdField===e.DEFAULT_STREAM_ID_FIELD}c.prototype.add=function(a){if(this._useGeneratedIds){var b=this._nextId();a.attributes[this.objectIdField]=b;a.objectId=b}this._addOrUpdated.set(a.objectId,a);this._maxAge=Math.max(this._maxAge,a.attributes[this._timeInfo.startTimeField]);if(this._timeInfo.trackIdField){b=a.attributes[this._timeInfo.trackIdField];if(!this._trackIdToObservations.has(b)){var d=
f.isSome(this._purgeOptions)&&null!=this._purgeOptions.maxObservations?this._purgeOptions.maxObservations:1E3,d=m.clamp(d,0,1E3);this._trackIdToObservations.set(b,new l.default(d))}a=this._trackIdToObservations.get(b).enqueue(a.objectId);f.isSome(a)&&(this._addOrUpdated.has(a)?this._addOrUpdated.delete(a):this._removed.push(a))}};c.prototype.checkForUpdates=function(){var a=this._getToAdd(),b=this._getToRemove(),d=performance.now();d-this._lastPurge>=this.purgeInterval&&(this._purge(d),this._lastPurge=
d);var h=[];if(f.isSome(b))for(var g=0;g<b.length;g++){var c=this.store.removeById(b[g]);f.isSome(c)&&h.push(c)}if(f.isSome(a))for(b=0;b<a.length;b++)c=a[b],c.attributes[e.ESRI_TIMESTAMP]=d,this.store.add(c);(a||h)&&this.store.update(a,h)};c.prototype._getToAdd=function(){if(!this._addOrUpdated.size)return null;var a=Array(this._addOrUpdated.size),b=0;this._addOrUpdated.forEach(function(d){return a[b++]=d});this._addOrUpdated.clear();return a};c.prototype._getToRemove=function(){var a=this._removed;
if(!this._removed.length)return null;this._removed=[];return a};c.prototype._nextId=function(){var a=this._idCounter;this._idCounter=(this._idCounter+1)%4294967294+1;return a};c.prototype._purge=function(a){var b=this._purgeOptions;f.isSome(b)&&(this._purgeSomeByDisplayCount(b),this._purgeByAge(b),this._purgeByAgeReceived(a,b),this._purgeTracks())};c.prototype._purgeSomeByDisplayCount=function(a){var b=this;if(a.displayCount){var d=this.store.size;d>a.displayCount&&this._trackIdToObservations.forEach(function(c){d>
a.displayCount&&c.size&&(c=f.unwrap(c.dequeue()),b._removed.push(c),d--)})}};c.prototype._purgeByAge=function(a){var b=this,d;if(a.age&&null!==(d=this._timeInfo)&&void 0!==d&&d.startTimeField){var c=this._maxAge-6E4*a.age;this.store.forEach(function(a){a.attributes[b._timeInfo.startTimeField]<c&&b._removed.push(a.objectId)})}};c.prototype._purgeByAgeReceived=function(a,b){var c=this;if(b.ageReceived){var f=a+6E4*b.ageReceived;this.store.forEach(function(a){a.attributes[e.ESRI_TIMESTAMP]<f&&c._removed.push(a.objectId)})}};
c.prototype._purgeTracks=function(){var a=this;this._trackIdToObservations.forEach(function(b,c){0===b.size&&a._trackIdToObservations.delete(c)})};return c}();e.default=k});