// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.17/esri/copyright.txt for details.
//>>built
define("require exports ../../../core/Error ../../../core/promiseUtils ../../../core/promiseUtils ./Zlib".split(" "),function(x,y,p,r,v,m){return function(){function e(a){a&&(this.canvas=a.canvas,this.ctx=a.ctx||a.canvas&&a.canvas.getContext("2d"))}e.prototype.decode=function(a,g,w){var b=this;if(!a||10>a.byteLength)throw new p("imagecanvasdecoder: decode","required a valid encoded data as input.");var d=g.width,f=g.height,k=g.format,t=g.applyJpegMask;if(t&&(!d||!f))throw new p("imagecanvasdecoder: decode",
"image width and height are needed to apply jpeg mask directly to canvas");return r.create(function(p,u){var l=null;"jpg"===k&&t&&(l=e.getMask(a,g));var m=new Blob([new Uint8Array(a)],{type:"jpg"==="image/"+k?"jpeg":k}),q=URL.createObjectURL(m),n=new Image,h;n.src=q;n.onload=function(){URL.revokeObjectURL(q);if(r.isAborted(w))u(v.createAbortError());else{d=n.width;f=n.height;if(b.canvas){if(b.canvas.width!==d||b.canvas.height!==f)b.canvas.width=d,b.canvas.height=f;b.ctx.clearRect(0,0,d,f)}else b.canvas=
document.createElement("canvas"),b.canvas.width=d,b.canvas.height=f,b.ctx=b.canvas.getContext("2d");b.ctx.drawImage(n,0,0);var a=b.ctx.getImageData(0,0,d,f);h=a.data;var c;if(g.renderOnCanvas){if(l)for(c=0;c<l.length;c++)h[4*c+3]=l[c]?255:0;b.ctx.putImageData(a,0,0);p(null)}else{var a=d*f,e=new Uint8Array(a),k=new Uint8Array(a),m=new Uint8Array(a);if(l)for(c=0;c<a;c++)e[c]=h[4*c],k[c]=h[4*c+1],m[c]=h[4*c+2];else for(l=new Uint8Array(a),c=0;c<a;c++)e[c]=h[4*c],k[c]=h[4*c+1],m[c]=h[4*c+2],l[c]=h[4*
c+3];p({width:d,height:f,pixels:[e,k,m],mask:l,pixelType:"u8"})}}};n.onerror=function(){URL.revokeObjectURL(q);u("cannot load image")}})};e.getMask=function(a,g){var e=null;try{var b=new Uint8Array(a);a=0;var d=b.length-2;for(a=Math.ceil(b.length/2);a<d&&(255!==b[a]||217!==b[a+1]);a++);a+=2;if(a<b.length-1)for(var f=(new m(b.subarray(a))).getBytes(),e=new Uint8Array(g.width*g.height),b=g=0;b<f.length;b++)for(d=7;0<=d;d--)e[g++]=f[b]>>d&1}catch(k){}return e};return e}()});