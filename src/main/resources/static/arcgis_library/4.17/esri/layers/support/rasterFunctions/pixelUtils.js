// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.17/esri/copyright.txt for details.
//>>built
define(["require","exports","../PixelBlock"],function(S,n,B){function O(a,e){a=Math.min(Math.max(a,-100),100);e=Math.min(Math.max(e,-100),100);var c,h,d=new Uint8Array(256);for(c=0;256>c;c++)0<a&&100>a?h=(200*c-25500+510*e)/(2*(100-a))+128:0>=a&&-100<a?h=(200*c-25500+510*e)*(100+a)/2E4+128:100===a?(h=200*c-25500+256*(100-a)+510*e,h=0<h?255:0):-100===a&&(h=128),d[c]=255<h?255:0>h?0:h;return d}function N(a,e,c,h,d,m,g,k){return{xmin:d<=c*a?0:d<c*a+a?d-c*a:a,ymin:m<=h*e?0:m<h*e+e?m-h*e:e,xmax:d+g<=c*
a?0:d+g<c*a+a?d+g-c*a:a,ymax:m+k<=h*e?0:m+k<h*e+e?m+k-h*e:e}}function P(a,e,c,h){var d=a.filter(function(a){return C(a)})[0];if(null==d)return null;var m=h?h.width:e.width;h=h?h.height:e.height;var g=d.width,k=d.height,f=e.width/g;e=e.height/k;var l=c?c.x:0;c=c?c.y:0;var b=d.pixelType,p=B.getPixelArrayConstructor(b),q=d.pixels.length,d=[],r,n,v,t,u,w,z,y,x,A;for(u=0;u<q;u++){n=new p(m*h);for(w=0;w<e;w++)for(z=0;z<f;z++)if(v=a[w*f+z])for(r=v.pixels[u],A=N(g,k,z,w,l,c,m,h),y=A.ymin;y<A.ymax;y++)for(v=
(w*k+y-c)*m+(z*g-l),t=y*g,x=A.xmin;x<A.xmax;x++)n[v+x]=r[t+x];d.push(n)}var D;if(a.some(function(a){return null==a||a.mask&&0<a.mask.length}))for(D=new Uint8Array(m*h),w=0;w<e;w++)for(z=0;z<f;z++)if(p=(v=a[w*f+z])?v.mask:null,A=N(g,k,z,w,l,c,m,h),p)for(y=A.ymin;y<A.ymax;y++)for(v=(w*k+y-c)*m+(z*g-l),t=y*g,x=A.xmin;x<A.xmax;x++)D[v+x]=p[t+x];else if(v)for(y=A.ymin;y<A.ymax;y++)for(v=(w*k+y-c)*m+(z*g-l),t=y*g,x=A.xmin;x<A.xmax;x++)D[v+x]=1;else for(y=A.ymin;y<A.ymax;y++)for(v=(w*k+y-c)*m+(z*g-l),t=
y*g,x=A.xmin;x<A.xmax;x++)D[v+x]=0;a=new B({width:m,height:h,pixels:d,pixelType:b,mask:D});a.updateStatistics();return a}function Q(a){if(!C(a))return null;var e=a.clone(),c=a.width,h=a.height,d=a.mask;a=a.pixels[0];for(var m=e.pixels[0],g=2;g<h-1;g++){for(var k=new Map,f=g-2;f<g+2;f++)for(var l=0;4>l;l++){var b=f*c+l;G(k,a[b],d?d[b]:1)}m[g*c]=R(k);m[g*c+1]=m[g*c+2]=m[g*c];for(f=3;f<c-1;f++)b=(g-2)*c+f+1,G(k,a[b],d?d[b]:1),b=(g-1)*c+f+1,G(k,a[b],d?d[b]:1),b=g*c+f+1,G(k,a[b],d?d[b]:1),b=(g+1)*c+f+
1,G(k,a[b],d?d[b]:1),b=(g-2)*c+f-3,H(k,a[b],d?d[b]:1),b=(g-1)*c+f-3,H(k,a[b],d?d[b]:1),b=g*c+f-3,H(k,a[b],d?d[b]:1),b=(g+1)*c+f-3,H(k,a[b],d?d[b]:1),m[g*c+f]=R(k);m[g*c+f+1]=m[g*c+f]}for(f=0;f<c;f++)m[f]=m[c+f]=m[2*c+f],m[(h-1)*c+f]=m[(h-2)*c+f];e.updateStatistics();return e}function R(a){if(0===a.size)return 0;for(var e=0,c=-1,h=0,d=a.keys(),m=d.next();!m.done;)h=a.get(m.value),h>e&&(c=m.value,e=h),m=d.next();return c}function H(a,e,c){0!==c&&(c=a.get(e),1===c?a.delete(e):a.set(e,c-1))}function G(a,
e,c){0!==c&&a.set(e,a.has(e)?a.get(e)+1:1)}Object.defineProperty(n,"__esModule",{value:!0});n.approximateTransform=n.clip=n.resampleByMajority=n.setValidBoundary=n.mosaic=n.mosaicPixelData=n.getClipBounds=n.remapColor=n.lookupPixels=n.stretch=n.createContrastBrightnessLUT=n.createStretchLUT=n.estimateStatisticsFromHistograms=n.estimateStatisticsHistograms=n.colorize=n.createColormapLUT=n.extractBands=void 0;var C=function(a){return a&&"esri.layers.support.PixelBlock"===a.declaredClass&&a.pixels&&
0<a.pixels.length};n.extractBands=function(a,e){if(!e||!C(a))return a;var c=a.pixels.length;return e&&e.some(function(a){return a>=c})||1===c&&1===e.length&&0===e[0]||c===e.length&&!e.some(function(a,c){return a!==c})?a:new B({pixelType:a.pixelType,width:a.width,height:a.height,mask:a.mask,validPixelCount:a.validPixelCount,maskIsAlpha:a.maskIsAlpha,pixels:e.map(function(c){return a.pixels[c]}),statistics:a.statistics&&e.map(function(c){return a.statistics[c]})})};n.createColormapLUT=function(a){if(a){var e=
a.colormap;if(e&&0!==e.length){var e=e.sort(function(a,b){return a[0]-b[0]}),c=0;0>e[0][0]&&(c=e[0][0]);var h=Math.max(256,e[e.length-1][0]-c+1),d=new Uint8Array(4*h),m=[],g=0,k=0,f=5===e[0].length;if(65536<h)return e.forEach(function(a){m[a[0]-c]=f?a.slice(1):a.slice(1).concat([255])}),{indexed2DColormap:m,offset:c,alphaSpecified:f};if(a.fillUnspecified)for(a=e[k],g=a[0]-c;g<h;g++)d[4*g]=a[1],d[4*g+1]=a[2],d[4*g+2]=a[3],d[4*g+3]=f?a[4]:255,g===a[0]-c&&(a=k===e.length-1?a:e[++k]);else for(g=0;g<e.length;g++)a=
e[g],k=4*(a[0]-c),d[k]=a[1],d[k+1]=a[2],d[k+2]=a[3],d[k+3]=f?a[4]:255;return{indexedColormap:d,offset:c,alphaSpecified:f}}}};n.colorize=function(a,e){if(!C(a)||!e&&(e.indexedColormap||e.indexed2DColormap))return a;var c=a.clone(),h=c.pixels,d=c.mask,m=c.width*c.height;if(1!==h.length)return a;var g=e.indexedColormap;a=e.indexed2DColormap;var k=e.offset;e=e.alphaSpecified;var f=g.length-1,l=0,h=h[0],b=new Uint8Array(h.length),p=new Uint8Array(h.length),q=new Uint8Array(h.length),r=0;if(g)if(d)for(l=
0;l<m;l++)d[l]&&(r=4*(h[l]-k),r<k||r>f?d[l]=0:(b[l]=g[r],p[l]=g[r+1],q[l]=g[r+2],d[l]=g[r+3]));else{d=new Uint8Array(m);for(l=0;l<m;l++)r=4*(h[l]-k),r<k||r>f?d[l]=0:(b[l]=g[r],p[l]=g[r+1],q[l]=g[r+2],d[l]=g[r+3]);c.mask=d}else if(d)for(l=0;l<m;l++)d[l]&&(g=a[h[l]],b[l]=g[0],p[l]=g[1],q[l]=g[2],d[l]=g[3]);else{d=new Uint8Array(m);for(l=0;l<m;l++)g=a[h[l]],b[l]=g[0],p[l]=g[1],q[l]=g[2],d[l]=g[3];c.mask=d}c.pixels=[b,p,q];c.statistics=null;c.pixelType="u8";c.maskIsAlpha=e;return c};n.estimateStatisticsHistograms=
function(a){if(!C(a))return null;a.statistics||a.updateStatistics();var e=a.pixels,c=a.mask,h=a.pixelType,d=a.statistics;a=a.width*a.height;var m=e.length,g,k,f,l,b,p=[],q=[],r,n,v;for(l=0;l<m;l++){r=new Uint32Array(256);v=e[l];if("u8"===h)if(g=-.5,k=255.5,c)for(b=0;b<a;b++)c[b]&&r[v[b]]++;else for(b=0;b<a;b++)r[v[b]]++;else{g=d[l].minValue;k=d[l].maxValue;f=(k-g)/256;n=new Uint32Array(257);if(c)for(b=0;b<a;b++)c[b]&&n[Math.floor((v[b]-g)/f)]++;else for(b=0;b<a;b++)n[Math.floor((v[b]-g)/f)]++;for(b=
0;255>b;b++)r[b]=n[b];r[255]=n[255]+n[256]}p.push({min:g,max:k,size:256,counts:r});for(b=v=n=f=0;256>b;b++)f+=r[b],n+=b*r[b];n/=f;for(b=0;256>b;b++)v+=r[b]*Math.pow(b-n,2);r=Math.sqrt(v/(f-1));f=(k-g)/256;b=(n+.5)*f+g;r*=f;q.push({min:g,max:k,avg:b,stddev:r})}return{statistics:q,histograms:p}};n.estimateStatisticsFromHistograms=function(a){for(var e=[],c=0;c<a.length;c++){for(var h=a[c],d=h.min,m=h.max,g=h.size,k=h.counts,f=h=0,l=0;l<g;l++)h+=k[l],f+=l*k[l];for(var f=f/h,b=0,l=0;l<g;l++)b+=k[l]*Math.pow(l-
f,2);g=(m-d)/g;e.push({min:d,max:m,avg:(f+.5)*g+d,stddev:Math.sqrt(b/(h-1))*g})}return e};n.createStretchLUT=function(a){var e=a.minCutOff,c=a.maxCutOff,h=a.gamma,d=a.pixelType,m=a.outMin||0,g=a.outMax||255;if(-1===["u8","u16","s8","s16"].indexOf(d))return null;var k=e.length,f,l=0;"s8"===d?l=-127:"s16"===d&&(l=-32767);var b=256;-1<["u16","s16"].indexOf(d)&&(b=65536);for(var p=[],q=g-m,d=0;d<k;d++)p[d]=c[d]-e[d];f=h&&h.length>=k;var r=[];if(f)for(d=0;d<k;d++)r[d]=1<h[d]?2<h[d]?6.5+Math.pow(h[d]-2,
2.5):6.5+100*Math.pow(2-h[d],4):1;var n,v=[],t,u,w;if(f)for(d=0;d<k;d++){w=[];for(f=0;f<b;f++)t=f+l,n=(t-e[d])/p[d],u=1,1<h[d]&&(u-=Math.pow(1/q,n*r[d])),w[f]=t<c[d]&&t>e[d]?Math.floor(u*q*Math.pow(n,1/h[d]))+m:t>=c[d]?g:m;v[d]=w}else for(d=0;d<k;d++){w=[];for(f=0;f<b;f++)t=f+l,w[f]=t<=e[d]?m:t>=c[d]?g:Math.floor((t-e[d])/p[d]*q)+m;v[d]=w}if(null!=a.contrastOffset)for(a=O(a.contrastOffset,a.brightnessOffset),d=0;d<k;d++)for(w=v[d],f=0;f<b;f++)w[f]=a[w[f]];return{lut:v,offset:l}};n.createContrastBrightnessLUT=
O;n.stretch=function(a,e){if(!C(a))return null;a=a.clone();var c=a.pixels,h=a.mask,d=e.minCutOff,m=e.maxCutOff,g=e.gamma,k=e.outMin||0;e=e.outMax||255;var f=a.width*a.height,l=c.length,b,p,q,r,n,v=e-k,t=[];for(b=0;b<l;b++)t[b]=m[b]-d[b];p=g&&g.length>=l;var u=[];if(p)for(b=0;b<l;b++)u[b]=1<g[b]?2<g[b]?6.5+Math.pow(g[b]-2,2.5):6.5+100*Math.pow(2-g[b],4):1;if(p)if(null!=h)for(p=0;p<f;p++){if(h[p])for(b=0;b<l;b++)q=c[b][p],n=(q-d[b])/t[b],r=1,1<g[b]&&(r-=Math.pow(1/v,n*u[b])),c[b][p]=q<m[b]&&q>d[b]?
Math.floor(r*v*Math.pow(n,1/g[b]))+k:q>=m[b]?e:k}else for(p=0;p<f;p++)for(b=0;b<l;b++)q=c[b][p],n=(q-d[b])/t[b],r=1,1<g[b]&&(r-=Math.pow(1/v,n*u[b])),c[b][p]=q<m[b]&&q>d[b]?Math.floor(r*v*Math.pow(n,1/g[b]))+k:q>=m[b]?e:k;else if(null!=h)for(p=0;p<f;p++){if(h[p])for(b=0;b<l;b++)q=c[b][p],c[b][p]=q<m[b]&&q>d[b]?Math.floor((q-d[b])/t[b]*v)+k:q>=m[b]?e:k}else for(p=0;p<f;p++)for(b=0;b<l;b++)q=c[b][p],c[b][p]=q<m[b]&&q>d[b]?Math.floor((q-d[b])/t[b]*v)+k:q>=m[b]?e:k;a.pixelType="u8";a.updateStatistics();
return a};n.lookupPixels=function(a,e){if(!C(a))return null;var c=a.pixels,h=a.mask,d=a.width*a.height,m=c.length,g=e.lut;e=e.offset;var k,f;g&&1===g[0].length&&(g=c.map(function(){return g}));var l=[],b,p,q;if(e)if(null==h)for(k=0;k<m;k++){b=c[k];p=g[k];q=new Uint8Array(d);for(f=0;f<d;f++)q[f]=p[b[f]-e];l.push(q)}else for(k=0;k<m;k++){b=c[k];p=g[k];q=new Uint8Array(d);for(f=0;f<d;f++)h[f]&&(q[f]=p[b[f]-e]);l.push(q)}else if(null==h)for(k=0;k<m;k++){b=c[k];p=g[k];q=new Uint8Array(d);for(f=0;f<d;f++)q[f]=
p[b[f]];l.push(q)}else for(k=0;k<m;k++){b=c[k];p=g[k];q=new Uint8Array(d);for(f=0;f<d;f++)h[f]&&(q[f]=p[b[f]]);l.push(q)}a=new B({width:a.width,height:a.height,pixels:l,mask:h,pixelType:"u8"});a.updateStatistics();return a};n.remapColor=function(a,e){if(!C(a))return null;a=a.clone();var c=a.width*a.height,h=e.length,d=Math.floor(h/2),m=e[Math.floor(d)],g=a.pixels[0],k,f,l,b,p,q,n=!1,B=new Uint8Array(c),v=new Uint8Array(c),t=new Uint8Array(c),u=a.mask,w=4===e[0].mappedColor.length;u||(u=new Uint8Array(c),
u.fill(w?255:1),a.mask=u);for(p=0;p<c;p++)if(u[p]){k=g[p];n=!1;q=d;f=m;l=0;for(b=h-1;1<b-l;){if(k===f.value){n=!0;break}k>f.value?l=q:b=q;q=Math.floor((l+b)/2);f=e[Math.floor(q)]}n||(k===e[l].value?(f=e[l],n=!0):k===e[b].value?(f=e[b],n=!0):k<e[l].value?(n=!1,f=null):k>e[l].value&&(k<e[b].value?(f=e[l],n=!0):b===h-1?(n=!1,f=null):(f=e[b],n=!0)));n?(B[p]=f.mappedColor[0],v[p]=f.mappedColor[1],t[p]=f.mappedColor[2],u[p]=f.mappedColor[3]):B[p]=v[p]=t[p]=u[p]=0}a.pixels=[B,v,t];a.mask=u;a.pixelType="u8";
a.maskIsAlpha=w;return a};n.getClipBounds=N;n.mosaicPixelData=function(a,e){if(!a||0===a.length)return null;var c=a.filter(function(a){return a.pixelBlock})[0];if(!c)return null;var h=(c.extent.xmax-c.extent.xmin)/c.pixelBlock.width,d=(c.extent.ymax-c.extent.ymin)/c.pixelBlock.height,m=.01*Math.min(h,d),g=a.sort(function(a,b){return Math.abs(a.extent.ymax-b.extent.ymax)>m?b.extent.ymax-a.extent.ymax:Math.abs(a.extent.xmin-b.extent.xmin)>m?a.extent.xmin-b.extent.xmin:0}),k=Math.min.apply(null,g.map(function(a){return a.extent.xmin})),
f=Math.min.apply(null,g.map(function(a){return a.extent.ymin})),l=Math.max.apply(null,g.map(function(a){return a.extent.xmax})),b=Math.max.apply(null,g.map(function(a){return a.extent.ymax}));a={x:Math.round((e.xmin-k)/h),y:Math.round((b-e.ymax)/d)};k={width:Math.round((l-k)/h),height:Math.round((b-f)/d)};h={width:Math.round((e.xmax-e.xmin)/h),height:Math.round((e.ymax-e.ymin)/d)};if(Math.round(k.width/c.pixelBlock.width)*Math.round(k.height/c.pixelBlock.height)!==g.length||0>a.x||0>a.y||k.width<
h.width||k.height<h.height)return null;c=g.map(function(a){return a.pixelBlock});c=P(c,k,a,h);return{extent:e,pixelBlock:c}};n.mosaic=P;n.setValidBoundary=function(a,e,c){if(!C(a))return null;var h=a.width,d=a.height,m=e.x;e=e.y;var g=c.width+m;c=c.height+e;if(0>m||0>e||g>h||c>d||0===m&&0===e&&g===h&&c===d)return a;a.mask||(a.mask=new Uint8Array(h*d));for(var k=a.mask,f=0;f<d;f++)for(var l=f*h,b=0;b<h;b++)k[l+b]=f<e||f>=c||b<m||b>=g?0:1;a.updateStatistics();return a};n.resampleByMajority=Q;n.clip=
function(a,e,c){var h=e.x;e=e.y;var d=c.width,m=c.height;if(0===h&&0===e&&m===a.height&&d===a.width)return a;var g=a.width,k=Math.max(0,e),f=Math.max(0,h),l=Math.min(h+d,g),b=Math.min(e+m,a.height);if(0>l||0>b||!C(a))return null;h=Math.max(0,-h);e=Math.max(0,-e);for(var p=a.pixels,n=a.mask,r=d*m,G=p.length,m=[],v=0;v<G;v++){for(var t=p[v],u=B.createEmptyBand(a.pixelType,r),w=k;w<b;w++)for(var z=w*g,y=(w+e)*d+h,x=f;x<l;x++)u[y++]=t[z+x];m.push(u)}a=new Uint8Array(r);for(w=k;w<b;w++)for(z=w*g,y=(w+
e)*d+h,x=f;x<l;x++)a[y++]=n?n[z+x]:1;c=new B({width:c.width,height:c.height,pixels:m,mask:a});c.updateStatistics();return c};n.approximateTransform=function(a,e,c,h,d){void 0===d&&(d="nearest");if(!C(a))return null;"majority"===d&&(a=Q(a));var m=a.pixels,g=a.mask,k=a.pixelType,f=a.width,l=a.height;a=B.getPixelArrayConstructor(k);var b=m.length,p=e.width,n=e.height;e=h.cols;var r=h.rows,G=Math.ceil(p/e),v=Math.ceil(n/r);h=!1;for(var t=0;t<c.length;t+=3)-1===c[t]&&-1===c[t+1]&&-1===c[t+2]&&(h=!0);for(var u,
w,z,y,x,A,D=new Float32Array(p*n),L=new Float32Array(p*n),I=0,J,K,H="majority"===d?0:.5,t=0;t<v;t++)for(var M=0;M<G;M++){u=12*(t*G+M);d=c[u];w=c[u+1];z=c[u+2];y=c[u+3];x=c[u+4];A=c[u+5];for(var E=0;E<r;E++){I=(t*r+E)*p+M*e;K=(E+.5)/r;for(var F=0;F<E;F++)J=(F+.5)/e,D[I+F]=Math.round((d*J+w*K+z)*f-H),L[I+F]=Math.round((y*J+x*K+A)*l-H)}u+=6;d=c[u];w=c[u+1];z=c[u+2];y=c[u+3];x=c[u+4];A=c[u+5];for(E=0;E<r;E++)for(I=(t*r+E)*p+M*e,K=(E+.5)/r,F=E;F<e;F++)J=(F+.5)/e,D[I+F]=Math.round((d*J+w*K+z)*f-H),L[I+
F]=Math.round((y*J+x*K+A)*l-H)}c=function(a,b){for(var c=0;c<n;c++){u=c*p;for(var d=0;d<p;d++)a[u]=0>D[u]||0>L[u]?0:b[D[u]+L[u]*f],u++}};l=[];for(t=0;t<b;t++)e=new a(p*n),c(e,m[t]),l.push(e);m=new B({width:p,height:n,pixelType:k,pixels:l});if(g)m.mask=new Uint8Array(p*n),c(m.mask,g);else if(h)for(m.mask=new Uint8Array(p*n),t=0;t<p*n;t++)m.mask[t]=0>D[t]||0>L[t]?0:1;m.updateStatistics();return m}});