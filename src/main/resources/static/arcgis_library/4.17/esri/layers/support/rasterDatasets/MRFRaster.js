// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.17/esri/copyright.txt for details.
//>>built
define("require exports tslib ../../../geometry ../../../core/Error ../../../core/maybe ../../../core/promiseUtils ../../../core/accessorSupport/decorators ../PixelBlock ../RasterInfo ../RasterStorageInfo ./BaseRaster ./xmlUtilities".split(" "),function(S,T,z,D,A,L,M,C,N,O,P,Q,d){var R=function(){var d=new ArrayBuffer(4),b=new Uint8Array(d);(new Uint32Array(d))[0]=1;return 1===b[0]}(),g=new Map;g.set("Int8","s8");g.set("UInt8","u8");g.set("Int16","s16");g.set("UInt16","u16");g.set("Int32","s32");
g.set("UInt32","u32");g.set("Float32","f32");g.set("Float64","f32");g.set("Double64","f32");var x=new Map;x.set("lerc",".lrc");x.set("none",".til");x.set("deflate",".pzp");x.set("jpeg",".jzp");return function(E){function b(){var a=null!==E&&E.apply(this,arguments)||this;a._files=null;a._storageIndex=null;a.datasetFormat="MRF";return a}z.__extends(b,E);b.prototype.open=function(a){return z.__awaiter(this,void 0,void 0,function(){var c,G,h,k,e,n,f,v,w,r,m,t,q,p,d,y,b,g,H,F,l;return z.__generator(this,
function(u){switch(u.label){case 0:return[4,this.init()];case 1:return u.sent(),this.datasetName=this.url.slice(this.url.lastIndexOf("/")+1),c=a?L.unwrap(a.signal):null,[4,this.request(this.url,{responseType:"xml",signal:c})];case 2:return G=u.sent(),h=this._parseHeader(G.data),k=h.rasterInfo,e=h.files,this._set("rasterInfo",k),this._files=e,[4,this.request(e.index,{responseType:"array-buffer",signal:c})];case 3:n=u.sent();this._storageIndex=this._parseIndex(n.data);f=0;v=-1;m=this.rasterInfo.storageInfo;
t=m.blockWidth;q=m.blockHeight;p=m.compression;d=this.rasterInfo.storageInfo.pyramidScalingFactor;y=this.rasterInfo;b=y.width;g=y.height;H=y.bandCount;F=[];for(l="none"===p?1:H;f<this._storageIndex.length;)v++,w=Math.ceil(b/t/Math.pow(d,v)),r=Math.ceil(g/q/Math.pow(d,v)),f+=w*r*l*4,F.push({maxRow:r,maxCol:w,minCol:0,minRow:0});this.rasterInfo.storageInfo.blockBoundary=F;0<v&&(this.rasterInfo.storageInfo.firstPyramidLevel=1,this.rasterInfo.storageInfo.maximumPyramidLevel=v);this.updateTileInfo();return[2]}})})};
b.prototype.fetchRawTile=function(a,c,G,h){void 0===h&&(h={});return z.__awaiter(this,void 0,void 0,function(){var k,e,n,f,d,w,r,m,t,q,p,u,b,g,A,H,F,l,x,D,C,E,K,J,B,I;return z.__generator(this,function(v){switch(v.label){case 0:k=this.rasterInfo.storageInfo;e=k.blockWidth;n=k.blockHeight;f=k.blockBoundary;d=k.compression;w=f[a];if(!w||w.maxRow<c||w.maxCol<G||w.minRow>c||w.minCol>G)return[2,null];r=this.rasterInfo;m=r.bandCount;t=r.pixelType;q=this._getTileLocation(a,c,G);p=q.ranges;u=q.actualTileWidth;
b=q.actualTileHeight;if(!p||0===p.length)return[2,null];if(0===p[0].from&&0===p[0].to)return g=new Uint8Array(e*n),[2,new N({width:e,height:n,pixels:null,mask:g,validPixelCount:0})];A=this.ioConfig.bandIds;H="none"===d?1:m;F=[];for(l=l=0;l<H;l++)(!A||-1<A.indexOf[l])&&F.push(this.request(this._files.data,{range:{from:p[l].from,to:p[l].to},responseType:"array-buffer",signal:h.signal}));return[4,M.all(F)];case 1:x=v.sent();D=x.map(function(a){return a.data.byteLength}).reduce(function(a,c){return a+
c});C=new Uint8Array(D);for(l=E=0;l<H;l++)C.set(new Uint8Array(x[l].data),E),E+=x[l].data.byteLength;K="lerc"===this.rasterInfo.storageInfo.compression?"lerc":"bip";return[4,this.decodePixelBlock(C.buffer,{width:e,height:n,format:K,pixelType:t})];case 2:J=v.sent();I=B=0;if(u!==e||b!==n)if(g=J.mask)for(l=0;l<n;l++)for(I=l*e,B=l<b?u:0;B<e;B++)g[I+B]=0;else for(g=new Uint8Array(e*n),J.mask=g,l=0;l<b;l++)for(I=l*e,B=0;B<u;B++)g[I+B]=1;return[2,J]}})})};b.prototype._parseIndex=function(a){if(0<a.byteLength%
16)throw"invalid array buffer must be multiples of 16";var c,d,h,k,e;if(R){c=new Uint8Array(a);h=new ArrayBuffer(a.byteLength);d=new Uint8Array(h);for(k=0;k<a.byteLength/4;k++)for(e=0;4>e;e++)d[4*k+e]=c[4*k+3-e];a=new Uint32Array(h)}else a=new Uint32Array(a);return a};b.prototype._getTileLocation=function(a,c,d){var h=this.rasterInfo.storageInfo,k=h.blockWidth,e=h.blockHeight,n=h.pyramidScalingFactor,f=this.rasterInfo,b=f.width,g=f.height,f=f.bandCount,h="none"===h.compression?1:f,r,m,t=0,q=0;for(m=
0;m<a;m++)q=Math.pow(n,m),f=Math.ceil(b/k/q),r=Math.ceil(g/e/q),t+=f*r;q=Math.pow(n,a);f=Math.ceil(b/k/q);r=Math.ceil(g/e/q);t=4*(t+(c*f+d))*h;a=this._storageIndex.subarray(t,t+4*h);m=n=0;for(var t=[],p=0;p<h;p++)n=a[4*p+0]*Math.pow(2,32)+a[4*p+1],m=n+a[4*p+2]*Math.pow(2,32)+a[4*p+3],t.push({from:n,to:m});return{ranges:t,actualTileWidth:d<f-1?k:Math.ceil(b/q)-k*(f-1),actualTileHeight:c<r-1?e:Math.ceil(g/q)-e*(r-1)}};b.prototype._parseHeader=function(a){var c=d.getElement(a,"MRF_META/Raster");if(!c)throw new A("mrf:open",
"not a valid MRF format");var b=d.getElement(c,"Size"),h=parseInt(b.getAttribute("x"),10),k=parseInt(b.getAttribute("y"),10),e=parseInt(b.getAttribute("c"),10),b=(d.getElementValue(c,"Compression")||"none").toLowerCase(),n=["none","lerc"];if(!b||-1===n.indexOf(b))throw new A("mrf:open","currently does not support compression "+b);var f=d.getElementValue(c,"DataType")||"UInt8",n=g.get(f);if(null==n)throw new A("mrf:open","currently does not support pixel type "+f);var v=d.getElement(c,"PageSize"),
f=parseInt(v.getAttribute("x"),10),v=parseInt(v.getAttribute("y"),10),c=d.getElement(c,"DataValues"),w;c&&(c=c.getAttribute("NoData"),null!=c&&(w=c.trim().split(" ").map(function(a){return parseFloat(a)})));if(d.getElement(a,"MRF_META/CachedSource"))throw new A("mrf:open","currently does not support MRF referencing other data files");var r=d.getElement(a,"MRF_META/GeoTags"),m=d.getElement(r,"BoundingBox");if(null==m)throw new A("mrf:open","missing node MRF_META/GeoTags/BoundingBox");var c=parseFloat(m.getAttribute("minx")),
t=parseFloat(m.getAttribute("miny")),q=parseFloat(m.getAttribute("maxx")),p=parseFloat(m.getAttribute("maxy")),u=d.getElementValue(r,"Projection"),r=d.getElementValue(a,"datafile"),m=d.getElementValue(a,"IndexFile"),y;"LOCAL_CS[]"!==u&&(y=new D.SpatialReference({wkt:u}));u=new D.Extent(c,t,q,p);u.spatialReference=y;a=d.getElement(a,"MRF_META/Rsets");a=parseInt(a&&a.getAttribute("scale")||"2",10);a=new P({origin:new D.Point({x:u.xmin,y:u.ymax,spatialReference:y}),blockWidth:f,blockHeight:v,pyramidBlockWidth:f,
pyramidBlockHeight:v,compression:b,pyramidScalingFactor:a});f=new D.Point({x:(q-c)/h,y:(p-t)/k,spatialReference:y});h=new O({width:h,height:k,extent:u,spatialReference:y,bandCount:e,pixelType:n,pixelSize:f,noDataValue:w,storageInfo:a});k={mrf:this.url,index:m||this.url.replace(".mrf",".idx"),data:r||this.url.replace(".mrf",x.get(b))};return{rasterInfo:h,files:k}};z.__decorate([C.property()],b.prototype,"_files",void 0);z.__decorate([C.property()],b.prototype,"_storageIndex",void 0);z.__decorate([C.property({type:String,
json:{write:!0}})],b.prototype,"datasetFormat",void 0);return b=z.__decorate([C.subclass("esri.layers.support.rasterIO.MRFRaster")],b)}(Q)});