// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.17/esri/copyright.txt for details.
//>>built
define("require exports tslib ../../request ../../core/Error ../../core/has ../../core/Logger ../../core/promiseUtils ../../core/urlUtils ../../core/accessorSupport/decorators ../../core/accessorSupport/originUtils ../../geometry/Extent ../../geometry/HeightModelInfo ../../geometry/SpatialReference ../support/arcgisLayerUrl ../support/commonProperties ../../portal/Portal ../../portal/PortalItem ../../webdoc/support/saveUtils @dojo/framework/shim/Promise".split(" "),function(B,k,c,r,m,G,g,n,t,e,w,
x,C,u,p,D,y,E,z){Object.defineProperty(k,"__esModule",{value:!0});k.SCENE_SERVICE_ITEM_TYPE=k.SceneService=void 0;var q=g.getLogger("esri.layers.mixins.SceneService");k.SceneService=function(g){return function(g){function b(){var a=null!==g&&g.apply(this,arguments)||this;a.spatialReference=null;a.fullExtent=null;a.heightModelInfo=null;a.minScale=0;a.maxScale=0;a.version={major:Number.NaN,minor:Number.NaN,versionString:""};a.copyright=null;a.sublayerTitleMode="item-title";a.title=null;a.layerId=null;
a._debouncedSaveOperations=n.debounce(function(d,b,f){return c.__awaiter(a,void 0,void 0,function(){return c.__generator(this,function(a){switch(d){case 0:return[2,this._save(b)];case 1:return[2,this._saveAs(f,b)]}return[2]})})});return a}c.__extends(b,g);b.prototype.readSpatialReference=function(a,d){return this._readSpatialReference(d)};b.prototype._readSpatialReference=function(a){if(null!=a.spatialReference)return u.fromJSON(a.spatialReference);a=a.store;a=(a=a.indexCRS||a.geographicCRS)&&parseInt(a.substring(a.lastIndexOf("/")+
1,a.length),10);return null!=a?new u(a):null};b.prototype.readFullExtent=function(a,d){a=d.store;d=this._readSpatialReference(d);return null==d||null==a||null==a.extent||!Array.isArray(a.extent)||a.extent.some(function(a){return a<v})?null:new x({xmin:a.extent[0],ymin:a.extent[1],xmax:a.extent[2],ymax:a.extent[3],spatialReference:d})};b.prototype.readVersion=function(a,d){a=d.store;d=null!=a.version?a.version.toString():"";a={major:Number.NaN,minor:Number.NaN,versionString:d};d=d.split(".");2<=d.length&&
(a.major=parseInt(d[0],10),a.minor=parseInt(d[1],10));return a};b.prototype.readTitlePortalItem=function(a){return"item-title"!==this.sublayerTitleMode?void 0:a};b.prototype.readTitleService=function(a,d){a=this.portalItem&&this.portalItem.title;if("item-title"===this.sublayerTitleMode)return p.titleFromUrlAndName(this.url,d.name);d=d.name||p.parse(this.url).title;"item-title-and-service-name"===this.sublayerTitleMode&&a&&(d=a+" - "+d);return p.cleanTitle(d)};Object.defineProperty(b.prototype,"url",
{set:function(a){a=p.sanitizeUrlWithLayerId(this,a,q);this._set("url",a.url);null!=a.layerId&&this._set("layerId",a.layerId)},enumerable:!1,configurable:!0});b.prototype.writeUrl=function(a,d,b,c){p.writeUrlWithLayerId(this,a,"layers",d,c)};Object.defineProperty(b.prototype,"parsedUrl",{get:function(){var a=this._get("url");if(!a)return null;a=t.urlToObject(a);null!=this.layerId&&p.isArcGISUrl(a.path)&&(a.path=a.path+"/layers/"+this.layerId);return a},enumerable:!1,configurable:!0});b.prototype._verifyRootNodeAndUpdateExtent=
function(a,d){return c.__awaiter(this,void 0,void 0,function(){var b,f,h;return c.__generator(this,function(c){switch(c.label){case 0:if(!a)return[3,4];c.label=1;case 1:return c.trys.push([1,3,,4]),b=this._updateExtentFromRootPage,f=[a],[4,this._fetchRootPage(a,d)];case 2:return[2,b.apply(this,f.concat([c.sent()]))];case 3:return c.sent(),[3,4];case 4:return h=this._updateExtentFromRootNode,[4,this._fetchRootNode(d)];case 5:return[2,h.apply(this,[c.sent()])]}})})};b.prototype._fetchRootPage=function(a,
d){return c.__awaiter(this,void 0,void 0,function(){var b,f,h;return c.__generator(this,function(c){switch(c.label){case 0:if(!a)return[2,n.reject()];b=Math.floor(a.rootIndex/a.nodesPerPage);f=this.parsedUrl.path+"/nodepages/"+b;return[4,r(f,{responseType:"json",signal:d})];case 1:return h=c.sent(),[2,h.data]}})})};b.prototype._updateExtentFromRootPage=function(a,d){if(null==d||null==d.nodes)throw new m("sceneservice:invalid-node-page","Inavlid node page.");d=d.nodes[a.rootIndex%a.nodesPerPage];if(null==
d||null==d.obb||null==d.obb.center||null==d.obb.halfSize)throw new m("sceneservice:invalid-node-page","Inavlid node page.");d.obb.center[0]<v||(a=d.obb.halfSize,d=d.obb.center[2],a=Math.sqrt(a[0]*a[0]+a[1]*a[1]+a[2]*a[2]),this.fullExtent.zmin=d-a,this.fullExtent.zmax=d+a)};b.prototype._updateExtentFromRootNode=function(a){if(null!=a&&null!=this.fullExtent&&!this.fullExtent.hasZ&&Array.isArray(a.mbs)&&4===a.mbs.length&&!(a.mbs[0]<v)){var d=a.mbs[2];a=a.mbs[3];this.fullExtent.zmin=d-a;this.fullExtent.zmax=
d+a}};b.prototype._fetchRootNode=function(a){return c.__awaiter(this,void 0,void 0,function(){var d,b,f;return c.__generator(this,function(c){switch(c.label){case 0:if(!this.rootNode)return[2];d=t.join(this.parsedUrl.path,this.rootNode);c.label=1;case 1:return c.trys.push([1,3,,4]),[4,r(d,{query:{f:"json"},responseType:"json",signal:a})];case 2:return b=c.sent(),[2,b.data];case 3:throw f=c.sent(),new m("sceneservice:root-node-missing","Root node missing.",{error:f,url:d});case 4:return[2]}})})};b.prototype._fetchService=
function(a){return c.__awaiter(this,void 0,void 0,function(){var d;return c.__generator(this,function(c){switch(c.label){case 0:return null==this.layerId&&/SceneServer\/*$/i.test(this.url)?[4,this._fetchFirstLayerId(a)]:[3,2];case 1:d=c.sent(),null!=d&&(this.layerId=d),c.label=2;case 2:return[2,this._fetchServiceLayer(a)]}})})};b.prototype._fetchFirstLayerId=function(a){return c.__awaiter(this,void 0,void 0,function(){var d;return c.__generator(this,function(c){switch(c.label){case 0:return[4,r(this.url,
{query:{f:"json"},responseType:"json",signal:a})];case 1:return d=c.sent(),d.data&&Array.isArray(d.data.layers)&&0<d.data.layers.length?[2,d.data.layers[0].id]:[2,void 0]}})})};b.prototype._fetchServiceLayer=function(a){return c.__awaiter(this,void 0,void 0,function(){var d,b;return c.__generator(this,function(c){switch(c.label){case 0:return[4,r(this.parsedUrl.path,{query:{f:"json"},responseType:"json",signal:a})];case 1:return d=c.sent(),d.ssl&&(this.url=this.url.replace(/^http:/i,"https:")),b=
d.data,this.read(b,{origin:"service",url:this.parsedUrl}),this.validateLayer(b),[2]}})})};b.prototype._ensureLoadBeforeSave=function(){return c.__awaiter(this,void 0,void 0,function(){return c.__generator(this,function(a){switch(a.label){case 0:return[4,this.load()];case 1:return a.sent(),"beforeSave"in this&&"function"===typeof this.beforeSave?[4,this.beforeSave()]:[3,3];case 2:a.sent(),a.label=3;case 3:return[2]}})})};b.prototype.validateLayer=function(a){};b.prototype._updateTypeKeywords=function(a,
d,c){a.typeKeywords||(a.typeKeywords=[]);var b=0;for(d=d.getTypeKeywords();b<d.length;b++)a.typeKeywords.push(d[b]);a.typeKeywords&&(a.typeKeywords=a.typeKeywords.filter(function(a,d,c){return c.indexOf(a)===d}),1===c&&(a.typeKeywords=a.typeKeywords.filter(function(a){return"Hosted Service"!==a})))};b.prototype._saveAs=function(a,d){return c.__awaiter(this,void 0,void 0,function(){var b,f,h,e,g;return c.__generator(this,function(l){switch(l.label){case 0:b=c.__assign(c.__assign({},A),d);if(f=E.from(a))return[3,
2];q.error("_saveAs(): requires a portal item parameter");return[4,n.reject(new m("sceneservice:portal-item-required","_saveAs() requires a portal item to save to"))];case 1:l.sent(),l.label=2;case 2:return f.id&&(f=f.clone(),f.id=null),h=f.portal||y.getDefault(),[4,this._ensureLoadBeforeSave()];case 3:return l.sent(),f.type=k.SCENE_SERVICE_ITEM_TYPE,f.portal=h,e={origin:"portal-item",url:null,messages:[],portal:h,portalItem:f,writtenProperties:[],blockedRelativeUrls:[],resources:{toAdd:[],toUpdate:[],
toKeep:[],pendingOperations:[]}},g={layers:[this.write(null,e)]},[4,n.all(e.resources.pendingOperations)];case 4:return l.sent(),[4,this._validateAgainstJSONSchema(g,e,b)];case 5:return l.sent(),f.url=this.url,f.title||(f.title=this.title),this._updateTypeKeywords(f,b,1),[4,h._signIn()];case 6:return l.sent(),[4,h.user.addItem({item:f,folder:b&&b.folder,data:g})];case 7:return l.sent(),[4,z.saveResources(this.resourceReferences,e,null)];case 8:return l.sent(),this.portalItem=f,w.updateOrigins(e),
e.portalItem=f,[2,f]}})})};b.prototype._save=function(a){return c.__awaiter(this,void 0,void 0,function(){var d,b,f;return c.__generator(this,function(e){switch(e.label){case 0:d=c.__assign(c.__assign({},A),a);if(this.portalItem)return[3,2];q.error("_save(): requires the .portalItem property to be set");return[4,n.reject(new m("sceneservice:portal-item-not-set","Portal item to save to has not been set on this SceneService"))];case 1:e.sent(),e.label=2;case 2:if(this.portalItem.type===k.SCENE_SERVICE_ITEM_TYPE)return[3,
4];q.error("_save(): Non-matching portal item type. Got "+this.portalItem.type+", expected "+k.SCENE_SERVICE_ITEM_TYPE);return[4,n.reject(new m("sceneservice:portal-item-wrong-type",'Portal item needs to have type "'+k.SCENE_SERVICE_ITEM_TYPE+'"'))];case 3:e.sent(),e.label=4;case 4:return[4,this._ensureLoadBeforeSave()];case 5:return e.sent(),b={origin:"portal-item",url:this.portalItem.itemUrl&&t.urlToObject(this.portalItem.itemUrl),messages:[],portal:this.portalItem.portal||y.getDefault(),portalItem:this.portalItem,
writtenProperties:[],blockedRelativeUrls:[],resources:{toAdd:[],toUpdate:[],toKeep:[],pendingOperations:[]}},f={layers:[this.write(null,b)]},[4,n.all(b.resources.pendingOperations)];case 6:return e.sent(),[4,this._validateAgainstJSONSchema(f,b,d)];case 7:return e.sent(),this.portalItem.url=this.url,this.portalItem.title||(this.portalItem.title=this.title),this._updateTypeKeywords(this.portalItem,d,0),[4,this.portalItem.update({data:f})];case 8:return e.sent(),[4,z.saveResources(this.resourceReferences,
b,null)];case 9:return e.sent(),w.updateOrigins(b),[2,this.portalItem]}})})};b.prototype._validateAgainstJSONSchema=function(a,d,b){return c.__awaiter(this,void 0,void 0,function(){var e,h,g,k,l,n;return c.__generator(this,function(c){switch(c.label){case 0:return e=d.messages.filter(function(a){return"error"===a.type}).map(function(a){return new m(a.name,a.message,a.details)}),b&&b.validationOptions.ignoreUnsupported&&(e=e.filter(function(a){return"layer:unsupported"!==a.name&&"symbol:unsupported"!==
a.name&&"symbol-layer:unsupported"!==a.name&&"property:unsupported"!==a.name&&"url:unsupported"!==a.name&&"scenemodification:unsupported"!==a.name})),b.validationOptions.enabled||F?[4,new Promise(function(a,b){B(["../../layers/support/schemaValidator"],a,b)})]:[3,2];case 1:h=c.sent();g=h.validate(a,b.portalItemLayerType);if(0<g.length&&(k="Layer item did not validate:\n"+g.join("\n"),q.error("_validateAgainstJSONSchema(): "+k),"throw"===b.validationOptions.failPolicy))throw l=g.map(function(a){return new m("sceneservice:schema-validation",
a)}),n=l.concat(e),new m("sceneservice-validate:error","Failed to save layer item due to schema validation, see `details.errors`.",{combined:n});c.label=2;case 2:if(0<e.length)throw new m("sceneservice:save","Failed to save SceneService due to unsupported or invalid content. See 'details.errors' for more detailed information",{errors:e});return[2]}})})};c.__decorate([e.property({json:{origins:{service:{read:!1},"portal-item":{read:!1}}}})],b.prototype,"id",void 0);c.__decorate([e.property({type:u})],
b.prototype,"spatialReference",void 0);c.__decorate([e.reader("spatialReference",["spatialReference","store.indexCRS","store.geographicCRS"])],b.prototype,"readSpatialReference",null);c.__decorate([e.property({type:x})],b.prototype,"fullExtent",void 0);c.__decorate([e.reader("fullExtent",["store.extent","spatialReference","store.indexCRS","store.geographicCRS"])],b.prototype,"readFullExtent",null);c.__decorate([e.property({readOnly:!0,type:C})],b.prototype,"heightModelInfo",void 0);c.__decorate([e.property({type:Number,
json:{name:"layerDefinition.minScale",write:!0,origins:{service:{read:{source:"minScale"},write:!1}}}})],b.prototype,"minScale",void 0);c.__decorate([e.property({type:Number,json:{name:"layerDefinition.maxScale",write:!0,origins:{service:{read:{source:"maxScale"},write:!1}}}})],b.prototype,"maxScale",void 0);c.__decorate([e.property({readOnly:!0})],b.prototype,"version",void 0);c.__decorate([e.reader("version",["store.version"])],b.prototype,"readVersion",null);c.__decorate([e.property({type:String,
json:{read:{source:"copyrightText"}}})],b.prototype,"copyright",void 0);c.__decorate([e.property({type:String,json:{read:!1}})],b.prototype,"sublayerTitleMode",void 0);c.__decorate([e.property({type:String})],b.prototype,"title",void 0);c.__decorate([e.reader("portal-item","title")],b.prototype,"readTitlePortalItem",null);c.__decorate([e.reader("service","title",["name"])],b.prototype,"readTitleService",null);c.__decorate([e.property({type:Number,json:{origins:{service:{read:{source:"id"}},"portal-item":{write:{target:"id",
isRequired:!0,ignoreOrigin:!0},read:!1}}}})],b.prototype,"layerId",void 0);c.__decorate([e.property(D.url)],b.prototype,"url",null);c.__decorate([e.writer("url")],b.prototype,"writeUrl",null);c.__decorate([e.property({dependsOn:["layerId"]})],b.prototype,"parsedUrl",null);c.__decorate([e.property({readOnly:!0})],b.prototype,"store",void 0);c.__decorate([e.property({type:String,readOnly:!0,json:{read:{source:"store.rootNode"}}})],b.prototype,"rootNode",void 0);return b=c.__decorate([e.subclass("esri.layers.mixins.SceneService")],
b)}(g)};var v=-1E38,F=0;k.SCENE_SERVICE_ITEM_TYPE="Scene Service";var A={getTypeKeywords:function(){return[]},portalItemLayerType:"unknown",validationOptions:{enabled:!0,ignoreUnsupported:!1,failPolicy:"throw"}}});