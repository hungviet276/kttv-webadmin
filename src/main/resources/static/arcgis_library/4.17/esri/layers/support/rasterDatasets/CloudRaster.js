// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.17/esri/copyright.txt for details.
//>>built
define("require exports tslib ../../../geometry ../../../core/Error ../../../core/maybe ../../../core/promiseUtils ../../../core/accessorSupport/decorators ../RasterInfo ../RasterStorageInfo ../TileInfo ./BaseRaster ./DBFParser ../../../tasks/support/FeatureSet".split(" "),function(K,L,f,v,B,C,D,p,E,F,G,H,I,J){var k=new Map;k.set("int16","esriFieldTypeSmallInteger");k.set("int32","esriFieldTypeInteger");k.set("int64","esriFieldTypeInteger");k.set("float32","esriFieldTypeSingle");k.set("float64","esriFieldTypeDouble");
k.set("text","esriFieldTypeString");return function(r){function b(){var a=null!==r&&r.apply(this,arguments)||this;a.storageInfo=null;a.datasetFormat="CRF";return a}f.__extends(b,r);b.prototype.open=function(a){return f.__awaiter(this,void 0,void 0,function(){var c,g,h,e,d;return f.__generator(this,function(m){switch(m.label){case 0:return[4,this.init()];case 1:return m.sent(),[4,this.request(this.url+"/conf.json",{signal:null===a||void 0===a?void 0:a.signal})];case 2:c=m.sent().data;if(!this._validateHeader(c))throw new B("cloudraster:open",
"Invalid or unsupported conf.json.");this.datasetName=this.url.slice(this.url.lastIndexOf("/")+1);g=this._parseHeader(c);h=g.storageInfo;e=g.rasterInfo;return"thematic"!==e.dataType?[3,4]:[4,this._fetchAuxiliaryInformation()];case 3:d=m.sent(),e.attributeTable=d,m.label=4;case 4:return this._set("storageInfo",h),this._set("rasterInfo",e),this.ioConfig.retryCount=this.ioConfig.retryCount||0,[2]}})})};b.prototype.fetchRawTile=function(a,c,g,h){void 0===h&&(h={});return f.__awaiter(this,void 0,void 0,
function(){var e,d,m,b,k,q,w;return f.__generator(this,function(f){switch(f.label){case 0:e=this.rasterInfo.storageInfo.maximumPyramidLevel-a;if(0>e)return[2,null];d=this._buildCacheFilePath(e,c,g,h.multidimensionalDefinition);m=this._getIndexRecordFromBundle(c,g);return[4,this.request(d,{range:{from:0,to:this.storageInfo.headerSize-1},responseType:"array-buffer",signal:h.signal})];case 1:b=f.sent();if(!b)return[2,null];k=new Uint8Array(b.data);q=this._getTileEndAndContentType(k,m);return 0===q.recordSize?
[2,null]:[4,this.request(d,{range:{from:q.position,to:q.position+q.recordSize},responseType:"array-buffer",signal:h.signal})];case 2:return(w=f.sent())?[2,this.decodePixelBlock(w.data,{width:this.rasterInfo.storageInfo.tileInfo.size[0],height:this.rasterInfo.storageInfo.tileInfo.size[1],planes:null,pixelType:null})]:[2,null]}})})};b.prototype._validateHeader=function(a){var c="origin extent geodataXform LODInfos blockWidth blockHeight bandCount pixelType pixelSizeX pixelSizeY format packetSize".split(" ");
return a&&"RasterInfo"===a.type&&!c.some(function(c){return!a[c]})};b.prototype._parseHeader=function(a){var c,g="u1 u2 u4 u8 s8 u16 s16 u32 s32 f32 f64".split(" ")[a.pixelType],h=a.bandCount,e=a.histograms,d=a.colormap,m=a.blockWidth,b=a.blockHeight,f=a.firstPyramidLevel,q=a.maximumPyramidLevel,w=a.statistics&&a.statistics.map(function(a){return{min:a.min,max:a.max,avg:a.mean,stddev:a.standardDeviation,median:a.median,mode:a.mode}}),k=new v.SpatialReference(a.extent.spatialReference||a.geodataXform.spatialReference),
u=new v.Extent({xmin:a.extent.xmin,ymin:a.extent.ymin,xmax:a.extent.xmax,ymax:a.extent.ymax,spatialReference:k}),p=new v.Point({x:a.pixelSizeX,y:a.pixelSizeY,spatialReference:k}),r=null!==(c=a.properties)&&void 0!==c?c:{},x=a.format.toLowerCase().replace("cache/","");c=new v.Point(a.origin.x,a.origin.y,k);var y,l,n,t;if(d&&d.colors)for(y=[],l=0;l<d.colors.length;l++)n=d.colors[l],t=d.values?d.values[l]:l,y.push([t,n&255,n<<16>>>24,n<<8>>>24,n>>>24]);d=a.LODInfos;n=[];for(l=0;l<d.levels.length;l++)n.push({level:d.levels[l],
resolution:d.resolutions[l],scale:96/.0254*d.resolutions[l]});d=new G({dpi:96,lods:n,format:x,origin:c,size:[m,b],spatialReference:k});x={recordSize:8,packetSize:a.packetSize,headerSize:a.packetSize*a.packetSize*8+64};n=Math.round((u.xmax-u.xmin)/p.x);t=Math.round((u.ymax-u.ymin)/p.y);var A=[{maxCol:Math.ceil(n/m)-1,maxRow:Math.ceil(t/b)-1,minCol:0,minRow:0}],z=2;if(0<q)for(l=0;l<q;l++)A.push({maxCol:Math.ceil(n/z/m)-1,maxRow:Math.ceil(t/z/b)-1,minCol:0,minRow:0}),z*=2;a=new E({width:n,height:t,pixelType:g,
bandCount:h,extent:u,spatialReference:k,pixelSize:p,keyProperties:r,statistics:w,histograms:e,multidimensionalInfo:a.mdInfo,colormap:y,storageInfo:new F({blockWidth:m,blockHeight:b,pyramidBlockWidth:m,pyramidBlockHeight:b,origin:c,tileInfo:d,firstPyramidLevel:f,maximumPyramidLevel:q,blockBoundary:A})});return{storageInfo:x,rasterInfo:a}};b.prototype._fetchAuxiliaryInformation=function(a){return f.__awaiter(this,void 0,void 0,function(){var c,g,h,e,d,b,p,r;return f.__generator(this,function(f){switch(f.label){case 0:return c=
this.request(this.url+"/conf.vat.json",{signal:a}).then(function(a){return a.data}).catch(function(){return null}),g=this.request(this.url+"/conf.vat.dbf",{responseType:"array-buffer",signal:a}).then(function(a){return a.data}).catch(function(){return null}),[4,D.all([c,g])];case 1:return h=f.sent(),h[0]&&(d=h[0].fields,b=h[0].values,d&&b&&(d=d.map(function(a){return{type:"OID"===a.name?"esriFieldTypeOID":k.get(a.type),name:a.name,alias:a.alias||a.name}}),p=b.map(function(a){return{attributes:a}}),
d&&b&&(e={fields:d,features:p}))),!e&&h[1]&&(r=I.parse(h[1]),e=r.recordSet),[2,J.fromJSON(e)]}})})};b.prototype._buildCacheFilePath=function(a,c,g,b){var e=this.storageInfo.packetSize;g=Math.floor(g/e)*e;c="R"+this._toHexString4(Math.floor(c/e)*e)+"C"+this._toHexString4(g);e="L";e=10<=a?e+a.toString():e+("0"+a.toString());a=this.rasterInfo.multidimensionalInfo;var d=null===b||void 0===b?void 0:b[0];if(!C.isSome(a)||!d)return this.url+"/_alllayers/"+e+"/"+c+".bundle";b=a.variables.filter(function(a){return a.name===
d.variableName})[0].dimensions[0].values.indexOf(d.values[0]).toString(16);a=4-b.length;for(g=0;g<a;g++)b="0"+b;return this.url+"/_alllayers/"+d.variableName+"/"+("S"+b)+"/"+e+"/"+c+".bundle"};b.prototype._getIndexRecordFromBundle=function(a,b){var c=this.storageInfo.packetSize;a=a%c*c+b%c;if(0>a)throw"Invalid level / row / col";return a*this.storageInfo.recordSize+64};b.prototype._getTileEndAndContentType=function(a,b){a=a.subarray(b,b+8);b=0;var c;for(c=0;5>c;c++)b|=(a[c]&255)<<8*c;var f=b&0xffffffffff;
b=0;for(c=5;8>c;c++)b|=(a[c]&255)<<8*(c-5);return{position:f,recordSize:b&0xffffffffff}};b.prototype._toHexString4=function(a){a=a.toString(16);if(4!==a.length)for(var b=4-a.length;0<b--;)a="0"+a;return a};f.__decorate([p.property({readOnly:!0})],b.prototype,"storageInfo",void 0);f.__decorate([p.property({type:String,json:{write:!0}})],b.prototype,"datasetFormat",void 0);return b=f.__decorate([p.subclass("esri.layers.support.rasterDatasets.CloudRaster")],b)}(H)});