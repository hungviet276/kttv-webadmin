// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.17/esri/copyright.txt for details.
//>>built
define("require exports tslib ../../../core/Error ../../../core/lang ../../../core/maybe ../../../core/MemCache ../../../core/promiseUtils ../../../core/SetUtils ../../../core/unitUtils ../../../geometry/support/aaBoundingBox ../../../geometry/support/aaBoundingRect ../../../geometry/support/boundsUtils ../../../geometry/support/jsonUtils ../../../geometry/support/spatialReferenceUtils ./attributeSupport ./projectionSupport ./QueryEngineCapabilities ./QueryEngineResult ./spatialQuerySupport ./timeSupport ./utils ../../support/FieldsIndex ../../support/PromiseQueue".split(" "),
function(A,x,k,u,v,J,F,K,L,y,p,E,M,G,H,r,I,N,t,C,O,l,P,Q){function R(k){return k.every(function(a){return"exceedslimit"!==a.statisticType})}Object.defineProperty(x,"__esModule",{value:!0});x.Feature=void 0;A=function(){return function(k,a,b,c,d){void 0===a&&(a=null);this.attributes=k;this.geometry=b;this.centroid=c;this.filterFlags=d;this.groupId=-1;this.displayId=a}}();x.Feature=A;var z=new Set,S=new F.MemCacheStorage(2E6),T=0;A=function(){function g(a){var b=this;this.capabilities={query:N.queryCapabilities};
this.geometryType=a.geometryType;this.hasM=a.hasM;this.hasZ=a.hasZ;this.objectIdField=a.objectIdField;this.spatialReference=a.spatialReference;this.definitionExpression=a.definitionExpression;this.featureStore=a.featureStore;this._changeHandle=this.featureStore.events.on("changed",function(){return b.clearCache()});this.timeInfo=a.timeInfo;a.cacheSpatialQueries&&(this._geometryQueryCache=new F.MemCache(T++ +"$$",S));this.fieldsIndex=new P(a.fields);a.scheduler&&a.task&&(this._frameQueue=new Q.default,
this._frameTask=a.scheduler.registerTask(a.task,function(a){return b._update(a)},function(){return 0<b._frameQueue.length}))}g.prototype.destroy=function(){this._frameTask&&(this._frameTask.remove(),this._frameTask=null,this._frameQueue.cancelAll(),this._frameQueue=null);this.clearCache();this._geometryQueryCache&&this._geometryQueryCache.destroy();this._changeHandle&&(this._changeHandle.remove(),this._changeHandle=null);this.fieldsIndex.destroy()};Object.defineProperty(g.prototype,"featureAdapter",
{get:function(){return this.featureStore.featureAdapter},enumerable:!1,configurable:!0});Object.defineProperty(g.prototype,"fullExtent",{get:function(){var a=this.featureStore.fullBounds;return a?{xmin:a[0],ymin:a[1],xmax:a[2],ymax:a[3],spatialReference:l.cleanFromGeometryEngine(this.spatialReference)}:null},enumerable:!1,configurable:!0});Object.defineProperty(g.prototype,"timeExtent",{get:function(){return this.timeInfo?this._timeExtent?this._timeExtent:this._timeExtent=O.getTimeExtent(this.timeInfo,
this.featureStore):null},enumerable:!1,configurable:!0});g.prototype.clearCache=function(){this._geometryQueryCache&&this._geometryQueryCache.clear();this._timeExtent=this._allItems=null};g.prototype.executeQuery=function(a,b){void 0===a&&(a={});return k.__awaiter(this,void 0,void 0,function(){var c,d,b,h=this;return k.__generator(this,function(f){switch(f.label){case 0:c=v.clone(a),f.label=1;case 1:return f.trys.push([1,8,,9]),[4,this._schedule(function(){return l.normalizeQuery(c,h.definitionExpression,
h.spatialReference)})];case 2:return c=f.sent(),[4,this._reschedule(function(){return h._checkQuerySupport(c)})];case 3:return c=f.sent(),[4,this._reschedule(function(){return h._executeGeometryQuery(c)})];case 4:return d=f.sent(),[4,this._reschedule(function(){return d.executeObjectIdsQuery(c)})];case 5:return d=f.sent(),[4,this._reschedule(function(){return d.executeTimeQuery(c)})];case 6:return d=f.sent(),[4,this._reschedule(function(){return d.executeAttributesQuery(c)})];case 7:return d=f.sent(),
[3,9];case 8:b=f.sent();if(b!==l.QUERY_ENGINE_EMPTY_RESULT)throw b;d=new t.default([],null,this);return[3,9];case 9:return[2,d.createQueryResponse(c)]}})})};g.prototype.executeQueryForCount=function(a,b){void 0===a&&(a={});return k.__awaiter(this,void 0,void 0,function(){var c,d,b,h=this;return k.__generator(this,function(f){switch(f.label){case 0:c=v.clone(a),c.returnGeometry=!1,c.returnCentroid=!1,c.outSR=null,f.label=1;case 1:return f.trys.push([1,8,,9]),[4,this._schedule(function(){return l.normalizeQuery(c,
h.definitionExpression,h.spatialReference)})];case 2:return c=f.sent(),[4,this._reschedule(function(){return h._checkQuerySupport(c)})];case 3:return c=f.sent(),[4,this._reschedule(function(){return h._executeGeometryQuery(c)})];case 4:return d=f.sent(),[4,this._reschedule(function(){return d.executeObjectIdsQuery(c)})];case 5:return d=f.sent(),[4,this._reschedule(function(){return d.executeTimeQuery(c)})];case 6:return d=f.sent(),[4,this._reschedule(function(){return d.executeAttributesQuery(c)})];
case 7:return d=f.sent(),[3,9];case 8:b=f.sent();if(b!==l.QUERY_ENGINE_EMPTY_RESULT)throw b;return[2,0];case 9:return[2,d.createQueryResponseForCount(c)]}})})};g.prototype.executeQueryForExtent=function(a,b){void 0===a&&(a={});return k.__awaiter(this,void 0,void 0,function(){var c,b,q,h,f,e,m,g,w=this;return k.__generator(this,function(d){switch(d.label){case 0:c=v.clone(a),q=c.outSR,d.label=1;case 1:return d.trys.push([1,8,,9]),[4,this._schedule(function(){return l.normalizeQuery(c,w.definitionExpression,
w.spatialReference)})];case 2:return c=d.sent(),[4,this._reschedule(function(){return w._checkQuerySupport(c)})];case 3:return c=d.sent(),c.returnGeometry=!0,c.returnCentroid=!1,c.outSR=null,[4,this._reschedule(function(){return w._executeGeometryQuery(c)})];case 4:return b=d.sent(),[4,this._reschedule(function(){return b.executeObjectIdsQuery(c)})];case 5:return b=d.sent(),[4,this._reschedule(function(){return b.executeTimeQuery(c)})];case 6:return b=d.sent(),[4,this._reschedule(function(){return b.executeAttributesQuery(c)})];
case 7:b=d.sent();h=b.size;if(!h)return[2,{count:h,extent:null}];p.set(n,p.NEGATIVE_INFINITY);this.featureStore.forEachBounds(b.items,function(a){return p.expand(n,a)},U);f={xmin:n[0],ymin:n[1],xmax:n[3],ymax:n[4],spatialReference:l.cleanFromGeometryEngine(this.spatialReference)};this.hasZ&&isFinite(n[2])&&isFinite(n[5])&&(f.zmin=n[2],f.zmax=n[5]);e=I.project(f,b.spatialReference,q);e.spatialReference=l.cleanFromGeometryEngine(q||this.spatialReference);0===e.xmax-e.xmin&&(m=y.getMetersPerUnitForSR(e.spatialReference),
e.xmin-=m,e.xmax+=m);0===e.ymax-e.ymin&&(m=y.getMetersPerUnitForSR(e.spatialReference),e.ymin-=m,e.ymax+=m);this.hasZ&&null!=e.zmin&&null!=e.zmax&&0===e.zmax-e.zmin&&(m=y.getMetersPerUnitForSR(e.spatialReference),e.zmin-=m,e.zmax+=m);return[2,{count:h,extent:e}];case 8:g=d.sent();if(g===l.QUERY_ENGINE_EMPTY_RESULT)return[2,{count:0,extent:null}];throw g;case 9:return[2]}})})};g.prototype.executeQueryForIds=function(a,b){void 0===a&&(a={});return k.__awaiter(this,void 0,void 0,function(){return k.__generator(this,
function(c){return[2,this.executeQueryForIdSet(a,b).then(function(a){return L.valuesOfSet(a)})]})})};g.prototype.executeQueryForIdSet=function(a,b){void 0===a&&(a={});return k.__awaiter(this,void 0,void 0,function(){var c,b,q,h,f,e=this;return k.__generator(this,function(d){switch(d.label){case 0:c=v.clone(a),c.returnGeometry=!1,c.returnCentroid=!1,c.outSR=null,d.label=1;case 1:return d.trys.push([1,9,,10]),[4,this._schedule(function(){return l.normalizeQuery(c,e.definitionExpression,e.spatialReference)})];
case 2:return c=d.sent(),[4,this._reschedule(function(){return e._checkQuerySupport(c)})];case 3:return c=d.sent(),[4,this._reschedule(function(){return e._executeGeometryQuery(c)})];case 4:return b=d.sent(),[4,this._reschedule(function(){return b.executeObjectIdsQuery(c)})];case 5:return b=d.sent(),[4,this._reschedule(function(){return b.executeTimeQuery(c)})];case 6:return b=d.sent(),[4,this._reschedule(function(){return b.executeAttributesQuery(c)})];case 7:return b=d.sent(),q=b.items,h=new Set,
[4,this._reschedule(function(){for(var a=0,c=q;a<c.length;a++)h.add(b.featureAdapter.getObjectId(c[a]))})];case 8:return d.sent(),[2,h];case 9:f=d.sent();if(f===l.QUERY_ENGINE_EMPTY_RESULT)return[2,new Set];throw f;case 10:return[2]}})})};g.prototype.executeQueryForLatestObservations=function(a,b){void 0===a&&(a={});return k.__awaiter(this,void 0,void 0,function(){var b,d,q,h=this;return k.__generator(this,function(c){switch(c.label){case 0:if(!this.timeInfo||!this.timeInfo.trackIdField)throw new u("feature-store:unsupported-query",
"Missing timeInfo or timeInfo.trackIdField",{query:a,timeInfo:this.timeInfo});b=v.clone(a);c.label=1;case 1:return c.trys.push([1,9,,10]),[4,this._schedule(function(){return l.normalizeQuery(b,h.definitionExpression,h.spatialReference)})];case 2:return b=c.sent(),[4,this._reschedule(function(){return h._checkQuerySupport(b)})];case 3:return b=c.sent(),[4,this._reschedule(function(){return h._executeGeometryQuery(b)})];case 4:return d=c.sent(),[4,this._reschedule(function(){return d.executeObjectIdsQuery(b)})];
case 5:return d=c.sent(),[4,this._reschedule(function(){return d.executeTimeQuery(b)})];case 6:return d=c.sent(),[4,this._reschedule(function(){return d.executeAttributesQuery(b)})];case 7:return d=c.sent(),[4,this._reschedule(function(){return d.filterLatest()})];case 8:return d=c.sent(),[3,10];case 9:q=c.sent();if(q!==l.QUERY_ENGINE_EMPTY_RESULT)throw q;d=new t.default([],null,this);return[3,10];case 10:return[2,d.createQueryResponse(b)]}})})};g.prototype._schedule=function(a){return k.__awaiter(this,
void 0,void 0,function(){return k.__generator(this,function(b){return this._frameQueue?[2,this._frameQueue.push(a)]:[2,a()]})})};g.prototype._reschedule=function(a){return k.__awaiter(this,void 0,void 0,function(){return k.__generator(this,function(b){return this._frameQueue?[2,this._frameQueue.unshift(a)]:[2,a()]})})};g.prototype._update=function(a){for(this._budget=a;!a.done&&this._frameQueue&&this._frameQueue.process();)a.madeProgress();this._budget=null};g.prototype._getAll=function(){if(!this._allItems){var a=
[];this.featureStore.forEach(function(b){return a.push(b)});this._allItems=new t.default(a,null,this)}return this._allItems};g.prototype._executeGeometryQuery=function(a){return k.__awaiter(this,void 0,void 0,function(){var b,c,d,q,h,f,e,g,l,w,n,r,D,u,v,B,p,A,x,z,y=this;return k.__generator(this,function(m){switch(m.label){case 0:b=a.geometry;c=a.outSR;d=a.spatialRel;q=H.isValid(c)&&!H.equals(this.spatialReference,c);if(h=this._geometryQueryCache?q?JSON.stringify({geometry:b,spatialRelationship:d,
outSpatialReference:c}):JSON.stringify({geometry:b,spatialRelationship:d}):null)if(f=this._geometryQueryCache.get(h),!J.isUndefined(f))return[2,f];e=function(b){return k.__awaiter(y,void 0,void 0,function(){var d;return k.__generator(this,function(e){switch(e.label){case 0:return q&&(a.returnGeometry||a.returnCentroid)?[4,b.project(c)]:[3,2];case 1:return d=e.sent(),h&&this._geometryQueryCache.put(h,d,d.size||1),[2,d];case 2:return h&&this._geometryQueryCache.put(h,b,b.size||1),[2,b]}})})};if(!b)return[2,
e(this._getAll())];g=this.featureAdapter;if("esriSpatialRelDisjoint"!==d)return[3,3];l=this._searchFeatures(this._getQueryBBoxes(b));if(!l.length)return[2,e(this._getAll())];r=new Set;D=0;for(u=l;D<u.length;D++)v=u[D],r.add(g.getObjectId(v));return[4,this._reschedule(function(){var a=0;w=Array(r.size);y.featureStore.forEach(function(b){return w[a++]=b});n=r})];case 1:return m.sent(),[4,this._reschedule(function(){return k.__awaiter(y,void 0,void 0,function(){var a,c,e;return k.__generator(this,function(f){switch(f.label){case 0:return[4,
C.getSpatialQueryOperator(d,b,this.geometryType,this.hasZ,this.hasM)];case 1:return a=f.sent(),c=function(b){return!n.has(g.getObjectId(b))||a(g.getGeometry(b))},e=t.default.bind,[4,this._runSpatialFilter(w,c)];case 2:return[2,new (e.apply(t.default,[void 0,f.sent(),b,this]))]}})})})];case 2:return B=m.sent(),[2,e(B)];case 3:return p=this._searchFeatures(this._getQueryBBoxes(b)),p.length?(A=this._canExecuteSoloPass(b,a))?[2,e(new t.default(p,b,this))]:[4,C.getSpatialQueryOperator(d,b,this.geometryType,
this.hasZ,this.hasM)]:(B=new t.default([],b,this),h&&this._geometryQueryCache.put(h,B,B.size||1),[2,B]);case 4:return x=m.sent(),[4,this._runSpatialFilter(p,function(a){return x(g.getGeometry(a))})];case 5:return z=m.sent(),[2,e(new t.default(z,b,this))]}})})};g.prototype._runSpatialFilter=function(a,b){return k.__awaiter(this,void 0,void 0,function(){var c,d,g,h=this;return k.__generator(this,function(f){if(!b)return[2,a];if(!this._budget)return[2,a.filter(function(a){return b(a)})];c=0;d=[];g=function(){return k.__awaiter(h,
void 0,void 0,function(){var e;return k.__generator(this,function(f){switch(f.label){case 0:if(!(c<a.length))return[3,3];e=a[c];b(e)&&d.push(e);return this._budget.done?[4,this._reschedule(function(){return g()})]:[3,2];case 1:f.sent(),f.label=2;case 2:return++c,[3,0];case 3:return[2]}})})};return[2,this._reschedule(function(){return g()}).then(function(){return d})]})})};g.prototype._canExecuteSoloPass=function(a,b){var c=this.geometryType;b=b.spatialRel;return C.canQueryWithRBush(a)&&("esriSpatialRelEnvelopeIntersects"===
b||"esriGeometryPoint"===c&&("esriSpatialRelIntersects"===b||"esriSpatialRelContains"===b||"esriSpatialRelWithin"===b))};g.prototype._getQueryBBoxes=function(a){if(C.canQueryWithRBush(a)){if(G.isExtent(a))return[E.fromValues(a.xmin,a.ymin,a.xmax,a.ymax)];if(G.isPolygon(a))return a.rings.map(function(a){return E.fromValues(Math.min(a[0][0],a[2][0]),Math.min(a[0][1],a[2][1]),Math.max(a[0][0],a[2][0]),Math.max(a[0][1],a[2][1]))})}return[M.getBoundsXY(E.create(),a)]};g.prototype._searchFeatures=function(a){for(var b=
0;b<a.length;b++)this.featureStore.forEachInBounds(a[b],function(a){z.add(a)});var c=Array(z.size),d=0;z.forEach(function(a){return c[d++]=a});z.clear();return c};g.prototype._checkQuerySupport=function(a){return k.__awaiter(this,void 0,void 0,function(){return k.__generator(this,function(b){if(0>a.distance||null!=a.geometryPrecision||a.multipatchOption||a.pixelSize||a.relationParam||a.text)throw new u("feature-store:unsupported-query","Unsupported query options",{query:a});return[2,K.all([this._checkAttributesQuerySupport(a),
this._checkStatisticsQuerySupport(a),C.checkSpatialQuerySupport(a,this.geometryType,this.spatialReference),I.checkProjectionSupport(this.spatialReference,a.outSR)]).then(function(){return a})]})})};g.prototype._checkAttributesQuerySupport=function(a){var b=a.outFields,c=a.orderByFields,d=a.returnDistinctValues,g=a.outStatistics,h=g?g.map(function(a){return a.outStatisticFieldName&&a.outStatisticFieldName.toLowerCase()}):[];c&&0<c.length&&(c=c.map(function(a){var b=a.toLowerCase();return-1<b.indexOf(" asc")?
b.split(" asc")[0]:-1<b.indexOf(" desc")?b.split(" desc")[0]:a}).filter(function(a){return-1===h.indexOf(a)}),r.validateFields(this.fieldsIndex,c,"orderByFields contains missing fields"));if(b&&0<b.length)r.validateFields(this.fieldsIndex,b,"outFields contains missing fields");else if(d)throw new u("feature-store:unsupported-query","outFields should be specified for returnDistinctValues",{query:a});r.validateWhere(this.fieldsIndex,a.where)};g.prototype._checkStatisticsQuerySupport=function(a){return k.__awaiter(this,
void 0,void 0,function(){var b,c,d,g,h,f,e,m,l,n,p,v,t;return k.__generator(this,function(k){b=a.outStatistics;c=a.groupByFieldsForStatistics;d=a.having;g=c&&c.length;h=b&&b.length;if(d){if(!g||!h)throw new u("feature-store:unsupported-query","outStatistics and groupByFieldsForStatistics should be specified with having",{query:a});r.validateHaving(this.fieldsIndex,d,b)}if(h){if(!R(b))return[2];f=b.map(function(a){return a.onStatisticField});r.validateFields(this.fieldsIndex,f,"onStatisticFields contains missing fields");
g&&r.validateFields(this.fieldsIndex,c,"groupByFieldsForStatistics contains missing fields");e=0;for(m=b;e<m.length;e++)if(l=m[e],n=l.onStatisticField,p=l.statisticType,(v="percentile_disc"===p||"percentile_cont"===p)&&"statisticParameters"in l){if(t=l.statisticParameters,!t)throw new u("feature-store:unsupported-query","statisticParamters should be set for percentile type",{definition:l,query:a});}else if("count"!==p&&n&&r.hasInvalidFieldType(n,this.fieldsIndex))throw new u("feature-store:unsupported-query",
"outStatistics contains non-numeric fields",{definition:l,query:a});}return[2]})})};return g}();x.default=A;var U=p.create(),n=p.create()});