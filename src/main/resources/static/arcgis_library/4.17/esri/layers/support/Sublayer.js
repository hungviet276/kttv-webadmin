// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.17/esri/copyright.txt for details.
//>>built
define("require exports tslib ../../geometry ../../PopupTemplate ../../renderers ../../request ../../symbols ../../core/Collection ../../core/Error ../../core/HandleOwner ../../core/Identifiable ../../core/lang ../../core/Loadable ../../core/Logger ../../core/MultiOriginJSONSupport ../../core/promiseUtils ../../core/urlUtils ../../core/accessorSupport/decorators ../../core/accessorSupport/ensureType ../../core/accessorSupport/PropertyOrigin ../../core/accessorSupport/utils ./FeatureType ./Field ./FieldsIndex ./fieldUtils ./LabelClass ./source/DataLayerSource ./source/MapLayerSource ../../support/popupUtils ../../tasks/support/Query @dojo/framework/shim/Promise".split(" "),
function(p,V,e,B,C,x,D,E,F,l,G,H,q,I,J,K,L,M,d,m,N,r,O,P,Q,R,S,y,t,T,z){function u(e){return e&&"esriSMS"===e.type}function f(e,b,d){return{ignoreOrigin:!0,enabled:d&&d.writeSublayerStructure||!1}}function k(e,b,d){return{ignoreOrigin:!0,enabled:d?d.writeSublayerStructure||this.originIdOf(b)>=N.nameToId(d.origin):!1}}var v=J.getLogger("esri.layers.support.Sublayer"),U=0,h=new Set;h.add("layer");h.add("parent");h.add("loaded");h.add("loadStatus");h.add("loadError");h.add("loadWarnings");return function(A){function b(a){a=
A.call(this,a)||this;a.capabilities=void 0;a.fields=null;a.fullExtent=null;a.globalIdField=null;a.legendEnabled=!0;a.objectIdField=null;a.popupEnabled=!0;a.popupTemplate=null;a.sourceJSON=null;a.title=null;a.typeIdField=null;a.types=null;return a}e.__extends(b,A);n=b;b.prototype.load=function(a){return e.__awaiter(this,void 0,void 0,function(){var c=this;return e.__generator(this,function(b){this.addResolvingPromise(function(){return e.__awaiter(c,void 0,void 0,function(){var c,b,w,d,f;return e.__generator(this,
function(g){switch(g.label){case 0:if(!this.layer&&!this.url)throw new l("sublayer:missing-layer","Sublayer can't be loaded without being part of a layer",{sublayer:this});c=null;return!this.layer||2<this.originIdOf("url")||"data-layer"===(null===(d=this.source)||void 0===d?void 0:d.type)?[4,D(this.url,e.__assign({responseType:"json",query:{f:"json"}},a))]:[3,2];case 1:return b=g.sent(),c=b.data,[3,4];case 2:return w=this.id,"map-layer"===(null===(f=this.source)||void 0===f?void 0:f.type)&&(w=this.source.mapLayerId),
[4,this.layer.fetchSublayerInfo(w,a)];case 3:c=g.sent(),g.label=4;case 4:return c&&(this.sourceJSON=c,this.read({layerDefinition:c},{origin:"service"})),[2]}})})}());return[2,this]})})};b.prototype.readCapabilities=function(a,c){c=c.layerDefinition||c;a=(a=c.capabilities||a)?a.toLowerCase().split(",").map(function(a){return a.trim()}):[];return{exportMap:{supportsModification:!!c.canModifyLayer},operations:{supportsQuery:-1!==a.indexOf("query")}}};Object.defineProperty(b.prototype,"definitionExpression",
{set:function(a){this._setAndNotifyLayer("definitionExpression",a)},enumerable:!1,configurable:!0});Object.defineProperty(b.prototype,"fieldsIndex",{get:function(){return new Q(this.fields||[])},enumerable:!1,configurable:!0});b.prototype.readGlobalIdFieldFromService=function(a,c){c=c.layerDefinition||c;if(c.globalIdField)return c.globalIdField;if(c.fields)for(a=0,c=c.fields;a<c.length;a++){var b=c[a];if("esriFieldTypeGlobalID"===b.type)return b.name}};Object.defineProperty(b.prototype,"id",{get:function(){var a=
this._get("id");return null==a?U++:a},set:function(a){this._get("id")!==a&&(!1===this.get("layer.capabilities.exportMap.supportsDynamicLayers")?this._logLockedError("id","capability not available 'layer.capabilities.exportMap.supportsDynamicLayers'"):this._set("id",a))},enumerable:!1,configurable:!0});Object.defineProperty(b.prototype,"labelingInfo",{set:function(a){this._setAndNotifyLayer("labelingInfo",a)},enumerable:!1,configurable:!0});b.prototype.writeLabelingInfo=function(a,c,b,g){a&&a.length&&
(c.layerDefinition={drawingInfo:{labelingInfo:a.map(function(a){return a.write({},g)})}})};Object.defineProperty(b.prototype,"labelsVisible",{set:function(a){this._setAndNotifyLayer("labelsVisible",a)},enumerable:!1,configurable:!0});Object.defineProperty(b.prototype,"layer",{set:function(a){this._set("layer",a);this.sublayers&&this.sublayers.forEach(function(c){return c.layer=a})},enumerable:!1,configurable:!0});Object.defineProperty(b.prototype,"listMode",{set:function(a){this._set("listMode",a)},
enumerable:!1,configurable:!0});Object.defineProperty(b.prototype,"minScale",{set:function(a){this._setAndNotifyLayer("minScale",a)},enumerable:!1,configurable:!0});b.prototype.readMinScale=function(a,c){return c.minScale||c.layerDefinition&&c.layerDefinition.minScale||0};Object.defineProperty(b.prototype,"maxScale",{set:function(a){this._setAndNotifyLayer("maxScale",a)},enumerable:!1,configurable:!0});b.prototype.readMaxScale=function(a,c){return c.maxScale||c.layerDefinition&&c.layerDefinition.maxScale||
0};b.prototype.readObjectIdFieldFromService=function(a,c){c=c.layerDefinition||c;if(c.objectIdField)return c.objectIdField;if(c.fields)for(a=0,c=c.fields;a<c.length;a++){var b=c[a];if("esriFieldTypeOID"===b.type)return b.name}};Object.defineProperty(b.prototype,"opacity",{set:function(a){this._setAndNotifyLayer("opacity",a)},enumerable:!1,configurable:!0});b.prototype.readOpacity=function(a,c){a=c.layerDefinition;return 1-.01*(null!=a.transparency?a.transparency:a.drawingInfo.transparency)};b.prototype.writeOpacity=
function(a,c,b,g){c.layerDefinition={drawingInfo:{transparency:100-100*a}}};b.prototype.writeParent=function(a,c){c.parentLayerId=this.parent&&this.parent!==this.layer?this.parent.id:-1};Object.defineProperty(b.prototype,"defaultPopupTemplate",{get:function(){return this.createPopupTemplate()},enumerable:!1,configurable:!0});Object.defineProperty(b.prototype,"renderer",{set:function(a){if(a)for(var c=0,b=a.getSymbols();c<b.length;c++)if(E.isSymbol3D(b[c])){v.warn("Sublayer renderer should use 2D symbols");
break}this._setAndNotifyLayer("renderer",a)},enumerable:!1,configurable:!0});Object.defineProperty(b.prototype,"source",{get:function(){return this._get("source")||new t.MapLayerSource({mapLayerId:this.id})},set:function(a){this._setAndNotifyLayer("source",a)},enumerable:!1,configurable:!0});Object.defineProperty(b.prototype,"sublayers",{set:function(a){this._handleSublayersChange(a,this._get("sublayers"));this._set("sublayers",a)},enumerable:!1,configurable:!0});b.prototype.castSublayers=function(a){return m.default(F.ofType(n),
a)};b.prototype.writeSublayers=function(a,c,b){this.get("sublayers.length")&&(c[b]=this.sublayers.map(function(a){return a.id}).toArray().reverse())};b.prototype.readTypeIdField=function(a,c){c=c.layerDefinition||c;if(a=c.typeIdField)if(c=R.getField(c.fields,a))return c.name;return null};Object.defineProperty(b.prototype,"url",{get:function(){var a,c,b=null!==(c=null===(a=this.layer)||void 0===a?void 0:a.parsedUrl)&&void 0!==c?c:this._lastParsedUrl;a=this.source;if(!b)return null;this._lastParsedUrl=
b;if("map-layer"===(null===a||void 0===a?void 0:a.type))return b.path+"/"+a.mapLayerId;a={layer:JSON.stringify({source:this.source})};return b.path+"/dynamicLayer?"+M.objectToQuery(a)},set:function(a){a?this._override("url",a):this._clearOverride("url")},enumerable:!1,configurable:!0});Object.defineProperty(b.prototype,"visible",{set:function(a){this._setAndNotifyLayer("visible",a)},enumerable:!1,configurable:!0});b.prototype.writeVisible=function(a,c,b,g){c[b]=this.getAtOrigin("defaultVisibility",
"service")||a};b.prototype.clone=function(){var a=r.getProperties(this).store,c=new n;r.getProperties(c).store=a.clone(h);this.url;c._lastParsedUrl=this._lastParsedUrl;return c};b.prototype.createPopupTemplate=function(a){return T.createPopupTemplate(this,a)};b.prototype.createQuery=function(){return new z({returnGeometry:!0,where:this.definitionExpression||"1\x3d1"})};b.prototype.createFeatureLayer=function(){var a,c;return e.__awaiter(this,void 0,void 0,function(){var b,g,d;return e.__generator(this,
function(e){switch(e.label){case 0:if(this.hasOwnProperty("sublayers"))return[2,null];b=null===(a=this.layer)||void 0===a?void 0:a.parsedUrl;return[4,new Promise(function(a,c){p(["../FeatureLayer"],a,c)})];case 1:return g=e.sent(),d=new g({url:b.path}),b&&this.source&&("map-layer"===this.source.type?d.layerId=this.source.mapLayerId:d.dynamicDataSource=this.source),null!=this.layer.refreshInterval&&(d.refreshInterval=this.layer.refreshInterval),this.definitionExpression&&(d.definitionExpression=this.definitionExpression),
2<this.originIdOf("labelingInfo")&&(d.labelingInfo=q.clone(this.labelingInfo)),0<this.originIdOf("labelsVisible")&&(d.labelsVisible=this.labelsVisible),0<this.originIdOf("legendEnabled")&&(d.legendEnabled=this.legendEnabled),0<this.originIdOf("visible")&&(d.visible=this.visible),0<this.originIdOf("minScale")&&(d.minScale=this.minScale),0<this.originIdOf("maxScale")&&(d.maxScale=this.maxScale),0<this.originIdOf("opacity")&&(d.opacity=this.opacity),0<this.originIdOf("popupTemplate")&&(d.popupTemplate=
q.clone(this.popupTemplate)),2<this.originIdOf("renderer")&&(d.renderer=q.clone(this.renderer)),"data-layer"===(null===(c=this.source)||void 0===c?void 0:c.type)&&(d.dynamicDataSource=this.source.clone()),0<this.originIdOf("title")&&(d.title=this.title),[2,d]}})})};b.prototype.getFeatureType=function(a){var c=this.typeIdField;if(!c||!a)return null;var b=a.attributes?a.attributes[c]:void 0;if(null==b)return null;var d=null;this.types.some(function(a){var c=a.id;if(null==c)return!1;c.toString()===b.toString()&&
(d=a);return!!d});return d};b.prototype.getFieldDomain=function(a,c){return(c=this.getFeatureType(c&&c.feature))&&(c=c.domains&&c.domains[a])&&"inherited"!==c.type?c:this._getLayerDomain(a)};b.prototype.queryFeatures=function(a,c){var b=this;void 0===a&&(a=this.createQuery());return this.load().then(function(){if(!b.get("capabilities.operations.supportsQuery"))throw new l("Sublayer.queryFeatures","this layer doesn't support queries.");return L.all([new Promise(function(a,c){p(["../../tasks/operations/query"],
a,c)}),new Promise(function(a,c){p(["../../tasks/support/FeatureSet"],a,c)})])}).then(function(d){var e=d[0].executeQuery,g=d[1];return e(b.url,z.from(a),b.layer?b.layer.spatialReference:null,c).then(function(a){return g.fromJSON(a.data)})}).then(function(a){a&&a.features&&a.features.forEach(function(a){a.sourceLayer=b});return a})};b.prototype.toExportImageJSON=function(){var a=this,c,b={id:this.id,source:null===(c=this.source)||void 0===c?void 0:c.toJSON()};this.definitionExpression&&(b.definitionExpression=
this.definitionExpression);var d=["renderer","labelingInfo","opacity","labelsVisible"].reduce(function(c,b){c[b]=a.originIdOf(b);return c},{});Object.keys(d).some(function(a){return 2<=d[a]})&&(c=b.drawingInfo={},2<=d.renderer&&(c.renderer=this.renderer?this.renderer.toJSON():null),2<=d.labelsVisible&&(c.showLabels=this.labelsVisible),this.labelsVisible&&2<=d.labelingInfo&&(c.labelingInfo=this.labelingInfo?this.labelingInfo.map(function(a){return a.write({},{origin:"service"})}):null,c.showLabels=
!0),2<=d.opacity&&(c.transparency=100-100*this.opacity),this._assignDefaultSymbolColors(c.renderer));return b};b.prototype._assignDefaultSymbolColors=function(a){this._forEachSimpleMarkerSymbols(a,function(a){a.color||"esriSMSX"!==a.style&&"esriSMSCross"!==a.style||(a.color=a.outline&&a.outline.color?a.outline.color:[0,0,0,0])})};b.prototype._forEachSimpleMarkerSymbols=function(a,b){if(a){var c=0,d="uniqueValueInfos"in a?a.uniqueValueInfos:"classBreakInfos"in a?a.classBreakInfos:[];for(;c<d.length;c++){var e=
d[c];u(e.symbol)&&b(e.symbol)}"symbol"in a&&u(a.symbol)&&b(a.symbol);"defaultSymbol"in a&&u(a.defaultSymbol)&&b(a.defaultSymbol)}};b.prototype._setAndNotifyLayer=function(a,b){var c=this.layer,d=this._get(a),e,f;switch(a){case "definitionExpression":e="supportsSublayerDefinitionExpression";case "minScale":case "maxScale":case "visible":e="supportsSublayerVisibility";break;case "labelingInfo":case "labelsVisible":case "opacity":case "renderer":case "source":e="supportsDynamicLayers",f="supportsModification"}var h=
r.getProperties(this).getDefaultOrigin();if("service"!==h){if(e&&!1===this.get("layer.capabilities.exportMap."+e)){this._logLockedError(a,"capability not available 'layer.capabilities.exportMap."+e+"'");return}if(f&&!1===this.get("capabilities.exportMap."+f)){this._logLockedError(a,"capability not available 'capabilities.exportMap."+f+"'");return}}"source"===a&&"not-loaded"!==this.loadStatus?this._logLockedError(a,"'source' can't be changed after calling sublayer.load()"):(this._set(a,b),"service"!==
h&&d!==b&&c&&c.emit&&c.emit("sublayer-update",{propertyName:a,target:this}))};b.prototype._handleSublayersChange=function(a,b){var c=this;b&&(b.forEach(function(a){a.parent=null;a.layer=null}),this.handles.removeAll());a&&(a.forEach(function(a){a.parent=c;a.layer=c.layer}),this.handles.add([a.on("after-add",function(a){a=a.item;a.parent=c;a.layer=c.layer}),a.on("after-remove",function(a){a=a.item;a.parent=null;a.layer=null}),a.on("before-changes",function(a){var b=c.get("layer.capabilities.exportMap.supportsSublayersChanges");
null==b||b||(v.error(new l("sublayer:sublayers-non-modifiable","Sublayer can't be added, moved, or removed from the layer's sublayers",{sublayer:c,layer:c.layer})),a.preventDefault())})]))};b.prototype._logLockedError=function(a,b){v.error(new l("sublayer:locked","Property '"+a+"' can't be changed on Sublayer from the layer '"+this.layer.id+"'",{reason:b,sublayer:this,layer:this.layer}))};b.prototype._getLayerDomain=function(a){return(a=this.fieldsIndex.get(a))?a.domain:null};var n;b.test={isSublayerStructureOverridePolicy:function(a){return a===
f}};e.__decorate([d.property({readOnly:!0})],b.prototype,"capabilities",void 0);e.__decorate([d.reader("service","capabilities",["layerDefinition.canModifyLayer","layerDefinition.capabilities"])],b.prototype,"readCapabilities",null);e.__decorate([d.property({type:String,value:null,json:{read:{source:"layerDefinition.definitionExpression"},write:{target:"layerDefinition.definitionExpression",overridePolicy:k}}})],b.prototype,"definitionExpression",null);e.__decorate([d.property({type:[P],json:{origins:{service:{read:{source:"layerDefinition.fields"}}}}})],
b.prototype,"fields",void 0);e.__decorate([d.property({readOnly:!0,dependsOn:["fields"]})],b.prototype,"fieldsIndex",null);e.__decorate([d.property({type:B.Extent,json:{read:{source:"layerDefinition.extent"}}})],b.prototype,"fullExtent",void 0);e.__decorate([d.property({type:String})],b.prototype,"globalIdField",void 0);e.__decorate([d.reader("service","globalIdField",["layerDefinition.globalIdField","layerDefinition.fields"])],b.prototype,"readGlobalIdFieldFromService",null);e.__decorate([d.property({type:Number,
json:{write:{ignoreOrigin:!0}}})],b.prototype,"id",null);e.__decorate([d.property({value:null,type:[S],json:{read:{source:"layerDefinition.drawingInfo.labelingInfo"},write:{target:"layerDefinition.drawingInfo.labelingInfo",overridePolicy:f}}})],b.prototype,"labelingInfo",null);e.__decorate([d.writer("labelingInfo")],b.prototype,"writeLabelingInfo",null);e.__decorate([d.property({type:Boolean,value:!0,json:{read:{source:"layerDefinition.drawingInfo.showLabels"},write:{target:"layerDefinition.drawingInfo.showLabels",
overridePolicy:f}}})],b.prototype,"labelsVisible",null);e.__decorate([d.property({value:null})],b.prototype,"layer",null);e.__decorate([d.property({type:Boolean,value:!0,json:{origins:{service:{read:{enabled:!1}}},read:{source:"showLegend"},write:{target:"showLegend",overridePolicy:k}}})],b.prototype,"legendEnabled",void 0);e.__decorate([d.property({type:["show","hide","hide-children"],value:"show",json:{read:!1,write:!1,origins:{"web-scene":{read:!0,write:!0}}}})],b.prototype,"listMode",null);e.__decorate([d.property({type:Number,
value:0,json:{write:{overridePolicy:f}}})],b.prototype,"minScale",null);e.__decorate([d.reader("minScale",["minScale","layerDefinition.minScale"])],b.prototype,"readMinScale",null);e.__decorate([d.property({type:Number,value:0,json:{write:{overridePolicy:f}}})],b.prototype,"maxScale",null);e.__decorate([d.reader("maxScale",["maxScale","layerDefinition.maxScale"])],b.prototype,"readMaxScale",null);e.__decorate([d.property({type:String})],b.prototype,"objectIdField",void 0);e.__decorate([d.reader("service",
"objectIdField",["layerDefinition.objectIdField","layerDefinition.fields"])],b.prototype,"readObjectIdFieldFromService",null);e.__decorate([d.property({type:Number,value:1,json:{write:{target:"layerDefinition.drawingInfo.transparency",overridePolicy:f}}})],b.prototype,"opacity",null);e.__decorate([d.reader("opacity",["layerDefinition.drawingInfo.transparency","layerDefinition.transparency"])],b.prototype,"readOpacity",null);e.__decorate([d.writer("opacity")],b.prototype,"writeOpacity",null);e.__decorate([d.property({json:{type:Number,
write:{target:"parentLayerId",allowNull:!0,overridePolicy:f}}})],b.prototype,"parent",void 0);e.__decorate([d.writer("parent")],b.prototype,"writeParent",null);e.__decorate([d.property({type:Boolean,value:!0,json:{read:{source:"disablePopup",reader:function(a,b){return!b.disablePopup}},write:{target:"disablePopup",overridePolicy:k,writer:function(a,b,d){b[d]=!a}}}})],b.prototype,"popupEnabled",void 0);e.__decorate([d.property({type:C,json:{read:{source:"popupInfo"},write:{target:"popupInfo",overridePolicy:k}}})],
b.prototype,"popupTemplate",void 0);e.__decorate([d.property({readOnly:!0,dependsOn:["fields","title"]})],b.prototype,"defaultPopupTemplate",null);e.__decorate([d.property({types:x.rendererTypes,value:null,json:{name:"layerDefinition.drawingInfo.renderer",write:{overridePolicy:f},origins:{"web-scene":{types:x.webSceneRendererTypes,name:"layerDefinition.drawingInfo.renderer",write:{overridePolicy:f}}}}})],b.prototype,"renderer",null);e.__decorate([d.property({types:{key:"type",base:null,typeMap:{"data-layer":y.DataLayerSource,
"map-layer":t.MapLayerSource}},cast:function(a){if(a){if("mapLayerId"in a)return m.ensureClass(t.MapLayerSource,a);if("dataSource"in a)return m.ensureClass(y.DataLayerSource,a)}return a},json:{name:"layerDefinition.source",write:{overridePolicy:f}}})],b.prototype,"source",null);e.__decorate([d.property()],b.prototype,"sourceJSON",void 0);e.__decorate([d.property({value:null,json:{type:[m.Integer],write:{target:"subLayerIds",allowNull:!0,overridePolicy:f}}})],b.prototype,"sublayers",null);e.__decorate([d.cast("sublayers")],
b.prototype,"castSublayers",null);e.__decorate([d.writer("sublayers")],b.prototype,"writeSublayers",null);e.__decorate([d.property({type:String,json:{read:{source:"name"},write:{target:"name",allowNull:!0,overridePolicy:k}}})],b.prototype,"title",void 0);e.__decorate([d.property({type:String})],b.prototype,"typeIdField",void 0);e.__decorate([d.reader("typeIdField",["layerDefinition.typeIdField"])],b.prototype,"readTypeIdField",null);e.__decorate([d.property({type:[O],json:{origins:{service:{read:{source:"layerDefinition.types"}}}}})],
b.prototype,"types",void 0);e.__decorate([d.property({type:String,dependsOn:["layer","source"],json:{read:{source:"layerUrl"},write:{target:"layerUrl",overridePolicy:function(){return{enabled:this._isOverridden("url")}}}}})],b.prototype,"url",null);e.__decorate([d.property({type:Boolean,value:!0,json:{read:{source:"defaultVisibility"},write:{target:"defaultVisibility",overridePolicy:f}}})],b.prototype,"visible",null);e.__decorate([d.writer("visible")],b.prototype,"writeVisible",null);return b=n=e.__decorate([d.subclass("esri.layers.support.Sublayer")],
b)}(G.HandleOwnerMixin(K.MultiOriginJSONMixin(H.IdentifiableMixin(I))))});