// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.17/esri/copyright.txt for details.
//>>built
define("require exports tslib ../../request ../../core/arrayUtils ../../core/Error ../../core/maybe ./arcgisLayerUrl ./lazyLayerLoader @dojo/framework/shim/Promise".split(" "),function(v,m,b,w,x,y,z,A,B){function p(d,a){return d?x.find(d,function(e){return e.id===a}):null}function C(d,a,e){function f(c,d){c=b.__assign(b.__assign({},e),{layerId:c,sublayerTitleMode:"service-name"});z.isSome(d)&&(c.sourceJSON=d);return new a.Constructor(c)}a.sublayerIds.forEach(function(c){c=f(c,p(a.sublayerInfos,c));
d.add(c)});a.tableIds.forEach(function(c){c=f(c,p(a.tableInfos,c));d.tables.add(c)})}function D(d){var a,e;return b.__awaiter(this,void 0,void 0,function(){var f,c,g,h,t,u,r,l,m,k,p,q;return b.__generator(this,function(b){switch(b.label){case 0:f=A.parse(d);if(!f)throw new y("arcgis-layers:url-mismatch","The url '${url}' is not a valid arcgis resource",{url:d});c=f.serverType;g=f.sublayer;t={FeatureServer:"FeatureLayer",StreamServer:"StreamLayer",VectorTileServer:"VectorTileLayer"};switch(c){case "MapServer":h=
null!=g?"FeatureLayer":E(d).then(function(a){return a?"TileLayer":"MapImageLayer"});break;case "ImageServer":h=n(d).then(function(a){var c=a.tileInfo&&a.tileInfo.format;return a.tileInfo?c&&"LERC"===c.toUpperCase()&&a.cacheType&&"elevation"===a.cacheType.toLowerCase()?"ElevationLayer":"ImageryTileLayer":"ImageryLayer"});break;case "SceneServer":h=n(f.url.path).then(function(a){var c={Point:"SceneLayer","3DObject":"SceneLayer",IntegratedMesh:"IntegratedMeshLayer",PointCloud:"PointCloudLayer",Building:"BuildingSceneLayer"};
return a&&Array.isArray(a.layers)&&0<a.layers.length&&(a=a.layers[0].layerType,null!=c[a])?c[a]:"SceneLayer"});break;default:h=t[c]}u={FeatureLayer:!0,SceneLayer:!0};r="FeatureServer"===c;l={parsedUrl:f,Constructor:null,layerOrTableId:r?g:null,sublayerIds:null,tableIds:null};return[4,h];case 1:return m=b.sent(),u[m]&&null==g?[4,F(d,c)]:[3,3];case 2:k=b.sent(),r&&(l.sublayerInfos=k.layerInfos,l.tableInfos=k.tableInfos),p=k.layerIds.length+k.tableIds.length,1!==p?(l.sublayerIds=k.layerIds,l.tableIds=
k.tableIds):r&&(l.layerOrTableId=null!==(a=k.layerIds[0])&&void 0!==a?a:k.tableIds[0],l.sourceJSON=null!==(e=k.layerInfos[0])&&void 0!==e?e:k.tableInfos[0]),b.label=3;case 3:return q=l,[4,G(m)];case 4:return q.Constructor=b.sent(),[2,l]}})})}function F(d,a){return b.__awaiter(this,void 0,void 0,function(){var e,f,c,g,h;return b.__generator(this,function(b){switch(b.label){case 0:return f=!1,"FeatureServer"!==a?[3,2]:[4,H(d)];case 1:return c=b.sent(),f=!!c.layersJSON,e=c.layersJSON||c.serviceJSON,
[3,4];case 2:return[4,n(d)];case 3:e=b.sent(),b.label=4;case 4:return g=null===e||void 0===e?void 0:e.layers,h=null===e||void 0===e?void 0:e.tables,[2,{layerIds:(null===g||void 0===g?void 0:g.map(function(a){return a.id}).reverse())||[],tableIds:(null===h||void 0===h?void 0:h.map(function(a){return a.id}).reverse())||[],layerInfos:f?g:[],tableInfos:f?h:[]}]}})})}function q(d){return!d.type||"Feature Layer"===d.type}function H(d){var a,e;return b.__awaiter(this,void 0,void 0,function(){var f,c,g;return b.__generator(this,
function(b){switch(b.label){case 0:return[4,n(d)];case 1:return f=(f=b.sent())||{},f.layers=(null===(a=f.layers)||void 0===a?void 0:a.filter(q))||[],c={serviceJSON:f},10.5>f.currentVersion?[2,c]:[4,n(d+"/layers")];case 2:return g=b.sent(),c.layersJSON={layers:(null===(e=null===g||void 0===g?void 0:g.layers)||void 0===e?void 0:e.filter(q))||[],tables:(null===g||void 0===g?void 0:g.tables)||[]},[2,c]}})})}function G(d){return b.__awaiter(this,void 0,void 0,function(){var a;return b.__generator(this,
function(b){a=B.layerLookupMap[d];return[2,a()]})})}function E(d){return b.__awaiter(this,void 0,void 0,function(){var a;return b.__generator(this,function(b){switch(b.label){case 0:return[4,n(d)];case 1:return a=b.sent(),[2,a.tileInfo]}})})}function n(d){return b.__awaiter(this,void 0,void 0,function(){var a;return b.__generator(this,function(b){switch(b.label){case 0:return[4,w(d,{responseType:"json",query:{f:"json"}})];case 1:return a=b.sent(),[2,a.data]}})})}Object.defineProperty(m,"__esModule",
{value:!0});m.fromUrl=void 0;m.fromUrl=function(d){return b.__awaiter(this,void 0,void 0,function(){var a,e,f,c;return b.__generator(this,function(g){switch(g.label){case 0:return[4,D(d.url)];case 1:return a=g.sent(),e=b.__assign(b.__assign({},d.properties),{url:d.url}),a.sublayerIds?[4,new Promise(function(a,b){v(["../GroupLayer"],a,b)})]:(null!=a.layerOrTableId&&(e.layerId=a.layerOrTableId,e.sourceJSON=a.sourceJSON),[2,new a.Constructor(e)]);case 2:return f=g.sent(),c=new f({title:a.parsedUrl.title}),
C(c,a,e),[2,c]}})})}});