// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.17/esri/copyright.txt for details.
//>>built
define("require exports tslib ../../../core/Error ../../../core/Logger ../../../core/maybe ../../../core/promiseUtils ../../../core/SetUtils ../../../geometry/support/aaBoundingRect ../../../geometry/support/boundsUtils ./spatialQuerySupport ./timeSupport ./utils ../../../tasks/support/Query ../../../views/2d/layers/features/FeatureStore2D ../../../views/2d/layers/features/support/whereUtils".split(" "),function(h,k,e,l,m,n,p,f,q,r,t,u,v,w,x,y){Object.defineProperty(k,"__esModule",{value:!0});var z=
m.getLogger("esri.views.2d.layers.features.controllers.FeatureFilter");h=function(){function b(a){this._geometryBounds=q.create();this._idToVisibility=new Map;this._serviceInfo=a}Object.defineProperty(b.prototype,"hash",{get:function(){return this._hash},enumerable:!1,configurable:!0});b.prototype.check=function(a){return this._applyFilter(a)};b.prototype.clear=function(){var a=this._resetAllHiddenIds();this.update();return{show:a,hide:[]}};b.prototype.invalidate=function(){var a=this;this._idToVisibility.forEach(function(c,
b){a._idToVisibility.set(b,0)})};b.prototype.setKnownIds=function(a){for(var b=0;b<a.length;b++)this._idToVisibility.set(a[b],1)};b.prototype.setTrue=function(a){var b=this,g=[],d=[],e=f.SetFromValues(a);this._idToVisibility.forEach(function(a,c){a=!!(b._idToVisibility.get(c)&1);var f=e.has(c);!a&&f?g.push(c):a&&!f&&d.push(c);b._idToVisibility.set(c,f?3:0)});return{show:g,hide:d}};b.prototype.createQuery=function(){return w.fromJSON({geometry:this.geometry,spatialRel:this.spatialRel,where:this.where,
timeExtent:this.timeExtent,objectIds:this.objectIds})};b.prototype.update=function(a,b){return e.__awaiter(this,void 0,void 0,function(){var c;return e.__generator(this,function(d){switch(d.label){case 0:return this._hash=JSON.stringify(a),[4,v.normalizeQueryLike(a,null,b)];case 1:return c=d.sent(),[4,p.all([this._setGeometryFilter(c),this._setIdFilter(c),this._setAttributeFilter(c),this._setTimeFilter(c)])];case 2:return d.sent(),[2]}})})};b.prototype._setAttributeFilter=function(a){return e.__awaiter(this,
void 0,void 0,function(){var b;return e.__generator(this,function(c){switch(c.label){case 0:if(!a||!a.where)return this.where=this._clause=null,[2];b=this;return[4,y.createWhereClause(a.where,this._serviceInfo.fieldsIndex)];case 1:return b._clause=c.sent(),this.where=a.where,[2]}})})};b.prototype._setIdFilter=function(a){this._idsToShow=a&&a.objectIds&&f.SetFromValues(a.objectIds);this._idsToHide=a&&a.hiddenIds&&f.SetFromValues(a.hiddenIds);this.objectIds=a&&a.objectIds};b.prototype._setGeometryFilter=
function(a){return e.__awaiter(this,void 0,void 0,function(){var b,g,d;return e.__generator(this,function(c){switch(c.label){case 0:if(!a||!a.geometry)return this.spatialRel=this.geometry=this._spatialQueryOperator=null,[2];b=a.geometry;g=a.spatialRel||"esriSpatialRelIntersects";return[4,t.getSpatialQueryOperator(g,b,this._serviceInfo.geometryType,this._serviceInfo.hasZ,this._serviceInfo.hasM)];case 1:return d=c.sent(),r.getBoundsXY(this._geometryBounds,b),this._spatialQueryOperator=d,this.geometry=
b,this.spatialRel=g,[2]}})})};b.prototype._setTimeFilter=function(a){this.timeExtent=this._timeOperator=null;a&&a.timeExtent&&(this._serviceInfo.timeInfo?(this.timeExtent=a.timeExtent,this._timeOperator=u.getTimeOperator(this._serviceInfo.timeInfo,a.timeExtent,x.featureAdapter)):(a=new l("feature-layer-view:time-filter-not-available","Unable to apply time filter, as layer doesn't have time metadata.",a.timeExtent),z.error(a)))};b.prototype._applyFilter=function(a){return this._filterByGeometry(a)&&
this._filterById(a)&&this._filterByTime(a)&&this._filterByExpression(a)};b.prototype._filterByExpression=function(a){return this.where?this._clause(a):!0};b.prototype._filterById=function(a){return(!this._idsToHide||!this._idsToHide.size||!this._idsToHide.has(a.getObjectId()))&&(!this._idsToShow||!this._idsToShow.size||this._idsToShow.has(a.getObjectId()))};b.prototype._filterByGeometry=function(a){return this.geometry?(a=a.readHydratedGeometry())?this._spatialQueryOperator(a):!1:!0};b.prototype._filterByTime=
function(a){return n.isSome(this._timeOperator)?this._timeOperator(a):!0};b.prototype._resetAllHiddenIds=function(){var a=this,b=[];this._idToVisibility.forEach(function(c,d){c&1||(a._idToVisibility.set(d,1),b.push(d))});return b};return b}();k.default=h});