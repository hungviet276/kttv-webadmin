// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.17/esri/copyright.txt for details.
//>>built
define("require exports tslib ../../kernel ../../request ../../core/arrayUtils ../../core/maybe ../../core/promiseUtils ../FeatureLayer ../../portal/Portal ../../portal/PortalItem".split(" "),function(l,h,b,v,r,w,g,p,m,x,y){Object.defineProperty(h,"__esModule",{value:!0});h.FetchAssociatedFeatureLayer=void 0;l=function(){function f(d,a,e){this.parsedUrl=d;this.portalItem=a;this.signal=e;this.rootDocument=null;if(d=this.parsedUrl.path.match(/^(.*)\/SceneServer\/layers\/([\d]*)\/?$/i))this.urlParts=
{root:d[1],layerId:parseInt(d[2],10)}}f.prototype.fetch=function(){var d;return b.__awaiter(this,void 0,void 0,function(){var a,e,c;return b.__generator(this,function(b){switch(b.label){case 0:if(!this.urlParts)return[2,null];if(null===(d=this.portalItem)||void 0===d)return[3,1];e=d;return[3,3];case 1:return[4,this.portalItemFromServiceItemId()];case 2:e=b.sent(),b.label=3;case 3:return a=e,g.isNone(a)?[2,this.loadFromUrl()]:[4,this.findAndLoadRelatedPortalItem(a)];case 4:return c=b.sent(),g.isNone(c)?
[2,null]:[2,this.loadFeatureLayerFromPortalItem(c)]}})})};f.prototype.fetchPortalItem=function(){var d;return b.__awaiter(this,void 0,void 0,function(){var a,e;return b.__generator(this,function(c){switch(c.label){case 0:if(!this.urlParts)return[2,null];if(null===(d=this.portalItem)||void 0===d)return[3,1];e=d;return[3,3];case 1:return[4,this.portalItemFromServiceItemId()];case 2:e=c.sent(),c.label=3;case 3:return a=e,g.isNone(a)?[2,null]:[2,this.findAndLoadRelatedPortalItem(a)]}})})};f.prototype.fetchRootDocument=
function(){return b.__awaiter(this,void 0,void 0,function(){var d,a,e;return b.__generator(this,function(c){switch(c.label){case 0:if(g.isSome(this.rootDocument))return[2,this.rootDocument];if(g.isNone(this.urlParts))return this.rootDocument={},[2,{}];d={query:{f:"json"},responseType:"json",authMode:"no-prompt",signal:this.signal};a=this.urlParts.root+"/SceneServer";c.label=1;case 1:return c.trys.push([1,3,,4]),[4,r(a,d)];case 2:return e=c.sent(),this.rootDocument=e.data,[3,4];case 3:return c.sent(),
this.rootDocument={},[3,4];case 4:return[2,this.rootDocument]}})})};f.prototype.fetchServiceOwningPortalUrl=function(){var d;return b.__awaiter(this,void 0,void 0,function(){var a,e,c,u,f;return b.__generator(this,function(b){switch(b.label){case 0:a=null===(d=v.id)||void 0===d?void 0:d.findServerInfo(this.parsedUrl.path);if(null===a||void 0===a?0:a.owningSystemUrl)return[2,a.owningSystemUrl];e=this.parsedUrl.path.replace(/(.*\/rest)\/.*/i,"$1")+"/info";b.label=1;case 1:return b.trys.push([1,3,,4]),
[4,r(e,{query:{f:"json"},responseType:"json",signal:this.signal})];case 2:return c=b.sent(),(u=c.data.owningSystemUrl)?[2,u]:[3,4];case 3:return f=b.sent(),p.throwIfAbortError(f),[3,4];case 4:return[2,null]}})})};f.prototype.findAndLoadRelatedPortalItem=function(d){return b.__awaiter(this,void 0,void 0,function(){var a,e;return b.__generator(this,function(c){switch(c.label){case 0:return c.trys.push([0,2,,3]),[4,d.fetchRelatedItems({relationshipType:"Service2Service",direction:"reverse"},{signal:this.signal})];
case 1:return a=c.sent(),[2,w.find(a,function(a){return"Feature Service"===a.type})||null];case 2:return e=c.sent(),p.throwIfAbortError(e),[2,null];case 3:return[2]}})})};f.prototype.loadFeatureLayerFromPortalItem=function(d){return b.__awaiter(this,void 0,void 0,function(){var a,e;return b.__generator(this,function(c){switch(c.label){case 0:return[4,d.load({signal:this.signal})];case 1:return c.sent(),[4,this.findMatchingAssociatedSublayerUrl(d.url)];case 2:return a=c.sent(),e=new m({url:a,portalItem:d}),
[2,e.load({signal:this.signal})]}})})};f.prototype.loadFromUrl=function(){return b.__awaiter(this,void 0,void 0,function(){var d,a;return b.__generator(this,function(e){switch(e.label){case 0:return[4,this.findMatchingAssociatedSublayerUrl(this.urlParts.root+"/FeatureServer")];case 1:return d=e.sent(),a=new m({url:d}),[2,a.load({signal:this.signal})]}})})};f.prototype.findMatchingAssociatedSublayerUrl=function(d){return b.__awaiter(this,void 0,void 0,function(){var a,e,c,f,g,h,t,l,q,k,n,m;return b.__generator(this,
function(b){switch(b.label){case 0:return a=d.replace(/^(.*FeatureServer)(\/[\d]*\/?)?$/i,"$1"),e={query:{f:"json"},responseType:"json",authMode:"no-prompt",signal:this.signal},c=this.urlParts.layerId,f=this.fetchRootDocument(),g=r(a,e),[4,p.all([g,f])];case 1:h=b.sent();t=h[0];q=(l=h[1])&&l.layers;k=t.data&&t.data.layers;if(!Array.isArray(k))throw Error("expected layers array");if(Array.isArray(q))for(n=0;n<Math.min(q.length,k.length);n++){if(m=q[n],m.id===c)return[2,a+"/"+k[n].id]}else if(c<k.length)return[2,
a+"/"+k[c].id];throw Error("could not find matching associated sublayer");}})})};f.prototype.portalItemFromServiceItemId=function(){return b.__awaiter(this,void 0,void 0,function(){var d,a,e,c;return b.__generator(this,function(b){switch(b.label){case 0:return[4,this.fetchRootDocument()];case 1:d=b.sent();a=d.serviceItemId;if(!a)return[2,null];e=new y({id:a});return[4,this.fetchServiceOwningPortalUrl()];case 2:c=b.sent();g.isSome(c)&&(e.portal=new x({url:c}));try{return[2,e.load({signal:this.signal})]}catch(z){return p.throwIfAbortError(z),
[2,null]}}})})};return f}();h.FetchAssociatedFeatureLayer=l});