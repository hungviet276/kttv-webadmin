// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.17/esri/copyright.txt for details.
//>>built
define("require exports tslib ../../../geometry ../../../request ../../../core/arrayUtils ../../../core/Error ../../../core/JSONSupport ../../../core/Logger ../../../core/maybe ../../../core/Promise ../../../core/promiseUtils ../../../core/accessorSupport/decorators ../arcgisLayerUrl ../commonProperties ../RasterStorageInfo ../TileInfo ./RawBlockCache ../rasterFormats/RasterCodec ../rasterFunctions/pixelUtils ../rasterFunctions/rasterProjectionHelper".split(" "),function(da,ea,f,M,U,V,N,W,X,I,Y,C,
w,Z,aa,ba,R,n,ca,S,x){return function(L){function c(){var a=null!==L&&L.apply(this,arguments)||this;a.rasterJobHandler=null;a.datasetName=null;a.datasetFormat=null;a.rasterInfo=null;a.ioConfig={sampling:"closest"};return a}f.__extends(c,L);c.prototype.init=function(){return f.__awaiter(this,void 0,void 0,function(){var a;return f.__generator(this,function(e){switch(e.label){case 0:return a=x.load(),this.addResolvingPromise(a),[4,this.when()];case 1:return e.sent(),[2]}})})};c.prototype.normalizeCtorArgs=
function(a){a&&a.ioConfig&&(a=f.__assign(f.__assign({},a),{ioConfig:f.__assign({resolution:null,bandIds:null,sampling:"closest",tileInfo:R.create()},a.ioConfig)}));return a};Object.defineProperty(c.prototype,"url",{set:function(a){this._set("url",Z.sanitizeUrl(a,X.getLogger(this.declaredClass)))},enumerable:!1,configurable:!0});c.prototype.open=function(a){return f.__awaiter(this,void 0,void 0,function(){return f.__generator(this,function(a){throw new N("BaseRaster:open-not-implemented","open() is not implemented");
})})};c.prototype.fetchTile=function(a,e,h,b){var p;void 0===b&&(b={});return f.__awaiter(this,void 0,void 0,function(){var d,g,k,m;return f.__generator(this,function(l){d=b.tileInfo;g=d.lodAt(a);k=new M.Point({x:g.resolution,y:g.resolution,spatialReference:d.spatialReference});m=this.getTileExtent(k,e,h,d);(null===(p=b.multidimensionalDefinition)||void 0===p?0:p.length)&&I.isSome(this.rasterInfo.multidimensionalInfo)&&null==b.sliceId&&(b=f.__assign(f.__assign({},b),{sliceId:this.getSliceIndex(b.multidimensionalDefinition)||
0}));return[2,this.fetchPixels(m,d.size[0],d.size[1],b)]})})};c.prototype.identify=function(a,e){void 0===e&&(e={});return f.__awaiter(this,void 0,void 0,function(){var h,b,p,d,g,k,m,l,c,y,z,D,r,q,u,t,A,v;return f.__generator(this,function(f){switch(f.label){case 0:h=this.rasterInfo;b=h.spatialReference;p=h.extent;d=e.datumTransformation;g=x.projectPoint(a,b,d);if(!p.intersects(g))return[2,{location:g,value:null}];k=0;if(!e.srcResolution)return[3,1];m=x.snapPyramid(e.srcResolution,this.rasterInfo,
this.ioConfig.sampling);k=m.pyramidLevel;return[3,3];case 1:return[4,this.computeBestPyramidLevelForLocation(a,e)];case 2:k=f.sent();if(null==k)return[2,{location:g,value:null}];f.label=3;case 3:l=this.identifyPixelLocation(g,k,null);if(null===l)return[2,{location:g,value:null}];c=l.row;y=l.col;z=l.rowOffset;D=l.colOffset;r=n.getRasterId(this.url,e.sliceId);q=k+"/"+c+"/"+y;u=n.getBlock(r,null,q);I.isSome(u)||(u=this.fetchRawTile(k,c,y,e),n.putBlock(r,null,q,u));return[4,u];case 4:t=f.sent();if(!(t&&
t.pixels&&0<t.pixels.length))return[2,{location:g,value:null}];A=z*this.rasterInfo.storageInfo.blockHeight+D;v=!t.mask||t.mask[A]?t.pixels.map(function(a){return a[A]}):null;return[2,{location:g,value:v,pyramidLevel:k}]}})})};c.prototype.fetchPixels=function(a,e,h,b){void 0===b&&(b={});return f.__awaiter(this,void 0,void 0,function(){var p,d,g,k,m,l,c,y,z,D,r,q,u,t,A,v,T,n,w,E,J,B,H,K,F,G,C;return f.__generator(this,function(f){switch(f.label){case 0:p=a.clone().normalize();a=p[0];d=this.rasterInfo.spatialReference;
g=!a.spatialReference.equals(d);k=b.datumTransformation;m=new M.Point({x:(a.xmax-a.xmin)/e,y:(a.ymax-a.ymin)/h,spatialReference:a.spatialReference});l=b.srcResolution||(g?x.projectResolution(m,d,a,k):m);if(!l)return[2,null];c=x.snapPyramid(l,this.rasterInfo,this.ioConfig.sampling);y=c.pyramidLevel;z=c.pyramidResolution;if(D=c.excessiveReading)return[2,null];r=this.rasterInfo.storageInfo;q=g?x.projectExtent(a,d,k):a;if(null==q)return[2,null];u={x:Math.floor((q.xmin-r.origin.x)/z.x+.1),y:Math.floor((r.origin.y-
q.ymax)/z.y+.1)};t=Math.ceil((q.xmax-q.xmin)/z.x-.1);A=Math.ceil((q.ymax-q.ymin)/z.y-.1);return 8<t/e||8<A/h?[2,null]:[4,this.fetchRawPixels(y,u,{width:t,height:A},b)];case 1:v=f.sent();if(!v)return[2,null];T=0<y?r.pyramidBlockWidth:r.blockWidth;n=0<y?r.pyramidBlockHeight:r.blockHeight;if(w=!g&&1===v.pixelBlocks.length&&T===e&&n===h&&l.x===m.x&&l.y===m.y)return[2,{extent:a,srcExtent:q,pixelBlock:v.pixelBlocks[0],transformGrid:null}];E=x.getProjectionOffsetGrid(a,v.extent,m,k);B=!b.requestRawData;
H={rows:E.spacing[0],cols:E.spacing[1]};K=v.pixelBlocks;F=v.mosaicSize;G=v.isPartiallyFilled;return this.rasterJobHandler?[4,this.rasterJobHandler.mosaicAndTransform({srcPixelBlocks:K,srcMosaicSize:F,destDimension:B?{width:e,height:h}:null,coefs:B?E.coefficients:null,sampleSpacing:B?H:null,interpolation:b.interpolation},b)]:[3,3];case 2:return J=f.sent(),[3,4];case 3:C=S.mosaic(K,F),J=B?S.approximateTransform(C,{width:e,height:h},E.coefficients,H,b.interpolation):C,f.label=4;case 4:return[2,{srcExtent:q,
pixelBlock:J,transformGrid:E,extent:a,isPartiallyFilled:G}]}})})};c.prototype.fetchRawPixels=function(a,e,h,b){return f.__awaiter(this,void 0,void 0,function(){var p,d,g,k,c,l,O,y,z,D,r,q,u,t,A,v,n,w,x,E,J,B,H,K,F,G,I,L,P,Q,N;return f.__generator(this,function(f){switch(f.label){case 0:p=this.rasterInfo.storageInfo;d=p.origin;g=p.blockBoundary;k=0<a?this.rasterInfo.storageInfo.pyramidBlockWidth:this.rasterInfo.storageInfo.blockWidth;c=0<a?this.rasterInfo.storageInfo.pyramidBlockHeight:this.rasterInfo.storageInfo.blockHeight;
l=e.x;O=e.y;y=h.width;z=h.height;b.buffer&&(l-=b.buffer.cols,O-=b.buffer.rows,y+=2*b.buffer.cols,z+=2*b.buffer.rows);D=Math.floor(l/k);r=Math.floor(O/c);q=Math.floor((l+y-1)/k);u=Math.floor((O+z-1)/c);t=this.rasterInfo;A=t.pixelSize;v=t.spatialReference;n=g[a];if(!n)return[2,null];w=n.minRow;x=n.minCol;E=n.maxCol;J=n.maxRow;if(u<w||q<x||r>J||D>E)return[2,null];B=[];K=!1;for(F=r;F<=u;F++)for(G=D;G<=q;G++)F>=w&&G>=x&&J>=F&&E>=G?(H=this._fetchRawTile(a,F,G,b),this.ioConfig.allowPartialFill&&(H=C.create(function(a){H.then(function(b){return a(b)}).catch(function(){K=
!0;a(null)})})),B.push(H)):B.push(null);return 0===B.length?[2,null]:[4,C.all(B)];case 1:return I=f.sent(),L={height:(u-r+1)*k,width:(q-D+1)*c},P=A.x*Math.pow(2,a),Q=A.y*Math.pow(2,a),N=new M.Extent({xmin:d.x+D*k*P,xmax:d.x+(q+1)*k*P,ymin:d.y-(u+1)*c*Q,ymax:d.y-r*c*Q,spatialReference:v}),[2,{extent:N,pixelBlocks:I,mosaicSize:L,isPartiallyFilled:K}]}})})};c.prototype.fetchRawTile=function(a,e,h,b){return f.__awaiter(this,void 0,void 0,function(){return f.__generator(this,function(a){throw new N("BaseRaster:read-not-implemented",
"fetchRawTile() is not implemented");})})};c.prototype.computeExtent=function(a){return x.projectExtent(this.rasterInfo.extent,a)};c.prototype.decodePixelBlock=function(a,e){return this.rasterJobHandler?this.rasterJobHandler.decode({data:a,options:e}):ca.decode(a,e)};c.prototype.request=function(a,e,h){var b;return f.__awaiter(this,void 0,void 0,function(){var p,d,g,c,m,l,n;return f.__generator(this,function(k){switch(k.label){case 0:p=this.ioConfig.customFetchParameters,d=e.range,g=e.query,c=e.headers,
h=null!==(b=null!==h&&void 0!==h?h:e.retryCount)&&void 0!==b?b:this.ioConfig.retryCount,m=d?{Range:"bytes\x3d"+d.from+"-"+d.to}:null,k.label=1;case 1:return k.trys.push([1,3,,4]),[4,U(a,f.__assign(f.__assign({},e),{query:f.__assign(f.__assign({},g),p),headers:f.__assign(f.__assign({},c),m)}))];case 2:return l=k.sent(),[2,l];case 3:n=k.sent();if(0<h)return h--,[2,this.request(a,e,h)];throw n;case 4:return[2]}})})};c.prototype.getSliceIndex=function(a){var e=this,h=this.rasterInfo.multidimensionalInfo;
if(!I.isSome(h)||null===a||void 0===a||!a.length)return null;for(var b=0,p=a[0].variableName,d=function(d){d=h.variables[d];var f=d.dimensions;if(d.name!==p)return b+=f.map(function(a){return e._getDimensionValuesCount(a)}).reduce(function(a,b){return a+b}),"break";var c=f.map(function(a){return e._getDimensionValuesCount(a)}),k=f.length;d=function(e){var d=a.filter(function(a){return a.dimensionName===f[e].name})[0];if(null==d)return{value:null};d=Array.isArray(d.values[0])?d.values[0][0]:d.values[0];
d=g._getIndexFromDimensions(d,f[e]);if(-1===d)return{value:null};c.shift();b=e===k-1?b+d:b+d*c.reduce(function(a,b){return a+b})};for(var l=0;l<k;l++){var m=d(l);if("object"===typeof m)return m}},g=this,f=0;f<h.variables.length;f++){var c=d(f);if("object"===typeof c)return c.value;if("break"===c)break}return b};c.prototype.updateTileInfo=function(){var a=this.rasterInfo,e=a.storageInfo,h=a.spatialReference,b=a.pixelSize;if(!e.tileInfo){for(var a=[],f=e.maximumPyramidLevel||0,b=Math.max(b.x,b.y),d=
1/.0254*96*b,g=0;g<=f;g++)a.push({level:f-g,resolution:b,scale:d}),b*=2,d*=2;e.tileInfo=new R({origin:e.origin,size:[e.blockWidth,e.blockHeight],spatialReference:h,lods:a});e.isVirtualTileInfo=!0}};c.prototype.createRemoteDatasetStorageInfo=function(a,e,h){void 0===e&&(e=512);void 0===h&&(h=512);var b=a.width,f=a.height,d=a.extent,g=a.pixelSize,c=new M.Point({x:d.xmin,y:d.ymax,spatialReference:a.spatialReference}),b=Math.max(0,Math.round(Math.log(Math.max(b,f))/Math.LN2-8)),d=this._computeBlockBoundary(d,
g,b,512,512);a.storageInfo=new ba({blockWidth:e,blockHeight:h,pyramidBlockWidth:e,pyramidBlockHeight:h,origin:c,firstPyramidLevel:1,maximumPyramidLevel:b,blockBoundary:d})};c.prototype.computeBestPyramidLevelForLocation=function(a,e){void 0===e&&(e={});return f.__awaiter(this,void 0,void 0,function(){return f.__generator(this,function(a){return[2,0]})})};c.prototype.identifyPixelLocation=function(a,e,f){var b=this.rasterInfo,h=b.pixelSize,d=b.extent,g=this.rasterInfo.storageInfo,c=g.blockWidth,m=
g.blockHeight,l=g.maximumPyramidLevel,n=g.pyramidScalingFactor,g=g.origin;a=x.projectPoint(a,b.spatialReference,f);if(!d.intersects(a)||0>e||e>l)return null;l=Math.pow(n,e);d=(g.y-a.y)/(l*h.y)/m;h=(a.x-g.x)/(l*h.x)/c;return{pyramidLevel:e,row:Math.floor(d),col:Math.floor(h),rowOffset:Math.min(m-1,Math.floor((d-Math.floor(d))*m)),colOffset:Math.min(c-1,Math.floor((h-Math.floor(h))*c)),srcLocation:a}};c.prototype.getTileExtent=function(a,e,h,b){var f=b.origin,d=b.size[0],g=b.size[1];h=f.x+h*d*a.x;e=
f.y-e*g*a.y;return new M.Extent({xmin:h,xmax:h+d*a.x,ymin:e-g*a.y,ymax:e,spatialReference:b.spatialReference})};c.prototype._computeBlockBoundary=function(a,e,f,b,c){var d=e.x;e=e.y;var h=a.xmin,k=a.ymax,p=[{minCol:Math.floor((a.xmin-h+.1*d)/b/d),maxCol:Math.floor((a.xmax-h-.1*d)/b/d),minRow:Math.floor((k-a.ymax+.1*e)/c/e),maxRow:Math.floor((k-a.ymin-.1*e)/c/e)}];if(0<f)for(var l=0;l<f;l++)d*=2,e*=2,p.push({minCol:Math.floor((a.xmin-h+.1*d)/b/d),maxCol:Math.floor((a.xmax-h-.1*d)/b/d),minRow:Math.floor((k-
a.ymax+.1*e)/c/d),maxRow:Math.floor((k-a.ymin-.1*e)/c/d)});return p};c.prototype._fetchRawTile=function(a,e,h,b){var c=this.rasterInfo.storageInfo.blockBoundary[a];if(!c)return C.resolve(null);var d=c.minCol,g=c.maxCol,k=c.maxRow;if(e<c.minRow||h<d||e>k||h>g)return C.resolve(null);var m=n.getRasterId(this.url,b.sliceId),l=a+"/"+e+"/"+h,c=n.getBlock(m,b.registryId,l);I.isSome(c)||(d=C.createAbortController(),c=this.fetchRawTile(a,e,h,f.__assign(f.__assign({},b),{signal:d.signal})),n.putBlock(m,b.registryId,
l,c,d),c.catch(function(){n.deleteBlock(m,b.registryId,l)}));if(b.signal)C.onAbort(b,function(){n.decreaseRefCount(m,b.registryId,l)});return c};c.prototype._getIndexFromDimensions=function(a,e){var c,b=e.extent,f=e.interval,d=e.unit,g=e.values;if(null===g||void 0===g?0:g.length)return Array.isArray(g[0])?V.findIndex(g,function(b){return b[0]<=a&&b[1]>=a}):g.indexOf(a);if(a>b[1])return-1;b=b[0];g=-1;if("ISO8601"===d){switch((null===(c=e.intervalUnit)||void 0===c?void 0:c.toLowerCase())||"seconds"){case "seconds":g=
Math.round((a-b)/1E3/f);break;case "minutes":g=Math.round((a-b)/6E4/f);break;case "hours":g=Math.round((a-b)/36E5/f);break;case "days":g=Math.round((a-b)/864E5/f);break;case "years":g=Math.round(((new Date(a)).getUTCFullYear()-(new Date(b)).getUTCFullYear())/f);break;case "decades":g=Math.round(((new Date(a)).getUTCFullYear()-(new Date(b)).getUTCFullYear())/10/f)}return g}return Math.round((a-b)/f)};c.prototype._getDimensionValuesCount=function(a){var e,c=a.extent,b=a.interval,f=a.unit,d=a.values;
if(d=(null===d||void 0===d?void 0:d.length)||0)return d;var g=c[0];if(0===d&&"ISO8601"===f){switch((null===(e=a.intervalUnit)||void 0===e?void 0:e.toLowerCase())||"seconds"){case "seconds":d=Math.round((c[1]-c[0])/1E3/b);break;case "minutes":d=Math.round((c[1]-c[0])/6E4/b);break;case "hours":d=Math.round((c[1]-c[0])/36E5/b);break;case "days":d=Math.round((c[1]-c[0])/864E5/b);break;case "years":d=Math.round(((new Date(c[1])).getUTCFullYear()-(new Date(g)).getUTCFullYear())/b);break;case "decades":d=
Math.round(((new Date(c[1])).getUTCFullYear()-(new Date(g)).getUTCFullYear())/10/b)}return d}return Math.round((c[1]-c[0])/b)};f.__decorate([w.property(aa.url)],c.prototype,"url",null);f.__decorate([w.property({type:String,json:{write:!0}})],c.prototype,"datasetName",void 0);f.__decorate([w.property({type:String,json:{write:!0}})],c.prototype,"datasetFormat",void 0);f.__decorate([w.property()],c.prototype,"rasterInfo",void 0);f.__decorate([w.property()],c.prototype,"ioConfig",void 0);f.__decorate([w.property()],
c.prototype,"sourceJSON",void 0);return c=f.__decorate([w.subclass("esri.layers.support.rasterDatasets.BaseRaster")],c)}(Y.EsriPromiseMixin(W.JSONSupport))});