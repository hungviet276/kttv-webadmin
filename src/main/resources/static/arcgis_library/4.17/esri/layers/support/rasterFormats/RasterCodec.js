// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.17/esri/copyright.txt for details.
//>>built
define("require exports tslib ../../../core/Error ../../../core/SetUtils ../PixelBlock ./ImageCanvasDecoder ./JpgPlus ./Lerc2Codec ./LercCodec ./Png ./Raw ./TiffDecoder".split(" "),function(W,x,z,u,H,v,I,J,K,L,M,N,E){function O(a,b){if(!B)throw new u("rasterCoded:decode","lerc decoder is not supported on big endian platform");var d=b.width,c=b.height,h=b.pixelType,f=F(h),e=f.pixelTypeCtor;b=null==b.noDataValue?f.noDataValue:b.noDataValue;for(var f=0,k,l=0,p,q=a.byteLength-10;l<q;){var m=L.decode(a,
{inputOffset:l,encodedMaskData:k,returnMask:0===f?!0:!1,returnEncodedMask:0===f?!0:!1,returnFileInfo:!0,pixelType:e,noDataValue:b});if(d&&c&&(m.width!==d||m.height!==c))throw new u("rasterCoded:decode","lerc decoded result has width or height different from specified in options");l=m.fileInfo.eofOffset;0===f&&(k=m.encodedMaskData,p=new v({width:m.width,height:m.height,pixels:[],pixelType:h,mask:m.maskData,statistics:[]}));f++;p.addData({pixels:m.pixelData,statistics:{minValue:m.minValue,maxValue:m.maxValue,
noDataValue:m.noDataValue}});10<q-l&&(m=String.fromCharCode.apply(null,new Uint8Array(a,l,10)),l=-1<l+m.indexOf("CntZ")?m.indexOf("CntZ"):0)}return p}function P(a,b){if(!B)throw new u("rasterCoded:decode","lerc decoder is not supported on big endian platform");var d=0,c=0,h=0,f,e,k,l=a.byteLength-10,p=[],q=b.width;for(b=b.height;c<l;){e=K.decode(a,{inputOffset:c,maskData:f,returnFileInfo:!0});if(q&&b&&(e.width!==q||e.height!==b))throw new u("rasterCoded:decode","lerc2 decoded result has width or height different from what's specified in options");
c=e.fileInfo.eofOffset;0===d&&(h=e.fileInfo.numValidPixel,f=e.maskData,k=new v({width:e.width,height:e.height,pixels:[],pixelType:e.fileInfo.pixelType,mask:e.maskData,statistics:[]}));e.fileInfo.mask&&0<e.fileInfo.mask.numBytes&&p.push(e.maskData);d++;k.addData({pixels:e.pixelData,statistics:{minValue:e.minValue,maxValue:e.maxValue}});10<l-c&&(e=String.fromCharCode.apply(null,new Uint8Array(a,c,10)),c+=-1<e.indexOf("Lerc")?e.indexOf("Lerc"):0)}c=d=a=0;if(1<p.length){c=k.width*k.height;f=new Uint8Array(c);
f.set(p[0]);for(a=1;a<p.length;a++)for(h=p[a],d=0;d<c;d++)f[d]&=h[d];for(d=h=0;d<c;d++)h+=f[d];k.mask=f}k.validPixelCount=h;return k}function Q(a){a=E.decode(a);a=new v({width:a.width,height:a.height,pixels:a.pixels,pixelType:a.pixelType.toLowerCase(),mask:a.mask,statistics:null});a.updateStatistics();return a}function R(a){a=J.decode(a);a=new v({width:a.width,height:a.height,pixels:a.pixels,pixelType:"U8",mask:a.mask,statistics:null});a.updateStatistics();return a}function S(a,b){a=new Uint8Array(a);
var d=new M(a);a=b.width;var c=b.height;b=a*c;for(var d=d.decode(),h=0,f=0,f=new Uint8Array(b),h=0;h<b;h++)f[h]=d[4*h+3];c=new v({width:a,height:c,pixels:[],pixelType:"U8",mask:f,statistics:[]});for(h=0;3>h;h++){a=new Uint8Array(b);for(f=0;f<b;f++)a[f]=d[4*f+h];c.addData({pixels:a})}c.updateStatistics();return c}function T(a,b,d,c){return z.__awaiter(this,void 0,void 0,function(){var h,f,e,k;return z.__generator(this,function(l){switch(l.label){case 0:return h=new I,f=z.__assign({applyJpegMask:!1,
format:b},d),[4,h.decode(a,f,c)];case 1:return e=l.sent(),k=new v(e),k.updateStatistics(),[2,k]}})})}function G(a){if(null==a)throw new u("rasterCodec:decode","parameter encodeddata is required.");a=new Uint8Array(a,0,10);var b="";255===a[0]&&216===a[1]?b="jpg":137===a[0]&&80===a[1]&&78===a[2]&&71===a[3]?b="png":67===a[0]&&110===a[1]&&116===a[2]&&90===a[3]&&73===a[4]&&109===a[5]&&97===a[6]&&103===a[7]&&101===a[8]&&32===a[9]?b="lerc":76===a[0]&&101===a[1]&&114===a[2]&&99===a[3]&&50===a[4]&&32===a[5]?
b="lerc2":73===a[0]&&73===a[1]&&42===a[2]&&0===a[3]||77===a[0]&&77===a[1]&&0===a[2]&&42===a[3]?b="tiff":71===a[0]&&73===a[1]&&70===a[2]?b="gif":66===a[0]&&77===a[1]?b="bmp":-1<String.fromCharCode.apply(null,a).toLowerCase().indexOf("error")&&(b="error");return b}function U(a){var b=null;switch(a){case "lerc":b=O;break;case "lerc2":b=P;break;case "jpg":b=R;break;case "png":b=S;break;case "bsq":case "bip":b=function(b,c){var d=F(c.pixelType).pixelTypeCtor,f=N.decode;b=f(b,{width:c.width,height:c.height,
pixelType:d,format:a});c=new v({width:c.width,height:c.height,pixels:b.pixels,pixelType:c.pixelType,mask:b.mask,statistics:null});c.updateStatistics();return c};break;case "tiff":b=Q;break;case "error":b=function(){throw new u("rasterCodec:decode","input data contains error");};break;default:b=function(){throw new u("rasterCodec:decode","unsupported raster format");}}return b}function F(a){var b=null,d=null;switch(a?a.toLowerCase():"f32"){case "u1":case "u2":case "u4":case "u8":d=Math.pow(2,8)-1;
b=Uint8Array;break;case "u16":d=d||Math.pow(2,16)-1;b=Uint16Array;break;case "u32":d=d||Math.pow(2,32)-1;b=Uint32Array;break;case "s8":d=d||0-Math.pow(2,7);b=Int8Array;break;case "s16":d=d||0-Math.pow(2,15);b=Int16Array;break;case "s32":d=d||0-Math.pow(2,31);b=Int32Array;break;default:b=Float32Array}return{pixelTypeCtor:b,noDataValue:d}}Object.defineProperty(x,"__esModule",{value:!0});x.decode=x.getFormat=void 0;var V=H.SetFromValues(["jpg","png","bmp","gif"]),B=function(){var a=new ArrayBuffer(4),
b=new Uint8Array(a);(new Uint32Array(a))[0]=1;return 1===b[0]}();x.getFormat=function(a){a=G(a);"lerc2"===a?a="lerc":"error"===a&&(a="");return a};x.decode=function(a,b,d){return z.__awaiter(this,void 0,void 0,function(){var c,h,f;return z.__generator(this,function(e){switch(e.label){case 0:if(null==a)throw new u("rasterCodec:decode","missing encodeddata parameter.");if(null==b||null==b.width||null==b.height)throw new u("rasterCodec:decode","requires width and height in options parameter.");c=b.format&&
b.format.toLowerCase();if("tiff"===c&&b.customOptions)return e=E.decodeTileOrStrip(a,b.customOptions),e=new v({width:e.width,height:e.height,pixels:e.pixels,pixelType:e.pixelType.toLowerCase(),mask:e.mask,statistics:null}),e.updateStatistics(),[2,e];if(!c||"bsq"!==c&&"bip"!==c)c=G(a);return b.useCanvas&&V.has(c)?[4,T(a,c,b,d)]:[3,2];case 1:return f=e.sent(),[3,3];case 2:h=U(c);b.isPoint&&(b=z.__assign({},b),b.width++,b.height++);f=h(a,b);if(b.isPoint){var k=f,l=void 0;void 0===l&&(l=1);if(k){var p=
k.pixels,q=k.width,m=k.mask;if(p&&0!==p.length){var x=p.length,t=q-1,w=k.height-1,D=[],n,g,r,y,A,C,B=v.getPixelArrayConstructor(k.pixelType);if(0===l){for(l=0;l<x;l++){y=p[l];A=new B(t*w);for(n=0;n<w;n++)for(r=n*q,g=0;g<t;g++)A[n*t+g]=y[r+g];D.push(A)}if(m)for(C=new Uint8Array(t*w),n=0;n<w;n++)for(r=n*q,g=0;g<t;g++)C[n*t+g]=m[r+g]}else{for(l=0;l<x;l++){y=p[l];A=new B(t*w);for(n=0;n<w;n++)for(r=n*q,g=0;g<t;g++)A[n*t+g]=(y[r+g]+y[r+g+1]+y[r+q+g]+y[r+q+g+1])/4;D.push(A)}if(m)for(C=new Uint8Array(t*w),
n=0;n<w;n++)for(r=n*q,g=0;g<t;g++)C[n*t+g]=Math.min.apply(null,[m[r+g],m[r+g+1],m[r+q+g],m[r+q+g+1]])}k.width=t;k.height=w;k.mask=C;k.pixels=D}}}e.label=3;case 3:return[2,f]}})})}});