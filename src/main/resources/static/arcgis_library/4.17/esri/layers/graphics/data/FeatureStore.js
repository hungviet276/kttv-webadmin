// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.17/esri/copyright.txt for details.
//>>built
define("require exports ../../../core/Error ../../../core/Evented ../../../core/Logger ../../../core/maybe ../../../geometry/support/aaBoundingBox ../../../geometry/support/aaBoundingRect ../featureConversionUtils ./BoundsStore ./optimizedFeatureQueryEngineAdapter".split(" "),function(f,g,l,m,n,h,p,e,q,r,t){Object.defineProperty(g,"__esModule",{value:!0});f=function(){function b(a){this.geometryInfo=a;this._boundsStore=new r.BoundsStore;this._featuresById=new Map;this._markedIds=new Set;this.events=
new m;this.featureAdapter=t.optimizedFeatureQueryEngineAdapter}Object.defineProperty(b.prototype,"geometryType",{get:function(){return this.geometryInfo.geometryType},enumerable:!1,configurable:!0});Object.defineProperty(b.prototype,"hasM",{get:function(){return this.geometryInfo.hasM},enumerable:!1,configurable:!0});Object.defineProperty(b.prototype,"hasZ",{get:function(){return this.geometryInfo.hasZ},enumerable:!1,configurable:!0});Object.defineProperty(b.prototype,"numFeatures",{get:function(){return this._featuresById.size},
enumerable:!1,configurable:!0});Object.defineProperty(b.prototype,"fullBounds",{get:function(){var a=this;if(!this.numFeatures)return null;var c=e.create(e.NEGATIVE_INFINITY);this._featuresById.forEach(function(b){if(b=a._boundsStore.get(b.objectId))c[0]=Math.min(b[0],c[0]),c[1]=Math.min(b[1],c[1]),c[2]=Math.max(b[2],c[2]),c[3]=Math.max(b[3],c[3])});return c},enumerable:!1,configurable:!0});Object.defineProperty(b.prototype,"storeStatistics",{get:function(){var a=0;this._featuresById.forEach(function(c){c.geometry&&
c.geometry.coords&&(a+=c.geometry.coords.length)});return{featureCount:this._featuresById.size,vertexCount:a/(this.hasZ?this.hasM?4:3:this.hasM?3:2)}},enumerable:!1,configurable:!0});b.prototype.add=function(a){this._add(a);this._emitChanged()};b.prototype.addMany=function(a){for(var c=0;c<a.length;c++)this._add(a[c]);this._emitChanged()};b.prototype.clear=function(){this._featuresById.clear();this._boundsStore.clear();this._emitChanged()};b.prototype.removeById=function(a){a=this._featuresById.get(a);
if(!a)return null;this._remove(a);this._emitChanged();return a};b.prototype.removeManyById=function(a){this._boundsStore.invalidateIndex();for(var c=0;c<a.length;c++){var b=this._featuresById.get(a[c]);b&&this._remove(b)}this._emitChanged()};b.prototype.forEachBounds=function(a,c,b){for(var d=0;d<a.length;d++){var k=this._boundsStore.get(a[d].objectId);k&&c(p.fromRect(b,k))}};b.prototype.getFeature=function(a){return this._featuresById.get(a)};b.prototype.has=function(a){return this._featuresById.has(a)};
b.prototype.forEach=function(a){this._featuresById.forEach(function(c){return a(c)})};b.prototype.forEachInBounds=function(a,c){var b=this;this._boundsStore.forEachInBounds(a,function(a){c(b._featuresById.get(a))})};b.prototype.startMarkingUsedFeatures=function(){this._boundsStore.invalidateIndex();this._markedIds.clear()};b.prototype.sweep=function(){var a=this,c=!1;this._featuresById.forEach(function(b,d){a._markedIds.has(d)||(c=!0,a._remove(b))});this._markedIds.clear();c&&this._emitChanged()};
b.prototype._emitChanged=function(){this.events.emit("changed",void 0)};b.prototype._add=function(a){if(a){var c=a.objectId;if(null==c)n.getLogger("esri.layers.graphics.data.FeatureStore").error(new l("featurestore:invalid-feature","feature id is missing",{feature:a}));else{var b=this._featuresById.get(c),d;this._markedIds.add(c);if(b)a.displayId=b.displayId,d=this._boundsStore.get(c),this._boundsStore.delete(c);else if(h.isSome(this.onFeatureAdd))this.onFeatureAdd(a);a.geometry&&a.geometry.coords&&
a.geometry.coords.length?(d=q.getBoundsOptimizedGeometry(d||e.create(),a.geometry,this.geometryInfo.hasZ,this.geometryInfo.hasM),this._boundsStore.set(c,d)):this._boundsStore.set(c,null);this._featuresById.set(c,a)}}};b.prototype._remove=function(a){if(h.isSome(this.onFeatureRemove))this.onFeatureRemove(a);this._markedIds.delete(a.objectId);this._boundsStore.delete(a.objectId);this._featuresById.delete(a.objectId);return a};return b}();g.default=f});