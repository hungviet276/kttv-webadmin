// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.17/esri/copyright.txt for details.
//>>built
define("require exports tslib ../../config ../../request ../../core/promiseUtils ../../core/urlUtils ../../views/2d/engine/vectorTiles/style/VectorTileSource".split(" "),function(F,u,n,z,C,w,p,D){function r(a){a&&(a=p.getOrigin(a),x&&-1===x.indexOf(a)&&x.push(a))}function q(){for(var a=[],b=0;b<arguments.length;b++)a[b]=arguments[b];for(var b=void 0,c=0;c<a.length;++c)p.isProtocolRelative(a[c])?b&&(b=b.split("://")[0]+":"+a[c].trim()):b=p.isAbsolute(a[c])?a[c]:p.join(b,a[c]);return p.removeTrailingSlash(b)}
function t(a,b,c,m,e){return n.__awaiter(this,void 0,void 0,function(){var g,d,h,f,k,l;return n.__generator(this,function(q){switch(q.label){case 0:w.throwIfAborted(e);if("string"!==typeof c)return[3,2];f=p.normalize(c);r(f);k=p.urlToObject(f);return[4,C(k.path,n.__assign({query:{f:"json"},responseType:"json"},e))];case 1:return h=q.sent(),d=g=f,[3,3];case 2:h={data:c},g=c.jsonUrl||null,d=m,q.label=3;case 3:return l=h.data,h.ssl&&(g&&(g=g.replace(/^http:/i,"https:")),d&&(d=d.replace(/^http:/i,"https:"))),
l.sources?(a.styleUrl=g||null,[2,E(a,l,d,e)]):l.sources?[2,w.reject("You must specify the URL or the JSON for a service or for a style.")]:a.sourceUrl?[2,B(a,l,d,!1,b,e)]:(a.sourceUrl=g||null,[2,B(a,l,d,!0,b,e)])}})})}function E(a,b,c,m){return n.__awaiter(this,void 0,void 0,function(){var e,g,d,h,f,k;return n.__generator(this,function(l){switch(l.label){case 0:e=c?p.removeFile(c):p.appBaseUrl;a.styleBase=e;a.style=b;a.styleUrl&&r(a.styleUrl);g=[];if(!b.sources||!b.sources.esri)return[3,3];d=b.sources.esri;
return d.url?[4,t(a,"esri",q(e,d.url),void 0,m)]:[3,2];case 1:return l.sent(),[3,3];case 2:g.push(t(a,"esri",d,e,m)),l.label=3;case 3:h=0;for(f=Object.keys(b.sources);h<f.length;h++)k=f[h],"esri"!==k&&"vector"===b.sources[k].type&&(b.sources[k].url?g.push(t(a,k,q(e,b.sources[k].url),void 0,m)):g.push(t(a,k,b.sources[k],e,m)));return[4,w.all(g)];case 4:return l.sent(),[2]}})})}function B(a,b,c,m,e,g){return n.__awaiter(this,void 0,void 0,function(){var d,h,f,k;return n.__generator(this,function(l){d=
c?p.removeTrailingSlash(c)+"/":p.appBaseUrl;l=d;if(b.hasOwnProperty("tileInfo"))h=b;else{for(var n={xmin:-2.0037507067161843E7,ymin:-2.0037507067161843E7,xmax:2.0037507067161843E7,ymax:2.0037507067161843E7,spatialReference:{wkid:102100}},v=78271.51696400007,y=2.958287637957775E8,u=[],x=b.hasOwnProperty("minzoom")?parseFloat(b.minzoom):0,z=b.hasOwnProperty("maxzoom")?parseFloat(b.maxzoom):22,A=0;A<=z;A++)A>=x&&u.push({level:A,scale:y,resolution:v}),v/=2,y/=2;v=0;for(y=b.tiles;v<y.length;v++)r(q(l,
y[v]));h={capabilities:"TilesOnly",initialExtent:n,fullExtent:n,minScale:0,maxScale:0,tiles:b.tiles,tileInfo:{rows:512,cols:512,dpi:96,format:"pbf",origin:{x:-2.0037508342787E7,y:2.0037508342787E7},lods:u,spatialReference:{wkid:102100}}}}f=new D(e,d,h);if(!m&&a.primarySourceName in a.sourceNameToSource){k=a.sourceNameToSource[a.primarySourceName];if(!k.isCompatibleWith(f))return[2,w.resolve()];null!=f.fullExtent&&(null!=k.fullExtent?k.fullExtent.union(f.fullExtent):k.fullExtent=f.fullExtent.clone());
k.tileInfo.lods.length<f.tileInfo.lods.length&&(k.tileInfo=f.tileInfo)}m?(a.sourceBase=d,a.source=b,a.validatedSource=h,a.primarySourceName=e,a.sourceUrl&&r(a.sourceUrl)):r(d);a.sourceNameToSource[e]=f;return a.style?[2]:null==b.defaultStyles?[2,w.reject()]:"string"===typeof b.defaultStyles?[2,t(a,"",q(d,b.defaultStyles,"root.json"),void 0,g)]:[2,t(a,"",b.defaultStyles,q(d,"root.json"),g)]})})}Object.defineProperty(u,"__esModule",{value:!0});u.loadMetadata=void 0;var x=z.defaults&&z.defaults.io.corsEnabledServers;
u.loadMetadata=function(a,b){return n.__awaiter(this,void 0,void 0,function(){var c,m,e,g,d,h;return n.__generator(this,function(f){switch(f.label){case 0:return c={source:null,sourceBase:null,sourceUrl:null,validatedSource:null,style:null,styleBase:null,styleUrl:null,sourceNameToSource:{},primarySourceName:""},m="string"===typeof a?[a,null]:[null,a.jsonUrl],e=m[0],g=m[1],d=e?p.urlToObject(e):null,[4,t(c,"esri",a,g,b)];case 1:return f.sent(),h={layerDefinition:c.validatedSource,url:e,parsedUrl:d,
serviceUrl:c.sourceUrl,style:c.style,styleUrl:c.styleUrl,spriteUrl:c.style.sprite&&q(c.styleBase,c.style.sprite),glyphsUrl:c.style.glyphs&&q(c.styleBase,c.style.glyphs),sourceNameToSource:c.sourceNameToSource,primarySourceName:c.primarySourceName},r(h.spriteUrl),r(h.glyphsUrl),[2,h]}})})}});