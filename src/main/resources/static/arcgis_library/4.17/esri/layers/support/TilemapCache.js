// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.17/esri/copyright.txt for details.
//>>built
define("require exports tslib ../../request ../../core/Accessor ../../core/Error ../../core/Handles ../../core/Logger ../../core/LRUCache ../../core/PooledArray ../../core/promiseUtils ../../core/scheduling ../../core/urlUtils ../../core/watchUtils ../../core/accessorSupport/decorators ./Tilemap".split(" "),function(q,l,d,y,z,p,A,B,C,D,h,E,F,G,e,m){Object.defineProperty(l,"__esModule",{value:!0});l.TilemapCache=void 0;var H=B.getLogger("esri.layers.support.TilemapCache");q=function(l){function b(a){a=
l.call(this,a)||this;a._handles=new A;a._pendingTilemapRequests={};a._availableLevels={};a.levels=5;a.cacheByteSize=2097152;a.request=y;a._prefetchingEnabled=!0;return a}d.__extends(b,l);n=b;b.prototype.initialize=function(){var a=this;this._tilemapCache=new C(this.cacheByteSize);this._handles.add([this.watch(["layer.parsedUrl","layer.tileServers?"],function(){return a._initializeTilemapDefinition()}),G.init(this,"layer.tileInfo.lods",function(f){return a._initializeAvailableLevels(f)},!0)]);this._initializeTilemapDefinition()};
b.prototype.destroy=function(){this._handles&&(this._handles.destroy(),this._handles=null)};b.prototype.castLevels=function(a){return 2>=a?(H.error("Minimum levels for Tilemap is 3, but got ",a),3):a};Object.defineProperty(b.prototype,"size",{get:function(){return 1<<this.levels},enumerable:!1,configurable:!0});b.prototype.fetchTilemap=function(a,f,b,c){var g=this;if(!this._availableLevels[a])return h.reject(new p("tilemap-cache:level-unavailable","Level "+a+" is unavailable in the service"));var e=
this._tmpTilemapDefinition;if(a=this._tilemapFromCache(a,f,b,e))return h.resolve(a);var I=c&&c.signal;c=d.__assign(d.__assign({},c),{signal:null});return h.create(function(a,f){h.onAbort(I,function(){return f(h.createAbortError())});var b=m.tilemapDefinitionId(e),d=g._pendingTilemapRequests[b];if(!d){var d=m.Tilemap.fromDefinition(e,c).then(function(a){g._tilemapCache.put(b,a,a.byteSize);return a}),r=function(){return delete g._pendingTilemapRequests[b]};g._pendingTilemapRequests[b]=d;d.then(r,r)}d.then(a,
f)})};b.prototype.getAvailability=function(a,f,b){return this._availableLevels[a]?(a=this._tilemapFromCache(a,f,b,this._tmpTilemapDefinition))?a.getAvailability(f,b):"unknown":"unavailable"};b.prototype.getAvailabilityUpsample=function(a,b,g,c){c.level=a;c.row=b;c.col=g;a=this.layer.tileInfo;for(a.updateTileInfo(c);;)if(b=this.getAvailability(c.level,c.row,c.col),"unavailable"===b){if(!a.upsampleTile(c))return"unavailable"}else return b};b.prototype.fetchAvailability=function(a,b,g,c){return this._availableLevels[a]?
this.fetchTilemap(a,b,g,c).catch(function(a){return a}).then(function(c){if(c instanceof m.Tilemap)return c=c.getAvailability(b,g),"unavailable"===c?h.reject(new p("tile-map:tile-unavailable","Tile is not available",{level:a,row:b,col:g})):c;if(h.isAbortError(c))throw c;return"unknown"}):h.reject(new p("tilemap-cache:level-unavailable","Level "+a+" is unavailable in the service"))};b.prototype.fetchAvailabilityUpsample=function(a,b,g,c,d){var f=this;c.level=a;c.row=b;c.col=g;var e=this.layer.tileInfo;
e.updateTileInfo(c);var k=this.fetchAvailability(a,b,g,d).catch(function(a){if(h.isAbortError(a))throw a;if(e.upsampleTile(c))return f.fetchAvailabilityUpsample(c.level,c.row,c.col,c);throw a;});this._fetchAvailabilityUpsamplePrefetch(c.id,a,b,g,d,k);return k};b.prototype._fetchAvailabilityUpsamplePrefetch=function(a,b,g,c,e,l){return d.__awaiter(this,void 0,void 0,function(){var f,k,t,m,u,p,q,r,x,w;return d.__generator(this,function(v){switch(v.label){case 0:if(!this._prefetchingEnabled)return[2];
f="prefetch-"+a;if(this._handles.has(f))return[2];k=h.createAbortController();l.then(function(){return k.abort()},function(){return k.abort()});t=!1;m={remove:function(){t||(t=!0,k.abort())}};this._handles.add(m,f);v.label=1;case 1:return v.trys.push([1,3,,4]),[4,E.waitTicks(10,k.signal)];case 2:return v.sent(),[3,4];case 3:return v.sent(),[3,4];case 4:t||(t=!0,this._handles.remove(f));if(h.isAborted(k))return[2];u={id:a,level:b,row:g,col:c};p=d.__assign(d.__assign({},e),{signal:k.signal});q=this.layer.tileInfo;
r=function(a){var b=x.fetchAvailability(u.level,u.row,u.col,p);n._prefetches.push(b);a=function(){n._prefetches.removeUnordered(b)};b.then(a,a)};x=this;for(w=0;n._prefetches.length<n._maxPrefetch&&q.upsampleTile(u);++w)r(w);return[2]}})})};b.prototype._initializeTilemapDefinition=function(){if(this.layer.parsedUrl){var a=this.layer.parsedUrl,b=a.query;this._tilemapCache.clear();this._tmpTilemapDefinition={service:{url:a.path,query:b?F.objectToQuery(b):null,tileServers:this.layer.tileServers,request:this.request,
type:this.layer.type},width:this.size,height:this.size,level:0,row:0,col:0}}};b.prototype._tilemapFromCache=function(a,b,d,c){c.level=a;c.row=b-b%this.size;c.col=d-d%this.size;a=m.tilemapDefinitionId(c);return this._tilemapCache.get(a)};b.prototype._initializeAvailableLevels=function(a){var b=this;this._availableLevels={};a&&a.forEach(function(a){return b._availableLevels[a.level]=!0})};Object.defineProperty(b.prototype,"test",{get:function(){var a=this;return{get prefetchingEnabled(){return a._prefetchingEnabled},
set prefetchingEnabled(b){a._prefetchingEnabled=b},hasTilemap:function(b,d,c){return!!a._tilemapFromCache(b,d,c,a._tmpTilemapDefinition)}}},enumerable:!1,configurable:!0});var n;b._maxPrefetch=4;b._prefetches=new D({initialSize:n._maxPrefetch});d.__decorate([e.property({constructOnly:!0,type:Number})],b.prototype,"levels",void 0);d.__decorate([e.cast("levels")],b.prototype,"castLevels",null);d.__decorate([e.property({readOnly:!0,dependsOn:["levels"],type:Number})],b.prototype,"size",null);d.__decorate([e.property({constructOnly:!0,
type:Number})],b.prototype,"cacheByteSize",void 0);d.__decorate([e.property({constructOnly:!0})],b.prototype,"layer",void 0);d.__decorate([e.property({constructOnly:!0})],b.prototype,"request",void 0);return b=n=d.__decorate([e.subclass("esri.layers.support.TilemapCache")],b)}(z);l.TilemapCache=q});