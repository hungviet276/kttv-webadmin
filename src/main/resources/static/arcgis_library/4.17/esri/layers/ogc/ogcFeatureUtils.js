// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.17/esri/copyright.txt for details.
//>>built
define("require exports tslib ../../request ../../core/arrayUtils ../../core/Error ../../core/Logger ../../geometry/support/spatialReferenceUtils ../graphics/featureConversionUtils ../graphics/OptimizedFeatureSet ../graphics/data/projectionSupport ../graphics/data/projectionSupport ../graphics/sources/geojson/geojson ../graphics/sources/support/clientSideDefaults ../support/FieldsIndex ../support/fieldType ../../tasks/support/FeatureSet".split(" "),function(fa,c,a,z,H,t,X,A,P,Y,T,Z,Q,aa,ba,ca,da){function u(d,
f,g){return a.__awaiter(this,void 0,void 0,function(){var q;return a.__generator(this,function(h){switch(h.label){case 0:return[4,U(d,f,g)];case 1:return q=h.sent(),[2,P.convertToFeatureSet(q)]}})})}function U(d,f,g){var q;return a.__awaiter(this,void 0,void 0,function(){var h,c,l,k,m,t,r,n,e,v,B,b,w,C,x,D,E,F,I,W,G,H,u,J,K,L,M,N,R,y,O,S,p;return a.__generator(this,function(V){switch(V.label){case 0:return h=d.capabilities.query.maxRecordCount,c=d.collectionId,l=d.layerDefinition,k=d.url,m=k+"/collections/"+
c+"/items",t=f.geometry,r=f.num,n=f.outSpatialReference,e=f.start,v=f.timeExtent,B=f.where,w=(b=Z.project(t,A.WGS84))?b.xmin+","+b.ymin+","+b.xmax+","+b.ymax:null,C=ea(v),x=B&&"1\x3d1"!==B?B:null,D=null!==e&&void 0!==e?e:0,E=null!==r&&void 0!==r?r:null!=e&&void 0!==e?10:h,[4,z(m,a.__assign(a.__assign({},g),{query:{bbox:w,datetime:C,query:x,limit:E,startindex:D,f:"application/geo+json"}}))];case 1:F=V.sent().data;I=null===(q=F.links)||void 0===q?void 0:q.filter(function(b){return"next"===b.rel});W=
0!==(null===I||void 0===I?void 0:I.length);G=l.fields;H=l.globalIdField;u=l.hasM;J=l.hasZ;K=l.objectIdField;L=l.geometryType;M=Q.createOptimizedFeatures(F,{geometryType:L,hasZ:J,objectIdFieldName:K});if(!A.equals(n,A.WGS84))for(N=0,R=M;N<R.length;N++)y=R[N],y.geometry&&(y.geometry=P.convertFromGeometry(T.project(P.convertToGeometry(y.geometry,L,J,!1),A.WGS84,n)));O=0;for(S=M;O<S.length;O++)y=S[O],y.objectId=y.attributes[K];p=new Y.default;p.exceededTransferLimit=W;p.features=M;p.fields=G;p.geometryType=
L;p.globalIdFieldName=H;p.hasM=u;p.hasZ=J;p.objectIdFieldName=K;p.spatialReference=n||A.WGS84;return[2,p]}})})}function ea(d){if(!d)return null;var f=d.start;d=d.end;return(f?f.toISOString():"..")+"/"+(d?d.toISOString():"..")}Object.defineProperty(c,"__esModule",{value:!0});c.queryOptimizedFeatureSet=c.queryFeatureSetJSON=c.queryFeatureSet=c.getServerLandingPage=c.getServerConformance=c.getServerCollections=c.getServerCollection=c.getCollectionDefinition=void 0;var G=X.getLogger("esri.layers.graphics.sources.ogcfeature");
c.getCollectionDefinition=function(d,f,g,q,h){void 0===h&&(h=5);return a.__awaiter(this,void 0,void 0,function(){var c,l,k,m,u,r,n,e,v,B,b,w,C,x,D,E,F;return a.__generator(this,function(a){switch(a.label){case 0:return a.trys.push([0,2,,3]),[4,T.checkProjectionSupport(A.WGS84,g.spatialReference)];case 1:return a.sent(),[3,3];case 2:throw a.sent(),new t("ogc-feature-layer:projection-not-supported","Projection not supported");case 3:return c=d+"/collections/"+f+"/items",[4,z(c,{signal:q,query:{limit:h,
f:"application/geo+json"}})];case 4:return l=a.sent().data,[4,Q.validateGeoJSON(l)];case 5:a.sent();k=Q.inferLayerProperties(l,{geometryType:g.geometryType});m=g.fields||k.fields||[];u=null!=g.hasZ?g.hasZ:k.hasZ;r=k.geometryType;n=g.objectIdField||k.objectIdFieldName||"OBJECTID";e=g.timeInfo;v=H.find(m,function(b){return b.name===n});if(B=!v){if(!k.objectIdFieldType)throw new t("ogc-feature-layer:missing-feature-id","Collection geojson require a feature id as a unique identifier");m.unshift({name:n,
alias:n,type:"esriFieldTypeOID",editable:!1,nullable:!1})}else v.type="esriFieldTypeOID",v.editable=!1,v.nullable=!1;n!==k.objectIdFieldName&&(b=H.find(m,function(b){return b.name===k.objectIdFieldName}))&&(b.type="esriFieldTypeInteger");if(!r)throw new t("ogc-feature-layer:missing-property","geometryType not set and couldn't be inferred from the provided features");m===k.fields&&0<k.unknownFields.length&&G.warn({name:"ogc-feature-layer:unknown-field-types",message:"Some fields types couldn't be inferred from the features and were dropped",
details:{unknownFields:k.unknownFields}});w=0;for(C=m;w<C.length;w++){b=C[w];null==b.name&&(b.name=b.alias);null==b.alias&&(b.alias=b.name);"esriFieldTypeOID"!==b.type&&"esriFieldTypeGlobalID"!==b.type&&(b.editable=null==b.editable?!0:!!b.editable,b.nullable=null==b.nullable?!0:!!b.nullable);if(!b.name)throw new t("ogc-feature-layer:invalid-field-name","field name is missing",{field:b});if(-1===ca.kebabDict.jsonValues.indexOf(b.type))throw new t("ogc-feature-layer:invalid-field-type",'invalid type for field "'+
b.name+'"',{field:b});}e&&(x=new ba(m),e.startTimeField&&((D=x.get(e.startTimeField))?(e.startTimeField=D.name,D.type="esriFieldTypeDate"):e.startTimeField=null),e.endTimeField&&((E=x.get(e.endTimeField))?(e.endTimeField=E.name,E.type="esriFieldTypeDate"):e.endTimeField=null),e.trackIdField&&((F=x.get(e.trackIdField))?e.trackIdField=F.name:(e.trackIdField=null,G.warn({name:"ogc-feature-layer:invalid-timeInfo-trackIdField",message:"trackIdField is missing",details:{timeInfo:e}}))),e.startTimeField||
e.endTimeField||(G.warn({name:"ogc-feature-layer:invalid-timeInfo",message:"startTimeField and endTimeField are missing",details:{timeInfo:e}}),e=null));return[2,{drawingInfo:aa.createDrawingInfo(r),geometryType:r,fields:m,hasZ:!!u,objectIdField:n,timeInfo:e}]}})})};c.getServerCollection=function(d,c,g,q){return a.__awaiter(this,void 0,void 0,function(){var h,f;return a.__generator(this,function(a){switch(a.label){case 0:return h=d+"/collections/"+c,[4,z(h,{signal:q,query:{f:g}})];case 1:return f=
a.sent().data,[2,f]}})})};c.getServerCollections=function(c,f,g){return a.__awaiter(this,void 0,void 0,function(){var d,h;return a.__generator(this,function(a){switch(a.label){case 0:return d=c+"/collections",[4,z(d,{signal:g,query:{f:f}})];case 1:return h=a.sent().data,[2,h]}})})};c.getServerConformance=function(c,f,g){return a.__awaiter(this,void 0,void 0,function(){var d,h;return a.__generator(this,function(a){switch(a.label){case 0:return d=c+"/conformance",[4,z(d,{signal:g,query:{f:f}})];case 1:return h=
a.sent().data,[2,h]}})})};c.getServerLandingPage=function(c,f,g){return a.__awaiter(this,void 0,void 0,function(){var d;return a.__generator(this,function(a){switch(a.label){case 0:return[4,z(c,{signal:g,query:{f:f}})];case 1:return d=a.sent().data,[2,d]}})})};c.queryFeatureSet=function(c,f,g){return a.__awaiter(this,void 0,void 0,function(){var d;return a.__generator(this,function(a){switch(a.label){case 0:return[4,u(c,f,g)];case 1:return d=a.sent(),[2,da.fromJSON(d)]}})})};c.queryFeatureSetJSON=
u;c.queryOptimizedFeatureSet=U});