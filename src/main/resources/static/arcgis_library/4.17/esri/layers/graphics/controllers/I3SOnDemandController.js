// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.17/esri/copyright.txt for details.
//>>built
define("require exports tslib ../../../core/Accessor ../../../core/arrayUtils ../../../core/Handles ../../../core/has ../../../core/Logger ../../../core/maybe ../../../core/PooledArray ../../../core/Promise ../../../core/promiseUtils ../../../core/watchUtils ../../../core/accessorSupport/decorators ../../../core/libs/gl-matrix-2/vec3 ../../../core/libs/gl-matrix-2/vec3f64 ../../../geometry/support/aaBoundingBox ../../../geometry/support/aaBoundingRect ../dehydratedFeatures ../../support/PromiseQueue ../../../views/3d/layers/i3s/I3SFrameTask ../../../views/3d/layers/i3s/I3SIndex ../../../views/3d/layers/i3s/I3SLodHandling ../../../views/3d/layers/i3s/I3SNodeLoader ../../../views/3d/layers/i3s/I3SStreamDataController ../../../views/3d/layers/i3s/I3SUtil ../../../views/3d/layers/i3s/I3SViewportQueries ../../../views/3d/support/debugFlags ../../../views/3d/support/debugUtils ../../../views/3d/support/extentUtils ../../../views/3d/support/projectionUtils ../../../views/support/layerViewUtils ../../../views/support/Scheduler".split(" "),
function(q,Y,e,E,F,G,H,I,d,r,J,l,K,k,w,t,L,A,M,N,O,P,Q,u,R,x,S,T,U,V,W,y,X){function v(e,b){return d.isSome(e)&&e.length===b.length&&e.every(function(a){return 0<=z(b,a.name)})}function z(d,b){b=b.toLowerCase();for(var a=0;a<d.length;a++)if(d[a].name.toLowerCase()===b)return a;return-1}function B(e){return d.isSome(e)&&d.isSome(e.loadedAttributes)&&d.isSome(e.attributeData)}var p=I.getLogger("esri.layers.graphics.controllers.I3SOnDemandController");q=function(q){function b(a){a=q.call(this,a)||this;
a.screenSizeFactor=0;a.featureTarget=5E4;a.fixedFeatureTarget=!1;a.updating=!0;a.updatingProgress=1;a.leafsReached=!1;a.scaleVisibilityEnabled=!0;a.uncompressedTextureDownsamplingEnabled=!1;a._featureLOD=1;a._stableFeatureLOD=!1;a._isIdle=!1;a._cameraDirty=!0;a._invisibleDirty=!1;a._newLoadingNodes=new r({deallocator:null});a._loadedNodeScales=new Map;a._modificationsNodeFilteringArray=new r;a._downloadingCount=0;a._loadingNodes=new Map;a._updatingNodes=new Map;a._progressMaxNumNodes=1;a._poi=t.vec3f64.create();
a._requiredAttributes=[];a._requiredAttributesDirty=!0;a._updatesDisabled=!1;a.disableIDBCache=!1;a._disableMemCache=!1;a._restartNodeLoading=!1;a._fields=null;a._attributeStorageInfo=null;a._handles=new G;a._idleQueue=new N.default;a._elevationUpdateNodes=new r({deallocator:null});a._errorCount=0;return a}e.__extends(b,q);Object.defineProperty(b.prototype,"isMeshPyramid",{get:function(){return"mesh-pyramids"===this.layer.profile||"MeshPyramid"===this.layer.store.lodType},enumerable:!1,configurable:!0});
Object.defineProperty(b.prototype,"isGraphics3D",{get:function(){return"points"===this.layer.profile},enumerable:!1,configurable:!0});Object.defineProperty(b.prototype,"streamDataController",{get:function(){var a=this.layerView.view.resourceController.createStreamDataRequester(2);return new R.default(a)},enumerable:!1,configurable:!0});Object.defineProperty(b.prototype,"crsVertex",{get:function(){return x.getVertexCrs(this.layer)},enumerable:!1,configurable:!0});Object.defineProperty(b.prototype,
"crsIndex",{get:function(){return x.getIndexCrs(this.layer)},enumerable:!1,configurable:!0});Object.defineProperty(b.prototype,"rootNodeVisible",{get:function(){if(d.isSome(this._index)){var a=this._index.rootNode;if(d.isSome(a))return this._updateViewData(),this._index.isNodeVisible(a.index)}return!0},enumerable:!1,configurable:!0});b.prototype.initialize=function(){var a=this;this._disableMemCache=!this.layerView.loadCachedGPUData||!this.layerView.addCachedGPUData;this._lodHandling=new Q(this.layerView);
var c=this.layerView.i3slayer;this.layer=c;this._defaultGeometrySchema=c.store.defaultGeometrySchema;this.disableIDBCache=H("disable-feature:idb-cache");"fields"in c&&(this._fields=c.fields,this._attributeStorageInfo=c.attributeStorageInfo);var b=l.all([this.layer.when(),this.layerView.when()]).then(function(){if(!a.destroyed&&a.layerView&&!a.layerView.destroyed){var b=a.layerView.view;a._setClippingArea(b.clippingArea);a._centerOnSurface=b.pointsOfInterest.centerOnSurfaceFrequent;var g=a.layerView.view.resourceController;
a._handles.add([a._centerOnSurface.watch("renderLocation",function(){return a._pointOfInterestChanged()}),g.memoryController.events.on("quality-changed",function(){return a._setCameraDirty()}),K.init(a.layerView,"suspended",function(c){var b=c?function(){return a._updateViewData()}:function(){return a._updateIdleState(!0)},d=c?function(){}:function(){return a._updateIdleState(!1)};a._idleStateCallbacks?(c&&a.cancelNodeLoading(),a.restartNodeLoading(),a._idleStateCallbacks.idleBegin=b,a._idleStateCallbacks.idleEnd=
d):a._idleStateCallbacks=g.scheduler.registerIdleStateCallbacks(b,d)}),O.addTask(a.layerView.view.resourceController.scheduler,{update:function(c,b){return a._frame(c,b)},needsUpdate:function(){return a.updating}}),a.watch("uncompressedTextureDownsamplingEnabled",function(){return a.restartNodeLoading()}),a.watch(["featureTarget","fixedFeatureTarget"],function(){a._setCameraDirty();a._stableFeatureLOD=!1}),b.state.watch("camera",function(){return a._setCameraDirty()}),a.layer.watch("elevationInfo",
function(){return a._elevationInfoChanged()}),a.layer.watch(["minScale","maxScale"],function(){return a._scaleBoundsChanged()}),a.layerView.watch("lodFactor",function(){return a._setCameraDirty()}),a.layerView.watch("availableFields?",function(){return a._requiredFieldsChange()}),a.layerView.watch("holeFilling",function(c){return d.isSome(a._index)&&(a._index.holeFilling=c)})]);a._updateScaleHandles();a._viewportQueries=new S(a.crsIndex,b.renderCoordsHelper,b.state.camera,a._clippingArea,b.elevationProvider,
a.layer.elevationInfo,{progressiveLoadFactor:a._getProgressiveLoadFactor(),screenspaceErrorBias:a.lod,angleDependentLoD:.5>a.lod});a._index=new P.I3SIndex(c,a.streamDataController,a._viewportQueries,p,a.layerView.holeFilling,function(c){return a.layerView.isNodeLoaded(c)},function(c){return a.layerView.isNodeReloading(c)},function(c){return a._shouldLoadNode(c)},function(c){return a._enableFromGPUCache(c,1)},function(c){return a._needsUpdate(c)},function(){return!a.streamDataController.busy},function(c){return a.layerView.computeVisibilityObb?
a.layerView.computeVisibilityObb(c):null});b=d.isSome(a.layer.modifications)&&a.layer.modifications&&0<a.layer.modifications.length;a._index.imModificationsChanged(b)}});this._tmpPoint=M.makeDehydratedPoint(0,0,0,this.crsIndex);this.addResolvingPromise(b);this.when(function(){return a._startNodeLoading()})};b.prototype.updateNodeModificationStatus=function(a){var c=this,b=this._index,f=this.layerView;d.isSome(b)&&f&&f.updateNodeModificationStatus&&(this._modificationsNodeFilteringArray.clear(),a.forEachSimple(function(a){a=
b.getNode(a);d.isSome(a)&&c._modificationsNodeFilteringArray.push(a)}),f.updateNodeModificationStatus(this._modificationsNodeFilteringArray),this._invisibleDirty=!0)};b.prototype.destroy=function(){this.cancelNodeLoading();this._idleStateCallbacks&&(this._isIdle=!1,this._idleStateCallbacks.remove(),this._idleStateCallbacks=null);this._handles.destroy();this._nodeLoader=null;m.prune();d.isSome(n)&&(n.remove(),n=null)};b.prototype._getRequiredAttributes=function(){if(null==this._attributeStorageInfo||
!this._fields||!this.layerView.availableFields)return[];var a=this._attributeStorageInfo,c=this._fields,b=this.layer.objectIdField;return this.layerView.availableFields.map(function(b){var g=z(a,b);b=z(c,b);return 0<=g&&0<=b?{index:g,name:c[b].name,field:c[b],attributeStorageInfo:a[g]}:null}).filter(function(a){return null!=a&&a.name!==b})};b.prototype._requiredFieldsChange=function(){var a=this._getRequiredAttributes();v(this._requiredAttributes,a)||(this._requiredAttributes=a,this._requiredAttributesDirty=
!1,this.restartNodeLoading())};b.prototype.requestUpdate=function(){this._requiredAttributesDirty=!0;this.restartNodeLoading()};b.prototype._setClippingArea=function(a){var c=L.create();V.projectToBoundingBox(a,c,this.layerView.view.renderSpatialReference)?this._clippingArea=c:this._clippingArea=null};b.prototype._pointOfInterestChanged=function(){this._camPos&&(this._calculatePointOfInterest(this._poi),d.isSome(this._viewportQueries)&&(this._viewportQueries.setPointOfInterest(this._poi),d.isSome(this._index)&&
(this._index.progressiveLoadPenalty=C.distancePenalty*this._viewportQueries.distCameraToPOI(),this._index.requestUpdate())))};b.prototype._calculatePointOfInterest=function(a){var c=this._centerOnSurface.renderLocation,b=t.vec3f64.create();w.vec3.subtract(b,c,this._camPos);var f=this.layerView.view.renderCoordsHelper,h=t.vec3f64.create();f.worldUpAtPosition(c,h);b=w.vec3.angle(h,b)-.5*Math.PI;w.vec3.lerp(a,this._camPos,c,Math.max(0,Math.min(1,b/(.5*Math.PI))));T.SHOW_POI?(d.isNone(n)&&(n=new U.GraphicsHandle(this.layerView.view.graphics,
"blue")),n.showPoint(a,this.layerView.view.renderSpatialReference)):d.isSome(n)&&n.remove()};b.prototype.updateClippingArea=function(a){this._setClippingArea(a);d.isSome(this._viewportQueries)&&d.isSome(this._index)&&(this._viewportQueries.updateExtent(this._clippingArea),this._index.invalidateVisibilityCache());this._setCameraDirty()};b.prototype._setCameraDirty=function(){this._cameraDirty=!0;this.notifyChange("rootNodeVisible");this._lodHandling.setLodGlobalDirty();this._evaluateUpdating()};b.prototype.updateElevationChanged=
function(a,c){var b=this,f=this._index;if(!d.isNone(f)){var h=f.rootNode;if(!d.isNone(h)){var e=this._elevationUpdateNodes;e.clear();x.findIntersectingNodes(a,c,h,this.crsIndex,f,function(a){return e.push(a.index)});e.forEachSimple(function(a){f.invalidateBoundingVolumeCache(a);a===h.index&&b.notifyChange("rootNodeVisible")});e.length&&this.restartNodeLoading()}}};b.prototype.getParentIndex=function(a){return d.isSome(this._index)&&this._index.getParentIndex(a)};b.prototype._elevationInfoChanged=
function(){d.isSome(this._index)&&this._index.updateElevationInfo(this.layer.elevationInfo);this._setCameraDirty()};b.prototype._updateScaleHandles=function(){var a=this;this._handles.remove("scale-bounds");this.areScaleBoundsActive&&this._handles.add(this.layerView.view.basemapTerrain.on("scale-change",function(c){return a._scaleUpdateHandler(c)}),"scale-bounds")};b.prototype._scaleBoundsChanged=function(){this.areScaleBoundsActive||this._loadedNodeScales.clear();this._updateScaleHandles();this._setCameraDirty()};
b.prototype._scaleUpdateHandler=function(a){this._updateScaleInBoundingRect(a.scale,a.extent,a.spatialReference);this._setCameraDirty()};b.prototype._updateScaleInBoundingRect=function(a,c,b){var g=this,h=this._index;d.isNone(h)||!d.isNone(h.rootNode)&&W.boundingRectToBoundingRect(c,b,D,this.crsIndex)&&this._loadedNodeScales.forEach(function(c,b){c=h.getNode(b);d.isSome(c)&&A.containsPoint(D,c.mbs)&&g._loadedNodeScales.set(b,a)})};b.prototype.restartNodeLoading=function(){this._restartNodeLoading=
!0;this.cancelNodeLoading();this._evaluateUpdating()};b.prototype.schedule=function(a,c){return this._idleQueue.push(function(){l.throwIfAborted(a);return c()})};b.prototype.reschedule=function(a,c){return this._idleQueue.unshift(function(){l.throwIfAborted(a);return c()})};Object.defineProperty(b.prototype,"isIntegratedMesh",{get:function(){return"integrated-mesh"===this.layer.type},enumerable:!1,configurable:!0});Object.defineProperty(b.prototype,"areScaleBoundsActive",{get:function(){var a=y.extractSafeScaleBounds(this.layer),
c=a.minScale,a=a.maxScale;return this.scaleVisibilityEnabled&&(0<c||0<a)},enumerable:!1,configurable:!0});Object.defineProperty(b.prototype,"unloadedMemoryEstimate",{get:function(){return d.isNone(this._index)||this.layerView.suspended?0:this._index.getUnloadedMemoryEstimate()*this.lodDropFactor},enumerable:!1,configurable:!0});Object.defineProperty(b.prototype,"indexDepth",{get:function(){return d.isSome(this._index)?this._index.maxLevel:0},enumerable:!1,configurable:!0});Object.defineProperty(b.prototype,
"disableMemCache",{set:function(a){this.layerView.loadCachedGPUData&&this.layerView.addCachedGPUData||(this._disableMemCache=!0);this._disableMemCache=a},enumerable:!1,configurable:!0});b.prototype._frame=function(a,c){if(this.layerView.suspended)return this._updateViewData(),this._evaluateUpdating(),-Infinity;if(!this.layerView.visible||d.isNone(this._index))return-Infinity;this._processLogError(a,c);return this._index.getPriority()};b.prototype._processLogError=function(a,c){try{this._process(a,
c)}catch(g){50>this._errorCount?p.error("Error during processing: "+g):50===this._errorCount&&p.error("Too many errors for this layer. Further errors will not be displayed."),this._errorCount++}};b.prototype._process=function(a,c){var b=this;this._restartNodeLoading&&this._startNodeLoading();if(null!=this._nodeLoader&&!d.isNone(this._index)){this._updateViewData();this._invisibleDirty&&this._removeInvisibleNodes(a)&&(this._invisibleDirty=!1);this.isIntegratedMesh&&(a.enabled=!1);a.run(function(){return b._processIndex(a)});
this._updateFeatureLOD();a.run(function(){return b._processCache(a)});this.isIntegratedMesh&&(a.enabled=!0);for(a.run(function(){return b._processNodes(a,c)});!a.done&&this._idleQueue.process();)a.madeProgress();a.run(function(){return b._prefetchIndex()});c.numIndexLoading+=this._index.getIndexLoading();c.numNodesLoading+=this._downloadingCount;a.run(function(){return b._lodHandling.lodGlobalHandling(a)});this._evaluateUpdating()}};b.prototype._processIndex=function(a){var c=this;if(d.isNone(this._index))return!1;
this._index.dirty&&(this._newLoadingNodes.clear(),this._index.update(F.keysOfMap(this._loadingNodes),a,function(a){return c.updateNodeModificationStatus(a)}),this._disableMemCache||(this._newLoadingNodes.pushArray(this._index.updates.add.data,this._index.updates.add.length),this._newLoadingNodes.pushArray(this._index.updates.missing.data,this._index.updates.missing.length)),a=this._index.getFeatureEstimate().leafsReached,this._index.isLoading()||a===this._get("leafsReached")||this._set("leafsReached",
a));return this._index.load()};b.prototype._prefetchIndex=function(){return d.isNone(this._index)||0<this._loadingNodes.size||0<this._index.updates.add.length?!1:this._index.prefetch()};b.prototype._updateFeatureLOD=function(){if(this.isGraphics3D&&!d.isNone(this._index)&&!d.isNone(this._viewportQueries)){var a=!this._index.isLoading(),c=this.featureTarget*this.baseLOD,b=this._index.getFeatureEstimate();b.estimate=b.estimate||c/2;if(500<this._index.getIndexMissing()){if(1E-4>=this._featureLOD)return;
this._featureLOD/=1.5;this._stableFeatureLOD=!1}else if(a&&b.estimate<c){if(b.leafsReached||1E4<=this._featureLOD||this._stableFeatureLOD)return;this._featureLOD*=Math.min(10,Math.max(c/b.estimate,1.001));a=this.lod;c=this._index.checkFeatureTarget(c,a);c!==a&&(this._featureLOD=c/this.baseLOD,this._stableFeatureLOD=!0)}else if(b.estimate>1.2*c||a&&b.estimate>c){if(1E-4>=this._featureLOD)return;this._featureLOD/=1+.25*(b.estimate/c-1);this._stableFeatureLOD=!1}else return;this._featureLOD=Math.min(1E4,
Math.max(1E-4,this._featureLOD));this._viewportQueries.updateScreenSpaceErrorBias(this.lod);this._index.requestUpdate()}};b.prototype._processCache=function(a){var c=this._index;if(d.isNone(c))return!1;for(;0<this._newLoadingNodes.length&&!a.done;)for(var b=this._newLoadingNodes.pop(),b=c.getParent(b);d.isSome(b)&&!this.layerView.isNodeLoaded(b.index)&&this._isNodeInScaleBounds(b);b=c.getParent(b.index))if(this._enableFromGPUCache(b,0)){a.madeProgress();break}return a.hasProgressed};b.prototype._processNodes=
function(a,b){if(d.isNone(this._index))return!1;var c=(this._isIdle?100:2)-this._loadingNodes.size,f=this._index.updates;f.cancel.forEach(this._cancelNode,this);for(f.cancel=[];0<f.remove.length&&!a.done;)this.layerView.removeNode(f.remove.pop()),a.madeProgress();for(;0<f.update.length&&!a.done;){var h=this._index.getNode(f.update.pop());d.isSome(h)&&(this._updateLoadedNode(h),a.madeProgress())}for(;0<f.add.length&&!a.done&&0<c;){--c;h=this._index.getNode(f.add.back());if(d.isNone(h)||2!==h.cacheState&&
!this._hasNodeLoadToken(b))break;f.add.pop();this._loadNode(h);a.madeProgress()}return a.hasProgressed};b.prototype._cancelAllNodes=function(){this._loadingNodes.forEach(function(a){return a.abort()});this._loadingNodes.clear();this._updatingNodes.forEach(function(a){return a.abort()});this._updatingNodes.clear()};b.prototype._cancelNode=function(a){var b=this._loadingNodes.get(a);b&&(b.abort(),this._loadingNodes.delete(a))};b.prototype._hasNodeLoadToken=function(a){return!this._isIdle&&2<=a.numNodesLoading+
this._loadingNodes.size?!1:!this.streamDataController.busy};b.prototype._evaluateUpdating=function(){var a=!1,b=0;this.layerView.suspended?b=(a=this._cameraDirty)?.5:1:(a=d.isSome(this._index)?this._index.getIndexMissing():0,b=d.isSome(this._index)?this._index.updates.add.length:0,b=a+3*b+2*this._loadingNodes.size,a=!!(0<b||0<this._updatingNodes.size||this._restartNodeLoading||this._cameraDirty||0<this._idleQueue.length||this._lodHandling&&this._lodHandling.requiresLODGlobalHandling),0===b&&(this._progressMaxNumNodes=
1),this._progressMaxNumNodes=Math.max(b,this._progressMaxNumNodes),b=1-b/this._progressMaxNumNodes);a!==this.updating&&this._set("updating",a);b!==this.updatingProgress&&this._set("updatingProgress",b)};b.prototype._updateViewData=function(){if(this._cameraDirty&&!d.isNone(this._index)&&!d.isNone(this._viewportQueries)){var a=this.layerView.view,b=a.state.camera;this._camPos=t.vec3f64.clone(a.pointsOfInterest.renderPointOfView);this.screenSizeFactor=1/(b.perScreenPixelRatio/2);this._calculatePointOfInterest(this._poi);
this._viewportQueries.updateCamera(b);this._viewportQueries.setPointOfInterest(this._poi);this._viewportQueries.updateScreenSpaceErrorBias(this.lod);this._index.invalidateVisibilityCache();this._index.progressiveLoadPenalty=C.distancePenalty*this._viewportQueries.distCameraToPOI();this._index.requestUpdate();this._stableFeatureLOD=!1;this._invisibleDirty=!0;this._cameraDirty=!1;this.notifyChange("rootNodeVisible")}};b.prototype._getProgressiveLoadFactor=function(){return 1>this.layerView.view.resourceController.memoryController.memoryFactor?
1:this.layerView.progressiveLoadFactor};Object.defineProperty(b.prototype,"lod",{get:function(){return this._featureLOD*this.baseLOD},enumerable:!1,configurable:!0});Object.defineProperty(b.prototype,"baseLOD",{get:function(){var a=this.layerView.lodFactor,b=this.layerView.view.resourceController.memoryController.memoryFactor;return this.fixedFeatureTarget?1:(0<a?a:1)*b},enumerable:!1,configurable:!0});Object.defineProperty(b.prototype,"lodDropFactor",{get:function(){if(this.fixedFeatureTarget)return 1;
var a=this.layerView.view.resourceController.memoryController;return(Math.min(a.memoryFactor,.5)-a.minQuality)/(.5-a.minQuality)},enumerable:!1,configurable:!0});b.prototype.isGeometryVisible=function(a){return d.isSome(this._index)&&this._index.isGeometryVisible(a.index)};b.prototype.updateVisibility=function(a){d.isSome(this._index)&&this._index.invalidateNodeVisibilityCache(a)};b.prototype.updateBoundingVolume=function(a){d.isSome(this._index)&&this._index.invalidateBoundingVolumeCache(a)};b.prototype.invalidateGeometryVisibility=
function(a){d.isSome(this._index)&&this._index.invalidateGeometryVisibility(a)};b.prototype.invalidateVisibilityObbs=function(){d.isSome(this._index)&&this._index.invalidateVisibilityObbs()};b.prototype.modificationsChanged=function(){if(d.isSome(this._index)){var a=d.isSome(this.layer.modifications)&&this.layer.modifications&&0<this.layer.modifications.length;this._index.imModificationsChanged(a)}this._invisibleDirty=!0};b.prototype._shouldLoadNode=function(a){return this._lodHandling.shouldLoadNode(a)&&
!this._shouldDropNode(a)&&this._isNodeInScaleBounds(a)?d.isSome(this._index)?this._index.isGeometryVisible(a.index):!1:!1};b.prototype._shouldDropNode=function(a){if(d.isNone(this._viewportQueries))return!1;var b=this.lodDropFactor;return 1<=b||!this._lodHandling.childrenEmpty(a)?!1:Math.abs(this._viewportQueries.calcCameraDistanceToCenter(a))-this._viewportQueries.minDistance>(this._viewportQueries.maxDistance-this._viewportQueries.minDistance)*b};b.prototype._startNodeLoading=function(){var a=this;
this._restartNodeLoading=!1;var b=this._index;if(!(this._updatesDisabled||null==this.streamDataController||d.isNone(b)||d.isNone(this._viewportQueries))){this._updateViewData();this._requiredAttributesDirty&&(this._requiredAttributes=this._getRequiredAttributes(),this._requiredAttributesDirty=!1);var g=u.TextureFormat.Normal;this.layerView.useCompressedTextures?g=u.TextureFormat.Compressed:this.uncompressedTextureDownsamplingEnabled&&(g=u.TextureFormat.Downsampled);this._nodeLoader=new u(this.layer,
this.streamDataController,p,this._defaultGeometrySchema,this._requiredAttributes,{textureFormat:g,textureUsageMask:this.layerView.rendererTextureUsage,loadFeatureData:!this.isMeshPyramid});b.requestUpdate();this._lodHandling.startNodeLoading(function(b){return a._isNodeInScaleBounds(b)},function(b,c){return a._removeNodes(b,c)},b,{maxLodLevel:this._viewportQueries.maxLodLevel});this._evaluateUpdating()}};b.prototype.isNodeLoading=function(){return null!=this._nodeLoader&&null!=this._index};b.prototype.cancelNodeLoading=
function(){this.isNodeLoading()&&(this.streamDataController.cancelAll(),this._idleQueue.cancelAll(),this._cancelAllNodes(),this._nodeLoader=null,this._evaluateUpdating())};b.prototype._removeInvisibleNodes=function(a){var b=this,g=this._index;if(d.isNone(g)||d.isNone(this._viewportQueries))return!1;m.clear();this.layerView.getLoadedNodeIndices(m);var f=0===this._viewportQueries.maxDistance,h=f?function(){return!1}:function(a){return b._shouldDropNode(a)};m.filterInPlace(function(a){var c=g.getNode(a);
return d.isNone(c)||!g.isGeometryVisible(a)||h(c)||!b._isNodeInScaleBounds(c)});0<m.length&&this._lodHandling.setLodGlobalDirty();this._removeNodes(m,a);if(f&&1>this.lodDropFactor)return!1;if(0===m.length)return!0;m.clear();return!1};b.prototype.markNodeToRemove=function(a){m.push(a)};b.prototype.removeMarkedNodes=function(){this._removeNodes(m,X.noBudget)};b.prototype._removeNodes=function(a,b){0<a.length&&d.isSome(this._index)&&this._index.requestUpdate();for(var c=a.length;0<a.length&&!b.done;)this.layerView.removeNode(a.pop()),
b.madeProgress();if(0<this._loadedNodeScales.size)for(b=a.length;b<c;b++)this._loadedNodeScales.delete(a.data[b])};b.prototype._needsUpdate=function(a){if(!a.resources.hasFeatureData||this._updatingNodes.has(a.index))return!1;a=this.layerView.getLoadedAttributes(a.index);return null!=a&&a!==this._requiredAttributes};b.prototype._updateLoadedNode=function(a){var b=this,d=l.createAbortController();this._updatingNodes.set(a.index,d);var f=this.layerView.getLoadedAttributes(a.index);(v(f,this._requiredAttributes)?
l.resolve(this.layerView.getAttributeData(a.index)):this._nodeLoader.loadAttributes(a,this._requiredAttributes,d.signal)).then(function(c){return b.schedule(d.signal,function(){return b.layerView.setAttributeData(a.index,{loadedAttributes:b._requiredAttributes,attributeData:c})})}).catch(function(c){l.isAbortError(c)||b.layerView.setAttributeData(a.index,{loadedAttributes:b._requiredAttributes,attributeData:{}})}).catch(function(){}).then(function(){b._updatingNodes.delete(a.index);b._evaluateUpdating()});
this._evaluateUpdating()};b.prototype._loadNode=function(a){var b=this;if(this._loadingNodes.has(a.index))p.error("already loading node "+a.index);else{var d=l.createAbortController();this._loadingNodes.set(a.index,d);var f=function(){b._loadingNodes.get(a.index)===d&&b._loadingNodes.delete(a.index);b._evaluateUpdating()};this._evaluateUpdating();this._loadAndAddNode(a,d.signal).then(f).catch(function(a){f();if(!l.isAbortError(a))throw a;})}};b.prototype._loadAndAddNode=function(a,b){var c=this;return 1===
a.cacheState?this._loadUncached(a,b):this._loadCached(a,b).then(function(b){b||(a.cacheState=1,d.isSome(c._index)&&c._index.updates.add.push(a.index))}).catch(function(b){if(!l.isAbortError(b))throw a.cacheState=1,b;})};b.prototype._enableFromGPUCache=function(a,b){if(this._disableMemCache||d.isNone(this._index))return!1;if(0===b&&!this._index.useNodeAsHole(a.index))return!0;var c=this._loadCachedGPUData(a);if(!c)return!1;this.layerView.addCachedGPUData(a,c,b);this._nodeAdded();return!0};b.prototype._loadCachedGPUData=
function(a){a=this.layerView.loadCachedGPUData(a);return d.isSome(a)&&B(a.attributeInfo)&&v(a.attributeInfo.loadedAttributes,this._requiredAttributes)?a:null};b.prototype._nodeAdded=function(){d.isSome(this._index)&&this._index.requestUpdate();this._lodHandling.setLodGlobalDirty();this._evaluateUpdating()};b.prototype._loadCached=function(a,b){var c=this;if(this._enableFromGPUCache(a,1))return l.resolve(!0);var f=this.layerView;return!this.disableIDBCache&&f.loadCachedNodeData&&f.addCachedNodeData?
this.schedule(b,function(){return f.loadCachedNodeData(a,b,function(b,d){return c._nodeLoader.loadTextures(a,b,d)})}).then(function(e){if(d.isNone(e))return!1;var g=c._requiredAttributes;return B(e)&&v(e.loadedAttributes,g)?c.reschedule(b,function(){return f.addCachedNodeData(a,e,e,b)}).then(function(){c._nodeAdded();return!0}):c.reschedule(b,function(){return c._nodeLoader.loadAttributes(a,g,b)}).then(function(d){return c.reschedule(b,function(){return f.addCachedNodeData(a,e,{loadedAttributes:g,
attributeData:d},b)})}).then(function(){c._nodeAdded();return!0})}):l.resolve(!1)};b.prototype._loadUncached=function(a,b){var c=this;this._downloadingCount++;return this._nodeLoader.loadNodeData(a,b).catch(function(a){c._downloadingCount--;throw a;}).then(function(d){c._downloadingCount--;return c.schedule(b,function(){return c.layerView.addNode(a,d,b)})}).then(function(){c._nodeAdded();a.cacheState=2}).catch(function(b){if(!l.isAbortError(b))throw p.error("Failed to load node '"+a.id+"': "+b),a.failed=
!0,d.isSome(c._index)&&c._index.requestUpdate(),b;})};b.prototype._updateIdleState=function(a){a!==this._isIdle&&(this._isIdle=a,this._evaluateUpdating(),a&&this._index&&d.isSome(this._index)&&this._index.resetFailedNodes())};b.prototype._getScale=function(a){if(this._loadedNodeScales.has(a.index))return this._loadedNodeScales.get(a.index);this._tmpPoint.x=a.mbs[0];this._tmpPoint.y=a.mbs[1];this._tmpPoint.z=a.mbs[2];var b=this.layerView.view.basemapTerrain.getScale(this._tmpPoint);this.layerView.isNodeLoaded(a.index)&&
this._loadedNodeScales.set(a.index,b);return b};b.prototype._isNodeInScaleBounds=function(a){if(!this.areScaleBoundsActive)return!0;a=this._getScale(a);var b=y.extractSafeScaleBounds(this.layer);return y.scaleBoundsPredicate(a,b.minScale,b.maxScale)};b.prototype.updateStats=function(a){a.index=d.isSome(this._index)?this._index.size:0;this.isGraphics3D&&(a.detail=this._featureLOD,a.target=this.featureTarget*this.baseLOD);d.isSome(this._index)&&this._index.updateStats(a)};Object.defineProperty(b.prototype,
"test",{get:function(){var a=this;return{index:this._index,set disableUpdates(b){(a._updatesDisabled=b)?a.cancelNodeLoading():a.requestUpdate()},set disableIDBCache(b){a.disableIDBCache=b},set ignoreServiceObb(b){d.isSome(a._index)&&(a._index.ignoreServiceObb=b)},shouldLoadNode:function(b){return a._shouldLoadNode(b)}}},enumerable:!1,configurable:!0});e.__decorate([k.property({readOnly:!0})],b.prototype,"isMeshPyramid",null);e.__decorate([k.property({readOnly:!0})],b.prototype,"isGraphics3D",null);
e.__decorate([k.property({readOnly:!0})],b.prototype,"streamDataController",null);e.__decorate([k.property({readOnly:!0})],b.prototype,"crsVertex",null);e.__decorate([k.property({readOnly:!0})],b.prototype,"crsIndex",null);e.__decorate([k.property()],b.prototype,"_camPos",void 0);e.__decorate([k.property()],b.prototype,"screenSizeFactor",void 0);e.__decorate([k.property()],b.prototype,"featureTarget",void 0);e.__decorate([k.property()],b.prototype,"fixedFeatureTarget",void 0);e.__decorate([k.property()],
b.prototype,"layerView",void 0);e.__decorate([k.property()],b.prototype,"layer",void 0);e.__decorate([k.property({readOnly:!0})],b.prototype,"updating",void 0);e.__decorate([k.property({readOnly:!0})],b.prototype,"updatingProgress",void 0);e.__decorate([k.property({readOnly:!0})],b.prototype,"leafsReached",void 0);e.__decorate([k.property({constructOnly:!0})],b.prototype,"scaleVisibilityEnabled",void 0);e.__decorate([k.property({readOnly:!0})],b.prototype,"rootNodeVisible",null);e.__decorate([k.property({aliasOf:"layerView.uncompressedTextureDownsamplingEnabled?"})],
b.prototype,"uncompressedTextureDownsamplingEnabled",void 0);return b=e.__decorate([k.subclass("esri.layers.graphics.controllers.I3SOnDemandController")],b)}(J.EsriPromiseMixin(E));var m=new r({deallocator:null}),n,C={factorIM:.2,factor3dObject:.05,distancePenalty:10},D=A.create();return q});