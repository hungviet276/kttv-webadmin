// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.17/esri/copyright.txt for details.
//>>built
define("require exports tslib ../../../../core/Error ../../../../core/Logger ../../../../core/maybe ../../../../core/promiseUtils ../../../../core/accessorSupport/decorators ./StreamConnection ../../../../tasks/operations/zscale".split(" "),function(t,g,c,l,u,q,r,m,v,w){Object.defineProperty(g,"__esModule",{value:!0});g.WebSocketConnection=g.ReadyState=void 0;var h=u.getLogger("esri.layers.graphics.sources.connections.WebSocketConnection"),k;(function(e){e[e.CONNECTING=0]="CONNECTING";e[e.OPEN=1]=
"OPEN";e[e.CLOSING=2]="CLOSING";e[e.CLOSED=3]="CLOSED"})(k=g.ReadyState||(g.ReadyState={}));t=function(e){function f(a){var b=e.call(this)||this;b.errorString=null;var d=a.geometryType,p=a.spatialReference,f=a.sourceSpatialReference;b._config=a;b._featureZScaler=w.getGeometryZScaler(d,f,p);b._open();return b}c.__extends(f,e);f.prototype._open=function(){return c.__awaiter(this,void 0,void 0,function(){return c.__generator(this,function(a){switch(a.label){case 0:return[4,this._tryCreateWebSocket()];
case 1:return a.sent(),this.destroyed?[3,3]:[4,this._handshake()];case 2:a.sent(),a.label=3;case 3:return[2]}})})};f.prototype.destroy=function(){q.isSome(this._websocket)&&(this._websocket.onopen=null,this._websocket.onclose=null,this._websocket.onerror=null,this._websocket.onmessage=null,this._websocket.close());this._websocket=null};Object.defineProperty(f.prototype,"connectionStatus",{get:function(){if(q.isNone(this._websocket))return"disconnected";switch(this._websocket.readyState){case k.CONNECTING:case k.OPEN:return"connected";
case k.CLOSING:case k.CLOSED:return"disconnected"}},enumerable:!1,configurable:!0});f.prototype._tryCreateWebSocket=function(a,b,d){void 0===a&&(a=this._config.source.path);void 0===b&&(b=1E3);void 0===d&&(d=0);return c.__awaiter(this,void 0,void 0,function(){var p,f,e;return c.__generator(this,function(c){switch(c.label){case 0:c.trys.push([0,2,,4]);if(this.destroyed)return[2];p=this;return[4,this._createWebSocket(a)];case 1:return p._websocket=c.sent(),this.notifyChange("connectionStatus"),[3,4];
case 2:f=c.sent();e=b/1E3;if(this._config.maxReconnectionAttempts&&d>=this._config.maxReconnectionAttempts)return h.error(new l("websocket-connection","Exceeded maxReconnectionAttempts attempts. No further attempts will be made")),this.destroy(),[2];h.error(new l("websocket-connection","Failed to connect. Attempting to reconnect in "+e+"s",f));return[4,r.after(b)];case 3:return c.sent(),[2,this._tryCreateWebSocket(a,Math.min(1.5*b,1E3*this._config.maxReconnectionInterval),d+1)];case 4:return[2]}})})};
f.prototype._createWebSocket=function(a){var b=this,d=new WebSocket(a);a=r.create(function(a,b){d.onopen=function(){return a(d)};d.onclose=function(a){return b(a)}});a.then(function(){b.destroyed?(d.onclose=function(){},d.close()):(d.onclose=function(a){return b._onClose(a)},d.onerror=function(a){return b._onError(a)},d.onmessage=function(a){return b._onMessage(a)})});return a};f.prototype._handshake=function(a){void 0===a&&(a=1E4);return c.__awaiter(this,void 0,void 0,function(){var b,d,f,e,g,k,
n,m=this;return c.__generator(this,function(c){b=this._websocket;if(q.isNone(b))return[2];d=r.createResolver();f=b.onmessage;e=this._config;g=e.filter;k=e.outFields;n=e.spatialReference;d.timeout(a);b.onmessage=function(a){var e,c=null;try{c=JSON.parse(a.data)}catch(y){}c&&"object"===typeof c||(h.error(new l("websocket-connection","Protocol violation. Handshake failed - malformed message",a.data)),d.reject(),m.destroy());(null===(e=c.spatialReference)||void 0===e?void 0:e.wkid)!==(null===n||void 0===
n?void 0:n.wkid)&&(h.error(new l("websocket-connection","Protocol violation. Handshake failed - expected wkid of "+n.wkid,a.data)),d.reject(),m.destroy());"json"!==c.format&&(h.error(new l("websocket-connection","Protocol violation. Handshake failed - format is not set",a.data)),d.reject(),m.destroy());g&&c.filter!==g&&h.error(new l("websocket-connection","Tried to set filter, but server doesn't support it"));k&&c.outFields!==k&&h.error(new l("websocket-connection","Tried to set outFields, but server doesn't support it"));
b.onmessage=f;d.resolve()};b.send(JSON.stringify({filter:g,outFields:k,format:"json",spatialReference:{wkid:n.wkid}}));return[2,d.promise]})})};f.prototype._onMessage=function(a){try{var b=JSON.parse(a.data);if("featureResult"!==b.type)throw new l("websocket-connection","Protocol violation - Expected to find message of type 'featureResult'",b);a=0;for(var d=b.features;a<d.length;a++){var c=d[a];this._featureZScaler&&this._featureZScaler(c.geometry);this.onFeature(c)}}catch(x){h.error(new l("websocket-connection",
"Failed to parse message",x)),this.destroy()}};f.prototype._onError=function(a){this._set("errorString","Encountered an error over WebSocket connection");h.error("websocket-connection","Encountered an error over WebSocket connection")};f.prototype._onClose=function(a){this._websocket=null;this.notifyChange("connectionStatus");1E3!==a.code&&h.error("websocket-connection","WebSocket closed unexpectedly with error code "+a.code);this.destroyed||this._open()};c.__decorate([m.property()],f.prototype,"connectionStatus",
null);c.__decorate([m.property()],f.prototype,"errorString",void 0);return f=c.__decorate([m.subclass("esri.layers.graphics.sources.connections.WebSocketConnection")],f)}(v.default);g.WebSocketConnection=t});