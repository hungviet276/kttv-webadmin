// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.17/esri/copyright.txt for details.
//>>built
define("require exports tslib ../../Graphic ../../core/Collection ../../core/Error ../../core/lang ../../core/maybe ../../core/promiseUtils ../../core/urlUtils ../../geometry/support/normalizeUtils".split(" "),function(D,l,h,w,p,e,x,r,t,y,z){function A(a,b,d){return h.__awaiter(this,void 0,void 0,function(){var n,f;return h.__generator(this,function(c){switch(c.label){case 0:return[4,a.load()];case 1:c.sent();n=a.source;if(!n||null==n.applyEdits)return[2,t.reject(new e(a.type+"-layer:no-editing-support",
"Layer source does not support applyEdits capability",{layer:a}))];if(!a.editingEnabled)throw new e(a.type+"-layer:editing-disabled","Editing is disabled for layer",{layer:a});return[4,B(a,b,d)];case 2:return f=c.sent(),f.addFeatures.length||f.updateFeatures.length||f.deleteFeatures.length||f.addAttachments.length||f.updateAttachments.length||f.deleteAttachments.length?[2,n.applyEdits(f,d)]:[2,{addFeatureResults:[],updateFeatureResults:[],deleteFeatureResults:[],addAttachmentResults:[],updateAttachmentResults:[],
deleteAttachmentResults:[]}]}})})}function B(a,b,d){return h.__awaiter(this,void 0,void 0,function(){var n,f,c,g;return h.__generator(this,function(k){n=b&&(b.addFeatures||b.updateFeatures||b.deleteFeatures);f=b&&(b.addAttachments||b.updateAttachments||b.deleteAttachments);if(!b||!n&&!f)throw new e(a.type+"-layer:missing-parameters","'addFeatures', 'updateFeatures', 'deleteFeatures', 'addAttachments', 'updateAttachments' or 'deleteAttachments' parameter is required");if(!a.capabilities.data.isVersioned&&
d&&d.gdbVersion)throw new e(a.type+"-layer:invalid-parameter","'gdbVersion' is applicable only if the layer supports versioned data. See: 'capabilities.data.isVersioned'");if(!a.capabilities.editing.supportsRollbackOnFailure&&d&&d.rollbackOnFailureEnabled)throw new e(a.type+"-layer:invalid-parameter","This layer does not support 'rollbackOnFailureEnabled' parameter. See: 'capabilities.editing.supportsRollbackOnFailure'");if(!a.capabilities.editing.supportsGlobalId&&d&&d.globalIdUsed)throw new e(a.type+
"-layer:invalid-parameter","This layer does not support 'globalIdUsed' parameter. See: 'capabilities.editing.supportsGlobalId'");if(!a.capabilities.editing.supportsGlobalId&&f)throw new e(a.type+"-layer:invalid-parameter","'addAttachments', 'updateAttachments' and 'deleteAttachments' are applicable only if the layer supports global ids. See: 'capabilities.editing.supportsGlobalId'");if((!d||!d.globalIdUsed)&&f)throw new e(a.type+"-layer:invalid-parameter","When 'addAttachments', 'updateAttachments' or 'deleteAttachments' is specified, globalIdUsed should be set to true");
c=h.__assign({},b);c.addFeatures=b&&p.isCollection(b.addFeatures)?b.addFeatures.toArray():c.addFeatures||[];c.updateFeatures=b&&p.isCollection(b.updateFeatures)?b.updateFeatures.toArray():c.updateFeatures||[];c.deleteFeatures=b&&p.isCollection(b.deleteFeatures)?b.deleteFeatures.toArray():c.deleteFeatures||[];c.addAttachments=c.addAttachments||[];c.updateAttachments=c.updateAttachments||[];c.deleteAttachments=c.deleteAttachments||[];c.addFeatures=c.addFeatures.map(u);c.updateFeatures=c.updateFeatures.map(u);
g=d&&d.globalIdUsed;c.addFeatures.forEach(function(b){return q(b,a,g)});c.updateFeatures.forEach(function(b){return q(b,a,g)});c.deleteFeatures.forEach(function(b){return q(b,a,g)});c.addAttachments.forEach(function(b){return v(b,a)});c.updateAttachments.forEach(function(b){return v(b,a)});return[2,C(c)]})})}function q(a,b,d){if(d){if("attributes"in a&&!a.attributes[b.globalIdField])throw new e(b.type+"-layer:invalid-parameter","Feature should have 'globalId' when 'globalIdUsed' is true");if(!("attributes"in
a||a.globalId))throw new e(b.type+"-layer:invalid-parameter","'globalId' of the feature should be passed when 'globalIdUsed' is true");}if("geometry"in a&&r.isSome(a.geometry)&&a.geometry.hasZ&&r.isSome(b.capabilities.data.supportsZ)&&!1===b.capabilities.data.supportsZ)throw new e(b.type+"-layer:z-unsupported","Service does not support z values while feature has z values.");}function v(a,b){var d=a.feature;a=a.attachment;if(!d||"attributes"in d&&!d.attributes[b.globalIdField])throw new e(b.type+"-layer:invalid-parameter",
"Attachment should have reference to a feature with 'globalId'");if(!("attributes"in d||d.globalId))throw new e(b.type+"-layer:invalid-parameter","Attachment should have reference to 'globalId' of the parent feature");if(!a.globalId)throw new e(b.type+"-layer:invalid-parameter","Attachment should have 'globalId'");if(!a.data&&!a.uploadId)throw new e(b.type+"-layer:invalid-parameter","Attachment should have 'data' or 'uploadId'");if(!(a.data instanceof File&&a.data.name||a.name))throw new e(b.type+
"-layer:invalid-parameter","'name' is required when attachment is specified as Base64 encoded string using 'data'");if(!b.capabilities.editing.supportsUploadWithItemId&&a.uploadId)throw new e(b.type+"-layer:invalid-parameter","This layer does not support 'uploadId' parameter. See: 'capabilities.editing.supportsUploadWithItemId'");if("string"===typeof a.data&&(d=y.dataComponents(a.data))&&!d.isBase64)throw new e(b.type+"-layer:invalid-parameter","Attachment 'data' should be a Blob, File or Base64 encoded string");
}function C(a){return h.__awaiter(this,void 0,void 0,function(){var b,d,e,f,c,g;return h.__generator(this,function(k){switch(k.label){case 0:return b=a.addFeatures,d=a.updateFeatures,e=b.concat(d).map(function(a){return a.geometry}),[4,z.normalizeCentralMeridian(e)];case 1:return f=k.sent(),c=b.length,g=d.length,f.slice(0,c).forEach(function(b,c){a.addFeatures[c].geometry=b}),f.slice(c,c+g).forEach(function(b,c){a.updateFeatures[c].geometry=b}),[2,a]}})})}function u(a){var b=new w;a.attributes||(a.attributes=
{});b.geometry=a.geometry;b.attributes=a.attributes;return b}Object.defineProperty(l,"__esModule",{value:!0});l.applyEdits=l.isEditableLayer=void 0;l.isEditableLayer=function(a){return!0===a.get("capabilities.operations.supportsEditing")};l.applyEdits=function(a,b,d){return h.__awaiter(this,void 0,void 0,function(){var e,f,c,g,k,m,l;return h.__generator(this,function(h){switch(h.label){case 0:c={edits:b,result:t.create(function(a,b){e=a;f=b})},a.emit("apply-edits",c),h.label=1;case 1:return h.trys.push([1,
3,,4]),[4,A(a,b,d)];case 2:return g=h.sent(),k=function(a){return a.filter(function(a){return!a.error}).map(x.clone)},m={addedFeatures:k(g.addFeatureResults),updatedFeatures:k(g.updateFeatureResults),deletedFeatures:k(g.deleteFeatureResults),addedAttachments:k(g.addAttachmentResults),updatedAttachments:k(g.updateAttachmentResults),deletedAttachments:k(g.deleteAttachmentResults)},(m.addedFeatures.length||m.updatedFeatures.length||m.deletedFeatures.length||m.addedAttachments.length||m.updatedAttachments.length||
m.deletedAttachments.length)&&a.emit("edits",m),e(m),[2,g];case 3:throw l=h.sent(),f(l),l;case 4:return[2]}})})}});