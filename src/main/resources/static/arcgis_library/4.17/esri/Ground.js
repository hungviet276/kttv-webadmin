// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.17/esri/copyright.txt for details.
//>>built
define("require exports tslib ./Color ./core/Collection ./core/collectionUtils ./core/compilerUtils ./core/Error ./core/JSONSupport ./core/lang ./core/Loadable ./core/loadAll ./core/Logger ./core/promiseUtils ./core/accessorSupport/decorators ./core/accessorSupport/ensureType ./ground/NavigationConstraint ./webdoc/support/opacityUtils @dojo/framework/shim/Promise".split(" "),function(l,E,d,u,v,w,x,y,z,m,A,B,C,k,f,n,D,p){function q(d){return"elevation"===d.type||d&&"createElevationSampler"in d}var r=
C.getLogger("esri.Ground");return function(g){function c(a){var b=g.call(this,a)||this;b.opacity=1;b.surfaceColor=null;b.navigationConstraint=null;b.layers=new v;b.layers.on("after-add",function(a){a=a.item;a.parent&&a.parent!==b&&"remove"in a.parent&&a.parent.remove(a);a.parent=b;"elevation"!==a.type&&"base-elevation"!==a.type&&r.error("Layer '"+a.title+", id:"+a.id+"' of type '"+a.type+"' is not supported as a ground layer and will therefore be ignored. Only layers of type 'elevation' are supported.")});
b.layers.on("after-remove",function(a){a.item.parent=null});return b}d.__extends(c,g);h=c;c.prototype.initialize=function(){this.when().catch(function(a){r.error("#load()","Failed to load ground",a)});this.resourceInfo&&this.read(this.resourceInfo.data,this.resourceInfo.context)};c.prototype.destroy=function(){for(var a=0,b=this.layers.removeAll();a<b.length;a++)b[a].destroy();this.layers.destroy()};c.prototype.normalizeCtorArgs=function(a){a&&"resourceInfo"in a&&(this._set("resourceInfo",a.resourceInfo),
a=d.__assign({},a),delete a.resourceInfo);return a};Object.defineProperty(c.prototype,"layers",{set:function(a){this._set("layers",w.referenceSetter(a,this._get("layers")))},enumerable:!1,configurable:!0});c.prototype.writeLayers=function(a,b,c,e){var t=[];a&&(e=d.__assign(d.__assign({},e),{layerContainerType:"ground"}),a.forEach(function(a){if("write"in a){var b={};x.typeCast(a)().write(b,e)&&t.push(b)}else e&&e.messages&&e.messages.push(new y("layer:unsupported","Layers ("+a.title+", "+a.id+") of type '"+
a.declaredClass+"' cannot be persisted in the ground",{layer:a}))}));b.layers=t};c.prototype.load=function(a){this.addResolvingPromise(this._loadFromSource(a));return k.resolve(this)};c.prototype.loadAll=function(){var a=this;return B.loadAll(this,function(b){b(a.layers)})};c.prototype.queryElevation=function(a,b){var c=this;return this.load().then(function(){return c._importElevationQuery()}).then(function(d){d=new d.ElevationQuery;var e=c.layers.filter(q).toArray();return d.queryAll(e,a,b)})};c.prototype.createElevationSampler=
function(a,b){var c=this.layers.filter(q).toArray();return 1===c.length?c[0].createElevationSampler(a,b):this._importElevationQuery().then(function(d){return(new d.ElevationQuery).createSamplerAll(c,a,b)})};c.prototype.clone=function(){var a={opacity:this.opacity,surfaceColor:m.clone(this.surfaceColor),navigationConstraint:m.clone(this.navigationConstraint),layers:this.layers.slice()};this.loaded&&(a.loadStatus="loaded");return(new h({resourceInfo:this.resourceInfo})).set(a)};c.prototype.read=function(a,
b){this.resourceInfo||this._set("resourceInfo",{data:a,context:b});g.prototype.read.call(this,a,b)};c.prototype._loadFromSource=function(a){var b=this.resourceInfo;return b?this._loadLayersFromJSON(b.data,b.context,a):k.resolve(null)};c.prototype._loadLayersFromJSON=function(a,b,c){var d=this,f=b&&b.origin||"web-scene",g=b&&b.portal||null,h=b&&b.url||null;return(new Promise(function(a,b){l(["./portal/support/layersCreator"],a,b)})).then(function(b){k.throwIfAborted(c);var e=[];a.layers&&Array.isArray(a.layers)&&
e.push(b.populateOperationalLayers(d.layers,a.layers,{context:{origin:f,url:h,portal:g,layerContainerType:"ground"},defaultLayerType:"ArcGISTiledElevationServiceLayer"}));return k.eachAlways(e)}).then(function(){})};c.prototype._importElevationQuery=function(){return new Promise(function(a,b){l(["./layers/support/ElevationQuery"],a,b)})};var h;d.__decorate([f.property({json:{read:!1}})],c.prototype,"layers",null);d.__decorate([f.writer("layers")],c.prototype,"writeLayers",null);d.__decorate([f.property({readOnly:!0})],
c.prototype,"resourceInfo",void 0);d.__decorate([f.property({type:Number,nonNullable:!0,range:{min:0,max:1},json:{type:n.Integer,read:{reader:p.transparencyToOpacity,source:"transparency"},write:{writer:function(a,b){b.transparency=p.opacityToTransparency(a)},target:"transparency"}}})],c.prototype,"opacity",void 0);d.__decorate([f.property({type:u,json:{type:[n.Integer],write:function(a,b){b.surfaceColor=a.toJSON().slice(0,3)}}})],c.prototype,"surfaceColor",void 0);d.__decorate([f.property({type:D.NavigationConstraint,
json:{write:!0}})],c.prototype,"navigationConstraint",void 0);return c=h=d.__decorate([f.subclass("esri.Ground")],c)}(z.JSONSupportMixin(A))});