// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.17/esri/copyright.txt for details.
//>>built
define("require exports tslib ../../core/Error ../../core/promiseUtils ../../portal/schemas/webScene ./utils @dojo/framework/shim/Promise".split(" "),function(E,q,f,y,w,r,u){function F(b,a){if(a.properties){if("layerType"in a.properties)return a.properties.layerType.enum[0];if("type"in a.properties)return a.properties.type.enum[0]}switch(b){case "multipoint_geometry_schema.json":return"multipoint";case "point_geometry_schema.json":return"point";case "polyline_geometry_schema.json":return"polyline";
case "polygon_geometry_schema.json":return"polygon";case "extent_schema.json":return"extent"}}function z(b){return"array"===b.type?z(b.items)+"[]":b.type}function G(b){var a={count:b.length,refsCount:0,typesCount:0,distinctTypes:[],type:null},c=new Set,d;for(d in b){var e=b[d];e.$ref?a.refsCount++:e.type&&(a.typesCount++,c.add(z(e)))}c.forEach(function(c){return a.distinctTypes.push(c)});a.distinctTypes.sort();a.refsCount===a.count?a.type="refs":2===a.count&&0<a.refsCount&&1===a.distinctTypes.length&&
"null"===a.distinctTypes[0]?a.type="refsAndNull":a.typesCount===a.count?(a.type="types",a.distinctTypes=a.distinctTypes):a.type="mix";return a}function x(b,a,c,d,e){return f.__awaiter(this,void 0,void 0,function(){var g,h,k,l,m;return f.__generator(this,function(f){switch(f.label){case 0:e.schemaStack.push(b);g=F(b,c);d=d?d.replace("\x3c?TYPE?\x3e",g?"\x3c"+g+"\x3e":""):null;if("array"!==c.type&&"properties"in c)return[3,2];(h=e.currentClass?null:{type:b,name:b,id:b+"--"+a,typeValue:a,properties:[]})&&
e.push(null,h);return[4,t(c,d,e)];case 1:return f.sent(),e.schemaStack.pop(),[2,h];case 2:e.hasFilteredProperties?(f=e.filteredPropertiesArray.join("/"),k=b+"--"+a+"--"+f):k=b+"--"+a;if((l="drawingInfo_schema.json"!==b&&"layer_schema.json"!==b&&e.seen.get(k))&&d)return e.addProperty({name:d,type:l}),e.schemaStack.pop(),[2,l];m={type:b,name:b,id:k,typeValue:a,properties:[]};d&&e.addProperty({name:d,type:m});e.push(d,m);return[4,t(c,"",e)];case 3:return f.sent(),e.schemaStack.pop(),[2,e.pop()]}})})}
function B(b,a,c){return f.__awaiter(this,void 0,void 0,function(){var d,e,g,h,k,l,m,A;return f.__generator(this,function(n){switch(n.label){case 0:return[4,c.requestSchema(b.$ref)];case 1:d=n.sent();var p=d.schema;e="layerDefinition"===p.title?null:(p=p.properties&&p.properties.type)&&p.enum?p.enum:null;if(!e)return[3,6];g=0;h=e;n.label=2;case 2:if(!(g<h.length))return[3,5];k=h[g];l=f.__assign({},d.schema);l.properties=f.__assign(f.__assign({},l.properties),{type:{type:"string",enum:[k]}});m=-1===
a.indexOf("\x3c?TYPE?\x3e")?a+"\x3c?TYPE?\x3e":a;return[4,x(d.schemaId,k,l,m,c)];case 3:n.sent(),n.label=4;case 4:return g++,[3,2];case 5:return[2,void 0];case 6:return A="layer_schema.json"===d.schemaId&&c.schemaStack.length?c.schemaStack[c.schemaStack.length-1].replace(/_schema\.json/,""):null,[4,x(d.schemaId,A,d.schema,a,c)];case 7:return n.sent(),[2]}})})}function H(b,a){if(!v(b))return!1;b=b.stack.map(function(a){return a.klass.type}).join("/");return/.*pointCloudLayer_schema\.json\/layerDefinition_schema\.json\/drawingInfo_schema\.json$/.test(b)&&
"renderer"===a}function I(b,a){if(!v(b))return!1;b=b.stack.map(function(a){return a.klass.type}).join("/");return/.*(imageServiceLayer|tiledImageServiceLayer)_schema\.json\/layerDefinition_schema\.json\/drawingInfo_schema\.json$/.test(b)&&"renderer"===a}function v(b){return b.currentClass&&"drawingInfo_schema.json"===b.currentClass.name}function J(b,a,c){if(v(c)){var d=H(c,a),e=I(c,a);return b.filter(function(a){if(/uniqueValueFromStyleRenderer_schema\.json$/.test(a.$ref))return!1;if(e)return K.test(a.$ref)&&
!L.test(a.$ref);if(M.test(a.$ref))return!1;a=/pointCloud.*Renderer/.test(a.$ref);return d===a})}a:{switch(c.schemaStack[c.schemaStack.length-1]){case "operationalLayers_schema.json":case "elevationLayers_schema.json":case "baseMapLayer_schema.json":a=!0;break a}a=!1}if(a){var g=["kmlLayer","rasterDataElevationLayer","rasterDataLayer"];return b.filter(function(a){return!g.some(function(b){return a.$ref.replace(/.*\//,"")===b+"_schema.json"})})}return b}function N(b,a,c){return f.__awaiter(this,void 0,
void 0,function(){return f.__generator(this,function(d){switch(d.label){case 0:return[4,t(b.items,a+"[]",c)];case 1:return d.sent(),[2]}})})}function O(b,a,c){return f.__awaiter(this,void 0,void 0,function(){var d,e,g,h,k,l=this;return f.__generator(this,function(m){switch(m.label){case 0:d=function(d){var e;return f.__generator(this,function(g){switch(g.label){case 0:return"webscene_schema.json"===c.currentClass.name&&("tables"===d||"mapRangeInfo"===d||"widgets"===d)||"baseMap_schema.json"===c.currentClass.name&&
"elevationLayers"===d||v(c)&&(e=c.stack.map(function(a){return a.klass.type}).join("/"),/imageServiceLayer|tiledImageServiceLayer/.test(e)&&"transparency"===d)?[2,"continue"]:[4,c.withFilter(d,function(){return f.__awaiter(l,void 0,void 0,function(){var e;return f.__generator(this,function(g){switch(g.label){case 0:return e=a?a+"."+d:d,[4,t(b.properties[d],e,c)];case 1:return g.sent(),[2]}})})})];case 1:return g.sent(),[2]}})};e=[];for(g in b.properties)e.push(g);h=0;m.label=1;case 1:if(!(h<e.length))return[3,
4];k=e[h];return[5,d(k)];case 2:m.sent(),m.label=3;case 3:return h++,[3,1];case 4:return[2]}})})}function C(b,a,c){void 0===a&&(a="");void 0===c&&(c=new Set);for(var d=0;d<b.length;d++){var e=b[d];if("properties"in e)for(var g in e.properties){var h=e.properties[g],f=a?a+"."+g:g,l=Object.keys(h);if(0===l.length||1===l.length&&"$ref"===l[0])c.add(f);else if(1===l.length&&"allOf"===l[0])c.add(f),C(h.allOf,f,c);else throw Error("unexpected allOf filter construct: "+JSON.stringify(h));}}return c}function P(b,
a,c){return f.__awaiter(this,void 0,void 0,function(){var d,e,g,h,k;return f.__generator(this,function(f){switch(f.label){case 0:d=null;e=0;for(g=b.allOf;e<g.length;e++)if(h=g[e],"$ref"in h){if(d)throw Error("Cannot process more than 1 ref in an allOf construct");d=h}else if(!("properties"in h))throw Error("allOf construct only allows simple top-level property filters");k=C(b.allOf);return[4,c.addFilter(k,function(){return B(d,a,c)})];case 1:return f.sent(),[2]}})})}function Q(b,a,c){return f.__awaiter(this,
void 0,void 0,function(){var d,e,g,h,k,l,m,q,n,p,r;return f.__generator(this,function(f){switch(f.label){case 0:d=G(b.oneOf);if("refs"!==d.type&&"refsAndNull"!==d.type)return[3,6];e=J(b.oneOf,a,c);g=0;h=e;f.label=1;case 1:if(!(g<h.length))return[3,5];k=h[g];return"null"!==k.type?[3,2]:[3,4];case 2:return l=""+(a||"")+(1!==e.length?"\x3c?TYPE?\x3e":""),[4,t(k,l,c)];case 3:f.sent(),f.label=4;case 4:return g++,[3,1];case 5:return[2];case 6:if("types"===d.type)return c.addProperty({name:a,type:u.sorted(d.distinctTypes).join("|")}),
[2];m=[];for(q in b.oneOf)m.push(q);n=0;f.label=7;case 7:if(!(n<m.length))return[3,10];p=m[n];r=".oneOf["+p+"]";return[4,t(b.oneOf[p],""+a+r,c)];case 8:f.sent(),f.label=9;case 9:return n++,[3,7];case 10:return[2]}})})}function R(b,a,c){return f.__awaiter(this,void 0,void 0,function(){return f.__generator(this,function(d){switch(d.label){case 0:return[4,B(b,a,c)];case 1:return d.sent(),[2]}})})}function S(b,a,c){return f.__awaiter(this,void 0,void 0,function(){var d,e;return f.__generator(this,function(f){d=
"unknown";b.type&&(d=Array.isArray(b.type)?u.sorted(b.type).join("|"):b.type.replace(/ /g,"").split(",").join("|"));e={name:a,type:d,default:b.default};b.enum&&(e.enum=u.sorted(b.enum).map(function(a){return"string"===typeof a?'"'+a+'"':""+a}).join("|"));c.addProperty(e);return[2]})})}function t(b,a,c){return f.__awaiter(this,void 0,void 0,function(){return f.__generator(this,function(d){return"array"===b.type?[2,N(b,a,c)]:"properties"in b?[2,O(b,a,c)]:"allOf"in b?[2,P(b,a,c)]:"oneOf"in b?[2,Q(b,
a,c)]:"$ref"in b?[2,R(b,a,c)]:[2,S(b,a,c)]})})}function D(b){return 0===b.indexOf("#/definitions/")?b.slice(14):b}Object.defineProperty(q,"__esModule",{value:!0});q.schemaDefinitions=q.scan=void 0;var M=/raster.*Renderer|vectorFieldRenderer/,K=/(uniqueValueRenderer|classBreaksRenderer|raster.*Renderer|vectorFieldRenderer)/,L=/(rasterUniqueValueRenderer|rasterClassBreaksRenderer)/;q.scan=function(b,a){return f.__awaiter(this,void 0,void 0,function(){var c;return f.__generator(this,function(d){switch(d.label){case 0:return[4,
T.create(b,a)];case 1:return c=d.sent(),[2,x((b||"webscene")+"_schema.json",null,c.schemaRoot,null,c)]}})})};var T=function(b){function a(a,d,e){var c=b.call(this)||this;c.definitions=a;c.schemaRoot=d;c.requestSchema=e;c.filteredProperties=null;c.schemaStack=[];c.requestSchema.bind(c);return c}f.__extends(a,b);Object.defineProperty(a.prototype,"hasFilteredProperties",{get:function(){return this.filteredProperties&&0<this.filteredProperties.size},enumerable:!1,configurable:!0});Object.defineProperty(a.prototype,
"filteredPropertiesArray",{get:function(){var a=[];this.filteredProperties.forEach(function(c){return a.push(c)});return a},enumerable:!1,configurable:!0});a.prototype.withFilter=function(a,b){return f.__awaiter(this,void 0,void 0,function(){var c,d,h=this;return f.__generator(this,function(e){switch(e.label){case 0:if(!this.hasFilteredProperties)return[2,b()];if(!this.filteredProperties.has(a))return[2];c=this.filteredProperties;this.filteredProperties=null;d=function(a){h.filteredProperties||(h.filteredProperties=
new Set);h.filteredProperties.add(a)};c.forEach(function(c){c=c.split(".",2);1<c.length&&c[0]===a&&d(c[1])});return[4,b()];case 1:return e.sent(),this.filteredProperties=c,[2]}})})};a.prototype.addFilter=function(a,b){return f.__awaiter(this,void 0,void 0,function(){var c,d,h,k=this;return f.__generator(this,function(e){switch(e.label){case 0:return c=this.filteredProperties,this.filteredProperties=null,d=function(a){k.filteredProperties||(k.filteredProperties=new Set);k.filteredProperties.add(a)},
c&&c.forEach(d),a&&a.forEach(d),[4,b()];case 1:return h=e.sent(),this.filteredProperties=c,[2,h]}})})};a.create=function(c,b){return f.__awaiter(this,void 0,void 0,function(){return f.__generator(this,function(d){return b&&b.useRemoteSchema?[2,a.createRemote(c,b.baseUrl)]:[2,a.createLocal(c)]})})};a.createLocal=function(c){return new a(r.json.definitions,c&&"webscene"!==c?r.json.definitions[c+"_schema.json"]:r.json,a.getLocalSchemaRequest())};a.createRemote=function(c,b){return f.__awaiter(this,void 0,
void 0,function(){var d,g,h;return f.__generator(this,function(e){switch(e.label){case 0:return[4,a.getRemoteSchemaRequest(b)];case 1:return d=e.sent(),g=new a({},null,d),[4,g.requestSchema((c||"webscene")+"_schema.json")];case 2:return h=e.sent().schema,[2,new a(g.definitions,h,d)]}})})};a.getLocalSchemaRequest=function(){return function(a){a=D(a);var b=this.definitions[a];return b?w.resolve({schemaId:a,schema:b}):w.reject(new y("flatspec-spec:invalid-local-schema","Schema reference is not a local reference"))}};
a.getRemoteSchemaRequest=function(b){return f.__awaiter(this,void 0,void 0,function(){var c,e;return f.__generator(this,function(d){switch(d.label){case 0:if(!b)return[2,w.reject(new y("flatspec-spec:missing-base-url","The base url of the remote schema directory must be specified when using a remote schema"))];c=a.getLocalSchemaRequest();return[4,new Promise(function(a,b){E(["../../request"],a,b)})];case 1:return e=d.sent(),[2,function(a){var d=this;return c.call(this,a).catch(function(){return e(b+
"/"+a,{responseType:"json"}).then(function(b){d.definitions[D(a)]=b.data;return{schemaId:a,schema:b.data}})})}]}})})};return a}(u.ScanContext);q.schemaDefinitions=Object.keys(r.json.definitions).map(function(b){return b.replace(/_schema\.json$/,"")})});