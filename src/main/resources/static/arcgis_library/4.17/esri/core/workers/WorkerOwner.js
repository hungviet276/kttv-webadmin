// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.17/esri/copyright.txt for details.
//>>built
define("require exports tslib ../../kernel ../Error ../Logger ../promiseUtils ./utils ./workerFactory".split(" "),function(z,A,g,q,r,t,h,f,u){var v=t.getLogger("esri.core.workers"),p=f.MessageType.ABORT,w=f.MessageType.INVOKE,x=f.MessageType.OPEN,y=f.MessageType.OPENED,k=f.MessageType.RESPONSE;return function(){function c(a,b){this._outJobs=new Map;this._inJobs=new Map;this.worker=a;this.id=b;a.addEventListener("message",this._onMessage.bind(this));a.addEventListener("error",function(a){a.preventDefault();
v.error(a)})}c.create=function(a){return g.__awaiter(this,void 0,void 0,function(){var b;return g.__generator(this,function(e){switch(e.label){case 0:return[4,u.createWorker()];case 1:return b=e.sent(),[2,new c(b,a)]}})})};c.prototype.terminate=function(){this.worker.terminate()};c.prototype.open=function(a,b){void 0===b&&(b={});return g.__awaiter(this,void 0,void 0,function(){var e,d,c=this;return g.__generator(this,function(B){e=b.signal;d=f.newJobId();return[2,h.create(function(b,f){var n=h.onAbortOrThrow(e,
function(){c._outJobs.delete(d);c._post({type:p,jobId:d})});c._outJobs.set(d,{resolve:b,reject:f,abortHandle:n});c._post({type:x,jobId:d,modulePath:a})})]})})};c.prototype._onMessage=function(a){if(a=f.receiveMessage(a))switch(a.type){case y:this._onOpenedMessage(a);break;case k:this._onResponseMessage(a);break;case p:this._onAbortMessage(a);break;case w:this._onInvokeMessage(a)}};c.prototype._onAbortMessage=function(a){var b=this._inJobs;a=a.jobId;var e=b.get(a);e&&(e.controller&&e.controller.abort(),
b.delete(a))};c.prototype._onInvokeMessage=function(a){var b=this,e=a.methodName,d=a.jobId,c=a.data;a=a.abortable?h.createAbortController():null;var l=this._inJobs,g=q.workerMessages[e],m;try{if("function"!==typeof g)throw new TypeError(e+" is not a function");m=g.call(null,c,{signal:a?a.signal:null})}catch(n){this._post({type:k,jobId:d,error:f.toInvokeError(n)});return}h.isPromiseLike(m)?(l.set(d,{controller:a,promise:m}),m.then(function(a){l.has(d)&&(l.delete(d),b._post({type:k,jobId:d},a))},function(a){l.has(d)&&
(l.delete(d),a||(a={message:"Error encountered at method"+e}),h.isAbortError(a)||b._post({type:k,jobId:d,error:f.toInvokeError(a||{message:"Error encountered at method "+e})}))})):this._post({type:k,jobId:d},m)};c.prototype._onOpenedMessage=function(a){var b,e=a.jobId;a=a.data;var d=this._outJobs.get(e);d&&(this._outJobs.delete(e),null===(b=d.abortHandle)||void 0===b?void 0:b.remove(),d.resolve(a))};c.prototype._onResponseMessage=function(a){var b,e=a.jobId,d=a.error;a=a.data;var c=this._outJobs.get(e);
c&&(this._outJobs.delete(e),null===(b=c.abortHandle)||void 0===b?void 0:b.remove(),d?c.reject(r.fromJSON(JSON.parse(d))):c.resolve(a))};c.prototype._post=function(a,b,c){return f.postMessage(this.worker,a,b,c)};return c}()});