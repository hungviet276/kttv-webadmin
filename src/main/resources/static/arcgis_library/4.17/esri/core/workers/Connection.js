// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.17/esri/copyright.txt for details.
//>>built
define("require exports ../handleUtils ../Logger ../promiseUtils ./RemoteClient".split(" "),function(t,u,n,p,f,l){var q=p.getLogger("esri.core.workers.Connection");return function(){function c(){this._clients=[];this._clientPromises=[];this._clientIdx=0}c.prototype.destroy=function(){this.close()};Object.defineProperty(c.prototype,"closed",{get:function(){return!this._clients||!this._clients.length},enumerable:!1,configurable:!0});c.prototype.open=function(b,e){var a=this;return f.create(function(m,
c){var d=!0,h=function(a){f.throwIfAborted(e.signal);d&&(d=!1,a())};a._clients.length=b.length;a._clientPromises.length=b.length;for(var r=function(d){var g=b[d];if(f.isThenable(g))return a._clientPromises[d]=g.then(function(b){a._clients[d]=new l(b,e);h(m);return a._clients[d]},function(){h(c);return null}),"continue";a._clients[d]=new l(g,e);a._clientPromises[d]=f.resolve(a._clients[d]);h(m)},k=0;k<b.length;++k)r(k)})};c.prototype.broadcast=function(b,e,a){for(var c=Array(this._clientPromises.length),
d=0;d<this._clientPromises.length;++d)c[d]=this._clientPromises[d].then(function(d){return d.invoke(b,e,a)});return c};c.prototype.close=function(){for(var b=0,e=this._clientPromises;b<e.length;b++)e[b].then(function(a){return a.close()});this._clients.length=0;this._clientPromises.length=0};c.prototype.getAvailableClient=function(){for(var b,e=0;e<this._clients.length;++e){var a=this._clients[e];if(!a)b=b||[],b.push(this._clientPromises[e]);else if(!a.isBusy())return f.resolve(a)}return b?f.first(b):
(this._clientIdx=(this._clientIdx+1)%this._clients.length,f.resolve(this._clients[this._clientIdx]))};c.prototype.invoke=function(b,e,a){var c=null;Array.isArray(a)?(q.warn("invoke()","The transferList parameter is deprecated, use the options object instead"),c={transferList:a}):c=a;return this.closed?f.reject(Error("Connection closed")):this.getAvailableClient().then(function(a){return a.invoke(b,e,c)})};c.prototype.on=function(b,c){var a=this;return f.all(this._clientPromises).then(function(){return n.handlesGroup(a._clients.map(function(a){return a.on(b,
c)}))})};c.prototype.openPorts=function(){var b=this;return f.create(function(c){for(var a=Array(b._clientPromises.length),e=a.length,d=function(d){b._clientPromises[d].then(function(b){a[d]=b.openPort();0===--e&&c(a)})},f=0;f<b._clientPromises.length;++f)d(f)})};Object.defineProperty(c.prototype,"test",{get:function(){return{numClients:this._clients.length}},enumerable:!1,configurable:!0});return c}()});