// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.17/esri/copyright.txt for details.
//>>built
define("require exports tslib ../Error ../has ../promiseUtils ./Connection ./RemoteClient ./WorkerOwner @dojo/framework/shim/Promise".split(" "),function(A,a,e,B,g,p,l,v,C){function m(c,b){return e.__awaiter(this,void 0,void 0,function(){var a;return e.__generator(this,function(x){switch(x.label){case 0:return a=new l,[4,a.open(c,b)];case 1:return x.sent(),[2,a]}})})}function y(){return e.__awaiter(this,void 0,void 0,function(){var c,b,a;return e.__generator(this,function(e){if(d)return[2,d];n=p.createAbortController();
c=[];b=function(b){var a=C.create(b).then(function(a){return f[b]=a});c.push(a)};for(a=0;a<h;a++)b(a);d=p.all(c);return[2,d]})})}Object.defineProperty(a,"__esModule",{value:!0});a.terminate=a.open=a.openWithPorts=a.initialize=a.RemoteClient=a.Connection=void 0;a.Connection=l;a.RemoteClient=v;var h=g("esri-workers-debug")?1:g("host-browser")?navigator.hardwareConcurrency-1:0;h||(h=g("safari")&&g("mac")||g("trident")?7:2);var z=0,f=[];a.initialize=function(){y()};a.openWithPorts=function(a,b){return m(a,
{client:b})};a.open=function(a,b){void 0===b&&(b={});return e.__awaiter(this,void 0,void 0,function(){var c,d,l,r,q,t,w,u,n;return e.__generator(this,function(k){switch(k.label){case 0:if("string"!==typeof a)throw new B("workers:undefined-module","modulePath is missing");c=b.strategy||"distributed";g("host-webworker")&&!g("esri-workers")&&(c="local");return"local"!==c?[3,4]:[4,v.loadWorker(a)];case 1:return(d=k.sent())?[3,3]:[4,new Promise(function(b,c){A([a],b,c)})];case 2:d=k.sent(),k.label=3;case 3:return p.throwIfAborted(b.signal),
l=b.client||d,r=v.connect(d),[2,m([r],e.__assign(e.__assign({},b),{client:l}))];case 4:return[4,y()];case 5:k.sent();p.throwIfAborted(b.signal);if("dedicated"!==c)return[3,7];q=z++%h;return[4,f[q].open(a,b)];case 6:return r=k.sent(),[2,m([r],b)];case 7:if(b.maxNumWorkers&&0<b.maxNumWorkers&&(t=Math.min(b.maxNumWorkers,h),t<h)){w=Array(t);for(u=0;u<t;++u)q=z++%h,w[u]=f[q].open(a,b);return[2,m(w,b)]}n=f.map(function(c){return c.open(a,b)});return[2,m(n,b)]}})})};a.terminate=function(){d&&(n.abort(),
d=null);for(var a=0;a<f.length;a++)f[a]&&f[a].terminate();f.length=0};var d=null,n});