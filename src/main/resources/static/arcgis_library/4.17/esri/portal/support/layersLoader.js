// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.17/esri/copyright.txt for details.
//>>built
define("require exports tslib ../../request ../../core/Error ../../core/promiseUtils ../../layers/support/lazyLayerLoader ../Portal ./jsonContext ../../renderers/support/styleUtils".split(" "),function(C,m,k,v,q,n,l,w,x,y){function z(b,d){return k.__awaiter(this,void 0,void 0,function(){var a,c,f,h,e,g;return k.__generator(this,function(k){switch(k.label){case 0:a=b.instance;c=a.portalItem;f=c.url;h=c.title;e=x.createForItem(c);if("group"===a.type)return a.read({title:h},e),[2,A(a,b)];f&&a.read({url:f},
e);return[4,r(b,d)];case 1:return(g=k.sent())&&a.read(g,e),a.resourceReferences={portalItem:c,paths:e.readResourcePaths},a.read({title:h},e),[2,y.loadStyleRenderer(a,e)]}})})}function A(b,d){var a;a=b.portalItem.type;switch(a){case "Feature Service":a=l.layerLookupMap.FeatureLayer;break;case "Stream Service":a=l.layerLookupMap.StreamLayer;break;case "Scene Service":a=l.layerLookupMap.SceneLayer;break;case "Feature Collection":a=l.layerLookupMap.FeatureLayer;break;default:throw new q("portal:unsupported-item-type-as-group",
"The item type '"+a+"' is not supported as a 'GroupLayer'");}var c;return a().then(function(a){c=a;return r(d)}).then(function(a){return 0<p(a)?t(b,c,a):B(b,c)})}function B(b,d){return b.portalItem.url?v(b.portalItem.url,{responseType:"json",query:{f:"json"}}).then(function(a){function c(a){return{id:a.id,name:a.name}}var f,h;(a=a.data)&&t(b,d,{layers:null===(f=a.layers)||void 0===f?void 0:f.map(c),tables:null===(h=a.tables)||void 0===h?void 0:h.map(c)})}):n.resolve()}function t(b,d,a){var c=a.layers||
[],f=a.tables||[];"Feature Collection"===b.portalItem.type&&(c.forEach(function(a){var b;"Table"===(null===(b=null===a||void 0===a?void 0:a.layerDefinition)||void 0===b?void 0:b.type)&&f.push(a)}),c=c.filter(function(a){var b;return"Table"!==(null===(b=null===a||void 0===a?void 0:a.layerDefinition)||void 0===b?void 0:b.type)}));c.reverse().forEach(function(c){c=u(b,d,a,c);b.add(c)});f.reverse().forEach(function(c){c=u(b,d,a,c);b.tables.add(c)})}function u(b,d,a,c){d=new d({portalItem:b.portalItem,
layerId:c.id,sublayerTitleMode:"service-name"});"Feature Collection"===b.portalItem.type&&(b={origin:"portal-item",portal:b.portalItem.portal||w.getDefault()},d.read(c,b),a=a.showLegend,null!=a&&d.read({showLegend:a},b));return d}function r(b,d){if(!1===b.supportsData)return n.resolve();var a=b.instance;return a.portalItem.fetchData("json",d).catch(function(){return null}).then(function(b){var c,d;d="stream"===a.type?!1:"layerId"in a;if(d){d=!0;if(b&&0<p(b)){null==a.layerId&&(c=(c=b.layers)&&c.length?
c[0].id:(c=b.tables)&&c.length?c[0].id:null,a.layerId=c);a:{c=a.layerId;var e=b.layers;if(e)for(var g=0;g<e.length;g++)if(e[g].id===c){c=e[g];break a}if(e=b.tables)for(g=0;g<e.length;g++)if(e[g].id===c){c=e[g];break a}c=null}c&&(1===p(b)&&(d=!1),null!=b.showLegend&&(c.showLegend=b.showLegend))}d&&"service-name"!==a.sublayerTitleMode&&(a.sublayerTitleMode="item-title-and-service-name");return c}return b})}function p(b){var d,a,c,f,h=null!==(a=null===(d=null===b||void 0===b?void 0:b.layers)||void 0===
d?void 0:d.length)&&void 0!==a?a:0;b=null!==(f=null===(c=null===b||void 0===b?void 0:b.tables)||void 0===c?void 0:c.length)&&void 0!==f?f:0;return h+b}Object.defineProperty(m,"__esModule",{value:!0});m.load=void 0;m.load=function(b,d){return k.__awaiter(this,void 0,void 0,function(){var a;return k.__generator(this,function(c){switch(c.label){case 0:return(a=b.instance.portalItem)&&a.id?[4,a.load(d)]:[2,n.resolve()];case 1:c.sent();c=b.instance.portalItem;if(-1===b.supportedTypes.indexOf(c.type))throw new q("portal:invalid-layer-item-type",
"Invalid layer item type '${type}', expected '${expectedType}'",{type:c.type,expectedType:b.supportedTypes.join(", ")});return[2,z(b,d)]}})})}});