// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.17/esri/copyright.txt for details.
//>>built
define("require exports tslib ../Color ../request ../core/Error ../core/lang ../core/Logger ../core/LRUCache ../core/maybe ../core/promiseUtils ../core/SetUtils ../core/string ../core/accessorSupport/decorators ../layers/support/fieldUtils ./Renderer ./mixins/VisualVariablesMixin ../support/arcadeOnDemand ../symbols/CIMSymbol".split(" "),function(V,W,c,L,B,M,k,N,O,q,C,P,Q,e,R,S,T,H,U){var I=N.getLogger("esri.renderers.DictionaryRenderer");return function(m){function b(a){a=m.call(this,a)||this;a._ongoingRequests=
new Map;a._symbolCache=new O(100);a.config=null;a.fieldMap=null;a.scaleExpression=null;a.scaleExpressionTitle=null;a.url=null;a.type="dictionary";return a}c.__extends(b,m);n=b;b.prototype.writeData=function(a,b){a&&(b.scalingExpressionInfo={expression:a,returnType:"number"})};b.prototype.writeVisualVariables=function(a,b,c,d){(null===d||void 0===d?0:d.origin)||m.prototype.writeVisualVariables.call(this,a,b,c,d)};b.prototype.clone=function(){return new n({config:k.clone(this.config),scaleExpression:this.scaleExpression,
scaleExpressionTitle:this.scaleExpressionTitle,fieldMap:k.clone(this.fieldMap),url:k.clone(this.url),visualVariables:k.clone(this.visualVariables)})};b.prototype.getSymbolAsync=function(a,b){return c.__awaiter(this,void 0,void 0,function(){var y,d,f,g,h,p,l,e,r,u,E,J,t,x,D,F,v,z,K,k,w,A,q,m,n,G,B=this;return c.__generator(this,function(c){switch(c.label){case 0:this._dictionaryPromise||(this._dictionaryPromise=this.fetchResources(b)),c.label=1;case 1:return c.trys.push([1,3,,4]),[4,this._dictionaryPromise];
case 2:return y=c.sent(),[3,4];case 3:return d=c.sent(),C.isAbortError(d)?(this._dictionaryPromise=null,[2,null]):[3,4];case 4:f={};if(this.fieldMap)for(g=0,h=this._symbolFields;g<h.length;g++)p=h[g],(l=this.fieldMap[p])&&null!==a.attributes[l]&&void 0!==a.attributes[l]?(e=""+a.attributes[l],f[p]=e):f[p]="";r=y(f,b);if(!r||"string"!==typeof r)return[2,null];u=Q.numericHash(r).toString();if(E=this._symbolCache.get(u))return E.catch(function(){B._symbolCache.pop(u)}),[2,E];J=r.split(";");t=[];x=[];
D=0;for(F=J;D<F.length;D++)if((v=F[D])&&0!==v.length)if(-1!==v.indexOf("po:"))z=v.substr(3).split("|"),3===z.length&&(K=z[0],k=z[1],w=z[2],"DashTemplate"===k?w=w.split(" ").map(function(a){return Number(a)}):"Color"===k?(A=(new L(w)).toRgba(),w=[A[0],A[1],A[2],255*A[3]]):w=Number(w),x.push({primitiveName:K,propertyName:k,value:w}));else if(-1!==v.indexOf("|"))for(q=0,m=v.split("|");q<m.length;q++)n=m[q],this._itemNames.has(n)&&t.push(n);else this._itemNames.has(v)&&t.push(v);G=this._cimPartsToCIMSymbol(t,
x,b);this._symbolCache.put(u,G,1);return[2,G]}})})};b.prototype.collectRequiredFields=function(a,b){return c.__awaiter(this,void 0,void 0,function(){var p,d;return c.__generator(this,function(c){switch(c.label){case 0:return[4,this.collectVVRequiredFields(a,b)];case 1:return c.sent(),this.scaleExpression?[4,R.collectArcadeFieldNames(a,b,this.scaleExpression)]:[3,3];case 2:c.sent(),c.label=3;case 3:p=b.map(function(a){return a.name});for(d in this.fieldMap)0>p.indexOf(this.fieldMap[d])||a.add(this.fieldMap[d]);
return[2]}})})};Object.defineProperty(b.prototype,"arcadeRequired",{get:function(){return!0},enumerable:!1,configurable:!0});b.prototype.fetchResources=function(a){return c.__awaiter(this,void 0,void 0,function(){var b,y,d,f,g,h,e,l,k,r,u,m,n,t,x;return c.__generator(this,function(p){switch(p.label){case 0:if(this._dictionaryPromise)return[2,this._dictionaryPromise];if(!this.url)return I.error("no valid URL!"),[2,void 0];b=q.isSome(a)?a.abortOptions:null;y=B(this.url+"/resources/styles/dictionary-info.json",
c.__assign({responseType:"json",query:{f:"json"}},b));return[4,C.all([y,H.loadArcade()])];case 1:d=p.sent()[0].data;if(!d)throw this._dictionaryPromise=null,new M("esri.renderers.DictionaryRenderer","Bad dictionary data!");f=d.expression;g=d.authoringInfo;this._refSymbolUrlTemplate=this.url+"/"+d.cimRefTemplateUrl;this._itemNames=P.SetFromValues(d.itemsNames);this._symbolFields=g.symbol;h={};if(this.config)for(l in e=this.config,e)h[l]=e[l];k=0;for(r=g.configuration;k<r.length;k++)l=r[k],h.hasOwnProperty(l.name)||
(h[l.name]=l.value);u=[];if(q.isSome(a)&&a.fields&&this.fieldMap)for(m=function(b){var d=n.fieldMap[b],f=a.fields.filter(function(a){return a.name===d});0<f.length&&u.push(c.__assign(c.__assign({},f[0]),{name:b}))},n=this,t=0,x=this._symbolFields;t<x.length;t++)l=x[t],m(l);this._dictionaryPromise=H.createDictionaryExpression(f,q.isSome(a)?a.spatialReference:null,u,h).then(function(a){var b={scale:0};return function(c,d){c=a.repurposeFeature({geometry:null,attributes:c});b.scale=q.isSome(d)?d.scale:
void 0;return a.evaluate({$feature:c,$view:b})}}).catch(function(a){I.error("Creating dictinoary expression failed:",a);return null});return[2,this._dictionaryPromise]}})})};b.prototype.getSymbol=function(){return null};b.prototype.getSymbols=function(){return[]};b.prototype.getAttributeHash=function(){return this.visualVariables&&this.visualVariables.reduce(function(a,b){return a+b.getAttributeHash()},"")};b.prototype.getMeshHash=function(){return this.url+"-"+JSON.stringify(this.fieldMap)};b.prototype.getSymbolFields=
function(){return this._symbolFields};b.prototype._getSymbolPart=function(a,b){return c.__awaiter(this,void 0,void 0,function(){var e,d,f,g;return c.__generator(this,function(h){switch(h.label){case 0:if(this._ongoingRequests.has(a))return[2,this._ongoingRequests.get(a).then(function(a){return a.data})];e=this._refSymbolUrlTemplate.replace(/\{itemName\}/gi,a);d=B(e,c.__assign({responseType:"json",query:{f:"json"}},b));this._ongoingRequests.set(a,d);h.label=1;case 1:return h.trys.push([1,3,,4]),[4,
d];case 2:return f=h.sent(),[2,f.data];case 3:return g=h.sent(),this._ongoingRequests.delete(a),[2,C.reject(g)];case 4:return[2]}})})};b.prototype._combineSymbolParts=function(a,b){var e;if(!a||0===a.length)return null;if(1===a.length)return{type:"CIMSymbolReference",symbol:a[0],primitiveOverrides:b};var d=c.__assign({},a[0]);d.symbolLayers=[];for(var f=0;f<a.length;f++){var g=a[f];(e=d.symbolLayers).unshift.apply(e,g.symbolLayers)}return{type:"CIMSymbolReference",symbol:d,primitiveOverrides:b}};
b.prototype._cimPartsToCIMSymbol=function(a,b,e){return c.__awaiter(this,void 0,void 0,function(){var d,f,g;return c.__generator(this,function(c){switch(c.label){case 0:d=Array(a.length);for(f=0;f<a.length;f++)d[f]=this._getSymbolPart(a[f],e);return[4,C.all(d)];case 1:return g=c.sent(),[2,new U({data:this._combineSymbolParts(g,b)})]}})})};var n;c.__decorate([e.property({type:Object,json:{read:{source:"configuration"},write:{target:"configuration"}}})],b.prototype,"config",void 0);c.__decorate([e.property({type:Object,
json:{write:!0}})],b.prototype,"fieldMap",void 0);c.__decorate([e.property({type:String,json:{read:{source:"scalingExpressionInfo.expression"},write:!0}})],b.prototype,"scaleExpression",void 0);c.__decorate([e.writer("scaleExpression")],b.prototype,"writeData",null);c.__decorate([e.property({type:String,json:{read:{source:"scalingExpressionInfo.title"},write:{target:"scalingExpressionInfo.title",overridePolicy:function(a){return{enabled:!!a&&!!this.scaleExpression}}}}})],b.prototype,"scaleExpressionTitle",
void 0);c.__decorate([e.property({type:String,json:{write:!0}})],b.prototype,"url",void 0);c.__decorate([e.writer("visualVariables")],b.prototype,"writeVisualVariables",null);return b=n=c.__decorate([e.subclass("esri.renderers.DictionaryRenderer")],b)}(T.VisualVariablesMixin(S))});