// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.17/esri/copyright.txt for details.
//>>built
define("require exports tslib ../symbols ../core/jsonMap ../core/lang ../core/Logger ../core/maybe ../core/promiseUtils ../core/accessorSupport/decorators ../core/accessorSupport/ensureType ../layers/support/fieldUtils ./Renderer ./mixins/VisualVariablesMixin ./support/ClassBreakInfo ./support/commonProperties ./support/LegendOptions ../support/arcadeOnDemand".split(" "),function(G,H,d,z,A,k,B,g,u,f,p,q,C,D,l,v,E,w){var m=B.getLogger("esri.renderers.ClassBreaksRenderer"),n=new A.default({esriNormalizeByLog:"log",
esriNormalizeByPercentOfTotal:"percent-of-total",esriNormalizeByField:"field"}),F=p.ensureType(l);return function(x){function b(a){a=x.call(this,a)||this;a.backgroundFillSymbol=null;a.classBreakInfos=null;a.defaultLabel=null;a.defaultSymbol=null;a.field=null;a.isMaxInclusive=!0;a.legendOptions=null;a.normalizationField=null;a.normalizationTotal=null;a.type="class-breaks";a.valueExpression=null;a.valueExpressionTitle=null;a._set("classBreakInfos",[]);return a}d.__extends(b,x);r=b;Object.defineProperty(b.prototype,
"_cache",{get:function(){return{compiledFunc:null}},enumerable:!1,configurable:!0});b.prototype.readClassBreakInfos=function(a,e,c){if(Array.isArray(a)){var b=e.minValue;return a.map(function(a){var e=new l;e.read(a,c);null==e.minValue&&(e.minValue=b);null==e.maxValue&&(e.maxValue=e.minValue);b=e.maxValue;return e})}};b.prototype.writeClassBreakInfos=function(a,e,c,b){a=a.map(function(a){return a.write({},b)});this._areClassBreaksConsecutive()&&a.forEach(function(a){return delete a.classMinValue});
e[c]=a};b.prototype.castField=function(a){return null==a?a:"function"===typeof a?(m.error(".field: field must be a string value"),null):p.ensureString(a)};Object.defineProperty(b.prototype,"minValue",{get:function(){return this.classBreakInfos&&this.classBreakInfos[0]&&this.classBreakInfos[0].minValue||0},enumerable:!1,configurable:!0});Object.defineProperty(b.prototype,"normalizationType",{get:function(){var a=this._get("normalizationType"),e=!!this.normalizationField,c=null!=this.normalizationTotal;
if(e||c)a=e&&"field"||c&&"percent-of-total"||null,e&&c&&m.warn("warning: both normalizationField and normalizationTotal are set!");else if("field"===a||"percent-of-total"===a)a=null;return a},set:function(a){this._set("normalizationType",a)},enumerable:!1,configurable:!0});b.prototype.addClassBreakInfo=function(a,e,c){var b=null,b="number"===typeof a?new l({minValue:a,maxValue:e,symbol:z.ensureType(c)}):F(k.clone(a));this.classBreakInfos.push(b);1===this.classBreakInfos.length&&this.notifyChange("minValue")};
b.prototype.removeClassBreakInfo=function(a,e){for(var c=this.classBreakInfos.length,b=0;b<c;b++){var d=[this.classBreakInfos[b].minValue,this.classBreakInfos[b].maxValue];if(d[0]===a&&d[1]===e){this.classBreakInfos.splice(b,1);break}}};b.prototype.getBreakIndex=function(a,e){this.valueExpression&&(g.isNone(e)||g.isNone(e.arcade))&&m.warn("");return this.valueExpression?this._getBreakIndexForExpression(a,e):this._getBreakIndexForField(a)};b.prototype.getClassBreakInfo=function(a,e){return d.__awaiter(this,
void 0,void 0,function(){var b,y,f,h;return d.__generator(this,function(c){switch(c.label){case 0:b=e;if(!this.valueExpression||!g.isNone(e)&&!g.isNone(e.arcade))return[3,2];y=[d.__assign({},b)];f={};return[4,w.loadArcade()];case 1:b=d.__assign.apply(void 0,y.concat([(f.arcade=c.sent(),f)])),c.label=2;case 2:return h=this.getBreakIndex(a,b),[2,-1!==h?this.classBreakInfos[h]:null]}})})};b.prototype.getSymbol=function(a,e){if(this.valueExpression&&(g.isNone(e)||g.isNone(e.arcade)))m.error("#getSymbol()",
"Please use getSymbolAsync if valueExpression is used");else return a=this.getBreakIndex(a,e),-1<a?this.classBreakInfos[a].symbol:this.defaultSymbol};b.prototype.getSymbolAsync=function(a,e){return d.__awaiter(this,void 0,void 0,function(){var b,f,t,h;return d.__generator(this,function(c){switch(c.label){case 0:b=e;if(!this.valueExpression||!g.isNone(e)&&!g.isNone(e.arcade))return[3,2];f=[d.__assign({},b)];t={};return[4,w.loadArcade()];case 1:b=d.__assign.apply(void 0,f.concat([(t.arcade=c.sent(),
t)])),c.label=2;case 2:return h=this.getBreakIndex(a,b),[2,-1<h?this.classBreakInfos[h].symbol:this.defaultSymbol]}})})};b.prototype.getSymbols=function(){var a=[];this.classBreakInfos.forEach(function(b){b.symbol&&a.push(b.symbol)});this.defaultSymbol&&a.push(this.defaultSymbol);return a};b.prototype.getAttributeHash=function(){return this.visualVariables&&this.visualVariables.reduce(function(a,b){return a+b.getAttributeHash()},"")};b.prototype.getMeshHash=function(){var a=JSON.stringify(this.backgroundFillSymbol),
b=JSON.stringify(this.defaultSymbol),c=this.normalizationField+"."+this.normalizationType+"."+this.normalizationTotal,d=this.classBreakInfos.reduce(function(a,b){return a+b.getMeshHash()},"");return a+"."+b+"."+d+"."+c+"."+this.field+"."+this.valueExpression};Object.defineProperty(b.prototype,"arcadeRequired",{get:function(){return this.arcadeRequiredForVisualVariables||!!this.valueExpression},enumerable:!1,configurable:!0});b.prototype.clone=function(){return new r({field:this.field,backgroundFillSymbol:this.backgroundFillSymbol&&
this.backgroundFillSymbol.clone(),defaultLabel:this.defaultLabel,defaultSymbol:this.defaultSymbol&&this.defaultSymbol.clone(),valueExpression:this.valueExpression,valueExpressionTitle:this.valueExpressionTitle,classBreakInfos:k.clone(this.classBreakInfos),isMaxInclusive:this.isMaxInclusive,normalizationField:this.normalizationField,normalizationTotal:this.normalizationTotal,normalizationType:this.normalizationType,visualVariables:k.clone(this.visualVariables),legendOptions:k.clone(this.legendOptions),
authoringInfo:this.authoringInfo&&this.authoringInfo.clone()})};b.prototype.collectRequiredFields=function(a,b){return d.__awaiter(this,void 0,void 0,function(){var c;return d.__generator(this,function(e){switch(e.label){case 0:return c=[this.collectVVRequiredFields(a,b),this.collectSymbolFields(a,b)],[4,u.all(c)];case 1:return e.sent(),[2]}})})};b.prototype.collectSymbolFields=function(a,b){return d.__awaiter(this,void 0,void 0,function(){var c;return d.__generator(this,function(e){switch(e.label){case 0:return c=
d.__spreadArrays(this.getSymbols().map(function(e){return e.collectRequiredFields(a,b)}),[q.collectArcadeFieldNames(a,b,this.valueExpression)]),q.collectField(a,b,this.field),q.collectField(a,b,this.normalizationField),[4,u.all(c)];case 1:return e.sent(),[2]}})})};b.prototype._getBreakIndexForExpression=function(a,b){var c=g.unwrapOr(b,{});b=c.viewingMode;var e=c.scale,d=c.spatialReference,f=this._cache.compiledFunc,c=g.unwrap(c.arcade).arcadeUtils;f||(f=c.createSyntaxTree(this.valueExpression),f=
c.createFunction(f),this._cache.compiledFunc=f);a=c.executeFunction(f,c.createExecContext(a,c.getViewInfo({viewingMode:b,scale:e,spatialReference:d})));return this._getBreakIndexfromInfos(a)};b.prototype._getBreakIndexForField=function(a){var b=a.attributes;a=this.normalizationType;var c=parseFloat(b[this.field]);if(a){var d=this.normalizationTotal,b=parseFloat(b[this.normalizationField]);if("log"===a)c=Math.log(c)*Math.LOG10E;else if("percent-of-total"===a&&!isNaN(d))c=c/d*100;else if("field"===
a&&!isNaN(b)){if(isNaN(c)||isNaN(b))return-1;c/=b}}return this._getBreakIndexfromInfos(c)};b.prototype._getBreakIndexfromInfos=function(a){var b=this.isMaxInclusive;if(null!=a&&"number"===typeof a&&!isNaN(a))for(var c=0;c<this.classBreakInfos.length;c++){var d=[this.classBreakInfos[c].minValue,this.classBreakInfos[c].maxValue];if(d[0]<=a&&(b?a<=d[1]:a<d[1]))return c}return-1};b.prototype._areClassBreaksConsecutive=function(){for(var a=this.classBreakInfos,b=a.length,c=1;c<b;c++)if(a[c-1].maxValue!==
a[c].minValue)return!1;return!0};var r;d.__decorate([f.property({readOnly:!0,dependsOn:["valueExpression"]})],b.prototype,"_cache",null);d.__decorate([f.property(v.rendererBackgroundFillSymbolProperty)],b.prototype,"backgroundFillSymbol",void 0);d.__decorate([f.property({type:[l]})],b.prototype,"classBreakInfos",void 0);d.__decorate([f.reader("classBreakInfos")],b.prototype,"readClassBreakInfos",null);d.__decorate([f.writer("classBreakInfos")],b.prototype,"writeClassBreakInfos",null);d.__decorate([f.property({type:String,
json:{write:!0}})],b.prototype,"defaultLabel",void 0);d.__decorate([f.property(v.rendererSymbolProperty)],b.prototype,"defaultSymbol",void 0);d.__decorate([f.property({type:String,json:{write:!0}})],b.prototype,"field",void 0);d.__decorate([f.cast("field")],b.prototype,"castField",null);d.__decorate([f.property({type:Boolean})],b.prototype,"isMaxInclusive",void 0);d.__decorate([f.property({type:E.default,json:{write:!0}})],b.prototype,"legendOptions",void 0);d.__decorate([f.property({type:Number,
readOnly:!0,value:null,dependsOn:["classBreakInfos"],json:{read:!1,write:{overridePolicy:function(){return 0!==this.classBreakInfos.length&&this._areClassBreaksConsecutive()?{enabled:!0}:{enabled:!1}}}}})],b.prototype,"minValue",null);d.__decorate([f.property({type:String,json:{write:!0}})],b.prototype,"normalizationField",void 0);d.__decorate([f.property({type:Number,cast:function(a){return p.ensureNumber(a)},json:{write:!0}})],b.prototype,"normalizationTotal",void 0);d.__decorate([f.property({type:n.apiValues,
value:null,dependsOn:["normalizationField","normalizationTotal"],json:{type:n.jsonValues,read:n.read,write:n.write}})],b.prototype,"normalizationType",null);d.__decorate([f.enumeration({classBreaks:"class-breaks"})],b.prototype,"type",void 0);d.__decorate([f.property({type:String,json:{write:!0}})],b.prototype,"valueExpression",void 0);d.__decorate([f.property({type:String,json:{write:!0}})],b.prototype,"valueExpressionTitle",void 0);return b=r=d.__decorate([f.subclass("esri.renderers.ClassBreaksRenderer")],
b)}(D.VisualVariablesMixin(C))});