// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.17/esri/copyright.txt for details.
//>>built
define("require exports tslib ../../rasterRenderers ../../core/colorUtils ../../core/JSONSupport ../../core/Logger ../../core/maybe ../../core/accessorSupport/decorators ../../layers/support/imageryRendererUtils ../../layers/support/RasterInfo ../../layers/support/rasterFunctions/pixelUtils ../../layers/support/rasterFunctions/surfaceUtils ../support/colorRampUtils ./rasterRendererHelper".split(" "),function(G,H,k,v,C,D,E,t,r,w,F,l,u,x,y){var z=E.getLogger("esri.renderers.support.RasterSymbolizer");
return function(A){function h(a){return A.call(this,a)||this}k.__extends(h,A);h.prototype.readRenderer=function(a,b,c){return v.read(a,c)};h.prototype.bind=function(){if(!this.renderer)return!1;this.lookup={rendererJson:{}};var a;switch(this.renderer.type){case "unique-value":a=this._updateUVRenderer(this.renderer);break;case "raster-colormap":a=this._updateColormapRenderer(this.renderer);break;case "raster-stretch":a=this._updateStretchRenderer(this.renderer);break;case "class-breaks":a=this._updateClassBreaksRenderer(this.renderer);
break;case "raster-shaded-relief":a=this._updateShadedReliefRenderer(this.renderer)}return a};h.prototype.symbolize=function(a){var b=a&&a.pixelBlock;if(!this.isValidPixelBlock(b))return b;if(a.simpleStretchParams&&"raster-stretch"===this.renderer.type)return this.simpleStretch(b,a.simpleStretchParams);try{3<b.pixels.length&&(b=l.extractBands(b,[0,1,2]));var c=void 0;switch(this.renderer.type){case "unique-value":case "raster-colormap":c=this._symbolize_colormap(b);break;case "class-breaks":c=this._symbolize_classBreaks(b);
break;case "raster-stretch":c=this._symbolize_stretch(b,a.bandIds);break;case "raster-shaded-relief":var f=a.extent,c=this._symbolize_shadedRelief(b,{isGCS:f.spatialReference.isGeographic,resolution:{x:(f.xmax-f.xmin)/b.width,y:(f.ymax-f.ymin)/b.height}})}return c}catch(e){return z.error("symbolize",e.message),b}};h.prototype.simpleStretch=function(a,b){if(!this.isValidPixelBlock(a))return a;try{return 3<a.pixels.length&&(a=l.extractBands(a,[0,1,2])),l.stretch(a,b)}catch(c){return z.error("symbolize",
c.message),a}};h.prototype.generateWebGLParameters=function(a){if(-1<["unique-value","raster-colormap","class-breaks"].indexOf(this.renderer.type)){var b=this.lookup.colormapLut;return{colormap:b.indexedColormap,colormapOffset:b.offset,type:"lut"}}var b=a.pixelBlock,c=a.isGCS,f=a.resolution;a=a.bandIds;return"raster-stretch"===this.renderer.type?this.generateStretchWebGLParams(b,this.renderer,a):"raster-shaded-relief"===this.renderer.type?this.generateShadedReliefWebGLParams(this.renderer,c,f):null};
h.prototype._isLUTChanged=function(a){if(!this.lookup||!this.lookup.rendererJson)return!0;if("colorRamp"in this.renderer){var b=this.renderer.colorRamp;if(a)return JSON.stringify(b.toJSON())!==JSON.stringify(this.lookup.rendererJson.colorRamp);a=k.__assign({},this.renderer.toJSON());b=k.__assign({},this.lookup.rendererJson);a.colorRamp=null;b.colorRamp=null}return JSON.stringify(this.renderer.toJSON())!==JSON.stringify(this.lookup.rendererJson)};h.prototype._symbolize_colormap=function(a){return this._isLUTChanged()&&
!this.bind()?a:l.colorize(a,this.lookup.colormapLut)};h.prototype._symbolize_classBreaks=function(a){var b=-1<["u8","u16","s8","s16"].indexOf(this.rasterInfo.pixelType);return this._isLUTChanged()&&!this.bind()?a:b?l.colorize(a,this.lookup.colormapLut):l.remapColor(a,this.lookup.remapLut)};h.prototype._symbolize_stretch=function(a,b){var c=this.rasterInfo,f=c.pixelType,e=c.bandCount,c=this.renderer,g=-1<["u8","u16","s8","s16"].indexOf(f),d,p=c.gamma,B=c.useGamma;if(g){if(c.dynamicRangeAdjustment)g=
this.getStretchCutoff(c,a,b),d=l.createStretchLUT(k.__assign(k.__assign({pixelType:f},g),{gamma:B?p:null}));else{if(this._isLUTChanged()&&(f=this.bind(),!f))return a;d=this.lookup?this.lookup.stretchLut:null}if(!d)return a;1<e&&(null===b||void 0===b?void 0:b.length)===a.pixels.length&&(null===d||void 0===d?void 0:d.lut.length)===e&&(d={lut:b.map(function(a){return d.lut[a]}),offset:d.offset});b=l.lookupPixels(a,d)}else g=this.getStretchCutoff(c,a,b),b=l.stretch(a,k.__assign(k.__assign({},g),{gamma:B?
p:null}));if(c.colorRamp){if(this._isLUTChanged(!0)&&(f=this.bind(),!f))return a;b=l.colorize(b,this.lookup.colormapLut)}return b};h.prototype._symbolize_shadedRelief=function(a,b){var c,f,e=this.renderer;b=k.__assign(k.__assign({},e.toJSON()),b);b=u.hillshade(a,b);if(!e.colorRamp||this._isLUTChanged(!0)&&!this.bind())return b;e=this.lookup?this.lookup.hsvMap:null;if(!e)return b;var g=null!==(f=null===(c=t.unwrap(this.rasterInfo.statistics))||void 0===c?void 0:c[0])&&void 0!==f?f:{min:0,max:8E3};
u.tintHillshade(b,a,e,g);return b};h.prototype._updateUVRenderer=function(a){var b=this.rasterInfo,c=b.bandCount,f=b.attributeTable,e=b.statistics,g=a.field;if(!g)return!1;b=-1<["u8","s8"].indexOf(b.pixelType)&&e&&null!=e[0].min&&null!=e[0].max;if(!(y.isUVRendererSupported(this.rasterInfo,g)||1===c&&b))return!1;var d=[];if(f){var p=f.fields.filter(function(a){return"value"===a.name.toLowerCase()})[0];if(!p)return!1;f.features.forEach(function(b){var c=a.uniqueValueInfos.filter(function(a){return String(a.value)===
String(b.attributes[g])})[0];(c=c&&c.symbol&&c.symbol.color)&&d.push([b.attributes[p.name],c.r,c.g,c.b,1<c.a?c.a:Math.round(255*c.a)])})}else{if("value"!==g.toLowerCase())return!1;a.uniqueValueInfos.forEach(function(a){var b=a&&a.symbol&&a.symbol.color;b&&d.push([parseInt(""+a.value,10),b.r,b.g,b.b,1<b.a?b.a:Math.round(255*b.a)])})}if(0===d.length)return!1;c=l.createColormapLUT({colormap:d});this.lookup={rendererJson:a.toJSON(),colormapLut:c};return this.canRenderInWebGL=!0};h.prototype._updateColormapRenderer=
function(a){var b=a.extractColormap();if(!b||0===b.length)return!1;b=l.createColormapLUT({colormap:b});this.lookup={rendererJson:a.toJSON(),colormapLut:b};return this.canRenderInWebGL=!0};h.prototype._updateShadedReliefRenderer=function(a){if(!y.isShadedReliefRendererSupported(this.rasterInfo))return!1;if(a.colorRamp){for(var b=x.convertColorRampToColormap(a.colorRamp,256,!0),b=l.createColormapLUT({colormap:b}),c=[],f=b.indexedColormap,e=0;e<f.length;e+=4){var g=C.toHSV({r:f[e],g:f[e+1],b:f[e+2]});
c.push([g.h/60,g.s/100,255*g.v/100])}this.lookup={rendererJson:a.toJSON(),colormapLut:b,hsvMap:c}}else this.lookup=null;return this.canRenderInWebGL=!0};h.prototype._updateClassBreaksRenderer=function(a){var b=-1<["u8","u16","s8","s16"].indexOf(this.rasterInfo.pixelType),c=a.classBreakInfos;if(!c||0===c.length)return!1;var f=c.sort(function(a,b){return a.minValue-b.minValue}),c=f[f.length-1];if(!b)return b=f.map(function(a){return{value:a.minValue,mappedColor:[a.symbol.color.r,a.symbol.color.g,a.symbol.color.b,
1<a.symbol.color.a?a.symbol.color.a:Math.round(255*a.symbol.color.a)]}}),b.push({value:c.maxValue,mappedColor:[c.symbol.color.g,c.symbol.color.b,1<c.symbol.color.a?c.symbol.color.a:Math.round(255*c.symbol.color.a)]}),this.lookup={rendererJson:a.toJSON(),remapLut:b},this.canRenderInWebGL=!1,!0;var e=[],g,d=0;f.forEach(function(a){g=Math.ceil(a.minValue);d=Math.floor(a.maxValue);for(var b=g;b<d;b++)e.push([b,a.symbol.color.r,a.symbol.color.g,a.symbol.color.b,1<a.symbol.color.a?a.symbol.color.a:Math.round(255*
a.symbol.color.a)])});e.push([c.maxValue,c.symbol.color.r,c.symbol.color.g,c.symbol.color.b,1<c.symbol.color.a?c.symbol.color.a:Math.round(255*c.symbol.color.a)]);b=l.createColormapLUT({colormap:e,fillUnspecified:!1});this.lookup={rendererJson:a.toJSON(),colormapLut:b};return this.canRenderInWebGL=!0};h.prototype._updateStretchRenderer=function(a){if(!(a.statistics||this.rasterInfo.statistics||a.dynamicRangeAdjustment))return!1;var b=a.histograms||this.rasterInfo.histograms;if(!a.dynamicRangeAdjustment&&
"percent-clip"===a.stretchType&&!b)return!1;var c=a.gamma,f=a.useGamma,b=a.colorRamp,e=this.rasterInfo.pixelType;if(!a.dynamicRangeAdjustment&&-1<["u8","u16","s8","s16"].indexOf(e)){var g=this.getStretchCutoff(a),c=l.createStretchLUT(k.__assign(k.__assign({pixelType:e},g),{gamma:f?c:null}));this.lookup={rendererJson:a.toJSON(),stretchLut:c}}b&&(b=x.convertColorRampToColormap(b,256,!0),this.lookup||(this.lookup={rendererJson:a.toJSON()}),this.lookup.colormapLut=l.createColormapLUT({colormap:b}),this.lookup.rendererJson=
a.toJSON());return this.canRenderInWebGL=!0};h.prototype.getStretchCutoff=function(a,b,c){var f,e,g,d=a.stretchType;a.dynamicRangeAdjustment?"min-max"===d&&b.statistics?e=b.statistics.map(function(a){return[a.minValue,a.maxValue,0,0]}):(g=l.estimateStatisticsHistograms(b),e=g.statistics,g=g.histograms):(e=0<(null===(f=a.statistics)||void 0===f?void 0:f.length)?a.statistics:t.unwrap(this.rasterInfo.statistics),g=a.histograms||t.unwrap(this.rasterInfo.histograms));var p=e||g?(e||g).length:this.rasterInfo.bandCount;
f=[];b=[];var h,k,q,m,n;e&&!Array.isArray(e[0])&&(e=e.map(function(a){return[a.min,a.max,a.avg,a.stddev]}));switch(d){case "none":g=w.pixelTypeRanges[this.rasterInfo.pixelType]||w.pixelTypeRanges.f32;for(d=0;d<p;d++)f[d]=g[0],b[d]=g[1];break;case "min-max":for(d=0;d<p;d++)f[d]=e[d][0],b[d]=e[d][1];break;case "standard-deviation":for(d=0;d<p;d++)f[d]=e[d][2]-a.numberOfStandardDeviations*e[d][3],b[d]=e[d][2]+a.numberOfStandardDeviations*e[d][3],f[d]<e[d][0]&&(f[d]=e[d][0]),b[d]>e[d][1]&&(b[d]=e[d][1]);
break;case "percent-clip":for(d=0;d<g.length;d++){e=g[d];q=new Uint32Array(e.size);k=e.counts;h=0;p=(e.max-e.min)/e.size;m=-.5===e.min&&1===p?.5:0;for(n=0;n<e.size;n++)h+=k[n],q[n]=h;k=a.minPercent*h/100;for(n=0;n<e.size;n++)if(q[n]>k){f[d]=e.min+p*(n+m);break}k=(1-a.maxPercent/100)*h;for(n=e.size-2;0<=n;n--)if(q[n]<k){b[d]=e.min+p*(n+2-m);break}}break;default:for(d=0;d<p;d++)f[d]=e[d][0],b[d]=e[d][1]}return this.getSelectedBandCutoffs({minCutOff:f,maxCutOff:b,outMax:a.outputMax||255,outMin:a.outputMin||
0},c)};h.prototype.getSelectedBandCutoffs=function(a,b){if(null==b||0===b.length)return a;var c=Math.max.apply(null,b),f=a.minCutOff,e=a.maxCutOff,g=a.outMin,d=a.outMax;return f.length===b.length||f.length<=c?a:{minCutOff:b.map(function(a){return f[a]}),maxCutOff:b.map(function(a){return e[a]}),outMin:g,outMax:d}};h.prototype.generateStretchWebGLParams=function(a,b,c){var f=null,e=null,g=this.lookup&&this.lookup.colormapLut;b.colorRamp&&g&&(f=g.indexedColormap,e=g.offset);var g=b.gamma,d=!!(b.useGamma&&
g&&g.some(function(a){return 1!==a})),h=this.getStretchCutoff(b,a,c);b=h.minCutOff;var k=h.maxCutOff,l=h.outMin,h=h.outMax;a&&a.pixels&&2===a.pixels.length&&(a=a.clone(),a.statistics=[a.statistics[0]],a.pixels=[a.pixels[0]]);a=Math.min(3,c&&c.length||a&&a.getPlaneCount()||this.rasterInfo.bandCount);c=new Float32Array(a);var q=f||d?1:255,m;for(m=0;m<a;m++)c[m]=(h-l)/(k[m]-b[m])/q;var n=new Float32Array(a);if(d)for(m=0;m<a;m++)n[m]=1<g[m]?2<g[m]?6.5+Math.pow(g[m]-2,2.5):6.5+100*Math.pow(2-g[m],4):1;
return{bandCount:a,outMin:l/q,outMax:h/q,minCutOff:b,maxCutOff:k,factor:c,useGamma:d,gamma:d?g:[1,1,1],gammaCorrection:d?n:[1,1,1],colormap:f,colormapOffset:e,type:"stretch"}};h.prototype.generateShadedReliefWebGLParams=function(a,b,c){var f,e,g,d=null,h=null,l=this.lookup&&this.lookup.colormapLut;a.colorRamp&&l&&(d=l.indexedColormap,h=l.offset);b=k.__assign(k.__assign({},a.toJSON()),{isGCS:b,resolution:c});b=u.calculateHillshadeParams(b);c=null===(f=t.unwrap(this.rasterInfo.statistics))||void 0===
f?void 0:f[0];return k.__assign(k.__assign({},b),{minValue:null!==(e=c.min)&&void 0!==e?e:0,maxValue:null!==(g=c.max)&&void 0!==g?g:8E3,hillshadeType:"traditional"===a.hillshadeType?0:1,type:"hillshade",colormap:d,colormapOffset:h})};h.prototype.isValidPixelBlock=function(a){return!!(a&&a.pixels&&0<a.pixels.length&&0!==a.validPixelCount)};k.__decorate([r.property({types:v.rasterRendererTypes,json:{write:!0}})],h.prototype,"renderer",void 0);k.__decorate([r.reader("renderer")],h.prototype,"readRenderer",
null);k.__decorate([r.property({type:F,json:{write:!0}})],h.prototype,"rasterInfo",void 0);k.__decorate([r.property({json:{write:!0}})],h.prototype,"lookup",void 0);k.__decorate([r.property({})],h.prototype,"canRenderInWebGL",void 0);return h=k.__decorate([r.subclass("esri.renderers.support.RasterSymbolizer")],h)}(D.JSONSupport)});