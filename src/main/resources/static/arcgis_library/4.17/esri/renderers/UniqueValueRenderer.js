// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.17/esri/copyright.txt for details.
//>>built
define("require exports tslib ../symbols ../symbols ../core/arrayUtils ../core/Error ../core/lang ../core/Logger ../core/maybe ../core/object ../core/promiseUtils ../core/accessorSupport/decorators ../core/accessorSupport/diffUtils ../core/accessorSupport/ensureType ../layers/support/fieldUtils ../portal/Portal ./Renderer ./mixins/VisualVariablesMixin ./support/commonProperties ./support/LegendOptions ./support/UniqueValueInfo ../support/arcadeOnDemand ../support/persistableUrlUtils ../symbols/support/styleUtils".split(" "),
function(L,M,d,A,B,t,C,m,D,g,E,u,e,F,v,p,r,G,H,w,I,q,x,y,J){var l=D.getLogger("esri.renderers.UniqueValueRenderer"),K=v.ensureType(q);return function(z){function b(a){a=z.call(this,a)||this;a._valueInfoMap={};a._isDefaultSymbolDerived=!1;a.type="unique-value";a.backgroundFillSymbol=null;a.field=null;a.field2=null;a.field3=null;a.valueExpression=null;a.valueExpressionTitle=null;a.legendOptions=null;a.defaultLabel=null;a.fieldDelimiter=null;a.portal=null;a.styleOrigin=null;a.diff={uniqueValueInfos:function(a,
f){if(a||f){if(!a||!f)return{type:"complete",oldValue:a,newValue:f};for(var c=!1,b={type:"collection",added:[],removed:[],changed:[],unchanged:[]},d=function(d){var h=t.find(a,function(a){return a.value===f[d].value});h?F.diff(h,f[d])?(b.changed.push({type:"complete",oldValue:h,newValue:f[d]}),c=!0):b.unchanged.push({oldValue:h,newValue:f[d]}):(b.added.push(f[d]),c=!0)},e=0;e<f.length;e++)d(e);d=function(d){t.find(f,function(c){return c.value===a[d].value})||(b.removed.push(a[d]),c=!0)};for(e=0;e<
a.length;e++)d(e);return c?b:void 0}}};a._set("uniqueValueInfos",[]);return a}d.__extends(b,z);n=b;Object.defineProperty(b.prototype,"_cache",{get:function(){return{compiledFunc:null}},enumerable:!1,configurable:!0});b.prototype.castField=function(a){return null==a||"function"===typeof a?a:v.ensureString(a)};b.prototype.writeField=function(a,c,f,b){"string"===typeof a?c[f]=a:b&&b.messages?b.messages.push(new C("property:unsupported","UniqueValueRenderer.field set to a function cannot be written to JSON")):
l.error(".field: cannot write field to JSON since it's not a string value")};Object.defineProperty(b.prototype,"defaultSymbol",{set:function(a){this._isDefaultSymbolDerived=!1;this._set("defaultSymbol",a)},enumerable:!1,configurable:!0});b.prototype.readPortal=function(a,c,f){return f.portal||r.getDefault()};b.prototype.readStyleOrigin=function(a,c,f){if(c.styleName)return Object.freeze({styleName:c.styleName});if(c.styleUrl)return a=y.fromJSON(c.styleUrl,f),Object.freeze({styleUrl:a})};b.prototype.writeStyleOrigin=
function(a,c,f,b){a.styleName?c.styleName=a.styleName:a.styleUrl&&(c.styleUrl=y.toJSON(a.styleUrl,b))};Object.defineProperty(b.prototype,"uniqueValueInfos",{set:function(a){this.styleOrigin?l.error("#uniqueValueInfos\x3d","Cannot modify unique value infos of a UniqueValueRenderer created from a web style"):(this._set("uniqueValueInfos",a),this._updateValueInfoMap())},enumerable:!1,configurable:!0});b.prototype.addUniqueValueInfo=function(a,c){this.styleOrigin?l.error("#addUniqueValueInfo()","Cannot modify unique value infos of a UniqueValueRenderer created from a web style"):
(a="object"===typeof a?K(a):new q({value:a,symbol:B.ensureType(c)}),this.uniqueValueInfos.push(a),this._valueInfoMap[a.value]=a)};b.prototype.removeUniqueValueInfo=function(a){if(this.styleOrigin)l.error("#removeUniqueValueInfo()","Cannot modify unique value infos of a UniqueValueRenderer created from a web style");else for(var c=0;c<this.uniqueValueInfos.length;c++)if(this.uniqueValueInfos[c].value===a+""){delete this._valueInfoMap[a];this.uniqueValueInfos.splice(c,1);break}};b.prototype.getUniqueValueInfo=
function(a,c){return d.__awaiter(this,void 0,void 0,function(){var f,b,e;return d.__generator(this,function(h){switch(h.label){case 0:f=c;if(!this.valueExpression||!g.isNone(c)&&!g.isNone(c.arcade))return[3,2];b=[d.__assign({},f)];e={};return[4,x.loadArcade()];case 1:f=d.__assign.apply(void 0,b.concat([(e.arcade=h.sent(),e)])),h.label=2;case 2:return[2,this._getUniqueValueInfo(a,f)]}})})};b.prototype.getSymbol=function(a,c){if(this.valueExpression&&(g.isNone(c)||g.isNone(c.arcade)))l.error("#getSymbol()",
"Please use getSymbolAsync if valueExpression is used");else return(a=this._getUniqueValueInfo(a,c))&&a.symbol||this.defaultSymbol};b.prototype.getSymbolAsync=function(a,c){return d.__awaiter(this,void 0,void 0,function(){var b,h,e,k;return d.__generator(this,function(f){switch(f.label){case 0:b=c;if(!this.valueExpression||!g.isNone(b)&&!g.isNone(b.arcade))return[3,2];h=[d.__assign({},b)];e={};return[4,x.loadArcade()];case 1:b=d.__assign.apply(void 0,h.concat([(e.arcade=f.sent(),e)])),f.label=2;case 2:return k=
this._getUniqueValueInfo(a,b),[2,k&&k.symbol||this.defaultSymbol]}})})};b.prototype.getSymbols=function(){for(var a=[],c=0,b=this.uniqueValueInfos;c<b.length;c++){var d=b[c];d.symbol&&a.push(d.symbol)}this.defaultSymbol&&a.push(this.defaultSymbol);return a};b.prototype.getAttributeHash=function(){return this.visualVariables&&this.visualVariables.reduce(function(a,c){return a+c.getAttributeHash()},"")};b.prototype.getMeshHash=function(){var a=JSON.stringify(this.backgroundFillSymbol),c=JSON.stringify(this.defaultSymbol),
b=this.uniqueValueInfos.reduce(function(a,c){return a+c.getMeshHash()},"");return a+"."+c+"."+b+"."+(this.field+"."+this.field2+"."+this.field3+"."+this.fieldDelimiter)+"."+this.valueExpression};b.prototype.clone=function(){var a=new n({field:this.field,field2:this.field2,field3:this.field3,defaultLabel:this.defaultLabel,defaultSymbol:m.clone(this.defaultSymbol),valueExpression:this.valueExpression,valueExpressionTitle:this.valueExpressionTitle,fieldDelimiter:this.fieldDelimiter,visualVariables:m.clone(this.visualVariables),
legendOptions:m.clone(this.legendOptions),authoringInfo:this.authoringInfo&&this.authoringInfo.clone(),backgroundFillSymbol:m.clone(this.backgroundFillSymbol)});this._isDefaultSymbolDerived&&(a._isDefaultSymbolDerived=!0);a._set("portal",this.portal);var c=m.clone(this.uniqueValueInfos);this.styleOrigin&&(a._set("styleOrigin",Object.freeze(m.clone(this.styleOrigin))),Object.freeze(c));a._set("uniqueValueInfos",c);a._updateValueInfoMap();return a};Object.defineProperty(b.prototype,"arcadeRequired",
{get:function(){return this.arcadeRequiredForVisualVariables||!!this.valueExpression},enumerable:!1,configurable:!0});b.prototype.collectRequiredFields=function(a,c){return d.__awaiter(this,void 0,void 0,function(){var b;return d.__generator(this,function(f){switch(f.label){case 0:return b=[this.collectVVRequiredFields(a,c),this.collectSymbolFields(a,c)],[4,u.all(b)];case 1:return f.sent(),[2]}})})};b.prototype.collectSymbolFields=function(a,c){return d.__awaiter(this,void 0,void 0,function(){var b;
return d.__generator(this,function(f){switch(f.label){case 0:return b=d.__spreadArrays(this.getSymbols().map(function(b){return b.collectRequiredFields(a,c)}),[p.collectArcadeFieldNames(a,c,this.valueExpression)]),p.collectField(a,c,this.field),p.collectField(a,c,this.field2),p.collectField(a,c,this.field3),[4,u.all(b)];case 1:return f.sent(),[2]}})})};b.prototype.populateFromStyle=function(){var a=this;return J.fetchStyle(this.styleOrigin,{portal:this.portal}).then(function(c){var b=[];a._valueInfoMap=
{};c&&c.data&&Array.isArray(c.data.items)&&c.data.items.forEach(function(f){var d=new A.WebStyleSymbol({styleUrl:c.styleUrl,styleName:c.styleName,portal:a.portal,name:f.name});a.defaultSymbol||f.name!==c.data.defaultItem||(a.defaultSymbol=d,a._isDefaultSymbolDerived=!0);d=new q({value:f.name,symbol:d});b.push(d);a._valueInfoMap[f.name]=d});a._set("uniqueValueInfos",Object.freeze(b));!a.defaultSymbol&&a.uniqueValueInfos.length&&(a.defaultSymbol=a.uniqueValueInfos[0].symbol,a._isDefaultSymbolDerived=
!0);return a})};b.prototype._updateValueInfoMap=function(){var a=this;this._valueInfoMap={};this.uniqueValueInfos.forEach(function(c){return a._valueInfoMap[c.value+""]=c})};b.prototype._getUniqueValueInfo=function(a,c){return this.valueExpression?this._getUnqiueValueInfoForExpression(a,c):this._getUnqiueValueInfoForFields(a)};b.prototype._getUnqiueValueInfoForExpression=function(a,c){var b=g.unwrapOr(c,{});c=b.viewingMode;var d=b.scale,e=b.spatialReference,k=this._cache.compiledFunc,b=g.unwrap(b.arcade).arcadeUtils;
k||(k=b.createSyntaxTree(this.valueExpression),k=b.createFunction(k),this._cache.compiledFunc=k);a=b.executeFunction(k,b.createExecContext(a,b.getViewInfo({viewingMode:c,scale:d,spatialReference:e})));return this._valueInfoMap[a+""]};b.prototype._getUnqiueValueInfoForFields=function(a){var b=this.field,d=a.attributes,e;if("function"!==typeof b&&this.field2){a=this.field2;e=this.field3;var g=[];b&&g.push(d[b]);a&&g.push(d[a]);e&&g.push(d[e]);e=g.join(this.fieldDelimiter||"")}else"function"===typeof b?
e=b(a):b&&(e=d[b]);return this._valueInfoMap[e+""]};b.fromPortalStyle=function(a,b){var c=new n(b&&b.properties);c._set("styleOrigin",Object.freeze({styleName:a}));c._set("portal",b&&b.portal||r.getDefault());b=c.populateFromStyle();b.catch(function(b){l.error("#fromPortalStyle('"+a+"'[, ...])","Failed to create unique value renderer from style name",b)});return b};b.fromStyleUrl=function(a,b){b=new n(b&&b.properties);b._set("styleOrigin",Object.freeze({styleUrl:a}));b=b.populateFromStyle();b.catch(function(b){l.error("#fromStyleUrl('"+
a+"'[, ...])","Failed to create unique value renderer from style URL",b)});return b};var n;d.__decorate([e.property({readOnly:!0,dependsOn:["valueExpression"]})],b.prototype,"_cache",null);d.__decorate([e.enumeration({uniqueValue:"unique-value"})],b.prototype,"type",void 0);d.__decorate([e.property(w.rendererBackgroundFillSymbolProperty)],b.prototype,"backgroundFillSymbol",void 0);d.__decorate([e.property({json:{type:String,read:{source:"field1"},write:{target:"field1"}}})],b.prototype,"field",void 0);
d.__decorate([e.cast("field")],b.prototype,"castField",null);d.__decorate([e.writer("field")],b.prototype,"writeField",null);d.__decorate([e.property({type:String,json:{write:!0}})],b.prototype,"field2",void 0);d.__decorate([e.property({type:String,json:{write:!0}})],b.prototype,"field3",void 0);d.__decorate([e.property({type:String,json:{write:!0}})],b.prototype,"valueExpression",void 0);d.__decorate([e.property({type:String,json:{write:!0}})],b.prototype,"valueExpressionTitle",void 0);d.__decorate([e.property({type:I.default,
json:{write:!0}})],b.prototype,"legendOptions",void 0);d.__decorate([e.property({type:String,json:{write:!0}})],b.prototype,"defaultLabel",void 0);d.__decorate([e.property(E.deepMerge(d.__assign({},w.rendererSymbolProperty),{json:{write:{overridePolicy:function(){return{enabled:!this._isDefaultSymbolDerived}}},origins:{"web-scene":{write:{overridePolicy:function(){return{enabled:!this._isDefaultSymbolDerived}}}}}}}))],b.prototype,"defaultSymbol",null);d.__decorate([e.property({type:String,json:{write:!0}})],
b.prototype,"fieldDelimiter",void 0);d.__decorate([e.property({type:r,readOnly:!0})],b.prototype,"portal",void 0);d.__decorate([e.reader("portal",["styleName"])],b.prototype,"readPortal",null);d.__decorate([e.property({readOnly:!0,json:{write:{enabled:!1,overridePolicy:function(){return{enabled:!0}}}}})],b.prototype,"styleOrigin",void 0);d.__decorate([e.reader("styleOrigin",["styleName","styleUrl"])],b.prototype,"readStyleOrigin",null);d.__decorate([e.writer("styleOrigin",{styleName:{type:String},
styleUrl:{type:String}})],b.prototype,"writeStyleOrigin",null);d.__decorate([e.property({type:[q],json:{write:{overridePolicy:function(){return this.styleOrigin?{enabled:!1}:{enabled:!0}}}}})],b.prototype,"uniqueValueInfos",null);return b=n=d.__decorate([e.subclass("esri.renderers.UniqueValueRenderer")],b)}(H.VisualVariablesMixin(G))});