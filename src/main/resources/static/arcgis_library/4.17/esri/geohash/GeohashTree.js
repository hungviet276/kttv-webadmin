// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.17/esri/copyright.txt for details.
//>>built
define(["require","exports","../core/CircularArray","../core/maybe","./geohashUtils"],function(E,x,G,w,H){Object.defineProperty(x,"__esModule",{value:!0});x.GeohashTree=void 0;E=function(){function d(g,b,e){void 0===e&&(e=8096);this._nodes=0;this._root=new F(0,0,0);this._fields=g;this._statisticFields=b;this._pool=e?new G.default(8096):null}d.prototype._acquire=function(g,b,e){this._nodes++;var h=null;w.isSome(this._pool)&&(h=this._pool.dequeue());return w.isSome(h)?h.realloc(g,b,e):new F(g,b,e)};
d.prototype._release=function(g){this._nodes--;w.isSome(this._pool)&&this._pool.enqueue(g)};Object.defineProperty(d.prototype,"count",{get:function(){return this._root.count},enumerable:!1,configurable:!0});Object.defineProperty(d.prototype,"size",{get:function(){return this._nodes},enumerable:!1,configurable:!0});Object.defineProperty(d.prototype,"poolSize",{get:function(){return w.mapOr(this._pool,0,function(g){return g.size})},enumerable:!1,configurable:!0});Object.defineProperty(d.prototype,"depth",
{get:function(){var g=0;this._forEachNode(function(b){return g=Math.max(g,b.depth)});return g},enumerable:!1,configurable:!0});d.prototype.dropLevels=function(g){var b=this;this._forEachNode(function(e){if(e.depth>=g)for(var h=0;h<e.children.length;h++){var n=e.children[h];e.children[h]=null;n&&b._release(n)}})};d.prototype.clear=function(){this.dropLevels(0)};d.prototype.insert=function(g,b,e){void 0===e&&(e=0);for(var h=this._root,n=0,c=0,a=0;null!==h;){h.depth>=e&&(h.count+=1,h.xTotal+=g.geometry.coords[0],
h.yTotal+=g.geometry.coords[1],h.xGeohashTotal+=g.geohashX,h.yGeohashTotal+=g.geohashY,h.displayId=g.displayId,this._updateStatistics(g,h,1));if(n>=b)break;var f=Math.ceil((n+1)/2),k=Math.floor((n+1)/2),l=1-n%2,m=30-(3*f+2*k),f=30-(2*f+3*k),m=(g.geohashX&7*l+3*(1-l)<<m)>>m,f=(g.geohashY&3*l+7*(1-l)<<f)>>f,k=m+f*(8*l+4*(1-l)),q=2*l+3*(1-l),c=c<<3*l+2*(1-l)|m,a=a<<q|f;null==h.children[k]&&(h.children[k]=this._acquire(c,a,n+1));n+=1;h=h.children[k]}};d.prototype.insertCursor=function(g,b,e,h,n,c,a,f){void 0===
f&&(f=0);for(var k=this._root,l=0,m=0,q=0;null!==k;){k.depth>=f&&(k.count+=1,k.xTotal+=e,k.yTotal+=h,k.xGeohashTotal+=n,k.yGeohashTotal+=c,k.displayId=b,this._updateStatisticsCursor(g,k,1));if(l>=a)break;var d=Math.ceil((l+1)/2),t=Math.floor((l+1)/2),p=1-l%2,r=30-(3*d+2*t),d=30-(2*d+3*t),r=(n&7*p+3*(1-p)<<r)>>r,d=(c&3*p+7*(1-p)<<d)>>d,t=r+d*(8*p+4*(1-p)),v=2*p+3*(1-p),m=m<<3*p+2*(1-p)|r,q=q<<v|d;null==k.children[t]&&(k.children[t]=this._acquire(m,q,l+1));l+=1;k=k.children[t]}};d.prototype.remove=
function(g,b){for(var e=this._root,h=0;null!==e;){--e.count;e.xTotal-=g.geometry.coords[0];e.yTotal-=g.geometry.coords[1];e.xGeohashTotal-=g.geohashX;e.yGeohashTotal-=g.geohashY;this._updateStatistics(g,e,-1);if(h>=b)break;var n=Math.ceil((h+1)/2),c=Math.floor((h+1)/2),a=1-h%2,f=30-(3*n+2*c),n=30-(2*n+3*c),a=((g.geohashX&7*a+3*(1-a)<<f)>>f)+((g.geohashY&3*a+7*(1-a)<<n)>>n)*(8*a+4*(1-a)),f=e.children[a];1===f.count&&(this._release(f),e.children[a]=null);h+=1;e=f}};d.prototype.removeCursor=function(g,
b,e,h,n,c){for(var a=this._root,f=0;null!==a;){--a.count;a.xTotal-=b;a.yTotal-=e;a.xGeohashTotal-=h;a.yGeohashTotal-=n;this._updateStatisticsCursor(g,a,-1);if(f>=c)break;var k=Math.ceil((f+1)/2),l=Math.floor((f+1)/2),m=1-f%2,q=30-(3*k+2*l),k=30-(2*k+3*l),m=((h&7*m+3*(1-m)<<q)>>q)+((n&3*m+7*(1-m)<<k)>>k)*(8*m+4*(1-m)),q=a.children[m];1===q.count&&(this._release(q),a.children[m]=null);f+=1;a=q}};d.prototype.find=function(g,b,e){return this._root.find(g,b,e,0,0,0)};d.prototype.findSingleOccupancyNode=
function(g,b,e,h,n){for(var c=this._root;null!==c;){var a=c.depth,f=c.xNode,k=c.yNode,l=1-a%2,m=c.xGeohashTotal/c.count,q=c.yGeohashTotal/c.count;if(1===c.count&&g<m&&m<=e&&b<q&&q<=h)return c;if(a>=n)c=c.next;else{for(var m=Math.ceil((a+1)/2),a=Math.floor((a+1)/2),d=30-(3*m+2*a),m=30-(2*m+3*a),t=~((1<<d)-1),q=~((1<<m)-1),f=f<<3*l+2*(1-l),k=k<<2*l+3*(1-l),a=Math.max(f,(g&t)>>d),d=Math.min(f+8*l+4*(1-l),(e&t)>>d),t=Math.min(k+4*l+8*(1-l),(h&q)>>m),p=null,r=null,m=Math.max(k,(b&q)>>m);m<=t;m++)for(q=
a;q<=d;q++){var v=c.children[q-f+(m-k)*(8*l+4*(1-l))];v&&(p||(p=v,p.next=c.next),r&&(r.next=v),r=v,v.next=c.next)}c=p||c.next}}return null};d.prototype.getRegionStatistics=function(g,b,e,h,n){for(var c=this._root,a=0,f=0,k=0,l={},m=0;null!==c;){var d=c.depth,z=c.xNode,t=c.yNode;if(d>=n){var p=c.xGeohashTotal/c.count,r=c.yGeohashTotal/c.count;g<p&&p<=e&&b<r&&r<=h&&(a+=c.count,f+=c.xTotal,k+=c.yTotal,1===c.count&&(m=c.displayId),this._aggregateStatistics(l,c.statistics));c=c.next}else{for(var v=Math.ceil((d+
1)/2),A=Math.floor((d+1)/2),d=1-d%2,y=30-(3*v+2*A),p=30-(2*v+3*A),B=~((1<<y)-1),r=~((1<<p)-1),z=z<<3*d+2*(1-d),t=t<<2*d+3*(1-d),v=Math.max(z,(g&B)>>y),A=Math.max(t,(b&r)>>p),y=Math.min(z+8*d+4*(1-d),(e&B)>>y),B=Math.min(t+4*d+8*(1-d),(h&r)>>p),w=null,x=null,C=A;C<=B;C++)for(var D=v;D<=y;D++){var u=c.children[D-z+(C-t)*(8*d+4*(1-d))];u&&(C!==A&&C!==B&&D!==v&&D!==y?(p=u.xGeohashTotal/u.count,r=u.yGeohashTotal/u.count,g<p&&p<=e&&b<r&&r<=h&&(a+=u.count,f+=u.xTotal,k+=u.yTotal,1===u.count&&(m=u.displayId),
this._aggregateStatistics(l,u.statistics))):(w||(w=u,w.next=c.next),x&&(x.next=u),x=u,u.next=c.next))}c=w||c.next}}g=this._normalizeStatistics(l,a);return{count:a,attributes:g,xTotal:f,yTotal:k,referenceId:m}};d.prototype._forEachNode=function(g){for(var b=this._root;null!==b;){var e=this._linkChildren(b)||b.next;g(b);b=e}};d.prototype._linkChildren=function(g){for(var b=null,e=null,h=0;h<=g.children.length;h++){var d=g.children[h];d&&(b||(b=d,b.next=g.next),e&&(e.next=d),e=d,d.next=g.next)}return b};
d.prototype._updateStatistics=function(g,b,e){for(var h=0,d=this._fields;h<d.length;h++){var c=d[h],a=c.name,f=g.attributes[c.outStatistic.onStatisticField];switch(c.outStatistic.statisticType){case "norm":b.statistics[a]||(b.statistics[a]={});var c=g.attributes[c.outStatistic.onStatisticNormalizationField],k=b.statistics[a].onStatisticField||0,l=b.statistics[a].onStatisticNormalizationField||0;null==f||isNaN(f)||null==c||0===c||isNaN(c)||(b.statistics[a].onStatisticField=k+e*f,b.statistics[a].onStatisticNormalizationField=
l+e*c);break;case "sum":case "avg":b.statistics[a]||(b.statistics[a]={value:0,nanCount:0});k=b.statistics[a].value;c=b.statistics[a].nanCount;null==f||isNaN(f)?b.statistics[a].nanCount=c+e:b.statistics[a].value=k+e*f;break;case "avg_angle":b.statistics[a]||(b.statistics[a]={x:0,y:0,nanCount:0});var k=b.statistics[a].x,l=b.statistics[a].y,c=b.statistics[a].nanCount,m=Math.PI/180;null==f||isNaN(f)?b.statistics[a].nanCount=c+e:(b.statistics[a].x=k+e*Math.cos(f*m),b.statistics[a].y=l+e*Math.sin(f*m));
break;case "mode":b.statistics[a]||(b.statistics[a]={}),k=b.statistics[a][f]||0,b.statistics[a][f]=k+e}}};d.prototype._updateStatisticsCursor=function(g,b,e){for(var h=0,d=this._statisticFields;h<d.length;h++){var c=d[h],a=c.name,f=c.inField?g.readAttribute(c.inField):g.getComputedNumericAtIndex(c.inFieldIndex);switch(c.statisticType){case "norm":b.statistics[a]||(b.statistics[a]={});var c=g.readAttribute(c.inNormalizationField),k=b.statistics[a].onStatisticField||0,l=b.statistics[a].onStatisticNormalizationField||
0;null==f||isNaN(f)||null==c||0===c||isNaN(c)||(b.statistics[a].onStatisticField=k+e*f,b.statistics[a].onStatisticNormalizationField=l+e*c);break;case "sum":case "avg":b.statistics[a]||(b.statistics[a]={value:0,nanCount:0});k=b.statistics[a].value;c=b.statistics[a].nanCount;null==f||isNaN(f)?b.statistics[a].nanCount=c+e:b.statistics[a].value=k+e*f;break;case "avg_angle":b.statistics[a]||(b.statistics[a]={x:0,y:0,nanCount:0});var k=b.statistics[a].x,l=b.statistics[a].y,c=b.statistics[a].nanCount,m=
Math.PI/180;null==f||isNaN(f)?b.statistics[a].nanCount=c+e:(b.statistics[a].x=k+e*Math.cos(f*m),b.statistics[a].y=l+e*Math.sin(f*m));break;case "mode":b.statistics[a]||(b.statistics[a]={}),k=b.statistics[a][f]||0,b.statistics[a][f]=k+e}}};d.prototype._aggregateStatistics=function(g,b){for(var e=0,h=this._fields;e<h.length;e++){var d=h[e],c=d.name;switch(d.outStatistic.statisticType){case "sum":case "avg":case "avg_angle":case "mode":case "norm":g[c]||(g[c]={});for(var a in b[c])g[c][a]=(g[c][a]||
0)+b[c][a]}}};d.prototype._normalizeStatistics=function(g,b){for(var e={},h=0,d=this._fields;h<d.length;h++){var c=d[h],a=c.name;switch(c.outStatistic.statisticType){case "norm":c=g[a];if(b&&null==c.onStatisticNormalizationField)break;if(b&&c.onStatisticNormalizationField){e[a]=c.onStatisticField/c.onStatisticNormalizationField;break}e[a]=0;break;case "sum":if(!b)break;var f=g[a],c=f.value,f=f.nanCount;if(!(b-f))break;e[a]=c;break;case "avg":if(!b)break;f=g[a];c=f.value;f=f.nanCount;if(!(b-f))break;
e[a]=c/(b-f);break;case "avg_angle":if(!b)break;var f=g[a],c=f.x,k=f.y,f=f.nanCount;if(!(b-f))break;e[a]=180/Math.PI*Math.atan2(k/(b-f),c/(b-f));break;case "mode":var c=g[a],f=0,k=null,l;for(l in c){var m=c[l];m>f&&(f=m,k=l)}e[a]="null"===k?null:k}}return e};return d}();x.GeohashTree=E;var F=function(){function d(g,b,e){this.yTotal=this.xTotal=this.count=0;this.statistics={};this.displayId=0;this.next=null;this.yGeohashTotal=this.xGeohashTotal=this.yNode=this.xNode=this.depth=0;this.children=Array(32);
for(var d=0;d<this.children.length;d++)this.children[d]=null;this.xNode=g;this.yNode=b;this.depth=e}d.prototype.realloc=function(g,b,e){for(var d=0;d<this.children.length;d++)this.children[d]=null;this.xNode=g;this.yNode=b;this.depth=e;this.next=null;this.count=this.yTotal=this.xTotal=this.yGeohashTotal=this.xGeohashTotal=0;this.statistics={};return this};d.prototype.getLngLatBounds=function(){var d=this.depth,b=Math.ceil(d/2),d=Math.floor(d/2);return H.decodeGeohashXY({geohashX:this.xNode<<30-(3*
b+2*d),geohashY:this.yNode<<30-(2*b+3*d)},this.depth)};d.prototype.find=function(d,b,e,h,n,c){if(h>=e)return this;var a=1-h%2,f=3*a+2*(1-a),g=2*a+3*(1-a),l=30-n-f,m=30-c-g,a=this.children[((d&7*a+3*(1-a)<<l)>>l)+((b&3*a+7*(1-a)<<m)>>m)*(8*a+4*(1-a))];return null==a?null:a.find(d,b,e,h+1,n+f,c+g)};return d}()});