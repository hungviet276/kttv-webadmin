// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.17/esri/copyright.txt for details.
//>>built
define("require exports tslib ../../../Graphic ../support/FeatureSet ../support/IdSet ../support/shared ../support/sqlUtils ../../../core/promiseUtils ../../../geometry/Geometry ../../../layers/FeatureLayer ../../../layers/support/FeatureType ../../../layers/support/Field ../../../tasks/support/Query".split(" "),function(D,E,w,x,y,n,q,z,k,A,B,C,u,r){return function(v){function c(a){var b=v.call(this,a)||this;b.declaredClass="esri.arcade.featureset.sources.FeatureLayerMemory";b._removeGeometry=!1;
b._overrideFields=null;b._forceIsTable=!1;a.spatialReference&&(b.spatialReference=a.spatialReference);b._transparent=!0;b._maxProcessing=1E3;b._layer=a.layer;b._wset=null;!0===a.isTable&&(b._forceIsTable=!0);void 0!==a.outFields&&(b._overrideFields=a.outFields);void 0!==a.includeGeometry&&(b._removeGeometry=!1===a.includeGeometry);return b}w.__extends(c,v);c.prototype._maxQueryRate=function(){return q.defaultMaxRecords};c.prototype.end=function(){return this._layer};c.prototype.optimisePagingFeatureQueries=
function(){};c.prototype.load=function(){var a=this;null===this._loadPromise&&(this._loadPromise=k.create(function(b,e){!0===a._layer.loaded?(a._initialiseFeatureSet(),b(a)):(a._layer.when().then(function(){try{a._initialiseFeatureSet(),b(a)}catch(d){e(d)}},e),a._layer.load())}));return this._loadPromise};c.prototype._initialiseFeatureSet=function(){null==this.spatialReference&&(this.spatialReference=this._layer.spatialReference);this.geometryType=this._layer.geometryType;this.fields=this._layer.fields.slice(0);
if(this._layer.outFields&&(1!==this._layer.outFields.length||"*"!==this._layer.outFields[0])){for(var a=[],b=0,e=this.fields;b<e.length;b++){var d=e[b];if("oid"===d.type)a.push(d);else for(var c=0,f=this._layer.outFields;c<f.length;c++){var m=f[c];if(m.toLowerCase()===d.name.toLowerCase()){a.push(d);break}}}this.fields=a}if(null!==this._overrideFields)if(1===this._overrideFields.length&&"*"===this._overrideFields[0])this._overrideFields=null;else{a=[];b=[];e=0;for(c=this.fields;e<c.length;e++)if(d=
c[e],"oid"===d.type)a.push(d),b.push(d.name);else for(var f=0,p=this._overrideFields;f<p.length;f++)if(m=p[f],m.toLowerCase()===d.name.toLowerCase()){a.push(d);b.push(d.name);break}this.fields=a;this._overrideFields=b}this.objectIdField=this._layer.objectIdField;this.hasM=this._layer.supportsM;this.hasZ=this._layer.supportsZ;this._databaseType=q.FeatureServiceDatabaseType.Standardised;this.typeIdField=this._layer.typeIdField;this.types=this._layer.types};c.prototype.isTable=function(){return this._forceIsTable||
this._layer.isTable||"table"===this._layer.type||!this._layer.geometryType};c.prototype._isInFeatureSet=function(){return q.IdState.InFeatureSet};c.prototype._candidateIdTransform=function(a){return a};c.prototype._getSet=function(a){var b=this;return null===this._wset?this._ensureLoaded().then(function(){return b._getFilteredSet("",null,null,null,a)}).then(function(a){return b._wset=a}):k.resolve(this._wset)};c.prototype._changeFeature=function(a){for(var b={},e=0,d=this.fields;e<d.length;e++){var c=
d[e];b[c.name]=a.attributes[c.name]}return new x({geometry:!0===this._removeGeometry?null:a.geometry,attributes:b})};c.prototype._getFilteredSet=function(a,b,e,d,c){var f=this,m="",t=!1;null!==d&&(m=d.constructClause(),t=!0);if(this.isTable()&&b&&null!==a&&""!==a)return a=new n([],[],!0,null),k.resolve(a);d=new r;d.where=null===e?null===b?"1\x3d1":"":z.toWhereClause(e,q.FeatureServiceDatabaseType.Standardised);d.spatialRelationship=this._makeRelationshipEnum(a);d.outSpatialReference=this.spatialReference;
d.orderByFields=""!==m?m.split(","):null;d.geometry=null===b?null:b;d.returnGeometry=!0;d.relationParameter=this._makeRelationshipParam(a);return this._layer.queryFeatures(d).then(function(a){if(null===a)return new n([],[],t,null);f._checkCancelled(c);var b=[];a.features.forEach(function(a){var d=a.attributes[f._layer.objectIdField];b.push(d);f._featureCache[d]=f._changeFeature(a)});return new n([],b,t,null)})};c.prototype._makeRelationshipEnum=function(a){if(0<=a.indexOf("esriSpatialRelRelation"))return"relation";
switch(a){case "esriSpatialRelRelation":return"relation";case "esriSpatialRelIntersects":return"intersects";case "esriSpatialRelContains":return"contains";case "esriSpatialRelOverlaps":return"overlaps";case "esriSpatialRelWithin":return"within";case "esriSpatialRelTouches":return"touches";case "esriSpatialRelCrosses":return"crosses";case "esriSpatialRelEnvelopeIntersects":return"envelope-intersects"}return a};c.prototype._makeRelationshipParam=function(a){return 0<=a.indexOf("esriSpatialRelRelation")?
a.split(":")[1]:""};c.prototype._queryAllFeatures=function(){var a=this;if(this._wset)return k.resolve(this._wset);var b=new r;b.where="1\x3d1";return this._ensureLoaded().then(function(){if(a._layer.source&&a._layer.source.items){var c=[];a._layer.source.items.forEach(function(b){var d=b.attributes[a._layer.objectIdField];c.push(d);a._featureCache[d]=a._changeFeature(b)});a._wset=new n([],c,!1,null);return a._wset}return a._layer.queryFeatures(b).then(function(b){var d=[];b.features.forEach(function(b){var c=
b.attributes[a._layer.objectIdField];d.push(c);a._featureCache[c]=a._changeFeature(b)});a._wset=new n([],d,!1,null);return a._wset})})};c.prototype._getFeatures=function(a,b,c){var d=[];-1!==b&&void 0===this._featureCache[b]&&d.push(b);for(var e=a._lastFetchedIndex;e<a._known.length&&!(a._lastFetchedIndex+=1,void 0===this._featureCache[a._known[e]]&&(a._known[e]!==b&&d.push(a._known[e]),d.length>c));e++);return 0===d.length?k.resolve("success"):k.reject(Error("Unaccounted for Features. Not in Feature Collection"))};
c.prototype._refineSetBlock=function(a){return k.resolve(a)};c.prototype._stat=function(){return k.resolve({calculated:!1})};c.prototype._canDoAggregates=function(){return k.resolve(!1)};c.prototype.relationshipMetaData=function(){return[]};c._cloneAttr=function(a){var b={},c;for(c in a)b[c]=a[c];return b};c.prototype.nativeCapabilities=function(){return{title:this._layer.title,canQueryRelated:!1,source:this,capabilities:this._layer.capabilities,databaseType:this._databaseType,requestStandardised:!0}};
c.create=function(a,b){var e=a.layerDefinition.objectIdField,d=a.layerDefinition.typeIdField?a.layerDefinition.typeIdField:"",k=[];if(a.layerDefinition.types)for(var f=0,m=a.layerDefinition.types;f<m.length;f++)k.push(C.fromJSON(m[f]));var p=a.layerDefinition.geometryType;void 0===p&&(p=a.featureSet.geometryType||"");f=a.featureSet.features;m=b.toJSON();if(""===e||void 0===e){for(var h=!1,l=0,n=a.layerDefinition.fields;l<n.length;l++){var g=n[l];if("oid"===g.type||"esriFieldTypeOID"===g.type){e=g.name;
h=!0;break}}if(!1===h){e="FID";h=!0;for(l=0;h;){for(var n=!0,q=0,r=a.layerDefinition.fields;q<r.length;q++)if(g=r[q],g.name===e){n=!1;break}!0===n?h=!1:(l++,e="FID"+l.toString())}a.layerDefinition.fields.push({type:"esriFieldTypeOID",name:e,alias:e});g=[];for(h=0;h<f.length;h++)g.push({geometry:a.featureSet.features[h].geometry,attributes:a.featureSet.features[h].attributes?this._cloneAttr(a.featureSet.features[h].attributes):{}}),g[h].attributes[e]=h;f=g}}h=[];l=0;for(a=a.layerDefinition.fields;l<
a.length;l++)g=a[l],g instanceof u?h.push(g):h.push(u.fromJSON(g));a=p;switch(a){case "esriGeometryPoint":a="point";break;case "esriGeometryPolyline":a="polyline";break;case "esriGeometryPolygon":a="polygon";break;case "esriGeometryExtent":a="extent";break;case "esriGeometryMultipoint":a="multipoint"}p=0;for(l=f;p<l.length;p++)g=l[p],g.geometry&&!1===g.geometry instanceof A&&(g.geometry.type=a,void 0===g.geometry.spatialReference&&(g.geometry.spatialReference=m));d={outFields:["*"],source:f,fields:h,
types:k,typeIdField:d,objectIdField:e,spatialReference:b};d.geometryType=a?a:"point";d=new B(d);return new c({layer:d,spatialReference:b,isTable:null===a||""===a})};c.prototype.queryAttachments=function(){return k.resolve([])};c.prototype.getFeatureByObjectId=function(a){var b=new r;b.where=this.objectIdField+"\x3d"+a.toString();return this._layer.queryFeatures(b).then(function(a){return 1===a.features.length?a.features[0]:null})};return c}(y)});