// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.17/esri/copyright.txt for details.
//>>built
define("require exports tslib ../../../Graphic ../../../request ../../Attachment ../support/FeatureSet ../support/IdSet ../support/shared ../support/sqlUtils ../support/sqlUtils ../support/stats ../../../core/MD5 ../../../core/promiseUtils ../../../geometry/support/jsonUtils ../../../layers/FeatureLayer ../../../layers/graphics/featureConversionUtils ../../../tasks/QueryTask ../../../tasks/operations/query ../../../tasks/support/FeatureSet ../../../tasks/support/Query ../../../tasks/support/StatisticDefinition ../../../tasks/operations/pbfOptimizedFeatureSet".split(" "),
function(P,Q,E,y,F,G,H,w,u,v,z,I,A,p,J,K,L,B,M,N,t,C,O){return function(D){function e(a){var b=D.call(this,a)||this;b.declaredClass="esri.arcade.featureset.sources.FeatureLayerDynamic";b._removeGeometry=!1;b._overrideFields=null;b.formulaCredential=null;b._pageJustIds=!1;b._requestStandardised=!1;a.spatialReference&&(b.spatialReference=a.spatialReference);b._transparent=!0;b._maxProcessing=1E3;b._layer=a.layer;b._wset=null;void 0!==a.outFields&&(b._overrideFields=a.outFields);void 0!==a.includeGeometry&&
(b._removeGeometry=!1===a.includeGeometry);return b}E.__extends(e,D);e.prototype._maxQueryRate=function(){return u.defaultMaxRecords};e.prototype.end=function(){return this._layer};e.prototype.optimisePagingFeatureQueries=function(a){this._pageJustIds=a};e.prototype.convertQueryToLruCacheKey=function(a){a=u.stableStringify(a.toJSON());return A.createMD5Hash(a,A.outputTypes.String)};e.prototype.load=function(){var a=this;null===this._loadPromise&&(this._loadPromise=p.create(function(b,g){try{!0===
a._layer.loaded?(a._initialiseFeatureSet(),b(a)):(a._layer.when().then(function(){try{a._initialiseFeatureSet(),b(a)}catch(f){g(f)}},g),a._layer.load())}catch(f){g(f)}}));return this._loadPromise};e.prototype._initialiseFeatureSet=function(){null==this.spatialReference&&(this.spatialReference=this._layer.spatialReference);this.geometryType=this._layer.geometryType;this.fields=this._layer.fields.slice(0);if(this._layer.outFields&&(1!==this._layer.outFields.length||"*"!==this._layer.outFields[0])){for(var a=
[],b=0,g=this.fields;b<g.length;b++){var f=g[b];if("oid"===f.type)a.push(f);else for(var h=0,c=this._layer.outFields;h<c.length;h++){var l=c[h];if(l.toLowerCase()===f.name.toLowerCase()){a.push(f);break}}}this.fields=a}if(null!==this._overrideFields)if(1===this._overrideFields.length&&"*"===this._overrideFields[0])this._overrideFields=null;else{a=[];b=[];g=0;for(h=this.fields;g<h.length;g++)if(f=h[g],"oid"===f.type)a.push(f),b.push(f.name);else for(var c=0,d=this._overrideFields;c<d.length;c++)if(l=
d[c],l.toLowerCase()===f.name.toLowerCase()){a.push(f);b.push(f.name);break}this.fields=a;this._overrideFields=b}this._layer.source&&this._layer.source.sourceJSON&&(a=this._layer.source.sourceJSON.currentVersion,!0===this._layer.source.sourceJSON.useStandardizedQueries?(this._databaseType=u.FeatureServiceDatabaseType.StandardisedNoInterval,void 0!==a&&null!==a&&10.61<=a&&(this._databaseType=u.FeatureServiceDatabaseType.Standardised)):void 0!==a&&null!==a&&(10.5<=a&&(this._databaseType=u.FeatureServiceDatabaseType.StandardisedNoInterval,
this._requestStandardised=!0),10.61<=a&&(this._databaseType=u.FeatureServiceDatabaseType.Standardised)));this.objectIdField=this._layer.objectIdField;this.hasM=this._layer.supportsM;this.hasZ=this._layer.supportsZ;this.typeIdField=this._layer.typeIdField;this.types=this._layer.types};e.prototype._isInFeatureSet=function(){return u.IdState.InFeatureSet};e.prototype._refineSetBlock=function(a){return p.resolve(a)};e.prototype._candidateIdTransform=function(a){return a};e.prototype._getSet=function(a){var b=
this;return null===this._wset?this._ensureLoaded().then(function(){return b._getFilteredSet("",null,null,null,a)}).then(function(a){return b._wset=a}):p.resolve(this._wset)};e.prototype._runDatabaseProbe=function(a){var b=this;return p.create(function(g,f){try{b._ensureLoaded().then(function(){try{var h=new t;h.where=a.replace("OBJECTID",b._layer.objectIdField);b._layer.queryObjectIds(h).then(function(){g(!0)},function(){try{g(!1)}catch(c){f(c)}})}catch(c){f(c)}})}catch(h){f(h)}})};e.prototype._canUsePagination=
function(){return this._layer.capabilities&&this._layer.capabilities.query&&!0===this._layer.capabilities.query.supportsPagination?!0:!1};e.prototype._cacheableFeatureSetSourceKey=function(){return this._layer.url};e.prototype.pbfSupportedForQuery=function(a){return!a.outStatistics&&this._layer&&this._layer.capabilities&&this._layer.capabilities.query&&!0===this._layer.capabilities.query.supportsFormatPBF&&!0===this._layer.capabilities.query.supportsQuantizationEditMode};e.prototype.queryPBF=function(a){a.quantizationParameters=
{mode:"edit"};return M.executeQueryPBF(this._layer.parsedUrl,a,new O.OptimizedFeatureSetParserContext({})).then(function(a){return N.fromJSON(L.convertToFeatureSet(a.data)).unquantize()})};e.prototype.nativeCapabilities=function(){return{title:this._layer.title,source:this,canQueryRelated:!0,capabilities:this._layer.capabilities,databaseType:this._databaseType,requestStandardised:this._requestStandardised}};e.prototype.executeQuery=function(a,b){var g=this,f=new B({url:this._layer.parsedUrl.path}),
h="execute"===b&&this.pbfSupportedForQuery(a),c=null;if(this.recentlyUsedQueries){var l=this.convertQueryToLruCacheKey(a),c=this.recentlyUsedQueries.getFromCache(l);null===c&&(c=!0!==h?f[b](a):this.queryPBF(a),this.recentlyUsedQueries.addToCache(l,c),c=c.catch(function(a){g.recentlyUsedQueries.removeFromCache(l);throw a;}))}null===c&&(c=!0!==h?f[b](a):this.queryPBF(a));return c};e.prototype._getFilteredSet=function(a,b,g,f,h){var c=this;return this.databaseType().then(function(l){if(c.isTable()&&
b&&null!==a&&""!==a)return new w([],[],!0,null);if(c._canUsePagination())return c._getFilteredSetUsingPaging(a,b,g,f,h);var d="",k=!1;null!==f&&c._layer.capabilities&&c._layer.capabilities.query&&!0===c._layer.capabilities.query.supportsOrderBy&&(d=f.constructClause(),k=!0);var q=new t;q.where=null===g?null===b?"1\x3d1":"":v.toWhereClause(g,l);c._requestStandardised&&(q.sqlFormat="standard");q.spatialRelationship=c._makeRelationshipEnum(a);q.outSpatialReference=c.spatialReference;q.orderByFields=
""!==d?d.split(","):null;q.geometry=null===b?null:b;q.relationParameter=c._makeRelationshipParam(a);return c.executeQuery(q,"executeForIds").then(function(a){null===a&&(a=[]);c._checkCancelled(h);return new w([],a,k,null)})})};e.prototype._expandPagedSet=function(a,b,g,f,h){return this._expandPagedSetFeatureSet(a,b,g,f,h)};e.prototype._getFilteredSetUsingPaging=function(a,b,g,f,h){var c=this;try{var l="",d=!1;null!==f&&this._layer.capabilities&&this._layer.capabilities.query&&!0===this._layer.capabilities.query.supportsOrderBy&&
(l=f.constructClause(),d=!0);return this.databaseType().then(function(f){f=null===g?null===b?"1\x3d1":"":v.toWhereClause(g,f);c._layer.definitionExpression&&(f=""!==f?"(("+c._layer.definitionExpression+") AND ("+f+"))":c._layer.definitionExpression);var k=c._maxQueryRate(),e=c._layer.capabilities.query.maxRecordCount;void 0!==e&&e<k&&(k=e);var m=null;if(!0===c._pageJustIds)m=new w([],["GETPAGES"],d,{spatialRel:c._makeRelationshipEnum(a),relationParam:c._makeRelationshipParam(a),outFields:c._layer.objectIdField,
resultRecordCount:k,resultOffset:0,geometry:null===b?null:b,where:f,orderByFields:l,returnGeometry:!1,returnIdsOnly:"false",internal:{set:[],lastRetrieved:0,lastPage:0,fullyResolved:!1}});else{e=!0;!0===c._removeGeometry&&(e=!1);var n=null!==c._overrideFields?c._overrideFields:c._fieldsIncludingObjectId(c._layer.outFields?c._layer.outFields:["*"]),m=new w([],["GETPAGES"],d,{spatialRel:c._makeRelationshipEnum(a),relationParam:c._makeRelationshipParam(a),outFields:n.join(","),resultRecordCount:k,resultOffset:0,
geometry:null===b?null:b,where:f,orderByFields:l,returnGeometry:e,returnIdsOnly:"false",internal:{set:[],lastRetrieved:0,lastPage:0,fullyResolved:!1}})}return c._expandPagedSet(m,k,0,1,h).then(function(){return m})})}catch(k){return p.reject(k)}};e.prototype._clonePageDefinition=function(a){return null===a?null:!0!==a.groupbypage?{groupbypage:!1,spatialRel:a.spatialRel,relationParam:a.relationParam,outFields:a.outFields,resultRecordCount:a.resultRecordCount,resultOffset:a.resultOffset,geometry:a.geometry,
where:a.where,orderByFields:a.orderByFields,returnGeometry:a.returnGeometry,returnIdsOnly:a.returnIdsOnly,internal:a.internal}:{groupbypage:!0,spatialRel:a.spatialRel,relationParam:a.relationParam,outFields:a.outFields,resultRecordCount:a.resultRecordCount,useOIDpagination:a.useOIDpagination,generatedOid:a.generatedOid,groupByFieldsForStatistics:a.groupByFieldsForStatistics,resultOffset:a.resultOffset,outStatistics:a.outStatistics,geometry:a.geometry,where:a.where,orderByFields:a.orderByFields,returnGeometry:a.returnGeometry,
returnIdsOnly:a.returnIdsOnly,internal:a.internal}};e.prototype._getPhysicalPage=function(a,b,g){var f=this;try{var h=a.pagesDefinition.internal.lastRetrieved,c=a.pagesDefinition.internal.lastPage,l=new t;this._requestStandardised&&(l.sqlFormat="standard");l.spatialRelationship=a.pagesDefinition.spatialRel;l.relationParameter=a.pagesDefinition.relationParam;l.outFields=a.pagesDefinition.outFields.split(",");l.num=a.pagesDefinition.resultRecordCount;l.start=a.pagesDefinition.internal.lastPage;l.geometry=
a.pagesDefinition.geometry;l.where=a.pagesDefinition.where;l.orderByFields=""!==a.pagesDefinition.orderByFields?a.pagesDefinition.orderByFields.split(","):null;l.returnGeometry=a.pagesDefinition.returnGeometry;l.outSpatialReference=this.spatialReference;return this.executeQuery(l,"execute").then(function(b){f._checkCancelled(g);if(a.pagesDefinition.internal.lastPage!==c)return"done";for(var d=0;d<b.features.length;d++)a.pagesDefinition.internal.set[h+d]=b.features[d].attributes[f._layer.objectIdField];
if(!1===f._pageJustIds)for(d=0;d<b.features.length;d++)f._featureCache[b.features[d].attributes[f._layer.objectIdField]]=b.features[d];if(void 0===b.exceededTransferLimit&&b.features.length!==a.pagesDefinition.resultRecordCount||!1===b.exceededTransferLimit)a.pagesDefinition.internal.fullyResolved=!0;a.pagesDefinition.internal.lastRetrieved=h+b.features.length;a.pagesDefinition.internal.lastPage+=a.pagesDefinition.resultRecordCount;return"done"})}catch(d){return p.reject(d)}};e.prototype._fieldsIncludingObjectId=
function(a){if(null===a)return[this.objectIdField];a=a.slice(0);if(-1<a.indexOf("*"))return a;for(var b=!1,g=0;g<a.length;g++)if(a[g].toUpperCase()===this.objectIdField.toUpperCase()){b=!0;break}!1===b&&a.push(this.objectIdField);return a};e.prototype._getFeatures=function(a,b,g,f){var h=this,c=[];try{-1!==b&&void 0===this._featureCache[b]&&c.push(b);if(!0===this._checkIfNeedToExpandKnownPage(a,this._maxProcessingRate()))return this._expandPagedSet(a,this._maxProcessingRate(),0,0,f).then(function(){return h._getFeatures(a,
b,g,f)});for(var l=0,d=a._lastFetchedIndex;d<a._known.length;d++){a._lastFetchedIndex+=1;l++;if(void 0===this._featureCache[a._known[d]]){var e=!1;if(null!==this._layer._mode&&void 0!==this._layer._mode){var q=this._layer._mode;if(void 0!==q._featureMap[a._known[d]]){var r=q._featureMap[a._known[d]];null!==r&&(e=!0,this._featureCache[a._known[d]]=r)}}if(!1===e&&(a._known[d]!==b&&c.push(a._known[d]),c.length>=this._maxProcessingRate()-1))break}if(l>=g&&0===c.length)break}if(0===c.length)return p.resolve("success");
try{var m=new t;this._requestStandardised&&(m.sqlFormat="standard");m.objectIds=c;m.outFields=null!==this._overrideFields?this._overrideFields:this._fieldsIncludingObjectId(this._layer.outFields?this._layer.outFields:["*"]);m.returnGeometry=!0;!0===this._removeGeometry&&(m.returnGeometry=!1);m.outSpatialReference=this.spatialReference;return this.executeQuery(m,"execute").then(function(a){h._checkCancelled(f);if(void 0!==a.error)return p.reject(Error(a.error));for(var b=0;b<a.features.length;b++)h._featureCache[a.features[b].attributes[h._layer.objectIdField]]=
a.features[b];return"success"})}catch(n){return p.reject(n)}}catch(n){return p.reject(n)}};e.prototype._getDistinctPages=function(a,b,g,f,h,c,l,d,e){var k=this;return this._ensureLoaded().then(function(){return k.databaseType()}).then(function(r){for(var m=g.parseTree.column,n=0;n<k._layer.fields.length;n++)if(k._layer.fields[n].name.toLowerCase()===m.toLowerCase()){m=k._layer.fields[n].name;break}n=new t;k._requestStandardised&&(n.sqlFormat="standard");r=null===c?null===h?"1\x3d1":"":v.toWhereClause(c,
r);k._layer.definitionExpression&&(r=""!==r?"(("+k._layer.definitionExpression+") AND ("+r+"))":k._layer.definitionExpression);n.where=r;n.spatialRelationship=k._makeRelationshipEnum(f);n.relationParameter=k._makeRelationshipParam(f);n.geometry=null===h?null:h;n.returnDistinctValues=!0;n.returnGeometry=!1;n.outFields=[m];return k.executeQuery(n,"execute").then(function(n){k._checkCancelled(e);if(!n.hasOwnProperty("features"))return p.reject(Error("Unnexected Result querying statistics from layer"));
for(var r=!1,q=0;q<k._layer.fields.length;q++)if(k._layer.fields[q].name===m){"date"===k._layer.fields[q].type&&(r=!0);break}for(q=0;q<n.features.length;q++){if(r){var x=n.features[q].attributes[m];null!==x?d.push(new Date(x)):d.push(x)}else d.push(n.features[q].attributes[m]);if(d.length>=l)break}return 0===n.features.length?d:n.features.length===k._layer.capabilities.query.maxRecordCount&&d.length<l?k._getDistinctPages(a+n.features.length,b,g,f,h,c,l,d,e).then(function(a){return{calculated:!0,result:a}}):
d})})};e.prototype._distinctStat=function(a,b,g,f,h,c,l){return this._getDistinctPages(0,a,b,g,f,h,c,[],l).then(function(a){return{calculated:!0,result:a}})};e.prototype.isTable=function(){return this._layer.isTable||null===this._layer.geometryType||"table"===this._layer.type||""===this._layer.geometryType};e.prototype._countstat=function(a,b,g,f){var h=this;return this.databaseType().then(function(a){var c=new t;h._requestStandardised&&(c.sqlFormat="standard");if(h.isTable()&&g&&null!==b&&""!==b)return{calculated:!0,
result:0};a=null===f?null===g?"1\x3d1":"":v.toWhereClause(f,a);h._layer.definitionExpression&&(a=""!==a?"(("+h._layer.definitionExpression+") AND ("+a+"))":h._layer.definitionExpression);c.where=a;c.where=a;c.spatialRelationship=h._makeRelationshipEnum(b);c.relationParameter=h._makeRelationshipParam(b);c.geometry=null===g?null:g;c.returnGeometry=!1;return h.executeQuery(c,"executeForCount").then(function(a){return{calculated:!0,result:a}})})};e.prototype._stats=function(a,b,g,f,h,c,e){var d=this;
return this._ensureLoaded().then(function(){var k=d._layer.capabilities&&d._layer.capabilities.query&&!0===d._layer.capabilities.query.supportsSqlExpression,l=d._layer.capabilities&&d._layer.capabilities.query&&!0===d._layer.capabilities.query.supportsStatistics,r=d._layer.capabilities&&d._layer.capabilities.query&&!0===d._layer.capabilities.query.supportsDistinct;return"count"===a?r?d._countstat(a,g,f,h):{calculated:!1}:!1===l||!1===z.isSingleField(b)&&!1===k||!1===b.isStandardized?""!==g||null!==
h?{calculated:!1}:d._manualStat(a,b,c,e):"distinct"===a?!1===r?""!==g||null!==h?{calculated:!1}:d._manualStat(a,b,c,e):d._distinctStat(a,b,g,f,h,c,e):d.databaseType().then(function(c){if(d.isTable()&&f&&null!==g&&""!==g)return{calculated:!0,result:null};var e=new t;d._requestStandardised&&(e.sqlFormat="standard");var k=null===h?null===f?"1\x3d1":"":v.toWhereClause(h,c);d._layer.definitionExpression&&(k=""!==k?"(("+d._layer.definitionExpression+") AND ("+k+"))":d._layer.definitionExpression);e.where=
k;e.spatialRelationship=d._makeRelationshipEnum(g);e.relationParameter=d._makeRelationshipParam(g);e.geometry=null===f?null:f;k=new C;k.statisticType=I.decodeStatType(a);k.onStatisticField=v.toWhereClause(b,c);k.outStatisticFieldName="ARCADE_STAT_RESULT";e.returnGeometry=!1;var l="ARCADE_STAT_RESULT";e.outStatistics=[k];return d.executeQuery(e,"execute").then(function(a){if(!a.hasOwnProperty("features")||0===a.features.length)return p.reject(Error("Unnexected Result querying statistics from layer"));
for(var b=!1,c=0;c<a.fields.length;c++)if("ARCADE_STAT_RESULT"===a.fields[c].name.toUpperCase()){l=a.fields[c].name;"date"===a.fields[c].type&&(b=!0);break}return b?(b=a.features[0].attributes[l],null!==b&&(b=new Date(a.features[0].attributes[l])),{calculated:!0,result:b}):{calculated:!0,result:a.features[0].attributes[l]}})})})};e.prototype._stat=function(a,b,g,f,h,c,e){return this._stats(a,b,g,f,h,c,e)};e.prototype._canDoAggregates=function(a,b){var g=this;return this._ensureLoaded().then(function(){var a=
!1,e=g._layer.capabilities&&g._layer.capabilities.query&&!0===g._layer.capabilities.query.supportsSqlExpression;void 0!==g._layer.capabilities&&null!==g._layer.capabilities.query&&!0===g._layer.capabilities.query.supportsStatistics&&!0===g._layer.capabilities.query.supportsOrderBy&&(a=!0);if(a)for(var c=0;c<b.length-1;c++)null!==b[c].workingexpr&&(!1===b[c].workingexpr.isStandardized?a=!1:!1===z.isSingleField(b[c].workingexpr)&&!1===e&&(a=!1));return!1===a?!1:!0})};e.prototype._makeRelationshipEnum=
function(a){if(0<=a.indexOf("esriSpatialRelRelation"))return"relation";switch(a){case "esriSpatialRelRelation":return"relation";case "esriSpatialRelIntersects":return"intersects";case "esriSpatialRelContains":return"contains";case "esriSpatialRelOverlaps":return"overlaps";case "esriSpatialRelWithin":return"within";case "esriSpatialRelTouches":return"touches";case "esriSpatialRelCrosses":return"crosses";case "esriSpatialRelEnvelopeIntersects":return"envelope-intersects"}return a};e.prototype._makeRelationshipParam=
function(a){return 0<=a.indexOf("esriSpatialRelRelation")?a.split(":")[1]:""};e.prototype._getAggregatePagesDataSourceDefinition=function(a,b,g,f,e,c,l){var d=this;return this._ensureLoaded().then(function(){return d.databaseType()}).then(function(k){var h="",r=!1,m=!1;null!==c&&d._layer.capabilities&&d._layer.capabilities.query&&!0===d._layer.capabilities.query.supportsOrderBy&&(h=c.constructClause(),m=!0);d._layer.capabilities&&d._layer.capabilities.query&&!1===d._layer.capabilities.query.supportsPagination&&
(m=!1,r=!0,h=d._layer.objectIdField);for(var n=[],p=0;p<b.length;p++){var t=new C;t.onStatisticField=null!==b[p].workingexpr?v.toWhereClause(b[p].workingexpr,k):"";t.outStatisticFieldName=b[p].field;t.statisticType=b[p].toStatisticsName();n.push(t)}""===h&&(h=a.join(","));p=d._maxQueryRate();t=d._layer.capabilities.query.maxRecordCount;void 0!==t&&t<p&&(p=t);k=null===e?null===f?"1\x3d1":"":v.toWhereClause(e,k);d._layer.definitionExpression&&(k=""!==k?"(("+d._layer.definitionExpression+") AND ("+k+
"))":d._layer.definitionExpression);return new w([],["GETPAGES"],m,{groupbypage:!0,spatialRel:d._makeRelationshipEnum(g),relationParam:d._makeRelationshipParam(g),outFields:["*"],useOIDpagination:r,generatedOid:l,resultRecordCount:p,resultOffset:0,groupByFieldsForStatistics:a,outStatistics:n,geometry:null===f?null:f,where:k,orderByFields:h,returnGeometry:!1,returnIdsOnly:!1,internal:{lastMaxId:-1,set:[],lastRetrieved:0,lastPage:0,fullyResolved:!1}})})};e.prototype._getAgregagtePhysicalPage=function(a,
b,g){var f=this;try{var e=a.pagesDefinition.where;!0===a.pagesDefinition.useOIDpagination&&(e=""!==e?"("+e+") AND ("+a.pagesDefinition.generatedOid+"\x3e"+a.pagesDefinition.internal.lastMaxId.toString()+")":a.pagesDefinition.generatedOid+"\x3e"+a.pagesDefinition.internal.lastMaxId.toString());var c=a.pagesDefinition.internal.lastRetrieved,l=a.pagesDefinition.internal.lastPage,d=new t;this._requestStandardised&&(d.sqlFormat="standard");d.where=e;d.spatialRelationship=a.pagesDefinition.spatialRel;d.relationParameter=
a.pagesDefinition.relationParam;d.outFields=a.pagesDefinition.outFields;d.outStatistics=a.pagesDefinition.outStatistics;d.geometry=a.pagesDefinition.geometry;d.groupByFieldsForStatistics=a.pagesDefinition.groupByFieldsForStatistics;d.num=a.pagesDefinition.resultRecordCount;d.start=a.pagesDefinition.internal.lastPage;d.returnGeometry=a.pagesDefinition.returnGeometry;d.orderByFields=""!==a.pagesDefinition.orderByFields?a.pagesDefinition.orderByFields.split(","):null;return this.isTable()&&d.geometry&&
d.spatialRelationship?p.resolve([]):this.executeQuery(d,"execute").then(function(b){f._checkCancelled(g);if(!b.hasOwnProperty("features"))return p.reject(Error("Unnexected Result querying aggregates from layer"));var d=[];if(a.pagesDefinition.internal.lastPage!==l)return[];for(var e=0;e<b.features.length;e++)a.pagesDefinition.internal.set[c+e]=b.features[e].attributes[a.pagesDefinition.generatedOid];for(e=0;e<b.features.length;e++)d.push(new y({attributes:b.features[e].attributes,geometry:null}));
if(!0===a.pagesDefinition.useOIDpagination)0===b.features.length?a.pagesDefinition.internal.fullyResolved=!0:a.pagesDefinition.internal.lastMaxId=b.features[b.features.length-1].attributes[a.pagesDefinition.generatedOid];else if(void 0===b.exceededTransferLimit&&b.features.length!==a.pagesDefinition.resultRecordCount||!1===b.exceededTransferLimit)a.pagesDefinition.internal.fullyResolved=!0;a.pagesDefinition.internal.lastRetrieved=c+b.features.length;a.pagesDefinition.internal.lastPage+=a.pagesDefinition.resultRecordCount;
return d})}catch(k){return p.reject(k)}};e.create=function(a,b,g,f){a=new K({url:a,outFields:null===b?["*"]:b});return new e({layer:a,spatialReference:g,lrucache:f})};e.prototype.relationshipMetaData=function(){return this._layer&&this._layer.source&&this._layer.source.sourceJSON&&this._layer.source.sourceJSON.relationships?this._layer.source.sourceJSON.relationships:[]};e.prototype.serviceUrl=function(){return u.extractServiceUrl(this._layer.parsedUrl.path)};e.prototype.queryAttachments=function(a,
b,e,f){var g=this;if(this._layer.capabilities.data.supportsAttachment&&this._layer.capabilities.operations.supportsQueryAttachments){var c={objectIds:[a]};if(b&&0<b||e&&0<e)c.size=[b&&0<b?b:0,e&&0<e?e:b+1];f&&0<f.length&&(c.attachmentTypes=f);return this._layer.queryAttachments(c).then(function(b){var c=[];b&&b[a]&&b[a].forEach(function(b){c.push(new G(b.id,b.name,b.contentType,b.size,g._layer.parsedUrl.path+"/"+a.toString()+"/attachments/"+b.id.toString()))});return c})}return p.resolve([])};e.prototype.queryRelatedFeatures=
function(a){var b={f:"json",relationshipId:a.relationshipId.toString(),definitionExpression:a.where,outFields:a.outFields.join(","),returnGeometry:a.returnGeometry.toString()};void 0!==a.resultOffset&&null!==a.resultOffset&&(b.resultOffset=a.resultOffset.toString());void 0!==a.resultRecordCount&&null!==a.resultRecordCount&&(b.resultRecordCount=a.resultRecordCount.toString());a.orderByFields&&(b.orderByFields=a.orderByFields.join(","));0<a.objectIds.length&&(b.objectIds=a.objectIds.join(","));a.outSpatialReference&&
(b.outSR=JSON.stringify(a.outSpatialReference.toJSON()));return F(this._layer.parsedUrl.path+"/queryRelatedRecords",{responseType:"json",query:b}).then(function(a){if(a.data){var b={};if((a=a.data)&&a.relatedRecordGroups)for(var e=a.spatialReference,c=0,g=a.relatedRecordGroups;c<g.length;c++){for(var d=g[c],k=d.objectId,q=[],r=0,d=d.relatedRecords;r<d.length;r++){var m=d[r];m.geometry&&(m.geometry.spatialReference=e);m=new y({geometry:m.geometry?J.fromJSON(m.geometry):null,attributes:m.attributes});
q.push(m)}b[k]={features:q,exceededTransferLimit:!0===a.exceededTransferLimit}}return b}return p.reject("Invalid Request")})};e.prototype.getFeatureByObjectId=function(a,b){var e=new B({url:this._layer.parsedUrl.path}),f=new t;f.outFields=b;f.returnGeometry=!1;f.outSpatialReference=this.spatialReference;f.where=this.objectIdField+"\x3d"+a.toString();return e.execute(f).then(function(a){return 1===a.features.length?a.features[0]:null})};return e}(H)});