// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.17/esri/copyright.txt for details.
//>>built
define("require exports ../ArcadePortal ../Dictionary ../Dictionary ../Feature ../featureSetCollection ../featureSetUtils ../languageUtils ../featureset/actions/Adapted ../featureset/actions/AttributeFilter ../featureset/actions/OrderBy ../featureset/actions/Top ../featureset/sources/Empty ../featureset/sources/FeatureLayerMemory ../featureset/support/OrderbyClause ../featureset/support/shared ../featureset/support/sqlUtils ./fieldStats ../../core/promiseUtils ../../core/sql/WhereClause ../../layers/FeatureLayer ../../layers/support/Field".split(" "),
function(Z,G,S,M,x,A,N,t,d,n,O,T,U,V,W,X,H,P,I,u,v,J,D){function Y(b,g,c,l){if(1===l.length){if(d.isArray(l[0]))return I.calculateStat(b,l[0],-1);if(d.isImmutableArray(l[0]))return I.calculateStat(b,l[0].toArray(),-1)}return I.calculateStat(b,l,-1)}function K(b,d,c){var l=b.getVariables();if(0<l.length){for(var g=[],a=0;a<l.length;a++)g.push(d.evaluateIdentifier(c,{name:l[a]}));return u.all(g).then(function(a){for(var e={},d=0;d<l.length;d++)e[l[d]]=a[d];b.parameters=e;return b})}return u.resolve(b)}
function k(d,g,c){void 0===c&&(c=null);for(var l in d)if(l.toLowerCase()===g.toLowerCase())return d[l];return c}function Q(d){if(null===d)return null;var b={type:k(d,"type",""),name:k(d,"name","")};if("range"===b.type)b.range=k(d,"range",[]);else{b.codedValues=[];var c=0;for(d=k(d,"codedValues",[]);c<d.length;c++){var l=d[c];b.codedValues.push({name:k(l,"name",""),code:k(l,"code",null)})}}return b}function L(d){if(null===d)return null;var b={},c=k(d,"wkt",null);null!==c&&(b.wkt=c);d=k(d,"wkid",null);
null!==d&&(b.wkid=d);return b}function R(d){if(null===d)return null;var b={hasZ:k(d,"hasz",!1),hasM:k(d,"hasm",!1)},c=k(d,"spatialreference",null);c&&(b.spatialReference=L(c));c=k(d,"x",null);if(null!==c)return b.x=c,b.y=k(d,"y",null),b;c=k(d,"rings",null);if(null!==c)return b.rings=c,b;c=k(d,"paths",null);if(null!==c)return b.paths=c,b;c=k(d,"points",null);if(null!==c)return b.points=c,b;for(var c=0,l="xmin xmax ymin ymax zmin zmax mmin mmax".split(" ");c<l.length;c++){var f=l[c],a=k(d,f,null);null!==
a&&(b[f]=a)}return b}Object.defineProperty(G,"__esModule",{value:!0});G.registerFunctions=void 0;G.registerFunctions=function(b){"async"===b.mode&&(b.functions.featuresetbyid=function(g,c){return b.standardFunctionAsync(g,c,function(l,b,a){d.pcCheck(a,2,4);if(a[0]instanceof N){l=d.toString(a[1]);b=d.defaultUndefined(a[2],null);var e=d.toBoolean(d.defaultUndefined(a[3],!0));null===b&&(b=["*"]);if(!1===d.isArray(b))throw Error("Invalid Parameter");return a[0].featureSetById(l,e,b)}throw Error("Invalid Parameter");
})},b.signatures.push({name:"featuresetbyid",min:"2",max:"4"}),b.functions.featuresetbyportalitem=function(g,c){return b.standardFunctionAsync(g,c,function(b,f,a){d.pcCheck(a,2,5);if(null===a[0])throw Error("Portal is required");if(a[0]instanceof S){b=d.toString(a[1]);f=d.toString(a[2]);var e=d.defaultUndefined(a[3],null),l=d.toBoolean(d.defaultUndefined(a[4],!0));null===e&&(e=["*"]);if(!1===d.isArray(e))throw Error("Invalid Parameter");var m=null;g.services&&g.services.portal&&(m=g.services.portal);
m=t.getPortal(a[0],m);return t.constructFeatureSetFromPortalItem(b,f,g.spatialReference,e,l,m,g.lrucache)}if(!1===d.isString(a[0]))throw Error("Portal is required");b=d.toString(a[0]);f=d.toString(a[1]);e=d.defaultUndefined(a[2],null);a=d.toBoolean(d.defaultUndefined(a[3],!0));null===e&&(e=["*"]);if(!1===d.isArray(e))throw Error("Invalid Parameter");if(g.services&&g.services.portal)return t.constructFeatureSetFromPortalItem(b,f,g.spatialReference,e,a,g.services.portal,g.lrucache);throw Error("Portal is required");
})},b.signatures.push({name:"featuresetbyportalitem",min:"2",max:"5"}),b.functions.featuresetbyname=function(g,c){return b.standardFunctionAsync(g,c,function(b,f,a){d.pcCheck(a,2,4);if(a[0]instanceof N){b=d.toString(a[1]);f=d.defaultUndefined(a[2],null);var e=d.toBoolean(d.defaultUndefined(a[3],!0));null===f&&(f=["*"]);if(!1===d.isArray(f))throw Error("Invalid Parameter");return a[0].featureSetByName(b,e,f)}throw Error("Invalid Parameter");})},b.signatures.push({name:"featuresetbyname",min:"2",max:"4"}),
b.functions.featureset=function(g,c){return b.standardFunction(g,c,function(b,f,a){d.pcCheck(a,1,1);f=a[0];b={layerDefinition:{geometryType:"",objectIdField:"",typeIdField:"",fields:[]},featureSet:{geometryType:"",features:[]}};if(d.isString(f))f=JSON.parse(f),void 0!==f.layerDefinition?(b.layerDefinition=f.layerDefinition,b.featureSet=f.featureSet,f.layerDefinition.spatialReference&&(b.layerDefinition.spatialReference=f.layerDefinition.spatialReference)):(b.featureSet.features=f.features,b.featureSet.geometryType=
f.geometryType,b.layerDefinition.geometryType=b.featureSet.geometryType,b.layerDefinition.objectIdField=f.objectIdFieldName,b.layerDefinition.typeIdField=f.typeIdFieldName,b.layerDefinition.fields=f.fields,f.spatialReference&&(b.layerDefinition.spatialReference=f.spatialReference));else if(a[0]instanceof M){f=JSON.parse(a[0].castToText());var e=k(f,"layerdefinition");if(null!==e){b.layerDefinition.geometryType=k(e,"geometrytype","");b.featureSet.geometryType=b.layerDefinition.geometryType;b.layerDefinition.objectIdField=
k(e,"objectidfield","");b.layerDefinition.typeIdField=k(e,"typeidfield","");if(a=k(e,"spatialreference",null))b.layerDefinition.spatialReference=L(a);a=0;for(var c=k(e,"fields",[]);a<c.length;a++)e=c[a],e={name:k(e,"name",""),alias:k(e,"alias",""),type:k(e,"type",""),nullable:k(e,"nullable",!0),editable:k(e,"editable",!0),length:k(e,"length",null),domain:Q(k(e,"domain"))},b.layerDefinition.fields.push(e);if(f=k(f,"featureset",null)){a={};e=0;for(c=b.layerDefinition.fields;e<c.length;e++){var m=c[e];
a[m.name.toLowerCase()]=m.name}for(var r=0,h=k(f,"features",[]);r<h.length;r++){f=h[r];e={};c=k(f,"attributes",{});for(m in c)e[a[m.toLowerCase()]]=c[m];b.featureSet.features.push({attributes:e,geometry:R(k(f,"geometry",null))})}}}else{b.layerDefinition.geometryType=k(f,"geometrytype","");b.featureSet.geometryType=b.layerDefinition.geometryType;b.layerDefinition.objectIdField=k(f,"objectidfieldname","");b.layerDefinition.typeIdField=k(f,"typeidfieldname","");if(a=k(f,"spatialreference",null))b.layerDefinition.spatialReference=
L(a);a=0;for(c=k(f,"fields",[]);a<c.length;a++)e=c[a],e={name:k(e,"name",""),alias:k(e,"alias",""),type:k(e,"type",""),nullable:k(e,"nullable",!0),editable:k(e,"editable",!0),length:k(e,"length",null),domain:Q(k(e,"domain"))},b.layerDefinition.fields.push(e);a={};e=0;for(c=b.layerDefinition.fields;e<c.length;e++)m=c[e],a[m.name.toLowerCase()]=m.name;r=0;for(h=k(f,"features",[]);r<h.length;r++){f=h[r];e={};c=k(f,"attributes",{});for(m in c)e[a[m.toLowerCase()]]=c[m];b.featureSet.features.push({attributes:e,
geometry:R(k(f,"geometry",null))})}}}else throw Error("Invalid Parameter");if(b.layerDefinition&&b.featureSet){b:{m=0;for(f=" esriGeometryPoint esriGeometryPolyline esriGeometryPolygon esriGeometryMultipoint esriGeometryEnvelope".split(" ");m<f.length;m++)if(f[m]===b.layerDefinition.geometryType){m=!0;break b}m=!1}m=!1===m||null===b.layerDefinition.objectIdField||""===b.layerDefinition.objectIdField||!1===d.isArray(b.layerDefinition.fields)||!1===d.isArray(b.featureSet.features)?!1:!0}else m=!1;if(!1===
m)throw Error("Invalid Parameter");return W.create(b,g.spatialReference)})},b.signatures.push({name:"featureset",min:"1",max:"1"}),b.functions.filter=function(g,c){return b.standardFunctionAsync(g,c,function(c,f,a){d.pcCheck(a,2,2);return d.isFeatureSet(a[0])?a[0].load().then(function(d){var e=v.WhereClause.create(a[1],d.getFieldsIndex()),c=e.getVariables();if(0<c.length){d=[];for(var f=0;f<c.length;f++)d.push(b.evaluateIdentifier(g,{name:c[f]}));return u.all(d).then(function(b){for(var d={},h=0;h<
c.length;h++)d[c[h]]=b[h];e.parameters=d;return new O({parentfeatureset:a[0],whereclause:e})})}return u.resolve(new O({parentfeatureset:a[0],whereclause:e}))}):b.failDefferred("Filter cannot accept this parameter type")})},b.signatures.push({name:"filter",min:"2",max:"2"}),b.functions.orderby=function(g,c){return b.standardFunctionAsync(g,c,function(c,f,a){d.pcCheck(a,2,2);return d.isFeatureSet(a[0])?(c=new X(a[1]),u.resolve(new T({parentfeatureset:a[0],orderbyclause:c}))):b.failDefferred("Order cannot accept this parameter type")})},
b.signatures.push({name:"orderby",min:"2",max:"2"}),b.functions.top=function(g,c){return b.standardFunctionAsync(g,c,function(c,f,a){d.pcCheck(a,2,2);return d.isFeatureSet(a[0])?u.resolve(new U({parentfeatureset:a[0],topnum:a[1]})):d.isArray(a[0])?d.toNumber(a[1])>=a[0].length?a[0].slice(0):a[0].slice(0,d.toNumber(a[1])):d.isImmutableArray(a[0])?d.toNumber(a[1])>=a[0].length()?a[0].slice(0):a[0].slice(0,d.toNumber(a[1])):b.failDefferred("Top cannot accept this parameter type")})},b.signatures.push({name:"top",
min:"2",max:"2"}),b.functions.first=function(g,c){return b.standardFunctionAsync(g,c,function(b,c,a){d.pcCheck(a,1,1);return d.isFeatureSet(a[0])?a[0].first(b.abortSignal).then(function(b){if(null!==b){var d=A.createFromGraphicLikeObject(b.geometry,b.attributes,a[0]);d._underlyingGraphic=b;b=d}return b}):d.isArray(a[0])?0===a[0].length?u.resolve(null):u.resolve(a[0][0]):d.isImmutableArray(a[0])?0===a[0].length()?u.resolve(null):u.resolve(a[0].get(0)):null})},b.signatures.push({name:"first",min:"1",
max:"1"}),b.functions.attachments=function(g,c){return b.standardFunctionAsync(g,c,function(b,c,a){d.pcCheck(a,1,2);var e=-1,f=-1,m=null;if(1<a.length)if(a[1]instanceof M)a[1].hasField("minsize")&&(e=d.toNumber(a[1].field("minsize"))),a[1].hasField("maxsize")&&(f=d.toNumber(a[1].field("maxsize"))),a[1].hasField("types")&&(b=d.toStringArray(a[1].field("types"),!1),0<b.length&&(m=b));else if(null!==a[1])throw Error("Invalid Parameter");if(a[0]instanceof A){var r=a[0]._layer;r instanceof J&&(r=t.constructFeatureSet(r,
g.spatialReference,["*"],!0,g.lrucache));return null===r||!1===d.isFeatureSet(r)?[]:r.load().then(function(){return r.queryAttachments(a[0].field(r.objectIdField),e,f,m)})}if(null===a[0])return[];throw Error("Invalid Parameter");})},b.signatures.push({name:"attachments",min:"1",max:"2"}),b.functions.featuresetbyrelationshipname=function(g,c){return b.standardFunctionAsync(g,c,function(b,c,a){d.pcCheck(a,2,4);var e=a[0],f=d.toString(a[1]),m=d.defaultUndefined(a[2],null),r=d.toBoolean(d.defaultUndefined(a[3],
!0));null===m&&(m=["*"]);if(!1===d.isArray(m))throw Error("Invalid Parameter");if(null===a[0])return null;if(!(a[0]instanceof A))throw Error("Invalid Parameter");b=e._layer;b instanceof J&&(b=t.constructFeatureSet(b,g.spatialReference,["*"],!0,g.lrucache));return null===b||!1===d.isFeatureSet(b)?null:b.load().then(function(a){var b=a.relationshipMetaData().filter(function(b){return b.name===f});if(0===b.length)return null;if(void 0!==b[0].relationshipTableId&&null!==b[0].relationshipTableId&&-1<b[0].relationshipTableId)return t.constructFeatureSetFromRelationship(a,
b[0],e.field(a.objectIdField),a.spatialReference,m,r,g.lrucache);var d=a.serviceUrl();if(!d)return null;d="/"===d.charAt(d.length-1)?d+b[0].relatedTableId.toString():d+"/"+b[0].relatedTableId.toString();return t.constructFeatureSetFromUrl(d,a.spatialReference,m,r,g.lrucache).then(function(d){return d.load().then(function(){return d.relationshipMetaData()}).then(function(h){h=h.filter(function(a){return a.id===b[0].id});if(!1===e.hasField(b[0].keyField)||null===e.field(b[0].keyField))return a.getFeatureByObjectId(e.field(a.objectIdField),
[b[0].keyField]).then(function(a){if(a){var e=v.WhereClause.create(h[0].keyField+"\x3d @id",d.getFieldsIndex());e.parameters={id:a.attributes[b[0].keyField]};return d.filter(e)}return new V({parentfeatureset:d})});var c=v.WhereClause.create(h[0].keyField+"\x3d @id",d.getFieldsIndex());c.parameters={id:e.field(b[0].keyField)};return d.filter(c)})})})})},b.signatures.push({name:"featuresetbyrelationshipname",min:"2",max:"4"}),b.functions.featuresetbyassociation=function(g,c){return b.standardFunctionAsync(g,
c,function(b,c,a){d.pcCheck(a,2,3);var e=a[0],f=d.toString(d.defaultUndefined(a[1],"")).toLowerCase(),m=d.isString(a[2])?d.toString(a[2]):null;if(null===a[0])return null;if(!(a[0]instanceof A))throw Error("Invalid Parameter");var r=e._layer;r instanceof J&&(r=t.constructFeatureSet(r,g.spatialReference,["*"],!0,g.lrucache));return null===r||!1===d.isFeatureSet(r)?null:r.load().then(function(){var a=r.serviceUrl();return t.constructAssociationMetaDataFeatureSetFromUrl(a,g.spatialReference)}).then(function(a){var b=
null,c=null,h=!1;if(null!==m&&""!==m&&void 0!==m){for(var g=0,k=a.terminals;g<k.length;g++){var l=k[g];l.terminalName===m&&(c=l.terminalId)}null===c&&(h=!0)}for(var w=a.associations.getFieldsIndex(),g=w.get("TOGLOBALID").name,k=w.get("FROMGLOBALID").name,u=w.get("TOTERMINALID").name,t=w.get("FROMTERMINALID").name,x=w.get("FROMNETWORKSOURCEID").name,E=w.get("TONETWORKSOURCEID").name,z=w.get("ASSOCIATIONTYPE").name,l=w.get("ISCONTENTVISIBLE").name,A=w.get("OBJECTID").name,C=0,F=r.fields;C<F.length;C++){var q=
F[C];if("global-id"===q.type){b=e.field(q.name);break}}var B=null,C=new n.SqlExpressionAdapted(new D({name:"percentalong",alias:"percentalong",type:"double"}),v.WhereClause.create("0",a.associations.getFieldsIndex())),F=new n.SqlExpressionAdapted(new D({name:"side",alias:"side",type:"string"}),v.WhereClause.create("''",a.associations.getFieldsIndex())),q={},y;for(y in a.lkp)q[y]=a.lkp[y].sourceId;y=new n.StringToCodeAdapted(new D({name:"classname",alias:"classname",type:"string"}),null,q);q="";switch(f){case "midspan":q=
"(("+g+"\x3d'"+b+"') OR ( "+k+"\x3d'"+b+"')) AND ("+z+" IN (5))";y.codefield=v.WhereClause.create("CASE WHEN ("+g+"\x3d'"+b+"') THEN "+x+" ELSE "+E+" END",a.associations.getFieldsIndex());c=H.cloneField(n.AdaptedFeatureSet.findField(a.associations.fields,k));c.name="globalid";c.alias="globalid";B=new n.SqlExpressionAdapted(c,v.WhereClause.create("CASE WHEN ("+k+"\x3d'"+b+"') THEN "+g+" ELSE "+k+" END",a.associations.getFieldsIndex()));C=4<=a.unVersion?new n.OriginalField(n.AdaptedFeatureSet.findField(a.associations.fields,
w.get("PERCENTALONG").name)):new n.SqlExpressionAdapted(new D({name:"percentalong",alias:"percentalong",type:"double"}),v.WhereClause.create("0",a.associations.getFieldsIndex()));break;case "junctionedge":q="(("+g+"\x3d'"+b+"') OR ( "+k+"\x3d'"+b+"')) AND ("+z+" IN (4,6))";y.codefield=v.WhereClause.create("CASE WHEN ("+g+"\x3d'"+b+"') THEN "+x+" ELSE "+E+" END",a.associations.getFieldsIndex());c=H.cloneField(n.AdaptedFeatureSet.findField(a.associations.fields,k));c.name="globalid";c.alias="globalid";
B=new n.SqlExpressionAdapted(c,v.WhereClause.create("CASE WHEN ("+k+"\x3d'"+b+"') THEN "+g+" ELSE "+k+" END",a.associations.getFieldsIndex()));F=new n.SqlExpressionAdapted(new D({name:"side",alias:"side",type:"string"}),v.WhereClause.create("CASE WHEN ("+z+"\x3d4) THEN 'from' ELSE 'to' END",a.associations.getFieldsIndex()));break;case "connected":w=g+"\x3d'@T'";z=k+"\x3d'@T'";null!==c&&(w+=" AND "+u+"\x3d@A",z+=" AND "+t+"\x3d@A");q=d.multiReplace("(("+w+") OR ("+z+"))","@T",b);w=d.multiReplace(w,
"@T",b);null!==c&&(w=d.multiReplace(w,"@A",c.toString()),q=d.multiReplace(q,"@A",c.toString()));y.codefield=v.WhereClause.create("CASE WHEN "+w+(" THEN "+x+" ELSE "+E+" END"),a.associations.getFieldsIndex());b=H.cloneField(n.AdaptedFeatureSet.findField(a.associations.fields,k));b.name="globalid";b.alias="globalid";B=new n.SqlExpressionAdapted(b,v.WhereClause.create("CASE WHEN "+w+(" THEN "+k+" ELSE "+g+" END"),a.associations.getFieldsIndex()));break;case "container":q=g+"\x3d'"+b+"' AND "+z+" \x3d 2",
null!==c&&(q+=" AND "+u+" \x3d "+c.toString()),y.codefield=x,q="( "+q+" )",B=new n.FieldRename(n.AdaptedFeatureSet.findField(a.associations.fields,k),"globalid","globalid");case "content":q="("+k+"\x3d'"+b+"' AND "+z+" \x3d 2)";null!==c&&(q+=" AND "+t+" \x3d "+c.toString());y.codefield=E;q="( "+q+" )";B=new n.FieldRename(n.AdaptedFeatureSet.findField(a.associations.fields,g),"globalid","globalid");break;case "structure":q="("+g+"\x3d'"+b+"' AND "+z+" \x3d 3)";null!==c&&(q+=" AND "+u+" \x3d "+c.toString());
y.codefield=x;q="( "+q+" )";B=new n.FieldRename(n.AdaptedFeatureSet.findField(a.associations.fields,k),"globalid","globalId");break;case "attached":q="("+k+"\x3d'"+b+"' AND "+z+" \x3d 3)";null!==c&&(q+=" AND "+t+" \x3d "+c.toString());y.codefield=E;q="( "+q+" )";B=new n.FieldRename(n.AdaptedFeatureSet.findField(a.associations.fields,g),"globalid","globalId");break;default:throw Error("Invalid Parameter");}h&&(q="1 \x3c\x3e 1");return new n.AdaptedFeatureSet({parentfeatureset:a.associations,adaptedFields:[new n.OriginalField(n.AdaptedFeatureSet.findField(a.associations.fields,
A)),new n.OriginalField(n.AdaptedFeatureSet.findField(a.associations.fields,l)),B,F,y,C],extraFilter:q?v.WhereClause.create(q,a.associations.getFieldsIndex()):null})})})},b.signatures.push({name:"featuresetbyassociation",min:"2",max:"6"}),b.functions.groupby=function(g,c){return b.standardFunctionAsync(g,c,function(c,k,a){d.pcCheck(a,3,3);return d.isFeatureSet(a[0])?a[0].load().then(function(c){var e=[],k=[],f=!1,h=[];if(d.isString(a[1]))h.push(a[1]);else if(a[1]instanceof x)h.push(a[1]);else if(d.isArray(a[1]))h=
a[1];else if(d.isImmutableArray(a[1]))h=a[1].toArray();else return b.failDefferred("Illegal Value: GroupBy");for(var l=0,n=h;l<n.length;l++){var p=n[l];if(d.isString(p))h=v.WhereClause.create(d.toString(p),c.getFieldsIndex()),p=!0===P.isSingleField(h)?d.toString(p):"%%%%FIELDNAME",e.push({name:p,expression:h}),"%%%%FIELDNAME"===p&&(f=!0);else if(p instanceof x){var t=p.hasField("name")?p.field("name"):"%%%%FIELDNAME",h=p.hasField("expression")?p.field("expression"):"";"%%%%FIELDNAME"===t&&(f=!0);
if(!t)return b.failDefferred("Illegal Value: GroupBy");e.push({name:t,expression:v.WhereClause.create(h?h:t,c.getFieldsIndex())})}else return b.failDefferred("Illegal Value: GroupBy")}h=[];if(d.isString(a[2]))h.push(a[2]);else if(d.isArray(a[2]))h=a[2];else if(d.isImmutableArray(a[2]))h=a[2].toArray();else if(a[2]instanceof x)h.push(a[2]);else return b.failDefferred("Illegal Value: GroupBy");l=0;for(n=h;l<n.length;l++)if(p=n[l],p instanceof x){var t=p.hasField("name")?p.field("name"):"",A=p.hasField("statistic")?
p.field("statistic"):"",h=p.hasField("expression")?p.field("expression"):"";if(!t||!A||!h)return b.failDefferred("Illegal Value: GroupBy");k.push({name:t,statistic:A.toLowerCase(),expression:v.WhereClause.create(h,c.getFieldsIndex())})}else return b.failDefferred("Illegal Value: GroupBy");if(f){f={};h=0;for(p=c.fields;h<p.length;h++)c=p[h],f[c.name.toLowerCase()]=1;for(h=0;h<e.length;h++)c=e[h],"%%%%FIELDNAME"!==c.name&&(f[c.name.toLowerCase()]=1);for(h=0;h<k.length;h++)c=k[h],"%%%%FIELDNAME"!==c.name&&
(f[c.name.toLowerCase()]=1);for(p=h=0;p<e.length;p++)if(c=e[p],"%%%%FIELDNAME"===c.name){for(;1===f["field_"+h.toString()];)h++;f["field_"+h.toString()]=1;c.name="FIELD_"+h.toString()}}c=[];for(h=0;h<e.length;h++)f=e[h],c.push(K(f.expression,b,g));for(h=0;h<k.length;h++)f=k[h],c.push(K(f.expression,b,g));return 0<c.length?u.all(c).then(function(){return u.resolve(a[0].groupby(e,k))}):u.resolve(a[0].groupby(e,k))}):b.failDefferred("Illegal Value: GroupBy")})},b.signatures.push({name:"groupby",min:"3",
max:"3"}),b.functions.distinct=function(k,c){return b.standardFunctionAsync(k,c,function(c,f,a){return d.isFeatureSet(a[0])?(d.pcCheck(a,2,2),a[0].load().then(function(c){var e=[],f=[];if(d.isString(a[1]))f.push(a[1]);else if(a[1]instanceof x)f.push(a[1]);else if(d.isArray(a[1]))f=a[1];else if(d.isImmutableArray(a[1]))f=a[1].toArray();else return b.failDefferred("Illegal Value: GroupBy");for(var g=!1,h=0;h<f.length;h++){var l=f[h];if(d.isString(l)){var n=v.WhereClause.create(d.toString(l),c.getFieldsIndex()),
l=!0===P.isSingleField(n)?d.toString(l):"%%%%FIELDNAME";e.push({name:l,expression:n});"%%%%FIELDNAME"===l&&(g=!0)}else if(l instanceof x){var p=l.hasField("name")?l.field("name"):"%%%%FIELDNAME",n=l.hasField("expression")?l.field("expression"):"";"%%%%FIELDNAME"===p&&(g=!0);if(!p)return b.failDefferred("Illegal Value: GroupBy");e.push({name:p,expression:v.WhereClause.create(n?n:p,c.getFieldsIndex())})}else return b.failDefferred("Illegal Value: GroupBy")}if(g){g={};h=0;for(f=c.fields;h<f.length;h++)c=
f[h],g[c.name.toLowerCase()]=1;for(h=0;h<e.length;h++)c=e[h],"%%%%FIELDNAME"!==c.name&&(g[c.name.toLowerCase()]=1);for(f=h=0;f<e.length;f++)if(c=e[f],"%%%%FIELDNAME"===c.name){for(;1===g["field_"+h.toString()];)h++;g["field_"+h.toString()]=1;c.name="FIELD_"+h.toString()}}c=[];for(g=0;g<e.length;g++)c.push(K(e[g].expression,b,k));return 0<c.length?u.all(c).then(function(){return u.resolve(a[0].groupby(e,[]))}):u.resolve(a[0].groupby(e,[]))})):Y("distinct",c,f,a)})})}});