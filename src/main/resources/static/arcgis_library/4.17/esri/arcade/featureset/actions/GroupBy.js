// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.17/esri/copyright.txt for details.
//>>built
define("require exports tslib ../../../Graphic ../../languageUtils ./Adapted ./AttributeFilter ./OrderBy ../support/FeatureSet ../support/IdSet ../support/OrderbyClause ../support/shared ../support/sqlUtils ../support/sqlUtils ../support/stats ../support/StatsField ../../../core/MD5 ../../../core/promiseUtils ../../../core/sql/WhereClause ../../../geometry/SpatialReference ../../../layers/support/Field ../../../layers/support/FieldsIndex".split(" "),function(J,K,B,w,C,r,D,E,x,q,F,m,t,k,n,y,z,h,p,
G,u,H){function I(h){if(!h)return"COUNT";switch(h.toLowerCase()){case "max":return"MAX";case "var":case "variance":return"VAR";case "avg":case "average":case "mean":return"AVG";case "min":return"MIN";case "sum":return"SUM";case "stdev":case "stddev":return"STDDEV"}return"COUNT"}return function(A){function g(b){var a=A.call(this,b)||this;a._decodedStatsfield=[];a._decodedGroupbyfield=[];a._candosimplegroupby=!0;a.phsyicalgroupbyfields=[];a.objectIdField="ROW__ID";a._internalObjectIdField="ROW__ID";
a._adaptedFields=[];a.declaredClass="esri.arcade.featureset.actions.Aggregate";a._uniqueIds=1;a._maxQuery=10;a._maxProcessing=10;a._parent=b.parentfeatureset;a._config=b;return a}B.__extends(g,A);g.prototype.isTable=function(){return!0};g.prototype._getSet=function(b){var a=this;return null===this._wset?this._getFilteredSet("",null,null,null,b).then(function(b){a._wset=b;return a._wset}):h.resolve(this._wset)};g.prototype._isInFeatureSet=function(){return m.IdState.InFeatureSet};g.prototype.nextUniqueName=
function(b){for(;1===b["T"+this._uniqueIds.toString()];)this._uniqueIds++;var a="T"+this._uniqueIds.toString();b[a]=1;return a};g.prototype.convertToEsriFieldType=function(b){return b};g.prototype._initialiseFeatureSet=function(){var b={},a=!1,e=1,c=this._parent?this._parent.getFieldsIndex():new H([]);for(this.objectIdField="ROW__ID";!1===a;){for(var f=!1,d=0;d<this._config.groupbyfields.length;d++)if(this._config.groupbyfields[d].name.toLowerCase()===this.objectIdField.toLowerCase()){f=!0;break}if(!1===
f)for(d=0;d<this._config.statsfields.length;d++)if(this._config.statsfields[d].name.toLowerCase()===this.objectIdField.toLowerCase()){f=!0;break}!1===f?a=!0:(this.objectIdField="ROW__ID"+e.toString(),e++)}a=0;for(e=this._config.statsfields;a<e.length;a++)d=e[a],f=new y,f.field=d.name,f.tofieldname=d.name,f.workingexpr=d.expression instanceof p.WhereClause?d.expression:p.WhereClause.create(d.expression,c),f.typeofstat=I(d.statistic),this._decodedStatsfield.push(f);this._decodedGroupbyfield=[];a=0;
for(e=this._config.groupbyfields;a<e.length;a++)d=e[a],d={name:d.name,singlefield:null,tofieldname:d.name,expression:d.expression instanceof p.WhereClause?d.expression:p.WhereClause.create(d.expression,c)},this._decodedGroupbyfield.push(d);if(null!==this._parent){this.geometryType=this._parent.geometryType;this.spatialReference=this._parent.spatialReference;this.hasM=this._parent.hasM;this.hasZ=this._parent.hasZ;this.typeIdField="";c=0;for(a=this._parent.fields;c<a.length;c++)d=a[c],b[d.name.toUpperCase()]=
1;this.types=null}else this.geometryType=m.layerGeometryEsriConstants.point,this.typeIdField="",this.types=null,this.spatialReference=new G({wkid:4326});this.fields=[];c=new y;c.field=this.nextUniqueName(b);c.tofieldname=this.objectIdField;c.workingexpr=p.WhereClause.create(this._parent.objectIdField,this._parent.getFieldsIndex());c.typeofstat="MIN";this._decodedStatsfield.push(c);d=0;for(e=this._decodedGroupbyfield;d<e.length;d++){a=e[d];c=new u;a.name=this.nextUniqueName(b);c.name=a.tofieldname;
c.alias=c.name;if(t.isSingleField(a.expression)){f=this._parent.getField(k.toWhereClause(a.expression,m.FeatureServiceDatabaseType.Standardised));if(!f)throw Error("Field is not present for Aggregation");a.name=f.name;a.singlefield=f.name;this.phsyicalgroupbyfields.push(f.name);c.type=f.type}else c.type=this.convertToEsriFieldType(k.predictType(a.expression,this._parent.fields)),f=new u,f.name=a.name,f.alias=f.name,this.phsyicalgroupbyfields.push(a.name),this._adaptedFields.push(new r.SqlExpressionAdapted(f,
a.expression)),this._candosimplegroupby=!1;this.fields.push(c)}if(0<this._adaptedFields.length)for(c=0,a=this._parent.fields;c<a.length;c++)d=a[c],this._adaptedFields.push(new r.OriginalField(d));for(d=0;d<this._decodedStatsfield.length;d++){c=new u;f=null;a=this._decodedStatsfield[d];a.field=this.nextUniqueName(b);a.tofieldname===this.objectIdField&&(this._internalObjectIdField=a.field);c.name=a.tofieldname;c.alias=c.name;a=null!==a.workingexpr?t.isSingleField(a.workingexpr)?k.toWhereClause(a.workingexpr,
m.FeatureServiceDatabaseType.Standardised):"":"";switch(this._decodedStatsfield[d].typeofstat){case "SUM":if(""!==a){f=this._parent.getField(a);if(!f)throw Error("Field is not present for Aggregation");c.type=f.type}else c.type="double";break;case "MIN":case "MAX":if(""!==a){f=this._parent.getField(a);if(!f)throw Error("Field is not present for Aggregation");c.type=f.type}else c.type="double";break;case "COUNT":c.type="integer";break;case "STDDEV":case "VAR":case "AVG":if(""!==a&&(f=this._parent.getField(a),
!f))throw Error("Field is not present for Aggregation");c.type="double"}this.fields.push(c)}};g.prototype._canDoAggregates=function(){return h.resolve(!1)};g.prototype._getFeatures=function(b,a,e,c){var f=this,d=[];-1!==a&&void 0===this._featureCache[a]&&d.push(a);d=this._maxQuery;return!0===this._checkIfNeedToExpandKnownPage(b,d)?this._expandPagedSet(b,d,0,0,c).then(function(){return f._getFeatures(b,a,e,c)}):h.resolve("success")};g.prototype._getFilteredSet=function(b,a,e,c,f){var d=this;if(""!==
b)return h.resolve(new q([],[],!0,null));var g=null,l=!1,v=!1;return this._ensureLoaded().then(function(){if(null!==e)for(var a=0;a<d._decodedStatsfield.length;a++)if(!0===t.scanForField(e,d._decodedStatsfield[a].tofieldname)){v=!0;e=null;break}if(null!==c){l=!0;for(a=0;a<d._decodedStatsfield.length;a++)if(!0===c.scanForField(d._decodedStatsfield[a].tofieldname)){c=null;l=!1;break}if(null!==c)for(var a=0,b=d._decodedGroupbyfield;a<b.length;a++){var f=b[a];if(null===f.singlefield&&!0===c.scanForField(f.tofieldname)){c=
null;l=!1;break}}}return!1===d._candosimplegroupby?h.resolve(!1):d._parent._canDoAggregates(d.phsyicalgroupbyfields,d._decodedStatsfield,"",null,null)}).then(function(a){if(a){a=null;e&&(a=d._reformulateWhereClauseWithoutGroupByFields(e));var b=null;c&&(b=d._reformulateOrderClauseWithoutGroupByFields(c));return d._parent._getAggregatePagesDataSourceDefinition(d.phsyicalgroupbyfields,d._decodedStatsfield,"",null,a,b,d._internalObjectIdField).then(function(a){d._checkCancelled(f);return g=!0===v?new q(a._candidates.slice(0).concat(a._known.slice(0)),
[],!0===l?a._ordered:!1,d._clonePageDefinition(a.pagesDefinition)):new q(a._candidates.slice(0),a._known.slice(0),!0===l?a._ordered:!1,d._clonePageDefinition(a.pagesDefinition))})}a=d._parent;0<d._adaptedFields.length&&(a=new r.AdaptedFeatureSet({parentfeatureset:d._parent,adaptedFields:d._adaptedFields,extraFilter:null}));!0!==v&&null!==e&&(b=null,e&&(b=d._reformulateWhereClauseWithoutGroupByFields(e)),a=new D({parentfeatureset:a,whereclause:b}));return g=new q(["GETPAGES"],[],!1,{aggregatefeaturesetpagedefinition:!0,
resultOffset:0,resultRecordCount:d._maxQuery,internal:{fullyResolved:!1,workingItem:null,type:"manual",iterator:null,set:[],subfeatureset:new E({parentfeatureset:a,orderbyclause:new F(d.phsyicalgroupbyfields.join(",")+","+d._parent.objectIdField+" ASC")})}})})};g.prototype._reformulateWhereClauseWithoutStatsFields=function(b){for(var a=0,e=this._decodedStatsfield;a<e.length;a++){var c=e[a];b=k.reformulateWithoutField(b,c.tofieldname,k.toWhereClause(c.workingexpr,m.FeatureServiceDatabaseType.Standardised),
this._parent.getFieldsIndex())}return b};g.prototype._reformulateWhereClauseWithoutGroupByFields=function(b){for(var a=0,e=this._decodedGroupbyfield;a<e.length;a++){var c=e[a];c.tofieldname!==c.name&&(b=k.reformulateWithoutField(b,c.tofieldname,k.toWhereClause(c.expression,m.FeatureServiceDatabaseType.Standardised),this._parent.getFieldsIndex()))}return b};g.prototype._reformulateOrderClauseWithoutGroupByFields=function(b){for(var a=[],e=0,c=this._decodedGroupbyfield;e<c.length;e++){var f=c[e];f.tofieldname!==
f.name&&a.push({field:f.tofieldname,newfield:f.name})}return 0<a.length?b.replaceFields(a):b};g.prototype._clonePageDefinition=function(b){return null===b?null:!0===b.aggregatefeaturesetpagedefinition?{aggregatefeaturesetpagedefinition:!0,resultRecordCount:b.resultRecordCount,resultOffset:b.resultOffset,internal:b.internal}:this._parent._clonePageDefinition(b)};g.prototype._refineSetBlock=function(b,a,e){var c=this;try{if(!0===this._checkIfNeedToExpandCandidatePage(b,this._maxQuery))return this._expandPagedSet(b,
this._maxQuery,0,0,e).then(function(){return c._refineSetBlock(b,a,e)});this._checkCancelled(e);this._refineKnowns(b,a);return h.resolve(b)}catch(f){return h.reject(f)}};g.prototype._expandPagedSet=function(b,a,e,c,f){return this._expandPagedSetFeatureSet(b,a,e,c,f)};g.prototype._getPhysicalPage=function(b,a,e){var c=this;return!0===b.pagesDefinition.aggregatefeaturesetpagedefinition?h.create(function(a,d){c._sequentialGetPhysicalItem(b,b.pagesDefinition.resultRecordCount,e,[]).then(function(c){a(c)},
d)}):this._getAgregagtePhysicalPage(b,a,e).then(function(a){for(var b=0;b<a.length;b++){for(var f=a[b],e={geometry:f.geometry,attributes:{}},g=0,h=c._decodedGroupbyfield;g<h.length;g++){var k=h[g];e.attributes[k.tofieldname]=f.attributes[k.name]}g=0;for(h=c._decodedStatsfield;g<h.length;g++)k=h[g],e.attributes[k.tofieldname]=f.attributes[k.field];c._featureCache[e.attributes[c.objectIdField]]=new w(e)}return a.length})};g.prototype._sequentialGetPhysicalItem=function(b,a,e,c){var f=this;return h.create(function(d,
g){null===b.pagesDefinition.internal.iterator&&(b.pagesDefinition.internal.iterator=b.pagesDefinition.internal.subfeatureset.iterator(e));!0===b.pagesDefinition.internal.fullyResolved?d(c.length):0===a?d(c.length):f._nextAggregateItem(b,a,e,c,function(g){null===g?d(c.length):(--a,d(f._sequentialGetPhysicalItem(b,a,e,c)))},g)})};g.prototype._nextAggregateItem=function(b,a,e,c,f,d){var g=this;try{C.tick(b.pagesDefinition.internal.iterator.next()).then(function(h){if(null===h){if(null!==b.pagesDefinition.internal.workingItem){var k=
g._calculateAndAppendAggregateItem(b.pagesDefinition.internal.workingItem);c.push(k);b.pagesDefinition.internal.workingItem=null;b.pagesDefinition.internal.set.push(k.attributes[g.objectIdField])}b.pagesDefinition.internal.fullyResolved=!0;f(null)}else{var l=g._generateAggregateHash(h);if(null===b.pagesDefinition.internal.workingItem)b.pagesDefinition.internal.workingItem={features:[h],id:l};else{if(l!==b.pagesDefinition.internal.workingItem.id){k=g._calculateAndAppendAggregateItem(b.pagesDefinition.internal.workingItem);
c.push(k);b.pagesDefinition.internal.workingItem=null;b.pagesDefinition.internal.set.push(k.attributes[g.objectIdField]);--a;b.pagesDefinition.internal.workingItem={features:[h],id:l};f(k);return}b.pagesDefinition.internal.workingItem.features.push(h)}g._nextAggregateItem(b,a,e,c,f,d)}},d)}catch(l){d(l)}};g.prototype._calculateFieldStat=function(b,a,e){for(var c=[],f=0;f<b.features.length;f++)if(null!==a.workingexpr){var d=a.workingexpr.calculateValue(b.features[f]);null!==d&&c.push(d)}else c.push(null);
switch(a.typeofstat){case "MIN":e.attributes[a.tofieldname]=n.calculateStat("min",c,-1);break;case "MAX":e.attributes[a.tofieldname]=n.calculateStat("max",c,-1);break;case "SUM":e.attributes[a.tofieldname]=n.calculateStat("sum",c,-1);break;case "COUNT":e.attributes[a.tofieldname]=c.length;break;case "VAR":e.attributes[a.tofieldname]=n.calculateStat("var",c,-1);break;case "STDDEV":e.attributes[a.tofieldname]=n.calculateStat("stddev",c,-1);break;case "AVG":e.attributes[a.tofieldname]=n.calculateStat("avg",
c,-1)}return!0};g.prototype._calculateAndAppendAggregateItem=function(b){for(var a={attributes:{},geometry:null},e=0,c=this._decodedGroupbyfield;e<c.length;e++){var f=c[e],d=f.singlefield?b.features[0].attributes[f.singlefield]:f.expression.calculateValue(b.features[0]);a.attributes[f.tofieldname]=d}e=0;for(c=this._decodedStatsfield;e<c.length;e++)this._calculateFieldStat(b,c[e],a);e=[];for(c=0;c<this._decodedStatsfield.length;c++)e.push(this._calculateFieldStat(b,this._decodedStatsfield[c],a));this._featureCache[a.attributes[this.objectIdField]]=
new w({attributes:a.attributes,geometry:a.geometry});return a};g.prototype._generateAggregateHash=function(b){for(var a="",e=0,c=this._decodedGroupbyfield;e<c.length;e++)var f=c[e],f=f.singlefield?b.attributes[f.singlefield]:f.expression.calculateValue(b),a=null===f||void 0===f?a+":":a+(":"+f.toString());return z.createMD5Hash(a,z.outputTypes.String)};g.prototype._stat=function(){return h.resolve({calculated:!1})};g.prototype.getFeatureByObjectId=function(){return h.resolve(null)};g.registerAction=
function(){x._featuresetFunctions.groupby=function(b,a){return new g({parentfeatureset:this,groupbyfields:b,statsfields:a})}};return g}(x)});