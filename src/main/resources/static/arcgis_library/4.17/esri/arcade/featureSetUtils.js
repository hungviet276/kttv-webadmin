// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.17/esri/copyright.txt for details.
//>>built
define("require exports tslib ../request ./featureSetCollection ./featureset/actions/AttributeFilter ./featureset/actions/GroupBy ./featureset/actions/OrderBy ./featureset/actions/SpatialFilter ./featureset/actions/Top ./featureset/sources/FeatureLayerDynamic ./featureset/sources/FeatureLayerMemory ./featureset/sources/FeatureLayerRelated ./featureset/support/cache ./featureset/support/shared ../core/promiseUtils ../core/sql/WhereClause ../layers/FeatureLayer ../portal/Portal ../portal/PortalItem".split(" "),
function(S,l,t,v,y,C,D,E,F,G,H,I,J,h,z,p,K,q,L,M){function w(d,b){if(h.applicationCache){var c=h.applicationCache.getLayerInfo(d);if(c)return c.then(function(a){return p.resolve(new q({url:d,outFields:b,sourceJSON:a}))});var f=new q({url:d,outFields:b}),c=p.create(function(a,c){f.load().then(function(){a(f.sourceJSON)},function(a){c(a)})});h.applicationCache&&(h.applicationCache.setLayerInfo(d,c),c=c.catch(function(a){h.applicationCache.clearLayerInfo(d);throw a;}));return c.then(function(){return p.resolve(f)})}return p.resolve(new q({url:d,
outFields:b}))}function x(d,b,c,f,a){return w(d,["*"]).then(function(d){return p.resolve(u(d,b,c,f,a))})}function u(d,b,c,f,a){void 0===b&&(b=null);void 0===c&&(c=null);void 0===f&&(f=!0);void 0===a&&(a=null);return!0===d._hasMemorySource()?new I({layer:d,spatialReference:b,outFields:c,includeGeometry:f,lrucache:a}):new H({layer:d,spatialReference:b,outFields:c,includeGeometry:f,lrucache:a})}function N(d){if(null!==h.applicationCache){var b=h.applicationCache.getLayerInfo(d);if(null!==b)return b}b=
v(d,{responseType:"json",query:{f:"json"}}).then(function(c){return c.data?p.resolve(c.data):p.resolve(null)});null!==h.applicationCache&&(h.applicationCache.setLayerInfo(d,b),b=b.catch(function(c){h.applicationCache.clearLayerInfo(d);throw c;}));return b}function O(d,b){var c="QUERYDATAELEMTS:"+b.toString()+":"+d;if(null!==h.applicationCache){var f=h.applicationCache.getLayerInfo(c);if(null!==f)return f}d=v(d+"/queryDataElements",{method:"post",responseType:"json",query:{layers:JSON.stringify([b.toString()]),
f:"json"}}).then(function(a){if(a.data&&(a=a.data,a.layerDataElements&&a.layerDataElements[0]))return a.layerDataElements[0];throw Error("Not Found");});null!==h.applicationCache&&(h.applicationCache.setLayerInfo(c,d),d=d.catch(function(a){h.applicationCache.clearLayerInfo(c);throw a;}));return d}function B(d){if(null!==h.applicationCache){var b=h.applicationCache.getLayerInfo(d);if(null!==b)return b}b=v(d,{responseType:"json",query:{f:"json"}}).then(function(c){return c.data?(c=c.data,c.layers||
(c.layers=[]),c.tables||(c.tables=[]),p.resolve(c)):p.resolve({layers:[],tables:[]})});null!==h.applicationCache&&(h.applicationCache.setLayerInfo(d,b),b=b.catch(function(c){h.applicationCache.clearLayerInfo(d);throw c;}));return b}Object.defineProperty(l,"__esModule",{value:!0});l.constructFeatureSetFromPortalItem=l.getPortal=l.createFeatureSetCollectionFromService=l.createFeatureSetCollectionFromMap=l.constructFeatureSetFromRelationship=l.constructAssociationMetaDataFeatureSetFromUrl=l.constructFeatureSet=
l.constructFeatureSetFromUrl=l.initialiseMetaDataCache=void 0;C.registerAction();D.registerAction();E.registerAction();F.registerAction();G.registerAction();l.initialiseMetaDataCache=function(){null===h.applicationCache&&(h.applicationCache=new h)};l.constructFeatureSetFromUrl=x;l.constructFeatureSet=u;l.constructAssociationMetaDataFeatureSetFromUrl=function(d,b){var c=3,f=[],a=null,r={},h=null;return B(d).then(function(e){if(e.controllerDatasetLayers&&void 0!==e.controllerDatasetLayers.utilityNetworkLayerId&&
null!==e.controllerDatasetLayers.utilityNetworkLayerId){if(e.layers)for(var k=0,g=e.layers;k<g.length;k++){var m=g[k];r[m.id]=m.name}if(e.tables)for(k=0,g=e.tables;k<g.length;k++)m=g[k],r[m.id]=m.name;var A=e.controllerDatasetLayers.utilityNetworkLayerId;return O(d,A).then(function(g){if(g){(a=g)&&a.dataElement&&void 0!==a.dataElement.schemaGeneration&&(c=a.dataElement.schemaGeneration);h={};a.dataElement.domainNetworks||(a.dataElement.domainNetworks=[]);g=0;for(var e=a.dataElement.domainNetworks;g<
e.length;g++){for(var m=e[g],k=0,l=m.edgeSources?m.edgeSources:[];k<l.length;k++){var n=l[k],n={layerId:n.layerId,sourceId:n.sourceId,className:r[n.layerId]?r[n.layerId]:null};n.className&&(h[n.className]=n)}k=0;for(m=m.junctionSources?m.junctionSources:[];k<m.length;k++)n=m[k],n={layerId:n.layerId,sourceId:n.sourceId,className:r[n.layerId]?r[n.layerId]:null},n.className&&(h[n.className]=n)}if(a.dataElement.terminalConfigurations)for(g=0,e=a.dataElement.terminalConfigurations;g<e.length;g++)for(m=
0,n=e[g].terminals;m<n.length;m++)k=n[m],f.push({terminalId:k.terminalId,terminalName:k.terminalName});return N(d+"/"+A).then(function(a){if(a.systemLayers&&void 0!==a.systemLayers.associationsTableId&&null!==a.systemLayers.associationsTableId){var g=[];4<=c&&(g.push("STATUS"),g.push("PERCENTALONG"));return x(d+"/"+a.systemLayers.associationsTableId.toString(),b,t.__spreadArrays("OBJECTID FROMNETWORKSOURCEID TONETWORKSOURCEID FROMGLOBALID TOGLOBALID TOTERMINALID FROMTERMINALID ASSOCIATIONTYPE ISCONTENTVISIBLE GLOBALID".split(" "),
g),!1,null).then(function(a){return a.load()}).then(function(a){return 4<=c?(a=a.filter(K.WhereClause.create("STATUS NOT IN (1, 2, 3, 4, 5, 6, 7, 9, 10, 11, 12, 13, 14, 15, 17, 18, 19, 20, 21, 22, 23, 25, 26, 27, 28, 29, 30, 31, 33, 34, 35, 36, 37, 38, 39, 41, 42, 43, 44, 45, 46, 47, 49, 50, 51, 52, 53, 54, 55, 57, 58, 59, 60, 61, 62,63)",a.getFieldsIndex())),a.load()):a}).then(function(a){return{lkp:h,associations:a,unVersion:c,terminals:f}})}return{associations:null,unVersion:c,lkp:null,terminals:[]}})}return{associations:null,
unVersion:c,lkp:null,terminals:[]}})}return{associations:null,unVersion:c,lkp:null,terminals:[]}})};l.constructFeatureSetFromRelationship=function(d,b,c,f,a,r,h){void 0===f&&(f=null);void 0===a&&(a=null);void 0===r&&(r=!0);void 0===h&&(h=null);var e=d.serviceUrl();if(!e)return null;e="/"===e.charAt(e.length-1)?e+b.relatedTableId.toString():e+"/"+b.relatedTableId.toString();return x(e,f,a,r,h).then(function(e){return new J({layer:d,relatedLayer:e,relationship:b,objectId:c,spatialReference:f,outFields:a,
includeGeometry:r,lrucache:h})})};var Q=function(d){function b(c,f,a){void 0===f&&(f=null);void 0===a&&(a=null);var b=d.call(this)||this;b._map=c;b._overridespref=f;b.lrucache=a;b._instantLayers=[];return b}t.__extends(b,d);b.prototype.makeAndAddFeatureSet=function(c,f,a){void 0===f&&(f=!0);void 0===a&&(a=null);var b=u(c,this._overridespref,null===a?["*"]:a,f,this.lrucache);this._instantLayers.push({featureset:b,opitem:c,includeGeometry:f,outFields:JSON.stringify(a)});return b};b.prototype.featureSetByName=
function(c,b,a){var f=this;void 0===b&&(b=!0);void 0===a&&(a=null);if(void 0!==this._map.loaded&&void 0!==this._map.load&&!1===this._map.loaded)return this._map.load().then(function(){try{return f.featureSetByName(c,b,a)}catch(m){return p.reject(m)}});null===a&&(a=["*"]);a=a.slice(0);a=a.sort();for(var d=JSON.stringify(a),e=0;e<this._instantLayers.length;e++){var k=this._instantLayers[e];if(k.opitem.title===c&&k.includeGeometry===b&&k.outFields===d)return this.resolvePromise(this._instantLayers[e].featureset)}if(d=
this._map.layers.find(function(a){return a instanceof q&&a.title===c?!0:!1}))return this.resolvePromise(this.makeAndAddFeatureSet(d,b,a));if(this._map.tables){var g=this._map.tables.find(function(a){return a.title&&a.title===c||a.title&&a.title===c?!0:!1});if(g){if(g instanceof q)return this.resolvePromise(this.makeAndAddFeatureSet(g,b,a));g._materializedTable||(d=g.outFields?g:t.__assign(t.__assign({},g),{outFields:["*"]}),g._materializedTable=new q(d));return g._materializedTable.load().then(function(){return f.resolvePromise(f.makeAndAddFeatureSet(g._materializedTable,
b,a))})}}return this.resolvePromise(null)};b.prototype.featureSetById=function(c,b,a){var d=this;void 0===b&&(b=!0);void 0===a&&(a=["*"]);if(void 0!==this._map.loaded&&void 0!==this._map.load&&!1===this._map.loaded)return this._map.load().then(function(){try{return d.featureSetById(c,b,a)}catch(m){return p.reject(m)}});null===a&&(a=["*"]);a=a.slice(0);a=a.sort();for(var f=JSON.stringify(a),e=0;e<this._instantLayers.length;e++){var k=this._instantLayers[e];if(k.opitem.id===c&&k.includeGeometry===b&&
k.outFields===f)return this.resolvePromise(this._instantLayers[e].featureset)}if(f=this._map.layers.find(function(a){return a instanceof q&&a.id===c?!0:!1}))return this.resolvePromise(this.makeAndAddFeatureSet(f,b,a));if(this._map.tables){var g=this._map.tables.find(function(a){return a.id===c?!0:!1});if(g){if(g instanceof q)return this.resolvePromise(this.makeAndAddFeatureSet(g,b,a));g._materializedTable||(f=t.__assign(t.__assign({},g),{outFields:["*"]}),g._materializedTable=new q(f));return g._materializedTable.load().then(function(){return d.resolvePromise(d.makeAndAddFeatureSet(g._materializedTable,
b,a))})}}return this.resolvePromise(null)};return b}(y),R=function(d){function b(c,b,a){void 0===b&&(b=null);void 0===a&&(a=null);var f=d.call(this)||this;f._url=c;f._overridespref=b;f.lrucache=a;f.metadata=null;f._instantLayers=[];return f}t.__extends(b,d);Object.defineProperty(b.prototype,"url",{get:function(){return this._url},enumerable:!1,configurable:!0});b.prototype.makeAndAddFeatureSet=function(c,b,a){void 0===b&&(b=!0);void 0===a&&(a=null);var d=u(c,this._overridespref,null===a?["*"]:a,b,
this.lrucache);this._instantLayers.push({featureset:d,opitem:c,includeGeometry:b,outFields:JSON.stringify(a)});return d};b.prototype._loadMetaData=function(){var b=this;return B(this._url).then(function(c){return b.metadata=c})};b.prototype.load=function(){return this._loadMetaData()};b.prototype.clone=function(){return new b(this._url,this._overridespref,this.lrucache)};b.prototype.featureSetByName=function(b,d,a){var c=this;void 0===d&&(d=!0);void 0===a&&(a=null);null===a&&(a=["*"]);a=a.slice(0);
a=a.sort();for(var f=JSON.stringify(a),e=0;e<this._instantLayers.length;e++){var k=this._instantLayers[e];if(k.opitem.title===b&&k.includeGeometry===d&&k.outFields===f)return this.resolvePromise(this._instantLayers[e].featureset)}return this._loadMetaData().then(function(g){for(var f=null,e=0,k=g.layers?g.layers:[];e<k.length;e++){var h=k[e];h.name===b&&(f=h)}if(!f)for(e=0,g=g.tables?g.tables:[];e<g.length;e++)h=g[e],h.name===b&&(f=h);return f?w(c._url+"/"+f.id,["*"]).then(function(b){return c.makeAndAddFeatureSet(b,
d,a)}):c.resolvePromise(null)})};b.prototype.featureSetById=function(b,d,a){var c=this;void 0===d&&(d=!0);void 0===a&&(a=["*"]);null===a&&(a=["*"]);a=a.slice(0);a=a.sort();var f=JSON.stringify(a);b=null!==b&&void 0!==b?b.toString():"";for(var e=0;e<this._instantLayers.length;e++){var h=this._instantLayers[e];if(h.opitem.id===b&&h.includeGeometry===d&&h.outFields===f)return this.resolvePromise(this._instantLayers[e].featureset)}return this._loadMetaData().then(function(g){for(var f=null,e=0,h=g.layers?
g.layers:[];e<h.length;e++){var k=h[e];null!==k.id&&void 0!==k.id&&k.id.toString()===b&&(f=k)}if(!f)for(e=0,g=g.tables?g.tables:[];e<g.length;e++)k=g[e],null!==k.id&&void 0!==k.id&&k.id.toString()===b&&(f=k);return f?w(c._url+"/"+f.id,["*"]).then(function(b){return c.makeAndAddFeatureSet(b,d,a)}):c.resolvePromise(null)})};return b}(y);l.createFeatureSetCollectionFromMap=function(d,b,c){void 0===c&&(c=null);return new Q(d,b,c)};l.createFeatureSetCollectionFromService=function(d,b,c){void 0===c&&(c=
null);return new R(d,b,c)};l.getPortal=function(d,b){return null===d?b:new L({url:d.field("url")})};l.constructFeatureSetFromPortalItem=function(d,b,c,f,a,l,t){if(h.applicationCache){var e=h.applicationCache.getLayerInfo(d+":"+l.url);if(e)return e.then(function(d){try{var e=new q({url:z.extractServiceUrl(d.url)+"/"+b,outFields:["*"]});return p.resolve(u(e,c,f,a,t))}catch(m){return p.reject(m)}},function(a){return p.reject(a)})}return p.create(function(e,g){var k=(new M({id:d,portal:l})).load();h.applicationCache&&
h.applicationCache.setLayerInfo(d+":"+l.url,k);k.then(function(d){try{var h=new q({url:z.extractServiceUrl(d.url)+"/"+b,outFields:["*"]});e(u(h,c,f,a,t))}catch(P){g(P)}},function(a){h.applicationCache&&h.applicationCache.clearLayerInfo(d+":"+l.url);g(a)})})}});