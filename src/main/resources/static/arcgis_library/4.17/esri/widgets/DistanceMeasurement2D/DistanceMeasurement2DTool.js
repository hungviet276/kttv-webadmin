// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.17/esri/copyright.txt for details.
//>>built
define("require exports tslib ../../geometry ../../Graphic ../../intl ../../symbols ../../core/Handles ../../core/unitFormatUtils ../../core/unitUtils ../../core/watchUtils ../../core/accessorSupport/decorators ../../geometry/geometryEngine ../../geometry/projection ../../geometry/support/geodesicUtils ../../layers/GraphicsLayer ../../layers/GroupLayer ../../views/2d/draw/Draw ../../views/interactive/dragEventPipeline ../../views/interactive/GraphicManipulator ../../views/interactive/InteractiveToolBase".split(" "),
function(w,g,d,n,p,q,x,C,r,D,y,h,t,l,e,z,E,F,u,G,H){function I(c,a,b,f){var J=new x.SimpleMarkerSymbol({style:"circle",color:f.handleColor,size:f.handleWidth,outline:{type:"simple-line",width:0}});f=new x.SimpleMarkerSymbol({style:"circle",color:f.handleColor,size:1.5*f.handleWidth,outline:{type:"simple-line",width:0}});c=new p({geometry:c,symbol:J});return new G.GraphicManipulator({view:a,layer:b,graphic:c,focusedSymbol:f})}function A(c,a,b){c=new n.Polyline({paths:[c],spatialReference:a});if(a.isGeographic)if(e.isSupported(a))b=
e.geodesicLengths([c],"meters")[0],a=e.geodesicDensify(c,1E5);else{b=l.project(c,n.SpatialReference.WGS84);var f=e.geodesicDensify(b,1E5);b=e.geodesicLengths([b],"meters")[0];a=l.project(f,a)}else a.isWebMercator?(b=t.geodesicLength(c,"meters"),a=t.geodesicDensify(c,1E5,"meters")):(f=t.planarLength(c,"meters"),f>=b?(b=l.project(c,n.SpatialReference.WGS84),f=e.geodesicDensify(b,1E5),b=e.geodesicLengths([b],"meters")[0],a=l.project(f,a)):(b=f,a=c));return{measurement:{geometry:a,length:b},original:c,
drawing:a}}function v(c){if(!c)return!1;var a=c.isGeographic,b=c.isWebMercator,f=c.isWGS84;return a&&!f&&!e.isSupported(c)||!a&&!b}function B(c,a,b){if(!a||!c)return null;switch(b){case "metric":return r.formatMetricLength(c,a.length,"meters");case "imperial":return r.formatImperialLength(c,a.length,"meters");default:return r.formatDecimal(c,D.convertUnit(a.length,"meters",b),b)}}Object.defineProperty(g,"__esModule",{value:!0});g.createDistanceMeasurementLabel=g.isSupported=g.createDistanceMeasurementInfo2D=
void 0;w=function(c){function a(){var b=null!==c&&c.apply(this,arguments)||this;b._drawActive=!1;b._handles=new C;b._polylineLayer=new z;b._manipulatorLayer=new z;b._groupLayer=new E({layers:[b._polylineLayer,b._manipulatorLayer],listMode:"hide",visible:!1});b._vertices=[];b.deferCreation=!0;b.geodesicDistanceThreshold=1E5;b.measurement=null;b.measurementLabel=null;return b}d.__extends(a,c);a.prototype.initialize=function(){var b=this;q.loadMessageBundle("esri/core/t9n/Units").then(function(a){b.messages=
a});this._handles.add(q.onLocaleChange(function(){return d.__awaiter(b,void 0,void 0,function(){var b;return d.__generator(this,function(a){switch(a.label){case 0:return b=this,[4,q.loadMessageBundle("esri/core/t9n/Units")];case 1:return b.messages=a.sent(),[2]}})})}))};a.prototype.destroy=function(){this.detach();this._draw&&(this._draw.destroy(),this._draw=null);this._handles&&(this._handles.destroy(),this._handles=null);this._polylineLayer&&(this._polylineLayer.destroy(),this._polylineLayer=null);
this._manipulatorLayer&&(this._manipulatorLayer.destroy(),this._manipulatorLayer=null)};Object.defineProperty(a.prototype,"editable",{set:function(b){this._set("editable",b);b||this._draw.reset()},enumerable:!1,configurable:!0});a.prototype.activate=function(){this._drawActive||0!==this._vertices.length||this._startSketch()};a.prototype.onAttach=function(){var b=this,a=this.view;this._draw=new F({view:a});a.map.add(this._groupLayer);a.focus();this._handles.add([y.init(this,["unit","geodesicDistanceThreshold",
"palette","messages"],function(){0<b._vertices.length&&b._updatePolylines()}),y.init(this,"view.spatialReference",function(b){v(b)&&!l.isLoaded()&&l.load()})]);this.create()};a.prototype.onDetach=function(){var b=this.view.map;this._draw.view=null;this._draw.destroy();this._draw=null;b.remove(this._groupLayer);this._handles.removeAll();this._polylineLayer.removeAll();this._manipulatorLayer.removeAll();this._set("measurement",null);this._set("measurementLabel",null)};a.prototype.onShow=function(){this._groupLayer.visible=
!0};a.prototype.onHide=function(){this._groupLayer.visible=!1};a.prototype.reset=function(){this._vertices=[];this._polylineLayer.removeAll();this._set("measurement",null);this._set("measurementLabel",null);this._draw.reset();this._drawActive=!1;this._updateSketch([])};a.prototype.onInputEvent=function(b){"pointer-move"===b.type&&this._updateCursor()};a.prototype._startSketch=function(){var b=this;this._drawActive=!0;var a=this._draw.create("polyline",{mode:"click"});a.on("vertex-add vertex-update vertex-remove cursor-update undo redo".split(" "),
function(a){return b._updateSketch(a.vertices)});a.on("draw-complete",function(){b._stopSketch()})};a.prototype._stopSketch=function(){this.manipulators.forEach(function(b){b.manipulator.interactive=!0});this._drawActive=!1;this.complete()};a.prototype._updateSketch=function(b){var a=this;if(!v(this.view.spatialReference)||l.isLoaded())if(2>b.length)this._vertices=[],this.manipulators.removeAll(),this._polylineLayer.removeAll();else{this.create();for(var c=this.view.spatialReference;this._vertices.length>
b.length;){var d=this._vertices.pop().manipulatorId;this.manipulators.remove(d)}for(var d=function(d){var f=b[d],g=f[0],f=f[1],e=new n.Point({x:g,y:f,spatialReference:c}),e=I(e,h.view,h._manipulatorLayer,h.palette),k=h.manipulators.add(e);u.createManipulatorDragEventPipeline(e,function(b,c){c.next(u.screenToMap(a.view)).next(u.dragGraphic(b.graphic)).next(function(){var c=b.graphic.geometry;a._vertices[d].coord=[c.x,c.y];a._updatePolylines()})});h._vertices.push({manipulatorId:k,coord:[g,f]})},h=
this,k=this._vertices.length;k<b.length;k++)d(k);var d=this._vertices.length-1,k=this._vertices[d],m=b[d],g=m[0],m=m[1];if(k.coord[0]!==g||k.coord[1]!==m)k.coord=[g,m],g=new n.Point({x:g,y:m,spatialReference:c}),this.manipulators.findById(k.manipulatorId).graphic.geometry=g;var e=this._drawActive?this._vertices[d].manipulatorId:null;this.manipulators.forEach(function(b){b.manipulator.interactive=null==e||b.id!==e});this._updatePolylines()}};a.prototype._updateCursor=function(){this.cursor=this._drawActive?
"crosshair":null};a.prototype._updatePolylines=function(){this._polylineLayer.removeAll();var b=this._vertices.map(function(a){return a.coord}),a=A(b,this.view.spatialReference,this.geodesicDistanceThreshold),c=a.measurement,b=a.drawing,a=a.original;this._set("measurement",c);c=B(this.messages,c,this.unit);this._set("measurementLabel",c);var d=this.palette,g=d.pathSecondaryColor,h=d.pathWidth,e=[];e.push(new p({geometry:b,symbol:{type:"simple-line",cap:"butt",join:"round",color:d.pathPrimaryColor,
width:h}}));e.push(new p({geometry:b,symbol:{type:"simple-line",style:"dash",cap:"butt",join:"round",color:g,width:h-2}}));e.push(new p({geometry:a.extent.center,symbol:{type:"text",color:[255,255,255,1],haloColor:[0,0,0,.5],haloSize:2,text:c,font:{size:14,family:"sans-serif"}}}));this._polylineLayer.addMany(e)};d.__decorate([h.property()],a.prototype,"cursor",void 0);d.__decorate([h.property({value:!0})],a.prototype,"editable",null);d.__decorate([h.property({type:Number})],a.prototype,"geodesicDistanceThreshold",
void 0);d.__decorate([h.property({readOnly:!0})],a.prototype,"measurement",void 0);d.__decorate([h.property({readOnly:!0})],a.prototype,"measurementLabel",void 0);d.__decorate([h.property()],a.prototype,"messages",void 0);d.__decorate([h.property()],a.prototype,"palette",void 0);d.__decorate([h.property()],a.prototype,"unit",void 0);d.__decorate([h.property({constructOnly:!0})],a.prototype,"view",void 0);return a=d.__decorate([h.subclass("esri.widgets.DistanceMeasurement2D.DistanceMeasurement2DTool")],
a)}(H.InteractiveToolBase);g.createDistanceMeasurementInfo2D=A;g.isSupported=function(c){return null!=c&&(!v(c)||l.isSupported())};g.createDistanceMeasurementLabel=B;g.default=w});