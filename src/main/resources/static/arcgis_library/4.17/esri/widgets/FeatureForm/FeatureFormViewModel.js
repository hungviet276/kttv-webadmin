// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.17/esri/copyright.txt for details.
//>>built
define("require exports tslib ../../intl ../../core/arrayUtils ../../core/Evented ../../core/HandleOwner ../../core/lang ../../core/Logger ../../core/ReentrantObjectPool ../../core/watchUtils ../../core/accessorSupport/decorators ../../core/accessorSupport/decorators/cast ../../form/FormTemplate ../../support/arcadeOnDemand ./FieldConfig ./FieldGroupConfig ./InputField ./InputFieldGroup ./support/formTemplateUtils".split(" "),function(K,L,d,r,n,x,y,z,A,t,B,e,C,D,E,u,v,F,G,H){function I(d){return!!d.fieldConfig}
var J=A.getLogger("esri.widgets.FeatureForm.FeatureFormViewModel");return function(w){function c(a){a=w.call(this,a)||this;a._arcade=null;a._fieldPool=new t.ReentrantObjectPool(F);a._fieldGroupPool=new t.ReentrantObjectPool(G);a._featureClone=null;a._needsArcade=!1;a.messages=null;a.strict=!1;return a}d.__extends(c,w);c.prototype.initialize=function(){var a=this,b=function(){return d.__awaiter(a,void 0,void 0,function(){var a;return d.__generator(this,function(b){switch(b.label){case 0:return a=this,
[4,r.loadMessageBundle("esri/widgets/FeatureForm/t9n/FeatureForm")];case 1:return[2,a.messages=b.sent()]}})})};b();this.handles.add(r.onLocaleChange(b));var c=B.init(this,"fieldConfig",function(b){return d.__awaiter(a,void 0,void 0,function(){var a,e,f,k,h,l;return d.__generator(this,function(d){switch(d.label){case 0:return a=[],b&&b.forEach(function(b){a.push(b.visibilityExpression);b.fieldConfig?b.fieldConfig.forEach(function(b){a.push(b.requiredExpression,b.visibilityExpression)}):a.push(b.requiredExpression)}),
e=a.filter(function(a){return!!a}),(f=0<e.length)?[4,E.loadArcade()]:[3,4];case 1:return k=d.sent(),h=k.arcadeUtils,(l=e.some(function(a){return h.hasGeometryOperations(a)}))?[4,h.enableGeometryOperations()]:[3,3];case 2:d.sent(),c.remove(),d.label=3;case 3:this._arcade=k,this.notifyChange("inputFields"),d.label=4;case 4:return this._needsArcade=f,[2]}})})});this.handles.add(c)};c.prototype.destroy=function(){this.layer=this.feature=this.fieldConfig=null;this._fieldPool.destroy();this._fieldGroupPool.destroy()};
Object.defineProperty(c.prototype,"_allInputFields",{get:function(){return this.inputFields.reduce(function(a,b){return b.inputFields?d.__spreadArrays(a,b.inputFields):d.__spreadArrays(a,[b])},[])},enumerable:!1,configurable:!0});Object.defineProperty(c.prototype,"_inputFieldCache",{get:function(){var a=this,b=this._get("_inputFieldCache")||new Map;b.forEach(function(b){return a._disposeInputOrGroup(b)});b.clear();(this.get("layer.fields")||[]).forEach(function(c){return b.set(c,a._fieldPool.acquire())});
return b},enumerable:!1,configurable:!0});Object.defineProperty(c.prototype,"_inputFieldGroupCache",{get:function(){var a=this,b=this._get("_inputFieldGroupCache")||new Map;b.forEach(function(b){return a._disposeInputOrGroup(b)});b.clear();(this.fieldConfig||[]).filter(I).forEach(function(c){return b.set(c,a._fieldGroupPool.acquire())});return b},enumerable:!1,configurable:!0});Object.defineProperty(c.prototype,"description",{get:function(){var a;return null===(a=this.formTemplate)||void 0===a?void 0:
a.description},set:function(a){void 0===a?this._clearOverride("description"):this._override("description",a)},enumerable:!1,configurable:!0});Object.defineProperty(c.prototype,"feature",{get:function(){return this._get("feature")},set:function(a){this._featureClone=a?a.clone():null;this._set("feature",a)},enumerable:!1,configurable:!0});Object.defineProperty(c.prototype,"fieldConfig",{get:function(){var a=this.formTemplate;if(!a)return null;var b=H.fieldConfigsFromFormTemplate(a),a=b.config,b=b.encounteredUnsupportedTypes;
0<b.length&&J.warn("form-info::unsupported-type","encountered unsupported elements/types when parsing form info",b);return a},set:function(a){a?this._override("fieldConfig",a):this._clearOverride("fieldConfig")},enumerable:!1,configurable:!0});c.prototype.castFieldConfig=function(a){return a?a.map(function(a){return a instanceof u||a instanceof v?a:a.fieldConfig?new v(a):new u(a)}):null};Object.defineProperty(c.prototype,"formTemplate",{get:function(){var a;return null===(a=this.layer)||void 0===
a?void 0:a.formTemplate},set:function(a){void 0===a?this._clearOverride("formTemplate"):this._override("formTemplate",a)},enumerable:!1,configurable:!0});Object.defineProperty(c.prototype,"inputFields",{get:function(){var a=this,b=this._arcade,c=this._inputFieldCache,d=this._inputFieldGroupCache,e=this._featureClone,g=this.messages,m=this._needsArcade,p=this.layer,h=this.state,l=e&&e.clone();if("ready"!==h||m&&!b)return[];var q=this.get("layer.fields")||[],e=this.fieldConfig||[];return(0!==e.length?
e.map(function(e){if(e.fieldConfig){var k=d.get(e),f=e.fieldConfig.map(function(d){var e=n.find(q,function(a){return a.name===d.name}),f=c.get(e);f.set({arcade:b,field:e,config:d,feature:l,group:k,layer:p,messages:g,value:a.getValue(e.name)});return f}).filter(function(a){return a.visible});k.set({arcade:b,config:e,feature:l,inputFields:f});return k}var f=n.find(q,function(a){return a.name===e.name}),h=c.get(f);h.set({arcade:b,field:f,config:e,feature:l,group:null,layer:p,messages:g,value:a.getValue(f.name)});
return h}):q.map(function(d){var e=c.get(d);e.set({arcade:b,config:null,field:d,feature:l,group:null,layer:p,messages:g,value:a.getValue(d.name)});return e})).filter(function(a){return a.visible})},enumerable:!1,configurable:!0});Object.defineProperty(c.prototype,"layer",{get:function(){return this.get("feature.layer")},set:function(a){a?this._override("layer",a):this._clearOverride("layer")},enumerable:!1,configurable:!0});Object.defineProperty(c.prototype,"state",{get:function(){return this.messages&&
this.get("layer.loaded")&&this.feature?"ready":"disabled"},enumerable:!1,configurable:!0});Object.defineProperty(c.prototype,"title",{get:function(){var a;return null===(a=this.formTemplate)||void 0===a?void 0:a.title},set:function(a){void 0===a?this._clearOverride("title"):this._override("title",a)},enumerable:!1,configurable:!0});Object.defineProperty(c.prototype,"valid",{get:function(){var a=this._allInputFields;return 0<a.length&&a.every(function(a){return a.valid})},enumerable:!1,configurable:!0});
c.prototype.findField=function(a){return n.find(this._allInputFields,function(b){return b.name===a})};c.prototype.getValue=function(a){var b=this._featureClone;return b&&b.get("attributes."+a)};c.prototype.setValue=function(a,b){var c=this,d=this._featureClone,e=this.strict;if(d&&d.attributes){var g=this.findField(a);b=""===b?null:b;if(g&&d.attributes[a]!==b){g.value=b;if(this.get("layer.typeIdField")===g.name){var m=new Set;this.layer.types.forEach(function(a){return Object.keys(a.domains).forEach(function(a){return m.add(a)})});
m.forEach(function(a){(a=c.findField(a))&&a.notifyChange("domain")})}if(!e||g.valid)d.attributes[a]=b,this.notifyChange("inputFields"),this._emitChangeEvent(g)}}};c.prototype.getValues=function(){var a=this._featureClone;return a&&z.clone(a.attributes)||null};c.prototype.submit=function(){var a=this._allInputFields,b=a.filter(function(a){return a.valid}).map(function(a){return a.name}),a=a.filter(function(a){return!a.valid}).map(function(a){return a.name}),c=this.getValues();this.emit("submit",{valid:b,
invalid:a,values:c})};c.prototype._disposeInputOrGroup=function(a){a.inputFields?this._disposeGroup(a):this._disposeInput(a)};c.prototype._disposeGroup=function(a){var b=this;a.inputFields.forEach(function(a){return b._disposeInput(a)});this._fieldGroupPool.release(a)};c.prototype._disposeInput=function(a){this._fieldPool.release(a)};c.prototype._emitChangeEvent=function(a){this.emit("value-change",{layer:this.layer,feature:this.feature,fieldName:a.name,value:a.value,valid:a.valid})};d.__decorate([e.property({readOnly:!0,
dependsOn:["inputFields"]})],c.prototype,"_allInputFields",null);d.__decorate([e.property({dependsOn:["layer.fields"],readOnly:!0})],c.prototype,"_inputFieldCache",null);d.__decorate([e.property({dependsOn:["fieldConfig"],readOnly:!0})],c.prototype,"_inputFieldGroupCache",null);d.__decorate([e.property({dependsOn:["formTemplate"]})],c.prototype,"description",null);d.__decorate([e.property()],c.prototype,"feature",null);d.__decorate([e.property({dependsOn:["formTemplate"]})],c.prototype,"fieldConfig",
null);d.__decorate([C.cast("fieldConfig")],c.prototype,"castFieldConfig",null);d.__decorate([e.property({dependsOn:["layer?.formTemplate"],type:D})],c.prototype,"formTemplate",null);d.__decorate([e.property({readOnly:!0,dependsOn:["messages","feature","fieldConfig","layer.fields","layer.loaded"]})],c.prototype,"inputFields",null);d.__decorate([e.property({dependsOn:["feature.layer"]})],c.prototype,"layer",null);d.__decorate([e.property()],c.prototype,"messages",void 0);d.__decorate([e.property({dependsOn:["messages",
"layer.loaded","feature"]})],c.prototype,"state",null);d.__decorate([e.property()],c.prototype,"strict",void 0);d.__decorate([e.property({dependsOn:["formTemplate"]})],c.prototype,"title",null);d.__decorate([e.property({dependsOn:["_allInputFields"]})],c.prototype,"valid",null);d.__decorate([e.property()],c.prototype,"getValues",null);d.__decorate([e.property()],c.prototype,"submit",null);return c=d.__decorate([e.subclass("esri.widgets.FeatureForm.FeatureFormViewModel")],c)}(y.HandleOwnerMixin(x.EventedAccessor))});