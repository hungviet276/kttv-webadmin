// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.17/esri/copyright.txt for details.
//>>built
define("require exports ../../../intl ../../../core/Error ../../../core/lang ../../../core/Logger ../../../core/maybe ../../../core/promiseUtils ../../../core/unitUtils ../../../geometry/Polygon ./geometryUtils".split(" "),function(V,p,z,v,H,I,J,y,K,L,A){function B(a,c){var b=a.filter;c=c&&c.extent;a=a.withinViewEnabled&&c?c:void 0;return b&&b.geometry||a}function C(a){return a?a.load().then(y.resolve).catch(y.reject):y.resolve()}function D(a){return a&&!!a.get("capabilities.query.supportsPagination")}
function E(a){var c="";a&&(a=a.fields)&&a.some(function(a){return"string"===a.type?(c=a.name,!0):!1});return c}function x(a,c){return a&&c?c.every(function(c){return!!a.getField(c)}):!1}function M(a){for(var c=0;c<a.length;c++)if(255<a.charCodeAt(c))return!0;return!1}function N(a,c,b){var h=null;(a=a.codedValues)&&a.some(function(a){var e=a.name,e=b?e:e.toLowerCase();return(b?c:c.toLowerCase())===e?(h=a.code.toString(),!0):!1});return h}function q(a,c){return(c=c&&c.where)?"("+a+") AND ("+c+")":a}
function F(a,c,b,h,k){var e=c.definitionExpression,l="";if(a){var d=O.test(c.url)&&M(a)?"N":"";b&&b.forEach(function(b){var f=c.getField(b);b=((b="function"===typeof c.getFieldDomain&&c.getFieldDomain(b))&&"coded-value"===b.type?N(b,a,k):null)||a||null;if(null!==b){var e=f.type,f=f.name;"string"===e||"date"===e||"global-id"===e?k?f=q(f+" \x3d "+d+"'"+b+"'",h):(b=b.toUpperCase(),f=q("UPPER("+f+") LIKE "+d+"'%"+b+"%'",h)):"oid"===e||"small-integer"===e||"integer"===e||"single"===e||"double"===e?(b=
Number(b),f=isNaN(b)?null:q(f+" \x3d "+b,h)):f=q(f+" \x3d "+b,h);f&&(l+=l?" OR ("+f+")":"("+f+")")}})}return e?"("+e+") AND ("+l+")":l}function P(a,c){var b=null;(a=a.codedValues)&&a.length&&a.some(function(a){return a.code===c?(b=a.name,!0):!1});return b}function G(a,c,b){var h=a.layer,k=a.attributes,e="function"===typeof h.getFieldDomain&&h.getFieldDomain(b);return c?z.substitute(c,k):b&&a.hasOwnProperty("attributes")&&k.hasOwnProperty(b)?(a=k[b],b=h.getField(b),e&&"coded-value"===e.type?P(e,a):
b&&"date"===b.type?z.formatDate(new Date(a)):"number"===typeof a?a.toString():"string"!==typeof a?"":a.trim()):""}function Q(a,c,b,h){return a.features.map(function(a){var e=a.attributes[a.layer.objectIdField];return{text:G(a,c.suggestionTemplate,h),key:e,sourceIndex:b}})}function R(a,c,b,h,k,e,l){return a.features.map(function(a){var d=a.clone(),f=a.layer,f=(f=f&&f.objectIdField)&&a.attributes[f],u=G(a,b.searchTemplate,k),g=A.createExtentFromGeometry(d.geometry,c,e),g="number"===typeof l?A.scaleExtent(H.clone(g),
c,l):g;a=a.clone();J.isSome(g)&&(a.geometry=L.fromExtent(g));return{extent:g,target:a,feature:d,key:f,name:u,sourceIndex:h}})}Object.defineProperty(p,"__esModule",{value:!0});p.getSuggestions=p.getResults=void 0;var O=/https?:\/\/services.*\.arcgis\.com/i,S=/(?:\{([^}]+)\})/g,w=I.getLogger("esri.widgets.Search.support.layerSearchUtils");p.getResults=function(a,c){var b=a.exactMatch,h=void 0===b?!1:b,k=a.location,e=a.maxResults,l=a.spatialReference,d=a.source,p=a.sourceIndex,f=a.suggestResult,u=a.view,
g=d.layer,T=d.filter,t=d.zoomScale,m=u&&u.scale,n=B(d,u),U=c&&c.signal;return C(g).then(function(){var a=g.popupTemplate;return a?a.getRequiredFields(g.fields):null}).then(function(a){var b=g.objectIdField,c=g.returnZ,q=d.displayField||d.layer.displayField||E(d.layer);if(!g.getField(q))throw w.error("invalid-field: displayField is invalid."),new v("getResults():invalid-field","displayField is invalid.");a=a&&a.length?a:[q];var r=(a=d.outFields||a)&&-1!==a.indexOf("*");-1!==a.indexOf(b)||r||a.push(b);
if(!r&&!x(g,a))throw w.error("invalid-field: outField is invalid."),new v("getResults():invalid-field","outField is invalid.");b=g.createQuery();if(r=d.orderByFields)b.orderByFields=r;l&&(b.outSpatialReference=l,r=1/K.getMetersPerUnitForSR(l))&&(b.maxAllowableOffset=r);r=!!g.get("capabilities.data.supportsZ");b.returnZ=r&&!1!==c;b.returnGeometry=!0;a&&(b.outFields=a);if(k)b.geometry=k;else if(f.key)b.objectIds=[parseInt(f.key,10)];else{c=d.searchFields||[q];if(!x(g,c))throw w.error("invalid-field: search field is invalid."),
new v("getResults():invalid-field","search field is invalid.");D(g)&&(b.num=e);n&&(b.geometry=n);if(!f.text.trim())return[];a=d.prefix;r=d.suffix;a=(""+(void 0===a?"":a)+f.text+(void 0===r?"":r)).replace(/\'/g,"''");c=F(a,g,c,T,h);if(!c)return[];b.where=c}return g.queryFeatures(b,{signal:U}).then(function(a){return R(a,u,d,p,q,m,t)})})};p.getSuggestions=function(a,c){var b=a.source,h=a.spatialReference,k=a.suggestTerm,e=a.maxSuggestions,l=a.sourceIndex,d=b.layer,q=b.filter,f=c&&c.signal,u=B(b,a.view);
return C(d).then(function(){if(!D(d))return[];var a=b.displayField||b.layer.displayField||E(b.layer),c=b.searchFields||[a],t=[];b.suggestionTemplate?b.suggestionTemplate.replace(S,function(a,b){t.push(b);return a}):t.push(a);var m=t&&-1!==t.indexOf("*");-1!==t.indexOf(d.objectIdField)||m||t.push(d.objectIdField);var n=!!d.getField(a),m=m||x(d,t),p=x(d,c);if(!n)throw w.error("invalid-field: displayField is invalid."),new v("getSuggestions():invalid-field","displayField is invalid.");if(!m)throw w.error("invalid-field: outField is invalid."),
new v("getSuggestions():invalid-field","outField is invalid.");if(!p)throw w.error("invalid-field: search field is invalid."),new v("getSuggestions():invalid-field","search field is invalid.");n=d.createQuery();if(m=b.orderByFields)n.orderByFields=m;n.outSpatialReference=h;n.returnGeometry=!1;n.num=e;n.outFields=t;u&&(n.geometry=u);if(!k.trim())return[];m=b.prefix;p=b.suffix;m=(""+(void 0===m?"":m)+k+(void 0===p?"":p)).replace(/\'/g,"''");c=F(m,d,c,q,!1);if(!c)return[];n.where=c;return d.queryFeatures(n,
{signal:f}).then(function(c){return Q(c,b,l,a)})})}});