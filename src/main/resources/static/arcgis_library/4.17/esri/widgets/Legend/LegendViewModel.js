// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.17/esri/copyright.txt for details.
//>>built
define("require exports tslib ../../intl ../../core/Accessor ../../core/Collection ../../core/Handles ../../core/watchUtils ../../core/accessorSupport/decorators ./support/ActiveLayerInfo".split(" "),function(z,A,f,t,u,n,v,k,l,p){var q=n.ofType(p),w="esri.layers.BuildingSceneLayer esri.layers.CSVLayer esri.layers.FeatureLayer esri.layers.GeoJSONLayer esri.layers.GeoRSSLayer esri.layers.GroupLayer esri.layers.HeatmapLayer esri.layers.ImageryLayer esri.layers.ImageryTileLayer esri.layers.MapImageLayer esri.layers.OGCFeatureLayer esri.layers.PointCloudLayer esri.layers.StreamLayer esri.layers.SceneLayer esri.layers.TileLayer esri.layers.WMSLayer esri.layers.WMTSLayer esri.layers.WCSLayer".split(" "),
x=["view.basemapView.baseLayerViews","view.groundView.layerViews","view.layerViews","view.basemapView.referenceLayerViews"];return function(r){function b(a){a=r.call(this,a)||this;a._handles=new v;a._layerViewByLayerId={};a._layerInfosByLayerViewId={};a._activeLayerInfosByLayerViewId={};a._activeLayerInfosWithNoParent=new n;a.activeLayerInfos=new q;a.basemapLegendVisible=!1;a.groundLegendVisible=!1;a.keepCacheOnDestroy=!1;a.respectLayerVisibility=!0;a.layerInfos=[];a.view=null;return a}f.__extends(b,
r);b.prototype.initialize=function(){var a=this;this._handles.add(k.init(this,"view",this._viewHandles),"view");this._handles.add(t.onLocaleChange(function(){return a._refresh()}))};b.prototype.destroy=function(){this._destroyViewActiveLayerInfos();this._handles.destroy();this.view=this._handles=null};Object.defineProperty(b.prototype,"state",{get:function(){return this.get("view.ready")?"ready":"disabled"},enumerable:!1,configurable:!0});b.prototype._viewHandles=function(){this._handles.remove("state");
this.view&&this._handles.add(k.init(this,"state",this._stateHandles),"state")};b.prototype._stateHandles=function(){this._resetAll();"ready"===this.state&&this._watchPropertiesAndAllLayerViews()};b.prototype._resetAll=function(){this._handles.remove(["all-layer-views","legend-properties"]);this._destroyViewActiveLayerInfos();this.activeLayerInfos.removeAll()};b.prototype._destroyViewActiveLayerInfos=function(){Object.keys(this._activeLayerInfosByLayerViewId).forEach(this._destroyViewActiveLayerInfo,
this)};b.prototype._destroyViewActiveLayerInfo=function(a){this._handles.remove(a);var e=this._activeLayerInfosByLayerViewId[a];delete this._activeLayerInfosByLayerViewId[a];e&&e.parent&&e.parent.children.remove(e)};b.prototype._watchPropertiesAndAllLayerViews=function(){var a=this.view.allLayerViews;a.length&&this._refresh();this._handles.add(a.on("change",this._allLayerViewsChangeHandle.bind(this)),"all-layer-views");this._handles.add(k.watch(this,"layerInfos, basemapLegendVisible, groundLegendVisible",
this._propertiesChangeHandle.bind(this)),"legend-properties")};b.prototype._allLayerViewsChangeHandle=function(a){var e=this;a.removed.forEach(function(a){return e._destroyViewActiveLayerInfo(a.uid)});this._refresh()};b.prototype._propertiesChangeHandle=function(){this._destroyViewActiveLayerInfos();this._refresh()};b.prototype._refresh=function(){this._layerInfosByLayerViewId={};this.activeLayerInfos.removeAll();this._generateLayerViews().filter(this._filterLayerViewsByLayerInfos,this).filter(this._isLayerViewSupported,
this).forEach(this._generateActiveLayerInfo,this);this._sortActiveLayerInfos(this.activeLayerInfos)};b.prototype._sortActiveLayerInfos=function(a){var e=this;if(!(2>a.length)){var b=[];a.forEach(function(c){if(!c.parent){var d=c.layer.parent;(d=(d=d&&"uid"in d&&e._layerViewByLayerId[d.uid])&&e._activeLayerInfosByLayerViewId[d.uid])&&-1!==a.indexOf(d)&&(b.push(c),c.parent=d,d.children.add(c),e._sortActiveLayerInfos(d.children))}});a.removeMany(b);var g={};this.view.allLayerViews.forEach(function(a,
e){return g[a.layer.uid]=e});a.sort(function(a,e){return(g[e.layer.uid]||0)-(g[a.layer.uid]||0)})}};b.prototype._generateLayerViews=function(){var a=[];x.filter(this._filterLayerViews,this).map(this.get,this).filter(function(a){return null!=a}).forEach(this._collectLayerViews("layerViews",a));return a};b.prototype._filterLayerViews=function(a){var e=!this.groundLegendVisible&&"view.groundView.layerViews"===a;return!(!this.basemapLegendVisible&&("view.basemapView.baseLayerViews"===a||"view.basemapView.referenceLayerViews"===
a))&&!e};b.prototype._collectLayerViews=function(a,e){var b=function(c){c&&c.forEach(function(c){e.push(c);b(c[a])});return e};return b};b.prototype._filterLayerViewsByLayerInfos=function(a){var e=this,b=this.layerInfos;return b&&b.length?b.some(function(b){return e._hasLayerInfo(b,a)}):!0};b.prototype._hasLayerInfo=function(a,b){var e=this._isLayerUIDMatching(a.layer,b.layer.uid);e&&(this._layerInfosByLayerViewId[b.uid]=a);return e};b.prototype._isLayerUIDMatching=function(a,b){return a&&(a.uid===
b||this._hasLayerUID(a.layers,b))};b.prototype._hasLayerUID=function(a,b){var e=this;return a&&a.some(function(a){return e._isLayerUIDMatching(a,b)})};b.prototype._isLayerViewSupported=function(a){return-1<w.indexOf(a.layer.declaredClass)?(this._layerViewByLayerId[a.layer.uid]=a,!0):!1};b.prototype._generateActiveLayerInfo=function(a){var b=this;this._isLayerActive(a)?this._buildActiveLayerInfo(a):(this._handles.remove(a.uid),this._handles.add(k.watch(a,"legendEnabled, layer.legendEnabled",function(){return b._layerActiveHandle(a)}),
a.uid))};b.prototype._layerActiveHandle=function(a){this._isLayerActive(a)&&(this._handles.remove(a.uid),this._buildActiveLayerInfo(a))};b.prototype._isLayerActive=function(a){return this.respectLayerVisibility?a.legendEnabled&&a.get("layer.legendEnabled"):!0};b.prototype._buildActiveLayerInfo=function(a){var b=this,c,g=a.layer,m=a.uid,d=this._layerInfosByLayerViewId[m],h=this._activeLayerInfosByLayerViewId[m];h||(h=new p({layer:g,layerView:a,title:d&&void 0!==d.title&&d.layer.uid===g.uid?d.title:
g.title,view:this.view,respectLayerVisibility:this.respectLayerVisibility,keepCacheOnDestroy:this.keepCacheOnDestroy,sublayerIds:d&&d.sublayerIds||[]}),this._activeLayerInfosByLayerViewId[m]=h);d=g.parent&&"uid"in g.parent&&this._layerViewByLayerId[null===(c=g.parent)||void 0===c?void 0:c.uid];h.parent=this._activeLayerInfosByLayerViewId[null===d||void 0===d?void 0:d.uid];if(!this._handles.has(m)){c=k.watch(g,"title",function(a){return b._titleHandle(a,h)});var d=k.watch(g,"renderer?, opacity",function(){return b._constructLegendElements(h)}),
y=k.whenTrue(this.view,"stationary",function(){return b._scaleHandle(h)}),f=k.watch(a,"_effectiveRenderer",function(){return b._constructLegendElements(h)});c=[c,d,y,f];this.respectLayerVisibility&&(a=k.watch(a,"legendEnabled",function(a){return b._legendEnabledHandle(a,h)}),g=k.watch(g,"legendEnabled",function(a){return b._legendEnabledHandle(a,h)}),c.push(a,g));this._handles.add(c,m)}h.isScaleDriven||this._constructLegendElements(h);this._addActiveLayerInfo(h)};b.prototype._titleHandle=function(a,
b){b.title=a;this._constructLegendElements(b)};b.prototype._legendEnabledHandle=function(a,b){a?this._addActiveLayerInfo(b):this._removeActiveLayerInfo(b)};b.prototype._scaleHandle=function(a){a.isScaleDriven&&this._constructLegendElements(a)};b.prototype._addActiveLayerInfo=function(a){var b=this,c,g=a.layer;if(this._isLayerActive(a.layerView)&&-1===this.activeLayerInfos.indexOf(a)){var f=a.parent;f?(-1===f.children.indexOf(a)&&f.children.push(a),this._sortActiveLayerInfos(f.children)):(f=null===
(c=this.layerInfos)||void 0===c?void 0:c.some(function(a){return a.layer.uid===g.uid}),g.parent&&"uid"in g.parent&&!f?this._activeLayerInfosWithNoParent.add(a):(this.activeLayerInfos.add(a),this._sortActiveLayerInfos(this.activeLayerInfos)));if(this._activeLayerInfosWithNoParent.length){var d=[];this._activeLayerInfosWithNoParent.forEach(function(a){var c=a.layer.parent,c=c&&"uid"in c&&b._layerViewByLayerId[null===c||void 0===c?void 0:c.uid];if(c=b._activeLayerInfosByLayerViewId[null===c||void 0===
c?void 0:c.uid])d.push(a),a.parent=c});d.length&&(this._activeLayerInfosWithNoParent.removeMany(d),d.forEach(function(a){return b._addActiveLayerInfo(a)}))}}};b.prototype._removeActiveLayerInfo=function(a){var b=a.parent;b?b.children.remove(a):this.activeLayerInfos.remove(a)};b.prototype._constructLegendElements=function(a){var b=this,c=a.layer;"featureCollections"in c&&c.featureCollections?a.buildLegendElementsForFeatureCollections(c.featureCollections):"renderer"in c&&c.renderer?a.buildLegendElementsForRenderer(c.renderer):
"url"in c&&c.url?a.buildLegendElementsForTools():a.children.forEach(function(a){return b._constructLegendElements(a)})};f.__decorate([l.property({type:q})],b.prototype,"activeLayerInfos",void 0);f.__decorate([l.property()],b.prototype,"basemapLegendVisible",void 0);f.__decorate([l.property()],b.prototype,"groundLegendVisible",void 0);f.__decorate([l.property()],b.prototype,"keepCacheOnDestroy",void 0);f.__decorate([l.property()],b.prototype,"respectLayerVisibility",void 0);f.__decorate([l.property()],
b.prototype,"layerInfos",void 0);f.__decorate([l.property({dependsOn:["view.ready"],readOnly:!0})],b.prototype,"state",null);f.__decorate([l.property()],b.prototype,"view",void 0);return b=f.__decorate([l.subclass("esri.widgets.Legend.LegendViewModel")],b)}(u)});