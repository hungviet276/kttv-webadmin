// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.17/esri/copyright.txt for details.
//>>built
define("require exports tslib ../../Graphic ../../core/arrayUtils ../../core/compilerUtils ../../core/maybe ../../core/promiseUtils ../../core/screenUtils ../../core/accessorSupport/diffUtils ../../layers/support/fieldUtils ../../renderers/support/clickToleranceUtils ../../renderers/support/utils ../../renderers/visualVariables/support/sizeVariableUtils ../../renderers/visualVariables/support/visualVariableUtils ../../symbols/support/symbolConversion ../../symbols/support/symbolUtils ../../views/support/drapedUtils @dojo/framework/shim/Promise".split(" "),
function(D,f,g,H,I,E,u,z,A,J,F,K,L,M,N,O,B,P){function G(a){var c=a.layer,d;a:switch(c.renderer.type){case "class-breaks":case "simple":case "unique-value":case "dot-density":case "dictionary":d=!0;break a;default:d=!1}var b=(a=d&&N.getVisualVariableValues(c.renderer,a))?a.map(function(a){return a.variable}):[];d=b.filter(function(a){return"rotation"===a.type&&(!a.axis||"heading"===a.axis)});a=d[0];d=1===d.length&&a.field&&!a.valueExpression;var e=b.filter(function(a){return"size"===a.type}),b=e[0],
e=1===e.length&&"real-world-size"===M.getTransformationType(b)&&b.field&&!b.useSymbolValue&&!b.valueExpression;return{rotation:d?Q(a,c):null,size:e?R(b,c):null}}function Q(a,c){var d="heading"===(a.axis||"heading")&&"arithmetic"===a.rotationType?-1:1,b=a.field,e=(a=c.fields&&c.fields.filter(function(a){return a.name===b}))&&1===a.length?a[0].type:"double",h=0,k=0;return{field:b,getDefault:function(){return z.resolve(0)},getValue:function(a){k=h-d*a;return C((k+360)%360,e)},initValue:function(a){h=
null!=a?a:k;k=0},isUpdatingInteractively:!1}}function S(a,c){switch(c){case "width":return a[0];case "depth":return a[1];case "height":return a[2];default:return a[2]||a[1]||a[0]}}function T(a,c,d){return g.__awaiter(this,void 0,void 0,function(){var b,e,h,k,n,p,l,m,v,q;return g.__generator(this,function(g){switch(g.label){case 0:if(u.isNone(c))return[2,0];b=O.to3D(c).symbol;if(u.isNone(b)||"web-style"===b.type)return[2,0];e=b.symbolLayers.getItemAt(0);if(!e)return[2,0];h=e.type;switch(h){case "icon":return[3,
1];case "text":return[3,5];case "line":return[3,6];case "object":return[3,7];case "path":return[3,10];case "extrude":return[3,10];case "fill":return[3,11];case "water":return[3,11]}return[3,12];case 1:return[4,new Promise(function(a,b){D(["../../symbols/support/symbolLayerUtils"],a,b)})];case 2:k=g.sent().computeIconLayerResourceSize;if(n=e.size)return[3,4];l=(p=Math).min;m=[f.sizeDefaults.icon];return[4,k(e,f.sizeDefaults.icon)];case 3:n=l.apply(p,m.concat([g.sent()[0]])),g.label=4;case 4:return[2,
n||f.sizeDefaults.icon];case 5:return[2,e.size||f.sizeDefaults.text];case 6:return[2,e.size||f.sizeDefaults.line];case 7:return[4,new Promise(function(a,b){D(["../../symbols/support/symbolLayerUtils"],a,b)})];case 8:return v=g.sent().computeObjectLayerResourceSize,[4,v(e,a.scale/f.sizeDefaults.viewScaleSizeFactor)];case 9:return q=g.sent(),[2,S(q,d)];case 10:return[2,e.size||a.scale/f.sizeDefaults.viewScaleSizeFactor];case 11:return[2,0];case 12:return E.neverReached(e),[2,0]}})})}function R(a,c){var d=
this,b=a.field,e=a.axis,h=(c=c.fields&&c.fields.filter(function(a){return a.name===b}))&&1===c.length?c[0].type:"double",k=0,n=0,p=L.meterIn[a.valueUnit],l;l="area"===a.valueRepresentation?function(a){return Math.pow(a*p/2,2)*Math.PI}:"radius"===a.valueRepresentation||"distance"===a.valueRepresentation?function(a){return a*p/2}:function(a){return a*p};return{field:b,getDefault:function(a,b){return g.__awaiter(d,void 0,void 0,function(){var k,c;return g.__generator(this,function(d){switch(d.label){case 0:return k=
C,c=l,[4,T(b,a,e)];case 1:return[2,k.apply(void 0,[c.apply(void 0,[d.sent()]),h])]}})})},getValue:function(a,b){k||(k=b.pixelSizeAt(b.center));n=k*a;return C(n,h)},initValue:function(a){k=null!=a?a:n;n=0},isUpdatingInteractively:!1}}function C(a,c){switch(c){case "small-integer":case "integer":case "long":return Math.round(a);case "double":case "single":return a;default:return 0}}function w(a){return g.__awaiter(this,void 0,void 0,function(){var c,d;return g.__generator(this,function(b){switch(b.label){case 0:return[4,
B.getDisplayedSymbol(a,{ignoreGraphicSymbol:!0})];case 1:return c=b.sent(),d=J.diff(a.symbol,c),u.isSome(d)&&(a.symbol=c),[2]}})})}function U(a,c,d){return g.__awaiter(this,void 0,void 0,function(){var b,e,h,k,n,p,l,m,f,q,r,x,y,w;return g.__generator(this,function(t){switch(t.label){case 0:if("3d"!==d.type)return[2];b=c.layer;e=g.__assign({},c.template.prototype.attributes);h=new H({layer:b,sourceLayer:b,attributes:e});k=G(h);n=k.rotation;p=k.size;return[4,B.getDisplayedSymbol(h)];case 1:l=t.sent(),
m=!1,f=0,q=[p,n],t.label=2;case 2:if(!(f<q.length))return[3,5];r=q[f];if(u.isNone(r))return[3,4];x=e[r.field];if(null!=x)return[3,4];y=e;w=r.field;return[4,r.getDefault(l,d)];case 3:y[w]=t.sent(),m=!0,t.label=4;case 4:return f++,[3,2];case 5:return m?[4,B.getDisplayedSymbol(h)]:[3,7];case 6:l=t.sent(),t.label=7;case 7:switch(null===l||void 0===l?void 0:l.type){case "simple-fill":case "polygon-3d":a.polygonSymbol=l;break;case "simple-line":case "line-3d":a.polylineSymbol=l;break;case "simple-marker":case "point-3d":a.pointSymbol=
l}return[2]}})})}function V(a,c,d){return g.__awaiter(this,void 0,void 0,function(){var b,e;return g.__generator(this,function(h){switch(h.label){case 0:return 0===a.length?[2,[]]:[4,c.hitTest(d)];case 1:b=h.sent();if(0===b.results.length)return[2,[]];e=new Map;b.results.forEach(function(a){a=a.graphic;var b=a.layer;e.has(b)||e.set(b,[]);e.get(b).push(a)});return[2,z.eachAlways(a.items.filter(function(a){var b=a.layer;return-1<a.supports.indexOf("update")&&e.has(b)}).map(function(a){a=a.layer;var b=
a.displayField,c=[a.objectIdField];F.hasField(a.fields,b)&&c.push(b);b=e.get(a);if(b.some(function(a){return c.some(function(b){return!(b in a.attributes)})})){var d=a.createQuery();d.outFields=c;d.returnGeometry=!1;d.objectIds=b.map(function(a){return a.getObjectId()});return a.queryFeatures(d).then(function(a){return a.features})}return z.resolve(b)}))]}})})}function W(a,c,d){return g.__awaiter(this,void 0,void 0,function(){var b,e;return g.__generator(this,function(h){switch(h.label){case 0:return 0===
a.length?[2,[]]:[4,c.hitTest(d)];case 1:b=h.sent();if(0===b.results.length)return[2,[]];e=new Set;b.results.forEach(function(a){return e.add(a.graphic.layer)});return[2,z.eachAlways(a.items.filter(function(a){var b=a.layer;return-1<a.supports.indexOf("update")&&e.has(b)}).map(function(a){a=a.layer;var b=a.displayField,e=[a.objectIdField];F.hasField(a.fields,b)&&e.push(b);b=a.createQuery();b.outFields=e;b.returnGeometry=!1;e=K.calculateTolerance({renderer:a.renderer,event:d});b.geometry=P.createQueryGeometry(d.mapPoint,
e,c);return a.queryFeatures(b).then(function(a){return a.features})}))]}})})}Object.defineProperty(f,"__esModule",{value:!0});f.sizeDefaults=f.setUpGeometryUpdate=f.fetchFullFeature=f.fetchCandidates=f.findLayerInfo=f.setUpFeatureAdd=f.getVisualVariableAttributes=void 0;f.getVisualVariableAttributes=G;f.setUpFeatureAdd=function(a,c,d,b){return g.__awaiter(this,void 0,void 0,function(){var e,h,f,n=this;return g.__generator(this,function(k){switch(k.label){case 0:return e=c.layer,[4,U(a,c,d)];case 1:return k.sent(),
a.layer.elevationInfo=e.elevationInfo,h=function(){return a.create(e.geometryType,{hasZ:e.capabilities.data.supportsZ})},[4,h()];case 2:return k.sent(),f=a.on("create",function(d){return g.__awaiter(n,void 0,void 0,function(){var f,l,k;return g.__generator(this,function(m){switch(m.label){case 0:f=d.state;l=d.graphic;if("cancel"===f)return h(),[2];if("complete"!==f)return[3,2];k=l.clone();k.attributes=g.__assign({},c.template.prototype.attributes);k.layer=e;a.layer.remove(l);return[4,w(k)];case 1:m.sent(),
b(k),m.label=2;case 2:return[2]}})})}),d.map.add(a.layer),[2,{remove:function(){f.remove();d.map.remove(a.layer);a.cancel()}}]}})})};f.findLayerInfo=function(a,c){return a&&I.find(a,function(a){return a.layer===c})};f.fetchCandidates=function(a,c,d){return g.__awaiter(this,void 0,void 0,function(){return g.__generator(this,function(b){switch(c.type){case "3d":return[2,V(a,c,d)];case "2d":return[2,W(a,c,d)];default:return E.neverReached(c),[2,null]}})})};f.fetchFullFeature=function(a,c,d){var b=a.layer,
e=b.createQuery();e.objectIds=[a.getAttribute(b.objectIdField)];e.outFields=["*"];e.outSpatialReference=c.spatialReference;e.returnM=b.capabilities.data.supportsM;e.returnZ=b.capabilities.data.supportsZ;return b.queryFeatures(e,d).then(function(a){return a.features[0]})};f.setUpGeometryUpdate=function(a,c,d,b,e){return g.__awaiter(this,void 0,void 0,function(){var h,f,n,p,l,m,v,q,r,x,y=this;return g.__generator(this,function(k){switch(k.label){case 0:return h=a.clone(),[4,w(h)];case 1:return k.sent(),
d.layer.add(h),h.sourceLayer=a.layer,f=function(){var d=a.layer;if("graphics"===d.type)return{remove:function(){}};var c=a.attributes[d.objectIdField],e=b.whenLayerView(d);e.then(function(a){return a.setVisibility(c,!1)},function(){});return{remove:function(){e.then(function(a){return a.setVisibility(c,!0)},function(){})}}},n=f(),p=a.layer,l=c.size,m=c.rotation,v={multipleSelectionEnabled:!1},"point"===p.geometryType&&(v.enableRotation=!!m,v.enableScaling=!!l),d.layer.elevationInfo=p.elevationInfo,
d.update(h,v),q=(u.isSome(l)||u.isSome(m))&&a.watch("attributes",function(a){return g.__awaiter(y,void 0,void 0,function(){var d,c,e;return g.__generator(this,function(f){switch(f.label){case 0:d=!1;for(c in a)e=a[c],e!==h.attributes[c]&&(h.setAttribute(c,e),d=!0,u.isSome(l)&&!l.isUpdatingInteractively&&l.field===c&&l.initValue(e),u.isSome(m)&&!m.isUpdatingInteractively&&m.field===c&&m.initValue(e));return d&&"3d"===b.type?[4,w(h)]:[3,2];case 1:f.sent(),f.label=2;case 2:return[2]}})})}),[m,l].forEach(function(c){return g.__awaiter(y,
void 0,void 0,function(){var d,e;return g.__generator(this,function(f){switch(f.label){case 0:if(u.isNone(c))return[2];d=a.attributes[c.field];if(null==d)return[3,1];c.initValue(d);return[3,4];case 1:return[4,c.getDefault(h.symbol,b)];case 2:return e=f.sent(),c.initValue(e),h.setAttribute(c.field,e),"3d"!==b.type?[3,4]:[4,w(h)];case 3:f.sent(),f.label=4;case 4:return[2]}})})}),r=d.on("update",function(a){return g.__awaiter(y,void 0,void 0,function(){var c,f,k,n,p,q,r,t;return g.__generator(this,function(g){switch(g.label){case 0:c=
a.graphics[0];f=a.state;k=a.toolEventInfo;if("complete"===f)return d.update(c,v),[2];n=k;u.isSome(m)&&n&&(p=m.field,q=m.getValue,r=m.initValue,"rotate-stop"===n.type?(m.isUpdatingInteractively=!1,r()):null!=n.angle&&(m.isUpdatingInteractively=!0,h.attributes[p]=q(n.angle/Math.PI*180,b)));t=k;u.isSome(l)&&t&&(p=l.field,q=l.getValue,r=l.initValue,"scale-stop"===t.type?(l.isUpdatingInteractively=!1,r()):null!=t.xScale&&(l.isUpdatingInteractively=!0,h.attributes[p]=q(t.xScale,b)));return"3d"!==b.type?
[3,2]:[4,w(h)];case 1:g.sent(),g.label=2;case 2:return e(c.clone()),[2]}})})}),b.map.add(d.layer),x=function(){},[2,{interactive:{remove:function(){r.remove();d.cancel();q&&q.remove();this.remove=x}},visual:{remove:function(){n.remove();b.map.remove(d.layer);d.layer.removeAll();this.remove=x}}}]}})})};f.sizeDefaults={icon:A.px2pt(24),text:A.px2pt(12),line:A.px2pt(1),viewScaleSizeFactor:100}});