// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.17/esri/copyright.txt for details.
//>>built
define("require exports tslib ../../Graphic ../../core/Accessor ../../core/Handles ../../core/Logger ../../core/promiseUtils ../../core/throttle ../../core/watchUtils ../../core/accessorSupport/decorators ../../popup/content/TextContent ../Attachments/AttachmentsViewModel ./FeatureContent/FeatureContentViewModel ./FeatureFields/FeatureFieldsViewModel ./FeatureMedia/FeatureMediaViewModel ./support/arcadeFeatureUtils ./support/featureUtils ./support/relatedFeatureUtils".split(" "),function(J,K,d,y,
z,A,B,t,C,D,f,E,F,u,G,r,H,k,p){var I=B.getLogger("esri.widgets.FeatureViewModel");return function(v){function b(a){var c=v.call(this,a)||this;c._handles=new A;c._featureAbortController=null;c._graphicChangedThrottled=C.throttle(c._graphicChanged,1,c);c.content=null;c.contentViewModels=[];c.defaultPopupTemplateEnabled=!1;c.formattedAttributes=null;c.lastEditInfo=null;c.relatedInfos=new Map;c.title="";c.view=null;c._handles.add(D.init(c,["graphic","_effectivePopupTemplate"],function(){return c._graphicChangedThrottled()}));
return c}d.__extends(b,v);b.prototype.destroy=function(){this._clear();this._cancelFeatureQuery();this._handles.destroy();this.graphic=this._handles=null;this._destroyContentViewModels();this.relatedInfos.clear()};Object.defineProperty(b.prototype,"_effectivePopupTemplate",{get:function(){var a;return(null===(a=this.graphic)||void 0===a?void 0:a.getEffectivePopupTemplate(this.defaultPopupTemplateEnabled))||null},enumerable:!1,configurable:!0});Object.defineProperty(b.prototype,"_fieldInfoMap",{get:function(){return k.createfieldInfoMap(k.getAllFieldInfos(this._effectivePopupTemplate),
this._sourceLayer)},enumerable:!1,configurable:!0});Object.defineProperty(b.prototype,"_sourceLayer",{get:function(){return k.getSourceLayer(this.graphic)},enumerable:!1,configurable:!0});Object.defineProperty(b.prototype,"graphic",{set:function(a){this._set("graphic",a?a.clone():null)},enumerable:!1,configurable:!0});Object.defineProperty(b.prototype,"spatialReference",{get:function(){return this.get("view.spatialReference")||null},set:function(a){void 0===a?this._clearOverride("spatialReference"):
this._override("spatialReference",a)},enumerable:!1,configurable:!0});Object.defineProperty(b.prototype,"map",{get:function(){return this.get("view.map")||null},set:function(a){void 0===a?this._clearOverride("map"):this._override("map",a)},enumerable:!1,configurable:!0});Object.defineProperty(b.prototype,"waitingForContent",{get:function(){return!!this._featureAbortController},enumerable:!1,configurable:!0});b.prototype.setActiveMedia=function(a,c){a=this.contentViewModels[a];a instanceof r&&a.setActiveMedia(c)};
b.prototype.nextMedia=function(a){a=this.contentViewModels[a];a instanceof r&&a.next()};b.prototype.previousMedia=function(a){a=this.contentViewModels[a];a instanceof r&&a.previous()};b.prototype._clear=function(){this._set("title","");this._set("content",null);this._set("formattedAttributes",null)};b.prototype._graphicChanged=function(){return d.__awaiter(this,void 0,void 0,function(){var a,c,h;return d.__generator(this,function(b){switch(b.label){case 0:this._cancelFeatureQuery();this._clear();
a=this.graphic;if(!a)return[2];this._featureAbortController=c=t.createAbortController();b.label=1;case 1:return b.trys.push([1,3,,4]),[4,this._queryFeature({signal:c.signal})];case 2:return b.sent(),[3,4];case 3:return h=b.sent(),I.error("error","error loading popupTemplate for graphic",{error:h,graphic:a}),[3,4];case 4:return this._featureAbortController===c&&(this._featureAbortController=null),[2]}})})};b.prototype._cancelFeatureQuery=function(){var a=this._featureAbortController;a&&a.abort();this._featureAbortController=
null};b.prototype._compileContent=function(a){var c=this;this._destroyContentViewModels();if(this.graphic)return Array.isArray(a)?a.map(function(a,b){if("attachments"===a.type)return c._compileAttachments(a,b);if("custom"===a.type)return c._compileCustom(a,b);if("fields"===a.type)return c._compileFields(a,b);if("media"===a.type)return c._compileMedia(a,b);if("text"===a.type)return c._compileText(a,b)}):"string"===typeof a?this._compileText(new E({text:a}),0).text:a};b.prototype._destroyContentViewModels=
function(){this.contentViewModels.forEach(function(a){return a&&!a.destroyed&&a.destroy()});this._set("contentViewModels",[])};b.prototype._compileAttachments=function(a,c){this.contentViewModels[c]=new F({graphic:this.graphic});return a};b.prototype._compileCustom=function(a,c){this.contentViewModels[c]=new u({graphic:this.graphic,creator:a.creator,destroyer:a.destroyer});return a};b.prototype._compileFields=function(a,c){var b=this._effectivePopupTemplate,g=this.formattedAttributes,e=a.clone();
a=(null===a||void 0===a?void 0:a.fieldInfos)||(null===b||void 0===b?void 0:b.fieldInfos);b=null===b||void 0===b?void 0:b.expressionInfos;g=d.__assign(d.__assign({},g.global),g.content[c]);g=new G({attributes:g,expressionInfos:b,fieldInfos:a});this.contentViewModels[c]=g;e.fieldInfos=g.formattedFieldInfos.slice(0);return e};b.prototype._compileMedia=function(a,c){var b=this._fieldInfoMap,d=this._effectivePopupTemplate,e=this.relatedInfos,f=this._sourceLayer,k=this.graphic.attributes,m=this.formattedAttributes.global;
a=a.clone();b=new r({activeMediaInfoIndex:a.activeMediaInfoIndex||0,attributes:k,layer:f,fieldInfoMap:b,formattedAttributes:m,mediaInfos:a.mediaInfos,popupTemplate:d,relatedInfos:e});a.mediaInfos=b.formattedMediaInfos.slice(0);this.contentViewModels[c]=b;return a};b.prototype._compileText=function(a,c){a=a.clone();var b=this.graphic,g=this._fieldInfoMap,e=this._sourceLayer;if(a&&a.text){var f=b.attributes,l=this.formattedAttributes.global,e=k.processFieldsInLinks(a.text,d.__assign(d.__assign({},l),
f),e);a.text=k.substituteAttributes({formattedAttributes:l,template:e,fieldInfoMap:g})}this.contentViewModels[c]=new u({graphic:b,creator:a.text});return a};b.prototype._compileLastEditInfo=function(){var a=this._effectivePopupTemplate,b=this._sourceLayer;if(a&&(b=null===b||void 0===b?void 0:b.editFieldsInfo,a.lastEditInfoEnabled&&b))return k.formatEditInfo(b,this.graphic.attributes)};b.prototype._compileTitle=function(a){var b=this._fieldInfoMap,h=this._sourceLayer,g=this.graphic.attributes,e=this.formattedAttributes.global;
return a?(a=k.processFieldsInLinks(a,d.__assign(d.__assign({},e),g),h),k.substituteAttributes({formattedAttributes:e,template:a,fieldInfoMap:b})):""};b.prototype._getTitle=function(){return d.__awaiter(this,void 0,void 0,function(){var a,b,h,g;return d.__generator(this,function(c){a=this;b=a._effectivePopupTemplate;h=a.graphic;g=null===b||void 0===b?void 0:b.title;return[2,k.graphicCallback(g,{graphic:h})]})})};b.prototype._getContent=function(){return d.__awaiter(this,void 0,void 0,function(){var a,
b,h,g;return d.__generator(this,function(c){a=this;b=a._effectivePopupTemplate;h=a.graphic;g=null===b||void 0===b?void 0:b.content;return[2,k.graphicCallback(g,{graphic:h})]})})};b.prototype._queryFeature=function(a){return d.__awaiter(this,void 0,void 0,function(){var b,h,g,e,f,l,m,n,q,w,x;return d.__generator(this,function(c){switch(c.label){case 0:return b=this,h=b._featureAbortController,g=b._sourceLayer,e=b.graphic,f=b._effectivePopupTemplate,l=b.spatialReference,m=b.map,[4,t.eachAlways({content:this._getContent(),
title:this._getTitle()})];case 1:return n=c.sent(),q=n.content.value,w=n.title.value,h===this._featureAbortController&&e?[4,t.eachAlways({checkForRelatedFeatures:this._checkForRelatedFeatures(a),expressionAttributes:H.createFormattedExpressions({popupTemplate:this._effectivePopupTemplate,spatialReference:l,graphic:e,map:m}),queryRequiredFields:k.queryRequiredFields({graphic:e,popupTemplate:f,layer:g},a)})]:[2];case 2:x=c.sent().expressionAttributes.value;if(h!==this._featureAbortController||!e)return[2];
this._set("formattedAttributes",this._createFormattedAttributes(q,x));this._set("title",this._compileTitle(w));this._set("lastEditInfo",this._compileLastEditInfo()||null);this._set("content",this._compileContent(q)||null);return[2]}})})};b.prototype._createFormattedAttributes=function(a,b){var c=this._effectivePopupTemplate,g=this.graphic,e=this.relatedInfos,f=this._sourceLayer,l=this._fieldInfoMap,c=null===c||void 0===c?void 0:c.fieldInfos,m=d.__assign(d.__assign({},g.attributes),b),n={global:k.formatAttributes({fieldInfos:c,
graphic:g,attributes:m,layer:f,fieldInfoMap:l,relatedInfos:e}),content:[]};Array.isArray(a)&&a.forEach(function(a,b){"fields"===a.type&&a.fieldInfos&&(n.content[b]=k.formatAttributes({fieldInfos:a.fieldInfos,graphic:g,attributes:m,layer:f,fieldInfoMap:l,relatedInfos:e}))});return n};b.prototype._checkForRelatedFeatures=function(a){return this._queryRelatedInfos(this.graphic,k.getAllFieldInfos(this._effectivePopupTemplate),a)};b.prototype._queryRelatedInfos=function(a,b,f){return d.__awaiter(this,
void 0,void 0,function(){var c,e,h,l,m,n,q=this;return d.__generator(this,function(d){switch(d.label){case 0:c=this;e=c.relatedInfos;h=c._sourceLayer;e.clear();if(!h)return[2];l=b.filter(function(a){return a&&k.isRelatedField(a.fieldName)});if(!l||!l.length)return[2];b.forEach(function(a){return q._configureRelatedInfo(a,h)});return[4,p.queryLayerInfos({relatedInfos:e,layer:h},f)];case 1:return m=d.sent(),Object.keys(m).forEach(function(a){var b,c=e.get(a.toString());a=null===(b=m[a])||void 0===b?
void 0:b.value;c&&a&&(c.layerInfo=a.data)}),[4,p.queryRelatedFeatures({graphic:a,relatedInfos:e,layer:h},f)];case 2:return n=d.sent(),Object.keys(n).forEach(function(a){var b;p.setRelatedFeatures(null===(b=n[a])||void 0===b?void 0:b.value,e.get(a.toString()))}),[2]}})})};b.prototype._configureRelatedInfo=function(a,b){var c=this.relatedInfos,d=p.getRelatedFieldInfo(a.fieldName);if(d){var e=d.layerId,d=d.fieldName;e&&(b=c.get(e.toString())||p.createRelatedInfo(e,b))&&(p.updateRelatedInfo({relatedInfo:b,
fieldName:d,fieldInfo:a}),this.relatedInfos.set(e,b))}};d.__decorate([f.property()],b.prototype,"_featureAbortController",void 0);d.__decorate([f.property({readOnly:!0,dependsOn:"graphic graphic.sourceLayer.popupTemplate graphic.sourceLayer.popupTemplate.title graphic.sourceLayer.popupTemplate.content graphic.sourceLayer.popupTemplate.expressionInfos graphic.sourceLayer.popupTemplate.fieldInfos graphic.sourceLayer.popupTemplate.lastEditInfoEnabled graphic.sourceLayer.popupTemplate.outFields graphic.sourceLayer.popupTemplate.relatedRecordsInfo graphic.popupTemplate graphic.popupTemplate.title graphic.popupTemplate.content graphic.popupTemplate.expressionInfos graphic.popupTemplate.fieldInfos graphic.popupTemplate.lastEditInfoEnabled graphic.popupTemplate.outFields graphic.popupTemplate.relatedRecordsInfo defaultPopupTemplateEnabled".split(" ")})],
b.prototype,"_effectivePopupTemplate",null);d.__decorate([f.property({readOnly:!0,dependsOn:["_effectivePopupTemplate","_sourceLayer"]})],b.prototype,"_fieldInfoMap",null);d.__decorate([f.property({readOnly:!0,dependsOn:["graphic.layer","graphic.sourceLayer"]})],b.prototype,"_sourceLayer",null);d.__decorate([f.property({readOnly:!0})],b.prototype,"content",void 0);d.__decorate([f.property({readOnly:!0})],b.prototype,"contentViewModels",void 0);d.__decorate([f.property({type:Boolean})],b.prototype,
"defaultPopupTemplateEnabled",void 0);d.__decorate([f.property({readOnly:!0})],b.prototype,"formattedAttributes",void 0);d.__decorate([f.property({type:y,value:null})],b.prototype,"graphic",null);d.__decorate([f.property({readOnly:!0})],b.prototype,"lastEditInfo",void 0);d.__decorate([f.property()],b.prototype,"relatedInfos",void 0);d.__decorate([f.property({dependsOn:["view"]})],b.prototype,"spatialReference",null);d.__decorate([f.property({readOnly:!0})],b.prototype,"title",void 0);d.__decorate([f.property({dependsOn:["view"]})],
b.prototype,"map",null);d.__decorate([f.property({readOnly:!0,dependsOn:["_featureAbortController"]})],b.prototype,"waitingForContent",null);d.__decorate([f.property()],b.prototype,"view",void 0);return b=d.__decorate([f.subclass("esri.widgets.FeatureViewModel")],b)}(z)});