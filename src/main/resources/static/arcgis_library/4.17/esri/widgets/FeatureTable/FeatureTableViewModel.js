// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.17/esri/copyright.txt for details.
//>>built
define("require exports tslib ../../Graphic ../../intl ../../core/arrayUtils ../../core/Collection ../../core/HandleOwner ../../core/Handles ../../core/watchUtils ../../core/accessorSupport/decorators ../../layers/FeatureLayer ../../views/support/layerViewUtils ./AttachmentsColumn ./FieldColumn ./Grid/Grid ./Grid/GridViewModel ./support/FeatureStore".split(" "),function(F,G,d,m,h,n,v,w,x,f,e,y,z,A,p,B,C,q){return function(r){function c(a){var b=r.call(this,a)||this;b._defaultHiddenFields=["CreationDate",
"Creator","EditDate","Editor","GlobalID"];b._highlights=new x;b.attachmentsEnabled=!1;b.cellClassNameGenerator=function(a,b){return a.path||null};b.dataProvider=function(a,c){return d.__awaiter(b,void 0,void 0,function(){var b,g,k,e,f,l,u;return d.__generator(this,function(d){switch(d.label){case 0:return b=this.store,g=a.page,k=a.pageSize,e=a.sortOrders,f=this._sortOrdersToLayerOrderByFields(e),c?b?[4,b.set({orderByFields:f})]:(c&&c([]),[2]):[2];case 1:return d.sent(),"loaded"===b.state||"loading"===
b.state?[3,3]:[4,b.load()];case 2:d.sent(),d.label=3;case 3:l=c;if(!l)return[3,5];u=c;return[4,b.fetchItems({page:g,pageSize:k})];case 4:l=u.apply(void 0,[d.sent()]),d.label=5;case 5:return l,[2]}})})};b.editingEnabled=!1;b.grid=null;b.hiddenFields=new v;b.highlightOnRowSelectEnabled=!0;b.itemIdPath="objectId";b.messagesCommon=null;b.relatedRecordsEnabled=!1;b.store=null;b.view=null;a=b.itemIdPath;b.hiddenFields.addMany(b._defaultHiddenFields);b._set("store",new q);b._set("grid",new B({itemIdPath:a,
viewModel:b}));return b}d.__extends(c,r);c.prototype.initialize=function(){var a=this,b=function(){return d.__awaiter(a,void 0,void 0,function(){var a,b;return d.__generator(this,function(g){switch(g.label){case 0:return a=this,[4,h.loadMessageBundle("esri/widgets/FeatureTable/t9n/FeatureTable")];case 1:return a.messages=g.sent(),b=this,[4,h.loadMessageBundle("esri/t9n/common")];case 2:return b.messagesCommon=g.sent(),[2]}})})};b();this.handles.add([h.onLocaleChange(b),f.on(this,"grid.selectedItems",
"change",function(b){return a._onSelectionChange(b)}),f.watch(this,"relatedRecordsEnabled",function(b){return a.store.relatedRecordsEnabled=b}),f.watch(this,["layer.loaded"],function(){var b;if(null===(b=a.layer)||void 0===b?0:b.loaded)(b=a._getPageSizeFromLayer())&&a.grid.set({pageSize:b}),a._generateColumns()}),f.watch(this,["editingEnabled","messages"],function(){var b;return(null===(b=a.layer)||void 0===b?void 0:b.loaded)&&a._generateColumns()}),f.watch(this,"layer.definitionExpression",function(b,
c){return(b||c)&&"loaded"===a.store.state&&a.refresh()}),f.watch(this,"attachmentsEnabled",function(b,c){(b||c)&&"loaded"===a.store.state&&(a.store.attachmentsEnabled=!0,a.refresh(),a._generateColumns())})])};c.prototype.destroy=function(){this._resetColumns();this.columns.destroy();this.handles.removeAll();this._highlights.removeAll();this._highlights.destroy();this.view=this.layer=null};Object.defineProperty(c.prototype,"fieldConfigs",{set:function(a){var b;this._set("fieldConfigs",a);(null===(b=
this.layer)||void 0===b?0:b.loaded)&&this._generateColumns()},enumerable:!1,configurable:!0});Object.defineProperty(c.prototype,"layer",{set:function(a){this._set("layer",a);this._resetColumns();this.store.set({layer:a});a&&a.load();this.notifyChange("state")},enumerable:!1,configurable:!0});Object.defineProperty(c.prototype,"messages",{set:function(a){var b;null===(b=this.grid)||void 0===b?void 0:b.set("messages",a);this._set("messages",a)},enumerable:!1,configurable:!0});c.prototype.clearHighlights=
function(){this._highlights.removeAll()};c.prototype.clearSelection=function(){var a;null===(a=this.grid)||void 0===a?void 0:a.clearSelection()};c.prototype.deselectRows=function(a){var b=this;a=a instanceof Array?a:[a];a.forEach(function(a){return b._deselectRow(a)})};c.prototype.getObjectIdIndex=function(a){var b;return null===(b=this.store)||void 0===b?void 0:b.getObjectIdIndex(a)};c.prototype.getValue=function(a,b){var c;a=this.store.getItemByObjectId(a);return null===(c=null===a||void 0===a?
void 0:a.feature)||void 0===c?void 0:c.attributes[b]};c.prototype.refresh=function(){var a;null===(a=this.grid)||void 0===a?void 0:a.refresh()};c.prototype.selectRows=function(a){var b=this;a=a instanceof Array?a:[a];a.forEach(function(a){return b._selectRow(a)})};c.prototype._generateColumns=function(){this._resetColumns();this.columns.addMany(d.__spreadArrays(this._createFieldColumns()));this.attachmentsEnabled&&this.columns.push(this._createAttachmentsColumn())};c.prototype._createFieldColumns=
function(){return this.fieldConfigs&&this.fieldConfigs.length?this._createColumnsFromConfigs():this._createColumnsFromFields()};c.prototype._createColumnsFromConfigs=function(){var a=this.editingEnabled,b=this.fieldConfigs,c=this.grid,d=this.hiddenFields,e=this.layer,f=this.messages,h=this.messagesCommon,D=this.store,E=this.get("layer.fields")||[];return b.map(function(b){var g=b.direction||null,k=b.formatFunction||null,t=n.find(E||[],function(a){return b.name===a.name}),l=!1===b.visible||!0!==b.visible&&
-1<d.indexOf(t.name);return new p({config:b,direction:g,editingEnabled:a,field:t,formatFunction:k,grid:c,hidden:l,layer:e,store:D,messages:f,messagesCommon:h})})};c.prototype._createColumnsFromFields=function(){var a=this.editingEnabled,b=this.grid,c=this.hiddenFields,d=this.layer,e=this.messages,f=this.messagesCommon,h=this.store;return(this.get("layer.fields")||[]).map(function(g){var k=-1<c.indexOf(g.name);return new p({editingEnabled:a,field:g,grid:b,hidden:k,layer:d,store:h,messages:e,messagesCommon:f})})};
c.prototype._createAttachmentsColumn=function(){var a;return new A({header:null===(a=this.messages)||void 0===a?void 0:a.attachments})};c.prototype._sortOrdersToLayerOrderByFields=function(a){return a&&a.length?a.filter(function(a,c,d){return d.map(function(a){return a.path}).indexOf(a.path)===c}).map(function(a){return a.path+" "+a.direction.toUpperCase()}):[]};c.prototype._highlight=function(a){var b=this.view,b=b&&a&&n.find(b.allLayerViews.items,function(b){return b.layer===a.layer});z.highlightsSupported(b)&&
this._highlights.add(b.highlight(a),"feature-"+a.getObjectId())};c.prototype._unhighlight=function(a){a&&this._highlights.remove("feature-"+a.getObjectId())};c.prototype._selectRow=function(a){var b=this.grid,c=a instanceof m?a:null;a=c?c.getObjectId():a;var d=this.getObjectIdIndex(a);-1===d?null===b||void 0===b?void 0:b.selectItem({objectId:a,feature:c}):null===b||void 0===b?void 0:b.selectRow(d)};c.prototype._deselectRow=function(a){var b=this.grid;a=a instanceof m?a.getObjectId():a;var c=this.getObjectIdIndex(a);
-1===c?null===b||void 0===b?void 0:b.deselectItem({objectId:a}):null===b||void 0===b?void 0:b.deselectRow(c)};c.prototype._onSelectionChange=function(a){var b=this,c=this.highlightOnRowSelectEnabled,d=a.added;a=a.removed;c&&d.forEach(function(a){return b._highlight(a.feature)});c&&a.forEach(function(a){return b._unhighlight(a.feature)})};c.prototype._resetColumns=function(){this.columns.items.forEach(function(a){return a.destroy()});this.columns.removeAll()};c.prototype._getPageSizeFromLayer=function(){var a,
b,c;return(null===(c=null===(b=null===(a=this.layer)||void 0===a?void 0:a.capabilities)||void 0===b?void 0:b.query)||void 0===c?void 0:c.maxRecordCount)||0};d.__decorate([e.property()],c.prototype,"attachmentsEnabled",void 0);d.__decorate([e.property()],c.prototype,"cellClassNameGenerator",void 0);d.__decorate([e.property()],c.prototype,"dataProvider",void 0);d.__decorate([e.property()],c.prototype,"editingEnabled",void 0);d.__decorate([e.property({dependsOn:["messages","layer.loaded"]})],c.prototype,
"fieldConfigs",null);d.__decorate([e.property({readOnly:!0})],c.prototype,"grid",void 0);d.__decorate([e.property()],c.prototype,"hiddenFields",void 0);d.__decorate([e.property()],c.prototype,"highlightOnRowSelectEnabled",void 0);d.__decorate([e.property({readOnly:!0})],c.prototype,"itemIdPath",void 0);d.__decorate([e.property({type:y})],c.prototype,"layer",null);d.__decorate([e.property()],c.prototype,"messages",null);d.__decorate([e.property()],c.prototype,"messagesCommon",void 0);d.__decorate([e.property()],
c.prototype,"relatedRecordsEnabled",void 0);d.__decorate([e.property({readOnly:!0,type:q})],c.prototype,"store",void 0);d.__decorate([e.property()],c.prototype,"view",void 0);return c=d.__decorate([e.subclass("esri.widgets.FeatureTable.FeatureTableViewModel")],c)}(w.HandleOwnerMixin(C))});