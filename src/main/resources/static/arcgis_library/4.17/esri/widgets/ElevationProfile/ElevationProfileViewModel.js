// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.17/esri/copyright.txt for details.
//>>built
define("require exports tslib ../../Color ../../core/Accessor ../../core/Collection ../../core/collectionUtils ../../core/Handles ../../core/Logger ../../core/maybe ../../core/unitUtils ../../core/watchUtils ../../core/accessorSupport/decorators ../../core/libs/gl-matrix-2/vec4f64 ../../views/3d/interactive/visualElements/PointVisualElement ./ElevationProfileInteraction ./ElevationProfileLine ./ElevationProfileLineUpdater ./GroundElevationProvider ./support/chartUtils ./support/constants ./support/profileUtils ../support/commonProperties".split(" "),
function(F,G,c,q,r,g,t,u,v,f,l,m,d,w,x,y,h,z,A,B,k,C,D){var E=v.getLogger("ElevationProfileViewModel"),n=g.ofType(h);return function(p){function a(b){var e=p.call(this,b)||this;e.view=null;e.path=null;e.options=k.DEFAULT_OPTIONS;e.hoveredChartPosition=null;e.queue=null;e._handles=new u;e._pointVisualElements=[];e._userUnitOptions=null;e._userUnit=null;e._lineUpdaters=new g;e._defaultProvider=new A;b.profiles||(e.profiles=new n([new h({label:"Elevation",provider:e._defaultProvider})]));return e}c.__extends(a,
p);a.prototype.initialize=function(){var b=this,e,a=this.view;this.queue=C.createProfileQueue("3d"===a.type?null===(e=a.resourceController)||void 0===e?void 0:e.scheduler:void 0);this._interaction=new y({parentViewModel:this});this._handles.add([this.profiles.on("change",function(){return b._onProfilesChange()}),m.init(this,["_hoveredPoints","chartData"],function(){return b._onHoveredPointsChange()}),this._syncGroundToDefaultProvider()]);this._onProfilesChange()};a.prototype.destroy=function(){this._handles.destroy();
this._destroyLineUpdaters();this._destroyPointVisualElements();this._defaultProvider.destroy();this._interaction.destroy()};Object.defineProperty(a.prototype,"state",{get:function(){var b,a;return null!==(a=null===(b=this._interaction)||void 0===b?void 0:b.state)&&void 0!==a?a:"disabled"},enumerable:!1,configurable:!0});Object.defineProperty(a.prototype,"progress",{get:function(){var b=this.profiles.length;return 0===b?1:this.profiles.reduce(function(b,a){return b+a.progress},0)/b},enumerable:!1,
configurable:!0});Object.defineProperty(a.prototype,"updating",{get:function(){return 1>this.progress},enumerable:!1,configurable:!0});Object.defineProperty(a.prototype,"unitOptions",{get:function(){return this._filteredOrAllUnits(this._userUnitOptions)},set:function(b){this._userUnitOptions=b;this._set("unitOptions",this._filteredOrAllUnits(this._userUnitOptions))},enumerable:!1,configurable:!0});Object.defineProperty(a.prototype,"unit",{get:function(){return this._userUnit?this._userUnit=this._findSelectableUnit(this._userUnit,
this.defaultUnit):this._findSelectableUnit(this.defaultUnit)},set:function(b){this._userUnit=b?this._findSelectableUnit(b,this._userUnit):null;this.notifyChange("unit")},enumerable:!1,configurable:!0});a.prototype._castOptions=function(b){return c.__assign(c.__assign({},k.DEFAULT_OPTIONS),b)};Object.defineProperty(a.prototype,"profiles",{set:function(b){b=null!==b&&void 0!==b?b:new g;var a=b.filter(function(b){return b instanceof h});a.length!==b.length&&E.error("Some profiles are not instances of ElevationProfileLine");
this._set("profiles",t.referenceSetter(a,this._get("profiles")))},enumerable:!1,configurable:!0});Object.defineProperty(a.prototype,"chartData",{get:function(){var b=this.path;return f.isSome(b)?B.getChartData(this.profiles.toArray(),b.spatialReference,this.unit):null},enumerable:!1,configurable:!0});Object.defineProperty(a.prototype,"_hoveredPoints",{get:function(){var b=this.hoveredChartPosition;return f.isNone(this.path)||f.isNone(b)||this.updating?[]:this.profiles.toArray().map(function(a){return a.getPoint(b)}).filter(f.isSome)},
enumerable:!1,configurable:!0});a.prototype.start=function(){this._interaction.start()};a.prototype.stop=function(){this._interaction.stop()};a.prototype.cancel=function(){this._interaction.cancel()};a.prototype.clear=function(){this._interaction.clear()};a.prototype._syncGroundToDefaultProvider=function(){var b=this;return m.init(this,"view.map.ground",function(){var a,c=null===(a=b.view.map)||void 0===a?void 0:a.ground;c&&(b._defaultProvider.ground=c)})};a.prototype._onProfilesChange=function(){var b=
this;this._handles.remove("profiles");this._destroyLineUpdaters();this._lineUpdaters=this.profiles.map(function(a){return new z({line:a,parentViewModel:b})});for(var a=0,c=this.profiles.items;a<c.length;a++){var d=c[a];this._handles.add([d.watch(["id","label","color","samples","stats"],function(){return b.notifyChange("chartData")}),d.watch("progress",function(){b.notifyChange("progress");b.notifyChange("_hoveredPoints")})],"profiles")}};a.prototype._destroyLineUpdaters=function(){this._lineUpdaters.drain(function(a){return a.destroy()})};
a.prototype._onHoveredPointsChange=function(){var a=this._hoveredPoints,c=this.profiles;if(0===c.length)this._destroyPointVisualElements();else{for(;this._pointVisualElements.length>a.length;)this._pointVisualElements.pop().destroy();for(;this._pointVisualElements.length<a.length;){var d=new x.PointVisualElement({view:this.view,size:k.HOVERED_POINT_SIZE,elevationInfo:{mode:"absolute-height",offset:0}});d.primitive="circle";d.hidden=!0;d.attached=!0;this._pointVisualElements.push(d)}for(var f=0;f<
a.length;++f){d=this._pointVisualElements[f];d.geometry=a[f];var g=c.getItemAt(f);d.color=w.vec4f64.fromArray(q.toUnitRGBA(g.color))}}};a.prototype._destroyPointVisualElements=function(){this._pointVisualElements.forEach(function(a){return a.destroy()});this._pointVisualElements.length=0};a.prototype._findSelectableUnit=function(a,c){var b=this.unitOptions;return f.isSome(a)&&-1!==b.indexOf(a)?a:c?this._findSelectableUnit(c):b[0]};a.prototype._filteredOrAllUnits=function(a){a=(f.isSome(a)?a:[]).filter(function(a){return-1!==
l.measurementLengthUnits.indexOf(a)});return 0===a.length?l.measurementLengthUnits.slice():a};c.__decorate([d.property({value:null})],a.prototype,"view",void 0);c.__decorate([d.property({readOnly:!0,dependsOn:["_interaction.state"]})],a.prototype,"state",null);c.__decorate([d.property({readOnly:!0,dependsOn:["profiles"]})],a.prototype,"progress",null);c.__decorate([d.property({readOnly:!0,dependsOn:["progress"]})],a.prototype,"updating",null);c.__decorate([d.property(D.defaultUnitPropertyMetadata)],
a.prototype,"defaultUnit",void 0);c.__decorate([d.property({dependsOn:["view.spatialReference"]})],a.prototype,"unitOptions",null);c.__decorate([d.property({dependsOn:["unitOptions","defaultUnit"]})],a.prototype,"unit",null);c.__decorate([d.property()],a.prototype,"path",void 0);c.__decorate([d.property({nonNullable:!0})],a.prototype,"options",void 0);c.__decorate([d.cast("options")],a.prototype,"_castOptions",null);c.__decorate([d.property({type:n,nonNullable:!0})],a.prototype,"profiles",null);c.__decorate([d.property()],
a.prototype,"hoveredChartPosition",void 0);c.__decorate([d.property({readOnly:!0,dependsOn:["path.spatialReference","profiles","unit"]})],a.prototype,"chartData",null);c.__decorate([d.property()],a.prototype,"queue",void 0);c.__decorate([d.property()],a.prototype,"_interaction",void 0);c.__decorate([d.property()],a.prototype,"_lineUpdaters",void 0);c.__decorate([d.property()],a.prototype,"_defaultProvider",void 0);c.__decorate([d.property({readOnly:!0,dependsOn:["path","profiles","updating","hoveredChartPosition"]})],
a.prototype,"_hoveredPoints",null);return a=c.__decorate([d.subclass("esri.widgets.ElevationProfile.ElevationProfileViewModel")],a)}(r)});