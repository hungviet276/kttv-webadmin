// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.17/esri/copyright.txt for details.
//>>built
define("require exports tslib ../../assets ../../Graphic ../../PopupTemplate ../../core/Accessor ../../core/Collection ../../core/Error ../../core/Evented ../../core/Handles ../../core/has ../../core/Logger ../../core/maybe ../../core/promiseUtils ../../core/watchUtils ../../core/accessorSupport/decorators ../../geometry/Point ../../geometry/SpatialReference ../../intl/locale ../../intl/messages ../../portal/Portal ../../smartMapping/symbology/location ../../symbols/PictureMarkerSymbol ../../symbols/SimpleFillSymbol ../../symbols/SimpleLineSymbol ../../symbols/SimpleMarkerSymbol ../../symbols/TextSymbol ../../views/support/layerViewUtils ./LayerSearchSource ./LocatorSearchSource ./SearchSource ./support/geometryUtils ./support/locatorUtils ../support/geolocationUtils ../support/GoTo".split(" "),
function(ca,da,d,G,C,w,H,I,m,J,K,L,M,u,g,r,f,v,N,O,P,x,y,Q,R,S,T,U,V,z,D,W,B,X,q,Y){function l(d,b){return d.hasOwnProperty(b)&&null!=d[b]&&""!==d[b]}var n=M.getLogger("esri.widgets.Search.SearchViewModel"),t=I.ofType({key:function(d){return d.layer?"layer":"locator"},base:W,typeMap:{layer:z,locator:D}}),F=N.WGS84,Z=/<(?:.|\s)*?>/g;return function(E){function b(a){a=E.call(this,a)||this;a._handles=new K;a._gotoController=null;a._searching=null;a.autoNavigate=!0;a.autoSelect=!0;a.defaultPopupTemplate=
null;a.defaultSources=new t;a.defaultSymbol=new Q({url:G.getAssetUrl(L("trident")?"esri/images/search/search-symbol-32.png":"esri/images/search/search-symbol-32.svg"),size:24,width:24,height:24});a.includeDefaultSources=!0;a.maxInputLength=128;a.maxResults=6;a.maxSuggestions=6;a.messages=null;a.minSuggestCharacters=1;a.popupEnabled=!0;a.popupTemplate=null;a.portal=x.getDefault();a.resultCount=null;a.resultGraphicEnabled=!0;a.resultGraphic=null;a.results=null;a.selectedSuggestion=null;a.searchAllEnabled=
!0;a.selectedResult=null;a.sources=new t;a.suggestionDelay=150;a.suggestionCount=null;a.suggestions=null;a.suggestionsEnabled=!0;a.view=null;return a}d.__extends(b,E);b.prototype.initialize=function(){var a=this,c=function(){return d.__awaiter(a,void 0,void 0,function(){var a;return d.__generator(this,function(c){switch(c.label){case 0:return[4,P.loadMessageBundle("esri/widgets/Search/t9n/Search")];case 1:return this.messages=a=c.sent(),this.defaultPopupTemplate=new w({title:a.searchResult,content:"{Match_addr}"}),
[2]}})})};c();this._handles.add([r.on(this,["defaultSources","sources"],"change",function(){return a.notifyChange("allSources")}),r.init(this,["includeDefaultSources","view","portal"],function(){return a._update()}),O.onLocaleChange(c)])};b.prototype.destroy=function(){this._abortGoTo();this.clearGraphics();this._handles.destroy();this._handles=null};Object.defineProperty(b.prototype,"activeSource",{get:function(){return this.allSources.getItemAt(this.activeSourceIndex)||null},enumerable:!1,configurable:!0});
Object.defineProperty(b.prototype,"activeSourceIndex",{get:function(){return 1!==this.allSources.length&&this.searchAllEnabled?-1:0},set:function(a){void 0===a?this._clearOverride("activeSourceIndex"):this._override("activeSourceIndex",a)},enumerable:!1,configurable:!0});Object.defineProperty(b.prototype,"allPlaceholder",{get:function(){var a;return null===(a=this.messages)||void 0===a?void 0:a.allPlaceholder},set:function(a){a?this._override("allPlaceholder",a):this._clearOverride("allPlaceholder")},
enumerable:!1,configurable:!0});Object.defineProperty(b.prototype,"allSources",{get:function(){var a=this.sources,c=this.defaultSources,e=this.includeDefaultSources,a="function"===typeof e?e.call(null,{sources:a,defaultSources:c}):e?c.concat(a):a,c=this._get("allSources")||new t;c.removeAll();c.addMany(a.filter(Boolean));return c},enumerable:!1,configurable:!0});Object.defineProperty(b.prototype,"locationEnabled",{get:function(){return this._get("locationEnabled")||q.supported()},set:function(a){if(void 0===
a)this._clearOverride("locationEnabled");else{var c=q.supported();if(a&&!c){var e=new m("locationEnabled:geolocation-unsupported","Geolocation API is unsupported.",{geolocation:navigator.geolocation});n.error(e)}this._override("locationEnabled",a&&c)}},enumerable:!1,configurable:!0});Object.defineProperty(b.prototype,"placeholder",{get:function(){var a=this.activeSourceIndex,c=this.allPlaceholder;return-1===a?c:(a=this.allSources.getItemAt(a))?a.placeholder:""},enumerable:!1,configurable:!0});Object.defineProperty(b.prototype,
"searchTerm",{get:function(){return this._get("searchTerm")||""},set:function(a){this._set("searchTerm",a||"");this.clearGraphics();this.selectedSuggestion&&this.selectedSuggestion.text!==a&&this._set("selectedSuggestion",null);""===a&&this._clear()},enumerable:!1,configurable:!0});Object.defineProperty(b.prototype,"state",{get:function(){return this._searching?"searching":this.updating?"loading":0===this.allSources.length?"disabled":"ready"},enumerable:!1,configurable:!0});Object.defineProperty(b.prototype,
"updating",{get:function(){return null!=this._updatingPromise},enumerable:!1,configurable:!0});b.prototype.clear=function(){this.searchTerm=""};b.prototype.clearGraphics=function(){this._removeHighlight();this._closePopup();this.view&&this.view.graphics.remove(this.resultGraphic);this._set("resultGraphic",null)};b.prototype.search=function(a,c){var e=this;this.emit("search-start");this.clearGraphics();var b=this._createSuggestionForSearch(a);this._searching=a=this.when().then(function(){return e._getResultsFromSources(b,
c).then(function(a){var c={activeSourceIndex:e.activeSourceIndex,searchTerm:b.text,numResults:0,numErrors:0,errors:[],results:[]};e._formatResponse(c,a,b);a=e._getFirstResult(c.results);var k=(b.location&&a?a.name:b.text).replace(Z,"");e._set("searchTerm",k);(b.key&&"number"===typeof b.sourceIndex||b.location)&&e._set("selectedSuggestion",b);e._set("results",c.results);e._set("resultCount",c.results.reduce(function(a,c){return a+c.results.length},0));e.emit("search-complete",c);return e._selectFirstResult(a).then(function(){return c})})}).then(function(a){e._clearSearching();
return a},function(a){e._clearSearching();throw a;});this.notifyChange("state");return a};b.prototype.searchNearby=function(a){var c=this;if(!this.locationEnabled){var e=new m("searchNearby:geolocation-unsupported","Geolocation API is unsupported.",{geolocation:navigator.geolocation});n.error(e);return g.reject(e)}this._searching=e=q.getCurrentPosition().then(function(e){return q.positionToPoint({position:e,view:c.view},a)}).then(function(e){return c.search(e,a)});this.notifyChange("state");e.catch(function(){}).then(function(){return c._clearSearching()});
return e};b.prototype.select=function(a){var c=this;this.clearGraphics();if(!a){var e=new m("select:missing-parameter","Cannot select without a searchResult.",{searchResult:a});n.error(e);return g.reject(e)}var b=this.view,d=l(a,"sourceIndex")?a.sourceIndex:this._getSourceIndexOfResult(a),h=this.allSources.getItemAt(d);if(!h)return e=new m("select:missing-source","Cannot select without a source.",{source:h}),n.error(e),g.reject(e);var e=h instanceof z?this._getLayerSourcePopupTemplate(h):h.popupTemplate,
f=h.resultSymbol||this._getDefaultSymbol(a),ba=l(h,"resultGraphicEnabled")?h.resultGraphicEnabled:this.resultGraphicEnabled,r=l(h,"autoNavigate")?h.autoNavigate:this.autoNavigate,q=l(h,"popupEnabled")?h.popupEnabled:this.popupEnabled,t=q?e||this.popupTemplate||this.defaultPopupTemplate:null,p=a.feature;if(!p)return e=new m("select:missing-feature","Cannot select without a feature.",{feature:p}),n.error(e),g.reject(e);var w=p.attributes,v=p.geometry,x=p.layer,y=p.sourceLayer,A=B.getPointFromGeometry(v),
e={layerViewQuery:this._getLayerView(p),elevationQuery:b&&u.isSome(A)?B.getPointWithElevation(A,b).catch(function(){return A}):g.resolve(A)};return g.eachAlways(e).then(function(e){var k=e.layerViewQuery.value,aa=e.elevationQuery.value;f instanceof U&&(f.text=a.name);e=b&&r?a.target||a.extent:null;return(u.isSome(e)?c._goToSearchResult(e):g.resolve()).then(function(){var e=k?p:new C({geometry:v,symbol:f,attributes:w,layer:x,sourceLayer:y,popupTemplate:t}),g=q&&c.get("view.popup");if(g=g&&e.getEffectivePopupTemplate(g.defaultPopupTemplateEnabled))b.popup.open({features:[e],
location:aa}),b.popup.focus();k&&V.highlightsSupported(k)&&!g&&c._highlightFeature({graphic:e,layerView:k});!k&&ba&&b&&b.graphics.push(e);c._set("selectedResult",a);c._set("resultGraphic",e);c.emit("select-result",{result:a,source:h,sourceIndex:d});return a})})};b.prototype.suggest=function(a,c,e){var b=this,d=a||this.searchTerm;this.emit("suggest-start",{searchTerm:d});return this._suggestTimer(c,e).then(function(){return b._suggestImmediate(d,e).then(function(a){b._set("suggestions",a.results);
b._set("suggestionCount",a.results.reduce(function(a,c){return a+c.results.length},0));b.emit("suggest-complete",a);return a})})};b.prototype.when=function(){return d.__awaiter(this,void 0,void 0,function(){return d.__generator(this,function(a){switch(a.label){case 0:return[4,r.whenFalseOnce(this,"updating")];case 1:return a.sent(),[2]}})})};b.prototype._update=function(){return d.__awaiter(this,void 0,void 0,function(){var a,c,e,b,f;return d.__generator(this,function(k){switch(k.label){case 0:a=
this;c=a.portal;e=a.view;if(!this.includeDefaultSources)return[3,2];b=this._updatingPromise=g.eachAlways([null===c||void 0===c?void 0:c.load(),null===e||void 0===e?void 0:e.when()]);if(this.destroyed)return[2];this.notifyChange("updating");return[4,b];case 1:k.sent();if(b!==this._updatingPromise)return[2];k.label=2;case 2:this._updatingPromise=null;this.notifyChange("updating");f=r.whenOnce(this,"messages");if(this.destroyed)return[2];this._handles.add(f);return[4,f];case 3:return k.sent(),this._updateDefaultSources(),
[2]}})})};b.prototype._clearSearching=function(){this._searching=null;this.notifyChange("state")};b.prototype._convertHelperServices=function(){var a=this,c=this.get("portal.helperServices.geocode");return c?c.map(function(c){if(!1!==c.placefinding&&(c=D.fromJSON(c),X.isArcGISWorldGeocoder(c.get("locator.url"))&&c.set({singleLineFieldName:"SingleLine",outFields:c.outFields||["Addr_type","Match_addr","StAddr","City"],placeholder:c.placeholder||a.messages.placeholder,defaultZoomScale:"number"===typeof c.defaultZoomScale?
c.defaultZoomScale:2500}),c.singleLineFieldName))return c}).filter(Boolean):[]};b.prototype._convertApplicationProperties=function(){var a=this,c=this.get("view.map.applicationProperties.viewing.search"),b=this.get("view.map");if(!b||!c)return[];var k=c.hintText;return c.enabled?c.layers.map(function(c){var e=b.findLayerById(c.id);if(e){c=a._getLayerJSON(c);var d=z.fromJSON(c);d.placeholder=k;a._getLayer(e,c).then(function(a){d.layer=a});return d}}).filter(Boolean).toArray():[]};b.prototype._getSubLayer=
function(a,c){return a&&a.allSublayers?(a=a.allSublayers.find(function(a){return a.id===c.subLayer}))?a.createFeatureLayer():g.reject():g.reject()};b.prototype._getLayer=function(a,c){var b=this;if("feature"===a.type||"scene"===a.type)return g.resolve(a);if("map-image"===a.type)return a.load().then(function(){return b._getSubLayer(a,c).catch(function(){var c=new m("search:create-featurelayer","Could not create a FeatureLayer from the MapImageLayer",{layer:a});n.error(c);return null})})};b.prototype._getLayerJSON=
function(a){return"function"===typeof a.toJSON?a.toJSON():a};b.prototype._updateDefaultSources=function(){var a=this.defaultSources,c=this.includeDefaultSources;a.removeAll();c&&a.addMany(d.__spreadArrays(this._convertApplicationProperties(),this._convertHelperServices()));this.notifyChange("allSources")};b.prototype._abortGoTo=function(){this._gotoController&&this._gotoController.abort();this._gotoController=null};b.prototype._clear=function(){this._abortGoTo();this._set("resultCount",null);this._set("results",
null);this._set("suggestions",null);this._set("suggestionCount",null);this._set("selectedResult",null);this._set("selectedSuggestion",null);this.emit("search-clear")};b.prototype._closePopup=function(){var a=this.get("view.popup"),c=this.resultGraphic;if(a&&c){var b=a.selectedFeature;b&&b===c&&a.close()}};b.prototype._suggestTimer=function(a,c){return g.after(null!=a?a:this.suggestionDelay,null,c&&c.signal)};b.prototype._createLocationForSearch=function(a){return a instanceof C?B.getPointFromGeometry(a.geometry):
a instanceof v?a:Array.isArray(a)&&2===a.length?new v({longitude:a[0],latitude:a[1]}):null};b.prototype._createSuggestionForSearch=function(a){if(a&&l(a,"key")&&l(a,"text")&&l(a,"sourceIndex"))return a;var c=this._createLocationForSearch(a),b="string"===typeof a?a:this.searchTerm,k=this.selectedSuggestion,d=this.selectedResult,f=(a=!a&&k&&d)&&k.location;return a&&k.key===d.key&&k.sourceIndex===d.sourceIndex||f?k:{location:u.unwrap(c),text:c?"":b,sourceIndex:null,key:null}};b.prototype._getFirstResult=
function(a){var c=null;a&&a.some(function(a){a=a.results[0];var b=!!a;b&&(c=a);return b});return c};b.prototype._selectFirstResult=function(a){return this.autoSelect&&a?this.select(a):g.resolve()};b.prototype._suggestImmediate=function(a,c){var b=this;return this.when().then(function(){return b._getSuggestionsFromSources(a,c)}).then(function(c){var e={activeSourceIndex:b.activeSourceIndex,searchTerm:a,numResults:0,numErrors:0,errors:[],results:[]};b._formatResponse(e,c);return e})};b.prototype._formatSourceResponse=
function(a,c,b){var e=c&&c.value||[];c=c&&c.error;var d=this.allSources.getItemAt(b);c?(a.errors.push({sourceIndex:b,source:d,error:c}),a.numErrors++):(a.results.push({sourceIndex:b,source:d,results:e}),a.numResults+=e.length)};b.prototype._formatResponse=function(a,c,b){var e=this;if(c)if(-1===a.activeSourceIndex){var d=b&&l(b,"sourceIndex")&&-1!==b.sourceIndex?b.sourceIndex:void 0;c.forEach(function(c,b){e._formatSourceResponse(a,c,void 0!==d?d:b)})}else this._formatSourceResponse(a,c[0],a.activeSourceIndex)};
b.prototype._getResultsFromSources=function(a,c){var b=this,d=this.allSources,f=!a.location&&l(a,"sourceIndex")?a.sourceIndex:this.activeSourceIndex,h=[];if(!d.length)return d=new m("search:no-sources-defined","At least one source is required.",{allSources:d}),n.error(d),g.reject(d);-1===f?d.forEach(function(e,d){h.push(b._getResultsFromSource(a,d,c))}):h.push(this._getResultsFromSource(a,f,c));return g.eachAlways(h)};b.prototype._getSuggestionsFromSources=function(a,c){var b=this,d=this.allSources,
f=this.activeSourceIndex,h=[];if(!d.length)return d=new m("suggest:no-sources-defined","At least one source is required.",{allSources:d}),n.error(d),g.reject(d);-1===f?d.forEach(function(d,e){h.push(b._getSuggestionsFromSource(a,e,c))}):h.push(this._getSuggestionsFromSource(a,f,c));return g.eachAlways(h)};b.prototype._getResultsFromSource=function(a,c,b){var d=this.allSources.getItemAt(c),e=a.location,e=void 0===e?null:e,f=this.get("view.spatialReference")||F,g=l(d,"maxResults")?d.maxResults:this.maxResults,
m=d instanceof z&&l(d,"exactMatch")?d.exactMatch:!1;return d.getResults({view:this.view,sourceIndex:c,location:e,suggestResult:a,spatialReference:f,exactMatch:m,maxResults:g},b)};b.prototype._getSuggestionsFromSource=function(a,c,b){var d=this.allSources.getItemAt(c),e=l(d,"suggestionsEnabled")?d.suggestionsEnabled:this.suggestionsEnabled,f=a.length,m=l(d,"minSuggestCharacters")?d.minSuggestCharacters:this.minSuggestCharacters;return e&&a.trim()&&f>=m?(e=this.get("view.spatialReference")||F,f=l(d,
"maxSuggestions")?d.maxSuggestions:this.maxSuggestions,d.getSuggestions({view:this.view,sourceIndex:c,suggestTerm:a,spatialReference:e,maxSuggestions:f},b)):g.resolve()};b.prototype.createDefaultSymbol=function(a,b){if("point"===b)return new T({color:a.color,size:a.size,outline:{color:a.outline.color,width:a.outline.width}});if("polyline"===b)return new S({color:a.color,width:a.width});if("polygon"===b)return new R({color:a.color,outline:{color:a.outline.color,width:a.outline.width}})};b.prototype._getLayerSourcePopupTemplate=
function(a){var b=a.layer;if(b)return l(a,"popupTemplate")?a.popupTemplate:b.popupTemplate};b.prototype._getSourceIndexOfResult=function(a){var b=null;this.results.some(function(c){return c.results.some(function(d){return d===a?(b=c.sourceIndex,!0):!1})});return b};b.prototype._goToSearchResult=function(a){return d.__awaiter(this,void 0,void 0,function(){var b,e,f;return d.__generator(this,function(c){switch(c.label){case 0:return b=!!a,this._abortGoTo(),this._gotoController=e=g.createAbortController(),
f={target:{target:a},options:{animate:b,signal:e.signal}},[4,this.callGoTo(f)];case 1:return c.sent(),this._gotoController=null,[2]}})})};b.prototype._getDefaultSymbol=function(a){var b=this.get("view.map.basemap.id");a=u.get(a,"feature","geometry","type");return u.isSome(a)&&(b=(b=y.getSchemes({basemap:b,geometryType:a})||y.getSchemes({basemap:"topo",geometryType:a}))&&b.primaryScheme)?(b.color&&l(b,"opacity")&&(b.color.a=b.opacity),this.createDefaultSymbol(b,a)):this.defaultSymbol};b.prototype._removeHighlight=
function(){this._handles.remove("highlight")};b.prototype._getLayerView=function(a){return d.__awaiter(this,void 0,void 0,function(){var b,e;return d.__generator(this,function(c){switch(c.label){case 0:b=this.view;if(!a||!b)return[2,g.resolve(null)];e=a.layer;return[4,b.when()];case 1:return c.sent(),[2,b.whenLayerView(e)]}})})};b.prototype._highlightFeature=function(a){var b=a.graphic,d=b.attributes,f=b.layer.objectIdField;a=a.layerView.highlight(d&&d[f]||b);this._handles.add(a,"highlight")};b.ALL_INDEX=
-1;d.__decorate([f.property({readOnly:!0,dependsOn:["activeSourceIndex","allSources.length"],value:null})],b.prototype,"activeSource",null);d.__decorate([f.property({dependsOn:["allSources.length","searchAllEnabled"]})],b.prototype,"activeSourceIndex",null);d.__decorate([f.property({dependsOn:["messages"]})],b.prototype,"allPlaceholder",null);d.__decorate([f.property({dependsOn:["defaultSources.length","sources.length","includeDefaultSources"],readOnly:!0})],b.prototype,"allSources",null);d.__decorate([f.property()],
b.prototype,"autoNavigate",void 0);d.__decorate([f.property()],b.prototype,"autoSelect",void 0);d.__decorate([f.property()],b.prototype,"defaultPopupTemplate",void 0);d.__decorate([f.property({readOnly:!0})],b.prototype,"defaultSources",void 0);d.__decorate([f.property()],b.prototype,"defaultSymbol",void 0);d.__decorate([f.property()],b.prototype,"includeDefaultSources",void 0);d.__decorate([f.property()],b.prototype,"locationEnabled",null);d.__decorate([f.property()],b.prototype,"maxInputLength",
void 0);d.__decorate([f.property()],b.prototype,"maxResults",void 0);d.__decorate([f.property()],b.prototype,"maxSuggestions",void 0);d.__decorate([f.property()],b.prototype,"messages",void 0);d.__decorate([f.property()],b.prototype,"minSuggestCharacters",void 0);d.__decorate([f.property({readOnly:!0,dependsOn:["activeSourceIndex","activeSource.placeholder","allPlaceholder","allSources"]})],b.prototype,"placeholder",null);d.__decorate([f.property()],b.prototype,"popupEnabled",void 0);d.__decorate([f.property({type:w})],
b.prototype,"popupTemplate",void 0);d.__decorate([f.property({type:x})],b.prototype,"portal",void 0);d.__decorate([f.property()],b.prototype,"resultCount",void 0);d.__decorate([f.property()],b.prototype,"resultGraphicEnabled",void 0);d.__decorate([f.property({readOnly:!0})],b.prototype,"resultGraphic",void 0);d.__decorate([f.property({readOnly:!0})],b.prototype,"results",void 0);d.__decorate([f.property({readOnly:!0})],b.prototype,"selectedSuggestion",void 0);d.__decorate([f.property()],b.prototype,
"searchAllEnabled",void 0);d.__decorate([f.property({readOnly:!0})],b.prototype,"selectedResult",void 0);d.__decorate([f.property()],b.prototype,"searchTerm",null);d.__decorate([f.property({type:t})],b.prototype,"sources",void 0);d.__decorate([f.property({readOnly:!0,dependsOn:["allSources.length","updating"]})],b.prototype,"state",null);d.__decorate([f.property()],b.prototype,"suggestionDelay",void 0);d.__decorate([f.property()],b.prototype,"suggestionCount",void 0);d.__decorate([f.property({readOnly:!0})],
b.prototype,"suggestions",void 0);d.__decorate([f.property()],b.prototype,"suggestionsEnabled",void 0);d.__decorate([f.property({readOnly:!0})],b.prototype,"updating",null);d.__decorate([f.property()],b.prototype,"view",void 0);d.__decorate([f.property()],b.prototype,"clear",null);return b=d.__decorate([f.subclass("esri.widgets.Search.SearchViewModel")],b)}(Y.GoToMixin(J.EventedMixin(H)))});