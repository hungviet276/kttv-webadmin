// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.17/esri/copyright.txt for details.
//>>built
define("require exports tslib ../../core/HandleOwner ../../core/maybe ../../core/scheduling ../../core/watchUtils ../../core/accessorSupport/decorators ../../views/SceneView ../../views/3d/environment/SceneViewLighting ../../views/3d/support/earthUtils ./daylightUtils ./daylightUtils ./support/SliderWithDropdownViewModel ../support/DatePickerViewModel".split(" "),function(u,v,d,m,n,p,f,c,q,r,t,e,g,h,k){return function(l){function b(a){a=l.call(this,a)||this;a.view=null;a.datePickerViewModel=new k;
a.timeSliderViewModel=new h.SliderWithDropdownViewModel;a.lightingUpdateInterval=200;a._cachedLightingDateUTC=new Date(0);a._cachedDisplayUTCOffset=0;a._enableShadowsOnFirstInteraction=!0;a._lastLightingUpdate=0;a._nextLightingUpdate=null;a.playSpeedMultiplier=1;return a}d.__extends(b,l);b.prototype.initialize=function(){var a=this;this.handles.add([f.init(this,"view",function(){a.view&&a.view.when(function(){return a._updateLighting(null)})}),f.watch(this,"view.environment.lighting.date",function(b){return a._scheduleUpdateLighting(b)}),
f.on(this,"view.environment.lighting","timezone-will-change",function(b){return a._timezoneWillChange(b)},function(){return a._timezoneWillChange(null)}),f.init(this,"view.stationary",function(){(a.dayPlaying||a.yearPlaying)&&a._updateSunriseAndSunset()}),this.watch(["timeSliderPosition","timeSliderViewModel.state"],function(){"ready"===a.timeSliderViewModel.state&&a.timeSliderViewModel.setValue(0,a.timeSliderPosition)}),this.timeSliderViewModel.watch("currentItem",function(b){return a.utcOffset=
b.abbr}),this.timeSliderViewModel.watch("isDropdownOpen",function(){return a.stopPlaying()}),this.timeSliderViewModel.watch("values",function(b){return a.timeSliderPosition=b[0]}),this.datePickerViewModel.watch("value",function(b){a.dayPlaying=!1;a.localDate=b}),this.watch("localDate",function(b){return d.__awaiter(a,void 0,void 0,function(){return d.__generator(this,function(a){this.datePickerViewModel.value.valueOf()!==b.getTime()&&this.datePickerViewModel.set("value",b);return[2]})})})])};b.prototype.destroy=
function(){this._nextLightingUpdate&&(clearTimeout(this._nextLightingUpdate),this._nextLightingUpdate=null);this.view=null};Object.defineProperty(b.prototype,"isSupported",{get:function(){return!this.view||"3d"===this.view.type},enumerable:!1,configurable:!0});Object.defineProperty(b.prototype,"utcOffset",{get:function(){return this._cachedDisplayUTCOffset},set:function(a){a!==this.utcOffset&&(this.view.environment.lighting.displayUTCOffset=a,this._updateLighting(null))},enumerable:!1,configurable:!0});
Object.defineProperty(b.prototype,"localDate",{get:function(){return e.dateTimeToLocalDate(this._lightingDateDisplay)},set:function(a){a.getTime()!==this.localDate.getTime()&&(this._lightingDateDisplay=e.localDateToDateTime(this._lightingDateDisplay,a))},enumerable:!1,configurable:!0});Object.defineProperty(b.prototype,"timeSliderPosition",{get:function(){return e.dateTimeToSliderPos(this._lightingDateDisplay)},set:function(a){Math.abs(a-this.timeSliderPosition)>1/60&&(this._lightingDateDisplay=e.sliderPosToDateTime(this._lightingDateDisplay,
a),this.stopPlaying(),this._enableShadowsOnFirstInteraction&&(this.directShadowsEnabled=!0,this._enableShadowsOnFirstInteraction=!1))},enumerable:!1,configurable:!0});Object.defineProperty(b.prototype,"_lightingDateDisplay",{get:function(){return e.dateAddHours(this._cachedLightingDateUTC,this._cachedDisplayUTCOffset)},set:function(a){a=e.dateAddHours(a,-this._cachedDisplayUTCOffset);a.getTime()!==this.view.environment.lighting.date.getTime()&&(this.view.environment.lighting.date=a,this._updateLighting(null))},
enumerable:!1,configurable:!0});b.prototype._timezoneFromCamera=function(a){a=a.camera.position;a=t.positionToTimezone([a.longitude,a.latitude]);return n.isSome(a)?Math.round(a.hours+a.minutes/60+a.seconds/3600):0};Object.defineProperty(b.prototype,"playingState",{set:function(a){this.playingState!==a&&(this._set("playingState",a),"none"!==a&&(this._updateSunriseAndSunset(),this._lastTime=(new Date).getTime(),this._play(),this._enableShadowsOnFirstInteraction&&(this.directShadowsEnabled=!0,this._enableShadowsOnFirstInteraction=
!1)))},enumerable:!1,configurable:!0});Object.defineProperty(b.prototype,"dayPlaying",{get:function(){return"day"===this.playingState},set:function(a){a?this.playingState="day":this.dayPlaying&&(this.playingState="none")},enumerable:!1,configurable:!0});Object.defineProperty(b.prototype,"yearPlaying",{get:function(){return"year"===this.playingState},set:function(a){a?this.playingState="year":this.yearPlaying&&(this.playingState="none")},enumerable:!1,configurable:!0});Object.defineProperty(b.prototype,
"currentSeason",{get:function(){return e.getSeasonFromDate(this.localDate,this._currentHemisphere)},set:function(a){this.stopPlaying();a=e.getNorthernHemisphereSeason(a,this._currentHemisphere);this.localDate=e.getSeasonDate(this.localDate,a,g.Hemisphere.NORTHERN)},enumerable:!1,configurable:!0});Object.defineProperty(b.prototype,"_currentHemisphere",{get:function(){var a,b,d=null===(b=null===(a=this.view)||void 0===a?void 0:a.camera)||void 0===b?void 0:b.position;return d?0<=d.latitude?g.Hemisphere.NORTHERN:
g.Hemisphere.SOUTHERN:g.Hemisphere.NORTHERN},enumerable:!1,configurable:!0});b.prototype.stopPlaying=function(){this.playingState="none"};b.prototype.toggleDayPlaying=function(){this.dayPlaying=!this.dayPlaying};b.prototype.toggleYearPlaying=function(){this.yearPlaying=!this.yearPlaying};b.prototype.toggleDirectShadows=function(){this.stopPlaying();this.directShadowsEnabled=!this.directShadowsEnabled};b.prototype._updateLighting=function(a){var b,d;this._lastLightingUpdate=Date.now();var c=null===
(d=null===(b=this.view)||void 0===b?void 0:b.environment)||void 0===d?void 0:d.lighting;c&&(a=a||c.date,c=c.displayUTCOffset,c=null!==c?c:this._timezoneFromCamera(this.view),this._cachedLightingDateUTC.getTime()!==a.getTime()&&(this._cachedLightingDateUTC=new Date(a.getTime())),this._cachedDisplayUTCOffset!==c&&(this._cachedDisplayUTCOffset=c))};b.prototype._timezoneWillChange=function(a){var b,d,c=null===(d=null===(b=this.view)||void 0===b?void 0:b.environment)||void 0===d?void 0:d.lighting;if(c){if(a)a=
a.timezoneOffset;else{if(null!=c.displayUTCOffset)return;a=r.calculateTimezoneOffset(c.positionTimezoneInfo)}c.displayUTCOffset=a;this._scheduleUpdateLighting(null)}};b.prototype._scheduleUpdateLighting=function(a){var b=this;if(!this._nextLightingUpdate){var c=Date.now()-this._lastLightingUpdate,c=this.lightingUpdateInterval-c;0>=c?p.schedule(function(){return b._updateLighting(a)}):this._nextLightingUpdate=setTimeout(function(){b._updateLighting(null);b._nextLightingUpdate=null},c)}};b.prototype._play=
function(){var a=this,b,c=this.view;if(null!==(b=this.view)&&void 0!==b&&b.environment&&(this.dayPlaying||this.yearPlaying)){b=(new Date).getTime()-this._lastTime;if(this.dayPlaying){if(this._lastTime=(new Date).getTime(),b*=e.calculatePlaySpeed(this._sunrise,this._sunset,c.environment.lighting.date)*this.playSpeedMultiplier/100,0<b){var d=new Date(c.environment.lighting.date.getTime()+b),f=((d.getUTCHours()+c.environment.lighting.displayUTCOffset)%24+24)%24,g=((c.environment.lighting.date.getUTCHours()+
c.environment.lighting.displayUTCOffset)%24+24)%24;f<g&&(d=new Date(c.environment.lighting.date.getTime()+b-864E5));c.environment.lighting.date=d}}else 1E3<b&&(this._lastTime=(new Date).getTime(),b=(c.environment.lighting.date.getUTCMonth()+1)%12,d=new Date(c.environment.lighting.date.getTime()),d.setUTCMonth(b),c.environment.lighting.date=d);requestAnimationFrame(function(){return a._play()})}};b.prototype._updateSunriseAndSunset=function(){var a=e.getSunriseAndSunsetTimes(this.view.environment.lighting.date,
this.view.camera.position.latitude,this.view.camera.position.longitude,this.view.environment.lighting.displayUTCOffset);this._sunrise=new Date(a.sunrise);this._sunset=new Date(a.sunset)};d.__decorate([c.property({type:q})],b.prototype,"view",void 0);d.__decorate([c.property({type:k})],b.prototype,"datePickerViewModel",void 0);d.__decorate([c.property({type:h.SliderWithDropdownViewModel})],b.prototype,"timeSliderViewModel",void 0);d.__decorate([c.property({dependsOn:["view.type"]})],b.prototype,"isSupported",
null);d.__decorate([c.property()],b.prototype,"lightingUpdateInterval",void 0);d.__decorate([c.property()],b.prototype,"_cachedLightingDateUTC",void 0);d.__decorate([c.property()],b.prototype,"_cachedDisplayUTCOffset",void 0);d.__decorate([c.property()],b.prototype,"_enableShadowsOnFirstInteraction",void 0);d.__decorate([c.property({dependsOn:["_cachedDisplayUTCOffset"]})],b.prototype,"utcOffset",null);d.__decorate([c.property({dependsOn:["_lightingDateDisplay"]})],b.prototype,"localDate",null);d.__decorate([c.property({dependsOn:["_lightingDateDisplay"]})],
b.prototype,"timeSliderPosition",null);d.__decorate([c.property({dependsOn:["_cachedDisplayUTCOffset","_cachedLightingDateUTC"]})],b.prototype,"_lightingDateDisplay",null);d.__decorate([c.property({aliasOf:"view.environment.lighting.directShadowsEnabled"})],b.prototype,"directShadowsEnabled",void 0);d.__decorate([c.property({type:["none","day","year"],value:"none"})],b.prototype,"playingState",null);d.__decorate([c.property({dependsOn:["playingState"]})],b.prototype,"dayPlaying",null);d.__decorate([c.property({dependsOn:["playingState"]})],
b.prototype,"yearPlaying",null);d.__decorate([c.property()],b.prototype,"playSpeedMultiplier",void 0);d.__decorate([c.property({dependsOn:["localDate","_currentHemisphere"]})],b.prototype,"currentSeason",null);d.__decorate([c.property()],b.prototype,"_lastTime",void 0);d.__decorate([c.property()],b.prototype,"_sunrise",void 0);d.__decorate([c.property()],b.prototype,"_sunset",void 0);d.__decorate([c.property({readOnly:!0,dependsOn:["view.camera.position.latitude"]})],b.prototype,"_currentHemisphere",
null);return b=d.__decorate([c.subclass("esri.widgets.Daylight.DaylightViewModel")],b)}(m.HandleOwner)});