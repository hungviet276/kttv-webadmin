// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.17/esri/copyright.txt for details.
//>>built
define("require exports tslib ../../geometry ../../core/arrayUtils ../../core/asyncUtils ../../core/Collection ../../core/HandleOwner ../../core/watchUtils ../../core/accessorSupport/decorators ../../geometry/support/contains ../../geometry/support/webMercatorUtils".split(" "),function(B,C,e,v,w,x,p,y,q,f,z,r){function A(d,c){return d.length!==c.length||d.some(function(b,a){return b.text!==c[a].text})}function k(d,c,b){b&&c&&(w.find(d,function(a){return a.layerView===c&&a.text===b})||d.push({text:b,
layerView:c}))}var d=[];return function(t){function c(b){var a=t.call(this,b)||this;a.clear=function(){a._fetchedAttributionData.clear();a._pendingAttributions.clear();a.handles.remove("suspension");a.notifyChange("state")};a._pendingAttributions=new Set;a._fetchedAttributionData=new Map;a.items=new p;a.view=null;a._allLayerViewsChange=function(b){a.handles.remove("suspension");var u=a.get("view.allLayerViews");u&&a.handles.add(u.map(function(b){return b.watch(["suspended","attributionVisible"],a._updateAttributionItems)}),
"suspension");b&&b.removed&&b.removed.forEach(function(b){a._pendingAttributions.delete(b);a._fetchedAttributionData.delete(b)});a._updateAttributionItems()};a._updateAttributionItems=function(){var b=a.get("view.allLayerViews");d.length=0;b?(b.forEach(function(b){if(!b.suspended&&b.get("layer.attributionVisible")){var c=b.layer;if(c&&"copyright"in c&&"function"===typeof c.originOf&&"user"===c.originOf("copyright"))k(d,b,c.copyright);else if(c.hasAttributionData)if(a._fetchedAttributionData.has(b)){var h=
a._fetchedAttributionData.get(b);h&&k(d,b,a._getDynamicAttribution(h,a.view,c))}else a._fetchAttributionData(b);else(h=c.get("portalItem.accessInformation"))?k(d,b,h):k(d,b,c.copyright)}}),A(a.items,d)&&(a.items.removeAll(),a.items.addMany(d)),d.length=0,a.notifyChange("state")):a.clear()};a.handles.add([q.on(a,"view.allLayerViews","change",a._allLayerViewsChange,a._allLayerViewsChange,a.clear),q.whenTrue(a,"view.stationary",function(){return a._updateAttributionItems()})]);return a}e.__extends(c,
t);c.prototype.destroy=function(){this.view=null;this._fetchedAttributionData.clear();this._pendingAttributions.clear();this.items.removeAll()};Object.defineProperty(c.prototype,"state",{get:function(){return this.get("view.ready")?0<this._pendingAttributions.size?"loading":"ready":"disabled"},enumerable:!1,configurable:!0});c.prototype._fetchAttributionData=function(b){return e.__awaiter(this,void 0,void 0,function(){var a,c;return e.__generator(this,function(h){switch(h.label){case 0:if(this._pendingAttributions.has(b))return[2];
this._pendingAttributions.add(b);return[4,x.result(b.layer.fetchAttributionData())];case 1:return a=h.sent(),this._pendingAttributions.has(b)&&(c=a.ok?this._createContributionIndex(a.value,"bing-maps"===b.layer.type):null,this._pendingAttributions.delete(b),this._fetchedAttributionData.set(b,c)),this._updateAttributionItems(),[2]}})})};c.prototype._createContributionIndex=function(b,a){b=b.contributors;var c={};if(!b)return c;for(var d=0;d<b.length;d++){var e=b[d],m=e.coverageAreas;if(!m)return;for(var n=
0;n<m.length;n++)for(var g=m[n],f=g.bbox,l=g.zoomMin-(a&&g.zoomMin?1:0),k=g.zoomMax-(a&&g.zoomMax?1:0),g={extent:r.geographicToWebMercator({xmin:f[1],ymin:f[0],xmax:f[3],ymax:f[2],spatialReference:v.SpatialReference.WGS84}),attribution:e.attribution||"",score:null!=g.score?g.score:100,id:d};l<=k;l++)c[l]=c[l]||[],c[l].push(g)}c.maxKey=Math.max.apply(null,Object.keys(c));return c};c.prototype._getDynamicAttribution=function(b,a,c){var d=a.extent;c=c.tileInfo.scaleToZoom(a.scale);c=Math.min(b.maxKey,
Math.round(c));if(!d||null==c||-1>=c)return"";b=b[c];var e=r.project(d.center.clone().normalize(),a.spatialReference),f={};return b?b.filter(function(a){var b=!f[a.id]&&e&&z.extentContainsPoint(a.extent,e);b&&(f[a.id]=!0);return b}).sort(function(a,b){return b.score-a.score||a.objectId-b.objectId}).map(function(a){return a.attribution}).join(", "):""};e.__decorate([f.property({readOnly:!0,type:p})],c.prototype,"items",void 0);e.__decorate([f.property({dependsOn:["view.ready"],readOnly:!0})],c.prototype,
"state",null);e.__decorate([f.property()],c.prototype,"view",void 0);return c=e.__decorate([f.subclass("esri.widgets.Attribution.AttributionViewModel")],c)}(y.HandleOwner)});