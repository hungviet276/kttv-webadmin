// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.17/esri/copyright.txt for details.
//>>built
define("require exports tslib ../../../core/Logger ../../../core/promiseUtils ./featureUtils @dojo/framework/shim/Promise".split(" "),function(u,q,r,v,w,e){function x(a){return'\x3cul class\x3d"esri-widget__list"\x3e'+a.map(function(a){return"\x3cli\x3e"+("string"===typeof a?e.applyTextFormattingHTML(e.htmlEntities(a)):a)+"\x3c/li\x3e"}).join("")+"\x3c/ul\x3e"}function y(a){return'\x3ctable class\x3d"esri-widget__table"\x3e'+a.keys().map(function(d){var b=a.field(d),b="string"===typeof b?e.applyTextFormattingHTML(e.htmlEntities(b)):
b;return"\x3ctr\x3e\x3cth\x3e"+d+"\x3c/th\x3e\x3ctd\x3e"+b+"\x3c/td\x3e\x3c/tr\x3e"}).join("")+"\x3c/table\x3e"}function z(a){var d=a.arcadeUtils,b=a.context,c=a.viewInfo,e=a.map,t=a.graphic;a.featureSetVars.forEach(function(a){a=a.toLowerCase();var f={map:e,spatialReference:c.sr};"$map"===a&&(b.vars[a]=d.convertMapToFeatureSetCollection(f));"$layer"===a&&(b.vars[a]=d.convertFeatureLayerToFeatureSet(t.sourceLayer,c.sr));"$datastore"===a&&(b.vars[a]=d.convertServiceUrlToWorkspace(t.sourceLayer.url,
c.sr))})}function A(){return new Promise(function(a,d){u(["../../../support/arcadeUtils"],a,d)})}function B(a){var d=a.expressionAttributes,b=a.info,c=a.arcadeUtils,q=a.spatialReference,t=a.map,l=a.graphic;return r.__awaiter(this,void 0,void 0,function(){var a,m,h,n,k,p,g;return r.__generator(this,function(f){switch(f.label){case 0:return a="expression/"+b.name,m=c.createSyntaxTree(b.expression),h=C.filter(function(a){return c.hasVariable(m,a)}),[4,c.loadScriptDependencies(m,!0,h)];case 1:return f.sent(),
n=c.getViewInfo({spatialReference:q}),k=c.createExecContext(l,n),k.useAsync=!0,z({arcadeUtils:c,featureSetVars:h,context:k,viewInfo:n,map:t,graphic:l}),p=c.createFunction(m,k),[4,c.executeAsyncFunction(p,k).catch(function(a){return D.error("arcade-execution-error",{error:a,graphic:l,expressionInfo:b})})];case 2:return g=f.sent(),d[a]="string"===typeof g?e.applyTextFormattingHTML(e.htmlEntities(g)):Array.isArray(g)?x(g):g&&"esri.arcade.Dictionary"===g.declaredClass?y(g):g,[2]}})})}Object.defineProperty(q,
"__esModule",{value:!0});q.createFormattedExpressions=void 0;var C=["$datastore","$map","$layer"],D=v.getLogger("esri.widgets.Feature.support.arcadeFeatureUtils");q.createFormattedExpressions=function(a){var d=a.popupTemplate,b=a.spatialReference,c=a.graphic,e=a.map;return r.__awaiter(this,void 0,void 0,function(){var a,l,f,m,h,n,k;return r.__generator(this,function(p){switch(p.label){case 0:return a=d.expressionInfos,l=[],f={},a&&a.length?[4,A()]:[2,f];case 1:m=p.sent();h=0;for(n=a;h<n.length;h++)k=
n[h],l.push(B({expressionAttributes:f,info:k,arcadeUtils:m,spatialReference:b,map:e,graphic:c}));return[4,w.eachAlways(l)];case 2:return p.sent(),[2,f]}})})}});