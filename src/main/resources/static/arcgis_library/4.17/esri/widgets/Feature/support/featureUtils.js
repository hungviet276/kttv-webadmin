// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.17/esri/copyright.txt for details.
//>>built
define("require exports tslib ../../../intl ../../../core/Error ../../../core/Logger ../../../core/string ../../../intl/date ../../../intl/number ../../../layers/support/fieldUtils ../../../popup/support/FieldInfoFormat".split(" "),function(X,c,h,k,x,H,r,I,y,J,K){function z(a){return A.test(a)}function L(a,b){if(!z(b)||!a)return null;var d=b.replace(A,"").toLowerCase(),f;a.some(function(a){return a.name.toLowerCase()===d?(f=a,!0):!1});return f}function t(a,b){return(b=u(b,a))?b.name:a}function u(a,
b){return a&&"function"===typeof a.getField?a.getField(b):null}function M(a,b){void 0===b&&(b=!1);var d=h.__assign({},a);Object.keys(d).forEach(function(a){var e=b;void 0===e&&(e=!1);var f=d[a];"string"===typeof f&&(e=(e?encodeURIComponent(f):f).replace(N,"%27"),d[a]=e)});return d}function B(a,b){return a.replace(O,function(a,f,e){return(a=u(b,e))?"{"+a.name+"}":f})}function C(a,b){var d=b.fieldName,f=D(b.fieldInfos,d),e=null===f||void 0===f?void 0:f.clone(),f=b.preventPlacesFormatting;b=u(b.layer,
d);e&&b&&"date"===b.type&&(b=e.format||new K,b.dateFormat=b.dateFormat||"short-date-short-time",e.format=b);e=e&&e.format;"string"!==typeof a||!e||null!=e.dateFormat||null==e.places&&null==e.digitSeparator||(b=Number(a),isNaN(b)||(a=b));return"string"===typeof a||null==a||null==e?a:f?y.formatNumber(a,h.__assign(h.__assign({},y.convertNumberFormatToIntlOptions(e)),{minimumFractionDigits:0,maximumFractionDigits:20})):e.format(a)}function D(a,b){if(a&&a.length&&b){var d=b.toLowerCase(),f=void 0;a.some(function(a){return a.fieldName&&
a.fieldName.toLowerCase()===d?(f=a,!0):!1});return f}}function E(a){return"string"===typeof a?a.replace(P,'\x3cbr class\x3d"esri-text-new-line" /\x3e'):a}function Q(a){var b=a.value,d=a.fieldName,f=a.fieldInfos,e=a.fieldInfoMap,c=a.layer;a=a.graphic;if(null==b)return"";var g;g=v(d)||!c||"function"!==typeof c.getFieldDomain?null:(g=c.getFieldDomain(d,{feature:a}))&&"coded-value"===g.type?g.getName(b):null;if(g)return g;a=v(d)||!c||"function"!==typeof c.getFeatureType?null:(g=c.typeIdField)&&d===g?
(a=c.getFeatureType(a))?a.name:null:null;return a?a:e.get(d.toLowerCase())?C(b,{fieldInfos:f,fieldName:d,layer:c}):(f=c&&c.fieldsIndex)&&f.isDateField(d)?k.formatDate(b,w):E(b)}function R(a,b){return h.__awaiter(this,void 0,void 0,function(){var d,f,e,c,g,p,l,m,q,n,k;return h.__generator(this,function(h){switch(h.label){case 0:d=a.layer;f=a.graphic;e=a.outFields;c=a.objectIds;g=c[0];if("number"!==typeof g)throw p="layer-query-features-invalid-objectid",l="Could not query required fields for the specified feature. The feature's ID is invalid.",
m={layer:d,graphic:f,objectId:g,requiredFields:e},q=new x(p,l,m),F.warn(l,m),q;if("function"!==typeof d.queryFeatures)throw p="layer-query-features-unsupported",l="The specified layer does not support the method 'queryFeatures'. The following fields will not be available.",m={layer:d,graphic:f,requiredFields:e},q=new x(p,l,m),F.warn(l,m),q;n=d.createQuery();n.objectIds=c;n.outFields=e;n.returnGeometry=!0;return[4,d.queryFeatures(n,b)];case 1:return k=h.sent(),[2,k.features[0]]}})})}function v(a){void 0===
a&&(a="");return a?-1!==a.indexOf("relationships/"):!1}function G(a){var b=a.attributes,d=a.graphic,c=a.relatedInfo;b&&d&&c&&Object.keys(d.attributes).forEach(function(a){var f={layerId:c.relation.id.toString(),fieldName:a};b[f?"relationships/"+f.layerId+"/"+f.fieldName:""]=d.attributes[a]})}function S(a,b){a&&b&&(b.relatedFeatures&&b.relatedFeatures&&b.relatedFeatures.forEach(function(d){return G({attributes:a,graphic:d,relatedInfo:b})}),b.relatedStatsFeatures&&b.relatedStatsFeatures&&b.relatedStatsFeatures.forEach(function(d){return G({attributes:a,
graphic:d,relatedInfo:b})}))}Object.defineProperty(c,"__esModule",{value:!0});c.isRelatedField=c.queryRequiredFields=c.formatAttributes=c.applyTextFormattingHTML=c.htmlEntities=c.getAllFieldInfos=c.createfieldInfoMap=c.formatEditInfo=c.getFieldInfo=c.formatValueToFieldInfo=c.processFieldsInLinks=c.fixTokens=c.substituteAttributes=c.getFixedFieldNames=c.getFixedFieldName=c.getFieldInfoLabel=c.isExpressionField=c.shouldOpenInNewTab=c.graphicCallback=c.getSourceLayer=void 0;var F=H.getLogger("esri.widgets.Feature.support.featureUtils"),
T=/href=(""|'')/gi,O=/(\{([^\{\r\n]+)\})/g,N=/\'/g,A=/^\s*expression\//i,P=/(\n)/gi,U=/[\u00A0-\u9999<>\&]/gim,V=/href\s*=\s*(?:\"([^\"]+)\"|\'([^\']+)\')/gi,W=/^(?:mailto:|tel:)/,w=I.convertDateFormatToIntlOptions("short-date-short-time");c.getSourceLayer=function(a){if(a)return a.get("sourceLayer")||a.get("layer")};c.graphicCallback=function(a,b){return h.__awaiter(this,void 0,void 0,function(){return h.__generator(this,function(d){return[2,"function"===typeof a?a.call(null,b):a]})})};c.shouldOpenInNewTab=
function(a){void 0===a&&(a="");if(a)return!W.test(a.trim().toLowerCase())};c.isExpressionField=z;c.getFieldInfoLabel=function(a,b){return(b=L(b,null===a||void 0===a?void 0:a.fieldName))?b.title||null:a?a.label||a.fieldName:null};c.getFixedFieldName=t;c.getFixedFieldNames=function(a,b){return a&&a.map(function(a){return t(a,b)})};c.substituteAttributes=function(a){var b=a.formattedAttributes,d=a.fieldInfoMap;return(""+r.replace(r.replace(a.template,function(a){var b=d.get(a.toLowerCase());return"{"+
(b&&b.fieldName||a)+"}"}),b).replace(T,"")).trim()};c.fixTokens=B;c.processFieldsInLinks=function(a,b,d){return(a=B(a,d))?a.replace(V,function(a,d,c){d=(""+(d||c)).trim();return r.replace(a,M(b,d&&"{"!==d[0]))}):a};c.formatValueToFieldInfo=C;c.getFieldInfo=D;c.formatEditInfo=function(a,b){var d=a.creatorField,c=a.creationDateField,e=a.editorField;if(b){a=b[a.editDateField];if("number"===typeof a)return b=b[e],d=k.formatDate(a,w),{type:"edit",date:d,user:b};c=b[c];return"number"===typeof c?(b=b[d],
d=k.formatDate(c,w),{type:"create",date:d,user:b}):null}};c.createfieldInfoMap=function(a,b){var c=new Map;a&&a.forEach(function(a){var d=t(a.fieldName,b);a.fieldName=d;c.set(d.toLowerCase(),a)});return c};c.getAllFieldInfos=function(a){var b=[];if(!a)return b;var c=a.fieldInfos;a=a.content;c&&b.push.apply(b,c);if(!a||!Array.isArray(a))return b;a.forEach(function(a){"fields"===a.type&&(a=a&&a.fieldInfos)&&b.push.apply(b,a)});return b};c.htmlEntities=function(a){return a.replace(U,function(a){return"\x26#"+
a.charCodeAt(0)+";"})};c.applyTextFormattingHTML=E;c.formatAttributes=function(a){var b=a.fieldInfos,c=a.layer,f=a.graphic,e=a.fieldInfoMap,k=a.relatedInfos,g=h.__assign({},a.attributes);null===k||void 0===k?void 0:k.forEach(function(a){return S(g,a)});Object.keys(g).forEach(function(a){g[a]=Q({fieldName:a,fieldInfos:b,fieldInfoMap:e,layer:c,value:g[a],graphic:f})});return g};c.queryRequiredFields=function(a,b){var c=a.graphic,f=a.popupTemplate,e=a.layer;return h.__awaiter(this,void 0,void 0,function(){var a,
d,k,l;return h.__generator(this,function(g){switch(g.label){case 0:return e&&f?"function"!==typeof e.load?[3,2]:[4,e.load(b)]:[2,null];case 1:g.sent(),g.label=2;case 2:return a=c.attributes[e.objectIdField],d=[a],[4,f.getRequiredFields(e.fields)];case 3:return k=g.sent(),J.featureHasFields(k,c)?[2,null]:[4,R({layer:e,graphic:c,outFields:k,objectIds:d},b)];case 4:if(l=g.sent())c.geometry=l.geometry,c.attributes=h.__assign(h.__assign({},c.attributes),l.attributes);return[2]}})})};c.isRelatedField=v});