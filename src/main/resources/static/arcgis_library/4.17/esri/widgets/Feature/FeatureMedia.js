// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.17/esri/copyright.txt for details.
//>>built
define("require exports tslib ../../core/events ../../core/watchUtils ../../core/accessorSupport/decorators ../Widget ./FeatureMedia/FeatureMediaViewModel ./support/featureUtils ../support/chartUtils ../support/widget ../support/widgetUtils".split(" "),function(w,x,d,q,r,k,t,l,u,m,f,n){return function(p){function b(a,c){a=p.call(this,a,c)||this;a._refreshTimer=null;a._refreshIntervalInfo=null;a.attributes=null;a.activeMediaInfoIndex=null;a.fieldInfoMap=null;a.layer=null;a.mediaInfos=null;a.popupTemplate=
null;a.relatedInfos=null;a.viewModel=new l;a.messages=null;return a}d.__extends(b,p);b.prototype.initialize=function(){var a=this;this.own(r.init(this,["viewModel.activeMediaInfo","viewModel.activeMediaInfoIndex"],function(){return a._setupMediaRefreshTimer()}))};b.prototype.destroy=function(){this._clearMediaRefreshTimer()};b.prototype.render=function(){return f.tsx("div",{bind:this,class:"esri-feature-media",onkeyup:this._handleMediaKeyup},this.renderMedia())};b.prototype.renderMedia=function(){return this.viewModel.formattedMediaInfoCount?
f.tsx("div",{key:"media-element-container",class:"esri-feature-media__container"},this.renderMediaPageButton("previous"),this.renderMediaInfo(),this.renderMediaPageButton("next")):null};b.prototype.renderImageMediaInfo=function(a){var c=this._refreshIntervalInfo,h=this.viewModel,b=h.activeMediaInfoIndex,g=h.formattedMediaInfoCount,e=a.value,d=a.refreshInterval,k=a.altText,h=a.title;a=a.type;var v=e.sourceURL,e=e.linkURL,l=u.shouldOpenInNewTab(e)?"_blank":"_self",m="_blank"===l?"noreferrer":"",c=d?
c:null,b=f.tsx("img",{alt:k||h,key:"media-"+a+"-"+b+"-"+g+"-"+(c?c.timestamp:0),src:c?c.sourceURL:v});return(h=e?f.tsx("a",{title:h,href:e,rel:m,target:l},b):null)?h:b};b.prototype.renderChartMediaInfo=function(a){var c=this.viewModel;return f.tsx("div",{key:"media-"+a.type+"-"+c.activeMediaInfoIndex+"-"+c.formattedMediaInfoCount,bind:this,class:"esri-feature-media__chart",afterCreate:this._getChartDependencies})};b.prototype.renderMediaInfoType=function(){var a=this.viewModel.activeMediaInfo;return a?
"image"===a.type?this.renderImageMediaInfo(a):-1!==a.type.indexOf("chart")?this.renderChartMediaInfo(a):null:null};b.prototype.renderMediaInfo=function(){var a=this.viewModel.activeMediaInfo,c=a.title?f.tsx("div",{key:"media-title",class:"esri-feature-media__item-title",innerHTML:a.title}):null,a=a.caption?f.tsx("div",{key:"media-caption",class:"esri-feature-media__item-caption",innerHTML:a.caption}):null;return f.tsx("div",{key:"media-container",class:"esri-feature-media__item-container"},c,a,f.tsx("div",
{key:"media-item-container",class:"esri-feature-media__item"},this.renderMediaInfoType()))};b.prototype.renderMediaPageButton=function(a){if(2>this.viewModel.formattedMediaInfoCount)return null;var c=(a="previous"===a)?this.messages.previous:this.messages.next,h=a?this.classes("esri-feature-media__button","esri-feature-media__previous"):this.classes("esri-feature-media__button","esri-feature-media__next"),b=a?this.classes("esri-feature-media__icon","esri-feature-media__previous-icon","esri-icon-left-triangle-arrow"):
this.classes("esri-feature-media__icon","esri-feature-media__next-icon","esri-icon-right-triangle-arrow"),g=a?this.classes("esri-feature-media__icon","esri-feature-media__previous-icon--rtl","esri-icon-right-triangle-arrow"):this.classes("esri-feature-media__icon","esri-feature-media__next-icon--rtl","esri-icon-left-triangle-arrow"),e=a?this._previous:this._next;return f.tsx("button",{type:"button",key:a?"media-previous":"media-next",title:c,"aria-label":c,tabIndex:0,class:h,bind:this,onkeydown:e,
onclick:e},f.tsx("span",{"aria-hidden":"true",class:b}),f.tsx("span",{"aria-hidden":"true",class:g}))};b.prototype._next=function(){this.viewModel.next()};b.prototype._previous=function(){this.viewModel.previous()};b.prototype._getChartDependencies=function(a){return d.__awaiter(this,void 0,void 0,function(){var c,h;return d.__generator(this,function(b){switch(b.label){case 0:return[4,m.loadChartsModule()];case 1:return c=b.sent(),h=this.viewModel.activeMediaInfo,this._renderChart({chartDiv:a,mediaInfo:h,
chartsModule:c}),[2]}})})};b.prototype._handleMediaKeyup=function(a){var c=q.eventKey(a);"ArrowLeft"===c&&(a.stopPropagation(),this.viewModel.previous());"ArrowRight"===c&&(a.stopPropagation(),this.viewModel.next())};b.prototype._renderChart=function(a){var c=a.chartsModule,h=a.chartDiv,b=a.mediaInfo,g=b.value,e=b.type,d=c.am4core,f=m.getColorSet(d);d.useTheme(c.am4themes_animated);d.useTheme(function(a){a instanceof d.ColorSet&&f&&(a.list=f)});a="pie-chart"===e?this._createPieChart(a):this._createXYChart(a);
h.setAttribute("aria-label",b.altText||b.title);a.data=g.series.map(function(a){return{tooltip:a.tooltip,value:a.value}}).filter(function(a){return"pie-chart"===e?0<a.value:!0})};b.prototype._customizeChartTooltip=function(a,c){a.label.wrap=!0;a.label.maxWidth=200;a.autoTextColor=!1;a.getFillFromObject=!1;a.label.fill=c.color("#ffffff");a.background.fill=c.color({r:0,g:0,b:0,a:.7})};b.prototype._createPieChart=function(a){var c=a.chartsModule,b=c.am4core,c=c.am4charts;a=b.create(a.chartDiv,c.PieChart);
a.rtl=n.isRTL();c=a.series.push(new c.PieSeries);c.labels.template.disabled=!0;c.ticks.template.disabled=!0;c.dataFields.value="value";c.dataFields.category="tooltip";this._customizeChartTooltip(c.tooltip,b);return a};b.prototype._getMinSeriesValue=function(a){var c=0;a.forEach(function(a){return c=Math.min(a.value,c)});return c};b.prototype._createColumnChart=function(a,c){var b=c.chartsModule;c=c.mediaInfo.value;var d=b.am4core,b=b.am4charts,g=a.xAxes.push(new b.CategoryAxis);g.dataFields.category=
"tooltip";g.renderer.labels.template.disabled=!0;this._customizeChartTooltip(g.tooltip,d);g.tooltip.events.on("sizechanged",function(){g.tooltip.dy=-g.tooltip.contentHeight});var e=a.yAxes.push(new b.ValueAxis),f=e.renderer.labels.template;e.renderer.minLabelPosition=.05;e.renderer.maxLabelPosition=.95;e.min=this._getMinSeriesValue(c.series);this._customizeChartTooltip(e.tooltip,d);f.wrap=!0;e=a.series.push(new b.ColumnSeries);e.dataFields.valueY="value";e.dataFields.categoryX="tooltip";a.cursor=
new b.XYCursor;15<c.series.length&&(a.scrollbarX=new d.Scrollbar)};b.prototype._createBarChart=function(a,c){var b=c.chartsModule;c=c.mediaInfo.value;var d=b.am4core,b=b.am4charts,g=a.yAxes.push(new b.CategoryAxis);g.dataFields.category="tooltip";g.renderer.inversed=!0;g.renderer.labels.template.disabled=!0;this._customizeChartTooltip(g.tooltip,d);g.tooltip.events.on("sizechanged",function(){g.tooltip.dx=g.tooltip.contentWidth});var e=a.xAxes.push(new b.ValueAxis),f=e.renderer.labels.template;e.renderer.minLabelPosition=
.05;e.renderer.maxLabelPosition=.95;e.min=this._getMinSeriesValue(c.series);this._customizeChartTooltip(e.tooltip,d);f.wrap=!0;e=a.series.push(new b.ColumnSeries);e.dataFields.valueX="value";e.dataFields.categoryY="tooltip";a.cursor=new b.XYCursor;15<c.series.length&&(a.scrollbarY=new d.Scrollbar)};b.prototype._createLineChart=function(a,c){var b=c.chartsModule;c=c.mediaInfo.value;var d=b.am4core,b=b.am4charts,g=a.xAxes.push(new b.CategoryAxis);g.dataFields.category="tooltip";g.renderer.labels.template.disabled=
!0;this._customizeChartTooltip(g.tooltip,d);g.tooltip.events.on("sizechanged",function(){g.tooltip.dy=-g.tooltip.contentHeight});var e=a.yAxes.push(new b.ValueAxis),f=e.renderer.labels.template;e.renderer.minLabelPosition=.05;e.renderer.maxLabelPosition=.95;e.min=this._getMinSeriesValue(c.series);this._customizeChartTooltip(e.tooltip,d);f.wrap=!0;e=a.series.push(new b.LineSeries);e.dataFields.categoryX="tooltip";e.dataFields.valueY="value";a.cursor=new b.XYCursor;15<c.series.length&&(a.scrollbarX=
new d.Scrollbar)};b.prototype._createXYChart=function(a){var b=a.chartsModule,d=a.mediaInfo.type,b=b.am4core.create(a.chartDiv,b.am4charts.XYChart);b.rtl=n.isRTL();"column-chart"===d&&this._createColumnChart(b,a);"bar-chart"===d&&this._createBarChart(b,a);"line-chart"===d&&this._createLineChart(b,a);return b};b.prototype._clearMediaRefreshTimer=function(){var a=this._refreshTimer;a&&(clearTimeout(a),this._refreshTimer=null)};b.prototype._updateMediaInfoTimestamp=function(a){var b=Date.now();this._refreshIntervalInfo=
{timestamp:b,sourceURL:this._getImageSource(a,b)};this.scheduleRender()};b.prototype._setupMediaRefreshTimer=function(){this._clearMediaRefreshTimer();var a=this.viewModel.activeMediaInfo;a&&"image"===a.type&&a.refreshInterval&&this._setRefreshTimeout(a)};b.prototype._setRefreshTimeout=function(a){var b=this,d=a.refreshInterval,f=a.value;d&&(a=6E4*d,this._updateMediaInfoTimestamp(f.sourceURL),this._refreshTimer=setInterval(function(){b._updateMediaInfoTimestamp(f.sourceURL)},a))};b.prototype._getImageSource=
function(a,b){var c=-1!==a.indexOf("?")?"\x26":"?";a=a.split("#");var d=a[1],d=void 0===d?"":d;return""+a[0]+c+"timestamp\x3d"+b+(d?"#":"")+d};d.__decorate([k.aliasOf("viewModel.attributes")],b.prototype,"attributes",void 0);d.__decorate([k.aliasOf("viewModel.activeMediaInfoIndex")],b.prototype,"activeMediaInfoIndex",void 0);d.__decorate([k.aliasOf("viewModel.fieldInfoMap")],b.prototype,"fieldInfoMap",void 0);d.__decorate([k.aliasOf("viewModel.layer")],b.prototype,"layer",void 0);d.__decorate([k.aliasOf("viewModel.mediaInfos")],
b.prototype,"mediaInfos",void 0);d.__decorate([k.aliasOf("viewModel.popupTemplate")],b.prototype,"popupTemplate",void 0);d.__decorate([k.aliasOf("viewModel.relatedInfos")],b.prototype,"relatedInfos",void 0);d.__decorate([k.property({type:l}),f.renderable(["viewModel.formattedMediaInfos","viewModel.activeMediaInfoIndex","viewModel.activeMediaInfo"])],b.prototype,"viewModel",void 0);d.__decorate([k.property(),f.renderable(),f.messageBundle("esri/widgets/Feature/t9n/Feature")],b.prototype,"messages",
void 0);return b=d.__decorate([k.subclass("esri.widgets.Feature.FeatureMedia")],b)}(t)});