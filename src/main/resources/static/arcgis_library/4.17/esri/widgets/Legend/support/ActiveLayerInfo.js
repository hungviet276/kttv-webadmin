// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.17/esri/copyright.txt for details.
//>>built
define("require exports tslib ../../../Color ../../../request ../../../symbols ../../../core/Accessor ../../../core/addTokenParameter ../../../core/arrayUtils ../../../core/Collection ../../../core/Handles ../../../core/jsonMap ../../../core/Logger ../../../core/maybe ../../../core/promiseUtils ../../../core/screenUtils ../../../core/urlUtils ../../../core/watchUtils ../../../core/accessorSupport/decorators ../../../layers/support/ExportImageParameters ../../../layers/support/fieldUtils ../../../renderers/support/jsonUtils ../../../renderers/visualVariables/support/SizeVariableLegendOptions ../../../symbols/support/cimSymbolUtils ../../../symbols/support/symbolUtils ../../../symbols/support/utils ./clusterUtils ./colorRampUtils ./heatmapRampUtils ./relationshipRampUtils ./sizeRampUtils ./utils @dojo/framework/shim/Promise".split(" "),
function(P,Ja,g,Q,ma,R,na,oa,pa,qa,ra,sa,ta,S,z,ua,va,w,p,ea,wa,xa,ya,za,F,Aa,Ba,E,Ca,fa,K,Da){function L(g){return"esri.renderers.SimpleRenderer"===g.declaredClass}function M(g){return"esri.renderers.ClassBreaksRenderer"===g.declaredClass}function Z(g){return"esri.renderers.UniqueValueRenderer"===g.declaredClass}function ha(g){return"esri.renderers.HeatmapRenderer"===g.declaredClass}function G(g){return"esri.renderers.PointCloudClassBreaksRenderer"===g.declaredClass}function H(g){return"esri.renderers.PointCloudStretchRenderer"===
g.declaredClass}function N(g){return"esri.renderers.PointCloudUniqueValueRenderer"===g.declaredClass}function ia(g){return"esri.renderers.DotDensityRenderer"===g.declaredClass}function ja(g){return"esri.layers.BuildingSceneLayer"===g.declaredClass}var A=ta.getLogger("esri.widgets.Legend.support.ActiveLayerInfo"),I=/^\s*(return\s+)?\$view\.scale\s*(;)?\s*$/i,Ea=new sa.default({esriGeometryPoint:"point",esriGeometryMultipoint:"multipoint",esriGeometryPolyline:"polyline",esriGeometryPolygon:"polygon",
esriGeometryMultiPatch:"multipatch"}),Fa={u1:[0,1],u2:[0,3],u4:[0,15],u8:[0,255],s8:[-128,127],u16:[0,65535],s16:[-32768,32767],u32:[0,4294967295],s32:[-2147483648,2147483647],f32:[-3.4*1E39,3.4*1E39],f64:[-Number.MAX_VALUE,Number.MAX_VALUE]},O=new R.SimpleMarkerSymbol({size:6,outline:{color:[128,128,128,.5],width:.5}}),Ga=new R.SimpleFillSymbol({style:"solid"}),Ha=new R.SimpleMarkerSymbol({style:"path",path:"M10,5 L5,0 0,5 M5,0 L5,15",size:15,outline:{width:1,color:[85,85,85,1]}}),u={};return function(ga){function d(a){a=
ga.call(this,a)||this;a._handles=new ra;a._hasColorRamp=!1;a._hasOpacityRamp=!1;a._hasSizeRamp=!1;a._webStyleSymbolCache=new Map;a._dotDensityUrlCache=new Map;a._scaleDrivenSizeVariable=null;a._hasClusterSizeVariable=!1;a.children=new qa;a.layerView=null;a.layer=null;a.legendElements=[];a.parent=null;a.keepCacheOnDestroy=!1;a.respectLayerVisibility=!0;a.sublayerIds=[];a.title=null;a.view=null;return a}g.__extends(d,ga);d.prototype.initialize=function(){var a=this,b=function(){return a.notifyChange("ready")};
this._handles.add([w.on(this,"children","change",function(c){var f=c.removed,h=a._handles;c.added.map(function(a){var c="activeLayerInfo-ready-watcher-"+a.layer.uid;h.add(w.init(a,"ready",b),c)});f.forEach(function(a){return h.remove(a.layer.uid)});b()})]);this.keepCacheOnDestroy||(u={})};d.prototype.destroy=function(){this._handles.destroy();this._scaleDrivenSizeVariable=this._dotDensityUrlCache=this._webStyleSymbolCache=this._handles=null;this.keepCacheOnDestroy||(u=null)};Object.defineProperty(d.prototype,
"opacity",{get:function(){var a,b=this.layer.opacity,c=null===(a=this.parent)||void 0===a?void 0:a.opacity;a=(a=this.layer.parent)&&"uid"in a?this._getParentLayerOpacity(a):null;return null!=c?c*b:null!=a?a*b:b},enumerable:!1,configurable:!0});Object.defineProperty(d.prototype,"ready",{get:function(){return null===this.layer?!0:0<this.children.length?this._isGroupActive():0<this.legendElements.length},enumerable:!1,configurable:!0});Object.defineProperty(d.prototype,"scale",{get:function(){return this.view&&
this.view.scale},enumerable:!1,configurable:!0});Object.defineProperty(d.prototype,"isScaleDriven",{get:function(){var a=this,b=this.layer;if(null===b)return!1;if("featureReduction"in b&&b.featureReduction&&"cluster"===b.featureReduction.type)return!0;if("renderer"in b&&b.renderer){if("dot-density"===b.renderer.type)return!0;var c=b.get("renderer.valueExpression");if(I.test(c))return!0;if(b=b.get("renderer.visualVariables"))return b.some(function(b){return a._isScaleDrivenSizeVariable(b)})}return this._isLayerScaleDriven(this.layer)},
enumerable:!1,configurable:!0});Object.defineProperty(d.prototype,"version",{get:function(){return this._get("version")+1},enumerable:!1,configurable:!0});d.prototype.buildLegendElementsForFeatureCollections=function(a){return g.__awaiter(this,void 0,void 0,function(){var b,c=this;return g.__generator(this,function(f){this.legendElements=[];b=a.map(function(a){if("esri.layers.FeatureLayer"===a.declaredClass)return c._buildRendererLegendElements(a.renderer,{title:a.title,mode:0});if(a.featureSet&&
a.featureSet.features.length){var b=a.layerDefinition,f=b&&b.drawingInfo,f=f&&xa.fromJSON(f.renderer),b=Ea.read(b.geometryType);return f?c._buildRendererLegendElements(f,{title:a.name,mode:0,geometryType:b}):(A.warn("drawingInfo not available!"),null)}return null});return[2,z.eachAlways(b).then(function(){})]})})};d.prototype.buildLegendElementsForRenderer=function(a){return g.__awaiter(this,void 0,void 0,function(){return g.__generator(this,function(b){return[2,this._buildRendererLegendElements(a)]})})};
d.prototype.buildLegendElementsForTools=function(){return g.__awaiter(this,void 0,void 0,function(){var a,b=this;return g.__generator(this,function(c){switch(c.label){case 0:a=this.layer;if("esri.layers.WMTSLayer"!==a.declaredClass)return[3,1];this._constructLegendElementsForWMTSlayer();return[3,8];case 1:if("esri.layers.WMSLayer"!==a.declaredClass)return[3,2];this._constructLegendElementsForWMSSublayers();return[3,8];case 2:return ja(a)?[4,this._constructLegendElementsForBuildingSceneLayer()]:[3,
4];case 3:return c.sent(),[3,8];case 4:return"esri.layers.MapImageLayer"===a.declaredClass||"esri.layers.TileLayer"===a.declaredClass||ja(a)?[4,this._constructLegendElementsForSublayers()]:[3,6];case 5:return c.sent(),[3,8];case 6:return this._handles.remove("imageryLayers-watcher"),[4,this._getLegendLayers().then(function(c){b.legendElements=[];c.forEach(function(c){if("esri.layers.ImageryLayer"===a.declaredClass){var f=a.watch("renderingRule, bandIds",function(){u["default"]=null;b.buildLegendElementsForTools()});
b._handles.add(f,"imageryLayers-watcher")}(c=b._generateSymbolTableElementForLegendLayer(c))&&c.infos.length&&("esri.layers.ImageryLayer"===a.declaredClass&&(c.title=a.title),b.legendElements.push(c));b.notifyChange("ready")});b.notifyChange("ready")}).catch(function(a){A.warn("Request to server for legend has failed!",a)})];case 7:c.sent(),c.label=8;case 8:return[2]}})})};d.prototype._getParentLayerOpacity=function(a){var b=1,c=a.parent;c&&"uid"in c&&(b=this._getParentLayerOpacity(c));return a.opacity*
b};d.prototype._isGroupActive=function(){var a=this.children;return a.length?a.some(function(a){return a.ready}):!1};d.prototype._isScaleDrivenSizeVariable=function(a){if(a&&"size"!==a.type)return!1;var b=a.minSize,c=a.maxSize;return"object"===typeof b&&b?this._isScaleDrivenSizeVariable(b):"object"===typeof c&&c?this._isScaleDrivenSizeVariable(c):!!a.expression||I.test(a.valueExpression)};d.prototype._isLayerScaleDriven=function(a){var b=this;if("minScale"in a&&0<a.minScale||"maxScale"in a&&0<a.maxScale)return!0;
if("sublayers"in a&&a.sublayers)return a.sublayers.some(function(a){return b._isLayerScaleDriven(a)});var c=a.parent;if(!1===a.loaded&&c&&"esri.layers.MapImageLayer"===c.declaredClass&&"source"in a&&a.source&&"map-layer"===a.source.type)for(var f=0,c=c.sourceJSON.layers;f<c.length;f++){var h=c[f];if(h.id===a.source.mapLayerId&&(0<h.minScale||0<h.maxScale))return!0}return!1};d.prototype._buildRendererLegendElements=function(a,b){void 0===b&&(b={});return g.__awaiter(this,void 0,void 0,function(){var c,
f;return g.__generator(this,function(h){switch(h.label){case 0:return h.trys.push([0,2,,3]),[4,this._getRendererLegendElements(a,{title:b.title,geometryType:b.geometryType})];case 1:return c=h.sent(),0===b.mode?Array.prototype.push.apply(this.legendElements,c):this.legendElements=c,this.notifyChange("ready"),[3,3];case 2:return f=h.sent(),A.warn("error while building legend for layer!",f),[3,3];case 3:return[2]}})})};d.prototype._constructLegendElementsForWMTSlayer=function(){var a=this;this.legendElements=
[];this._handles.remove("wmts-activeLayer-watcher");var b=this.layer.activeLayer;this._handles.add(w.watch(this.layer,"activeLayer",function(){return a._constructLegendElementsForWMTSlayer()}),"wmts-activeLayer-watcher");if(b.styleId&&b.styles){var c=null;b.styles.some(function(a){return b.styleId===a.id?(c=a.legendUrl,!0):!1});c&&(this.legendElements=[{type:"symbol-table",title:b.title,infos:[{src:c,opacity:this.opacity}]}])}this.notifyChange("ready")};d.prototype._constructLegendElementsForWMSSublayers=
function(){var a=this;this.legendElements=[];this._handles.remove("wms-sublayers-watcher");var b=this.layer,c=null;if(b.customParameters||b.customLayerParameters)c=g.__assign(g.__assign({},b.customParameters),b.customLayerParameters);this._handles.add(w.watch(this.layer,"sublayers",function(){return a._constructLegendElementsForWMSSublayers()}),"wms-sublayers-watcher");this.legendElements=this._generateLegendElementsForWMSSublayers(b.sublayers,c);this.notifyChange("ready")};d.prototype._generateLegendElementsForWMSSublayers=
function(a,b){var c=this,f=[];this._handles.add(a.on("change",function(){return c._constructLegendElementsForWMSSublayers()}),"wms-sublayers-watcher");a.forEach(function(a){var e=a.watch("title, visible, legendEnabled",function(){return c._constructLegendElementsForWMSSublayers()});c._handles.add(e,"wms-sublayers-watcher");a.visible&&a.legendEnabled&&(a=c._generateSymbolTableElementForWMSSublayer(a,b))&&a.infos.length&&f.unshift(a)});return f};d.prototype._generateSymbolTableElementForWMSSublayer=
function(a,b){return!a.legendUrl&&a.sublayers?(b=this._generateLegendElementsForWMSSublayers(a.sublayers,b).filter(function(a){return a}),{type:"symbol-table",title:a.title,infos:b}):this._generateSymbolTableElementForLegendUrl(a,b)};d.prototype._generateSymbolTableElementForLegendUrl=function(a,b){var c=a.legendUrl;if(c){var f={type:"symbol-table",title:a.title||a.name||a.id&&a.id+"",infos:[]};b&&(c+="?"+va.objectToQuery(b));f.infos.push({src:c,opacity:a.layer&&a.layer.opacity});return f}};d.prototype._getLegendLayers=
function(a){var b=(a=a&&a.hasDynamicLayers?a.dynamicLayers:null)||"default",c=u&&u[b];return c?z.resolve(c):this._legendRequest(a).then(function(a){a=a.layers;return u[b]=a})};d.prototype._legendRequest=function(a){var b=this.layer;a={f:"json",dynamicLayers:a};if("esri.layers.ImageryLayer"===b.declaredClass){var c=b.exportImageServiceParameters.renderingRule;c&&(a.renderingRule=JSON.stringify(c.toJSON()));b.bandIds&&(a.bandIds=b.bandIds.join());if(b.raster||b.viewId)a=g.__assign({raster:b.raster,
viewId:b.viewId},a)}c=b.url.replace(/(\/)+$/,"");"version"in b&&10.01<=b.version?(b=c.indexOf("?"),c=-1<b?c.substring(0,b)+"/legend"+c.substring(b):c+"/legend"):(b=c.toLowerCase().indexOf("/rest/"),b=c.substring(0,b)+c.substring(b+5,c.length),c="https://utility.arcgis.com/sharing/tools/legend?soapUrl\x3d"+encodeURI(b)+"\x26returnbytes\x3dtrue");return ma(c,{query:a}).then(function(a){return a.data})};d.prototype._constructLegendElementsForBuildingSceneLayer=function(){return g.__awaiter(this,void 0,
void 0,function(){var a,b,c,f=this;return g.__generator(this,function(h){switch(h.label){case 0:this.legendElements=[],this._handles.remove("sublayers-watcher"),a=this.layer,this._handles.add(w.watch(a,"sublayers",function(){return f._constructLegendElementsForBuildingSceneLayer()}),"sublayers-watcher"),h.label=1;case 1:return h.trys.push([1,3,,4]),b=this,[4,this._generateLegendElementsForBuildingSublayers(a.sublayers,this.opacity)];case 2:return b.legendElements=h.sent(),this.notifyChange("ready"),
[3,4];case 3:return c=h.sent(),A.warn("Request to server for legend has failed!",c),[3,4];case 4:return[2]}})})};d.prototype._generateLegendElementsForBuildingSublayers=function(a,b){return g.__awaiter(this,void 0,void 0,function(){var c,f,h,e,m,d,l,r,n,v,q,t=this;return g.__generator(this,function(k){switch(k.label){case 0:c=[],this._handles.add(a.on("change",function(){return t._constructLegendElementsForBuildingSceneLayer()}),"sublayers-watcher"),f=a.toArray(),h=0,e=f,k.label=1;case 1:if(!(h<e.length))return[3,
6];m=e[h];d=m.watch("renderer, opacity, title, visible",function(){return t._constructLegendElementsForBuildingSceneLayer()});this._handles.add(d,"sublayers-watcher");if(!m.visible)return[3,5];l=m&&null!=m.opacity?m.opacity:null;r=null!=l?l*b:b;if("building-group"!==m.type)return[3,3];n={type:"symbol-table",title:m.title,infos:[]};return[4,this._generateLegendElementsForBuildingSublayers(m.sublayers,r)];case 2:return v=k.sent(),(q=n.infos).push.apply(q,v),c=g.__spreadArrays([n],c),[3,5];case 3:return m.renderer?
[4,this._getRendererLegendElements(m.renderer,{title:m.title,opacity:r,sublayer:m})]:[3,5];case 4:v=k.sent(),c=g.__spreadArrays(v,c),k.label=5;case 5:return h++,[3,1];case 6:return[2,c.filter(function(a){return!!a&&("infos"in a?0<a.infos.length:!0)})]}})})};d.prototype._constructLegendElementsForSublayers=function(){return g.__awaiter(this,void 0,void 0,function(){var a,b,c,f=this;return g.__generator(this,function(h){switch(h.label){case 0:this.legendElements=[],this._handles.remove("sublayers-watcher"),
a=this.layer,this._handles.add(w.watch(a,"sublayers",function(){return f._constructLegendElementsForSublayers}),"sublayers-watcher"),h.label=1;case 1:return h.trys.push([1,3,,4]),b=this,[4,this._generateLegendElementsForSublayers(a.sublayers,this.opacity)];case 2:return b.legendElements=h.sent(),this.notifyChange("ready"),[3,4];case 3:return c=h.sent(),A.warn("Request to server for legend has failed!",c),[3,4];case 4:return[2]}})})};d.prototype._generateLegendElementsForSublayers=function(a,b,c){return g.__awaiter(this,
void 0,void 0,function(){var f,h,e,d,k,l,r,n,v,q,t=this;return g.__generator(this,function(m){switch(m.label){case 0:f=[],this._handles.add(a.on("change",function(){return t._constructLegendElementsForSublayers()}),"sublayers-watcher"),h=a.toArray(),!c&&this.sublayerIds&&this.sublayerIds.length&&(e=this.layer,h=this.sublayerIds.map(function(a){return e.findSublayerById(a)}).filter(Boolean)),d=new ea.ExportImageParameters({layer:this.layer}),k=d.hasDynamicLayers&&d.dynamicLayers||"default",d.destroy(),
l=function(a){var e,h,d,m,l;return g.__generator(this,function(n){switch(n.label){case 0:e=a.watch("renderer, opacity, title, visible, legendEnabled",function(b,f,e){(b=u&&u[k])&&!c&&(c=new Map,b.forEach(function(a){return c.set(a.layerId,a)}));b=null===c||void 0===c?void 0:c.get(a.id);("renderer"!==e||2<a.originIdOf("renderer")||!b)&&t._constructLegendElementsForSublayers()});r._handles.add(e,"sublayers-watcher");if(!a.visible||!a.legendEnabled)return[3,6];h=a&&null!=a.opacity?a.opacity:null;d=null!=
h?h*b:b;return a.renderer&&!a.sublayers&&2<a.originIdOf("renderer")?r.respectLayerVisibility&&!r._isSublayerInScale(a)?[3,3]:[4,a.load()]:[3,4];case 1:return n.sent(),[4,r._getRendererLegendElements(a.renderer,{title:a.title,opacity:d,sublayer:a})];case 2:m=n.sent(),f=g.__spreadArrays(m,f),n.label=3;case 3:return[3,6];case 4:return[4,r._generateSymbolTableElementForSublayer(a,d,c)];case 5:(l=n.sent())&&f.unshift(l),n.label=6;case 6:return[2]}})},r=this,n=0,v=h,m.label=1;case 1:if(!(n<v.length))return[3,
4];q=v[n];return[5,l(q)];case 2:m.sent(),m.label=3;case 3:return n++,[3,1];case 4:return[2,f.filter(function(a){return!!a&&("infos"in a?0<a.infos.length:!0)})]}})})};d.prototype._generateSymbolTableElementForSublayer=function(a,b,c){return g.__awaiter(this,void 0,void 0,function(){var f,h,e,d;return g.__generator(this,function(m){switch(m.label){case 0:if(c)return[3,4];c=new Map;f=new ea.ExportImageParameters({layer:this.layer});m.label=1;case 1:return m.trys.push([1,,3,4]),[4,this._getLegendLayers(f)];
case 2:return h=m.sent(),h.forEach(function(a){return c.set(a.layerId,a)}),[3,4];case 3:return f.destroy(),[7];case 4:return(e=c.get(a.id))||!a.sublayers?[3,6]:[4,this._generateLegendElementsForSublayers(a.sublayers,b,c)];case 5:return d=m.sent(),[2,{type:"symbol-table",title:a.title,infos:d}];case 6:return[2,this._generateSymbolTableElementForLegendLayer(e,a,b)]}})})};d.prototype._generateSymbolTableElementForLegendLayer=function(a,b,c){var f=this;if(!a||!a.legend||this.respectLayerVisibility&&!this._isLegendLayerInScale(a,
b))return null;var h=b&&b.renderer,e=b&&b.title||a.layerName;h&&(h=b&&b.title||this._getRendererTitle(h,b))&&(e&&(h.title=e),e=h);e={type:"symbol-table",title:e,infos:[]};a.legendType&&(e.legendType=a.legendType);b=b?this._sanitizeLegendForSublayer(a.legend.slice(),b):a.legend;e.infos=b.map(function(b){var e=b.url;if(b.imageData&&0<b.imageData.length)e="data:image/png;base64,"+b.imageData;else if(0!==e.indexOf("http"))e=oa.addTokenParameter(f.layer.url+"/"+a.layerId+"/images/"+e);else return null;
return{label:b.label,src:e,opacity:null==c?f.opacity:c,width:b.width,height:b.height}}).filter(function(a){return!!a});return e.infos.length?e:null};d.prototype._isSublayerInScale=function(a){var b=a.minScale||0;a=a.maxScale||0;return 0<b&&b<this.scale||a>this.scale?!1:!0};d.prototype._isLegendLayerInScale=function(a,b){b=b||this.layer;var c=null,f=null,h=!0;!b.minScale&&0!==b.minScale||!b.maxScale&&0!==b.maxScale?(0===a.minScale&&b.tileInfo&&(c=b.tileInfo.lods[0].scale),0===a.maxScale&&b.tileInfo&&
(f=b.tileInfo.lods[b.tileInfo.lods.length-1].scale)):(c=Math.min(b.minScale,a.minScale)||b.minScale||a.minScale,f=Math.max(b.maxScale,a.maxScale));if(0<c&&c<this.scale||f>this.scale)h=!1;return h};d.prototype._sanitizeLegendForSublayer=function(a,b){if("version"in this.layer&&10.1>this.layer.version||0===a.length)return a;b=b.renderer;var c=null,f=null;a.some(function(a){return a.values})&&a.some(function(a,b){a.values||(c=b,f=a,f.label||(f.label="others"));return null!=f});b?"unique-value"===b.type?
f&&(a.splice(c,1),a.push(f)):"class-breaks"===b.type&&(f&&a.splice(c,1),a.reverse(),f&&a.push(f)):f&&(a.splice(c,1),a.push(f));return a};d.prototype._getRendererLegendElements=function(a,b){void 0===b&&(b={});return g.__awaiter(this,void 0,void 0,function(){return g.__generator(this,function(c){return L(a)||M(a)||Z(a)||"raster-stretch"===a.type||"raster-colormap"===a.type||ha(a)||G(a)||H(a)||N(a)||ia(a)||"vector-field"===a.type||"raster-shaded-relief"===a.type?G(a)||H(a)||N(a)||"esri.renderers.PointCloudRGBRenderer"===
a.declaredClass?[2,this._constructPointCloudRendererLegendElements(a,b)]:ia(a)?[2,this._constructDotDensityRendererLegendElements(a)]:[2,this._constructRendererLegendElements(a,b)]:(A.warn("Renderer not supported!"),[2,[]])})})};d.prototype._getPointCloudRendererTitle=function(a){return a.legendOptions&&a.legendOptions.title||a.field};d.prototype._constructPointCloudRendererLegendElements=function(a,b){var c=this;void 0===b&&(b={});b=b.title;var f=[],h=null,e=null;if(G(a))h={type:"symbol-table",title:b||
this._getPointCloudRendererTitle(a),infos:[]},a.colorClassBreakInfos.forEach(function(a){h.infos.unshift({label:a.label||a.minValue+" - "+a.maxValue,value:[a.minValue,a.maxValue],symbol:c._getAppliedCloneSymbol(O,a.color)})});else if(H(a)){var e=a.stops,d=null;if(e.length&&(1===e.length&&(d=e[0].color),!d)){var g=e[0].value,l=e[e.length-1].value;null!=g&&null!=l&&(d=E.getColorFromPointCloudStops(g+(l-g)/2,e))}h={type:"symbol-table",title:null,infos:[{label:null,value:null,symbol:this._getAppliedCloneSymbol(O,
d||O.color)}]};e=E.getRampStopsForPointCloud(a.stops);e={type:"color-ramp",title:b||this._getPointCloudRendererTitle(a),infos:e,preview:F.renderColorRampPreviewHTML(e.map(function(a){return a.color}))}}else N(a)&&(h={type:"symbol-table",title:b||this._getPointCloudRendererTitle(a),infos:[]},a.colorUniqueValueInfos.forEach(function(a){h.infos.push({label:a.label||a.values.join(", "),value:a.values.join(", "),symbol:c._getAppliedCloneSymbol(O,a.color)})}));h&&h.infos.length&&f.push(h);e&&e.infos.length&&
f.push(e);a=f.reduce(function(a,b){return a.concat(b.infos)},[]).filter(function(a){return!!a.symbol}).map(function(a){return c._getSymbolPreview(a,c.opacity)});return z.eachAlways(a).then(function(){return f})};d.prototype._getElementInfoForDotDensity=function(a,b){var c=a.outline,c=a.dotSize+"-"+b+"-"+a.backgroundColor+"-"+(c&&JSON.stringify(c.toJSON())),f=this._dotDensityUrlCache;a=f.has(c)?f.get(c):F.renderDotDensityPreviewHTML(a,b);f.set(c,a);return{opacity:1,src:a.src,preview:a,width:a.width,
height:a.height}};d.prototype._constructDotDensityRendererLegendElements=function(a){var b=this,c=a.calculateDotValue(this.view.scale),f={type:"symbol-table",title:{value:c&&Math.round(c),unit:a.legendOptions&&a.legendOptions.unit||""},infos:[]};a.attributes.forEach(function(c){var e=b._getElementInfoForDotDensity(a,c.color);e.label=c.label||c.valueExpressionTitle||c.field;f.infos.push(e)});return z.resolve([f])};d.prototype._constructRendererLegendElements=function(a,b){void 0===b&&(b={});return g.__awaiter(this,
void 0,void 0,function(){var c,f,h,e,d,k,l,r,n,v,q,t,p,aa,ba,ca,ka,u,W,da,X,A,w,Ia,la,D,E,I,O,Y,x,B,C,J,y,K,G,T,U,H,N,P,Q,V=this;return g.__generator(this,function(g){switch(g.label){case 0:return c=b.title,h=(f=b.sublayer)||this.layer,[4,this._loadRenderer(a)];case 1:return e=g.sent(),this._hasSizeRamp=this._hasOpacityRamp=this._hasColorRamp=!1,this._scaleDrivenSizeVariable=null,[4,this._getVisualVariableLegendElements(e,h)];case 2:d=g.sent()||[];k={type:"symbol-table",title:c||this._getRendererTitle(e,
h),infos:[]};l=null;r=!1;n=new Set;if(!ha(e))return[3,3];v=Ca.getHeatmapRampStops(e);d.push({type:"heatmap-ramp",title:c,infos:v,preview:F.renderColorRampPreviewHTML(v.map(function(a){return a.color}))});return[3,12];case 3:if(!Z(e))return[3,4];if(t=(q=e&&e.authoringInfo)&&"relationship"===q.type){if(p=q.focus,aa=q.numClasses,ba=q.field1,ca=q.field2,aa&&ba&&ca){ka=[ba,ca];u=fa.getRotationAngleForFocus(p)||0;W=0;for(da=ka;W<da.length;W++)X=da[W],A=X.field,w=X.normalizationField,la=(Ia=X.label)||{field:this._getFieldAlias(A,
h),normField:w&&this._getFieldAlias(w,h)},D=Ha.clone(),D.angle=u,k.infos.push({label:la,symbol:D}),n.add(D),u+=90;E=fa.getRelationshipRampElement({focus:p,numClasses:aa,infos:e.uniqueValueInfos});d.unshift(E)}}else I=e.field,e.uniqueValueInfos.forEach(function(a){if(a.symbol){var b=a.symbol.clone();"esri.layers.ImageryLayer"===V.layer.declaredClass&&(b=R.SimpleMarkerSymbol.fromJSON({color:b.color,style:"square"}));k.infos.push({label:a.label||V._getDomainName(I,a.value,h)||a.value,value:a.value,symbol:b})}});
e.defaultSymbol&&(k.infos.push({label:e.defaultLabel||"others",symbol:e.defaultSymbol}),r=!0);return[3,12];case 4:if(!M(e))return[3,5];l=this._isUnclassedRenderer(e);if(O=!l||!this._hasSizeRamp)e.classBreakInfos.forEach(function(a){if(a.symbol){var b=a.symbol.clone();"esri.layers.ImageryLayer"===V.layer.declaredClass&&(b=R.SimpleMarkerSymbol.fromJSON({color:b.color,style:"square"}));k.infos.unshift({label:a.label||(l?null:a.minValue+" - "+a.maxValue),value:[a.minValue,a.maxValue],symbol:b})}}),l&&
(k.title=null),this._updateInfosforClassedSizeRenderer(e,k.infos);e.defaultSymbol&&!l&&(k.infos.push({label:e.defaultLabel||"others",symbol:e.defaultSymbol}),r=!0);return[3,12];case 5:if("raster-stretch"!==e.type)return[3,11];if("esri.layers.ImageryTileLayer"!==this.layer.declaredClass&&"esri.layers.WCSLayer"!==this.layer.declaredClass)return[3,6];Y=this._constructTileImageryStretchRendererElements(e);"stretch-ramp"===Y.type?d.push(Y):k.infos=Y;return[3,10];case 6:return x=this.layer,C=B=void 0,e.statistics&&
e.statistics.length&&(B=e.statistics[0].min||e.statistics[0][0],C=e.statistics[0].max||e.statistics[0][1]),J=[],K=S.unwrap,x.renderingRule?[4,x.generateRasterInfo(x.renderingRule)]:[3,8];case 7:return G=g.sent(),[3,9];case 8:G=x.serviceRasterInfo,g.label=9;case 9:y=K.apply(void 0,[G]),T=y.keyProperties.BandProperties,1===y.bandCount?(B=B||y.statistics&&y.statistics[0].min,C=C||y.statistics&&y.statistics[0].max,B||C?d.push(this._getStretchLegendElements(e,{min:B,max:C})):this.buildLegendElementsForTools()):
x.bandIds&&1===x.bandIds.length?(B=B||y.statistics&&y.statistics[x.bandIds[0]].min,C=C||y.statistics&&y.statistics[x.bandIds[0]].max,B||C?d.push(this._getStretchLegendElements(e,{min:B,max:C})):this.buildLegendElementsForTools()):3<=y.bandCount?T&&T.length>=y.bandCount?x.bandIds&&3===x.bandIds.length?(J=x.bandIds.map(function(a){return T[a].BandName}),k.infos=this._createSymbolTableElementMultiBand(J)):"lerc"===x.format?(J=[0,1,2].map(function(a){return T[a].BandName}),k.infos=this._createSymbolTableElementMultiBand(J)):
this.buildLegendElementsForTools():"lerc"===x.format?(J=["band1","band2","band3"],k.infos=this._createSymbolTableElementMultiBand(J)):this.buildLegendElementsForTools():this.buildLegendElementsForTools(),g.label=10;case 10:return[3,12];case 11:if("raster-colormap"===e.type)e.colormapInfos.forEach(function(a){k.infos.push({label:a.label,value:a.value,symbol:V._getAppliedCloneSymbol(Ga,a.color)})});else if(L(e)){D=e.symbol;switch(b.geometryType){case "point":D="pointSymbol"in h&&h.pointSymbol;break;
case "polyline":D="lineSymbol"in h&&h.lineSymbol;break;case "polygon":D="polygonSymbol"in h&&h.polygonSymbol}e.symbol&&!this._hasSizeRamp&&k.infos.push({label:e.label,symbol:D})}else"vector-field"===e.type?(e.outputUnit&&(this.title="("+e.toJSON().outputUnit+")"),k.title=e.attributeField,U=e.getClassBreakInfos(),(null===U||void 0===U?0:U.length)?U.forEach(function(a){k.infos.push({label:a.minValue+" - "+a.maxValue,symbol:a.symbol})}):k.infos.push({label:e.attributeField,symbol:e.getDefaultSymbol()})):
"raster-shaded-relief"===e.type&&d.push(this._getStretchLegendElements(e,{min:0,max:255}));g.label=12;case 12:return H=e.defaultSymbol,!H||r||L(e)||l&&!this._hasColorRamp&&!this._hasSizeRamp&&!this._hasOpacityRamp||d.push({type:"symbol-table",infos:[{label:e.defaultLabel||"others",symbol:H}]}),k.infos.length&&d.unshift(k),N=null==b.opacity?this.opacity:b.opacity,P=this._getSymbolConfig("visualVariables"in e&&e.visualVariables),Q=d.reduce(function(a,b){return a.concat(b.infos)},[]).filter(function(a){return!(!a||
!a.symbol)}).map(function(a){return V._getSymbolPreview(a,N,{applyScaleDrivenSize:!n.has(a.symbol),symbolConfig:P})}),e=null,[4,z.eachAlways(Q)];case 13:return g.sent(),[2,d]}})})};d.prototype._constructTileImageryStretchRendererElements=function(a){function b(a){var b,e=((null===(b=null===c||void 0===c?void 0:c.bandIds)||void 0===b?void 0:b.length)===f.bandCount?c.bandIds:Array.from(Array(Math.min(f.bandCount,3)).keys())).map(function(b){return a&&a[b]&&a[b].BandName||"band"+(b+1)});3>e.length?e.push(e[1]):
3<e.length&&e.splice(3);return e}var c=this.layer,f=c.rasterInfo,h=f.bandCount||a.statistics.length,e,d,g=[],g=f.keyProperties&&f.keyProperties.BandProperties;a.statistics&&a.statistics.length?(e=void 0!==a.statistics[0].min?a.statistics[0].min:a.statistics[0][0],d=a.statistics[0].max||a.statistics[0][1]):"esri.layers.WCSLayer"===c.declaredClass&&(d=Fa[c.rasterInfo.pixelType.toLowerCase()],e=d[0],d=d[1]);if(1===f.bandCount)return this._getStretchLegendElements(a,{min:e,max:d});g=g&&g.length>=h?b(g):
b();return this._createSymbolTableElementMultiBand(g)};d.prototype._getStretchLegendElements=function(a,b){a=E.getStrectchRampStops(a.colorRamp,b);return{type:"stretch-ramp",title:"",infos:a,preview:F.renderColorRampPreviewHTML(a.map(function(a){return a.color}))}};d.prototype._createSymbolTableElementMultiBand=function(a){var b=[],c=["red","green","blue"];a.forEach(function(a,d){b.push({label:{colorName:c[d],bandName:a},src:Da.RGB_IMG_SOURCE[d],opacity:1})});return b};d.prototype._updateInfosforClassedSizeRenderer=
function(a,b){var c=a.authoringInfo&&"class-breaks-size"===a.authoringInfo.type,f=a.classBreakInfos.some(function(a){return Aa.isVolumetricSymbol(a.symbol)});if(c&&f){var d=K.REAL_WORLD_MAX_SIZE;a=a.classBreakInfos.length;var e=(d-K.REAL_WORLD_MIN_SIZE)/(1<a?a-1:a);b.forEach(function(a,b){a.size=d-e*b})}};d.prototype._getSymbolConfig=function(a){var b=!1,c=!1;if(a)for(var f=0;f<a.length&&(!b||!c);f++){var d=a[f];"size"===d.type&&("height"===d.axis&&(b=!0),"width-and-depth"===d.axis&&(c=!0))}return b&&
c?"tall":null};d.prototype._getSymbolPreview=function(a,b,c){return g.__awaiter(this,void 0,void 0,function(){var f,d;return g.__generator(this,function(e){switch(e.label){case 0:return f=null==a.size&&this._hasSizeRamp?ua.px2pt(22):a.size,this._scaleDrivenSizeVariable&&(null===c||void 0===c?0:c.applyScaleDrivenSize)?[4,new Promise(function(a,b){P(["../../../renderers/visualVariables/support/visualVariableUtils"],a,b)})]:[3,2];case 1:d=e.sent().getSize,f=d(this._scaleDrivenSizeVariable,null,{view:this.view,
scale:this.scale,shape:"simple-marker"===a.symbol.type?a.symbol.style:null}),e.label=2;case 2:return[2,F.renderPreviewHTML(a.symbol,{size:f,opacity:b,scale:!1,symbolConfig:null===c||void 0===c?void 0:c.symbolConfig,rotation:a.symbol.angle}).then(function(b){a.preview=b;return a}).catch(function(){a.preview=null;return a})]}})})};d.prototype._loadRenderer=function(a){var b,c;return g.__awaiter(this,void 0,void 0,function(){var f,d,e,m,k,l,r,n,p,q,t,u,w=this;return g.__generator(this,function(g){switch(g.label){case 0:return f=
[],d=this.layer,a=a.clone(),this._hasClusterSizeVariable=!1,e="visualVariables"in a&&(null===(b=a.visualVariables)||void 0===b?void 0:b.some(function(a){return"size"===a.type&&"outline"!==a.target&&!I.test(a.valueExpression)})),a&&"visualVariables"in a&&!e&&"featureReduction"in d&&"cluster"===(null===(c=d.featureReduction)||void 0===c?void 0:c.type)&&(m=this.layerView._effectiveRenderer,k=S.unwrap(Ba.getClusterSizeVariable(m,this.view)))&&(l=d.featureReduction,"clusterMinSize"in l&&"clusterMaxSize"in
l&&(r=l.clusterMinSize,n=l.clusterMaxSize,k.legendOptions=new ya({showLegend:r!==n})),p=a.visualVariables||[],a.visualVariables=p.concat([k]),this._hasClusterSizeVariable=!0),[4,this._getMedianColor(a)];case 1:q=g.sent();if(M(a)||Z(a))t=a.classBreakInfos||a.uniqueValueInfos,u=t.map(function(a){return w._fetchSymbol(a.symbol,q).then(function(b){a.symbol=b}).catch(function(){a.symbol=null})}),Array.prototype.push.apply(f,u);f.push(this._fetchSymbol(a.symbol||a.defaultSymbol,a.defaultSymbol?null:q).then(function(b){w._applySymbolToRenderer(a,
b,L(a))}).catch(function(){w._applySymbolToRenderer(a,null,L(a))}));return[2,z.eachAlways(f).then(function(){return a})]}})})};d.prototype._applySymbolToRenderer=function(a,b,c){c?a.symbol=b:a.defaultSymbol=b};d.prototype._getMedianColor=function(a){return g.__awaiter(this,void 0,void 0,function(){var b,c,f,d,e;return g.__generator(this,function(g){switch(g.label){case 0:if(!("visualVariables"in a&&a.visualVariables))return[2,null];b=pa.find(a.visualVariables,function(a){return"color"===a.type});
if(!b)return[2,null];f=c=null;if(b.stops){if(1===b.stops.length)return[2,b.stops[0].color];c=b.stops[0].value;f=b.stops[b.stops.length-1].value}d=c+(f-c)/2;return[4,new Promise(function(a,b){P(["../../../renderers/visualVariables/support/visualVariableUtils"],a,b)})];case 1:return e=g.sent().getColor,[2,e(b,d)]}})})};d.prototype._fetchSymbol=function(a,b){var c=this;if(!a)return z.reject();if("web-style"===a.type){var f=a.portal,f=a.name+"-"+a.styleName+"-"+a.styleUrl+"-"+(f&&f.url)+"-"+(f&&f.user&&
f.user.username),d=this._webStyleSymbolCache;d.has(f)||("2d"===this.view.type?d.set(f,a.fetchCIMSymbol()):d.set(f,a.fetchSymbol()));return d.get(f).then(function(a){return c._getAppliedCloneSymbol(a,b)}).catch(function(){A.warn("Fetching web-style failed!");return z.reject()})}return z.resolve(this._getAppliedCloneSymbol(a,b))};d.prototype._getAppliedCloneSymbol=function(a,b){if(!a||!b)return a;a=a.clone();var c=b&&b.toRgba();-1<a.type.indexOf("3d")?this._applyColorTo3dSymbol(a,c):"cim"===a.type?
za.applyCIMSymbolColor(a,b):a.color&&(a.color=new Q(c||a.color));return a};d.prototype._applyColorTo3dSymbol=function(a,b){b&&a.symbolLayers.forEach(function(a){a&&(a.material||(a.material={}),a.material.color=new Q(b))})};d.prototype._getVisualVariableLegendElements=function(a,b){return g.__awaiter(this,void 0,void 0,function(){var c,f,d,e,m,k,l,p,n,v,q,t,u=this;return g.__generator(this,function(h){switch(h.label){case 0:if(!("visualVariables"in a&&a.visualVariables)||"vector-field"===a.type)return[2,
null];c=a.visualVariables;f=[];d=[];e=[];m=0;for(k=c;m<k.length;m++)l=k[m],"color"===l.type?f.push(l):"size"===l.type?d.push(l):"opacity"===l.type&&e.push(l);p=g.__spreadArrays(f,d,e);0===f.length&&M(a)&&a.classBreakInfos&&1===a.classBreakInfos.length&&(n=(q=a.classBreakInfos[0])&&q.symbol);0===f.length&&L(a)&&(n=a.symbol);n&&(-1<n.type.indexOf("3d")?(t=n.symbolLayers.getItemAt(0),"water"===t.type?S.isSome(t.color)&&(v=t.color):S.isSome(t.material)&&S.isSome(t.material.color)&&(v=t.material.color)):
n.url||(v=n.color));return[4,z.all(p.map(function(c){return g.__awaiter(u,void 0,void 0,function(){var f,d,e,h,k,l,m,n;return g.__generator(this,function(g){switch(g.label){case 0:if(c.legendOptions&&!1===c.legendOptions.showLegend)return[3,10];f=this._getRampTitle(c,b);d=null;h=(e="getField"in b&&b.getField&&b.getField(c.field))&&wa.isDateField(e);return"color"!==c.type?[3,2]:[4,E.getRampStops(c,null,h)];case 1:return k=g.sent(),d={type:"color-ramp",title:f,infos:k,preview:F.renderColorRampPreviewHTML(k.map(function(a){return a.color}))},
this._hasColorRamp||(this._hasColorRamp=!(null==d.infos||!d.infos.length)),[3,9];case 2:if("size"!==c.type||"outline"===c.target)return[3,7];if(!I.test(c.valueExpression))return[3,3];this._hasClusterSizeVariable||(this._scaleDrivenSizeVariable=c);return[3,6];case 3:return l={type:"size-ramp",title:this._hasClusterSizeVariable?this._getClusterTitle(c):f},m=K.getRampStops,n=[a,c],[4,this._getMedianColor(a)];case 4:return[4,m.apply(void 0,n.concat([g.sent(),this.scale,this.view,h]))];case 5:d=(l.infos=
g.sent(),l),this._hasSizeRamp||(this._hasSizeRamp=!(null==d.infos||!d.infos.length)),g.label=6;case 6:return[3,9];case 7:return"opacity"!==c.type?[3,9]:[4,E.getRampStops(c,v,h)];case 8:k=g.sent(),d={type:"opacity-ramp",title:f,infos:k,preview:F.renderColorRampPreviewHTML(k.map(function(a){return a.color}))},this._hasOpacityRamp||(this._hasOpacityRamp=!(null==d.infos||!d.infos.length)),g.label=9;case 9:return[2,d&&d.infos?d:null];case 10:return[2,void 0]}})})}))];case 1:return[2,h.sent().filter(function(a){return!!a})]}})})};
d.prototype._getDomainName=function(a,b,c){return a&&"function"!==typeof a?(c=(a="getField"in c&&c.getField&&c.getField(a))&&"getFieldDomain"in c&&c.getFieldDomain?c.getFieldDomain(a.name):null)&&"coded-value"===c.type?c.getName(b):null:null};d.prototype._getClusterTitle=function(a){var b=this.layer;a=a.field;if("featureReduction"in b&&b.featureReduction&&"cluster"===b.featureReduction.type&&(b=b.featureReduction,b=(b="popupTemplate"in b&&b.popupTemplate)&&b.fieldInfos))for(var c=0;c<b.length;c++){var d=
b[c];if(d.fieldName===a)return"cluster_count"===a?d.label||{showCount:!0}:d.label}return{showCount:!0}};d.prototype._getRampTitle=function(a,b){var c=a.field,d=a.normalizationField,g=!1,e=!1,m=!1,k=null,c="function"===typeof c?null:c,d="function"===typeof d?null:d,k=a.legendOptions&&a.legendOptions.title;if(null==k)if(a.valueExpressionTitle)k=a.valueExpressionTitle;else{if("renderer"in b&&b.renderer&&"authoringInfo"in b.renderer&&b.renderer.authoringInfo&&b.renderer.authoringInfo.visualVariables)for(a=
b.renderer.authoringInfo.visualVariables,k=0;k<a.length;k++){var l=a[k];if("color"===l.type){if("ratio"===l.style){g=!0;break}if("percent"===l.style){e=!0;break}if("percent-of-total"===l.style){m=!0;break}}}k={field:c&&this._getFieldAlias(c,b),normField:d&&this._getFieldAlias(d,b),ratio:g,ratioPercent:e,ratioPercentTotal:m}}return k};d.prototype._getRendererTitle=function(a,b){if(a.legendOptions&&a.legendOptions.title)return a.legendOptions.title;if(a.valueExpressionTitle)return a.valueExpressionTitle;
var c=a.field,d=null,g=null;M(a)&&(d=a.normalizationField,g="percent-of-total"===a.normalizationType);c="function"===typeof c?null:c;d="function"===typeof d?null:d;a=null;if(c||d)a={field:c&&this._getFieldAlias(c,b),normField:d&&this._getFieldAlias(d,b),normByPct:g};return a};d.prototype._getFieldAlias=function(a,b){var c="popupTemplate"in b&&b.popupTemplate,c=c&&c.fieldInfos,d=null;c&&c.some(function(b){return a===b.fieldName?(d=b,!0):!1});c=null;"getField"in b&&b.getField?c=b.getField(a):"fieldsIndex"in
b&&b.fieldsIndex&&(c=b.fieldsIndex.get(a));b=d||c;var g=null;b&&(g=d&&d.label||c&&c.alias||"name"in b&&b.name||"fieldName"in b&&b.fieldName);return g};d.prototype._isUnclassedRenderer=function(a){var b=a.visualVariables,c=!1;M(a)&&a.classBreakInfos&&1===a.classBreakInfos.length&&b&&(c=a.field?b.some(function(b){return!(!b||a.field!==b.field||(a.normalizationField||b.normalizationField)&&a.normalizationField!==b.normalizationField)}):!!b.length);return c};g.__decorate([p.property()],d.prototype,"children",
void 0);g.__decorate([p.property()],d.prototype,"layerView",void 0);g.__decorate([p.property()],d.prototype,"layer",void 0);g.__decorate([p.property()],d.prototype,"legendElements",void 0);g.__decorate([p.property({dependsOn:["parent","parent.opacity","layer","layer.opacity"],readOnly:!0})],d.prototype,"opacity",null);g.__decorate([p.property()],d.prototype,"parent",void 0);g.__decorate([p.property({readOnly:!0})],d.prototype,"ready",null);g.__decorate([p.property()],d.prototype,"keepCacheOnDestroy",
void 0);g.__decorate([p.property()],d.prototype,"respectLayerVisibility",void 0);g.__decorate([p.property({dependsOn:["view.scale"],readOnly:!0})],d.prototype,"scale",null);g.__decorate([p.property()],d.prototype,"sublayerIds",void 0);g.__decorate([p.property({dependsOn:["layer.renderer?.valueExpression?","layer.renderer?.visualVariables?","layer.featureReduction?","scale"],readOnly:!0})],d.prototype,"isScaleDriven",null);g.__decorate([p.property()],d.prototype,"title",void 0);g.__decorate([p.property({dependsOn:["ready"],
readOnly:!0,value:0})],d.prototype,"version",null);g.__decorate([p.property()],d.prototype,"view",void 0);return d=g.__decorate([p.subclass("esri.widgets.Legend.support.ActiveLayerInfo")],d)}(na)});