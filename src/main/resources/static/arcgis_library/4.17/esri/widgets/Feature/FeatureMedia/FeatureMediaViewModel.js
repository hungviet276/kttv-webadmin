// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.17/esri/copyright.txt for details.
//>>built
define("require exports tslib ../../../core/Accessor ../../../core/accessorSupport/decorators ../../../popup/FieldInfo ../../../popup/content/support/ChartMediaInfoValueSeries ../support/featureUtils ../support/relatedFeatureUtils".split(" "),function(w,x,d,t,l,u,v,k,r){return function(q){function c(a){a=q.call(this,a)||this;a.activeMediaInfoIndex=0;a.attributes=null;a.fieldInfoMap=null;a.formattedAttributes=null;a.layer=null;a.mediaInfos=null;a.popupTemplate=null;a.relatedInfos=null;return a}d.__extends(c,
q);Object.defineProperty(c.prototype,"activeMediaInfo",{get:function(){return this.formattedMediaInfos[this.activeMediaInfoIndex]||null},enumerable:!1,configurable:!0});Object.defineProperty(c.prototype,"formattedMediaInfos",{get:function(){return this._formatMediaInfos()||[]},enumerable:!1,configurable:!0});Object.defineProperty(c.prototype,"formattedMediaInfoCount",{get:function(){return this.formattedMediaInfos.length},enumerable:!1,configurable:!0});c.prototype.setActiveMedia=function(a){this._setContentElementMedia(a)};
c.prototype.next=function(){this._pageContentElementMedia(1)};c.prototype.previous=function(){this._pageContentElementMedia(-1)};c.prototype._setContentElementMedia=function(a){var c=this.formattedMediaInfoCount;this.activeMediaInfoIndex=(a+c)%c};c.prototype._pageContentElementMedia=function(a){this._setContentElementMedia(this.activeMediaInfoIndex+a)};c.prototype._formatMediaInfos=function(){var a=this,c=this.attributes,b=this.mediaInfos,e=this.formattedAttributes,g=this.fieldInfoMap,h=this.layer,
p=d.__assign(d.__assign({},e),c);return null===b||void 0===b?void 0:b.map(function(b){if(!b)return null;var f=b.title?k.processFieldsInLinks(b.title,p,h):"";b.title=f?k.substituteAttributes({formattedAttributes:e,template:f,fieldInfoMap:g}):"";f=b.caption?k.processFieldsInLinks(b.caption,p,h):"";b.caption=f?k.substituteAttributes({formattedAttributes:e,template:f,fieldInfoMap:g}):"";f=b.altText?k.processFieldsInLinks(b.altText,p,h):"";b.altText=f?k.substituteAttributes({formattedAttributes:e,template:f,
fieldInfoMap:g}):"";return"image"===b.type?(f=b.value,a._setImageValue({value:f,formattedAttributes:e,layer:h}),b.value.sourceURL?b:void 0):"pie-chart"===b.type||"line-chart"===b.type||"column-chart"===b.type||"bar-chart"===b.type?(f=b.value,a._setChartValue({value:f,chartType:b.type,attributes:c,formattedAttributes:e,layer:h}),b):null}).filter(Boolean)};c.prototype._setImageValue=function(a){var c=this.fieldInfoMap,b=a.value,e=a.formattedAttributes;a=a.layer;var g=b.linkURL,h=b.sourceURL;h&&(h=k.fixTokens(h,
a),b.sourceURL=k.substituteAttributes({formattedAttributes:e,template:h,fieldInfoMap:c}));g&&(a=k.fixTokens(g,a),b.linkURL=k.substituteAttributes({formattedAttributes:e,template:a,fieldInfoMap:c}))};c.prototype._setChartValue=function(a){var c=this,b=a.value,e=a.attributes,g=a.formattedAttributes,h=a.chartType;a=a.layer;var p=this.popupTemplate,l=this.relatedInfos,f=b.fields,m=b.normalizeField;b.fields=k.getFixedFieldNames(f,a);m&&(b.normalizeField=k.getFixedFieldName(m,a));if(f.some(function(a){return!!(null!=
g[a]||k.isRelatedField(a)&&l.size)})){var n=null===p||void 0===p?void 0:p.fieldInfos;f.forEach(function(a){k.isRelatedField(a)?b.series=d.__spreadArrays(b.series,c._getRelatedChartInfos({fieldInfos:n,fieldName:a,formattedAttributes:g,chartType:h,value:b})):(a=c._getChartOption({value:b,attributes:e,chartType:h,formattedAttributes:g,fieldName:a,fieldInfos:n}),b.series.push(a))})}};c.prototype._getRelatedChartInfos=function(a){var c=this,b,e=a.fieldInfos,g=a.fieldName,h=a.formattedAttributes,k=a.chartType,
d=a.value,f=[];a=r.getRelatedFieldInfo(g);var l=a.layerId,n=a.fieldName;a=null===(b=this.relatedInfos)||void 0===b?void 0:b.get(l.toString());if(!a)return f;b=a.relatedFeatures;a=a.relation;if(!a||!b)return f;a=a.cardinality;b.forEach(function(a){var b=a.attributes;b&&Object.keys(b).forEach(function(a){a===n&&f.push(c._getChartOption({value:d,attributes:b,formattedAttributes:h,fieldName:g,chartType:k,relatedFieldName:a,fieldInfos:e}))})});return"one-to-many"===a||"many-to-many"===a?f:[f[0]]};c.prototype._getTooltip=
function(a){var c=a.label;return"pie-chart"===a.chartType?c:c+": "+a.value};c.prototype._getChartOption=function(a){var c,b=a.value,e=a.attributes,g=a.formattedAttributes,h=a.fieldName,d=a.relatedFieldName,l=a.fieldInfos;a=a.chartType;var f=this.layer,m=b.normalizeField,n=b.tooltipField,m=m?k.isRelatedField(m)?e[r.getRelatedFieldInfo(m).fieldName]:e[m]:null,b=d&&void 0!==e[d]?e[d]:void 0!==e[h]?e[h]:g[h],q=void 0===b?null:b&&m?b/m:b,b=new v({value:q});if(k.isRelatedField(h))return c=r.getRelatedFieldInfo(h),
g=(g=r.getRelatedFieldInfo(n))?g.fieldName:null,l=k.formatValueToFieldInfo(q,{fieldInfos:l,fieldName:d,layer:f,preventPlacesFormatting:!!m}),d=c?c.label||c.fieldName:d,b.tooltip=this._getTooltip({label:g&&void 0!==e[g]?e[g]:d,value:l,chartType:a}),b;e=k.getFieldInfo(l,h);d=k.getFixedFieldName(h,f);e=n&&void 0!==g[n]?g[n]:k.getFieldInfoLabel(e||new u({fieldName:d}),null===(c=this.popupTemplate)||void 0===c?void 0:c.expressionInfos);b.tooltip=this._getTooltip({label:e,value:g[d],chartType:a});return b};
d.__decorate([l.property()],c.prototype,"activeMediaInfoIndex",void 0);d.__decorate([l.property({readOnly:!0,dependsOn:["formattedMediaInfos","activeMediaInfoIndex"]})],c.prototype,"activeMediaInfo",null);d.__decorate([l.property()],c.prototype,"attributes",void 0);d.__decorate([l.property()],c.prototype,"fieldInfoMap",void 0);d.__decorate([l.property()],c.prototype,"formattedAttributes",void 0);d.__decorate([l.property({readOnly:!0,dependsOn:"attributes fieldInfoMap formattedAttributes mediaInfos popupTemplate layer relatedInfos".split(" ")})],
c.prototype,"formattedMediaInfos",null);d.__decorate([l.property()],c.prototype,"layer",void 0);d.__decorate([l.property({readOnly:!0,dependsOn:["formattedMediaInfos"]})],c.prototype,"formattedMediaInfoCount",null);d.__decorate([l.property()],c.prototype,"mediaInfos",void 0);d.__decorate([l.property()],c.prototype,"popupTemplate",void 0);d.__decorate([l.property()],c.prototype,"relatedInfos",void 0);return c=d.__decorate([l.subclass("esri.widgets.Feature.FeatureMedia.FeatureMediaViewModel")],c)}(t)});