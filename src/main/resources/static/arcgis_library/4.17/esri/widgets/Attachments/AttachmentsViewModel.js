// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See https://js.arcgis.com/4.17/esri/copyright.txt for details.
//>>built
define("require exports tslib ../../Graphic ../../core/Collection ../../core/Error ../../core/HandleOwner ../../core/maybe ../../core/watchUtils ../../core/accessorSupport/decorators ../../layers/support/AttachmentInfo ../../tasks/support/AttachmentQuery ../Feature/support/featureUtils".split(" "),function(B,C,c,u,v,h,w,x,y,e,z,n,A){var p={editing:!1,operations:{add:!0,update:!0,delete:!0}},r=v.ofType(z);return function(t){function a(d){var b=t.call(this,d)||this;b._getAttachmentsPromise=null;b._attachmentLayer=
null;b.abilities=c.__assign({},p);b.activeAttachmentInfo=null;b.attachmentInfos=new r;b.graphic=null;b.mode="view";b.handles.add([y.init(b,"graphic",function(){return b._graphicChanged()})]);return b}c.__extends(a,t);a.prototype.destroy=function(){this.graphic=this._attachmentLayer=null};a.prototype.castAbilities=function(d){return c.__assign(c.__assign({},p),d)};Object.defineProperty(a.prototype,"state",{get:function(){return this._getAttachmentsPromise?"loading":this.graphic?"ready":"disabled"},
enumerable:!1,configurable:!0});Object.defineProperty(a.prototype,"supportsResizeAttachments",{get:function(){return this.get("graphic.layer.capabilities.operations.supportsResizeAttachments")||!1},enumerable:!1,configurable:!0});a.prototype.getAttachments=function(){return c.__awaiter(this,void 0,void 0,function(){var d,b,a,g,l,k,m,f;return c.__generator(this,function(c){switch(c.label){case 0:d=this;b=d._attachmentLayer;a=d.attachmentInfos;if(!b||"function"!==typeof b.queryAttachments)throw new h("invalid-layer",
"getAttachments(): A valid layer is required.");g=this._getFeatureId();l=new n({objectIds:[g],returnMetadata:!0});k=[];this._getAttachmentsPromise=m=b.queryAttachments(l).then(function(b){return b[g]||k}).catch(function(){return k});this.notifyChange("state");return[4,m];case 1:return f=c.sent(),a.removeAll(),f.length&&a.addMany(f),this._getAttachmentsPromise=null,this.notifyChange("state"),[2,f]}})})};a.prototype.addAttachment=function(d){return c.__awaiter(this,void 0,void 0,function(){var b,a,
g,l,k,m,f,e=this;return c.__generator(this,function(c){switch(c.label){case 0:b=this;a=b._attachmentLayer;g=b.attachmentInfos;l=b.graphic;k=b.abilities;if(!d)throw new h("invalid-attachment","addAttachment(): An attachment is required.",{attachment:d});if(!k.operations.add)throw new h("invalid-abilities","addAttachment(): add abilities are required.");if(!a||"function"!==typeof a.addAttachment)throw new h("invalid-layer","addAttachment(): A valid layer is required.");m=a.addAttachment(l,d).then(function(b){return e._queryAttachment(b.objectId)});
return[4,m];case 1:return f=c.sent(),g.add(f),[2,f]}})})};a.prototype.deleteAttachment=function(d){return c.__awaiter(this,void 0,void 0,function(){var b,a,g,l,k,e,f;return c.__generator(this,function(c){switch(c.label){case 0:b=this;a=b._attachmentLayer;g=b.attachmentInfos;l=b.graphic;k=b.abilities;if(!d)throw new h("invalid-attachment-info","deleteAttachment(): An attachmentInfo is required.",{attachmentInfo:d});if(!k.operations.delete)throw new h("invalid-abilities","deleteAttachment(): delete abilities are required.");
if(!a||"function"!==typeof a.deleteAttachments)throw new h("invalid-layer","deleteAttachment(): A valid layer is required.");e=a.deleteAttachments(l,[d.id]).then(function(){return d});return[4,e];case 1:return f=c.sent(),g.remove(f),[2,f]}})})};a.prototype.updateAttachment=function(a,b){void 0===b&&(b=this.activeAttachmentInfo);return c.__awaiter(this,void 0,void 0,function(){var d,g,e,k,m,f,n,q,p=this;return c.__generator(this,function(c){switch(c.label){case 0:d=this;g=d._attachmentLayer;e=d.attachmentInfos;
k=d.graphic;m=d.abilities;if(!a)throw new h("invalid-attachment","updateAttachment(): An attachment is required.",{attachment:a});if(!b)throw new h("invalid-attachment-info","updateAttachment(): An attachmentInfo is required.",{attachmentInfo:b});if(!m.operations.update)throw new h("invalid-abilities","updateAttachment(): Update abilities are required.");f=e.findIndex(function(a){return a===b});if(!g||"function"!==typeof g.updateAttachment)throw new h("invalid-layer","updateAttachment(): A valid layer is required.");
n=g.updateAttachment(k,b.id,a).then(function(b){return p._queryAttachment(b.objectId)});return[4,n];case 1:return q=c.sent(),e.splice(f,1,q),[2,q]}})})};a.prototype._queryAttachment=function(a){return c.__awaiter(this,void 0,void 0,function(){var b,d,e;return c.__generator(this,function(c){if(!a)throw new h("invalid-attachment-id","Could not query attachment.");b=this._attachmentLayer;d=this._getFeatureId();e=new n({objectIds:[d],attachmentsWhere:"AttachmentId\x3d"+a,returnMetadata:!0});return[2,
b.queryAttachments(e).then(function(b){return b[d][0]})]})})};a.prototype._getFeatureId=function(){var a=this._attachmentLayer,b=this.graphic;if(!a||!b)return null;a=a.objectIdField;return(b=b.attributes)&&b[a]};a.prototype._graphicChanged=function(){this.graphic&&(this._setAttachmentLayer(),this.getAttachments().catch(function(){}))};a.prototype._setAttachmentLayer=function(){var a=A.getSourceLayer(this.graphic);this._attachmentLayer=a?"scene"===a.type&&x.isSome(a.associatedLayer)?a.associatedLayer:
a:null};c.__decorate([e.property()],a.prototype,"abilities",void 0);c.__decorate([e.cast("abilities")],a.prototype,"castAbilities",null);c.__decorate([e.property()],a.prototype,"activeAttachmentInfo",void 0);c.__decorate([e.property({readOnly:!0,type:r})],a.prototype,"attachmentInfos",void 0);c.__decorate([e.property({type:u})],a.prototype,"graphic",void 0);c.__decorate([e.property()],a.prototype,"mode",void 0);c.__decorate([e.property({dependsOn:["graphic"],readOnly:!0})],a.prototype,"state",null);
c.__decorate([e.property({readOnly:!0,dependsOn:["graphic","graphic.layer","graphic.layer.loaded","graphic.layer.capabilities.operations.supportsResizeAttachments"]})],a.prototype,"supportsResizeAttachments",null);return a=c.__decorate([e.subclass("esri.widgets.Attachments.AttachmentsViewModel")],a)}(w.HandleOwner)});